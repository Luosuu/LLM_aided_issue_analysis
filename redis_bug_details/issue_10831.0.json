{
  "issue_number": 10831.0,
  "title": "[CRASH] Redis crashing on running 1200 hmset in pipeline mode",
  "body": "**Crash report**\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n1:M 08 Jun 2022 11:31:52.892 # Redis 6.2.4 crashed by signal: 11, si_code: 1\r\n1:M 08 Jun 2022 11:31:52.892 # Accessing address: 0x6f700a0d343224\r\n1:M 08 Jun 2022 11:31:52.892 # Crashed running the instruction at: 0x4000047c3b\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\nredis-server 0.0.0.0:6379(dictAddRaw+0x16b)[0x4000047c3b]\r\n\r\nBacktrace:\r\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x12730)[0x400217f730]\r\nredis-server 0.0.0.0:6379(dictAddRaw+0x16b)[0x4000047c3b]\r\nredis-server 0.0.0.0:6379(dictAdd+0x11)[0x4000047dd1]\r\nredis-server 0.0.0.0:6379(dbAdd+0x25)[0x400006f085]\r\nredis-server 0.0.0.0:6379(hashTypeLookupWriteOrCreate+0x67)[0x400008f707]\r\nredis-server 0.0.0.0:6379(hsetCommand+0x30)[0x4000090240]\r\nredis-server 0.0.0.0:6379(call+0x92)[0x400004cc72]\r\nredis-server 0.0.0.0:6379(processCommand+0x5b3)[0x400004e7c3]\r\nredis-server 0.0.0.0:6379(processCommandAndResetClient+0x1c)[0x4000061f5c]\r\nredis-server 0.0.0.0:6379(processInputBuffer+0xea)[0x400006464a]\r\nredis-server 0.0.0.0:6379(+0xf3e88)[0x40000f3e88]\r\nredis-server 0.0.0.0:6379(aeProcessEvents+0x2a1)[0x4000045ce1]\r\nredis-server 0.0.0.0:6379(aeMain+0x1d)[0x4000045f3d]\r\nredis-server 0.0.0.0:6379(main+0x314)[0x40000426f4]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xeb)[0x40021b209b]\r\nredis-server 0.0.0.0:6379(_start+0x2a)[0x4000042bda]\r\n\r\n------ REGISTERS ------\r\n1:M 08 Jun 2022 11:31:52.907 # \r\nRAX:000000400e376ec0 RBX:00000040029d8101\r\nRCX:0000000000003539 RDX:ffffffffffffffe8\r\nRDI:00000040029d8119 RSI:00000040029a5099\r\nRBP:2139dc4f734204b0 RSP:0000004001c2d4f0\r\nR8 :0000000000000018 R9 :0000004002960450\r\nR10:000000000000000e R11:0000004002318220\r\nR12:736f700a0d343224 R13:0000000000000000\r\nR14:0000004002960420 R15:00000000000004b0\r\nRIP:0000004000047c3b EFL:0000000000000206\r\nCSGSFS:002b000000000033\r\n1:M 08 Jun 2022 11:31:52.907 # (0000004001c2d4ff) -> 000000400006f085\r\n1:M 08 Jun 2022 11:31:52.907 # (0000004001c2d4fe) -> 00000040029d2fd0\r\n1:M 08 Jun 2022 11:31:52.907 # (0000004001c2d4fd) -> 00000040029df000\r\n1:M 08 Jun 2022 11:31:52.907 # (0000004001c2d4fc) -> 0000004002964f60\r\n1:M 08 Jun 2022 11:31:52.907 # (0000004001c2d4fb) -> 0000004000047dd1\r\n1:M 08 Jun 2022 11:31:52.907 # (0000004001c2d4fa) -> 00000040001f8218\r\n1:M 08 Jun 2022 11:31:52.907 # (0000004001c2d4f9) -> 00000002db5088ba\r\n1:M 08 Jun 2022 11:31:52.907 # (0000004001c2d4f8) -> 0000000000000000\r\n1:M 08 Jun 2022 11:31:52.907 # (0000004001c2d4f7) -> 00000040029d2fd0\r\n1:M 08 Jun 2022 11:31:52.907 # (0000004001c2d4f6) -> 00000040029df000\r\n1:M 08 Jun 2022 11:31:52.907 # (0000004001c2d4f5) -> 0000004002960420\r\n1:M 08 Jun 2022 11:31:52.908 # (0000004001c2d4f4) -> 0000000000000001\r\n1:M 08 Jun 2022 11:31:52.908 # (0000004001c2d4f3) -> 0000004002960430\r\n1:M 08 Jun 2022 11:31:52.908 # (0000004001c2d4f2) -> 0000004002960470\r\n1:M 08 Jun 2022 11:31:52.908 # (0000004001c2d4f1) -> 0000000000002580\r\n1:M 08 Jun 2022 11:31:52.908 # (0000004001c2d4f0) -> 0000004002960430\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:6.2.4\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:8fe6433c17d8e334\r\nredis_mode:standalone\r\nos:Linux 5.10.104-linuxkit x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:8.3.0\r\nprocess_id:1\r\nprocess_supervised:no\r\nrun_id:eec83025f80347e6f9639377dbe7520a32604dae\r\ntcp_port:6379\r\nserver_time_usec:1654687912890721\r\nuptime_in_seconds:528\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:10520744\r\nexecutable:/redis-server\r\nconfig_file:/opt/bitnami/redis/etc/redis.conf\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:9\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:212\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:1283272\r\nused_memory_human:1.22M\r\nused_memory_rss:0\r\nused_memory_rss_human:0B\r\nused_memory_peak:1532224\r\nused_memory_peak_human:1.46M\r\nused_memory_peak_perc:83.75%\r\nused_memory_overhead:1068500\r\nused_memory_startup:810152\r\nused_memory_dataset:214772\r\nused_memory_dataset_perc:45.39%\r\nallocator_allocated:1230488\r\nallocator_active:1904640\r\nallocator_resident:4464640\r\ntotal_system_memory:8337530880\r\ntotal_system_memory_human:7.76G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.55\r\nallocator_frag_bytes:674152\r\nallocator_rss_ratio:2.34\r\nallocator_rss_bytes:2560000\r\nrss_overhead_ratio:0.00\r\nrss_overhead_bytes:-4464640\r\nmem_fragmentation_ratio:0.00\r\nmem_fragmentation_bytes:-1082368\r\nmem_not_counted_for_evict:8186\r\nmem_replication_backlog:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:184620\r\nmem_aof_buffer:8192\r\nmem_allocator:jemalloc-5.1.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:8376\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1654687898\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:0\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:1789952\r\naof_enabled:1\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\naof_current_size:1212856\r\naof_base_size:652576\r\naof_pending_rewrite:0\r\naof_buffer_length:8180\r\naof_rewrite_buffer_length:0\r\naof_pending_bio_fsync:0\r\naof_delayed_fsync:0\r\n\r\n# Stats\r\ntotal_connections_received:30\r\ntotal_commands_processed:6018\r\ninstantaneous_ops_per_sec:63\r\ntotal_net_input_bytes:781787\r\ntotal_net_output_bytes:533368\r\ninstantaneous_input_kbps:14.85\r\ninstantaneous_output_kbps:0.08\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:18\r\nevicted_keys:0\r\nkeyspace_hits:2415\r\nkeyspace_misses:40\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:6473\r\ntotal_forks:2\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:210\r\ntotal_writes_processed:188\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:c230c6000b516da4a703074f3c65bae7fa819d4c\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:2.467775\r\nused_cpu_user:2.886542\r\nused_cpu_sys_children:0.270195\r\nused_cpu_user_children:1.016198\r\nused_cpu_sys_main_thread:2.448954\r\nused_cpu_user_main_thread:2.821468\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_info:calls=108,usec=132550,usec_per_call=1227.31,rejected_calls=0,failed_calls=0\r\ncmdstat_type:calls=1207,usec=1777,usec_per_call=1.47,rejected_calls=0,failed_calls=0\r\ncmdstat_auth:calls=6,usec=1423,usec_per_call=237.17,rejected_calls=0,failed_calls=0\r\ncmdstat_flushall:calls=1,usec=9439,usec_per_call=9439.00,rejected_calls=0,failed_calls=0\r\ncmdstat_client:calls=6,usec=1829,usec_per_call=304.83,rejected_calls=0,failed_calls=0\r\ncmdstat_dbsize:calls=2,usec=31,usec_per_call=15.50,rejected_calls=0,failed_calls=0\r\ncmdstat_sadd:calls=19,usec=3879,usec_per_call=204.16,rejected_calls=0,failed_calls=0\r\ncmdstat_module:calls=1,usec=66,usec_per_call=66.00,rejected_calls=0,failed_calls=0\r\ncmdstat_ttl:calls=1208,usec=2046,usec_per_call=1.69,rejected_calls=0,failed_calls=0\r\ncmdstat_exists:calls=40,usec=1045,usec_per_call=26.12,rejected_calls=0,failed_calls=0\r\ncmdstat_hset:calls=2212,usec=28235,usec_per_call=12.76,rejected_calls=0,failed_calls=0\r\ncmdstat_scan:calls=1,usec=4421,usec_per_call=4421.00,rejected_calls=0,failed_calls=0\r\ncmdstat_memory:calls=1207,usec=3312,usec_per_call=2.74,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=1024,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=29 addr=172.19.0.5:48448 laddr=172.19.0.4:6379 fd=13 name= age=47 idle=47 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=4 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20488 events=r cmd=NULL user=default redir=-1\r\nid=30 addr=172.19.0.5:48450 laddr=172.19.0.4:6379 fd=14 name= age=47 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=16393 qbuf-free=24561 argv-mem=131 obl=136 oll=0 omem=0 tot-mem=61699 events=r cmd=hset user=default redir=-1\r\nid=31 addr=172.19.0.1:56948 laddr=172.19.0.4:6379 fd=15 name=redisinsight-workbench-c6b40da4 age=14 idle=14 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=flushall user=default redir=-1\r\nid=10 addr=172.19.0.1:64142 laddr=172.19.0.4:6379 fd=16 name=redisinsight-browser-302df251 age=439 idle=8 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=dbsize user=default redir=-1\r\nid=3 addr=172.19.0.1:63418 laddr=172.19.0.4:6379 fd=9 name=redisinsight-common-7fc1713b age=527 idle=3 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=info user=default redir=-1\r\nid=26 addr=172.19.0.5:48442 laddr=172.19.0.4:6379 fd=10 name= age=47 idle=47 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=4 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20488 events=r cmd=NULL user=default redir=-1\r\nid=27 addr=172.19.0.5:48444 laddr=172.19.0.4:6379 fd=11 name= age=47 idle=47 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=4 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20488 events=r cmd=NULL user=default redir=-1\r\nid=32 addr=172.19.0.5:48788 laddr=172.19.0.4:6379 fd=17 name= age=4 idle=4 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=4 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20488 events=r cmd=NULL user=default redir=-1\r\nid=28 addr=172.19.0.5:48446 laddr=172.19.0.4:6379 fd=12 name= age=47 idle=47 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=4 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20488 events=r cmd=NULL user=default redir=-1\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=30 addr=172.19.0.5:48450 laddr=172.19.0.4:6379 fd=14 name= age=47 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=16393 qbuf-free=24561 argv-mem=131 obl=136 oll=0 omem=0 tot-mem=61699 events=r cmd=hset user=default redir=-1\r\nargv[0]: 'hset'\r\nargv[1]: 'post:3987:reaction:26248'\r\nargv[2]: 'id'\r\nargv[3]: '26248'\r\nargv[4]: 'created_at'\r\nargv[5]: '1648166901'\r\nargv[6]: 'updated_at'\r\nargv[7]: '-62135596800'\r\nargv[8]: 'like_on'\r\nargv[9]: 'Post'\r\nargv[10]: 'like_on_id'\r\nargv[11]: '3987'\r\nargv[12]: 'created_by'\r\nargv[13]: '1617'\r\nargv[14]: 'like_emoji'\r\nargv[15]: '1f49e'\r\n```\r\n",
  "state": "closed",
  "created_at": "2022-06-08T11:40:30Z",
  "updated_at": "2022-06-25T19:47:10Z",
  "closed_at": "2022-06-25T19:47:09Z",
  "labels": [
    "state:to-be-closed"
  ],
  "comments_data": [
    {
      "id": 1149812519,
      "user": "sundb",
      "created_at": "2022-06-08T11:48:07Z",
      "body": "Is your HM Mac M1, and running on docker? \r\nIt seems that you use bitnami docker image from `config_file:/opt/bitnami/redis/etc/redis.conf` log.\r\nProperty related https://github.com/redis/redis/issues/10162#issuecomment-1072359526"
    },
    {
      "id": 1152049593,
      "user": "oranagra",
      "created_at": "2022-06-10T07:16:27Z",
      "body": "@MrDHat please respond..\r\nmeanwhile, we'll assume this is the QEMU issue since we didn't see any other similar reports and are unable to reproduce the issue."
    },
    {
      "id": 1166351167,
      "user": "MrDHat",
      "created_at": "2022-06-25T19:47:09Z",
      "body": "Sorry folks... forgot to respond here\r\nI am indeed using M1 Mac & the issue seems to be what @sundb reported"
    }
  ]
}