{
  "issue_number": 10242.0,
  "title": "[CRASH] Found using fuzzing single redis server instance",
  "body": "**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n7171:M 06 Feb 2022 01:19:58.011 # Server initialized\r\n7171:M 06 Feb 2022 01:19:58.011 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.\r\n7171:M 06 Feb 2022 01:19:58.012 * The AOF directory appendonlydir doesn't exist\r\n7171:M 06 Feb 2022 01:19:58.012 * Ready to accept connections\r\n7171:M 06 Feb 2022 01:20:05.549 * Replica 127.0.0.1:<unknown-replica-port> asks for synchronization\r\n7171:M 06 Feb 2022 01:20:05.549 * Replication backlog created, my new replication IDs are '13e422441fb8cec64b82c2e259785a7bba615f39' and '0000000000000000000000000000000000000000'\r\n7171:M 06 Feb 2022 01:20:05.549 * Starting BGSAVE for SYNC with target: disk\r\n7171:M 06 Feb 2022 01:20:05.549 * Background saving started by pid 7179\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n7171:M 06 Feb 2022 01:20:05.549 # === ASSERTION FAILED ===\r\n7171:M 06 Feb 2022 01:20:05.549 # ==> networking.c:1048 'c->bufpos == 0 && listLength(c->reply) == 0' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\nsrc/redis-server *:6379(+0x8b0c3)[0x557cbe3e90c3]\r\nsrc/redis-server *:6379(writeToClient+0x48)[0x557cbe3ea518]\r\nsrc/redis-server *:6379(handleClientsWithPendingWrites+0x86)[0x557cbe3ea796]\r\nsrc/redis-server *:6379(handleClientsWithPendingWritesUsingThreads+0x245)[0x557cbe3f1675]\r\nsrc/redis-server *:6379(beforeSleep+0xf1)[0x557cbe3ce3a1]\r\nsrc/redis-server *:6379(aeProcessEvents+0xf8)[0x557cbe3c9fa8]\r\nsrc/redis-server *:6379(aeMain+0x1d)[0x557cbe3ca45d]\r\nsrc/redis-server *:6379(main+0x312)[0x557cbe3c6192]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf3)[0x7f99693af0b3]\r\nsrc/redis-server *:6379(_start+0x2e)[0x557cbe3c669e]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:255.255.255\r\nredis_git_sha1:6ebb679f\r\nredis_git_dirty:0\r\nredis_build_id:dead6269609cca88\r\nredis_mode:standalone\r\nos:Linux 5.13.0-28-generic x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:9.3.0\r\nprocess_id:7171\r\nprocess_supervised:no\r\nrun_id:ccc3168db2356e8c87a684e924a0204e4792dc0a\r\ntcp_port:6379\r\nserver_time_usec:1644128405549859\r\nuptime_in_seconds:7\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:16738453\r\nexecutable:/home/nikhil/test redis/redis/src/redis-server\r\nconfig_file:\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:0\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:0\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:947400\r\nused_memory_human:925.20K\r\nused_memory_rss:6262784\r\nused_memory_rss_human:5.97M\r\nused_memory_peak:1060232\r\nused_memory_peak_human:1.01M\r\nused_memory_peak_perc:89.36%\r\nused_memory_overhead:830060\r\nused_memory_startup:829872\r\nused_memory_dataset:117340\r\nused_memory_dataset_perc:99.84%\r\nallocator_allocated:1006696\r\nallocator_active:1187840\r\nallocator_resident:4042752\r\ntotal_system_memory:8337719296\r\ntotal_system_memory_human:7.77G\r\nused_memory_lua:37888\r\nused_memory_vm_eval:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:37888\r\nused_memory_vm_total:75776\r\nused_memory_vm_total_human:74.00K\r\nused_memory_functions:184\r\nused_memory_scripts:184\r\nused_memory_scripts_human:184B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.18\r\nallocator_frag_bytes:181144\r\nallocator_rss_ratio:3.40\r\nallocator_rss_bytes:2854912\r\nrss_overhead_ratio:1.55\r\nrss_overhead_bytes:2220032\r\nmem_fragmentation_ratio:7.55\r\nmem_fragmentation_bytes:5432768\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:4\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:0\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.2.1\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:1\r\nrdb_last_save_time:1644128398\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:1\r\ntotal_commands_processed:3\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:64\r\ntotal_net_output_bytes:167628\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\nrejected_connections:0\r\nsync_full:1\r\nsync_partial_ok:0\r\nsync_partial_err:1\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:134\r\ntotal_forks:1\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:1\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:2\r\ntotal_writes_processed:4\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:1\r\nslave0:ip=127.0.0.1,port=0,state=wait_bgsave,offset=0,lag=0\r\nmaster_failover_state:no-failover\r\nmaster_replid:13e422441fb8cec64b82c2e259785a7bba615f39\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:1\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:1\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.000000\r\nused_cpu_user:0.009654\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:0.000000\r\nused_cpu_user_main_thread:0.009577\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_sync:calls=1,usec=0,usec_per_call=0.00,rejected_calls=0,failed_calls=0\r\ncmdstat_psync:calls=1,usec=194,usec_per_call=194.00,rejected_calls=0,failed_calls=1\r\ncmdstat_command|docs:calls=1,usec=955,usec_per_call=955.00,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\nerrorstat_ERR:count=1\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_sync:p50=0.001,p99=0.001,p99.9=0.001\r\nlatency_percentiles_usec_psync:p50=194.559,p99=194.559,p99.9=194.559\r\nlatency_percentiles_usec_command|docs:p50=958.463,p99=958.463,p99.9=958.463\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=3 addr=127.0.0.1:38654 laddr=127.0.0.1:6379 fd=8 name= age=0 idle=0 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 obl=46 oll=0 omem=0 tot-mem=40960 events=r cmd=sync user=default redir=-1 resp=2\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nio-threads-do-reads no\r\nlazyfree-lazy-eviction no\r\nlazyfree-lazy-expire no\r\nlazyfree-lazy-server-del no\r\nlazyfree-lazy-user-del no\r\nlazyfree-lazy-user-flush no\r\nrepl-diskless-sync yes\r\nreplica-read-only yes\r\nactivedefrag no\r\nrepl-diskless-load disabled\r\nsanitize-dump-payload no\r\nio-threads 1\r\nlist-compress-depth 0\r\nproto-max-bulk-len 512mb\r\nclient-query-buffer-limit 1gb\r\n\r\n------ FAST MEMORY TEST ------\r\n7171:M 06 Feb 2022 01:20:05.551 # Bio thread for job type #0 terminated\r\n7171:M 06 Feb 2022 01:20:05.551 # Bio thread for job type #1 terminated\r\n7171:M 06 Feb 2022 01:20:05.551 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 557cbe615000 (2293760 bytes)\r\n*** Preparing to test memory region 557cc00e7000 (135168 bytes)\r\n*** Preparing to test memory region 7f9965c1f000 (8388608 bytes)\r\n*** Preparing to test memory region 7f9966420000 (8388608 bytes)\r\n*** Preparing to test memory region 7f9966c21000 (8388608 bytes)\r\n*** Preparing to test memory region 7f9967422000 (8388608 bytes)\r\n*** Preparing to test memory region 7f9968a00000 (8388608 bytes)\r\n*** Preparing to test memory region 7f9969382000 (24576 bytes)\r\n*** Preparing to test memory region 7f9969576000 (16384 bytes)\r\n*** Preparing to test memory region 7f9969599000 (16384 bytes)\r\n*** Preparing to test memory region 7f99696f2000 (8192 bytes)\r\n*** Preparing to test memory region 7f9969737000 (4096 bytes)\r\n.O.O.7179:C 06 Feb 2022 01:20:05.563 * DB saved on disk\r\n7179:C 06 Feb 2022 01:20:05.563 * Fork CoW for RDB: current 1 MB, peak 1 MB, average 1 MB\r\nO.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version - Ubuntu 20.04.3 LTS \r\n2. Steps to reproduce (if any)\r\n    - Build using default make command\r\n    - Run single redis server instance with no arguments (i.e. default parameters) - `redis-server`\r\n    - Issue this redis-cli command on terminal - `echo -e 'psync\\rget\\ra' |  redis-cli`\r\n\r\n",
  "state": "closed",
  "created_at": "2022-02-06T06:38:08Z",
  "updated_at": "2022-02-06T11:13:56Z",
  "closed_at": "2022-02-06T11:13:56Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1030764668,
      "user": "enjoy-binbin",
      "created_at": "2022-02-06T06:50:19Z",
      "body": "It should be the same kind of problem https://github.com/redis/redis/pull/10020\r\n\r\nThanks - verified.\r\n\r\nNote just input psync a b will crash the server\r\n"
    },
    {
      "id": 1030774662,
      "user": "enjoy-binbin",
      "created_at": "2022-02-06T08:14:54Z",
      "body": "i think the reason is here (getLongLongFromObjectOrReply): https://github.com/redis/redis/blob/6ebb679f061b357b46e07898b4f72505ff5f3778/src/replication.c#L703-L718\r\n\r\nwe should check the offset in `syncCommand`, and abort it in this situation"
    }
  ]
}