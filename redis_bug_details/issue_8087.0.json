{
  "issue_number": 8087.0,
  "title": "[CRASH] activeExpireCycle crash",
  "body": "**Crash report**\r\n```\r\n6:M 24 Nov 2020 03:46:25.073 - DB 0: 1266 keys (1266 volatile) in 2048 slots HT.\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n6:M 24 Nov 2020 03:46:25.816 # Redis 6.0.4 crashed by signal: 11\r\n6:M 24 Nov 2020 03:46:25.816 # Crashed running the instruction at: 0x4acff8\r\n6:M 24 Nov 2020 03:46:25.816 # Accessing address: 0x6c656401030b\r\n6:M 24 Nov 2020 03:46:25.816 # Failed assertion: <no assertion failed> (<no file>:0)\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n/bin/redis-server 0.0.0.0:7005 [cluster](activeExpireCycle+0x248)[0x4acff8]\r\n\r\nBacktrace:\r\n/bin/redis-server 0.0.0.0:7005 [cluster](logStackTrace+0x41)[0x476401]\r\n/bin/redis-server 0.0.0.0:7005 [cluster](sigsegvHandler+0x96)[0x476a86]\r\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x12890)[0x7f828bcbb890]\r\n/bin/redis-server 0.0.0.0:7005 [cluster](activeExpireCycle+0x248)[0x4acff8]\r\n/bin/redis-server 0.0.0.0:7005 [cluster](databasesCron+0x10b)[0x4332ab]\r\n/bin/redis-server 0.0.0.0:7005 [cluster](serverCron+0x24a)[0x43614a]\r\n/bin/redis-server 0.0.0.0:7005 [cluster](aeProcessEvents+0x30b)[0x42ec2b]\r\n/bin/redis-server 0.0.0.0:7005 [cluster](aeMain+0x1d)[0x42ef0d]\r\n/bin/redis-server 0.0.0.0:7005 [cluster](main+0x4ed)[0x42b84d]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xe7)[0x7f828b8d9b97]\r\n/bin/redis-server 0.0.0.0:7005 [cluster][0x42ba8a]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:6.0.4\r\nredis_git_sha1:27eef119\r\nredis_git_dirty:1\r\nredis_build_id:a4e2b82597ed8ff0\r\nredis_mode:cluster\r\nos:Linux 3.10.0-1127.el7.x86_64 x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:atomic-builtin\r\ngcc_version:7.3.1\r\nprocess_id:6\r\nrun_id:752fafa14e2689bc4184d4b809cd07f2d8b15b74\r\ntcp_port:7005\r\nuptime_in_seconds:325832\r\nuptime_in_days:3\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:12354065\r\nexecutable:/bin/redis-server\r\nconfig_file:/cluster/redis.conf\r\n\r\n# Clients\r\nconnected_clients:1\r\nclient_recent_max_input_buffer:2\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:2674832\r\nused_memory_human:2.55M\r\nused_memory_rss:6098944\r\nused_memory_rss_human:5.82M\r\nused_memory_peak:18704352\r\nused_memory_peak_human:17.84M\r\nused_memory_peak_perc:14.30%\r\nused_memory_overhead:2552320\r\nused_memory_startup:1464216\r\nused_memory_dataset:122512\r\nused_memory_dataset_perc:10.12%\r\nallocator_allocated:2957560\r\nallocator_active:5447680\r\nallocator_resident:10326016\r\ntotal_system_memory:2964717568\r\ntotal_system_memory_human:2.76G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.84\r\nallocator_frag_bytes:2490120\r\nallocator_rss_ratio:1.90\r\nallocator_rss_bytes:4878336\r\nrss_overhead_ratio:0.59\r\nrss_overhead_bytes:-4227072\r\nmem_fragmentation_ratio:2.24\r\nmem_fragmentation_bytes:3380152\r\nmem_not_counted_for_evict:2740\r\nmem_replication_backlog:1048576\r\nmem_clients_slaves:16986\r\nmem_clients_normal:16986\r\nmem_aof_buffer:2740\r\nmem_allocator:jemalloc-5.1.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nrdb_changes_since_last_save:1980354\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1606188598\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:0\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:339968\r\naof_enabled:1\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:7708672\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\naof_current_size:61434481\r\naof_base_size:1924787\r\naof_pending_rewrite:0\r\naof_buffer_length:1629\r\naof_rewrite_buffer_length:0\r\naof_pending_bio_fsync:0\r\naof_delayed_fsync:0\r\n\r\n# Stats\r\ntotal_connections_received:22\r\ntotal_commands_processed:6770297\r\ninstantaneous_ops_per_sec:1768\r\ntotal_net_input_bytes:160803211\r\ntotal_net_output_bytes:330638216\r\ninstantaneous_input_kbps:5.60\r\ninstantaneous_output_kbps:267.77\r\nrejected_connections:0\r\nsync_full:1\r\nsync_partial_ok:0\r\nsync_partial_err:1\r\nexpired_keys:887050\r\nexpired_stale_perc:24.78\r\nexpired_time_cap_reached_count:126\r\nexpire_cycle_cpu_milliseconds:11725\r\nevicted_keys:0\r\nkeyspace_hits:213132\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:14108\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:1\r\nslave0:ip=192.168.192.130,port=7001,state=online,offset=403621744,lag=0\r\nmaster_replid:661d07f3a15716c9e314dc122e1d34cb17bc9a41\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:403626662\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:1\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:402578087\r\nrepl_backlog_histlen:1048576\r\n\r\n# CPU\r\nused_cpu_sys:422.630964\r\nused_cpu_user:165.213361\r\nused_cpu_sys_children:1.528267\r\nused_cpu_user_children:0.157220\r\n\r\n# Modules\r\nmodule:name=mw,ver=1,api=1,filters=1,usedby=[],using=[],options=[]\r\n\r\n# Commandstats\r\ncmdstat_setex:calls=1270418,usec=9592131,usec_per_call=7.55\r\ncmdstat_persist:calls=11,usec=70,usec_per_call=6.36\r\ncmdstat_mwhgetall:calls=19914,usec=159773,usec_per_call=8.02\r\ncmdstat_incrbyfloat:calls=6,usec=7154,usec_per_call=1192.33\r\ncmdstat_replconf:calls=4950,usec=5087,usec_per_call=1.03\r\ncmdstat_pexpire:calls=11,usec=121,usec_per_call=11.00\r\ncmdstat_incr:calls=11,usec=142,usec_per_call=12.91\r\ncmdstat_incrby:calls=11,usec=144,usec_per_call=13.09\r\ncmdstat_mwdel:calls=153228,usec=2775850,usec_per_call=18.12\r\ncmdstat_exec:calls=454390,usec=10480619,usec_per_call=23.07\r\ncmdstat_pttl:calls=18,usec=46,usec_per_call=2.56\r\ncmdstat_mwhexpire:calls=19914,usec=195186,usec_per_call=9.80\r\ncmdstat_mset:calls=11,usec=823,usec_per_call=74.82\r\ncmdstat_psync:calls=1,usec=534,usec_per_call=534.00\r\ncmdstat_zrevrange:calls=6,usec=55,usec_per_call=9.17\r\ncmdstat_cluster:calls=25,usec=30750,usec_per_call=1230.00\r\ncmdstat_sismember:calls=6,usec=14,usec_per_call=2.33\r\ncmdstat_zrevrangebylex:calls=6,usec=124,usec_per_call=20.67\r\ncmdstat_sscan:calls=6,usec=48,usec_per_call=8.00\r\ncmdstat_smembers:calls=173148,usec=519529,usec_per_call=3.00\r\ncmdstat_get:calls=39828,usec=48230,usec_per_call=1.21\r\ncmdstat_save:calls=4,usec=98548,usec_per_call=24637.00\r\ncmdstat_sadd:calls=1315807,usec=6488610,usec_per_call=4.93\r\ncmdstat_ping:calls=57299,usec=27721,usec_per_call=0.48\r\ncmdstat_msetnx:calls=6,usec=17,usec_per_call=2.83\r\ncmdstat_bitfield:calls=11,usec=9890,usec_per_call=899.09\r\ncmdstat_set:calls=65275,usec=186185,usec_per_call=2.85\r\ncmdstat_zrevrank:calls=6,usec=36,usec_per_call=6.00\r\ncmdstat_mwhsetex:calls=1106760,usec=18755220,usec_per_call=16.95\r\ncmdstat_mwhget:calls=19914,usec=127187,usec_per_call=6.39\r\ncmdstat_setbit:calls=11,usec=731,usec_per_call=66.45\r\ncmdstat_sinter:calls=6,usec=8535,usec_per_call=1422.50\r\ncmdstat_sunion:calls=6,usec=63,usec_per_call=10.50\r\ncmdstat_srem:calls=1091757,usec=3765777,usec_per_call=3.45\r\ncmdstat_ttl:calls=6,usec=15,usec_per_call=2.50\r\ncmdstat_restore-asking:calls=4,usec=318,usec_per_call=79.50\r\ncmdstat_getbit:calls=6,usec=17,usec_per_call=2.83\r\ncmdstat_mget:calls=60,usec=45,usec_per_call=0.75\r\ncmdstat_multi:calls=454390,usec=53642,usec_per_call=0.12\r\ncmdstat_zscan:calls=6,usec=39,usec_per_call=6.50\r\ncmdstat_select:calls=1,usec=1,usec_per_call=1.00\r\ncmdstat_command:calls=6,usec=5628,usec_per_call=938.00\r\ncmdstat_info:calls=2,usec=120,usec_per_call=60.00\r\ncmdstat_expireat:calls=6,usec=66,usec_per_call=11.00\r\ncmdstat_del:calls=446620,usec=2177624,usec_per_call=4.88\r\ncmdstat_sinterstore:calls=11,usec=103849,usec_per_call=9440.82\r\ncmdstat_zadd:calls=33,usec=1528,usec_per_call=46.30\r\ncmdstat_sunionstore:calls=11,usec=219,usec_per_call=19.91\r\ncmdstat_expire:calls=56434,usec=121280,usec_per_call=2.15\r\ncmdstat_mwhdel:calls=19914,usec=249102,usec_per_call=12.51\r\ncmdstat_zrevrangebyscore:calls=6,usec=86,usec_per_call=14.33\r\n\r\n# Cluster\r\ncluster_enabled:1\r\n\r\n# Keyspace\r\ndb0:keys=28,expires=28,avg_ttl=315\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=642036 addr=192.168.192.130:43896 fd=20 name= age=5003 idle=0 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=1565 oll=0 omem=0 events=r cmd=replconf user=default\r\nid=2786529 addr=192.168.192.130:45836 fd=7 name= age=123 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=4 oll=0 omem=0 events=r cmd=mwhsetex user=default\r\n\r\n------ REGISTERS ------\r\n6:M 24 Nov 2020 03:46:25.871 # \r\nRAX:00007f828b5e11cb RBX:00007e0c9301fc3e\r\nRCX:00007f8280000000 RDX:00007f828b600900\r\nRDI:00007f828b402f58 RSI:00006c6564010303\r\nRBP:00006c6564010303 RSP:00007ffdcba4df50\r\nR8 :0000000000000068 R9 :0000000000000012\r\nR10:0000000000000012 R11:0000000000000006\r\nR12:00007e0c93022132 R13:0000000000000008\r\nR14:00000175f85c158d R15:000000000000000b\r\nRIP:00000000004acff8 EFL:0000000000010206\r\nCSGSFS:0000000000000033\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df5f) -> 0000000000000007\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df5e) -> 0000000000000001\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df5d) -> 000000100000000f\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df5c) -> 00000000000061a8\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df5b) -> 0005b4d227b430e3\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df5a) -> 000000000000000a\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df59) -> 0000000000000005\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df58) -> 0000000000000014\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df57) -> 0000000000000014\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df56) -> 0000000100000011\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df55) -> 0000000000000190\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df54) -> 0000000000000014\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df53) -> 000000000000000b\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df52) -> 0000000000000003\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df51) -> 000000000052b1fe\r\n6:M 24 Nov 2020 03:46:25.871 # (00007ffdcba4df50) -> 00007f828b506000\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ FAST MEMORY TEST ------\r\n6:M 24 Nov 2020 03:46:25.884 # Bio thread for job type #0 terminated\r\n6:M 24 Nov 2020 03:46:25.888 # Bio thread for job type #1 terminated\r\n6:M 24 Nov 2020 03:46:25.918 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 7c7000 (2277376 bytes)\r\n*** Preparing to test memory region 23a0000 (274432 bytes)\r\n*** Preparing to test memory region 7f8280000000 (135168 bytes)\r\n*** Preparing to test memory region 7f8285a00000 (33554432 bytes)\r\n*** Preparing to test memory region 7f8287c00000 (8388608 bytes)\r\n*** Preparing to test memory region 7f8288400000 (2097152 bytes)\r\n*** Preparing to test memory region 7f82887db000 (2621440 bytes)\r\n*** Preparing to test memory region 7f8288a5c000 (8388608 bytes)\r\n*** Preparing to test memory region 7f828925d000 (8388608 bytes)\r\n*** Preparing to test memory region 7f8289a5e000 (8388608 bytes)\r\n*** Preparing to test memory region 7f828a25f000 (8388608 bytes)\r\n*** Preparing to test memory region 7f828affc000 (16384 bytes)\r\n*** Preparing to test memory region 7f828b000000 (8388608 bytes)\r\n*** Preparing to test memory region 7f828bca5000 (16384 bytes)\r\n*** Preparing to test memory region 7f828bec4000 (16384 bytes)\r\n*** Preparing to test memory region 7f828c88f000 (32768 bytes)\r\n*** Preparing to test memory region 7f828c89b000 (4096 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: activeExpireCycle (base: 0x4acdb0)\r\nModule: /bin/redis-server 0.0.0.0:7005 [cluster] (base 0x400000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x4acdb0 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n6:M 24 Nov 2020 03:46:27.587 # dump of function (hexdump of 592 bytes):\r\n4157415641554154555389fb4883ec788b2d62043200e8555bf8ff4889442458e87b9bf9ff85c00f859c0400008d75ffb80a0000004863f64c69c6fa0000004829f048894424504981c0e803000083fb010f84ad0400008b0d5304320083f90f894c246c0f8f7f040000488d44361948633da2fc310031d2c70526f53100000000004869c040420f0048f7f748bac3f5285c8fc2f5288b7c246c48c1e80248f7e24889d0ba0100000048c1e8024885c0480f44c283fb014c0f45c085ff4c894424600f8ea8030000488d44b614c744243000000000c74424680000000048c74424480000000048c74424400000000048894424388b359ef4310031d289f083c601f7f189358ff4310089d0488d14c0488b050afc3100488d04d0488904246690488b04248344243001488b40084c8b70484c0370280f849d030000488b683848036818e8485af8ff4989c54883fd04761a4b8d04b631d2488d048048c1e00248f7f54885c00f8409020000488b4424388b5424304c39f04c0f46f083e20f4f8d3cb64d85f64c89742420895424344a8d0cbd0000000048894c24280f84f70100004885c90f8eee010000488b04244531e44531ff4589e648c7442418000000004d89ec48c7442410000000004d89fd488b48380f1f440000488b04244c89fdc744240c000000004d89ef488b50084c89e04589f44989c6486344240c4883442418014889c74883c00148c1e00548c1e705488b3402488b443a104821ce488b34f04885f674584589e54989eceb1a66904885db7e074901dc4183c5014983c7014885ed4889ee7428488b4608488b6e10\r\nFunction at 0x432920 is ustime\r\nFunction at 0x446950 is clientsArePaused\r\nFunction at 0x432940 is mstime\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n       Please report the crash by opening an issue on github:\r\n\r\n           http://github.com/antirez/redis/issues\r\n\r\n  Suspect RAM error? Use redis-server --test-memory to verify it.\r\n\r\nSegmentation fault (core dumped)\r\n```\r\n\r\n**Aditional information**\r\n```\r\n(gdb) bt\r\n#0  activeExpireCycle (type=type@entry=0) at expire.c:270\r\n#1  0x0000000000432ae7 in databasesCron () at server.c:1694\r\n#2  0x000000000043597a in serverCron (eventLoop=<optimized out>, id=<optimized out>, clientData=<optimized out>) at server.c:1964\r\n#3  0x000000000042e54b in processTimeEvents (eventLoop=0x7f153160b480) at ae.c:357\r\n#4  aeProcessEvents (eventLoop=eventLoop@entry=0x7f153160b480, flags=flags@entry=27) at ae.c:509\r\n#5  0x000000000042e82d in aeMain (eventLoop=0x7f153160b480) at ae.c:539\r\n#6  0x000000000042b16d in main (argc=<optimized out>, argv=0x7ffc5ba4e428) at server.c:5171\r\n(gdb) bt full\r\n#0  activeExpireCycle (type=type@entry=0) at expire.c:270\r\n        e = 0x6c6564010303\r\n        idx = <optimized out>\r\n        de = 0x6c6564010303\r\n        ttl = <optimized out>\r\n        table = <optimized out>\r\n        slots = <optimized out>\r\n        checked_buckets = 88\r\n        num = 20\r\n        now = 1605771839030\r\n        ttl_sum = 138122681626953\r\n        ttl_samples = 3\r\n        max_buckets = 400\r\n        expired = 2\r\n        sampled = 5\r\n        db = 0x7f1531659000\r\n        effort = <optimized out>\r\n        config_keys_per_loop = <optimized out>\r\n        config_cycle_fast_duration = <optimized out>\r\n        config_cycle_slow_time_perc = <optimized out>\r\n        config_cycle_acceptable_stale = <optimized out>\r\n        current_db = 81994449\r\n        timelimit_exit = 0\r\n        last_fast_cycle = 1605771838399289\r\n        j = <optimized out>\r\n        iteration = 25\r\n        dbs_per_call = 16\r\n        start = 1605771839029054\r\n        timelimit = 25000\r\n        elapsed = <optimized out>\r\n        total_sampled = 131\r\n        total_expired = 58\r\n        current_perc = <optimized out>\r\n```\r\n1. OS distribution and version\r\n      centos 7.6\r\n2. Steps to reproduce (if any)\r\n   **Preconditions**\r\n     * register a module \r\n     * in module onload function, register a notifycation callback: `RedisModule_SubscribeToKeyspaceEvents(ctx, mask, SubCallback)` \r\n```\r\n         //in notifycation callback\r\n         if (keya is expired) {\r\n                 use RM_Call delete keyb\r\n         }\r\n```\r\n  **Step**\r\n    1、Set keya and keyb\r\n    2、set expire keya and keyb, keya and keyb may be continuously stored in the expire dict\r\n    3、activeExpireCycle  expire keya，then trigger notifycation callback. keyb will be deleted in the callback.\r\n\r\n ```\r\n                 //expire.c:262:  activeExpireCycle()    redis 6.0.4\r\n                 /* Scan the current bucket of the current table. */\r\n                    checked_buckets++;\r\n                    while(de) {\r\n                        /* Get the next entry now since this entry may get\r\n                         * deleted. */\r\n                        dictEntry *e = de;       // e is keya, the next entry is keyb\r\n                        de = de->next;          //de point keyb\r\n\r\n                        ttl = dictGetSignedIntegerVal(e)-now;\r\n\r\n                        // keya will be expired, and keyb will be deleted in the notifycation callback\r\n                        // then \"de\" is invalid, next cycle may crash\r\n                        if (activeExpireCycleTryExpire(db,e,now)) expired++;\r\n                        if (ttl > 0) {\r\n                            /* We want the average TTL of keys yet\r\n                             * not expired. */\r\n                            ttl_sum += ttl;\r\n                            ttl_samples++;\r\n                        }\r\n                        sampled++;\r\n                    }\r\n```\r\n",
  "state": "open",
  "created_at": "2020-11-24T07:37:38Z",
  "updated_at": "2020-11-24T14:34:13Z",
  "closed_at": null,
  "labels": [],
  "comments_data": [
    {
      "id": 732781300,
      "user": "ShooterIT",
      "created_at": "2020-11-24T09:46:05Z",
      "body": "It is a interesting bug :)\r\nWhat a coincidence! In most cases, one hash slot doesn't have many entries. But your two keys both are in the same slot."
    }
  ]
}