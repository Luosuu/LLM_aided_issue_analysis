{
  "issue_number": 10162.0,
  "title": "[CRASH] Redis 6.2.5 calling script - Apple M1 docker - ReJSON",
  "body": "**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n\r\n1:M 22 Jan 2022 21:37:12.022 # Redis 6.2.5 crashed by signal: 11, si_code: 1\r\n\r\n1:M 22 Jan 2022 21:37:12.022 # Accessing address: 0x4000166a\r\n\r\n1:M 22 Jan 2022 21:37:12.022 # Crashed running the instruction at: 0x400004b644\r\n\r\n\r\n------ STACK TRACE ------\r\n\r\nEIP:\r\n\r\n/usr/local/bin/redis-server *:6379(dictSdsKeyCompare+0x34)[0x400004b644]\r\n\r\n\r\nBacktrace:\r\n\r\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x14140)[0x4002158140]\r\n\r\n/usr/local/bin/redis-server *:6379(dictSdsKeyCompare+0x34)[0x400004b644]\r\n\r\n/usr/local/bin/redis-server *:6379(dictAddRaw+0x155)[0x4000049af5]\r\n\r\n/usr/local/bin/redis-server *:6379(dictAdd+0x11)[0x4000049c81]\r\n\r\n/usr/local/bin/redis-server *:6379(dbAdd+0x25)[0x400006fbe5]\r\n\r\n/usr/local/bin/redis-server *:6379(hashTypeLookupWriteOrCreate+0x67)[0x4000092637]\r\n\r\n/usr/local/bin/redis-server *:6379(hsetCommand+0x30)[0x4000092bf0]\r\n\r\n/usr/local/bin/redis-server *:6379(call+0xa1)[0x400004f161]\r\n\r\n/usr/local/bin/redis-server *:6379(luaRedisGenericCommand+0x389)[0x40000b5ef9]\r\n\r\n/usr/local/bin/redis-server *:6379(+0x10d378)[0x400010d378]\r\n\r\n/usr/local/bin/redis-server *:6379(+0x1175b0)[0x40001175b0]\r\n\r\n/usr/local/bin/redis-server *:6379(+0x10da15)[0x400010da15]\r\n\r\n/usr/local/bin/redis-server *:6379(+0x10cd48)[0x400010cd48]\r\n\r\n/usr/local/bin/redis-server *:6379(+0x10dbc0)[0x400010dbc0]\r\n\r\n/usr/local/bin/redis-server *:6379(lua_pcall+0x48)[0x400010b0a8]\r\n\r\n/usr/local/bin/redis-server *:6379(evalGenericCommand+0x1f0)[0x40000b3870]\r\n\r\n/usr/local/bin/redis-server *:6379(call+0xa1)[0x400004f161]\r\n\r\n/usr/local/bin/redis-server *:6379(processCommand+0x5b3)[0x4000050d03]\r\n\r\n/usr/local/bin/redis-server *:6379(processInputBuffer+0xf8)[0x4000063c28]\r\n\r\n/usr/local/bin/redis-server *:6379(+0xfac98)[0x40000fac98]\r\n\r\n/usr/local/bin/redis-server *:6379(aeProcessEvents+0x292)[0x4000047d82]\r\n\r\n/usr/local/bin/redis-server *:6379(aeMain+0x1d)[0x4000047fed]\r\n\r\n/usr/local/bin/redis-server *:6379(main+0x316)[0x4000044286]\r\n\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xea)[0x400218cd0a]\r\n\r\n/usr/local/bin/redis-server *:6379(_start+0x2a)[0x400004475a]\r\n\r\n\r\n------ REGISTERS ------\r\n\r\n1:M 22 Jan 2022 21:37:12.030 # \r\n\r\nRAX:000000400004b6e8 RBX:000000400293c430\r\n\r\nRCX:000000400019b220 RDX:0000000000000044\r\n\r\nRDI:000000400629c283 RSI:400000004000166b\r\n\r\nRBP:0000000000000000 RSP:0000004001c3f4c8\r\n\r\nR8 :0000000000000000 R9 :00000040026000c0\r\n\r\nR10:0000000000000005 R11:000000400293a000\r\n\r\nR12:0000004001c3e399 R13:000000400293c450\r\n\r\nR14:000000400293c420 R15:000000400629c283\r\n\r\nRIP:000000400004b644 EFL:0000000000000207\r\n\r\nCSGSFS:002b000000000033\r\n\r\n1:M 22 Jan 2022 21:37:12.030 # (0000004001c3f4d7) -> 0000004002a35000\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4d6) -> 00000040061f7cf0\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4d5) -> 00000040061f7d50\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4d4) -> 0000004000049c81\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4d3) -> 0000004000209350\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4d2) -> 00000012f1780fe9\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4d1) -> 0000004002a42540\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4d0) -> 00000040061f7d50\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4cf) -> 00000040061f7cf0\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4ce) -> 000000400293c420\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4cd) -> 0000000000000001\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4cc) -> 000000000000017b\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4cb) -> 000000400293c470\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4ca) -> 0000000000000bd8\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4c9) -> 5f6518bc5329297b\r\n\r\n1:M 22 Jan 2022 21:37:12.031 # (0000004001c3f4c8) -> 0000004000049af5\r\n\r\n\r\n------ INFO OUTPUT ------\r\n\r\n# Server\r\n\r\nredis_version:6.2.5\r\n\r\nredis_git_sha1:00000000\r\n\r\nredis_git_dirty:0\r\n\r\nredis_build_id:3afff201ac09d18c\r\n\r\nredis_mode:standalone\r\n\r\nos:Linux 5.10.76-linuxkit x86_64\r\n\r\narch_bits:64\r\n\r\nmultiplexing_api:epoll\r\n\r\natomicvar_api:atomic-builtin\r\n\r\ngcc_version:10.2.1\r\n\r\nprocess_id:1\r\n\r\nprocess_supervised:no\r\n\r\nrun_id:9db7c01289f160a850ea0596de1a8c78dc7ea7ef\r\n\r\ntcp_port:6379\r\n\r\nserver_time_usec:1642887432021178\r\n\r\nuptime_in_seconds:104\r\n\r\nuptime_in_days:0\r\n\r\nhz:10\r\n\r\nconfigured_hz:10\r\n\r\nlru_clock:15497479\r\n\r\nexecutable:/usr/local/bin/redis-server\r\n\r\nconfig_file:\r\n\r\nio_threads_active:0\r\n\r\n\r\n# Clients\r\n\r\nconnected_clients:22\r\n\r\ncluster_connections:0\r\n\r\nmaxclients:10000\r\n\r\nclient_recent_max_input_buffer:731\r\n\r\nclient_recent_max_output_buffer:0\r\n\r\nblocked_clients:4\r\n\r\ntracking_clients:0\r\n\r\nclients_in_timeout_table:4\r\n\r\n\r\n# Memory\r\n\r\nused_memory:3790216\r\n\r\nused_memory_human:3.61M\r\n\r\nused_memory_rss:0\r\n\r\nused_memory_rss_human:0B\r\n\r\nused_memory_peak:4012296\r\n\r\nused_memory_peak_human:3.83M\r\n\r\nused_memory_peak_perc:94.47%\r\n\r\nused_memory_overhead:1443336\r\n\r\nused_memory_startup:904800\r\n\r\nused_memory_dataset:2346880\r\n\r\nused_memory_dataset_perc:81.34%\r\n\r\nallocator_allocated:3801080\r\n\r\nallocator_active:4284416\r\n\r\nallocator_resident:7626752\r\n\r\ntotal_system_memory:2085158912\r\n\r\ntotal_system_memory_human:1.94G\r\n\r\nused_memory_lua:65536\r\n\r\nused_memory_lua_human:64.00K\r\n\r\nused_memory_scripts:19728\r\n\r\nused_memory_scripts_human:19.27K\r\n\r\nnumber_of_cached_scripts:6\r\n\r\nmaxmemory:0\r\n\r\nmaxmemory_human:0B\r\n\r\nmaxmemory_policy:noeviction\r\n\r\nallocator_frag_ratio:1.13\r\n\r\nallocator_frag_bytes:483336\r\n\r\nallocator_rss_ratio:1.78\r\n\r\nallocator_rss_bytes:3342336\r\n\r\nrss_overhead_ratio:0.00\r\n\r\nrss_overhead_bytes:-7626752\r\n\r\nmem_fragmentation_ratio:0.00\r\n\r\nmem_fragmentation_bytes:-3729032\r\n\r\nmem_not_counted_for_evict:0\r\n\r\nmem_replication_backlog:0\r\n\r\nmem_clients_slaves:0\r\n\r\nmem_clients_normal:452512\r\n\r\nmem_aof_buffer:0\r\n\r\nmem_allocator:jemalloc-5.1.0\r\n\r\nactive_defrag_running:0\r\n\r\nlazyfree_pending_objects:0\r\n\r\nlazyfreed_objects:0\r\n\r\n\r\n# Persistence\r\n\r\nloading:0\r\n\r\ncurrent_cow_size:0\r\n\r\ncurrent_cow_size_age:0\r\n\r\ncurrent_fork_perc:0.00\r\n\r\ncurrent_save_keys_processed:0\r\n\r\ncurrent_save_keys_total:0\r\n\r\nrdb_changes_since_last_save:502\r\n\r\nrdb_bgsave_in_progress:0\r\n\r\nrdb_last_save_time:1642887328\r\n\r\nrdb_last_bgsave_status:ok\r\n\r\nrdb_last_bgsave_time_sec:-1\r\n\r\nrdb_current_bgsave_time_sec:-1\r\n\r\nrdb_last_cow_size:0\r\n\r\naof_enabled:0\r\n\r\naof_rewrite_in_progress:0\r\n\r\naof_rewrite_scheduled:0\r\n\r\naof_last_rewrite_time_sec:-1\r\n\r\naof_current_rewrite_time_sec:-1\r\n\r\naof_last_bgrewrite_status:ok\r\n\r\naof_last_write_status:ok\r\n\r\naof_last_cow_size:0\r\n\r\nmodule_fork_in_progress:0\r\n\r\nmodule_fork_last_cow_size:0\r\n\r\n\r\n# Stats\r\n\r\ntotal_connections_received:22\r\n\r\ntotal_commands_processed:1403\r\n\r\ninstantaneous_ops_per_sec:29\r\n\r\ntotal_net_input_bytes:315081\r\n\r\ntotal_net_output_bytes:563246\r\n\r\ninstantaneous_input_kbps:2.13\r\n\r\ninstantaneous_output_kbps:5.87\r\n\r\nrejected_connections:0\r\n\r\nsync_full:0\r\n\r\nsync_partial_ok:0\r\n\r\nsync_partial_err:0\r\n\r\nexpired_keys:0\r\n\r\nexpired_stale_perc:0.00\r\n\r\nexpired_time_cap_reached_count:0\r\n\r\nexpire_cycle_cpu_milliseconds:24\r\n\r\nevicted_keys:0\r\n\r\nkeyspace_hits:1271\r\n\r\nkeyspace_misses:78\r\n\r\npubsub_channels:8\r\n\r\npubsub_patterns:0\r\n\r\nlatest_fork_usec:0\r\n\r\ntotal_forks:0\r\n\r\nmigrate_cached_sockets:0\r\n\r\nslave_expires_tracked_keys:0\r\n\r\nactive_defrag_hits:0\r\n\r\nactive_defrag_misses:0\r\n\r\nactive_defrag_key_hits:0\r\n\r\nactive_defrag_key_misses:0\r\n\r\ntracking_total_keys:0\r\n\r\ntracking_total_items:0\r\n\r\ntracking_total_prefixes:0\r\n\r\nunexpected_error_replies:0\r\n\r\ntotal_error_replies:41\r\n\r\ndump_payload_sanitizations:0\r\n\r\ntotal_reads_processed:387\r\n\r\ntotal_writes_processed:764\r\n\r\nio_threaded_reads_processed:0\r\n\r\nio_threaded_writes_processed:0\r\n\r\n\r\n# Replication\r\n\r\nrole:master\r\n\r\nconnected_slaves:0\r\n\r\nmaster_failover_state:no-failover\r\n\r\nmaster_replid:a740067518cdb3377a576b9b36354c391a907c9a\r\n\r\nmaster_replid2:0000000000000000000000000000000000000000\r\n\r\nmaster_repl_offset:0\r\n\r\nsecond_repl_offset:-1\r\n\r\nrepl_backlog_active:0\r\n\r\nrepl_backlog_size:1048576\r\n\r\nrepl_backlog_first_byte_offset:0\r\n\r\nrepl_backlog_histlen:0\r\n\r\n\r\n# CPU\r\n\r\nused_cpu_sys:0.842743\r\n\r\nused_cpu_user:1.708462\r\n\r\nused_cpu_sys_children:0.011343\r\n\r\nused_cpu_user_children:0.049196\r\n\r\nused_cpu_sys_main_thread:0.832938\r\n\r\nused_cpu_user_main_thread:1.685633\r\n\r\n\r\n# Modules\r\n\r\nmodule:name=ReJSON,ver=20004,api=1,filters=0,usedby=[search],using=[],options=[handle-io-errors]\r\n\r\nmodule:name=search,ver=20205,api=1,filters=0,usedby=[],using=[ReJSON],options=[handle-io-errors]\r\n\r\n\r\n# Commandstats\r\n\r\ncmdstat_get:calls=22,usec=234,usec_per_call=10.64,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_rpoplpush:calls=43,usec=207,usec_per_call=4.81,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_expire:calls=1,usec=249,usec_per_call=249.00,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_monitor:calls=1,usec=126,usec_per_call=126.00,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_zrangebyscore:calls=57,usec=5103,usec_per_call=89.53,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_evalsha:calls=157,usec=244241,usec_per_call=1555.68,rejected_calls=0,failed_calls=20\r\n\r\ncmdstat_zscore:calls=22,usec=1428,usec_per_call=64.91,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_multi:calls=22,usec=86,usec_per_call=3.91,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_zrem:calls=44,usec=1538,usec_per_call=34.95,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_del:calls=22,usec=484,usec_per_call=22.00,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_exists:calls=80,usec=555,usec_per_call=6.94,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_lrem:calls=44,usec=1272,usec_per_call=28.91,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_auth:calls=21,usec=334,usec_per_call=15.90,rejected_calls=0,failed_calls=21\r\n\r\ncmdstat_hmset:calls=44,usec=1688,usec_per_call=38.36,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_command:calls=1,usec=10173,usec_per_call=10173.00,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_hset:calls=45,usec=1409,usec_per_call=31.31,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_keys:calls=1,usec=366,usec_per_call=366.00,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_smembers:calls=4,usec=63,usec_per_call=15.75,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_info:calls=14,usec=7414,usec_per_call=529.57,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_json.set:calls=68,usec=21506,usec_per_call=316.26,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_zrange:calls=78,usec=3810,usec_per_call=48.85,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_zadd:calls=65,usec=4267,usec_per_call=65.65,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_lpush:calls=23,usec=1594,usec_per_call=69.30,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_publish:calls=224,usec=2361,usec_per_call=10.54,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_lrange:calls=4,usec=40,usec_per_call=10.00,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_hget:calls=23,usec=538,usec_per_call=23.39,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_exec:calls=22,usec=4246,usec_per_call=193.00,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_hgetall:calls=65,usec=1886,usec_per_call=29.02,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_srem:calls=44,usec=319,usec_per_call=7.25,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_brpoplpush:calls=35,usec=6332,usec_per_call=180.91,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_client:calls=26,usec=228,usec_per_call=8.77,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_set:calls=30,usec=3504,usec_per_call=116.80,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_subscribe:calls=8,usec=378,usec_per_call=47.25,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_eval:calls=20,usec=86805,usec_per_call=4340.25,rejected_calls=0,failed_calls=0\r\n\r\ncmdstat_incr:calls=23,usec=787,usec_per_call=34.22,rejected_calls=0,failed_calls=0\r\n\r\n\r\n# Errorstats\r\n\r\nerrorstat_ERR:count=21\r\n\r\nerrorstat_NOSCRIPT:count=20\r\n\r\n\r\n# Cluster\r\n\r\ncluster_enabled:0\r\n\r\n\r\n# Keyspace\r\n\r\ndb0:keys=1024,expires=21,avg_ttl=24087363\r\n\r\n\r\n------ CLIENT LIST OUTPUT ------\r\n\r\nid=9 addr=172.17.0.1:59028 laddr=172.17.0.3:6379 fd=10 name=local:bull:Y2Fk age=20 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=729 qbuf-free=40225 argv-mem=589 obl=0 oll=0 omem=0 tot-mem=62189 events=r cmd=evalsha user=default redir=-1\r\n\r\nid=10 addr=172.17.0.1:59030 laddr=172.17.0.3:6379 fd=11 name=local:bull:Y2FkLWNhY2hl age=20 idle=4 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20584 events=r cmd=evalsha user=default redir=-1\r\n\r\nid=11 addr=172.17.0.1:59032 laddr=172.17.0.3:6379 fd=12 name=local:bull:ZGlzY29yZA== age=20 idle=4 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20584 events=r cmd=evalsha user=default redir=-1\r\n\r\nid=12 addr=172.17.0.1:59034 laddr=172.17.0.3:6379 fd=13 name= age=20 idle=19 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20512 events=r cmd=publish user=default redir=-1\r\n\r\nid=13 addr=172.17.0.1:59026 laddr=172.17.0.3:6379 fd=14 name=local:bull:Y2Fk age=20 idle=1 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=hgetall user=default redir=-1\r\n\r\nid=14 addr=172.17.0.1:59038 laddr=172.17.0.3:6379 fd=15 name= age=20 idle=19 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=info user=default redir=-1\r\n\r\nid=15 addr=172.17.0.1:59036 laddr=172.17.0.3:6379 fd=16 name=local:bull:cGF0cm9scw== age=20 idle=4 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20584 events=r cmd=evalsha user=default redir=-1\r\n\r\nid=7 addr=172.17.0.1:59022 laddr=172.17.0.3:6379 fd=8 name= age=30 idle=0 flags=O db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=879 oll=0 omem=0 tot-mem=20496 events=r cmd=monitor user=default redir=-1\r\n\r\nid=8 addr=172.17.0.1:59024 laddr=172.17.0.3:6379 fd=9 name=local:bull:ZGlzY29yZC1ub3RpZg== age=20 idle=19 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=info user=default redir=-1\r\n\r\nid=16 addr=172.17.0.1:59044 laddr=172.17.0.3:6379 fd=17 name= age=19 idle=19 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=info user=default redir=-1\r\n\r\nid=17 addr=172.17.0.1:59046 laddr=172.17.0.3:6379 fd=18 name= age=19 idle=15 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\n\r\nid=18 addr=172.17.0.1:59050 laddr=172.17.0.3:6379 fd=19 name= age=19 idle=19 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=info user=default redir=-1\r\n\r\nid=19 addr=172.17.0.1:59052 laddr=172.17.0.3:6379 fd=20 name= age=19 idle=19 flags=P db=0 sub=4 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=subscribe user=default redir=-1\r\n\r\nid=25 addr=172.17.0.1:59064 laddr=172.17.0.3:6379 fd=26 name=local:bull:cGF0cm9scw== age=19 idle=4 flags=b db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=59 obl=0 oll=0 omem=0 tot-mem=20579 events=r cmd=brpoplpush user=default redir=-1\r\n\r\nid=26 addr=172.17.0.1:59066 laddr=172.17.0.3:6379 fd=27 name=local:bull:ZGlzY29yZA== age=19 idle=4 flags=b db=0 sub=0 psub=0 multi=-1 qbuf=540 qbuf-free=0 argv-mem=59 obl=0 oll=0 omem=0 tot-mem=21211 events=r cmd=brpoplpush user=default redir=-1\r\n\r\nid=27 addr=172.17.0.1:59068 laddr=172.17.0.3:6379 fd=28 name=local:bull:Y2FkLWNhY2hl age=19 idle=4 flags=b db=0 sub=0 psub=0 multi=-1 qbuf=94 qbuf-free=0 argv-mem=63 obl=0 oll=0 omem=0 tot-mem=20687 events=r cmd=brpoplpush user=default redir=-1\r\n\r\nid=28 addr=172.17.0.1:59070 laddr=172.17.0.3:6379 fd=29 name=local:bull:Y2Fk age=19 idle=0 flags=b db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=82 argv-mem=51 obl=0 oll=0 omem=0 tot-mem=20659 events=r cmd=brpoplpush user=default redir=-1\r\n\r\nid=20 addr=172.17.0.1:59048 laddr=172.17.0.3:6379 fd=21 name= age=19 idle=19 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\n\r\nid=21 addr=172.17.0.1:59056 laddr=172.17.0.3:6379 fd=22 name=local:bull:Y2FkLWNhY2hl age=19 idle=19 flags=P db=0 sub=1 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=subscribe user=default redir=-1\r\n\r\nid=22 addr=172.17.0.1:59058 laddr=172.17.0.3:6379 fd=23 name=local:bull:Y2Fk age=19 idle=0 flags=P db=0 sub=1 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=subscribe user=default redir=-1\r\n\r\nid=23 addr=172.17.0.1:59062 laddr=172.17.0.3:6379 fd=24 name=local:bull:ZGlzY29yZA== age=19 idle=19 flags=P db=0 sub=1 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=subscribe user=default redir=-1\r\n\r\nid=24 addr=172.17.0.1:59060 laddr=172.17.0.3:6379 fd=25 name=local:bull:cGF0cm9scw== age=19 idle=4 flags=P db=0 sub=1 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=subscribe user=default redir=-1\r\n\r\n\r\n------ CURRENT CLIENT INFO ------\r\n\r\nid=9 addr=172.17.0.1:59028 laddr=172.17.0.3:6379 fd=10 name=local:bull:Y2Fk age=20 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=729 qbuf-free=40225 argv-mem=589 obl=0 oll=0 omem=0 tot-mem=62189 events=r cmd=evalsha user=default redir=-1\r\n\r\nargv[0]: 'evalsha'\r\n\r\nargv[1]: '8f55ae4a3be429c6d38c5d5db3e80edf89197b64'\r\n\r\nargv[2]: '6'\r\n\r\nargv[3]: 'local:bull:cad:wait'\r\n\r\nargv[4]: 'local:bull:cad:paused'\r\n\r\nargv[5]: 'local:bull:cad:meta-paused'\r\n\r\nargv[6]: 'local:bull:cad:id'\r\n\r\nargv[7]: 'local:bull:cad:delayed'\r\n\r\nargv[8]: 'local:bull:cad:priority'\r\n\r\nargv[9]: 'local:bull:cad:'\r\n\r\nargv[10]: 'repeat:757805924c3d6f0c532f0e36651e4769:1642887433000'\r\n\r\nargv[11]: 'warn inactivity'\r\n\r\nargv[12]: '{}'\r\n\r\nargv[13]: '{\"repeat\":{\"count\":970,\"key\":\"warn inactivity:inactivity-warning::1000\",\"every\":1000,\"jobId\":\"inactivity-warning\"},\"jobId\":\"repeat:757805924c3d6f0c532f0e36651e4769:1642887433000\",\"delay\":980,\"timestamp\":1642887432020,\"prevMillis\":1642887433000,\"attempts\":1}'\r\n\r\nargv[14]: '1642887432020'\r\n\r\nargv[15]: '980'\r\n\r\nargv[16]: '1642887433000'\r\n\r\nargv[17]: '0'\r\n\r\nargv[18]: 'LPUSH'\r\n\r\nargv[19]: 'e9288e3f-961b-4a08-a6aa-19fb873b5ab2'\r\n\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n# ReJSON_trace\r\n\r\nReJSON_trace:   0: redis_module::base_info_func\r\n\r\n   1: modulesCollectInfo\r\n\r\n             at /usr/src/redis/src/module.c:7076:9\r\n\r\n   2: logModulesInfo\r\n\r\n             at /usr/src/redis/src/debug.c:1598:22\r\n\r\n   3: printCrashReport\r\n\r\n             at /usr/src/redis/src/debug.c:1849:5\r\n\r\n      sigsegvHandler\r\n\r\n             at /usr/src/redis/src/debug.c:1831:5\r\n\r\n   4: <unknown>\r\n\r\n   5: dictSdsKeyCompare\r\n\r\n             at /usr/src/redis/src/server.c:1259:8\r\n\r\n   6: _dictKeyIndex\r\n\r\n             at /usr/src/redis/src/dict.c:1038:33\r\n\r\n      dictAddRaw\r\n\r\n             at /usr/src/redis/src/dict.c:325:18\r\n\r\n   7: dictAdd\r\n\r\n             at /usr/src/redis/src/dict.c:290:24\r\n\r\n   8: dbAdd\r\n\r\n             at /usr/src/redis/src/db.c:194:18\r\n\r\n   9: hashTypeLookupWriteOrCreate\r\n\r\n             at /usr/src/redis/src/t_hash.c:454:9\r\n\r\n      hashTypeLookupWriteOrCreate\r\n\r\n             at /usr/src/redis/src/t_hash.c:448:7\r\n\r\n  10: hsetCommand\r\n\r\n             at /usr/src/redis/src/t_hash.c:663:14\r\n\r\n  11: call\r\n\r\n             at /usr/src/redis/src/server.c:3717:5\r\n\r\n  12: luaRedisGenericCommand\r\n\r\n             at /usr/src/redis/src/scripting.c:736:5\r\n\r\n  13: luaD_precall\r\n\r\n  14: luaV_execute\r\n\r\n  15: luaD_call\r\n\r\n  16: luaD_rawrunprotected\r\n\r\n  17: luaD_pcall\r\n\r\n  18: lua_pcall\r\n\r\n  19: evalGenericCommand\r\n\r\n             at /usr/src/redis/src/scripting.c:1598:11\r\n\r\n  20: call\r\n\r\n             at /usr/src/redis/src/server.c:3717:5\r\n\r\n  21: processCommand\r\n\r\n             at /usr/src/redis/src/server.c:4242:9\r\n\r\n  22: processCommandAndResetClient\r\n\r\n             at /usr/src/redis/src/networking.c:2018:9\r\n\r\n      processInputBuffer\r\n\r\n             at /usr/src/redis/src/networking.c:2119:17\r\n\r\n  23: callHandler\r\n\r\n             at /usr/src/redis/src/connhelpers.h:79:18\r\n\r\n      connSocketEventHandler\r\n\r\n             at /usr/src/redis/src/connection.c:295:14\r\n\r\n  24: aeProcessEvents\r\n\r\n             at /usr/src/redis/src/ae.c:427:17\r\n\r\n  25: aeMain\r\n\r\n             at /usr/src/redis/src/ae.c:487:9\r\n\r\n  26: main\r\n\r\n             at /usr/src/redis/src/server.c:6396:5\r\n\r\n  27: __libc_start_main\r\n\r\n  28: _start\r\n\r\n\r\n\r\n------ FAST MEMORY TEST ------\r\n\r\n1:M 22 Jan 2022 21:37:12.094 # Bio thread for job type #0 terminated\r\n\r\n1:M 22 Jan 2022 21:37:12.095 # Bio thread for job type #1 terminated\r\n\r\n1:M 22 Jan 2022 21:37:12.095 # Bio thread for job type #2 terminated\r\n\r\n*** Preparing to test memory region 4000213000 (2682880 bytes)\r\n\r\n*** Preparing to test memory region 4001c6c000 (12288 bytes)\r\n\r\n*** Preparing to test memory region 4001db5000 (8192 bytes)\r\n\r\n*** Preparing to test memory region 4002140000 (16384 bytes)\r\n\r\n*** Preparing to test memory region 4002162000 (16384 bytes)\r\n\r\n*** Preparing to test memory region 4002327000 (40960 bytes)\r\n\r\n*** Preparing to test memory region 4002600000 (2097152 bytes)\r\n\r\n*** Preparing to test memory region 4002931000 (2097152 bytes)\r\n\r\n*** Preparing to test memory region 4003000000 (4194304 bytes)\r\n\r\n*** Preparing to test memory region 4003938000 (12288 bytes)\r\n\r\n*** Preparing to test memory region 400393c000 (8388608 bytes)\r\n\r\n*** Preparing to test memory region 400413d000 (8388608 bytes)\r\n\r\n*** Preparing to test memory region 400493e000 (8388608 bytes)\r\n\r\n*** Preparing to test memory region 400513f000 (8388608 bytes)\r\n\r\n*** Preparing to test memory region 4005940000 (8388608 bytes)\r\n\r\n*** Preparing to test memory region 4006140000 (5767168 bytes)\r\n\r\n*** Preparing to test memory region 400740b000 (3670016 bytes)\r\n\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\n\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\n\r\nSymbol: dictSdsKeyCompare (base: 0x400004b610)\r\n\r\nModule: /usr/local/bin/redis-server *:6379 (base 0x4000000000)\r\n\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n\r\n$ objdump --adjust-vma=0x400004b610 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n\r\n------\r\n\r\n1:M 22 Jan 2022 21:37:12.394 # dump of function (hexdump of 180 bytes):\r\n\r\n4889f74889d60fb657ff89d083e0073c040f879f7bffff488d0df2fb14000fb6c0486304814801c8ffe0660f1f440000486357f70fb64eff89c883e0073c040f876a7bffff4c8d05d8fb14000fb6c0496304804c01c0ffe00f1f8400000000008b4ef731c039ca75214883ec08e8ee6cffff85c00f94c04883c4080fb6c0c3900fb74efb31c039ca74dfc30f1f4400000fb64efdebcd662e0f1f840000000000c0e9030fb6c9ebbb0f1f8400000000008b4eefeb\r\n\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n\r\n```\r\n\r\n**Additional information**\r\n\r\nThis from running a stock ReJSON docker container, with no other modules. Most of the redis interaction is from the Bull queuing library",
  "state": "closed",
  "created_at": "2022-01-22T21:40:17Z",
  "updated_at": "2022-06-16T06:56:10Z",
  "closed_at": "2022-03-18T12:18:42Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1019431572,
      "user": "oranagra",
      "created_at": "2022-01-23T07:38:39Z",
      "body": "@MeirShpilraien can you please take a look?"
    },
    {
      "id": 1019439916,
      "user": "MeirShpilraien",
      "created_at": "2022-01-23T08:46:29Z",
      "body": "@codekrafter any chance you can share the script with this sha: 8f55ae4a3be429c6d38c5d5db3e80edf89197b64? Can help reproduce the issue."
    },
    {
      "id": 1019483158,
      "user": "MeirShpilraien",
      "created_at": "2022-01-23T13:14:49Z",
      "body": "Also notice that RediSearch and RedisJson is also loaded, we need to also considered that, might be a module that causes memory corruption ..."
    },
    {
      "id": 1019522388,
      "user": "codekrafter",
      "created_at": "2022-01-23T16:44:02Z",
      "body": "@MeirShpilraien it should be this script: https://github.com/OptimalBits/bull/blob/v4.2.1/lib/commands/addJob-6.lua\r\nThis is a crash from my local development environment (an M1 mac if that is of interest), but I know my production redis instance has been crashing every so often, I haven't gotten a chance to pull the logs from that yet but I would bet it is the same problem."
    },
    {
      "id": 1019793218,
      "user": "PingXie",
      "created_at": "2022-01-24T07:23:20Z",
      "body": "Well the crash log you posted is about a Redis server running on x64 Linux.\r\n\r\nBased on the instruction where this crash occurred, the invalid memory pointer belongs to a key string that is already in the database. Assuming the physical memory module in your system is not flaky, this sounds like a use-after-free issue to me. If it reproduces relatively consistently on your local dev env, maybe try a few more repros with Valgrind? \r\n\r\n0:  48 89 f7                mov    rdi,rsi\r\n3:  48 89 d6                mov    rsi,rdx\r\n6:  0f b6 57 ff             movzx  edx,BYTE PTR [rdi-0x1]\r\na:  89 d0                   mov    eax,edx\r\nc:  83 e0 07                and    eax,0x7\r\nf:  3c 04                   cmp    al,0x4\r\n11: 0f 87 9f 7b ff ff       ja     0xffffffffffff7bb6\r\n17: 48 8d 0d f2 fb 14 00    lea    rcx,[rip+0x14fbf2]        # 0x14fc10\r\n1e: 0f b6 c0                movzx  eax,al\r\n21: 48 63 04 81             movsxd rax,DWORD PTR [rcx+rax*4]\r\n25: 48 01 c8                add    rax,rcx\r\n28: ff e0                   jmp    rax\r\n2a: 66 0f 1f 44 00 00       nop    WORD PTR [rax+rax*1+0x0]\r\n30: 48 63 57 f7             movsxd rdx,DWORD PTR [rdi-0x9]\r\n34: 0f b6 4e ff             movzx  ecx,BYTE PTR [rsi-0x1]  // <--- here %rsi is **key2** in dictSdsKeyCompare, \r\n\r\n%rsi = 0x4000166b\r\n\r\nstatic int dictSdsKeyCompare(void *privdata, const void *key1, const void ***key2**)\r\n\r\nwhich is invoked by \r\n\r\nstatic long _dictKeyIndex(dict *d, const void *key, uint64_t hash, dictEntry **existing) {\r\n...\r\n            if (key==he->key || dictCompareKeys(d, key, **he->key**)) { // <-- here he->key is key2\r\n...\r\n}"
    },
    {
      "id": 1022919743,
      "user": "MeirShpilraien",
      "created_at": "2022-01-27T07:25:25Z",
      "body": "@codekrafter I do not see anything suspicious in the Lua script. I suspects its the modules fault. Is it possible to run without the module (just to try to prove/disprove this theory)?"
    },
    {
      "id": 1029467315,
      "user": "codekrafter",
      "created_at": "2022-02-03T22:38:45Z",
      "body": "@MeirShpilraien most of my app's interaction with redis is through module commands, which makes it hard to test the application without the module. "
    },
    {
      "id": 1030893073,
      "user": "MeirShpilraien",
      "created_at": "2022-02-06T19:01:37Z",
      "body": "@codekrafter any chance you have a deterministic reproduction steps?"
    },
    {
      "id": 1062589961,
      "user": "sundb",
      "created_at": "2022-03-09T06:17:09Z",
      "body": "@codekrafter It looks like this crash is similar to #10341.\r\nIf you are running docker on M1, can you confirm if you are using qemu?\r\nWhat is the redis docker image you are using?"
    },
    {
      "id": 1067462688,
      "user": "codekrafter",
      "created_at": "2022-03-15T01:18:08Z",
      "body": "@sundb How would I confirm I am using qemu? I believe so as my laptop is m1 but it is running as x86. It is using the `redislabs/rejson` container."
    },
    {
      "id": 1067466765,
      "user": "sundb",
      "created_at": "2022-03-15T01:26:51Z",
      "body": "@codekrafter You can tell by the warning shown in the docker.\r\nref comment: https://github.com/redis/redis/issues/10341#issuecomment-1053789795\r\n"
    },
    {
      "id": 1067467345,
      "user": "codekrafter",
      "created_at": "2022-03-15T01:28:02Z",
      "body": "@sundb can confirm it is running via qemu"
    },
    {
      "id": 1067472992,
      "user": "sundb",
      "created_at": "2022-03-15T01:40:22Z",
      "body": "@codekrafter It seems to be necessary to make an issue with https://github.com/RedisJSON/RedisJSON and ask them to build an image that supports arm, otherwise it will definitely have problems running on m1 docker."
    },
    {
      "id": 1072357342,
      "user": "oranagra",
      "created_at": "2022-03-18T12:18:42Z",
      "body": "i'm closing all of these reports, should be tracked in the ReJson repo.\r\n@sundb are all these reports about Arm / docker issues coming from the JSON / module dockers? or any of them are plain redis?"
    },
    {
      "id": 1072359526,
      "user": "sundb",
      "created_at": "2022-03-18T12:21:45Z",
      "body": "@oranagra ~~`RedisJson` and `RedisSearch`, no plain redis.~~\r\n#9561 plain redis\r\n#10341 plain redis\r\n#9187 RedisGraph\r\n#10162 RedisSearch\r\n#10442 RedisJson\r\n\r\nHere are the available ARM docker image:\r\n\r\nplain redis: [hub.docker.com/_/redis](https://hub.docker.com/_/redis)\r\nmodules: [hub.docker.com/r/redis/redis-stack-server](https://hub.docker.com/r/redis/redis-stack-server)\r\n\r\nThe above version may not be the latest, someon can find it on the docker hub if needed."
    },
    {
      "id": 1072375709,
      "user": "oranagra",
      "created_at": "2022-03-18T12:44:16Z",
      "body": "I see you mentioned that ReJson doesn't have an ARM image, does redis have one?\r\nif we can't fix this by creating a docker image, i think we need to solve this by preventing redis from running (these reports are starting to be annoying).\r\n\r\nI think we should find a way to detect this issue, and abort redis on startup with a clear message. like we did in #8224.\r\ni suppose that being under qemu, we don't have a good way to detect that combination, but maybe we can just do a `calloc()` and check if the memory is zeroed?\r\ncan someone with spare time and an M1 machine test this?"
    },
    {
      "id": 1072437367,
      "user": "sundb",
      "created_at": "2022-03-18T13:57:50Z",
      "body": "@oranagra I modified the above comment to add the available images.\r\nI remembered a silly thing on the bike ride, jemalloc already gives us a way to detect memory not zero in https://github.com/jemalloc/jemalloc/pull/2005/files, we can actually use memset in zcalloc when it is detected.\r\nWait for me to make a pr."
    },
    {
      "id": 1072523657,
      "user": "oranagra",
      "created_at": "2022-03-18T15:31:11Z",
      "body": "@sundb i don't think it's wise to add code to memset on calloc, if that's what you meant.\r\nfirst, IIUC, the problem is not with any calloc, just when re-using an page that was previously dismissed, so doing that would mean that in some cases we zero twice, and in other cases we're missing out on lazy zeroing.\r\nsecondly, even adding an additional branch in our low level function, just for better support of a platform that's not a realistic target for redis, would be wasteful.\r\n\r\nAnother alternative is to just enable the feature added in the jemalloc PR you mentioned (which causes jemalloc to never dismiss pages when running on an affected platform), that would fix the problem on qemu, by adding a sub-optimal effect on the runtime.\r\n\r\nwhat i suggest is to copy that detection code from jemalloc into redis, and use it in a similar manner as we did in #8224.\r\nIf the user disables the warning, we can then enable that feature (disable `trust_madvise`)\r\n"
    },
    {
      "id": 1073929685,
      "user": "sundb",
      "created_at": "2022-03-21T13:57:31Z",
      "body": "@oranagra I found some problems when I did with the way you said.\r\n1) When the MADV_DONTNEED zeroes page failure is detected (it must be placed after the config loaded because we need to log something), it is actually too late, and jemalloc may have allocte some memory before this.\r\n2) `trust_madvis` is read-only, I'm not sure jemalloc is trying to prevent us from setting it dynamically, as in the question in 1).\r\nPlease correct me if I'm wrong, as I'm not familiar with jemalloc."
    },
    {
      "id": 1074017619,
      "user": "oranagra",
      "created_at": "2022-03-21T15:08:51Z",
      "body": "@sundb i don't want to invest too much effort (and code) in this, if it's too late to tweak jemalloc config, let's drop this idea.\r\nif we do this detection, logging and `exit` after we already allocated things, there's also a slim chance that some calloc already failed zeroing memory (but that's actually unlikely, since it's unlikely that we used MADV_DONTNEED).\r\n\r\ni think the most important requirements here are:\r\n1. avoid letting redis start and later crash at runtime (after being populated with data)\r\n2. avoid people opening more issues about odd crashes.\r\n\r\nfrom that perspective, i think it's fine to do that check after init, and forget about the idea of setting `trust_madvise` to 0 when the warning (`exit()`) was silenced.\r\n\r\nin theory, people can provide jemalloc with a config from outside (there's a mechanism for that), and set `trust_madvise`. in theory we can detect that it has been disabled, and silence our warning too, but i guess i don't mind requiring these people to also silence the warning in redis config file separately."
    },
    {
      "id": 1157301055,
      "user": "oranagra",
      "created_at": "2022-06-16T06:53:41Z",
      "body": "@sundb i understand some progress have been made, and since we posted quite a few links to [this](https://github.com/redis/redis/issues/10162#issuecomment-1072359526) comment from other pages and people are likely to hit it, i'd like to ask you to edit / update it.\r\n\r\nit currently refers to `redisfab` which i understand is a testing playground, and not something seriously maintained.\r\ninstead, the official multi-platform docker images we should direct people to are:\r\n* plain redis: https://hub.docker.com/_/redis\r\n* modules: https://hub.docker.com/r/redis/redis-stack-server"
    },
    {
      "id": 1157302698,
      "user": "sundb",
      "created_at": "2022-06-16T06:55:48Z",
      "body": "@oranagra Already updated."
    }
  ]
}