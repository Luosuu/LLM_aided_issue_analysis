{
  "issue_number": 13480.0,
  "title": "[BUG] Redis Server Freeze",
  "body": "**Describe the bug**\r\n\r\nin some cases, redis server just become freeze and unresponsive, failed to connect to redis server at all, and can't log in from redis insight at all.\r\nI don't know what exactly the issue, but based on timing, it could be one client disconnect from redis server, when the client is restarting itself. (FYI, the client is using Jedis library) any concern if the client is not shutdown graceful/properly.\r\nfrom the stack race below, seems like it might related to Search Indexing, while we created hundreds of temporary indexes from client using Jedis library, not sure if this raised any alarm. \r\n\r\n**To reproduce**\r\n\r\ndon't have reproduce steps\r\n\r\n**Expected behavior**\r\n\r\nredis server should be responsive always\r\n\r\n**Additional information**\r\n\r\nstack trace when frozen:\r\n```\r\n#0  0x00007f8d352332ce in pthread_rwlock_wrlock () from /lib64/libpthread.so.0\r\n#1  0x00007f8d2c69956b in RedisSearchCtx_LockSpecWrite () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#2  0x00007f8d2c6ab45b in IndexSpec_DeleteDoc () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#3  0x00007f8d2c6abbfa in Indexes_DeleteMatchingWithSchemaRules () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#4  0x00007f8d2c681b16 in HashNotificationCallback () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#5  0x00000000004ff95f in moduleNotifyKeyspaceEvent.part.97.58377 (type=256, event=0x61abbf \"expired\", key=0x7f8c3d4ad620, dbid=0) at module.c:8724\r\n#6  0x000000000050a445 in moduleNotifyKeyspaceEvent (dbid=0, key=0x7f8c3d4ad620, event=0x61abbf \"expired\", type=256) at notify.c:145\r\n#7  notifyKeyspaceEvent (type=<optimized out>, event=<optimized out>, key=<optimized out>, dbid=<optimized out>, dbid=<optimized out>, key=<optimized out>, event=<optimized out>) at notify.c:114\r\n#8  0x000000000050e6ea in deleteExpiredKeyAndPropagate (keyobj=0x7f8c3d4ad620, db=0x7f8d33531000) at db.c:1686\r\n#9  expireIfNeeded.part.6.12916 (db=0x7f8d33531000, key=0x7f8c3d4ad620) at db.c:1813\r\n#10 0x000000000050eb44 in expireIfNeeded (flags=<optimized out>, key=0x7f8c3d4ad620, db=0x7f8d33531000) at networking.c:4077\r\n#11 lookupKey (db=0x7f8d33531000, key=0x7f8c3d4ad620, flags=0) at db.c:107\r\n#12 0x0000000000516cdf in lookupKeyReadWithFlags (flags=0, key=0x7f8c3d4ad620, db=<optimized out>) at db.c:153\r\n#13 RM_OpenKey (ctx=0x7ffcc4b3b790, keyname=0x7f8c3d4ad620, mode=1) at module.c:4005\r\n#14 0x00007f8d2adad201 in redis_module::context::Context::open_key::h6e9944a47573023b ()\r\n   from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/rejson.so\r\n#15 0x00007f8d2ad3a6bd in rejson::c_api::json_api_open_key_internal::heef0c3554720f6d6 ()\r\n   from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/rejson.so\r\n#16 0x00007f8d2c6a1133 in getKeyCommonJSON () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#17 0x00007f8d2c69f8aa in loadIndividualKeys () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#18 0x00007f8d2c69e3b7 in rploaderNext () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#19 0x00007f8d2c640a5a in rpevalNext_project () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#20 0x00007f8d2c64abbd in Grouper_rpAccum () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#21 0x00007f8d2c69ec2e in rpsortNext_Accum () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#22 0x00007f8d2c638365 in sendChunk () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#23 0x00007f8d2c638bd7 in AREQ_Execute () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#24 0x00007f8d2c6396b3 in RSAggregateCommand () from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n#25 0x00000000004ffa9c in RedisModuleCommandDispatcher (c=0x7f8affc0b500) at module.c:917\r\n#26 0x0000000000539808 in call (c=c@entry=0x7f8affc0b500, flags=flags@entry=3) at server.c:3519\r\n#27 0x000000000053bb33 in processCommand (c=0x7f8affc0b500) at server.c:4160\r\n#28 0x000000000057b7c7 in processCommandAndResetClient (c=0x7f8affc0b500) at networking.c:2466\r\n#29 processInputBuffer (c=c@entry=0x7f8affc0b500) at networking.c:2574\r\n#30 0x000000000057bf73 in readQueryFromClient (conn=<optimized out>) at networking.c:2713\r\n#31 0x00000000004b1f55 in callHandler (handler=<optimized out>, conn=0x7f8a70b5df00) at connhelpers.h:79\r\n#32 tlsHandleEvent (conn=0x7f8a70b5df00, mask=<optimized out>) at tls.c:720\r\n#33 0x00000000004d5ab9 in aeProcessEvents (flags=27, eventLoop=0x7f8d3342a1e0) at ae.c:436\r\n#34 aeMain (eventLoop=0x7f8d3342a1e0) at ae.c:496\r\n#35 0x0000000000457210 in main (argc=<optimized out>, argv=0x7ffcc4b3bbc8) at server.c:7360\r\n```\r\n\r\ninfo register:\r\n```\r\nrax            0xfffffffffffffe00       -512\r\nrbx            0x7ffcc4b3b100   140723608596736\r\nrcx            0xffffffffffffffff       -1\r\nrdx            0x0      0\r\nrsi            0x80     128\r\nrdi            0x7f8d20b28dac   140244115688876\r\nrbp            0x7f8d20b28c00   0x7f8d20b28c00\r\nrsp            0x7ffcc4b3b0d8   0x7ffcc4b3b0d8\r\nr8             0x7da    2010\r\nr9             0x7f8d33400ff0   140244426952688\r\nr10            0x0      0\r\nr11            0x206    518\r\nr12            0x7ffcc4b3b210   140723608597008\r\nr13            0x7f8c3d4ad620   140240300463648\r\nr14            0x7da    2010\r\nr15            0x7ffcc4b3b100   140723608596736\r\nrip            0x7f8d352332ce   0x7f8d352332ce <pthread_rwlock_wrlock+62>\r\neflags         0x206    [ PF IF ]\r\ncs             0x33     51\r\nss             0x2b     43\r\nds             0x0      0\r\nes             0x0      0\r\nfs             0x0      0\r\ngs             0x0      0\r\n```\r\n\r\nredis server config:\r\n```\r\nmaxmemory 300gb\r\nmaxmemory-policy allkeys-lru\r\nappendonly no\r\nsave \"\"\r\ntimeout 0\r\nio-threads 4\r\nloglevel notice\r\nlogfile path\r\n\r\nuser admin on +@all ~* #somehash\r\nuser readOnly on +@read +info +ping +json.get +ts.range ~* #somehash\r\nuser readWrite on +@all -@dangerous +info +ping ~* #somehash\r\nuser default off\r\n\r\nport 0\r\ntls-port 6379\r\ntls-cert-file path1\r\ntls-key-file path2\r\ntls-ca-cert-file path3\r\ntls-auth-clients no\r\n```\r\nredis server log (notice): not any useful log around freezing time\r\n```\r\n38578:C 20 Aug 2024 12:47:08.767 # WARNING Memory overcommit must be enabled! Without it, a background save or replication may fail under low memory condition. Being disabled, it can also cause failures without low memory condition, see https://github.com/jemalloc/jemalloc/issues/1328. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.\r\n38578:C 20 Aug 2024 12:47:08.768 * oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\r\n38578:C 20 Aug 2024 12:47:08.768 * Redis version=7.2.1, bits=64, commit=00000000, modified=0, pid=38578, just started\r\n38578:C 20 Aug 2024 12:47:08.769 * Configuration loaded\r\n38578:M 20 Aug 2024 12:47:08.770 * monotonic clock: POSIX clock_gettime\r\n38578:M 20 Aug 2024 12:47:08.772 * Running mode=standalone, port=6379.\r\n38578:M 20 Aug 2024 12:47:08.773 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.\r\n38578:M 20 Aug 2024 12:47:08.777 * <search> Redis version found by RedisSearch : 7.2.1 - oss\r\n38578:M 20 Aug 2024 12:47:08.778 * <search> RediSearch version 2.8.4 (Git=HEAD-7797d39)\r\n38578:M 20 Aug 2024 12:47:08.778 * <search> Low level api version 1 initialized successfully\r\n38578:M 20 Aug 2024 12:47:08.779 * <search> concurrent writes: OFF, gc: ON, prefix min length: 2, prefix max expansions: 200, query timeout (ms): 500, timeout policy: return, cursor read size: 1000, cursor max idle (ms): 300000, max doctable size: 1000000, max number of search results:  10000, search pool size: 20, index pool size: 8, \r\n38578:M 20 Aug 2024 12:47:08.780 * <search> Initialized thread pools!\r\n38578:M 20 Aug 2024 12:47:08.780 * <search> Enabled role change notification\r\n38578:M 20 Aug 2024 12:47:08.781 * Module 'search' loaded from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisearch.so\r\n38578:M 20 Aug 2024 12:47:08.783 * <timeseries> RedisTimeSeries version 11006, git_sha=2a4739648bbe771fc60561b37fbc7f3ca4cc4f24\r\n38578:M 20 Aug 2024 12:47:08.784 * <timeseries> Redis version found by RedisTimeSeries : 7.2.1 - oss\r\n38578:M 20 Aug 2024 12:47:08.785 * <timeseries> loaded default CHUNK_SIZE_BYTES policy: 4096\r\n38578:M 20 Aug 2024 12:47:08.786 * <timeseries> loaded server DUPLICATE_POLICY: block\r\n38578:M 20 Aug 2024 12:47:08.786 * <timeseries> Setting default series ENCODING to: compressed\r\n38578:M 20 Aug 2024 12:47:08.787 * <timeseries> Detected redis oss\r\n38578:M 20 Aug 2024 12:47:08.788 * Module 'timeseries' loaded from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redistimeseries.so\r\n38578:M 20 Aug 2024 12:47:08.790 * <ReJSON> Created new data type 'ReJSON-RL'\r\n38578:M 20 Aug 2024 12:47:08.791 * <ReJSON> version: 20606 git sha: unknown branch: unknown\r\n38578:M 20 Aug 2024 12:47:08.791 * <ReJSON> Exported RedisJSON_V1 API\r\n38578:M 20 Aug 2024 12:47:08.792 * <ReJSON> Exported RedisJSON_V2 API\r\n38578:M 20 Aug 2024 12:47:08.792 * <ReJSON> Exported RedisJSON_V3 API\r\n38578:M 20 Aug 2024 12:47:08.793 * <ReJSON> Exported RedisJSON_V4 API\r\n38578:M 20 Aug 2024 12:47:08.793 * <ReJSON> Enabled diskless replication\r\n38578:M 20 Aug 2024 12:47:08.794 * Module 'ReJSON' loaded from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/rejson.so\r\n38578:M 20 Aug 2024 12:47:08.794 * <search> Acquired RedisJSON_V4 API\r\n38578:M 20 Aug 2024 12:47:08.796 * <bf> RedisBloom version 2.6.3 (Git=unknown)\r\n38578:M 20 Aug 2024 12:47:08.797 * Module 'bf' loaded from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisbloom.so\r\n38578:M 20 Aug 2024 12:47:08.799 * <redisgears_2> Created new data type 'GearsType'\r\n38578:M 20 Aug 2024 12:47:08.800 * <redisgears_2> Detected redis oss\r\n38578:M 20 Aug 2024 12:47:08.801 # <redisgears_2> could not initialize RedisAI_InitError\r\n\r\n38578:M 20 Aug 2024 12:47:08.801 * <redisgears_2> Failed loading RedisAI API.\r\n38578:M 20 Aug 2024 12:47:08.802 * <redisgears_2> RedisGears v2.0.12, sha='716eb57fcfc2d383ec0925a59563f1bf69e2caa3', build_type='release', built_for='Linux-rhel7.x86_64'.\r\n38578:M 20 Aug 2024 12:47:08.805 * <redisgears_2> Registered backend: js.\r\n38578:M 20 Aug 2024 12:47:08.806 * Module 'redisgears_2' loaded from /home/svc_cathedral/nomad/pxstlccath008/alloc/fa9f504b-64e7-d510-1b7c-f56885fb4dca/redis-task/local/redis-stack-server-7.2.0-v2/lib/redisgears.so\r\n38578:M 20 Aug 2024 12:47:08.807 * The user 'default' is disabled (there is no 'on' modifier in the user description). Make sure this is not a configuration error.\r\n38578:M 20 Aug 2024 12:47:08.819 * Server initialized\r\n38578:M 20 Aug 2024 12:47:08.821 * Ready to accept connections tls\r\n38578:M 20 Aug 2024 14:32:35.458 # Error accepting a client connection: error:140760FC:SSL routines:SSL23_GET_CLIENT_HELLO:unknown protocol (addr=127.0.0.1:54758 laddr=127.0.0.1:6379)\r\n38578:M 20 Aug 2024 14:32:35.459 # Error accepting a client connection: error:140760FC:SSL routines:SSL23_GET_CLIENT_HELLO:unknown protocol (addr=10.49.30.56:37694 laddr=10.49.30.56:6379)\r\n38578:M 20 Aug 2024 20:37:35.448 # Error accepting a client connection: error:140760FC:SSL routines:SSL23_GET_CLIENT_HELLO:unknown protocol (addr=127.0.0.1:34328 laddr=127.0.0.1:6379)\r\n38578:M 20 Aug 2024 20:37:35.450 # Error accepting a client connection: error:140760FC:SSL routines:SSL23_GET_CLIENT_HELLO:unknown protocol (addr=10.49.30.56:45496 laddr=10.49.30.56:6379)\r\n```",
  "state": "open",
  "created_at": "2024-08-21T13:09:56Z",
  "updated_at": "2024-08-21T17:18:01Z",
  "closed_at": null,
  "labels": [],
  "comments_data": [
    {
      "id": 2302096023,
      "user": "sundb",
      "created_at": "2024-08-21T13:43:21Z",
      "body": "@simon1990zcs thanks, can you move this issue to https://github.com/RediSearch/RediSearch/issues?q=sort%3Aupdated-desc+is%3Aissue+is%3Aopen?"
    },
    {
      "id": 2302591325,
      "user": "simon1990zcs",
      "created_at": "2024-08-21T17:18:00Z",
      "body": "> @simon1990zcs thanks, can you move this issue to https://github.com/RediSearch/RediSearch/issues?q=sort%3Aupdated-desc+is%3Aissue+is%3Aopen?\r\n\r\njust created another one under RedisSearch, https://github.com/RediSearch/RediSearch/issues/4951, \r\nHowever, I am not 100% sure that's Search related though."
    }
  ]
}