{
  "issue_number": 9466.0,
  "title": "[CRASH] in CrystalTransaction module thread calling Lua",
  "body": "**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n14654:M 07 Sep 2021 05:00:36.123 . \r\natomic_inc_bulk_refcount.lua finally done with cfs_id:cfs_id_SnapNRollbacks1 and returnng\r\n14654:M 07 Sep 2021 05:00:36.124 . \r\natomic_inc_bulk_refcount.lua: entered\r\n14654:M 07 Sep 2021 05:00:36.124 . \r\natomic_inc_bulk_refcount.lua:  STEP1\r\n14654:M 07 Sep 2021 05:00:36.124 . \r\natomic_inc_bulk_refcount.lua: STEP2\r\n14654:M 07 Sep 2021 05:00:36.124 . \r\natomic_inc_bulk_refcount.lua: idx:6\r\n14654:M 07 Sep 2021 05:00:36.124 . \r\natomic_inc_bulk_refcount.lua: sig:v�\u001f���+6�H�}j�?�b�\u0018:]W��ִA�A\u001d�\r\n14654:M 07 Sep 2021 05:00:36.124 . \r\natomic_inc_bulk_refcount.lua: STEP376931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7\r\n14654:M 07 Sep 2021 05:00:36.124 . atomic_inc_bulk_refcount.lua:update_rc sig:76931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7 inc:80 sig_sz: 64 for_snapshotting:1\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n14654:M 07 Sep 2021 05:00:36.124 . atomic_inc_bulk_refcount.lua:update_rc sig:76931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7 inc:80 sig_sz: 64 for_snapshotting:1 entered\r\n14654:M 07 Sep 2021 05:00:36.124 # Redis 6.0.9 crashed by signal: 11, si_code: 128\r\n14654:M 07 Sep 2021 05:00:36.124 . atomic_inc_bulk_refcount.lua: snapshot count of 76931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7 is incremented to 8741\r\n14654:M 07 Sep 2021 05:00:36.124 # Crashed running the instruction at: 0x4cff88\r\n14654:M 07 Sep 2021 05:00:36.124 . atomic_inc_bulk_refcount.lua: Ref count of 76931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7 stays at 2\r\n14654:M 07 Sep 2021 05:00:36.124 # Accessing address: (nil)\r\n14654:M 07 Sep 2021 05:00:36.124 . \r\natomic_inc_bulk_refcount.lua: updated_rc is:2\r\n14654:M 07 Sep 2021 05:00:36.124 # Killed by PID: 0, UID: 0\r\n14654:M 07 Sep 2021 05:00:36.124 . \r\natomic_inc_bulk_refcount.lua: update_excl: updated_rc is:2\r\n14654:M 07 Sep 2021 05:00:36.124 # Failed assertion: <no assertion failed> (<no file>:0)\r\n\r\n------ STACK TRACE ------\r\n14654:M 07 Sep 2021 05:00:36.124 . atomic_inc_bulk_refcount.lua:76931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7 : existing exclusive usr =  NIL : existing exclusive cfs =  NIL\r\n14654:M 07 Sep 2021 05:00:36.124 . atomic_inc_bulk_refcount.lua: usr_excl_true:false\r\n14654:M 07 Sep 2021 05:00:36.124 . atomic_inc_bulk_refcount.lua: cfs_excl_true:false\r\n14654:M 07 Sep 2021 05:00:36.124 . atomic_inc_bulk_refcount.lua: pre_excl_true:false\r\n14654:M 07 Sep 2021 05:00:36.124 . atomic_inc_bulk_refcount.lua: usr_excl_false\r\nEIP:\r\n14654:M 07 Sep 2021 05:00:36.124 . atomic_inc_bulk_refcount.lua: cfs_excl_false\r\n14654:M 07 Sep 2021 05:00:36.124 . atomic_inc_bulk_refcount.lua: pre_excl_false\r\n14654:M 07 Sep 2021 05:00:36.124 . atomic_inc_bulk_refcount.lua: content not exclusive\r\nredis-server *:0(lua_rawseti+0x28)[0x4cff88]\r\n\r\nBacktrace:\r\n14654:M 07 Sep 2021 05:00:36.125 . \r\natomic_inc_bulk_refcount.lua done with cfs_id:cfs_id_SnapNRollbacks1 idx:6 and sig:76931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7\r\n14654:M 07 Sep 2021 05:00:36.125 . \r\natomic_inc_bulk_refcount.lua: idx:7\r\nredis-server *:0(logStackTrace+0x32)[0x47ca02]\r\n14654:M 07 Sep 2021 05:00:36.125 . \r\natomic_inc_bulk_refcount.lua: sig:v�\u001f���+6�H�}j�?�b�\u0018:]W��ִA�A\u001d�\r\n14654:M 07 Sep 2021 05:00:36.125 . \r\natomic_inc_bulk_refcount.lua: STEP376931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7\r\nredis-server *:0(sigsegvHandler+0xc8)[0x47d118]\r\n/lib64/libpthread.so.0(+0xf7e0)[0x7ffff753f7e0]\r\n14654:M 07 Sep 2021 05:00:36.125 . atomic_inc_bulk_refcount.lua:update_rc sig:76931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7 inc:38 sig_sz: 64 for_snapshotting:1\r\n14654:M 07 Sep 2021 05:00:36.125 . atomic_inc_bulk_refcount.lua:update_rc sig:76931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7 inc:38 sig_sz: 64 for_snapshotting:1 entered\r\nredis-server *:0(lua_rawseti+0x28)[0x4cff88]\r\n14654:M 07 Sep 2021 05:00:36.125 . atomic_inc_bulk_refcount.lua: snapshot count of 76931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7 is incremented to 8779\r\nredis-server *:0(luaSetGlobalArray+0x71)[0x48b611]\r\n14654:M 07 Sep 2021 05:00:36.125 . atomic_inc_bulk_refcount.lua: Ref count of 76931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7 stays at 2\r\n14654:M 07 Sep 2021 05:00:36.125 . \r\natomic_inc_bulk_refcount.lua: updated_rc is:2\r\nredis-server *:0(evalGenericCommand+0xf1)[0x48bb21]\r\n14654:M 07 Sep 2021 05:00:36.125 . \r\natomic_inc_bulk_refcount.lua: update_excl: updated_rc is:2\r\n14654:M 07 Sep 2021 05:00:36.125 . atomic_inc_bulk_refcount.lua:76931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7 : existing exclusive usr =  NIL : existing exclusive cfs =  NIL\r\nredis-server *:0(call+0x9b)[0x43a1db]\r\n14654:M 07 Sep 2021 05:00:36.125 . atomic_inc_bulk_refcount.lua: usr_excl_true:false\r\n14654:M 07 Sep 2021 05:00:36.125 . atomic_inc_bulk_refcount.lua: cfs_excl_true:false\r\nredis-server *:0(RM_Call+0x17d)[0x4ade0d]\r\n14654:M 07 Sep 2021 05:00:36.125 . atomic_inc_bulk_refcount.lua: pre_excl_true:false\r\n/home/scratch.ambars_inf/WORK/P4/ambars_crystal_atomicbulk/1.0/crsdb/redismodules/build/CrystalTransaction.so(_Z20rollback_transactionP14RedisModuleCtxxRKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEES8_+0x17b3)[0x7fffee20ee63]\r\n14654:M 07 Sep 2021 05:00:36.125 . atomic_inc_bulk_refcount.lua: usr_excl_false\r\n/home/scratch.ambars_inf/WORK/P4/ambars_crystal_atomicbulk/1.0/crsdb/redismodules/build/CrystalTransaction.so(_Z38CrystalTransaction_Rollback_ThreadMainPv+0xc7)[0x7fffee210777]\r\n14654:M 07 Sep 2021 05:00:36.125 . atomic_inc_bulk_refcount.lua: cfs_excl_false\r\n/lib64/libpthread.so.0(+0x7aa1)[0x7ffff7537aa1]\r\n14654:M 07 Sep 2021 05:00:36.125 . atomic_inc_bulk_refcount.lua: pre_excl_false\r\n14654:M 07 Sep 2021 05:00:36.125 . atomic_inc_bulk_refcount.lua: content not exclusive\r\n/lib64/libc.so.6(clone+0x6d)[0x7ffff7284aad]\r\n14654:M 07 Sep 2021 05:00:36.125 . \r\natomic_inc_bulk_refcount.lua done with cfs_id:cfs_id_SnapNRollbacks1 idx:7 and sig:76931fac9dab2b36c248b87d6ae33f9a62d7183a5d5789e4b2d6b441e2411dc7\r\n\r\n------ INFO OUTPUT ------\r\n14654:M 07 Sep 2021 05:00:36.125 . \r\natomic_inc_bulk_refcount.lua finally done with cfs_id:cfs_id_SnapNRollbacks1 and returnng\r\n# Server\r\nredis_version:6.0.9\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:485d73e75f107e56\r\nredis_mode:standalone\r\nos:Linux 4.1.15.pnotify x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:atomic-builtin\r\ngcc_version:5.5.0\r\nprocess_id:14654\r\nrun_id:02a6336cad7fb1399caf27bb1ced52384d5fff22\r\ntcp_port:0\r\nuptime_in_seconds:2\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:3626084\r\nexecutable:/home/scratch.ambars_inf/WORK/P4/ambars_crystal_atomicbulk/1.0/crsdb/redis-server\r\nconfig_file:/home/scratch.ambars_inf/WORK/P4/ambars_crystal_atomicbulk/1.0/misc/redis/redis.conf\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:4\r\nclient_recent_max_input_buffer:40960\r\nclient_recent_max_output_buffer:2280\r\nblocked_clients:1\r\ntracking_clients:0\r\nclients_in_timeout_table:1\r\n\r\n# Memory\r\nused_memory:1260160\r\nused_memory_human:1.20M\r\nused_memory_rss:18587648\r\nused_memory_rss_human:17.73M\r\nused_memory_peak:1260160\r\nused_memory_peak_human:1.20M\r\nused_memory_peak_perc:99.97%\r\nused_memory_overhead:975340\r\nused_memory_startup:794784\r\nused_memory_dataset:284476\r\nused_memory_dataset_perc:61.17%\r\nallocator_allocated:1399080\r\nallocator_active:1949696\r\nallocator_resident:6561792\r\ntotal_system_memory:135169318912\r\ntotal_system_memory_human:125.89G\r\nused_memory_lua:165888\r\nused_memory_lua_human:162.00K\r\nused_memory_scripts:93392\r\nused_memory_scripts_human:91.20K\r\nnumber_of_cached_scripts:14\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.39\r\nallocator_frag_bytes:550616\r\nallocator_rss_ratio:3.37\r\nallocator_rss_bytes:4612096\r\nrss_overhead_ratio:2.83\r\nrss_overhead_bytes:12025856\r\nmem_fragmentation_ratio:15.02\r\nmem_fragmentation_bytes:17350104\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:85292\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.1.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nrdb_changes_since_last_save:1363\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1631016034\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:4\r\ntotal_commands_processed:10443\r\ninstantaneous_ops_per_sec:5677\r\ntotal_net_input_bytes:167370\r\ntotal_net_output_bytes:67328\r\ninstantaneous_input_kbps:92.94\r\ninstantaneous_output_kbps:34.88\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nkeyspace_hits:6417\r\nkeyspace_misses:1281\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_reads_processed:163\r\ntotal_writes_processed:161\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_replid:d560600a58fd03b8258389e43d90c4cb3b469ee0\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.283000\r\nused_cpu_user:0.229000\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\n\r\n# Modules\r\nmodule:name=CrystalUtils,ver=1,api=1,filters=0,usedby=[],using=[],options=[]\r\nmodule:name=CrystalTransactions,ver=1,api=1,filters=0,usedby=[],using=[],options=[]\r\n\r\n# Commandstats\r\ncmdstat_del:calls=1,usec=1,usec_per_call=1.00\r\ncmdstat_CrystalTransaction.Dump:calls=2,usec=693,usec_per_call=346.50\r\ncmdstat_exists:calls=1,usec=1,usec_per_call=1.00\r\ncmdstat_CrystalTransaction.IsActive:calls=1,usec=91,usec_per_call=91.00\r\ncmdstat_srem:calls=3,usec=9,usec_per_call=3.00\r\ncmdstat_zrem:calls=3,usec=1,usec_per_call=0.33\r\ncmdstat_CrystalUtils.Cnv2Hex:calls=1272,usec=14516,usec_per_call=11.41\r\ncmdstat_hexists:calls=1271,usec=1220,usec_per_call=0.96\r\ncmdstat_hscan:calls=14,usec=104,usec_per_call=7.43\r\ncmdstat_CrystalTransaction.IsDiscarding:calls=1,usec=77,usec_per_call=77.00\r\ncmdstat_CrystalTransaction.Write:calls=2,usec=93,usec_per_call=46.50\r\ncmdstat_zincrby:calls=2,usec=16,usec_per_call=8.00\r\ncmdstat_module:calls=2,usec=57358,usec_per_call=28679.00\r\ncmdstat_zadd:calls=2,usec=8,usec_per_call=4.00\r\ncmdstat_hdel:calls=4,usec=14,usec_per_call=3.50\r\ncmdstat_get:calls=6,usec=6,usec_per_call=1.00\r\ncmdstat_sadd:calls=5,usec=22,usec_per_call=4.40\r\ncmdstat_CrystalTransaction.IncRefCnt:calls=3,usec=334,usec_per_call=111.33\r\ncmdstat_hget:calls=5127,usec=4324,usec_per_call=0.84\r\ncmdstat_decrby:calls=1,usec=3,usec_per_call=3.00\r\ncmdstat_CrystalTransaction.Rollback:calls=2,usec=66,usec_per_call=33.00\r\ncmdstat_hincrby:calls=1281,usec=2518,usec_per_call=1.97\r\ncmdstat_ping:calls=1,usec=3,usec_per_call=3.00\r\ncmdstat_sismember:calls=1277,usec=742,usec_per_call=0.58\r\ncmdstat_evalsha:calls=73,usec=439132,usec_per_call=6015.51\r\ncmdstat_CrystalTransaction.GetTransactionId:calls=3,usec=94,usec_per_call=31.33\r\ncmdstat_zscore:calls=2,usec=5,usec_per_call=2.50\r\ncmdstat_incrby:calls=9,usec=16,usec_per_call=1.78\r\ncmdstat_hset:calls=37,usec=130,usec_per_call=3.51\r\ncmdstat_CrystalTransaction.ping:calls=1,usec=2,usec_per_call=2.00\r\ncmdstat_memory:calls=1,usec=39,usec_per_call=39.00\r\ncmdstat_set:calls=19,usec=30,usec_per_call=1.58\r\ncmdstat_script:calls=14,usec=5333,usec_per_call=380.93\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=34,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=4 addr=/tmp/crs-9yGo5L/sock:0 fd=8 name= age=1 idle=0 flags=U db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=61464 events=r cmd=hget user=default\r\nid=7 addr=/tmp/crs-9yGo5L/sock:0 fd=11 name= age=1 idle=0 flags=U db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=61456 events=r cmd=CrystalTransaction.IsDiscarding user=default\r\nid=8 addr=/tmp/crs-9yGo5L/sock:0 fd=12 name= age=1 idle=0 flags=U db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=61600 events=r cmd=evalsha user=default\r\nid=9 addr=/tmp/crs-9yGo5L/sock:0 fd=13 name= age=1 idle=0 flags=bU db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 argv-mem=28 obl=0 oll=0 omem=0 tot-mem=61484 events=r cmd=CrystalTransaction.Rollback user=default\r\n\r\n------ REGISTERS ------\r\n14654:M 07 Sep 2021 05:00:36.125 # \r\nRAX:362bab9dac1f9376 RBX:00000000009fcf30\r\nRCX:362bab9dac1f9376 RDX:0000000000a0e880\r\nRDI:00000000009fcf30 RSI:0000000000a59640\r\nRBP:0000000000a89e00 RSP:00007fffd7ffcc90\r\nR8 :0000000000a59640 R9 :00000000009fcf30\r\nR10:0000000000000040 R11:00007ffff72f67d0\r\nR12:0000000000a89de0 R13:000000000056a334\r\nR14:00007fffe8627020 R15:0000000000000013\r\nRIP:00000000004cff88 EFL:0000000000010206\r\nCSGSFS:0000000000000033\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc9f) -> 6634633234353531\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc9e) -> 6234363432623138\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc9d) -> 3864333463636531\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc9c) -> 6461613238305f66\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc9b) -> 0000000000000004\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc9a) -> 00000000007c63a8\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc99) -> 000000000048bb21\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc98) -> 0000000000000551\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc97) -> 00007fffd7ffccf0\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc96) -> 0000000000000001\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc95) -> 00000000009fcf30\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc94) -> 00007fffe8614940\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc93) -> 000000000048b611\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc92) -> 0000000000000004\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc91) -> 00000000009fcf30\r\n14654:M 07 Sep 2021 05:00:36.125 # (00007fffd7ffcc90) -> 0000000000000001\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ FAST MEMORY TEST ------\r\n14654:M 07 Sep 2021 05:00:36.125 # main thread terminated\r\n14654:M 07 Sep 2021 05:00:36.126 # Bio thread for job type #0 terminated\r\n14654:M 07 Sep 2021 05:00:36.126 # Bio thread for job type #1 terminated\r\n14654:M 07 Sep 2021 05:00:36.126 # Bio thread for job type #2 terminated\r\n\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: lua_rawseti (base: 0x4cff60)\r\nModule: redis-server *:0 (base 0x400000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x4cff60 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n14654:M 07 Sep 2021 05:00:36.126 # dump of function (hexdump of 160 bytes):\r\n4154554189d0534889fbe881f0ffff488b6b10488b304489c24889df4989c4e8cc8c0000488b55f04889108b55f8895008488b43108378f8037e14488b40f0f6400903740a498b3424f6460904751148836b10105b5d415cc30f1f80000000004889dfe82849000048836b10105b5d415cc30f1f4000662e0f1f840000000000534889fbe807f0ffff488b53108b4af885c9743c48634808488b52f04889d683\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n```\r\n\r\n**Additional information**\r\nI am not clear from the logs exactly where the crash is occurring. Help really appreciated. \r\n\r\n1. OS distribution and version\r\n2. Steps to reproduce (if any)\r\n",
  "state": "closed",
  "created_at": "2021-09-07T12:15:22Z",
  "updated_at": "2021-09-07T14:00:25Z",
  "closed_at": "2021-09-07T13:07:41Z",
  "labels": [],
  "comments_data": [
    {
      "id": 914283629,
      "user": "sundb",
      "created_at": "2021-09-07T12:56:39Z",
      "body": "Look like the `CrystalTransaction` module crashed.\r\nThis module should not be open source, you can ask the relevant developer for help."
    },
    {
      "id": 914291586,
      "user": "oranagra",
      "created_at": "2021-09-07T13:07:41Z",
      "body": "Indeed, it crashes in Lua that's called from the module thread. Please take it to the module developer to debug. "
    },
    {
      "id": 914300875,
      "user": "ambarsarkar",
      "created_at": "2021-09-07T13:20:25Z",
      "body": "Thanks and I'll investigate.\n\nIt makes sense (isse in the C++ redismodule implementation) , but for\nposterity, how can one tell it was the CrystalTransaction.so from the log?\nI do see the sigsegvhandler, but cannot tell from the backtrace what\nspecifically caused it as there are other messages from the lua scripts as\nwell, so the trace sequence is unclear.\n\nHas anyone been successful in attaching a gdb debugger or identify the\nline/code where the C++ module is crashing?\n\nAppreciated,\n-Ambar\n\nOn Tue, Sep 7, 2021 at 8:56 AM sundb ***@***.***> wrote:\n\n> Look like the CrystalTransaction module crashed.\n>\n> —\n> You are receiving this because you authored the thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/redis/redis/issues/9466#issuecomment-914283629>, or\n> unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AC4DZWDTTEXUUVY6H65FMELUAYDZFANCNFSM5DSIG3UA>\n> .\n> Triage notifications on the go with GitHub Mobile for iOS\n> <https://apps.apple.com/app/apple-store/id1477376905?ct=notification-email&mt=8&pt=524675>\n> or Android\n> <https://play.google.com/store/apps/details?id=com.github.android&referrer=utm_campaign%3Dnotification-email%26utm_medium%3Demail%26utm_source%3Dgithub>.\n>\n>\n\n\n-- \nAmbar Sarkar:  ***@***.***\nSkype:             ambar.sarkar\n"
    },
    {
      "id": 914308192,
      "user": "oranagra",
      "created_at": "2021-09-07T13:30:00Z",
      "body": "First, whenever a module is present, it's the immediate suspect since they're usually less tested, are lower maturity level, and they can corrupt heap, so even if the module's code is not in the stack trace, unless the error is clearly in Redis, we'll ask the module developer to debug it first. \r\n\r\nSecondly, in this case we see `clone` in the top of the stack trace, so it's a thread, and then we see the module code (I.E. A module thread) calling RM_Call and then it crashes inside Lua, so I'd suspect that the module is doing something invalid. \r\n\r\nRegarding all these prints in the log, I never seen them in plain redis, so I suspect they're also a result of something invalid that the module is doing. "
    },
    {
      "id": 914331344,
      "user": "ambarsarkar",
      "created_at": "2021-09-07T14:00:25Z",
      "body": "Okay, I believe the following scenario is likely happening:\n\nI make a RM_Call from a client, which starts a thread on the server and\nreturns. The server  thread keeps working. In parallel, another client\nmakes a .lua call which prints the other messages (I know that for sure).\nThe earlier thread crashes, and the .lua call thus fails.\n\nThanks for the hints.\n-Ambar\n\nOn Tue, Sep 7, 2021 at 9:30 AM Oran Agra ***@***.***> wrote:\n\n> First, whenever a module is present, it's the immediate suspect since\n> they're usually less tested, are lower maturity level, and they can corrupt\n> heap, so even if the module's code is not in the stack trace, unless the\n> error is clearly in Redis, we'll ask the module developer to debug it first.\n>\n> Secondly, in this case we see clone in the top of the stack trace, so\n> it's a thread, and then we see the module code (I.E. A module thread)\n> calling RM_Call and then it crashes inside Lua, so I'd suspect that the\n> module is doing something invalid.\n>\n> Regarding all these prints in the log, I never seen them in plain redis,\n> so I suspect they're also a result of something invalid that the module is\n> doing.\n>\n> —\n> You are receiving this because you authored the thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/redis/redis/issues/9466#issuecomment-914308192>, or\n> unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AC4DZWAYHGP5DQOKNFLDHWLUAYHWLANCNFSM5DSIG3UA>\n> .\n> Triage notifications on the go with GitHub Mobile for iOS\n> <https://apps.apple.com/app/apple-store/id1477376905?ct=notification-email&mt=8&pt=524675>\n> or Android\n> <https://play.google.com/store/apps/details?id=com.github.android&referrer=utm_campaign%3Dnotification-email%26utm_medium%3Demail%26utm_source%3Dgithub>.\n>\n>\n\n\n-- \nAmbar Sarkar:  ***@***.***\nSkype:             ambar.sarkar\n"
    }
  ]
}