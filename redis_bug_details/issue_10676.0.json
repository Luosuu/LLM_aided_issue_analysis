{
  "issue_number": 10676.0,
  "title": "[CRASH] error while creating redisearch indexes",
  "body": "**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n1:M 02 May 2022 23:56:09.068 # Redis 6.2.6 crashed by signal: 11, si_code: 128\r\n1:M 02 May 2022 23:56:09.068 # Accessing address: (nil)\r\n1:M 02 May 2022 23:56:09.068 # Crashed running the instruction at: 0x55e68f61fdfe\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\nredis-server *:6380(RM_StringPtrLen+0xe)[0x55e68f61fdfe]\r\n\r\nBacktrace:\r\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x14140)[0x7f62fe1c2140]\r\nredis-server *:6380(RM_StringPtrLen+0xe)[0x55e68f61fdfe]\r\n/usr/lib/redis/modules/redisearch.so(RSValue_Equal+0x73)[0x7f62fd3272e3]\r\n/usr/lib/redis/modules/redisearch.so(+0x101edd)[0x7f62fd2c5edd]\r\n/usr/lib/redis/modules/redisearch.so(Indexes_FindMatchingSchemaRules+0x1a7)[0x7f62fd318817]\r\n/usr/lib/redis/modules/redisearch.so(IndexSpec_UpdateMatchingWithSchemaRules+0x3c)[0x7f62fd318abc]\r\n/usr/lib/redis/modules/redisearch.so(+0x154d6a)[0x7f62fd318d6a]\r\nredis-server *:6380(+0xd5c42)[0x55e68f61ec42]\r\nredis-server *:6380(dictScan+0x22c)[0x55e68f59387c]\r\nredis-server *:6380(RM_Scan+0x76)[0x55e68f61e306]\r\n/usr/lib/redis/modules/redisearch.so(+0x15327d)[0x7f62fd31727d]\r\n/usr/lib/redis/modules/redisearch.so(+0xf77ed)[0x7f62fd2bb7ed]\r\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x8ea7)[0x7f62fe1b6ea7]\r\n/lib/x86_64-linux-gnu/libc.so.6(clone+0x3f)[0x7f62fe0e6def]\r\n\r\n------ REGISTERS ------\r\n1:M 02 May 2022 23:56:09.068 # \r\nRAX:d83b0c2000000008 RBX:00007f62f3ffd280\r\nRCX:0000000000000064 RDX:0000000000000005\r\nRDI:00007f62f9f55d28 RSI:00007f62f3ffd130\r\nRBP:00007f62d83b0c20 RSP:00007f62f3ffd128\r\nR8 :0000000000000008 R9 :00007f62d92c4800\r\nR10:00007f62f3ffdeb0 R11:0000000000000000\r\nR12:00007f62e0c47208 R13:00007f62d92c4810\r\nR14:00007f62f3ffd270 R15:00007f62e0c47208\r\nRIP:000055e68f61fdfe EFL:0000000000010206\r\nCSGSFS:002b000000000033\r\n1:M 02 May 2022 23:56:09.068 # (00007f62f3ffd137) -> 00007f62f3ffd230\r\n1:M 02 May 2022 23:56:09.068 # (00007f62f3ffd136) -> 00007f62f3ffd280\r\n1:M 02 May 2022 23:56:09.068 # (00007f62f3ffd135) -> 00007f62e1ffc2a0\r\n1:M 02 May 2022 23:56:09.068 # (00007f62f3ffd134) -> 0000000000000000\r\n1:M 02 May 2022 23:56:09.068 # (00007f62f3ffd133) -> 00007f62d92c47c0\r\n1:M 02 May 2022 23:56:09.068 # (00007f62f3ffd132) -> 00007f62d83a3a70\r\n1:M 02 May 2022 23:56:09.068 # (00007f62f3ffd131) -> 00007f62e1ffc2a0\r\n1:M 02 May 2022 23:56:09.068 # (00007f62f3ffd130) -> 00007f62d839f500\r\n1:M 02 May 2022 23:56:09.068 # (00007f62f3ffd12f) -> 0000000000000030\r\n1:M 02 May 2022 23:56:09.068 # (00007f62f3ffd12e) -> 00007f62fd30ef37\r\n1:M 02 May 2022 23:56:09.068 # (00007f62f3ffd12d) -> 00007f62f3ffd168\r\n1:M 02 May 2022 23:56:09.069 # (00007f62f3ffd12c) -> 0000000000000000\r\n1:M 02 May 2022 23:56:09.069 # (00007f62f3ffd12b) -> 00007f62d92c47e0\r\n1:M 02 May 2022 23:56:09.069 # (00007f62f3ffd12a) -> 0000000000000000\r\n1:M 02 May 2022 23:56:09.069 # (00007f62f3ffd129) -> 0000000000000001\r\n1:M 02 May 2022 23:56:09.069 # (00007f62f3ffd128) -> 00007f62fd3272e3\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:6.2.6\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:9c335ca9779faba5\r\nredis_mode:standalone\r\nos:Linux 5.15.0-25-generic x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:atomic-builtin\r\ngcc_version:10.2.1\r\nprocess_id:1\r\nprocess_supervised:no\r\nrun_id:aeac49c3ebed7b417ecc556c027cbfd2836bf924\r\ntcp_port:6380\r\nserver_time_usec:1651535769067815\r\nuptime_in_seconds:1347\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:7368601\r\nexecutable:/data/redis-server\r\nconfig_file:\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:1\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:0\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:380522520\r\nused_memory_human:362.89M\r\nused_memory_rss:406482944\r\nused_memory_rss_human:387.65M\r\nused_memory_peak:385697120\r\nused_memory_peak_human:367.83M\r\nused_memory_peak_perc:98.66%\r\nused_memory_overhead:3432888\r\nused_memory_startup:904760\r\nused_memory_dataset:377089632\r\nused_memory_dataset_perc:99.33%\r\nallocator_allocated:381069064\r\nallocator_active:389820416\r\nallocator_resident:399089664\r\ntotal_system_memory:28068499456\r\ntotal_system_memory_human:26.14G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.02\r\nallocator_frag_bytes:8751352\r\nallocator_rss_ratio:1.02\r\nallocator_rss_bytes:9269248\r\nrss_overhead_ratio:1.02\r\nrss_overhead_bytes:7393280\r\nmem_fragmentation_ratio:1.07\r\nmem_fragmentation_bytes:26143752\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.1.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:1\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1651535723\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:2449408\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:95\r\ntotal_commands_processed:169240\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:524014101\r\ntotal_net_output_bytes:7473825\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:13\r\nevicted_keys:0\r\nkeyspace_hits:262659\r\nkeyspace_misses:6\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:4736\r\ntotal_forks:16\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:3\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:34465\r\ntotal_writes_processed:32491\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:b13db7ce74521f564af8fbee978fd9d3e3f5637e\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:2.630869\r\nused_cpu_user:6.280312\r\nused_cpu_sys_children:2.253349\r\nused_cpu_user_children:7.465886\r\nused_cpu_sys_main_thread:0.140462\r\nused_cpu_user_main_thread:1.496979\r\n\r\n# Modules\r\nmodule:name=search,ver=20406,api=1,filters=0,usedby=[],using=[ReJSON],options=[handle-io-errors]\r\nmodule:name=ReJSON,ver=999999,api=1,filters=0,usedby=[search],using=[],options=[handle-io-errors]\r\n\r\n# Commandstats\r\ncmdstat_FT.DROPINDEX:calls=21,usec=1418,usec_per_call=67.52,rejected_calls=0,failed_calls=3\r\ncmdstat_hset:calls=34938,usec=1601237,usec_per_call=45.83,rejected_calls=0,failed_calls=0\r\ncmdstat_info:calls=1,usec=12,usec_per_call=12.00,rejected_calls=0,failed_calls=0\r\ncmdstat_scan:calls=1224,usec=270034,usec_per_call=220.62,rejected_calls=0,failed_calls=0\r\ncmdstat_smembers:calls=1,usec=2218,usec_per_call=2218.00,rejected_calls=0,failed_calls=0\r\ncmdstat_FT.TAGVALS:calls=6,usec=110,usec_per_call=18.33,rejected_calls=0,failed_calls=0\r\ncmdstat_hgetall:calls=346,usec=2245,usec_per_call=6.49,rejected_calls=0,failed_calls=0\r\ncmdstat_FT.CREATE:calls=22,usec=1776,usec_per_call=80.73,rejected_calls=0,failed_calls=0\r\ncmdstat_sadd:calls=36,usec=11661,usec_per_call=323.92,rejected_calls=0,failed_calls=0\r\ncmdstat_del:calls=65407,usec=122754,usec_per_call=1.88,rejected_calls=0,failed_calls=0\r\ncmdstat_FT.AGGREGATE:calls=492,usec=27490,usec_per_call=55.87,rejected_calls=0,failed_calls=0\r\ncmdstat_zadd:calls=65388,usec=619283,usec_per_call=9.47,rejected_calls=0,failed_calls=0\r\ncmdstat_multi:calls=602,usec=708,usec_per_call=1.18,rejected_calls=0,failed_calls=0\r\ncmdstat_zrange:calls=26,usec=128,usec_per_call=4.92,rejected_calls=0,failed_calls=0\r\ncmdstat_exec:calls=602,usec=2584389,usec_per_call=4293.00,rejected_calls=0,failed_calls=0\r\ncmdstat_FT.SEARCH:calls=128,usec=3551,usec_per_call=27.74,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\nerrorstat_Unknown:count=3\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=50096,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=143 addr=192.168.1.48:55568 laddr=172.18.0.4:6380 fd=8 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=40954 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=61664 events=r cmd=FT.CREATE user=default redir=-1\r\n\r\n------ MODULES INFO OUTPUT ------\r\n# ReJSON_trace\r\nReJSON_trace:   0: redis_module::base_info_func\r\n             at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/redis-module-1.0.0/src/lib.rs:78:33\r\n   1: rejson::__info_func\r\n             at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/redis-module-1.0.0/src/macros.rs:120:13\r\n   2: modulesCollectInfo\r\n             at /usr/src/redis/src/module.c:7078:9\r\n   3: logModulesInfo\r\n             at /usr/src/redis/src/debug.c:1598:22\r\n   4: printCrashReport\r\n             at /usr/src/redis/src/debug.c:1849:5\r\n      sigsegvHandler\r\n             at /usr/src/redis/src/debug.c:1831:5\r\n   5: <unknown>\r\n   6: RM_StringPtrLen\r\n             at /usr/src/redis/src/module.c:1349:8\r\n   7: <unknown>\r\n   8: <unknown>\r\n   9: <unknown>\r\n  10: <unknown>\r\n  11: <unknown>\r\n  12: moduleScanCallback\r\n             at /usr/src/redis/src/module.c:7601:5\r\n  13: dictScan\r\n             at /usr/src/redis/src/dict.c:911:13\r\n  14: RM_Scan\r\n             at /usr/src/redis/src/module.c:7689:22\r\n      RM_Scan\r\n             at /usr/src/redis/src/module.c:7682:5\r\n  15: <unknown>\r\n  16: <unknown>\r\n  17: <unknown>\r\n  18: clone\r\n\r\n\r\n------ FAST MEMORY TEST ------\r\n1:M 02 May 2022 23:56:09.077 # main thread terminated\r\n1:M 02 May 2022 23:56:09.077 # Bio thread for job type #0 terminated\r\n1:M 02 May 2022 23:56:09.078 # Bio thread for job type #1 terminated\r\n1:M 02 May 2022 23:56:09.078 # Bio thread for job type #2 terminated\r\n\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: RM_StringPtrLen (base: 0x55e68f61fdf0)\r\nModule: redis-server *:6380 (base 0x55e68f549000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x55e68f61fdf0 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n1:M 02 May 2022 23:56:09.078 # dump of function (hexdump of 142 bytes):\r\n4885ff747b488b47084885f674300fb648ff89ca83e20780fa040f879dcbf6ff488d3d61de0d000fb6d2486314974801faffe20f1f4400008b48f748890ec390488b48efebf5662e0f1f840000000000c0e9030fb6c9ebe30f1f8400000000000fb648fdebd5662e0f1f8400000000000fb748fbebc5662e0f1f840000000000488d0551e10d004885f674b248c7\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version\r\nHost: Ubuntu 20.04 (x86_64)\r\nDocker container: docker.io/redislabs/redisearch:2.4.6\r\n\r\n3. Steps to reproduce (if any)\r\nrandomly occurs",
  "state": "closed",
  "created_at": "2022-05-03T00:02:35Z",
  "updated_at": "2022-05-03T07:08:11Z",
  "closed_at": "2022-05-03T05:52:55Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1115525073,
      "user": "rockyburt",
      "created_at": "2022-05-03T01:22:49Z",
      "body": "Further investigation... this occurs when...\r\n1. add > 16k hash keys\r\n2. create 3 redisearch indexes\r\n3. re-import same 16k hash keys\r\n4. create new redisearch index, bam, redis-server crashes"
    },
    {
      "id": 1115761360,
      "user": "oranagra",
      "created_at": "2022-05-03T05:52:55Z",
      "body": "@rockyburt please report in https://github.com/RediSearch/RediSearch\r\n@gkorland FYI"
    },
    {
      "id": 1115799380,
      "user": "ashtul",
      "created_at": "2022-05-03T07:08:11Z",
      "body": "@rockyburt please reopen on RediSearch.\r\nCan you add the filters you have been using in the indexes schema? The crash is related to the filters.\r\nThanks"
    }
  ]
}