{
  "issue_number": 7703.0,
  "title": "[CRASH]",
  "body": "My Redis has crashed, what should I do now? Thanks\r\n\r\n**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n16409:C 24 Aug 12:10:05.103 # --- FAST MEMORY TEST\r\n16409:C 24 Aug 12:10:07.524 # Fast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n16409:C 24 Aug 12:10:07.524 #\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n       Please report the crash by opening an issue on github:\r\n\r\n           http://github.com/antirez/redis/issues\r\n\r\n  Suspect RAM error? Use redis-server --test-memory to verify it.\r\n\r\n\r\n6004:M 24 Aug 12:10:07.601 # Background saving terminated by signal 11\r\n6004:M 24 Aug 12:10:11.007 * 1 changes in 900 seconds. Saving...\r\n6004:M 24 Aug 12:10:11.008 * Background saving started by pid 16438\r\n16438:C 24 Aug 12:10:11.013 #\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n16438:C 24 Aug 12:10:11.013 # === ASSERTION FAILED OBJECT CONTEXT ===\r\n16438:C 24 Aug 12:10:11.013 # Object type: 7\r\n16438:C 24 Aug 12:10:11.013 # Object encoding: 3\r\n16438:C 24 Aug 12:10:11.013 # Object refcount: 0\r\n16438:C 24 Aug 12:10:11.013 # === ASSERTION FAILED ===\r\n16438:C 24 Aug 12:10:11.013 # ==> rdb.c:328 'sdsEncodedObject(obj)' is not true\r\n16438:C 24 Aug 12:10:11.013 # (forcing SIGSEGV to print the bug report.)\r\n16438:C 24 Aug 12:10:11.013 #     Redis 3.0.6 crashed by signal: 11\r\n16438:C 24 Aug 12:10:11.013 #     SIGSEGV caused by address: 0xffffffffffffffff\r\n16438:C 24 Aug 12:10:11.013 #     Failed assertion: sdsEncodedObject(obj) (rdb.c:328)\r\n16438:C 24 Aug 12:10:11.013 # --- STACK TRACE\r\nredis-rdb-bgsave *:6379(logStackTrace+0xa6)[0x55798dff0c06]\r\nredis-rdb-bgsave *:6379(_redisAssert+0x70)[0x55798dfef780]\r\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x11390)[0x7f6cb2252390]\r\nredis-rdb-bgsave *:6379(_redisAssert+0x70)[0x55798dfef780]\r\nredis-rdb-bgsave *:6379(rdbSaveStringObject+0x45)[0x55798dfd43f5]\r\nredis-rdb-bgsave *:6379(rdbSaveObject+0xa7)[0x55798dfd4ce7]\r\nredis-rdb-bgsave *:6379(rdbSaveKeyValuePair+0xc3)[0x55798dfd50b3]\r\nredis-rdb-bgsave *:6379(rdbSaveRio+0x249)[0x55798dfd5389]\r\nredis-rdb-bgsave *:6379(rdbSave+0x8b)[0x55798dfd573b]\r\nredis-rdb-bgsave *:6379(rdbSaveBackground+0x67)[0x55798dfd5907]\r\nredis-rdb-bgsave *:6379(serverCron+0x653)[0x55798dfbd963]\r\nredis-rdb-bgsave *:6379(aeProcessEvents+0x27a)[0x55798dfb736a]\r\nredis-rdb-bgsave *:6379(aeMain+0x2b)[0x55798dfb758b]\r\nredis-rdb-bgsave *:6379(main+0x364)[0x55798dfb6204]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7f6cb1e97840]\r\nredis-rdb-bgsave *:6379(_start+0x29)[0x55798dfb6379]\r\n16438:C 24 Aug 12:10:11.013 # --- INFO OUTPUT\r\n16438:C 24 Aug 12:10:11.013 # # Server\r\nredis_version:3.0.6\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:7785291a3d2152db\r\nredis_mode:standalone\r\nos:Linux 4.15.0-52-generic x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\ngcc_version:5.4.0\r\nprocess_id:16438\r\nrun_id:3e13bcf8209ce76b4080aaf3079ec5c998f33089\r\ntcp_port:6379\r\nuptime_in_seconds:2844654\r\nuptime_in_days:32\r\nhz:10\r\nlru_clock:4435491\r\nconfig_file:/etc/redis/redis.conf\r\n\r\n# Clients\r\nconnected_clients:4\r\nclient_longest_output_list:0\r\nclient_biggest_input_buf:0\r\nblocked_clients:0\r\n\r\n# Memory\r\nused_memory:21249416\r\nused_memory_human:20.27M\r\nused_memory_rss:60723200\r\nused_memory_peak:309100552\r\nused_memory_peak_human:294.78M\r\nused_memory_lua:36864\r\nmem_fragmentation_ratio:2.86\r\nmem_allocator:jemalloc-3.6.0\r\n\r\n# Persistence\r\nloading:0\r\nrdb_changes_since_last_save:3145\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1598068707\r\nrdb_last_bgsave_status:err\r\nrdb_last_bgsave_time_sec:2\r\nrdb_current_bgsave_time_sec:-1\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\n\r\n# Stats\r\ntotal_connections_received:5816989\r\ntotal_commands_processed:342956949\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:53705612378\r\ntotal_net_output_bytes:4452016981\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:365576\r\nevicted_keys:0\r\nkeyspace_hits:31185229\r\nkeyspace_misses:183043558\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:1028\r\nmigrate_cached_sockets:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_repl_offset:0\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.00\r\nused_cpu_user:0.01\r\nused_cpu_sys_children:0.00\r\nused_cpu_user_children:0.00\r\n\r\n# Commandstats\r\ncmdstat_del:calls=8591590,usec=91254871,usec_per_call=10.62\r\ncmdstat_hset:calls=114310540,usec=380437050,usec_per_call=3.33\r\ncmdstat_hget:calls=205335983,usec=514062639,usec_per_call=2.50\r\ncmdstat_expire:calls=8892804,usec=28599920,usec_per_call=3.22\r\ncmdstat_auth:calls=5826031,usec=11174140,usec_per_call=1.92\r\ncmdstat_monitor:calls=1,usec=3,usec_per_call=3.00\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=6696,expires=6604,avg_ttl=36962513\r\nhash_init_value: 1595760975\r\n\r\n16438:C 24 Aug 12:10:11.013 # --- CLIENT LIST OUTPUT\r\n16438:C 24 Aug 12:10:11.013 # id=356374 addr=101.36.181.186:45059 fd=7 name= age=2740634 idle=2740634 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=ping\r\nid=4873750 addr=63.171.18.34:8312 fd=128 name= age=616323 idle=616322 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=info\r\nid=5253301 addr=60.190.248.12:64017 fd=152 name= age=400777 idle=400777 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=info\r\nid=666215 addr=183.134.104.173:34987 fd=8 name= age=2612374 idle=2612374 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=info\r\n\r\n16438:C 24 Aug 12:10:11.014 # --- REGISTERS\r\n16438:C 24 Aug 12:10:11.014 #\r\nRAX:0000000000000000 RBX:0000000000000148\r\nRCX:00007f6cb2694370 RDX:0000000000000002\r\nRDI:00007f6cb1406000 RSI:0000000000000181\r\nRBP:000055798e033bc0 RSP:00007ffce8538810\r\nR8 :00007f6cb2bb5740 R9 :00007f6cb2bb5740\r\nR10:000000000000002a R11:0000000000000246\r\nR12:000055798e033bd2 R13:00007f6c9d5d89d0\r\nR14:00007f6c9e0f81f0 R15:00007ffce8538930\r\nRIP:000055798dfef780 EFL:0000000000010202\r\nCSGSFS:002b000000000033\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce853881f) -> 0000000000000000\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce853881e) -> 0000000000000008\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce853881d) -> 00007ffce85389b0\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce853881c) -> 0000000000000008\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce853881b) -> 7a22aac0b76e6f00\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce853881a) -> 0000000000000008\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce8538819) -> 7a22aac0b76e6f00\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce8538818) -> 0000000000000000\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce8538817) -> 00007f6c9e0f81f0\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce8538816) -> 0000000000000017\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce8538815) -> 000055798dfd4ce7\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce8538814) -> 0000000000000037\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce8538813) -> 000055798dfd43f5\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce8538812) -> 00007f6c9e0b81a0\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce8538811) -> 00007ffce85389b0\r\n16438:C 24 Aug 12:10:11.014 # (00007ffce8538810) -> 0000000000000478\r\n16438:C 24 Aug 12:10:11.014 # --- FAST MEMORY TEST\r\n16438:C 24 Aug 12:10:13.424 # Fast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n16438:C 24 Aug 12:10:13.424 #\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n       Please report the crash by opening an issue on github:\r\n\r\n           http://github.com/antirez/redis/issues\r\n\r\n  Suspect RAM error? Use redis-server --test-memory to verify it.\r\n\r\n\r\n6004:M 24 Aug 12:10:13.512 # Background saving terminated by signal 11\r\n\r\n\r\n```\r\n\r\n**Aditional information**\r\n\r\nI did run redis-server --test-memory and got:\r\n*** MEMORY ERROR DETECTED: 0x7f9cdd8d3ea0 != 0x7f9d5d8d3ea0 (0 vs 2048)......\r\n\r\n",
  "state": "closed",
  "created_at": "2020-08-24T12:13:10Z",
  "updated_at": "2020-08-24T13:31:36Z",
  "closed_at": "2020-08-24T13:03:22Z",
  "labels": [],
  "comments_data": [
    {
      "id": 679112524,
      "user": "JimWestergren",
      "created_at": "2020-08-24T13:02:26Z",
      "body": "UPDATE:\r\nOk, I have found out that it was the background saving process that was stuck.\r\nBGSAVE did not work.\r\nSAVE did work and things went back to normal for the server.\r\n\r\nI check the error log I see this:\r\n\r\n```\r\n6004:M 24 Aug 12:28:33.296 # --- CURRENT CLIENT INFO\r\n6004:M 24 Aug 12:28:33.296 # client: id=5817047 addr=127.0.0.1:48392 fd=6 name= age=368 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=save\r\n6004:M 24 Aug 12:28:33.296 # argv[0]: 'SAVE'\r\n25043:M 24 Aug 12:28:33.839 # You requested maxclients of 10000 requiring at least 10032 max file descriptors.\r\n25043:M 24 Aug 12:28:33.839 # Redis can't set maximum open files to 10032 because of OS error: Operation not permitted.\r\n25043:M 24 Aug 12:28:33.839 # Current maximum open files is 4096. maxclients has been reduced to 4064 to compensate for low ulimit. If you need higher maxclients increase 'ulimit -n'.\r\n                _._\r\n           _.-``__ ''-._\r\n      _.-``    `.  `_.  ''-._           Redis 3.0.6 (00000000/0) 64 bit\r\n  .-`` .-```.  ```\\/    _.,_ ''-._\r\n (    '      ,       .-`  | `,    )     Running in standalone mode\r\n |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379\r\n |    `-._   `._    /     _.-'    |     PID: 25043\r\n  `-._    `-._  `-./  _.-'    _.-'\r\n |`-._`-._    `-.__.-'    _.-'_.-'|\r\n |    `-._`-._        _.-'_.-'    |           http://redis.io\r\n  `-._    `-._`-.__.-'_.-'    _.-'\r\n |`-._`-._    `-.__.-'    _.-'_.-'|\r\n |    `-._`-._        _.-'_.-'    |\r\n  `-._    `-._`-.__.-'_.-'    _.-'\r\n      `-._    `-.__.-'    _.-'\r\n          `-._        _.-'\r\n              `-.__.-'\r\n\r\n25043:M 24 Aug 12:28:33.839 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.\r\n25043:M 24 Aug 12:28:33.839 # Server started, Redis version 3.0.6\r\n25043:M 24 Aug 12:28:33.839 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.\r\n25043:M 24 Aug 12:28:33.839 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.\r\n25043:M 24 Aug 12:28:33.984 * DB loaded from disk: 0.145 seconds\r\n25043:M 24 Aug 12:28:33.984 * The server is now ready to accept connections on port 6379\r\n25043:M 24 Aug 12:28:44.102 * DB saved on disk\r\n25043:M 24 Aug 12:29:12.704 * DB saved on disk\r\n25043:M 24 Aug 12:34:13.099 * 10 changes in 300 seconds. Saving...\r\n25043:M 24 Aug 12:34:13.100 * Background saving started by pid 31383\r\n31383:C 24 Aug 12:34:13.224 * DB saved on disk\r\n31383:C 24 Aug 12:34:13.225 * RDB: 1 MB of memory used by copy-on-write\r\n25043:M 24 Aug 12:34:13.300 * Background saving terminated with success\r\n\r\n```\r\n\r\nSo I see that Redis is warning me about background save and memory problems. \r\nI have now done the changes according to the instructions in the warning messages. It should be fine now."
    },
    {
      "id": 679127882,
      "user": "oranagra",
      "created_at": "2020-08-24T13:31:35Z",
      "body": "```\r\n16438:C 24 Aug 12:10:11.013 # Object type: 7\r\n16438:C 24 Aug 12:10:11.013 # Object encoding: 3\r\n```\r\nthat's very odd. the highest object type in redis 3.0 is\r\n```\r\n#define REDIS_HASH 4\r\n```"
    }
  ]
}