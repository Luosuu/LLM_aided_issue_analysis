{
  "issue_number": 10076.0,
  "title": "[CRASH] ASSERTION FAILED and stack-buffer-overflow in networking.c:1026",
  "body": "**Crash report**\r\n\r\n```\r\n13886:C 08 Jan 2022 07:29:07.000 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\r\n13886:C 08 Jan 2022 07:29:07.000 # Redis version=255.255.255, bits=64, commit=00000000, modified=0, pid=13886, just started\r\n13886:C 08 Jan 2022 07:29:07.001 # Warning: no config file specified, using the default config. In order to specify a config file use ./redis-server-2022-1-2-ASAN /path/to/redis.conf\r\n13886:M 08 Jan 2022 07:29:07.002 * Increased maximum number of open files to 10032 (it was originally set to 1024).\r\n13886:M 08 Jan 2022 07:29:07.003 * monotonic clock: POSIX clock_gettime\r\n                _._\r\n           _.-``__ ''-._\r\n      _.-``    `.  `_.  ''-._           Redis 255.255.255 (00000000/0) 64 bit\r\n  .-`` .-```.  ```\\/    _.,_ ''-._\r\n (    '      ,       .-`  | `,    )     Running in standalone mode\r\n |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379\r\n |    `-._   `._    /     _.-'    |     PID: 13886\r\n  `-._    `-._  `-./  _.-'    _.-'\r\n |`-._`-._    `-.__.-'    _.-'_.-'|\r\n |    `-._`-._        _.-'_.-'    |           https://redis.io\r\n  `-._    `-._`-.__.-'_.-'    _.-'\r\n |`-._`-._    `-.__.-'    _.-'_.-'|\r\n |    `-._`-._        _.-'_.-'    |\r\n  `-._    `-._`-.__.-'_.-'    _.-'\r\n      `-._    `-.__.-'    _.-'\r\n          `-._        _.-'\r\n              `-.__.-'\r\n\r\n13886:M 08 Jan 2022 07:29:07.009 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.\r\n13886:M 08 Jan 2022 07:29:07.009 # Server initialized\r\n13886:M 08 Jan 2022 07:29:07.010 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.\r\n13886:M 08 Jan 2022 07:29:07.013 * Loading RDB produced by version 255.255.255\r\n13886:M 08 Jan 2022 07:29:07.013 * RDB age 224269 seconds\r\n13886:M 08 Jan 2022 07:29:07.014 * RDB memory usage when created 0.82 Mb\r\n13886:M 08 Jan 2022 07:29:07.014 * Done loading RDB, keys loaded: 60, keys expired: 0.\r\n13886:M 08 Jan 2022 07:29:07.014 * DB loaded from disk: 0.002 seconds\r\n13886:M 08 Jan 2022 07:29:07.014 * Ready to accept connections\r\n13886:M 08 Jan 2022 07:30:11.606 * Replica 127.0.0.1:<unknown-replica-port> asks for synchronization\r\n13886:M 08 Jan 2022 07:30:11.607 * Partial resynchronization not accepted: Replication ID mismatch (Replica asked for 'replicationid', my replication IDs are 'ba3f222f42df34fbf727ff0424d362fddbac19c4' and '304487fdad84b21fb9cded15b081113116e71d4a')\r\n13886:M 08 Jan 2022 07:30:11.608 * Starting BGSAVE for SYNC with target: disk\r\n13886:M 08 Jan 2022 07:30:12.124 * Background saving started by pid 13898\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n13886:M 08 Jan 2022 07:30:12.126 # === ASSERTION FAILED ===\r\n13886:M 08 Jan 2022 07:30:12.127 # ==> networking.c:1026 'c->bufpos == 0 && listLength(c->reply) == 0' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n./redis-server-2022-1-2-ASAN *:6379(_serverAssert+0x83)[0x7fb36b62c1b3]\r\n./redis-server-2022-1-2-ASAN *:6379(clientHasPendingReplies+0x1ed)[0x7fb36b56cf5d]\r\n./redis-server-2022-1-2-ASAN *:6379(prepareClientToWrite+0x6a)[0x7fb36b56d01a]\r\n./redis-server-2022-1-2-ASAN *:6379(addReply+0x93)[0x7fb36b575613]\r\n./redis-server-2022-1-2-ASAN *:6379(addReplyLongLongWithPrefix+0x1a7)[0x7fb36b57a967]\r\n./redis-server-2022-1-2-ASAN *:6379(slowlogCommand+0x41e)[0x7fb36b65f10e]\r\n./redis-server-2022-1-2-ASAN *:6379(call+0x11b)[0x7fb36b52cedb]\r\n./redis-server-2022-1-2-ASAN *:6379(processCommand+0xb4f)[0x7fb36b530c1f]\r\n./redis-server-2022-1-2-ASAN *:6379(processCommandAndResetClient+0x3e)[0x7fb36b57196e]\r\n./redis-server-2022-1-2-ASAN *:6379(processInputBuffer+0x24e)[0x7fb36b579d7e]\r\n./redis-server-2022-1-2-ASAN *:6379(readQueryFromClient+0x9b8)[0x7fb36b581888]\r\n./redis-server-2022-1-2-ASAN *:6379(+0x330597)[0x7fb36b730597]\r\n./redis-server-2022-1-2-ASAN *:6379(aeProcessEvents+0x4ec)[0x7fb36b51a44c]\r\n./redis-server-2022-1-2-ASAN *:6379(aeMain+0x4d)[0x7fb36b51b30d]\r\n./redis-server-2022-1-2-ASAN *:6379(main+0x442)[0x7fb36b50e3d2]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xe7)[0x7fb369491b97]\r\n./redis-server-2022-1-2-ASAN *:6379(_start+0x2a)[0x7fb36b50fe3a]\r\n\r\n------ INFO OUTPUT ------\r\n13898:C 08 Jan 2022 07:30:12.142 * DB saved on disk\r\n# Server\r\nredis_version:255.255.255\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:41175f004c38f34d\r\nredis_mode:standalone\r\nos:Linux 4.4.0-19041-Microsoft x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:7.5.0\r\nprocess_id:13886\r\nprocess_supervised:no\r\nrun_id:93e5ce2ba2afb2adb037d8b22ba1a98c7b056cdd\r\ntcp_port:6379\r\nserver_time_usec:1641598212124840\r\nuptime_in_seconds:65\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:14208259\r\nexecutable:/mnt/d/zyp/fuzzer/memdbFuzz/visualstudio/afl-vs-raw/afl-vs-raw/bin/x64/Debug/./redis-server-2022-1-2-ASAN\r\nconfig_file:\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:0\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:0\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:902984\r\nused_memory_human:881.82K\r\nused_memory_rss:17035264\r\nused_memory_rss_human:16.25M\r\nused_memory_peak:902984\r\nused_memory_peak_human:881.82K\r\nused_memory_peak_perc:100.20%\r\nused_memory_overhead:851076\r\nused_memory_startup:847960\r\nused_memory_dataset:51908\r\nused_memory_dataset_perc:94.34%\r\nallocator_allocated:1013328\r\nallocator_active:1212416\r\nallocator_resident:4624384\r\ntotal_system_memory:8359202816\r\ntotal_system_memory_human:7.79G\r\nused_memory_lua:37888\r\nused_memory_vm_eval:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nused_memory_vm_functions:35840\r\nused_memory_vm_total:73728\r\nused_memory_vm_total_human:72.00K\r\nused_memory_functions:168\r\nused_memory_scripts:168\r\nused_memory_scripts_human:168B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.20\r\nallocator_frag_bytes:199088\r\nallocator_rss_ratio:3.81\r\nallocator_rss_bytes:3411968\r\nrss_overhead_ratio:3.68\r\nrss_overhead_bytes:12410880\r\nmem_fragmentation_ratio:19.82\r\nmem_fragmentation_bytes:16175864\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:4\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:0\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.2.1\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:60\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:1\r\nrdb_last_save_time:1641598147\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:60\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:1\r\ntotal_commands_processed:1\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:58\r\ntotal_net_output_bytes:0\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\nrejected_connections:0\r\nsync_full:1\r\nsync_partial_ok:0\r\nsync_partial_err:1\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:2\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:514741\r\ntotal_forks:1\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:1\r\ntotal_writes_processed:0\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:1\r\nslave0:ip=127.0.013898:C 08 Jan 2022 07:30:12.149 * Fork CoW for RDB: current 0 MB, peak 0 MB, average 0 MB\r\n.1,port=0,state=wait_bgsave,offset=0,lag=0\r\nmaster_failover_state:no-failover\r\nmaster_replid:ba3f222f42df34fbf727ff0424d362fddbac19c4\r\nmaster_replid2:304487fdad84b21fb9cded15b081113116e71d4a\r\nmaster_repl_offset:28\r\nsecond_repl_offset:29\r\nrepl_backlog_active:1\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:29\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.031250\r\nused_cpu_user:0.015625\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:0.031250\r\nused_cpu_user_main_thread:0.015625\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_psync:calls=1,usec=519279,usec_per_call=519279.00,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=60,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=4 addr=127.0.0.1:11428 laddr=127.0.0.1:6379 fd=8 name= age=1 idle=1 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=58 qbuf-free=20416 argv-mem=11 multi-mem=0 obl=0 oll=1 omem=0 tot-mem=40995 events=r cmd=slowlog|get user=default redir=-1 resp=2\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=4 addr=127.0.0.1:11428 laddr=127.0.0.1:6379 fd=8 name= age=1 idle=1 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=58 qbuf-free=20416 argv-mem=11 multi-mem=0 obl=0 oll=1 omem=0 tot-mem=40995 events=r cmd=slowlog|get user=default redir=-1 resp=2\r\nargv[0]: 'SLOWLOG'\r\nargv[1]: 'GET'\r\nargv[2]: '3'\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nio-threads-do-reads no\r\nlazyfree-lazy-eviction no\r\nlazyfree-lazy-expire no\r\nlazyfree-lazy-server-del no\r\nlazyfree-lazy-user-del no\r\nlazyfree-lazy-user-flush no\r\nrepl-diskless-sync no\r\nreplica-read-only yes\r\nactivedefrag no\r\nrepl-diskless-load disabled\r\nsanitize-dump-payload no\r\nio-threads 1\r\nlist-compress-depth 0\r\nproto-max-bulk-len 512mb\r\nclient-query-buffer-limit 1gb\r\n\r\n------ FAST MEMORY TEST ------\r\n13886:M 08 Jan 2022 07:30:12.176 # Bio thread for job type #0 terminated\r\n13886:M 08 Jan 2022 07:30:12.176 # Bio thread for job type #1 terminated\r\n13886:M 08 Jan 2022 07:30:12.176 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 7fff7000 (268435456 bytes)\r\n*** Preparing to test memory region 2008fff7000 (15392894357504 bytes)\r\n*** Preparing to test memory region 602000000000 (65536 bytes)\r\n*** Preparing to test memory region 602e00000000 (65536 bytes)\r\n*** Preparing to test memory region 603000000000 (65536 bytes)\r\n*** Preparing to test memory region 603e00000000 (65536 bytes)\r\n*** Preparing to test memory region 604000000000 (65536 bytes)\r\n*** Preparing to test memory region 604e00000000 (65536 bytes)\r\n*** Preparing to test memory region 606000000000 (65536 bytes)\r\n*** Preparing to test memory region 606e00000000 (65536 bytes)\r\n*** Preparing to test memory region 607000000000 (65536 bytes)\r\n*** Preparing to test memory region 607e00000000 (65536 bytes)\r\n*** Preparing to test memory region 608000000000 (65536 bytes)\r\n*** Preparing to test memory region 608e00000000 (65536 bytes)\r\n*** Preparing to test memory region 60b000000000 (65536 bytes)\r\n*** Preparing to test memory region 60be00000000 (65536 bytes)\r\n*** Preparing to test memory region 60c000000000 (65536 bytes)\r\n*** Preparing to test memory region 60ce00000000 (65536 bytes)\r\n*** Preparing to test memory region 60d000000000 (65536 bytes)\r\n*** Preparing to test memory region 60de00000000 (65536 bytes)\r\n*** Preparing to test memory region 60e000000000 (65536 bytes)\r\n*** Preparing to test memory region 60ee00000000 (65536 bytes)\r\n*** Preparing to test memory region 60f000000000 (65536 bytes)\r\n*** Preparing to test memory region 60fe00000000 (65536 bytes)\r\n*** Preparing to test memory region 610000000000 (65536 bytes)\r\n*** Preparing to test memory region 610e00000000 (65536 bytes)\r\n*** Preparing to test memory region 611000000000 (65536 bytes)\r\n*** Preparing to test memory region 611e00000000 (65536 bytes)\r\n*** Preparing to test memory region 612000000000 (65536 bytes)\r\n*** Preparing to test memory region 612e00000000 (65536 bytes)\r\n*** Preparing to test memory region 613000000000 (65536 bytes)\r\n*** Preparing to test memory region 613e00000000 (65536 bytes)\r\n*** Preparing to test memory region 615000000000 (65536 bytes)\r\n*** Preparing to test memory region 615e00000000 (65536 bytes)\r\n*** Preparing to test memory region 616000000000 (65536 bytes)\r\n*** Preparing to test memory region 616e00000000 (65536 bytes)\r\n*** Preparing to test memory region 617000000000 (65536 bytes)\r\n*** Preparing to test memory region 617e00000000 (65536 bytes)\r\n*** Preparing to test memory region 619000000000 (65536 bytes)\r\n*** Preparing to test memory region 619e00000000 (65536 bytes)\r\n*** Preparing to test memory region 61a000000000 (65536 bytes)\r\n*** Preparing to test memory region 61ae00000000 (65536 bytes)\r\n*** Preparing to test memory region 61b000000000 (65536 bytes)\r\n*** Preparing to test memory region 61be00000000 (65536 bytes)\r\n*** Preparing to test memory region 61d000000000 (65536 bytes)\r\n*** Preparing to test memory region 61de00000000 (65536 bytes)\r\n*** Preparing to test memory region 61e000000000 (65536 bytes)\r\n*** Preparing to test memory region 61ee00000000 (65536 bytes)\r\n*** Preparing to test memory region 621000000000 (65536 bytes)\r\n*** Preparing to test memory region 621e00000000 (65536 bytes)\r\n*** Preparing to test memory region 624000000000 (327680 bytes)\r\n*** Preparing to test memory region 624e00000000 (65536 bytes)\r\n*** Preparing to test memory region 640000000000 (12288 bytes)\r\n*** Preparing to test memory region 7fb3638c1000 (8388608 bytes)\r\n*** Preparing to test memory region 7fb3640d1000 (8388608 bytes)\r\n*** Preparing to test memory region 7fb3648e1000 (8388608 bytes)\r\n*** Preparing to test memory region 7fb3650f1000 (8388608 bytes)\r\n*** Preparing to test memory region 7fb365c00000 (8388608 bytes)\r\n*** Preparing to test memory region 7fb366500000 (1048576 bytes)\r\n*** Preparing to test memory region 7fb366700000 (1048576 bytes)\r\n*** Preparing to test memory region 7fb366890000 (32768 bytes)\r\n*** Preparing to test memory region 7fb3668a0000 (57344 bytes)\r\n*** Preparing to test memory region 7fb366900000 (1048576 bytes)\r\n*** Preparing to test memory region 7fb366a10000 (69632 bytes)\r\n*** Preparing to test memory region 7fb366a30000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366a40000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366a50000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366a60000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366a70000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366a80000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366a90000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366aa0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366ab0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366ac0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366ad0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366ae0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366af0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366b00000 (1052672 bytes)\r\n*** Preparing to test memory region 7fb366c10000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366c20000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366c30000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366c40000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366c50000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366c60000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366c70000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366c80000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366c90000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366ca0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366cb0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366cc0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366cd0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb366ce0000 (37036032 bytes)\r\n*** Preparing to test memory region 7fb369257000 (4096 bytes)\r\n*** Preparing to test memory region 7fb369467000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36985b000 (8192 bytes)\r\n*** Preparing to test memory region 7fb36985d000 (16384 bytes)\r\n*** Preparing to test memory region 7fb369a8a000 (4096 bytes)\r\n*** Preparing to test memory region 7fb369a8b000 (16384 bytes)\r\n*** Preparing to test memory region 7fb369c93000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36a03d000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36a393000 (12288 bytes)\r\n*** Preparing to test memory region 7fb36a396000 (12996608 bytes)\r\n*** Preparing to test memory region 7fb36b030000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b040000 (659456 bytes)\r\n*** Preparing to test memory region 7fb36b0f0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b100000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b110000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b120000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b130000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b140000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b150000 (73728 bytes)\r\n*** Preparing to test memory region 7fb36b170000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b180000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b190000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b1a0000 (16384 bytes)\r\n*** Preparing to test memory region 7fb36b1b0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b1c0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b1d0000 (57344 bytes)\r\n*** Preparing to test memory region 7fb36b1e0000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b1f0000 (32768 bytes)\r\n*** Preparing to test memory region 7fb36b200000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b210000 (8192 bytes)\r\n*** Preparing to test memory region 7fb36b220000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b228000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b229000 (4096 bytes)\r\n*** Preparing to test memory region 7fb36b230000 (8192 bytes)\r\n*** Preparing to test memory region 7fb36b240000 (16384 bytes)\r\n*** Preparing to test memory region 7fb36b250000 (8192 bytes)\r\n=================================================================\r\n==13886==ERROR: AddressSanitizer: stack-buffer-overflow on address 0x7ffff2710b10 at pc 0x7fb36b62b960 bp 0x7ffff27106a0 sp 0x7ffff2710690\r\nWRITE of size 8 at 0x7ffff2710b10 thread T0\r\n    #0 0x7fb36b62b95f in memtest_test_linux_anonymous_maps /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/debug.c:1787\r\n    #1 0x7fb36b62ba14 in doFastMemoryTest /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/debug.c:1841\r\n    #2 0x7fb36b62c1b7 in _serverAssert /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/debug.c:976\r\n    #3 0x7fb36b56cf5c in clientHasPendingReplies /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/networking.c:1026\r\n    #4 0x7fb36b56d019 in prepareClientToWrite /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/networking.c:288\r\n    #5 0x7fb36b575612 in addReply /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/networking.c:382\r\n    #6 0x7fb36b57a966 in addReplyLongLongWithPrefix /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/networking.c:773\r\n    #7 0x7fb36b65f10d in slowlogCommand /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/slowlog.c:190\r\n    #8 0x7fb36b52ceda in call /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/server.c:3029\r\n    #9 0x7fb36b530c1e in processCommand /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/server.c:3606\r\n    #10 0x7fb36b57196d in processCommandAndResetClient /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/networking.c:2171\r\n    #11 0x7fb36b579d7d in processInputBuffer /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/networking.c:2266\r\n    #12 0x7fb36b581887 in readQueryFromClient /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/networking.c:2378\r\n    #13 0x7fb36b730596 in callHandler /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/connhelpers.h:79\r\n    #14 0x7fb36b730596 in connSocketEventHandler /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/connection.c:295\r\n    #15 0x7fb36b51a44b in aeProcessEvents /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/ae.c:428\r\n    #16 0x7fb36b51b30c in aeMain /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/ae.c:488\r\n    #17 0x7fb36b50e3d1 in main /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/server.c:6541\r\n    #18 0x7fb369491b96 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x21b96)\r\n    #19 0x7fb36b50fe39 in _start (/mnt/d/zyp/fuzzer/memdbFuzz/visualstudio/afl-vs-raw/afl-vs-raw/bin/x64/Debug/redis-server-2022-1-2-ASAN+0x10fe39)\r\n\r\nAddress 0x7ffff2710b10 is located in stack of thread T0 at offset 1056 in frame\r\n    #0 0x7fb36b62b3cf in memtest_test_linux_anonymous_maps /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/debug.c:1752\r\n\r\n  This frame has 4 object(s):\r\n    [32, 1056) 'start_vect' <== Memory access at offset 1056 overflows this variable\r\n    [1088, 2112) 'size_vect'\r\n    [2144, 3168) 'line'\r\n    [3200, 4224) 'logbuf'\r\nHINT: this may be a false positive if your program uses some custom stack unwind mechanism or swapcontext\r\n      (longjmp and C++ exceptions *are* supported)\r\nSUMMARY: AddressSanitizer: stack-buffer-overflow /mnt/d/zyp/fuzzer/fuzzed_projects/redis/redis-latest/redis-unstable/src/debug.c:1787 in memtest_test_linux_anonymous_maps\r\nShadow bytes around the buggy address:\r\n  0x10007e4da110: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x10007e4da120: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x10007e4da130: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x10007e4da140: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x10007e4da150: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n=>0x10007e4da160: 00 00[f2]f2 f2 f2 00 00 00 00 00 00 00 00 00 00\r\n  0x10007e4da170: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x10007e4da180: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x10007e4da190: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x10007e4da1a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x10007e4da1b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07\r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n==13886==ABORTING\r\n\r\n\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version\r\n  OS: Window WSL v1. \r\n  Redis version: the unstable branch, commit #5460c10 (2022-1-3)\r\n2. Steps to reproduce (if any)\r\n  (a) Build redis code with ASAN \r\n       `CFLAGS=\"-g  -fsanitize=address -fno-omit-frame-pointer \" LDFLAGS=\"-g -O0 -fsanitize=address \" make`\r\n  (b) Download the PoC input file from  https://raw.githubusercontent.com/zyingp/temp/master/redis/crash_StackOverFlow_prepareClientToWrite\r\n  (c) Start the redis server in one console.\r\n      ` ./redis-server`\r\n  (d) Open another console and run nc with the input file like:\r\n     nc 127.0.0.1 6379 < \"./crash_StackOverFlow_prepareClientToWrite\"\r\n   (e) The server crashes.\r\n\r\n   I found the crash by fuzzing.\r\n",
  "state": "closed",
  "created_at": "2022-01-08T01:54:42Z",
  "updated_at": "2022-01-10T06:21:17Z",
  "closed_at": "2022-01-10T06:21:17Z",
  "labels": [
    "crash report"
  ],
  "comments_data": [
    {
      "id": 1007879577,
      "user": "enjoy-binbin",
      "created_at": "2022-01-08T03:51:29Z",
      "body": "Thanks for report, verified.\r\n```\r\n[root@binblog redis]# cat crash2\r\nPSYNC replicationid -5\r\nslowlog get\r\nset a b\r\n[root@binblog redis]# nc 127.0.0.1 6379 < crash2\r\n+FULLRESYNC 373848c87acc903165d2e6ef691ecc2d867d5c9d 14\r\n\r\ncrash in (look like `slowlog get` will add a reply, but the client not able to read it)\r\nint clientHasPendingReplies(client *c) {\r\n    if (getClientType(c) == CLIENT_TYPE_SLAVE) {\r\n        /* Replicas use global shared replication buffer instead of\r\n         * private output buffer. */\r\n        serverAssert(c->bufpos == 0 && listLength(c->reply) == 0);         ->>>>>>>>>  execute (set a b), now len(c->reply): 1 buf: *0\r\n        if (c->ref_repl_buf_node == NULL) return 0;\r\n\r\n        /* If the last replication buffer block content is totally sent,\r\n         * we have nothing to send. */\r\n        listNode *ln = listLast(server.repl_buffer_blocks);\r\n        replBufBlock *tail = listNodeValue(ln);\r\n        if (ln == c->ref_repl_buf_node &&\r\n            c->ref_block_pos == tail->used) return 0;\r\n\r\n        return 1;\r\n    } else {\r\n        return c->bufpos || listLength(c->reply);\r\n    }\r\n}\r\n```\r\n\r\nthe assert introduced in #9166 (not the main reason)\r\n\r\nbtw, if i am not wrong,`PSYNC` is an internal command, and should not be called like this.\r\nand a replica client sholud not write anythings in the reply buffer normally\r\nlooks like it's been fixed in #10020 in normal way, maybe we should do the same in `addReplyDeferredLen`(or other missing)\r\n```\r\n--- a/src/networking.c\r\n+++ b/src/networking.c\r\n@@ -603,6 +603,18 @@ void *addReplyDeferredLen(client *c) {\r\n      * ready to be sent, since we are sure that before returning to the\r\n      * event loop setDeferredAggregateLen() will be called. */\r\n     if (prepareClientToWrite(c) != C_OK) return NULL;\r\n+\r\n+    /* Replicas should normally not cause any writes to the reply buffer. In case a rogue replica sent a command on the\r\n+     * replication link that caused a reply to be generated we'll simply disconnect it.\r\n+     * Note this is the simplest way to check a command added a response. Replication links are used to write data but\r\n+     * not for responses, so we should normally never get here on a replica client. */\r\n+    if (getClientType(c) == CLIENT_TYPE_SLAVE) {\r\n+        serverLog(LL_WARNING, \"Replica generated a reply to command %s, disconnecting it\",\r\n+                  c->lastcmd ? c->lastcmd->name : \"<unknown>\");\r\n+        freeClientAsync(c);\r\n+        return NULL;\r\n+    }\r\n+\r\n     trimReplyUnusedTailSpace(c);\r\n     listAddNodeTail(c->reply,NULL); /* NULL is our placeholder. */\r\n     return listLast(c->reply);\r\n```\r\n\r\nand the serverlog (ps: the subcommand name is error (should be `slowlog get`, but currently not able to do it with lastcmd->name)):\r\n```\r\n24219:M 08 Jan 2022 13:08:55.412 # Replica generated a reply to command get, disconnecting it\r\n```\r\n\r\nneeded @oranagra @yoav-steinberg  check it again.\r\n\r\nif we do so, i like to changed the output info a litter bit:\r\n```\r\n1. cmd with a full name by using `getFullCommandName`, now it will print the right subcommand name like slowlog|get\r\n2. print the full client info by using `catClientInfoString`, i think the info is valuable\r\n\r\n32590:M 08 Jan 2022 16:48:24.453 # Replica generated a reply to command slowlog|get, disconnecting it: id=5 addr=127.0.0.1:41104 laddr=127.0.0.1:6379 fd=8 name= age=0 idle=0 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=52 qbuf-free=20422 argv-mem=10 multi-mem=0 obl=0 oll=0 omem=0 tot-mem=40986 events=r cmd=slowlog|get user=default redir=-1 resp=2\r\n32590:M 08 Jan 2022 16:48:24.453 # Connection with replica 127.0.0.1:<unknown-replica-port> lost.\r\n```"
    },
    {
      "id": 1008242547,
      "user": "oranagra",
      "created_at": "2022-01-09T07:05:30Z",
      "body": "@enjoy-binbin i agree with everything you wrote. please make a PR."
    }
  ]
}