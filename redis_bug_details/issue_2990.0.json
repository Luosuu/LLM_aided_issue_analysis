{
  "issue_number": 2990.0,
  "title": "redis-trib.rb reshard bug",
  "body": "Hi：\n    I find a bug from redis-trib.rb. The reshard cmd compute_reshard_table error,as you say:\n\n```\n    #2) We take one slot more from the first instance in the case of not\n    #    perfect divisibility. Like we have 3 nodes and need to get 10\n    #    slots, we take 4 from the first, and 3 from the rest. So the\n    #    biggest is always the first.\n```\n\n   But if slots is 11, the 11th slot will not allocate.because of the algorithm：\n            n = (numslots.to_f/source_tot_slots*s.slots.length)\n            if i == 0\n                n = n.ceil\n            else\n                n = n.floor\n\nOnly the first node use ceil result in the bug.\nthis is the case:\nruby redis-trib.rb reshard --from all --to 80b661ecca260c89e3d8ea9b98f77edaeef43dcd --slots 11 10.180.157.199:6379\n\n> > > Performing Cluster Check (using node 10.180.157.199:6379)\n> > > S: b2506515b38e6bbd3034d540599f4cd2a5279ad1 10.180.157.199:6379\n> > >    slots: (0 slots) slave\n> > >    replicates 460b3a11e296aafb2615043291b7dd98274bb351\n> > > S: d376aaf80de0e01dde1f8cd4647d5ac3317a8641 10.180.157.205:6379\n> > >    slots: (0 slots) slave\n> > >    replicates e36c46dbe90960f30861af00786d4c2064e63df2\n> > > M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379\n> > >    slots:10923-16383 (5461 slots) master\n> > >    1 additional replica(s)\n> > > S: 59fa6ee455f58a5076f6d6f83ddd74161fd7fb55 10.180.157.208:6379\n> > >    slots: (0 slots) slave\n> > >    replicates 15126fb33796c2c26ea89e553418946f7443d5a5\n> > > M: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379\n> > >    slots:0-5460 (5461 slots) master\n> > >    1 additional replica(s)\n> > > M: 80b661ecca260c89e3d8ea9b98f77edaeef43dcd 10.180.157.200:6380\n> > >    slots: (0 slots) master\n> > >    0 additional replica(s)\n> > > M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379\n> > >    slots:5461-10922 (5462 slots) master\n> > >    1 additional replica(s)\n> > > [OK] All nodes agree about slots configuration.\n> > > Check for open slots...\n> > > Check slots coverage...\n> > > [OK] All 16384 slots covered.\n\nReady to move 11 slots.\n  Source nodes:\n    M: 15126fb33796c2c26ea89e553418946f7443d5a5 10.180.157.201:6379\n   slots:10923-16383 (5461 slots) master\n   1 additional replica(s)\n    M: 460b3a11e296aafb2615043291b7dd98274bb351 10.180.157.202:6379\n   slots:0-5460 (5461 slots) master\n   1 additional replica(s)\n    M: e36c46dbe90960f30861af00786d4c2064e63df2 10.180.157.200:6379\n   slots:5461-10922 (5462 slots) master\n   1 additional replica(s)\n  Destination node:\n    M: 80b661ecca260c89e3d8ea9b98f77edaeef43dcd 10.180.157.200:6380\n   slots: (0 slots) master\n   0 additional replica(s)\n  Resharding plan:\n    Moving slot 5461 from e36c46dbe90960f30861af00786d4c2064e63df2\n    Moving slot 5462 from e36c46dbe90960f30861af00786d4c2064e63df2\n    Moving slot 5463 from e36c46dbe90960f30861af00786d4c2064e63df2\n    Moving slot 5464 from e36c46dbe90960f30861af00786d4c2064e63df2\n    Moving slot 0 from 460b3a11e296aafb2615043291b7dd98274bb351\n    Moving slot 1 from 460b3a11e296aafb2615043291b7dd98274bb351\n    Moving slot 2 from 460b3a11e296aafb2615043291b7dd98274bb351\n    Moving slot 10923 from 15126fb33796c2c26ea89e553418946f7443d5a5\n    Moving slot 10924 from 15126fb33796c2c26ea89e553418946f7443d5a5\n    Moving slot 10925 from 15126fb33796c2c26ea89e553418946f7443d5a5\nDo you want to proceed with the proposed reshard plan (yes/no)? yes\nMoving slot 5461 from 10.180.157.200:6379 to 10.180.157.200:6380:\nMoving slot 5462 from 10.180.157.200:6379 to 10.180.157.200:6380:\nMoving slot 5463 from 10.180.157.200:6379 to 10.180.157.200:6380:\nMoving slot 5464 from 10.180.157.200:6379 to 10.180.157.200:6380:\nMoving slot 0 from 10.180.157.202:6379 to 10.180.157.200:6380:\nMoving slot 1 from 10.180.157.202:6379 to 10.180.157.200:6380:\nMoving slot 2 from 10.180.157.202:6379 to 10.180.157.200:6380:\nMoving slot 10923 from 10.180.157.201:6379 to 10.180.157.200:6380:\nMoving slot 10924 from 10.180.157.201:6379 to 10.180.157.200:6380:\nMoving slot 10925 from 10.180.157.201:6379 to 10.180.157.200:6380:\n",
  "state": "open",
  "created_at": "2016-01-07T07:41:28Z",
  "updated_at": "2016-01-07T07:44:57Z",
  "closed_at": null,
  "labels": [
    "non critical bug",
    "cluster"
  ],
  "comments_data": [
    {
      "id": 169587118,
      "user": "weizijun",
      "created_at": "2016-01-07T07:42:14Z",
      "body": "redis-trib.rb is from redis 3.0.6 version\n"
    }
  ]
}