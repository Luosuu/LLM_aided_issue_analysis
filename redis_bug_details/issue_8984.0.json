{
  "issue_number": 8984.0,
  "title": "[BUG] Redis 6.2.1 crash in processCommand",
  "body": "```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n1568:M 22 May 2021 13:29:59.793 # Redis 6.2.1 crashed by signal: 11, si_code: 2\r\n1568:M 22 May 2021 13:29:59.793 # Accessing address: 0x7f88a5ab6200\r\n1568:M 22 May 2021 13:29:59.793 # Killed by PID: -1515494912, UID: 32648\r\n1568:M 22 May 2021 13:29:59.793 # Crashed running the instruction at: 0x7f88a5ab6200\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n/lib64/libc.so.6(+0x15a200)[0x7f88a5ab6200]\r\n\r\nBacktrace:\r\n/lib64/libpthread.so.0(+0x12b20)[0x7f88a5d31b20]\r\n/lib64/libc.so.6(+0x15a200)[0x7f88a5ab6200]\r\n/www/server/redis/src/redis-server 127.0.0.1:6569(processCommand+0x2e)[0x4392ee]\r\n/www/server/redis/src/redis-server 127.0.0.1:6569(processCommandAndResetClient+0x10)[0x44d050]\r\n/www/server/redis/src/redis-server 127.0.0.1:6569(processInputBuffer+0xda)[0x44f4aa]\r\n/www/server/redis/src/redis-server 127.0.0.1:6569[0x4d7258]\r\n/www/server/redis/src/redis-server 127.0.0.1:6569(aeProcessEvents+0x299)[0x431ec9]\r\n/www/server/redis/src/redis-server 127.0.0.1:6569(aeMain+0x1d)[0x43212d]\r\n/www/server/redis/src/redis-server 127.0.0.1:6569(main+0x47f)[0x42ebaf]\r\n/lib64/libc.so.6(__libc_start_main+0xf3)[0x7f88a597f7b3]\r\n/www/server/redis/src/redis-server 127.0.0.1:6569(_start+0x2e)[0x42ee5e]\r\n\r\n------ REGISTERS ------\r\n1568:M 22 May 2021 13:29:59.794 #\r\nRAX:00007f88a1287e00 RBX:00007f88a08c6580\r\nRCX:00007f8880000000 RDX:000000000000003a\r\nRDI:00007f88a1287e13 RSI:000000000056c32d\r\nRBP:00007f88a1287e13 RSP:00007ffdcf3473d8\r\nR8 :0000000000000028 R9 :0000000000000040\r\nR10:1999999999999999 R11:00007f88a68e27d8\r\nR12:0000000000000000 R13:000000000000000a\r\nR14:0000000000000000 R15:0000000000000001\r\nRIP:00007f88a5ab6200 EFL:0000000000010246\r\nCSGSFS:002b000000000033\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e7) -> 00007f88a1da0300\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e6) -> 000000000044f4aa\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e5) -> 00007f88a08c6580\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e4) -> 000000000044d050\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e3) -> 0000000000000001\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e2) -> 0000000000000000\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e1) -> 000000000000000a\r\n\r\n\r\n\r\n------ REGISTERS ------\r\n1568:M 22 May 2021 13:29:59.794 #\r\nRAX:00007f88a1287e00 RBX:00007f88a08c6580\r\nRCX:00007f8880000000 RDX:000000000000003a\r\nRDI:00007f88a1287e13 RSI:000000000056c32d\r\nRBP:00007f88a1287e13 RSP:00007ffdcf3473d8\r\nR8 :0000000000000028 R9 :0000000000000040\r\nR10:1999999999999999 R11:00007f88a68e27d8\r\nR12:0000000000000000 R13:000000000000000a\r\nR14:0000000000000000 R15:0000000000000001\r\nRIP:00007f88a5ab6200 EFL:0000000000010246\r\nCSGSFS:002b000000000033\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e7) -> 00007f88a1da0300\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e6) -> 000000000044f4aa\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e5) -> 00007f88a08c6580\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e4) -> 000000000044d050\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e3) -> 0000000000000001\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e2) -> 0000000000000000\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e1) -> 000000000000000a\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473e0) -> 0000000000000000\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473df) -> 0000000000000000\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473de) -> 00007f88a08c6580\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473dd) -> 0000000000000000\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473dc) -> 00007f88a01d8b3a\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473db) -> 00007f88a1da0300\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473da) -> 000000000044eea6\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473d9) -> 0000000000000002\r\n1568:M 22 May 2021 13:29:59.794 # (00007ffdcf3473d8) -> 00000000004392ee\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:6.2.1\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:ecb0914182a9d599\r\nredis_mode:standalone\r\nos:Linux 4.18.0-193.28.1.el8_2.x86_64 x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:8.3.1\r\nprocess_id:1568\r\nprocess_supervised:no\r\nrun_id:0a18317a4a1532b97c44beec6a3d51a5bd5830a1\r\ntcp_port:6569\r\nserver_time_usec:1621661399793384\r\nuptime_in_seconds:271685\r\nuptime_in_days:3\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:11048663\r\nexecutable:/www/server/redis/src/redis-server\r\nconfig_file:/www/server/redis/redis.conf\r\nio_threads_active:0\r\n\r\n\r\n# Clients\r\nconnected_clients:4\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:48\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:39999632\r\nused_memory_human:38.15M\r\nused_memory_rss:51531776\r\nused_memory_rss_human:49.14M\r\nused_memory_peak:50902600\r\nused_memory_peak_human:48.54M\r\nused_memory_peak_perc:78.58%\r\nused_memory_overhead:6325456\r\nused_memory_startup:809944\r\nused_memory_dataset:33674176\r\nused_memory_dataset_perc:85.93%\r\nallocator_allocated:40033208\r\nallocator_active:41029632\r\nallocator_resident:44982272\r\ntotal_system_memory:67277574144\r\ntotal_system_memory_human:62.66G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.02\r\nallocator_frag_bytes:996424\r\nallocator_rss_ratio:1.10\r\nallocator_rss_bytes:3952640\r\nrss_overhead_ratio:1.15\r\nrss_overhead_bytes:6549504\r\nmem_fragmentation_ratio:1.29\r\nmem_fragmentation_bytes:11538616\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:82048\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.1.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n\r\n# Persistence\r\nloading:0\r\ncurrent_cow_size:0\r\ncurrent_fork_perc:0.00%\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:257652\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1621661361\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:0\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:9207808\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n\r\n# Stats\r\ntotal_connections_received:33\r\ntotal_commands_processed:16584131964\r\ninstantaneous_ops_per_sec:130943\r\ntotal_net_input_bytes:1750971263843\r\ntotal_net_output_bytes:4867758670484\r\ninstantaneous_input_kbps:12472.18\r\ninstantaneous_output_kbps:5005.09\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:627575\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:12691\r\nevicted_keys:0\r\nkeyspace_hits:3628477982\r\nkeyspace_misses:3077427151\r\npubsub_channels:0\r\npubsub_patterns:3\r\nlatest_fork_usec:2036\r\ntotal_forks:4388\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:5307055595\r\ntotal_writes_processed:5309129872\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:69b6f46a3e92ffe76a1e14a91e8dbc60e63014ef\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:58691.294602\r\nused_cpu_user:28354.451446\r\nused_cpu_sys_children:83.203099\r\nused_cpu_user_children:1082.557107\r\nused_cpu_sys_main_thread:58686.231479\r\nused_cpu_user_main_thread:28353.492568\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_publish:calls=822377,usec=3477225,usec_per_call=4.23,rejected_calls=0,failed_calls=0\r\ncmdstat_lset:calls=8315,usec=31391,usec_per_call=3.78,rejected_calls=0,failed_calls=0\r\ncmdstat_select:calls=5,usec=2,usec_per_call=0.40,rejected_calls=0,failed_calls=0\r\ncmdstat_dbsize:calls=1,usec=0,usec_per_call=0.00,rejected_calls=0,failed_calls=0\r\ncmdstat_punsubscribe:calls=4,usec=90,usec_per_call=22.50,rejected_calls=0,failed_calls=0\r\ncmdstat_get:calls=3251903185,usec=2844228331,usec_per_call=0.87,rejected_calls=0,failed_calls=0\r\ncmdstat_setnx:calls=7721273847,usec=5207577967,usec_per_call=0.67,rejected_calls=0,failed_calls=0\r\ncmdstat_exists:calls=2814967350,usec=3095864336,usec_per_call=1.10,rejected_calls=0,failed_calls=0\r\ncmdstat_del:calls=282363606,usec=376804471,usec_per_call=1.33,rejected_calls=0,failed_calls=0\r\ncmdstat_rpush:calls=137402,usec=847946,usec_per_call=6.17,rejected_calls=0,failed_calls=0\r\ncmdstat_psubscribe:calls=5,usec=111,usec_per_call=22.20,rejected_calls=0,failed_calls=0\r\ncmdstat_llen:calls=30326,usec=38589,usec_per_call=1.27,rejected_calls=0,failed_calls=0\r\ncmdstat_set:calls=1138123005,usec=2204937824,usec_per_call=1.94,rejected_calls=0,failed_calls=0\r\ncmdstat_keys:calls=5,usec=125852,usec_per_call=25170.40,rejected_calls=0,failed_calls=0\r\ncmdstat_lindex:calls=281691928,usec=552834721,usec_per_call=1.96,rejected_calls=0,failed_calls=0\r\ncmdstat_lrange:calls=357312344,usec=2334980667,usec_per_call=6.53,rejected_calls=0,failed_calls=0\r\ncmdstat_setex:calls=453204351,usec=1288431857,usec_per_call=2.84,rejected_calls=0,failed_calls=0\r\ncmdstat_expire:calls=976,usec=2039,usec_per_call=2.09,rejected_calls=0,failed_calls=0\r\ncmdstat_pexpire:calls=282292932,usec=326594019,usec_per_call=1.16,rejected_calls=0,failed_calls=0\r\n\r\n\r\n# Errorstats\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=106973,expires=3050,avg_ttl=1922262\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=3 addr=127.0.0.1:43164 laddr=127.0.0.1:6569 fd=7 name= age=270183 idle=1954 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=get user=default redir=-1\r\nid=33 addr=127.0.0.1:55300 laddr=127.0.0.1:6569 fd=8 name= age=67821 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=40954 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=61464 events=r cmd=setnx user=default redir=-1\r\nid=34 addr=127.0.0.1:55302 laddr=127.0.0.1:6569 fd=9 name= age=67821 idle=3 flags=P db=0 sub=0 psub=3 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20520 events=r cmd=psubscribe user=default redir=-1\r\nid=35 addr=127.0.0.1:55438 laddr=127.0.0.1:6569 fd=10 name= age=67800 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=403 qbuf-free=40551 argv-mem=77 obl=0 oll=0 omem=0 tot-mem=61541 events=r cmd=setnx user=default redir=-1\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=35 addr=127.0.0.1:55438 laddr=127.0.0.1:6569 fd=10 name= age=67800 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=403 qbuf-free=40551 argv-mem=77 obl=0 oll=0 omem=0 tot-mem=61541 events=r cmd=setnx user=default redir=-1\r\nargv[0]: 'SETNX'\r\nargv[1]: 'kh_while_is_over_byRobotId_1402'\r\nargv[2]: '-----机器人后台程序-----pool--1782'\r\n1568:M 22 May 2021 13:29:59.794 # key 'kh_while_is_over_byRobotId_1402' found in DB containing the following object:\r\n1568:M 22 May 2021 13:29:59.794 # Object type: 0\r\n1568:M 22 May 2021 13:29:59.794 # Object encoding: 8\r\n1568:M 22 May 2021 13:29:59.794 # Object refcount: 1\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ FAST MEMORY TEST ------\r\n1568:M 22 May 2021 13:29:59.794 # Bio thread for job type #0 terminated\r\n1568:M 22 May 2021 13:29:59.794 # Bio thread for job type #1 terminated\r\n1568:M 22 May 2021 13:29:59.794 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 7e1000 (2277376 bytes)\r\n*** Preparing to test memory region 1b95000 (135168 bytes)\r\n*** Preparing to test memory region 7f889e284000 (78643200 bytes)\r\n*** Preparing to test memory region 7f88a2d85000 (8388608 bytes)\r\n*** Preparing to test memory region 7f88a3586000 (8388608 bytes)\r\n*** Preparing to test memory region 7f88a3d87000 (8388608 bytes)\r\n*** Preparing to test memory region 7f88a4588000 (8388608 bytes)\r\n*** Preparing to test memory region 7f88a5000000 (8388608 bytes)\r\n*** Preparing to test memory region 7f88a5d1b000 (16384 bytes)\r\n*** Preparing to test memory region 7f88a5f3b000 (16384 bytes)\r\n*** Preparing to test memory region 7f88a68e2000 (32768 bytes)\r\n*** Preparing to test memory region 7f88a68f7000 (4096 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: (null) (base: (nil))\r\nModule: /lib64/libc.so.6 (base 0x7f88a595c000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=(nil) -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n```",
  "state": "open",
  "created_at": "2021-05-24T06:53:01Z",
  "updated_at": "2021-09-24T09:49:06Z",
  "closed_at": null,
  "labels": [],
  "comments_data": [
    {
      "id": 846819426,
      "user": "oranagra",
      "created_at": "2021-05-24T07:12:05Z",
      "body": "@syd505 do you happen to know which command or pattern triggered this crash?\r\ncan you please upload the redis executable you used when this happened."
    },
    {
      "id": 926496633,
      "user": "mzygQAQ",
      "created_at": "2021-09-24T09:49:06Z",
      "body": "m"
    }
  ]
}