{
  "issue_number": 13205.0,
  "title": "[CRASH] Redis 7.2.3 crashed in slotToKeyReplaceEntry",
  "body": "```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n9:M 12 Apr 2024 03:02:55.999 # Redis 7.2.3 crashed by signal: 11, si_code: 1\r\n9:M 12 Apr 2024 03:02:55.999 # Accessing address: 0x50\r\n9:M 12 Apr 2024 03:02:55.999 # Crashed running the instruction at: 0x4d0aa5\r\n\r\n------ STACK TRACE ------\r\n\r\nEIP:\r\n/usr/bin/redis-server *:6379 [cluster](slotToKeyReplaceEntry+0xa5)[0x4d0aa5]\r\n\r\nBacktrace:\r\n/lib64/libpthread.so.0(+0x12cf0)[0x7f147eec8cf0]\r\n/usr/bin/redis-server *:6379 [cluster](slotToKeyReplaceEntry+0xa5)[0x4d0aa5]\r\n/usr/bin/redis-server *:6379 [cluster][0x563ed8]\r\n/usr/bin/redis-server *:6379 [cluster][0x5643bf]\r\n/usr/bin/redis-server *:6379 [cluster](activeDefragCycle+0x357)[0x48b0f7]\r\n/usr/bin/redis-server *:6379 [cluster](databasesCron+0x6c)[0x5665ac]\r\n/usr/bin/redis-server *:6379 [cluster](serverCron+0x64a)[0x568e9a]\r\n/usr/bin/redis-server *:6379 [cluster][0x56214d]\r\n/usr/bin/redis-server *:6379 [cluster](aeMain+0x1d8)[0x563918]\r\n/usr/bin/redis-server *:6379 [cluster](main+0x39a)[0x450d4a]\r\n/lib64/libc.so.6(__libc_start_main+0xe5)[0x7f147eb2bd85]\r\n/usr/bin/redis-server *:6379 [cluster](_start+0x2e)[0x45147e]\r\n\r\n\r\n------ REGISTERS ------\r\n9:M 12 Apr 2024 03:02:56.000 # \r\nRAX:0000000000011020 RBX:00007f1471d1a4b8\r\nRCX:0000000000000046 RDX:0000000000000000\r\nRDI:00007f1442882912 RSI:000000000000003f\r\nRBP:00007f147e45be40 RSP:00007ffcbf966940\r\nR8 :000000000000003f R9 :00000003a040b000\r\nR10:0000000000000028 R11:0000000000000000\r\nR12:0000000000000000 R13:00007f147e45be40\r\nR14:0000000000000000 R15:00007f12c2288000\r\nRIP:00000000004d0aa5 EFL:0000000000010202\r\nCSGSFS:002b000000000033\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf96694f) -> 00007ffcbf966a30\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf96694e) -> 0000000000000014\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf96694d) -> 00000000005643bf\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf96694c) -> 000000996a97b751\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf96694b) -> 0000000003888000\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf96694a) -> 00007f147e45be40\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf966949) -> 00007f147e42f300\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf966948) -> 000000000048a4a0\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf966947) -> fffffffffff11000\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf966946) -> 00000000002054e9\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf966945) -> 0000000000000000\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf966944) -> 0000000000480930\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf966943) -> 0000000000563ed8\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf966942) -> 0000000000000000\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf966941) -> 00007f1471d1a4b8\r\n9:M 12 Apr 2024 03:02:56.000 # (00007ffcbf966940) -> 00007f13df2560c8\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:7.2.3\r\nredis_git_sha1:7d22beed\r\nredis_git_dirty:0\r\nredis_build_id:7a29a0d060f6d902\r\nredis_mode:cluster\r\nos:Linux 4.18.0-372.75.1.el8_6.x86_64 x86_64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:8.5.0\r\nprocess_id:9\r\nprocess_supervised:no\r\nrun_id:a704b9d1dd51118a824d041f84637ef782f22600\r\ntcp_port:6379\r\nserver_time_usec:1712890975998334\r\nuptime_in_seconds:87634\r\nuptime_in_days:1\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:1614943\r\nexecutable:/usr/bin/redis-server\r\nconfig_file:/redisdb/conf/server.conf\r\nio_threads_active:0\r\nlistener0:name=tcp\r\n\r\n# Clients\r\nconnected_clients:42\r\ncluster_connections:18\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:24576\r\nclient_recent_max_output_buffer:20504\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\ntotal_blocking_keys:0\r\ntotal_blocking_keys_on_nokey:0\r\n\r\n# Memory\r\nused_memory:4741536552\r\nused_memory_human:4.42G\r\nused_memory_rss:5345316864\r\nused_memory_rss_human:4.98G\r\nused_memory_peak:5270248928\r\nused_memory_peak_human:4.91G\r\nused_memory_peak_perc:89.97%\r\nused_memory_overhead:771394852\r\nused_memory_startup:1631608\r\nused_memory_dataset:3970141700\r\nused_memory_dataset_perc:83.76%\r\nallocator_allocated:4741865984\r\nallocator_active:5218967552\r\nallocator_resident:5318950912\r\ntotal_system_memory:540415094784\r\ntotal_system_memory_human:503.30G\r\nused_memory_lua:50176\r\nused_memory_vm_eval:50176\r\nused_memory_lua_human:49.00K\r\nused_memory_scripts_eval:440\r\nnumber_of_cached_scripts:1\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:32768\r\nused_memory_vm_total:82944\r\nused_memory_vm_total_human:81.00K\r\nused_memory_functions:184\r\nused_memory_scripts:624\r\nused_memory_scripts_human:624B\r\nmaxmemory:6442450944\r\nmaxmemory_human:6.00G\r\nmaxmemory_policy:volatile-lru\r\nallocator_frag_ratio:1.10\r\nallocator_frag_bytes:477101568\r\nallocator_rss_ratio:1.02\r\nallocator_rss_bytes:99983360\r\nrss_overhead_ratio:1.00\r\nrss_overhead_bytes:26365952\r\nmem_fragmentation_ratio:1.13\r\nmem_fragmentation_bytes:603782216\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:268438812\r\nmem_total_replication_buffers:269299536\r\nmem_clients_slaves:864080\r\nmem_clients_normal:942856\r\nmem_cluster_links:19296\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.3.0\r\nactive_defrag_running:1\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:71\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:536665877\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1712803341\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:0\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:0\r\nrdb_last_cow_size:1810432\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_rewrites_consecutive_failures:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:8434\r\ntotal_commands_processed:896198239\r\ninstantaneous_ops_per_sec:9639\r\ntotal_net_input_bytes:658918324049\r\ntotal_net_output_bytes:632580610226\r\ntotal_net_repl_input_bytes:0\r\ntotal_net_repl_output_bytes:626872252017\r\ninstantaneous_input_kbps:1535.98\r\ninstantaneous_output_kbps:998.97\r\ninstantaneous_input_repl_kbps:0.00\r\ninstantaneous_output_repl_kbps:948.41\r\nrejected_connections:0\r\nsync_full:1\r\nsync_partial_ok:0\r\nsync_partial_err:1\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:6183\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:22665571\r\nkeyspace_misses:78077474\r\npubsub_channels:0\r\npubsub_patterns:0\r\npubsubshard_channels:0\r\nlatest_fork_usec:801\r\ntotal_forks:1\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:2118892\r\nactive_defrag_misses:4787736\r\nactive_defrag_key_hits:1019014\r\nactive_defrag_key_misses:731397\r\ntotal_active_defrag_time:3369118\r\ncurrent_active_defrag_time:203\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:62942\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:429043632\r\ntotal_writes_processed:770916759\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:16892\r\nreply_buffer_expands:22661\r\neventloop_cycles:404285111\r\neventloop_duration_sum:16676420980\r\neventloop_duration_cmd_sum:2892413108\r\ninstantaneous_eventloop_cycles_per_sec:2959\r\ninstantaneous_eventloop_duration_usec:34\r\nacl_access_denied_auth:0\r\nacl_access_denied_cmd:0\r\nacl_access_denied_key:0\r\nacl_access_denied_channel:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:1\r\nslave0:ip=10.254.119.215\r\nmaster_failover_state:no-failover\r\nmaster_replid:b71b3b31f53260fa7be2cf17bc05837e5f5b47eb\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:626876775351\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:1\r\nrepl_backlog_size:268435456\r\nrepl_backlog_first_byte_offset:626608333401\r\nrepl_backlog_histlen:268441951\r\n\r\n# CPU\r\nused_cpu_sys:8391.303958\r\nused_cpu_user:5192.758853\r\nused_cpu_sys_children:0.200895\r\nused_cpu_user_children:0.519965\r\nused_cpu_sys_main_thread:8385.406512\r\nused_cpu_user_main_thread:5190.564016\r\n\r\n# Modules\r\nmodule:name=auditlog\r\n\r\n# Commandstats\r\ncmdstat_cluster|nodes:calls=10\r\ncmdstat_cluster|myid:calls=8390\r\ncmdstat_cluster|info:calls=87485\r\ncmdstat_flushall:calls=1\r\ncmdstat_replconf:calls=87270\r\ncmdstat_acl|log:calls=873172\r\ncmdstat_psync:calls=1\r\ncmdstat_auth:calls=8434\r\ncmdstat_get:calls=100743045\r\ncmdstat_del:calls=345446900\r\ncmdstat_info:calls=288366\r\ncmdstat_eval:calls=49576278\r\ncmdstat_ping:calls=17520\r\ncmdstat_client|setname:calls=1\r\ncmdstat_client|setinfo:calls=16784\r\ncmdstat_set:calls=399044582\r\n\r\n# Errorstats\r\nerrorstat_CLUSTERDOWN:count=62941\r\nerrorstat_NOAUTH:count=1\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_cluster|nodes:p50=85.503\r\nlatency_percentiles_usec_cluster|myid:p50=1.003\r\nlatency_percentiles_usec_cluster|info:p50=44.031\r\nlatency_percentiles_usec_flushall:p50=129.023\r\nlatency_percentiles_usec_replconf:p50=1.003\r\nlatency_percentiles_usec_acl|log:p50=2.007\r\nlatency_percentiles_usec_psync:p50=154.623\r\nlatency_percentiles_usec_auth:p50=5.023\r\nlatency_percentiles_usec_get:p50=1.003\r\nlatency_percentiles_usec_del:p50=2.007\r\nlatency_percentiles_usec_info:p50=66.047\r\nlatency_percentiles_usec_eval:p50=17.023\r\nlatency_percentiles_usec_ping:p50=1.003\r\nlatency_percentiles_usec_client|setname:p50=1.003\r\nlatency_percentiles_usec_client|setinfo:p50=0.001\r\nlatency_percentiles_usec_set:p50=3.007\r\n\r\n# Cluster\r\ncluster_enabled:1\r\n\r\n# Keyspace\r\ndb0:keys=4565998\r\n\r\n# Cluster info\r\ncluster_state:ok\r\ncluster_slots_assigned:16384\r\ncluster_slots_ok:16384\r\ncluster_slots_pfail:0\r\ncluster_slots_fail:0\r\ncluster_known_nodes:10\r\ncluster_size:5\r\ncluster_current_epoch:15\r\ncluster_my_epoch:12\r\ncluster_stats_messages_ping_sent:260374\r\ncluster_stats_messages_pong_sent:262119\r\ncluster_stats_messages_sent:522493\r\ncluster_stats_messages_ping_received:262119\r\ncluster_stats_messages_pong_received:260371\r\ncluster_stats_messages_received:522490\r\ntotal_cluster_links_buffer_limit_exceeded:0\r\n\r\n------ CLUSTER NODES OUTPUT ------\r\n924b5315fffce5fef2eb142aaee9bf2a37247a49 10.254.81.202:6379@16379\r\nbf5aed5fda50a30adcfa28af0a62d9324373d910 10.254.129.26:6379@16379\r\n79154a744f909715b53750f85393316ef95600e6 10.254.62.160:6379@16379\r\n8c562cb3b58590f80f7fc815ca641f01efc95343 10.254.234.190:6379@16379\r\n82ec0f12c13dff2acd7a06f58a33e821a2f21058 10.254.236.131:6379@16379\r\n46b08557bf546459dc6af6142b1e93053f6b18b8 10.254.73.152:6379@16379\r\n83e52f45a4c028d79113d99a41ee7c4f3fa93193 10.254.93.94:6379@16379\r\nf14048d196680240a95a60bff432f7fd768372c5 10.254.94.191:6379@16379\r\naba3ba132dbce6664b5ac441fb84a17d96ab2e0a 10.254.167.66:6379@16379\r\n6dede0e20ef9888646b061dc8152a7a514b26695 10.254.119.215:6379@16379\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=22 addr=172.16.18.230:35828 laddr=172.16.58.190:6379 fd=42 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=24467 argv-mem=0 multi-mem=0 rbs=1024 rbp=24 obl=0 oll=0 omem=0 tot-mem=26496 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=34 addr=172.16.45.145:60170 laddr=172.16.58.190:6379 fd=58 name= age=87631 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=20 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=42 addr=172.16.40.181:51794 laddr=172.16.58.190:6379 fd=66 name= age=87629 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=28 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=35 addr=172.16.30.159:58422 laddr=172.16.58.190:6379 fd=59 name= age=87631 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=24 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=9 addr=172.16.217.211:54430 laddr=172.16.58.190:6379 fd=22 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=25 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=10 addr=172.16.225.199:38944 laddr=172.16.58.190:6379 fd=23 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=35 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=29 addr=172.16.127.143:48266 laddr=172.16.58.190:6379 fd=51 name= age=87632 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=25 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=11 addr=172.16.21.180:35294 laddr=172.16.58.190:6379 fd=24 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=35 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=43 addr=172.16.30.230:39066 laddr=172.16.58.190:6379 fd=67 name= age=87629 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=33 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=37 addr=172.16.96.22:57554 laddr=172.16.58.190:6379 fd=61 name= age=87630 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=17 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=12 addr=172.16.41.143:56576 laddr=172.16.58.190:6379 fd=25 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=28 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=13 addr=172.16.144.7:35578 laddr=172.16.58.190:6379 fd=26 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=32 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=38 addr=172.16.127.55:52790 laddr=172.16.58.190:6379 fd=62 name= age=87630 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=16 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=23 addr=[::1]:47436 laddr=[::1]:6379 fd=43 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=8192 rbp=5890 obl=0 oll=0 omem=0 tot-mem=29568 events=r cmd=info user=probe-user redir=-1 resp=2 lib-name=redis-py lib-ver=5.0.1\r\nid=44 addr=172.16.220.31:41144 laddr=172.16.58.190:6379 fd=68 name= age=87629 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=25 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=14 addr=172.16.31.11:38200 laddr=172.16.58.190:6379 fd=27 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=28 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=30 addr=172.16.58.159:33026 laddr=172.16.58.190:6379 fd=52 name= age=87632 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=20 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=31 addr=172.16.208.202:56292 laddr=172.16.58.190:6379 fd=53 name= age=87632 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=30 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=32 addr=172.16.58.18:52802 laddr=172.16.58.190:6379 fd=54 name= age=87632 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=31 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=39 addr=172.16.96.107:57360 laddr=172.16.58.190:6379 fd=63 name= age=87630 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=20 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=45 addr=172.16.146.218:35422 laddr=172.16.58.190:6379 fd=69 name= age=87629 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=17896 argv-mem=0 multi-mem=0 rbs=1024 rbp=25 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=25 addr=172.16.190.148:33102 laddr=172.16.58.190:6379 fd=46 name= age=87632 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=27 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=26 addr=172.16.224.43:41718 laddr=172.16.58.190:6379 fd=48 name= age=87632 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=20 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=27 addr=172.16.223.206:58224 laddr=172.16.58.190:6379 fd=49 name= age=87632 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=25 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=21 addr=172.16.233.10:47040 laddr=172.16.58.190:6379 fd=41 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=25 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=36 addr=172.16.119.211:57302 laddr=172.16.58.190:6379 fd=60 name= age=87631 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=20 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=15 addr=172.16.109.32:54390 laddr=172.16.58.190:6379 fd=28 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=30 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=16 addr=172.16.110.35:57838 laddr=172.16.58.190:6379 fd=29 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=28 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=17 addr=172.16.46.62:49770 laddr=172.16.58.190:6379 fd=31 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=27 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=33 addr=172.16.182.227:40814 laddr=172.16.58.190:6379 fd=57 name= age=87631 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=33 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=18 addr=172.16.168.239:50376 laddr=172.16.58.190:6379 fd=32 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=25 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=get user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=46 addr=[::1]:47452 laddr=[::1]:6379 fd=70 name=local_monitor age=87629 idle=3 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 multi-mem=0 rbs=8192 rbp=5890 obl=0 oll=0 omem=0 tot-mem=9096 events=r cmd=info user=probe-user redir=-1 resp=2 lib-name=redis-py lib-ver=5.0.1\r\nid=47 addr=172.16.25.251:47928 laddr=172.16.58.190:6379 fd=71 name= age=87629 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=27 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=40 addr=172.16.114.106:51674 laddr=172.16.58.190:6379 fd=64 name= age=87629 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=0 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=28 addr=172.16.126.169:53956 laddr=172.16.58.190:6379 fd=50 name= age=87632 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=30 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=19 addr=172.16.77.53:48352 laddr=172.16.58.190:6379 fd=33 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=21653 argv-mem=0 multi-mem=0 rbs=1024 rbp=30 obl=0 oll=0 omem=0 tot-mem=26496 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=20 addr=172.16.208.154:60348 laddr=172.16.58.190:6379 fd=34 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=32 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=5 addr=172.16.137.6:33944 laddr=172.16.58.190:6379 fd=12 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=25 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=6 addr=172.16.241.138:58536 laddr=172.16.58.190:6379 fd=19 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=25 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=41 addr=172.16.95.192:51902 laddr=172.16.58.190:6379 fd=65 name= age=87629 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=0 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=set user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=24 addr=172.16.109.5:52888 laddr=172.16.58.190:6379 fd=45 name= age=87633 idle=0 flags=S db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=0 obl=0 oll=1 omem=20504 tot-mem=42904 events=r cmd=replconf user=repl-user redir=-1 resp=2 lib-name= lib-ver=\r\nid=7 addr=172.16.142.207:33080 laddr=172.16.58.190:6379 fd=20 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=30 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\nid=8 addr=172.16.198.104:45568 laddr=172.16.58.190:6379 fd=21 name= age=87633 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 rbs=1024 rbp=26 obl=0 oll=0 omem=0 tot-mem=22400 events=r cmd=del user=default redir=-1 resp=2 lib-name= lib-ver=\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nactivedefrag yes\r\nlazyfree-lazy-user-flush no\r\nrepl-diskless-sync yes\r\nsanitize-dump-payload no\r\nlazyfree-lazy-server-del no\r\nproto-max-bulk-len 512mb\r\nslave-read-only yes\r\nlazyfree-lazy-eviction no\r\nclient-query-buffer-limit 1gb\r\nreplica-read-only yes\r\nlazyfree-lazy-user-del no\r\nio-threads-do-reads no\r\nlazyfree-lazy-expire no\r\nlist-compress-depth 0\r\nrepl-diskless-load disabled\r\nio-threads 1\r\n\r\n------ FAST MEMORY TEST ------\r\n9:M 12 Apr 2024 03:02:56.003 # Bio worker thread #0 terminated\r\n9:M 12 Apr 2024 03:02:56.003 # Bio worker thread #1 terminated\r\n9:M 12 Apr 2024 03:02:56.004 # Bio worker thread #2 terminated\r\n*** Preparing to test memory region 8eb000 (2273280 bytes)\r\n*** Preparing to test memory region 184c000 (2740224 bytes)\r\n*** Preparing to test memory region 7f12bea00000 (6733955072 bytes)\r\n*** Preparing to test memory region 7f14500dd000 (604504064 bytes)\r\n*** Preparing to test memory region 7f147415e000 (8388608 bytes)\r\n*** Preparing to test memory region 7f147495f000 (8388608 bytes)\r\n*** Preparing to test memory region 7f1475160000 (8388608 bytes)\r\n*** Preparing to test memory region 7f1475961000 (8388608 bytes)\r\n*** Preparing to test memory region 7f147694c000 (4096 bytes)\r\n*** Preparing to test memory region 7f14789b8000 (4096 bytes)\r\n*** Preparing to test memory region 7f1478e80000 (4096 bytes)\r\n*** Preparing to test memory region 7f147986c000 (4096 bytes)\r\n*** Preparing to test memory region 7f1479f86000 (8192 bytes)\r\n*** Preparing to test memory region 7f147a532000 (12288 bytes)\r\n*** Preparing to test memory region 7f147b2a0000 (16384 bytes)\r\n*** Preparing to test memory region 7f147b8d2000 (1048576 bytes)\r\n*** Preparing to test memory region 7f147c41f000 (1048576 bytes)\r\n*** Preparing to test memory region 7f147c93e000 (1048576 bytes)\r\n*** Preparing to test memory region 7f147d084000 (1048576 bytes)\r\n*** Preparing to test memory region 7f147db2d000 (270336 bytes)\r\n*** Preparing to test memory region 7f147dd80000 (11010048 bytes)\r\n*** Preparing to test memory region 7f147eaf0000 (4096 bytes)\r\n*** Preparing to test memory region 7f147eeb2000 (16384 bytes)\r\n*** Preparing to test memory region 7f147f0d2000 (16384 bytes)\r\n*** Preparing to test memory region 7f147f5bc000 (20480 bytes)\r\n*** Preparing to test memory region 7f147f854000 (4096 bytes)\r\n*** Preparing to test memory region 7f148001b000 (1675264 bytes)\r\n*** Preparing to test memory region 7f1480207000 (24576 bytes)\r\n*** Preparing to test memory region 7f148020f000 (8192 bytes)\r\n{\r\n{\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: slotToKeyReplaceEntry (base: 0x4d0a00)\r\nModule: /usr/bin/redis-server *:6379 [cluster] (base 0x400000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x4d0a00 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n9:M 12 Apr 2024 03:03:19.535 # dump of function (hexdump of 293 bytes):\r\n55534883ec0840f6c6077564488b56204889fd4889f3488b46184885d27409f6c207754c488972184885c07413a807753f488958204883c4085b5dc30f1f40004889dfe8380009000fb670ff89f283e20780fa040f879b0000000fb6d2ff24d56807630066662e0f1f84000000000090ba19030000be37b76400bf10df6000e85c27010066662e0f1f840000000000908b70f74889c7e835e30000488b553889c048c1e00448034250488958084883c4085b5dc366662e0f1f840000000000900fb770fbebcd662e0f1f8400000000000fb670fdebbd662e0f1f84000000000040c0ee03400fb6f6eba9660f1f4400008b70efeb9e31f6eb9a0f1f8000000000554889f5534889fb4883ec08e86fff08000fb670ff4889c789f283e20780fa040f87e20000\r\nFunction at 0x560a80 is dictGetKey\r\nFunction at 0x4e31e0 is _serverAssert\r\nFunction at 0x4dedd0 is keyHashSlot\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n```",
  "state": "closed",
  "created_at": "2024-04-12T09:41:10Z",
  "updated_at": "2024-06-21T12:05:41Z",
  "closed_at": "2024-06-21T12:05:41Z",
  "labels": [
    "crash report"
  ],
  "comments_data": [
    {
      "id": 2054313281,
      "user": "sundb",
      "created_at": "2024-04-15T01:58:49Z",
      "body": "crash in `&(*db->slots_to_keys).by_slot`.\r\n\r\nassemble\r\n```asm\r\n   0x0000000000144b13 <+147>:   call   0x134c60 <keyHashSlot>\r\n   0x0000000000144b18 <+152>:   mov    0x38(%rbp),%rdx\r\n   0x0000000000144b1c <+156>:   mov    %eax,%eax\r\n   0x0000000000144b1e <+158>:   shl    $0x4,%rax\r\n   0x0000000000144b22 <+162>:   add    0x50(%rdx),%rax          <- crash here\r\n```\r\n\r\n```c\r\n        unsigned int hashslot = keyHashSlot(key, sdslen(key));\r\n        clusterDictMetadata *dictmeta = dictMetadata(d);\r\n        redisDb *db = dictmeta->db;\r\n        slotToKeys *slot_to_keys = &(*db->slots_to_keys).by_slot[hashslot];\r\n```"
    },
    {
      "id": 2054406144,
      "user": "SarthakSahu",
      "created_at": "2024-04-15T02:23:31Z",
      "body": "Thank you @sundb.\r\nBut why does it crashed. It is a bug here ?"
    },
    {
      "id": 2054417183,
      "user": "sundb",
      "created_at": "2024-04-15T02:25:53Z",
      "body": "@SarthakSahu yes, but i don't know why yet, it still need some time."
    },
    {
      "id": 2058286769,
      "user": "SarthakSahu",
      "created_at": "2024-04-16T05:57:20Z",
      "body": "Hi @sundb \r\n\r\nAny break through here? Our cluster has been crashed again with same stacks trace."
    },
    {
      "id": 2058312672,
      "user": "sundb",
      "created_at": "2024-04-16T06:18:30Z",
      "body": "@SarthakSahu sorry, since i haven't had enought time to dig into it right now, could you provide more information so I can pinpoint it quickly? Or can you reproduce it quickly?"
    },
    {
      "id": 2061234089,
      "user": "stevelipinski",
      "created_at": "2024-04-17T13:13:33Z",
      "body": "Same as https://github.com/redis/redis/issues/12677?"
    },
    {
      "id": 2061249872,
      "user": "sundb",
      "created_at": "2024-04-17T13:21:36Z",
      "body": "@stevelipinski Yes, they are same.\r\ndid you enable `activedefrag`?"
    },
    {
      "id": 2061290515,
      "user": "stevelipinski",
      "created_at": "2024-04-17T13:40:52Z",
      "body": "Yes:\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nactivedefrag yes\r\n\r\nI believe one minor difference is that in this case, activedefrag is set from the beginning, whereas in #12677, they mention setting it on a replica.  "
    },
    {
      "id": 2061298901,
      "user": "sundb",
      "created_at": "2024-04-17T13:44:42Z",
      "body": "@stevelipinski thanks a lot, this is usefull, and I will take the time to figue out why as soon as possible."
    },
    {
      "id": 2071481650,
      "user": "SarthakSahu",
      "created_at": "2024-04-23T06:10:29Z",
      "body": "Hi @sundb, Do we have any intermediate update to share."
    },
    {
      "id": 2071496938,
      "user": "sundb",
      "created_at": "2024-04-23T06:24:03Z",
      "body": "@SarthakSahu sorry, I've tried and failed to reproduce it, can you give me more clues about your system, special configurations, etc.\r\n"
    },
    {
      "id": 2075940273,
      "user": "kkharbas",
      "created_at": "2024-04-24T22:12:34Z",
      "body": "@SarthakSahu disable activedefrag until bug is fixed"
    },
    {
      "id": 2076935934,
      "user": "SarthakSahu",
      "created_at": "2024-04-25T11:11:06Z",
      "body": "> @SarthakSahu sorry, I've tried and failed to reproduce it, can you give me more clues about your system, special configurations, etc.\r\n\r\nAFAIK, Frequently short leaved data has been injected. This mean frequently data is keep injected and deleted."
    },
    {
      "id": 2076942561,
      "user": "sundb",
      "created_at": "2024-04-25T11:15:07Z",
      "body": "@SarthakSahu did you do anything special operations with the cluster? like slot migration?"
    },
    {
      "id": 2136022157,
      "user": "stevelipinski",
      "created_at": "2024-05-28T20:08:24Z",
      "body": "I've been trying to reproduce as well.  The closest I can achieve is with a script that creates a bunch of strings, some of them having a ttl.  Then by disabling and then re-enabling activedefrag, it crashes.  But, it is crashing at a different point in the code:\r\n\r\n\r\n\r\n```\r\n11360:M 28 May 2024 16:01:13.400 # Redis 7.2.3 crashed by signal: 11, si_code: 1\r\n11360:M 28 May 2024 16:01:13.400 # Accessing address: 0x48\r\n11360:M 28 May 2024 16:01:13.400 # Crashed running the instruction at: 0x48aa1c\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\nredis-server *:63791 [cluster](defragLaterStep+0x4c)[0x48aa1c]\r\n\r\nBacktrace:\r\n/lib64/libpthread.so.0(+0x12cf0)[0x7fe1d1570cf0]\r\nredis-server *:63791 [cluster](defragLaterStep+0x4c)[0x48aa1c]\r\nredis-server *:63791 [cluster](activeDefragCycle+0x3b4)[0x48b154]\r\nredis-server *:63791 [cluster](databasesCron+0x6c)[0x5668fc]\r\nredis-server *:63791 [cluster](serverCron+0x64a)[0x5691ea]\r\nredis-server *:63791 [cluster][0x56249d]\r\nredis-server *:63791 [cluster](aeMain+0x1d8)[0x563c68]\r\nredis-server *:63791 [cluster](main+0x39a)[0x450d4a]\r\n/lib64/libc.so.6(__libc_start_main+0xe5)[0x7fe1d11d3d85]\r\nredis-server *:63791 [cluster](_start+0x2e)[0x45147e]\r\n\r\n------ REGISTERS ------\r\n11360:M 28 May 2024 16:01:13.401 #\r\nRAX:0000000000000000 RBX:0000000000000000\r\nRCX:0000000000000000 RDX:0000000000000000\r\nRDI:0000000000000000 RSI:0000000000000000\r\nRBP:0000000000000000 RSP:00007ffc11d3acc0\r\nR8 :0000000000481278 R9 :00007ffc11d78080\r\nR10:00007ffc11d3ad40 R11:0000000000000003\r\nR12:0000000000000119 R13:00061989188d756f\r\nR14:0000000000000000 R15:0000000000000000\r\nRIP:000000000048aa1c EFL:0000000000010246\r\nCSGSFS:002b000000000033\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3accf) -> 0000000000000000\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3acce) -> 00061989188d756f\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3accd) -> 0000000000000000\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3accc) -> 0000000000000014\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3accb) -> 0000000000061cf3\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3acca) -> 0000000066563809\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3acc9) -> 0000000000481e0f\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3acc8) -> 0000000000000119\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3acc7) -> 0000000000000000\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3acc6) -> 00000005d9513e3c\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3acc5) -> 0000000000051650\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3acc4) -> 00000005d9513e3c\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3acc3) -> 0000000000480a20\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3acc2) -> 0000000000480930\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3acc1) -> 0000000000000001\r\n11360:M 28 May 2024 16:01:13.401 # (00007ffc11d3acc0) -> 0000000000000000\r\n....\r\n\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: defragLaterStep (base: 0x48a9d0)\r\nModule: redis-server *:63791 [cluster] (base 0x400000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x48a9d0 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n11360:M 28 May 2024 16:01:13.534 # dump of function (hexdump of 204 bytes):\r\n41574531ff41564989fe41554989f5415455534883ec68488b2d32734600f30f7e0dd27b19004c8b2543734600488b15244c46000f160d257b19000f294c2410488b35194c46004885d2755a498b7e48488b074885f6742f483970100f85510300004889c6e886870d00498b464848c705df4b46000000000048c705dc4b460000000000488b004885c00f841c03000048c705bd4b460000000000488b7010488935ba4b4600498b3ee802d00d004889c3488b05987246004889442420e9b500000066662e0f1f8400000000\r\nFunction at 0x5631c0 is listDelNode\r\nFunction at 0x567a80 is dictFind\r\n```"
    },
    {
      "id": 2136024931,
      "user": "stevelipinski",
      "created_at": "2024-05-28T20:10:21Z",
      "body": "Common thread I see here in these crashes, between 13205 and 12677 is the backtrace:\r\n activeDefragCycle, ..., libpthread.so.0\r\n\r\nMakes me wonder if there is some race condition occurring between threads when active defrag is running..."
    },
    {
      "id": 2136252031,
      "user": "sundb",
      "created_at": "2024-05-28T23:14:02Z",
      "body": "@stevelipinski thanks, it will be fixed in next release."
    },
    {
      "id": 2136367500,
      "user": "stevelipinski",
      "created_at": "2024-05-29T01:45:40Z",
      "body": "@sundb - Did you find the root cause?  Because we are investigating, and if you already know what needs fixed, we will not spend more time on it. Thanks!"
    },
    {
      "id": 2136468751,
      "user": "sundb",
      "created_at": "2024-05-29T03:59:25Z",
      "body": "@stevelipinski sorry for late, the reason of crash is that we forgot to call `slotToKeyInit()` when emptying the database async. \r\nthe defragment triggers the bug.\r\nthis is the patch: https://github.com/sundb/redis/commit/eb4a9275f471e00b8f5f74b28eec7a28985212ae"
    },
    {
      "id": 2137591500,
      "user": "stevelipinski",
      "created_at": "2024-05-29T14:42:49Z",
      "body": "@sundb - thanks for sharing the patch.  I also think that my above-mentioned crash was because of disabling activedefrag while it was actively running, which caused the old cursor to allow access to an out-of-range db: stevelipinski@ecb7cd8"
    },
    {
      "id": 2137640611,
      "user": "sundb",
      "created_at": "2024-05-29T15:03:58Z",
      "body": "@stevelipinski  defragment is just one way to trigger the crash, any code touching `dictMetadata(db->dict)->db` may trigger crash.\r\nbtw, did you use `flushdb async` or enable `lazyfree-lazy-user-flush` config?"
    },
    {
      "id": 2137733671,
      "user": "stevelipinski",
      "created_at": "2024-05-29T15:46:40Z",
      "body": "No - I did not use `flushdb` nor `lazyfree-lazy-user-flush`.  I did set `activedefrag=yes` with some low thresholds.\r\nAll I did was run a script that set a bunch of keys (like 100,000), some of which have a short TTL (1-10s).\r\nI then did `CONFIG SET activedefrag no`; `CONFIG SET activedefrag yes` - and it would crash.\r\n\r\nIt looked like a different crash/backtrace than was being discussed in this orig issue.  See above.\r\nReproduced with gdb and checked that in `activeDefragCycle()`, line 1014, `if (defragLaterStep(db, endtime))` was being called with db=NULL.\r\nThat could occur if the disabled mid-run block was hit (934-948), which could leave expires_cursor set to non-zero.\r\nThen when re-enabled, expires_cursor >0 caused the first do{}while to be skipped and into the second.  With db=NULL"
    },
    {
      "id": 2137754759,
      "user": "sundb",
      "created_at": "2024-05-29T15:56:39Z",
      "body": "@stevelipinski i saw `cmdstat_flushall:calls=1` in your crash log.\r\nmaybe you can apply my patch first to see if it crashes?\r\n\r\n> Makes me wonder if there is some race condition occurring between threads when active defrag is running...\r\n\r\n`active defrag` is running in the main thread."
    },
    {
      "id": 2138045932,
      "user": "stevelipinski",
      "created_at": "2024-05-29T18:43:28Z",
      "body": "Nope - even with your fix:\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n19766:M 29 May 2024 14:29:44.134 # Redis 7.2.3 crashed by signal: 11, si_code: 1\r\n19766:M 29 May 2024 14:29:44.134 # Accessing address: 0x48\r\n19766:M 29 May 2024 14:29:44.134 # Crashed running the instruction at: 0x48a9bc\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\nredis-server *:63791 [cluster](defragLaterStep+0x4c)[0x48a9bc]\r\n\r\nBacktrace:\r\n/lib64/libpthread.so.0(+0x12cf0)[0x7f11c991fcf0]\r\nredis-server *:63791 [cluster](defragLaterStep+0x4c)[0x48a9bc]\r\nredis-server *:63791 [cluster](activeDefragCycle+0x3b4)[0x48b0f4]\r\nredis-server *:63791 [cluster](databasesCron+0x6c)[0x5668ec]\r\nredis-server *:63791 [cluster](serverCron+0x64a)[0x5691da]\r\nredis-server *:63791 [cluster][0x56248d]\r\nredis-server *:63791 [cluster](aeMain+0x1d8)[0x563c58]\r\nredis-server *:63791 [cluster](main+0x39a)[0x450d4a]\r\n/lib64/libc.so.6(__libc_start_main+0xe5)[0x7f11c9582d85]\r\nredis-server *:63791 [cluster](_start+0x2e)[0x45147e]\r\n\r\n------ REGISTERS ------\r\n19766:M 29 May 2024 14:29:44.135 #\r\nRAX:0000000000000000 RBX:0000000000000000\r\nRCX:0000000000000000 RDX:0000000000000000\r\nRDI:0000000000000000 RSI:0000000000000000\r\nRBP:0000000000000000 RSP:00007ffe5c2adab0\r\nR8 :000000000036c9c2 R9 :00007ffe5c34a080\r\nR10:00007ffe5c2adb30 R11:0000000000000002\r\nR12:00000000000002c0 R13:0006199bef354748\r\nR14:0000000000000000 R15:0000000000000000\r\nRIP:000000000048a9bc EFL:0000000000010246\r\nCSGSFS:002b000000000033\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adabf) -> 0000000000000000\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adabe) -> 0006199bef354748\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adabd) -> 0000000000000000\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adabc) -> 0000000000000014\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adabb) -> 0000000000020d20\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adaba) -> 0000000066577418\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adab9) -> 0000000000481daf\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adab8) -> 00000000000002c0\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adab7) -> 0000000000000000\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adab6) -> 000000050a98c3d4\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adab5) -> 0000000000054e20\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adab4) -> 000000050a98c3d4\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adab3) -> 00000000004809c0\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adab2) -> 00000000004808d0\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adab1) -> 0000000000000001\r\n19766:M 29 May 2024 14:29:44.135 # (00007ffe5c2adab0) -> 0000000000000000\r\n...\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: defragLaterStep (base: 0x48a970)\r\nModule: redis-server *:63791 [cluster] (base 0x400000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x48a970 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n19766:M 29 May 2024 14:29:44.272 # dump of function (hexdump of 204 bytes):\r\n41574531ff41564989fe41554989f5415455534883ec68488b2d92734600f30f7e0d127c19004c8b25a3734600488b15844c46000f160d657b19000f294c2410488b35794c46004885d2755a498b7e48488b074885f6742f483970100f85510300004889c6e8d6870d00498b464848c7053f4c46000000000048c7053c4c460000000000488b004885c00f841c03000048c7051d4c460000000000488b70104889351a4c4600498b3ee852d00d004889c3488b05f87246004889442420e9b500000066662e0f1f8400000000\r\nFunction at 0x5631b0 is listDelNode\r\nFunction at 0x567a70 is dictFind\r\n```\r\n\r\nNeeds [my change](https://github.com/stevelipinski/redis/commit/ecb7cd8) to reset expires_cursor in defrag.c to avoid this crash\r\nShould I open a new issue for this?\r\n\r\n"
    },
    {
      "id": 2138048229,
      "user": "stevelipinski",
      "created_at": "2024-05-29T18:44:47Z",
      "body": "@sundb - Given your change to add `slotToKeyInit()`, how can I reproduce this issue?  I stumbled on the other crash in attempt to reproduce this one, but I am still unable.  It would be nice to be able to reproduce this issue and verify the fix resolves it."
    },
    {
      "id": 2138510790,
      "user": "sundb",
      "created_at": "2024-05-30T01:32:09Z",
      "body": "@stevelipinski thanks, they do seem to two issue, welcome to create a PR to fix it.\r\n\r\n> @sundb - Given your change to add `slotToKeyInit()`, how can I reproduce this issue? I stumbled on the other crash while attempting to reproduce this one, but I am still unable to. It would be nice to be able to reproduce this issue and verify the fix resolves it.\r\n\r\nyou can reproduce it by using `flushdb async` command, it's a high probability that the crash will be triggered when you use in cluster mode."
    },
    {
      "id": 2138811974,
      "user": "sundb",
      "created_at": "2024-05-30T06:57:06Z",
      "body": "@stevelipinski i've reproduced it locally and manually, and your solution is right.\r\nthe root cause is the disable of `activedefrag` config in the mid of defragment, and then enabling `activedefrag` might trigger this crash.\r\ndo you wanna make a PR to fix it?"
    },
    {
      "id": 2182624571,
      "user": "sundb",
      "created_at": "2024-06-21T12:05:41Z",
      "body": "Fixed via #13315"
    }
  ]
}