{
  "issue_number": 10508.0,
  "title": "[CRASH] Replication crashes on EVAL when replica-serve-stale-data=no (introduced in Redis 7)",
  "body": "- Issue first introduced with https://github.com/redis/redis/pull/10126\r\n- Removing CMD_STALE from EVAL doesn't allow crash to happen\r\n\r\n**Crash report**\r\n\r\n```\r\n70824:S 02 Apr 2022 00:24:52.961 * MASTER <-> REPLICA sync started\r\n70824:S 02 Apr 2022 00:24:52.961 # Error condition on socket for SYNC: Connection refused\r\n70824:S 02 Apr 2022 00:24:53.965 * Connecting to MASTER localhost:6379\r\n70824:S 02 Apr 2022 00:24:53.966 * MASTER <-> REPLICA sync started\r\n70824:S 02 Apr 2022 00:24:53.966 # Error condition on socket for SYNC: Connection refused\r\n70824:S 02 Apr 2022 00:24:54.969 * Connecting to MASTER localhost:6379\r\n70824:S 02 Apr 2022 00:24:54.969 * MASTER <-> REPLICA sync started\r\n70824:S 02 Apr 2022 00:24:54.969 * Non blocking connect for SYNC fired the event.\r\n70824:S 02 Apr 2022 00:24:54.998 # Error reply to PING from master: '-LOADING Redis is loading the dataset in memory'\r\n70824:S 02 Apr 2022 00:24:55.972 * Connecting to MASTER localhost:6379\r\n70824:S 02 Apr 2022 00:24:55.972 * MASTER <-> REPLICA sync started\r\n70824:S 02 Apr 2022 00:24:55.972 * Non blocking connect for SYNC fired the event.\r\n70824:S 02 Apr 2022 00:24:56.003 # Error reply to PING from master: '-LOADING Redis is loading the dataset in memory'\r\n70824:S 02 Apr 2022 00:24:56.975 * Connecting to MASTER localhost:6379\r\n70824:S 02 Apr 2022 00:24:56.975 * MASTER <-> REPLICA sync started\r\n70824:S 02 Apr 2022 00:24:56.975 * Non blocking connect for SYNC fired the event.\r\n70824:S 02 Apr 2022 00:24:56.998 # Error reply to PING from master: '-LOADING Redis is loading the dataset in memory'\r\n70824:S 02 Apr 2022 00:24:57.978 * Connecting to MASTER localhost:6379\r\n70824:S 02 Apr 2022 00:24:57.978 * MASTER <-> REPLICA sync started\r\n70824:S 02 Apr 2022 00:24:57.978 * Non blocking connect for SYNC fired the event.\r\n70824:S 02 Apr 2022 00:24:58.005 # Error reply to PING from master: '-LOADING Redis is loading the dataset in memory'\r\n70824:S 02 Apr 2022 00:24:58.981 * Connecting to MASTER localhost:6379\r\n70824:S 02 Apr 2022 00:24:58.981 * MASTER <-> REPLICA sync started\r\n70824:S 02 Apr 2022 00:24:58.981 * Non blocking connect for SYNC fired the event.\r\n70824:S 02 Apr 2022 00:24:58.983 # Error reply to PING from master: '-LOADING Redis is loading the dataset in memory'\r\n70824:S 02 Apr 2022 00:24:59.985 * Connecting to MASTER localhost:6379\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n70824:S 02 Apr 2022 00:24:59.985 # Redis 255.255.255 crashed by signal: 11, si_code: 128\r\n70824:S 02 Apr 2022 00:24:59.985 # Accessing address: (nil)\r\n70824:S 02 Apr 2022 00:24:59.985 # Crashed running the instruction at: 0x7f5988415c84\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x109c84)[0x7f5988415c84]\r\n\r\nBacktrace:\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x42520)[0x7f598834e520]\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x109c84)[0x7f5988415c84]\r\n/lib/x86_64-linux-gnu/libc.so.6(getaddrinfo+0x129)[0x7f5988417779]\r\n./redis-server 127.0.0.1:6378(+0x700ee)[0x5626c2aa10ee]\r\n./redis-server 127.0.0.1:6378(+0x147087)[0x5626c2b78087]\r\n./redis-server 127.0.0.1:6378(connectWithMaster+0x42)[0x5626c2ad6da2]\r\n./redis-server 127.0.0.1:6378(replicationCron+0x367)[0x5626c2adb487]\r\n./redis-server 127.0.0.1:6378(serverCron+0x2d8)[0x5626c2aaae98]\r\n./redis-server 127.0.0.1:6378(aeProcessEvents+0x2f1)[0x5626c2aa0801]\r\n./redis-server 127.0.0.1:6378(aeMain+0x1d)[0x5626c2aa0abd]\r\n./redis-server 127.0.0.1:6378(main+0x308)[0x5626c2a9c268]\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x29fd0)[0x7f5988335fd0]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0x7d)[0x7f598833607d]\r\n./redis-server 127.0.0.1:6378(_start+0x25)[0x5626c2a9c765]\r\n\r\n------ REGISTERS ------\r\n70824:S 02 Apr 2022 00:24:59.988 # \r\nRAX:f9dba8288a9ee8dc RBX:00007ffee90290a0\r\nRCX:0000000000000400 RDX:00007ffee90290b0\r\nRDI:00007f5987e9a0d1 RSI:00007ffee9028da0\r\nRBP:00007ffee9028f20 RSP:00007ffee9028ca0\r\nR8 :00007f59883086a8 R9 :00007f598830870c\r\nR10:0000000000000000 R11:0000000000000000\r\nR12:ffffffffffffe74c R13:0000000000000000\r\nR14:00007ffee9029530 R15:0000000000000000\r\nRIP:00007f5988415c84 EFL:0000000000010212\r\nCSGSFS:002b000000000033\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028caf) -> 00007f5900000000\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028cae) -> 00007ffee9028fa8\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028cad) -> 0000000000000000\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028cac) -> 0000000000000000\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028cab) -> 0000000000000000\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028caa) -> 00007ffe0000eb18\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028ca9) -> 0000000600000001\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028ca8) -> 0000000000000000\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028ca7) -> 0000000000000000\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028ca6) -> 0000000000000000\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028ca5) -> 0000000000000008\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028ca4) -> 00007ffe00000000\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028ca3) -> 00007f59885226c0\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028ca2) -> 0000000000000000\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028ca1) -> 00007f5988415c49\r\n70824:S 02 Apr 2022 00:24:59.988 # (00007ffee9028ca0) -> 0000000000000000\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:255.255.255\r\nredis_git_sha1:b8eb2a73\r\nredis_git_dirty:1\r\nredis_build_id:14c87aa0476c61e5\r\nredis_mode:standalone\r\nos:Linux 5.13.0-35-generic x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:11.2.0\r\nprocess_id:70824\r\nprocess_supervised:no\r\nrun_id:b7e83585082a581b39ac8c945baed84e7562c21d\r\ntcp_port:6378\r\nserver_time_usec:1648851899985449\r\nuptime_in_seconds:132\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:4684731\r\nexecutable:/home/eduardo/repos/redis/src/./redis-server\r\nconfig_file:/home/eduardo/repos/redis/redis.conf\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:0\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:0\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:927190800\r\nused_memory_human:884.24M\r\nused_memory_rss:945872896\r\nused_memory_rss_human:902.05M\r\nused_memory_peak:927227152\r\nused_memory_peak_human:884.27M\r\nused_memory_peak_perc:100.00%\r\nused_memory_overhead:535098844\r\nused_memory_startup:858392\r\nused_memory_dataset:392091956\r\nused_memory_dataset_perc:42.33%\r\nallocator_allocated:927299800\r\nallocator_active:927592448\r\nallocator_resident:943992832\r\ntotal_system_memory:16619466752\r\ntotal_system_memory_human:15.48G\r\nused_memory_lua:32768\r\nused_memory_vm_eval:32768\r\nused_memory_lua_human:32.00K\r\nused_memory_scripts_eval:144\r\nnumber_of_cached_scripts:1\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:37888\r\nused_memory_vm_total:70656\r\nused_memory_vm_total_human:69.00K\r\nused_memory_functions:184\r\nused_memory_scripts:328\r\nused_memory_scripts_human:328B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.00\r\nallocator_frag_bytes:292648\r\nallocator_rss_ratio:1.02\r\nallocator_rss_bytes:16400384\r\nrss_overhead_ratio:1.00\r\nrss_overhead_bytes:1880064\r\nmem_fragmentation_ratio:1.02\r\nmem_fragmentation_bytes:18684064\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:20508\r\nmem_total_replication_buffers:20504\r\nmem_clients_slaves:0\r\nmem_clients_normal:1816\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.2.1\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1648851767\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:10000001\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:121\r\ntotal_commands_processed:114\r\ninstantaneous_ops_per_sec:1\r\ntotal_net_input_bytes:535562547\r\ntotal_net_output_bytes:7751\r\ninstantaneous_input_kbps:0.06\r\ninstantaneous_output_kbps:0.10\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:71\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:251\r\ntotal_writes_processed:172\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:2\r\nreply_buffer_expands:0\r\n\r\n# Replication\r\nrole:slave\r\nmaster_host:localhost\r\nmaster_port:6379\r\nmaster_link_status:down\r\nmaster_last_io_seconds_ago:-1\r\nmaster_sync_in_progress:0\r\nslave_read_repl_offset:70\r\nslave_repl_offset:70\r\nmaster_link_down_since_seconds:19\r\nslave_priority:100\r\nslave_read_only:1\r\nreplica_announced:1\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:d27a75a2f2955ee5070bfa45f1a1a659562d71ab\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:70\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:1\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:1\r\nrepl_backlog_histlen:70\r\n\r\n# CPU\r\nused_cpu_sys:2.102113\r\nused_cpu_user:26.324652\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:2.029005\r\nused_cpu_user_main_thread:26.320263\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_eval:calls=106,usec=2188,usec_per_call=20.64,rejected_calls=15,failed_calls=56\r\ncmdstat_ping:calls=8,usec=3,usec_per_call=0.38,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\nerrorstat_LOADING:count=15\r\nerrorstat_MASTERDOWN:count=56\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_eval:p50=18.047,p99=59.135,p99.9=108.031\r\nlatency_percentiles_usec_ping:p50=0.001,p99=1.003,p99.9=1.003\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=10000001,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nlist-compress-depth 0\r\nrepl-diskless-load disabled\r\nproto-max-bulk-len 512mb\r\nlazyfree-lazy-server-del no\r\nclient-query-buffer-limit 1gb\r\nactivedefrag no\r\nsanitize-dump-payload no\r\nlazyfree-lazy-user-flush no\r\nlazyfree-lazy-expire no\r\nrepl-diskless-sync yes\r\nlazyfree-lazy-user-del no\r\nslave-read-only yes\r\nio-threads-do-reads no\r\nio-threads 1\r\nreplica-read-only yes\r\nlazyfree-lazy-eviction no\r\n\r\n------ FAST MEMORY TEST ------\r\n70824:S 02 Apr 2022 00:24:59.990 # Bio thread for job type #0 terminated\r\n70824:S 02 Apr 2022 00:24:59.990 # Bio thread for job type #1 terminated\r\n70824:S 02 Apr 2022 00:24:59.991 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 5626c2d06000 (2297856 bytes)\r\n*** Preparing to test memory region 5626c3718000 (135168 bytes)\r\n*** Preparing to test memory region 7f5940000000 (135168 bytes)\r\n*** Preparing to test memory region 7f5946600000 (8388608 bytes)\r\n*** Preparing to test memory region 7f5946e00000 (262144000 bytes)\r\n*** Preparing to test memory region 7f5956900000 (783286272 bytes)\r\n*** Preparing to test memory region 7f598548c000 (8388608 bytes)\r\n*** Preparing to test memory region 7f5985c8d000 (8388608 bytes)\r\n*** Preparing to test memory region 7f598648e000 (8388608 bytes)\r\n*** Preparing to test memory region 7f5986c8f000 (8388608 bytes)\r\n*** Preparing to test memory region 7f5987a00000 (8388608 bytes)\r\n*** Preparing to test memory region 7f5988308000 (16384 bytes)\r\n*** Preparing to test memory region 7f5988527000 (53248 bytes)\r\n*** Preparing to test memory region 7f5988618000 (8192 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: (null) (base: (nil))\r\nModule: /lib/x86_64-linux-gnu/libc.so.6 (base 0x7f598830c000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=(nil) -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n\r\n=== REDIS BUG REPORT END.\r\n```\r\n\r\nSometimes crash is different:\r\n```\r\n25343:S 02 Apr 2022 13:01:18.234 * Non blocking connect for SYNC fired the event.\r\n25343:S 02 Apr 2022 13:01:18.270 # Error reply to PING from master: '-LOADING Redis is loading the dataset in memory'\r\n25343:S 02 Apr 2022 13:01:19.238 * Connecting to MASTER localhost:6379\r\n25343:S 02 Apr 2022 13:01:19.238 * MASTER <-> REPLICA sync started\r\n25343:S 02 Apr 2022 13:01:19.238 * Non blocking connect for SYNC fired the event.\r\n25343:S 02 Apr 2022 13:01:19.277 # Error reply to PING from master: '-LOADING Redis is loading the dataset in memory'\r\n25343:S 02 Apr 2022 13:01:20.242 * Connecting to MASTER localhost:6379\r\n25343:S 02 Apr 2022 13:01:20.242 * MASTER <-> REPLICA sync started\r\n25343:S 02 Apr 2022 13:01:20.242 * Non blocking connect for SYNC fired the event.\r\n25343:S 02 Apr 2022 13:01:20.242 * Master replied to PING, replication can continue...\r\n25343:S 02 Apr 2022 13:01:20.243 * Trying a partial resynchronization (request 1dafe6a101d709ff596de1f1ac4b8548acc0a337:141).\r\n25343:S 02 Apr 2022 13:01:25.270 * Full resync from master: a577f6677ae5f45c8c97fdcd00a8787148c8648d:14\r\n25343:S 02 Apr 2022 13:01:25.291 * MASTER <-> REPLICA sync: receiving streamed RDB from master with EOF to disk\r\n25343:S 02 Apr 2022 13:01:29.932 * Discarding previously cached master state.\r\n25343:S 02 Apr 2022 13:01:29.932 * MASTER <-> REPLICA sync: Flushing old data\r\n25343:S 02 Apr 2022 13:01:36.091 * MASTER <-> REPLICA sync: Loading DB in memory\r\n25343:S 02 Apr 2022 13:01:36.104 * Loading RDB produced by version 255.255.255\r\n25343:S 02 Apr 2022 13:01:36.104 * RDB age 11 seconds\r\n25343:S 02 Apr 2022 13:01:36.104 * RDB memory usage when created 884.22 Mb\r\n25343:S 02 Apr 2022 13:01:40.597 * Done loading RDB, keys loaded: 10000000, keys expired: 0.\r\n25343:S 02 Apr 2022 13:01:40.597 * MASTER <-> REPLICA sync: Finished with success\r\nrealloc(): invalid next size\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n25343:S 02 Apr 2022 13:01:41.304 # Redis 255.255.255 crashed by signal: 6, si_code: 0\r\n25343:S 02 Apr 2022 13:01:41.304 # Killed by PID: 25343, UID: 1000\r\n25343:S 02 Apr 2022 13:01:41.304 # Crashed running the instruction at: 0x7fafb3821828\r\n\r\n(nothing else)\r\n```\r\n\r\n**Additional information**\r\n\r\nUbuntu 21.10 x86_64\r\nKernel: 5.13.0-35-generic\r\n\r\n2. Steps to reproduce\r\nPreparation:\r\n\r\nUsing latest from unstable (last commit https://github.com/redis/redis/commit/b8eb2a73408fa3b8845760857dd6fcccb62107fe)\r\nRun:\r\nMaster:\r\n`./redis-server ../redis.conf --dir master --appendonly yes`\r\n\r\nReplica:\r\n`./redis-server ../redis.conf --port 6378 --replicaof localhost 6379 --dir replica0`\r\n\r\nredis.conf is standard with the following changes:\r\n```\r\nreplica-serve-stale-data no\r\nenable-debug-command yes\r\nsave \"\"\r\n```\r\n\r\nPopulate master \r\n`./redis-cli -p 6379 DEBUG POPULATE 10000000`\r\n`./redis-cli -p 6379 BGREWRITEAOF`\r\n\r\nKeep running EVAL calls a few times per second (the more frequent, higher the chances of crashing):\r\n`for i in {1..1000}; do ./redis-cli -p 6378 EVAL \"return ARGV[1]\" 0 hello; date; sleep 0.2; done`\r\n\r\n\r\nCausing crash:\r\nBy doing this I get crashes on replica about 1/2 of times if running EVAL 1 per second. And virtually every time if calling 5 times per second:\r\n1. Shutdown master and wait a few seconds\r\n2. Start master again with same command mentioned above\r\n3. Wait for full replication\r\n4. All of this while EVAL commands are being issued",
  "state": "closed",
  "created_at": "2022-04-01T22:39:42Z",
  "updated_at": "2022-04-04T07:58:59Z",
  "closed_at": "2022-04-04T07:58:59Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1086825405,
      "user": "oranagra",
      "created_at": "2022-04-03T09:50:06Z",
      "body": "Thanks for reporting.. so i assume you got to #10126 by trial and error, right?"
    },
    {
      "id": 1086826033,
      "user": "eduardobr",
      "created_at": "2022-04-03T09:54:09Z",
      "body": "@oranagra Yes, bisecting commits"
    }
  ]
}