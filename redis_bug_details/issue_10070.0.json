{
  "issue_number": 10070.0,
  "title": "[CRASH] SIGSEGV in addReplySubcommandSyntaxError at networking.c:966",
  "body": "**Crash report**\r\n```\r\n13664:C 07 Jan 2022 21:21:36.403 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\r\n13664:C 07 Jan 2022 21:21:36.404 # Redis version=255.255.255, bits=64, commit=00000000, modified=0, pid=13664, just started\r\n13664:C 07 Jan 2022 21:21:36.404 # Warning: no config file specified, using the default config. In order to specify a config file use ./redis-server /path/to/redis.conf\r\n13664:M 07 Jan 2022 21:21:36.405 * Increased maximum number of open files to 10032 (it was originally set to 1024).\r\n13664:M 07 Jan 2022 21:21:36.406 * monotonic clock: POSIX clock_gettime\r\n                _._\r\n           _.-``__ ''-._\r\n      _.-``    `.  `_.  ''-._           Redis 255.255.255 (00000000/0) 64 bit\r\n  .-`` .-```.  ```\\/    _.,_ ''-._\r\n (    '      ,       .-`  | `,    )     Running in standalone mode\r\n |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379\r\n |    `-._   `._    /     _.-'    |     PID: 13664\r\n  `-._    `-._  `-./  _.-'    _.-'\r\n |`-._`-._    `-.__.-'    _.-'_.-'|\r\n |    `-._`-._        _.-'_.-'    |           https://redis.io\r\n  `-._    `-._`-.__.-'_.-'    _.-'\r\n |`-._`-._    `-.__.-'    _.-'_.-'|\r\n |    `-._`-._        _.-'_.-'    |\r\n  `-._    `-._`-.__.-'_.-'    _.-'\r\n      `-._    `-.__.-'    _.-'\r\n          `-._        _.-'\r\n              `-.__.-'\r\n\r\n13664:M 07 Jan 2022 21:21:36.409 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.\r\n13664:M 07 Jan 2022 21:21:36.409 # Server initialized\r\n13664:M 07 Jan 2022 21:21:36.409 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.\r\n13664:M 07 Jan 2022 21:21:36.410 * Loading RDB produced by version 255.255.255\r\n13664:M 07 Jan 2022 21:21:36.410 * RDB age 187818 seconds\r\n13664:M 07 Jan 2022 21:21:36.410 * RDB memory usage when created 0.82 Mb\r\n13664:M 07 Jan 2022 21:21:36.410 * Done loading RDB, keys loaded: 60, keys expired: 0.\r\n13664:M 07 Jan 2022 21:21:36.410 * DB loaded from disk: 0.001 seconds\r\n13664:M 07 Jan 2022 21:21:36.411 * Ready to accept connections\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n13664:M 07 Jan 2022 21:21:46.226 # Redis 255.255.255 crashed by signal: 11, si_code: 1\r\n13664:M 07 Jan 2022 21:21:46.226 # Accessing address: 0x10408\r\n13664:M 07 Jan 2022 21:21:46.226 # Crashed running the instruction at: 0x48665e\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n./redis-server *:6379(addReplySubcommandSyntaxError+0x4e)[0x48665e]\r\n\r\nBacktrace:\r\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x12890)[0x7ff92c032890]\r\n./redis-server *:6379(addReplySubcommandSyntaxError+0x4e)[0x48665e]\r\n./redis-server *:6379(processCommand+0x257)[0x45a527]\r\n./redis-server *:6379(processCommandAndResetClient+0x3f)[0x49103f]\r\n./redis-server *:6379(processInputBuffer+0x3d3)[0x491573]\r\n./redis-server *:6379(readQueryFromClient+0xcd3)[0x4817c3]\r\n./redis-server *:6379[0x60e8e6]\r\n./redis-server *:6379[0x60d4bb]\r\n./redis-server *:6379(aeProcessEvents+0x903)[0x441eb3]\r\n./redis-server *:6379(aeMain+0x7c)[0x44281c]\r\n./redis-server *:6379(main+0x1088)[0x4684e8]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xe7)[0x7ff92bc41b97]\r\n./redis-server *:6379(_start+0x2a)[0x437eda]\r\n\r\n------ REGISTERS ------\r\n13664:M 07 Jan 2022 21:21:46.253 #\r\nRAX:0000000000010400 RBX:00007ff92b858bb1\r\nRCX:0000000000000177 RDX:0000000000c867f0\r\nRDI:00007ff92b858bb1 RSI:65737c6472616373\r\nRBP:00007ff92b858ba3 RSP:00007fffe4cbfbe0\r\nR8 :0000000000000050 R9 :ffffffffffffe760\r\nR10:0000000000000007 R11:00007ff92bc508b0\r\nR12:0000000000005a01 R13:00007ff92b92a7c0\r\nR14:00007ff92b92a7c0 R15:fffffffffffffff8\r\nRIP:000000000048665e EFL:0000000000010206\r\nCSGSFS:00000053002b0033\r\n13664:M 07 Jan 2022 21:21:46.253 # (00007fffe4cbfbef) -> 000000000049103f\r\n13664:M 07 Jan 2022 21:21:46.253 # (00007fffe4cbfbee) -> 00000000000094a6\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbed) -> 0000000000000000\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbec) -> fffffffffffffff8\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbeb) -> 00007ff92b92a7c0\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbea) -> 0000000000005a01\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbe9) -> 00007ff92b92a7c0\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbe8) -> 0000000000c867f0\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbe7) -> 0000000000471f4e\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbe6) -> 00007ff92b809b30\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbe5) -> fffffffffffffff8\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbe4) -> 000000000000000c\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbe3) -> 000000000045a527\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbe2) -> 00007ff92b92a7c0\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbe1) -> 00007ff92b809f50\r\n13664:M 07 Jan 2022 21:21:46.254 # (00007fffe4cbfbe0) -> 00000000000012d1\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:255.255.255\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:a8ed957d8274f8d6\r\nredis_mode:standalone\r\nos:Linux 4.4.0-19041-Microsoft x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:4.2.1\r\nprocess_id:13664\r\nprocess_supervised:no\r\nrun_id:6803ab612ddfe2be52ddafaa234906178a47065a\r\ntcp_port:6379\r\nserver_time_usec:1641561706223451\r\nuptime_in_seconds:10\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:14171754\r\nexecutable:/mnt/d/zyp/fuzzer/memdbFuzz/visualstudio/afl-vs-raw/afl-vs-raw/bin/x64/Debug/./redis-server\r\nconfig_file:\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:1\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:0\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:923216\r\nused_memory_human:901.58K\r\nused_memory_rss:4714496\r\nused_memory_rss_human:4.50M\r\nused_memory_peak:923216\r\nused_memory_peak_human:901.58K\r\nused_memory_peak_perc:102.43%\r\nused_memory_overhead:912524\r\nused_memory_startup:847944\r\nused_memory_dataset:10692\r\nused_memory_dataset_perc:14.20%\r\nallocator_allocated:1013296\r\nallocator_active:1212416\r\nallocator_resident:4624384\r\ntotal_system_memory:8359202816\r\ntotal_system_memory_human:7.79G\r\nused_memory_lua:37888\r\nused_memory_vm_eval:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nused_memory_vm_functions:35840\r\nused_memory_vm_total:73728\r\nused_memory_vm_total_human:72.00K\r\nused_memory_functions:168\r\nused_memory_scripts:168\r\nused_memory_scripts_human:168B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.20\r\nallocator_frag_bytes:199120\r\nallocator_rss_ratio:3.81\r\nallocator_rss_bytes:3411968\r\nrss_overhead_ratio:1.02\r\nrss_overhead_bytes:90112\r\nmem_fragmentation_ratio:5.49\r\nmem_fragmentation_bytes:3855112\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:20508\r\nmem_total_replication_buffers:20504\r\nmem_clients_slaves:0\r\nmem_clients_normal:40960\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.2.1\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:1\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1641561696\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:60\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:1\r\ntotal_commands_processed:1\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:41\r\ntotal_net_output_bytes:0\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:1\r\ntotal_writes_processed:0\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:d5fbb09c7d108d570ea2ec65c7ff21c74b32cbb5\r\nmaster_replid2:304487fdad84b21fb9cded15b081113116e71d4a\r\nmaster_repl_offset:87\r\nsecond_repl_offset:29\r\nrepl_backlog_active:1\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:29\r\nrepl_backlog_histlen:59\r\n\r\n# CPU\r\nused_cpu_sys:0.015625\r\nused_cpu_user:0.000000\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:0.015625\r\nused_cpu_user_main_thread:0.000000\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_sadd:calls=1,usec=13,usec_per_call=13.00,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=60,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=4 addr=127.0.0.1:7484 laddr=127.0.0.1:6379 fd=8 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=41 qbuf-free=20433 argv-mem=10 multi-mem=0 obl=4 oll=0 omem=0 tot-mem=40978 events=r cmd=NULL user=default redir=-1 resp=2\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=4 addr=127.0.0.1:7484 laddr=127.0.0.1:6379 fd=8 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=41 qbuf-free=20433 argv-mem=10 multi-mem=0 obl=4 oll=0 omem=0 tot-mem=40978 events=r cmd=NULL user=default redir=-1 resp=2\r\nargv[0]: 'scard|set1'\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nio-threads-do-reads no\r\nlazyfree-lazy-eviction no\r\nlazyfree-lazy-expire no\r\nlazyfree-lazy-server-del no\r\nlazyfree-lazy-user-del no\r\nlazyfree-lazy-user-flush no\r\nrepl-diskless-sync no\r\nreplica-read-only yes\r\nactivedefrag no\r\nrepl-diskless-load disabled\r\nsanitize-dump-payload no\r\nio-threads 1\r\nlist-compress-depth 0\r\nproto-max-bulk-len 512mb\r\nclient-query-buffer-limit 1gb\r\n\r\n------ FAST MEMORY TEST ------\r\n13664:M 07 Jan 2022 21:21:46.286 # Bio thread for job type #0 terminated\r\n13664:M 07 Jan 2022 21:21:46.286 # Bio thread for job type #1 terminated\r\n13664:M 07 Jan 2022 21:21:46.286 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region a10000 (290816 bytes)\r\n*** Preparing to test memory region a57000 (2359296 bytes)\r\n*** Preparing to test memory region 20d7000 (135168 bytes)\r\n*** Preparing to test memory region 7ff929247000 (4096 bytes)\r\n*** Preparing to test memory region 7ff929251000 (8388608 bytes)\r\n*** Preparing to test memory region 7ff929a61000 (8388608 bytes)\r\n*** Preparing to test memory region 7ff92a271000 (8388608 bytes)\r\n*** Preparing to test memory region 7ff92aa81000 (8388608 bytes)\r\n*** Preparing to test memory region 7ff92b400000 (8388608 bytes)\r\n*** Preparing to test memory region 7ff92c00b000 (8192 bytes)\r\n*** Preparing to test memory region 7ff92c00d000 (16384 bytes)\r\n*** Preparing to test memory region 7ff92c23a000 (4096 bytes)\r\n*** Preparing to test memory region 7ff92c23b000 (16384 bytes)\r\n*** Preparing to test memory region 7ff92c447000 (4096 bytes)\r\n*** Preparing to test memory region 7ff92c653000 (4096 bytes)\r\n*** Preparing to test memory region 7ff92c9fd000 (4096 bytes)\r\n*** Preparing to test memory region 7ff92cc28000 (4096 bytes)\r\n*** Preparing to test memory region 7ff92cc29000 (4096 bytes)\r\n*** Preparing to test memory region 7ff92cc70000 (16384 bytes)\r\n*** Preparing to test memory region 7ff92cc80000 (8192 bytes)\r\n*** Preparing to test memory region 7ff92cc90000 (8192 bytes)\r\n.Segmentation fault (core dumped)\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version\r\n   unstable branch,  commit #5460c10  (2022-1-3)\r\n2. Steps to reproduce (if any)\r\n\r\n(a) Download the latest code and compile\r\n(b) Run  ./redis-server in one console\r\n(c) Download the input file:\r\nhttps://raw.githubusercontent.com/zyingp/temp/master/redis/crash_addReplySubcommandSyntaxError\r\n(d) Open another console and run  nc with the input file like:\r\nnc 127.0.0.1 6379 < \"./crash_addReplySubcommandSyntaxError\"\r\n(e) The server crashes.\r\n\r\n3. GDB output if we use gdb ./redis-server \r\n```\r\ngdb ./redis-server\r\nGNU gdb (Ubuntu 8.1-0ubuntu3.1) 8.1.0.20180409-git\r\nCopyright (C) 2018 Free Software Foundation, Inc.\r\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\r\nThis is free software: you are free to change and redistribute it.\r\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\r\nand \"show warranty\" for details.\r\nThis GDB was configured as \"x86_64-linux-gnu\".\r\nType \"show configuration\" for configuration details.\r\nFor bug reporting instructions, please see:\r\n<http://www.gnu.org/software/gdb/bugs/>.\r\nFind the GDB manual and other documentation resources online at:\r\n<http://www.gnu.org/software/gdb/documentation/>.\r\nFor help, type \"help\".\r\nType \"apropos word\" to search for commands related to \"word\"...\r\nReading symbols from ./redis-server...done.\r\n(gdb) run\r\nStarting program: /mnt/d/zyp/fuzzer/memdbFuzz/visualstudio/afl-vs-raw/afl-vs-raw/bin/x64/Debug/redis-server\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\r\n13493:C 07 Jan 2022 21:04:59.336 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\r\n13493:C 07 Jan 2022 21:04:59.337 # Redis version=255.255.255, bits=64, commit=00000000, modified=0, pid=13493, just started\r\n13493:C 07 Jan 2022 21:04:59.339 # Warning: no config file specified, using the default config. In order to specify a config file use /mnt/d/zyp/fuzzer/memdbFuzz/visualstudio/afl-vs-raw/afl-vs-raw/bin/x64/Debug/redis-server /path/to/redis.conf\r\n13493:M 07 Jan 2022 21:04:59.341 * Increased maximum number of open files to 10032 (it was originally set to 1024).\r\n13493:M 07 Jan 2022 21:04:59.342 * monotonic clock: POSIX clock_gettime\r\n                _._\r\n           _.-``__ ''-._\r\n      _.-``    `.  `_.  ''-._           Redis 255.255.255 (00000000/0) 64 bit\r\n  .-`` .-```.  ```\\/    _.,_ ''-._\r\n (    '      ,       .-`  | `,    )     Running in standalone mode\r\n |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379\r\n |    `-._   `._    /     _.-'    |     PID: 13493\r\n  `-._    `-._  `-./  _.-'    _.-'\r\n |`-._`-._    `-.__.-'    _.-'_.-'|\r\n |    `-._`-._        _.-'_.-'    |           https://redis.io\r\n  `-._    `-._`-.__.-'_.-'    _.-'\r\n |`-._`-._    `-.__.-'    _.-'_.-'|\r\n |    `-._`-._        _.-'_.-'    |\r\n  `-._    `-._`-.__.-'_.-'    _.-'\r\n      `-._    `-.__.-'    _.-'\r\n          `-._        _.-'\r\n              `-.__.-'\r\n\r\n13493:M 07 Jan 2022 21:04:59.360 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.\r\n13493:M 07 Jan 2022 21:04:59.360 # Server initialized\r\n13493:M 07 Jan 2022 21:04:59.361 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.\r\n[New Thread 0x7ffffddf0700 (LWP 13497)]\r\n[New Thread 0x7ffffd5e0700 (LWP 13498)]\r\n[New Thread 0x7ffffcdd0700 (LWP 13499)]\r\n[New Thread 0x7ffffc5c0700 (LWP 13500)]\r\n13493:M 07 Jan 2022 21:04:59.378 * Loading RDB produced by version 255.255.255\r\n13493:M 07 Jan 2022 21:04:59.379 * RDB age 186821 seconds\r\n13493:M 07 Jan 2022 21:04:59.382 * RDB memory usage when created 0.82 Mb\r\n13493:M 07 Jan 2022 21:04:59.383 * Done loading RDB, keys loaded: 60, keys expired: 0.\r\n13493:M 07 Jan 2022 21:04:59.383 * DB loaded from disk: 0.006 seconds\r\n13493:M 07 Jan 2022 21:04:59.384 * Ready to accept connections\r\n\r\nThread 1 \"redis-server\" received signal SIGSEGV, Segmentation fault.\r\n0x000000000048665e in addReplySubcommandSyntaxError (c=0x7ffffe32aa40) at networking.c:966\r\nwarning: Source file is more recent than executable.\r\n966             (char*)c->argv[1]->ptr,cmd);\r\n(gdb) bt\r\n#0  0x000000000048665e in addReplySubcommandSyntaxError (c=0x7ffffe32aa40) at networking.c:966\r\n#1  0x000000000045a527 in processCommand (c=0x7ffffe32aa40) at server.c:3290\r\n#2  0x000000000049103f in processCommandAndResetClient (c=0x7ffffe32aa40) at networking.c:2171\r\n#3  0x0000000000491573 in processInputBuffer (c=0x7ffffe32aa40) at networking.c:2266\r\n#4  0x00000000004817c3 in readQueryFromClient (conn=<optimized out>) at networking.c:2378\r\n#5  0x000000000060e8e6 in callHandler (conn=0x7ffffe21e5c0, handler=0x65737c6472616373) at ./connhelpers.h:79\r\n#6  0x000000000060d4bb in connSocketEventHandler (el=<optimized out>, fd=<optimized out>, clientData=0x7ffffe21e5c0,\r\n    mask=<optimized out>) at connection.c:295\r\n#7  0x0000000000441eb3 in aeProcessEvents (eventLoop=<optimized out>, flags=27) at ae.c:428\r\n#8  0x000000000044281c in aeMain (eventLoop=0x7ffffe21f190) at ae.c:488\r\n#9  0x00000000004684e8 in main (argc=<optimized out>, argv=0x7ffffffedfe8) at server.c:6541\r\n(gdb) p *c\r\n$1 = {id = 4, conn = 0x7ffffe21e5c0, resp = 2, db = 0x7ffffe304000, name = 0x0,\r\n  querybuf = 0x7ffffe330e85 \"sadd set1 valuN1\\r\\nscard|set1\\r\\nspop set1\\r\\n\", qb_pos = 30,\r\n  pending_querybuf = 0x7ffffe209f5b \"\", querybuf_peak = 41, argc = 1, argv = 0x7ffffe209f50, argv_len = 1,\r\n  original_argc = 0, original_argv = 0x0, argv_len_sum = 10, cmd = 0x0, lastcmd = 0x0, user = 0x7ffffe235000,\r\n  reqtype = 1, multibulklen = 0, bulklen = -1, reply = 0x7ffffe218f00, reply_bytes = 0, sentlen = 0,\r\n  ctime = 1641560704, duration = 14, lastinteraction = 1641560704, obuf_soft_limit_reached_time = 0, flags = 2097152,\r\n  authenticated = 1, replstate = 0, repl_put_online_on_ack = 0, repldbfd = 0, repldboff = 0, repldbsize = 0,\r\n  replpreamble = 0x0, read_reploff = 0, reploff = 0, repl_ack_off = 0, repl_ack_time = 0, repl_last_partial_write = 0,\r\n  psync_initial_offset = 0, replid = '\\000' <repeats 40 times>, slave_listening_port = 0, slave_addr = 0x0,\r\n  slave_capa = 0, slave_req = 0, mstate = {commands = 0x0, count = 0, cmd_flags = 0, cmd_inv_flags = 0,\r\n    argv_len_sums = 0}, btype = 0, bpop = {count = 0, timeout = 0, keys = 0x7ffffe212108, target = 0x0, blockpos = {\r\n      wherefrom = 0, whereto = 0}, xread_count = 0, xread_group = 0x0, xread_consumer = 0x0, xread_group_noack = 0,\r\n    numreplicas = 0, reploffset = 0, module_blocked_handle = 0x0}, woff = 87, watched_keys = 0x7ffffe218f30,\r\n  pubsub_channels = 0x7ffffe212140, pubsub_patterns = 0x7ffffe218f60, pubsubshard_channels = 0x7ffffe212178,\r\n  peerid = 0x0, sockname = 0x0, client_list_node = 0x7ffffe250890, paused_list_node = 0x0,\r\n  pending_read_list_node = 0x0, auth_callback = 0x0, auth_callback_privdata = 0x0, auth_module = 0x0,\r\n  client_tracking_redirection = 0, client_tracking_prefixes = 0x0, last_memory_usage = 40960, last_memory_type = 0,\r\n  last_memory_usage_on_bucket_update = 40960, mem_usage_bucket_node = 0x7ffffe2508c0,\r\n  mem_usage_bucket = 0xa71118 <server+760>, ref_repl_buf_node = 0x0, ref_block_pos = 0, bufpos = 4,\r\n  buf_usable_size = 19792, buf = \":1\\r\\n\", '\\000' <repeats 16379 times>}\r\n(gdb) p c->argv[1]\r\n$2 = (robj *) 0x10400\r\n(gdb) p *(c->argv[1])\r\nCannot access memory at address 0x10400\r\n(gdb) quit\r\nA debugging session is active.\r\n\r\n        Inferior 1 [process 13493] will be killed.\r\n\r\nQuit anyway? (y or n) y\r\n\r\n```",
  "state": "closed",
  "created_at": "2022-01-07T13:27:16Z",
  "updated_at": "2022-01-09T11:06:52Z",
  "closed_at": "2022-01-09T11:06:52Z",
  "labels": [
    "crash report"
  ],
  "comments_data": [
    {
      "id": 1007746163,
      "user": "itamarhaber",
      "created_at": "2022-01-07T21:15:33Z",
      "body": "Thanks @zyingp - verified."
    },
    {
      "id": 1007872266,
      "user": "enjoy-binbin",
      "created_at": "2022-01-08T02:48:16Z",
      "body": "It looks like every command ending with `|` (or contains it, split(\"|\"), then length == 2) will crash (unstable branch)\r\n```\r\n127.0.0.1:6379> scard|\r\nError: Server closed the connection\r\n127.0.0.1:6379> set|\r\nError: Server closed the connection\r\n127.0.0.1:6379> get|\r\nError: Server closed the connection\r\nnot connected> get|set\r\nError: Server closed the connection\r\n```\r\n\r\nin normal way, we need to return ASAP with `(error) ERR unknown command` error, like\r\n```\r\n127.0.0.1:6379> getaaa\r\n(error) ERR unknown command 'getaaa', with args beginning with:\r\n127.0.0.1:6379> get|anything|aaa\r\n(error) ERR unknown command 'get|anything|aaa', with args beginning with:\r\n```\r\n\r\nit pass `(error) ERR unknown command` check, and finally crash in here, `c->argv[1]` is NULL\r\n```\r\naddReplySubcommandSyntaxError\r\n    addReplyErrorFormat(c,\r\n        \"Unknown subcommand or wrong number of arguments for '%s'. Try %s HELP.\",\r\n        (char*)c->argv[1]->ptr,cmd);\r\n```\r\n\r\nintroduced in #9504 \r\n`get|` or `get|anythings` sdssplitlen make argv[0] became a valid command name, and then need to checks the subscommand\r\n```\r\nstruct redisCommand *lookupCommandBySdsLogic(dict *commands, sds s) {\r\n    int argc, j;\r\n    sds *strings = sdssplitlen(s,sdslen(s),\"|\",1,&argc);           ->>>>>>>>>>> here\r\n    if (strings == NULL)\r\n        return NULL;\r\n    if (argc > 2) {\r\n        /* Currently we support just one level of subcommands */\r\n        sdsfreesplitres(strings,argc);\r\n        return NULL;\r\n    }\r\n\r\n    robj objects[argc];\r\n    robj *argv[argc];\r\n    for (j = 0; j < argc; j++) {\r\n        initStaticStringObject(objects[j],strings[j]);\r\n        argv[j] = &objects[j];\r\n    }\r\n\r\n    struct redisCommand *cmd = lookupCommandLogic(commands,argv,argc);\r\n    sdsfreesplitres(strings,argc);\r\n    return cmd;\r\n}\r\n```\r\n\r\nSo i think a easy(quick) way to fix it is:\r\n```\r\n127.0.0.1:6379> get|set\r\n(error) ERR unknown command 'get|set'.\r\n\r\ndiff:\r\n void addReplySubcommandSyntaxError(client *c) {\r\n     sds cmd = sdsnew((char*) c->argv[0]->ptr);\r\n     sdstoupper(cmd);\r\n-    addReplyErrorFormat(c,\r\n-        \"Unknown subcommand or wrong number of arguments for '%s'. Try %s HELP.\",\r\n-        (char*)c->argv[1]->ptr,cmd);\r\n+    if (c->argc == 1) {\r\n+        addReplyErrorFormat(c, \"unknown command '%s'.\", (char*)c->argv[0]->ptr);\r\n+    } else {\r\n+        addReplyErrorFormat(c,\r\n+             \"Unknown subcommand or wrong number of arguments for '%s'. Try %s HELP.\",\r\n+             (char*)c->argv[1]->ptr,cmd);\r\n+    }\r\n     sdsfree(cmd);\r\n }\r\n```\r\n\r\nneeded @oranagra @guybe7 check it again."
    },
    {
      "id": 1008240855,
      "user": "oranagra",
      "created_at": "2022-01-09T06:48:45Z",
      "body": "@zyingp for reporting.\r\n@enjoy-binbin your fix seems ok, maybe i would also limit the length of the reply, in case argv[1] is too long.\r\nhowever, i also wonder why at all we need to reach that function in this case.\r\n```c\r\n    c->cmd = c->lastcmd = lookupCommand(c->argv,c->argc);\r\n    if (!c->cmd) {\r\n        if (lookupCommandBySds(c->argv[0]->ptr)) {\r\n            /* If we can't find the command but argv[0] by itself is a command\r\n             * it means we're dealing with an invalid subcommand. Print Help. */\r\n            addReplySubcommandSyntaxError(c);\r\n            return C_OK;\r\n        }\r\n```\r\n1. i don't think in this case we need to split the string with `|`, but rather just look in the commands dict to find if `argv[0]` is a container command (not `lookupCommandBySds`).\r\n2. i think we may prefer to error using `rejectCommand` (important in case we're inside a transaction)\r\n\r\nplease make a PR."
    }
  ]
}