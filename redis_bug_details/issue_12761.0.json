{
  "issue_number": 12761.0,
  "title": "[BUG]\"corrupted cluster config file\" on redis 7.2.3 error when running redis cluster with mixed 7.0 and 7.2 nodes",
  "body": "**Describe the bug**\r\n\r\n\"corrupted cluster config file\" on redis 7.2 error when running redis cluster with mixed 7.0 and 7.2 nodes.\r\n\r\n**To reproduce**\r\n\r\n1. Create a 3 node cluster with redis 7.0 (I've used 7.0.14)\r\n2. Create 3 slave nodes with redis 7.2 (I've used 7.2.3)\r\n3. Stop any of the 7.2 nodes and try to start it again. It fails with the following error:\r\n\r\n> 70878:M 14 Nov 2023 09:47:27.115 # Unrecoverable error: corrupted cluster config file \"c5cb6e214d955fe19cb2eb2d5d3e8a35a165f7d2 127.0.0.1:6381@16381,,tls-port=0,shard-id=f5de5cc8bc87f66210d34f1017149ebd89e03ad7 master - 0 1699951301788 3 connected 10923-16383\r\n\".\r\n\r\n**Expected behavior**\r\n\r\n7.2 nodes can be restarted and can rejoin the cluster.\r\n\r\n**Additional information**\r\n\r\nI've came across this problem when trying to update one of my 7.0 cluster to 7.2. I've updated several slaves, as usual. Everything seemed to work fine, until I had to restart one of them and it failed. So it seems that the rolling update from 7.0 to 7.2 is right now impossible, but maybe I'm doing something wrong?\r\n\r\nCorrupted config file generated by redis 7.2 (6379-6381 nodes are 7.0, 36379-36381 are 7.2):\r\n\r\n> 8f542d6e23d29a9106e4d5db7c028dafd67d4649 127.0.0.1:6380@16380,,tls-port=0,shard-id=502af3db7f3f11593bb9754e9fd4f58e309cd719 master - 0 1699951299000 2 connected 5461-10922\r\nf83290999eab469341f81dea9a783eaaec18b96a 127.0.0.1:6379@16379,,tls-port=0,shard-id=653bfbe1b8b4f698f81e93c173a04fb886641e51 master - 0 1699951300780 1 connected 0-5460\r\n9662b7ddd38a17cd7a294e1c2bac692c5fc1cbcc 127.0.0.1:36381@46381,,tls-port=0,shard-id=a6af4619eec99aabd7c4b9e4ccc5070f43f642b8 slave,fail c5cb6e214d955fe19cb2eb2d5d3e8a35a165f7d2 1699951288673 1699951282616 3 disconnected\r\nc5cb6e214d955fe19cb2eb2d5d3e8a35a165f7d2 127.0.0.1:6381@16381,,tls-port=0,shard-id=f5de5cc8bc87f66210d34f1017149ebd89e03ad7 master - 0 1699951301788 3 connected 10923-16383\r\n0eabd0c4889de11a25ac373c66251e5021d157a0 127.0.0.1:36380@46380,,tls-port=0,shard-id=98461c28bba1a38fdb7100cba6e98eacbb95e97b slave 8f542d6e23d29a9106e4d5db7c028dafd67d4649 0 1699951300000 2 connected\r\nbd1667d21001886891be7def40c298d6873967ce 127.0.0.1:36379@46379,,tls-port=0,shard-id=653bfbe1b8b4f698f81e93c173a04fb886641e51 myself,slave f83290999eab469341f81dea9a783eaaec18b96a 0 1699951301000 1 connected\r\nvars currentEpoch 3 lastVoteEpoch 0\r\n\r\nI've also used gdb to check why it is failing and it seems to fail in this place when trying to parse shard-id field:\r\nhttps://github.com/redis/redis/blob/7f4bae817614988c43c3024402d16edcbf3b3277/src/cluster.c#L502",
  "state": "closed",
  "created_at": "2023-11-14T08:53:21Z",
  "updated_at": "2024-08-08T21:00:58Z",
  "closed_at": "2024-01-07T04:24:43Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1809837914,
      "user": "enjoy-binbin",
      "created_at": "2023-11-14T09:25:32Z",
      "body": "@madolson this is a issue i mentioned in https://github.com/redis/redis/pull/12604#issuecomment-1759100649\r\ndo you have any ideas how should we fix it?"
    },
    {
      "id": 2140827979,
      "user": "rraptorr",
      "created_at": "2024-05-30T20:39:24Z",
      "body": "Sorry, I didn't have time to test this previously, but it seems that his bug is still unsolved. The same crash, for 7.2 nodes, still occurs on mixed 7.2 and 7.0 clusters. I've just verified it using 7.0.15 and 7.2.4/7.2.5. Both 7.2.4 and 7.2.5 still crash."
    },
    {
      "id": 2141558129,
      "user": "sundb",
      "created_at": "2024-05-31T09:08:20Z",
      "body": "@rraptorr did you mean you got the same error info `Unrecoverable error: corrupted cluster config file`?\r\ndid you ever delete old nodes*.conf?"
    },
    {
      "id": 2141565763,
      "user": "rraptorr",
      "created_at": "2024-05-31T09:12:40Z",
      "body": "> @rraptorr did you mean you got the same error info `Unrecoverable error: corrupted cluster config file`? did you ever delete old nodes*.conf?\r\n\r\nYes, I get the same error. I have tested this creating a fresh setup with 7.0.15 masters and 7.2.5 slaves, as described in the original bug report."
    },
    {
      "id": 2141569463,
      "user": "sundb",
      "created_at": "2024-05-31T09:14:52Z",
      "body": "@rraptorr is it the same step?\r\ni can't reproduce it locally, i'm sure if i miss something."
    },
    {
      "id": 2141594943,
      "user": "rraptorr",
      "created_at": "2024-05-31T09:28:57Z",
      "body": "> @rraptorr is it the same step? i can't reproduce it locally, i'm sure if i miss something.\r\n\r\nSame step. OK, let me give exactly config files and commands I type.\r\n\r\nRedis 7.0.15, build from source, 3 masters.\r\n\r\nn1-master.conf:\r\n```\r\nport 7001\r\ncluster-enabled yes\r\ncluster-config-file n1-master.node.conf\r\ndbfilename n1-master.rdb\r\n```\r\n\r\nn2-master.conf:\r\n```\r\nport 7002\r\ncluster-enabled yes\r\ncluster-config-file n2-master.node.conf\r\ndbfilename n2-master.rdb\r\n```\r\n\r\nn3-master.conf:\r\n```\r\nport 7003\r\ncluster-enabled yes\r\ncluster-config-file n3-master.node.conf\r\ndbfilename n3-master.rdb\r\n```\r\n\r\nRedis 7.2.5, build from source, 3 slaves.\r\n\r\nn1-slave.conf:\r\n```\r\nport 8001\r\ncluster-enabled yes\r\ncluster-config-file n1-slave.node.conf\r\ndbfilename n1-slave.rdb\r\n```\r\n\r\nn2-slave.conf:\r\n```\r\nport 8002\r\ncluster-enabled yes\r\ncluster-config-file n2-slave.node.conf\r\ndbfilename n2-slave.rdb\r\n```\r\n\r\nn3-slave.conf:\r\n```\r\nport 8003\r\ncluster-enabled yes\r\ncluster-config-file n3-slave.node.conf\r\ndbfilename n3-slave.rdb\r\n```\r\n\r\nStart all nodes (masters use 7.0.15 binary, slaves 7.2.5 binary):\r\n```\r\n./src/redis-server n1-master.conf\r\n./src/redis-server n2-master.conf\r\n./src/redis-server n3-master.conf\r\n./src/redis-server n1-slave.conf\r\n./src/redis-server n2-slave.conf\r\n./src/redis-server n3-slave.conf\r\n```\r\n\r\nSetup the cluster and add slaves:\r\n```\r\n./src/redis-cli --cluster create localhost:7001 localhost:7002 localhost:7003\r\n./src/redis-cli --cluster add-node localhost:8001 localhost:7001 --cluster-slave\r\n./src/redis-cli --cluster add-node localhost:8002 localhost:7001 --cluster-slave\r\n./src/redis-cli --cluster add-node localhost:8003 localhost:7001 --cluster-slave\r\n```\r\n\r\nRestart any 7.2.5 node, but doing ctrl-c on the terminal and starting it again.\r\n\r\n```$ ./src/redis-server n3-slave.conf \r\n15101:C 31 May 2024 11:28:05.316 # WARNING: Changing databases number from 16 to 1 since we are in cluster mode\r\n15101:C 31 May 2024 11:28:05.316 # WARNING Memory overcommit must be enabled! Without it, a background save or replication may fail under low memory condition. Being disabled, it can also cause failures without low memory condition, see https://github.com/jemalloc/jemalloc/issues/1328. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.\r\n15101:C 31 May 2024 11:28:05.316 * oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\r\n15101:C 31 May 2024 11:28:05.316 * Redis version=7.2.5, bits=64, commit=00000000, modified=0, pid=15101, just started\r\n15101:C 31 May 2024 11:28:05.316 * Configuration loaded\r\n15101:M 31 May 2024 11:28:05.316 # You requested maxclients of 10000 requiring at least 10032 max file descriptors.\r\n15101:M 31 May 2024 11:28:05.316 # Server can't set maximum open files to 10032 because of OS error: Operation not permitted.\r\n15101:M 31 May 2024 11:28:05.316 # Current maximum open files is 4096. maxclients has been reduced to 4064 to compensate for low ulimit. If you need higher maxclients increase 'ulimit -n'.\r\n15101:M 31 May 2024 11:28:05.316 * monotonic clock: POSIX clock_gettime\r\n                _._                                                  \r\n           _.-``__ ''-._                                             \r\n      _.-``    `.  `_.  ''-._           Redis 7.2.5 (00000000/0) 64 bit\r\n  .-`` .-```.  ```\\/    _.,_ ''-._                                  \r\n (    '      ,       .-`  | `,    )     Running in cluster mode\r\n |`-._`-...-` __...-.``-._|'` _.-'|     Port: 8003\r\n |    `-._   `._    /     _.-'    |     PID: 15101\r\n  `-._    `-._  `-./  _.-'    _.-'                                   \r\n |`-._`-._    `-.__.-'    _.-'_.-'|                                  \r\n |    `-._`-._        _.-'_.-'    |           https://redis.io       \r\n  `-._    `-._`-.__.-'_.-'    _.-'                                   \r\n |`-._`-._    `-.__.-'    _.-'_.-'|                                  \r\n |    `-._`-._        _.-'_.-'    |                                  \r\n  `-._    `-._`-.__.-'_.-'    _.-'                                   \r\n      `-._    `-.__.-'    _.-'                                       \r\n          `-._        _.-'                                           \r\n              `-.__.-'                                               \r\n\r\n15101:M 31 May 2024 11:28:05.317 # Unrecoverable error: corrupted cluster config file \"75f3feb14d7cb10148cb8ae02b1fd4fc2da6da23 ::1:7003@17003,,tls-port=0,shard-id=0faf9642000f848dfe3d1216a682b4ab5332917b master - 0 1717147657974 3 connected 10923-16383\r\n\".\r\n```\r\n"
    },
    {
      "id": 2141610240,
      "user": "sundb",
      "created_at": "2024-05-31T09:33:28Z",
      "body": "@rraptorr thanks a log, let me have a try."
    },
    {
      "id": 2276644342,
      "user": "stevelipinski",
      "created_at": "2024-08-08T21:00:57Z",
      "body": "We have encountered this same issue, and there are some additional contributing factors, specifically, whether the primary or replica is listed first in the nodes.conf, and if the other nodes are reachable (for gossip).\r\n13428 does not fix these cases.\r\n\r\n\r\n\r\n"
    }
  ]
}