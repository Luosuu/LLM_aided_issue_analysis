{
  "issue_number": 11049.0,
  "title": "[CRASH] \"Unknown sorted set encoding\" #t_zset.c:1350",
  "body": "Redis suddenly keeps crashing everytime a celery task is scheduled from this morning. Everything was fine yesterday and I'm quite sure nothing has been updated in-between. I'm not really sure where to go from here :S\r\n\r\n\r\n**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n24343:M 27 Jul 12:39:51.221 # Server started, Redis version 3.0.6\r\n24343:M 27 Jul 12:39:51.221 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.\r\n24343:M 27 Jul 12:39:51.221 * DB loaded from disk: 0.000 seconds\r\n24343:M 27 Jul 12:39:51.221 * The server is now ready to accept connections on port 6379\r\n24343:M 27 Jul 12:40:10.353 #\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n24343:M 27 Jul 12:40:10.353 # ------------------------------------------------\r\n24343:M 27 Jul 12:40:10.353 # !!! Software Failure. Press left mouse button to continue\r\n24343:M 27 Jul 12:40:10.353 # Guru Meditation: \"Unknown sorted set encoding\" #t_zset.c:1350\r\n24343:M 27 Jul 12:40:10.353 # (forcing SIGSEGV in order to print the stack trace)\r\n24343:M 27 Jul 12:40:10.353 # ------------------------------------------------\r\n24343:M 27 Jul 12:40:10.353 #     Redis 3.0.6 crashed by signal: 11\r\n24343:M 27 Jul 12:40:10.353 #     SIGSEGV caused by address: 0xffffffffffffffff\r\n24343:M 27 Jul 12:40:10.353 #     Failed assertion: <no assertion failed> (<no file>:0)\r\n24343:M 27 Jul 12:40:10.353 # --- STACK TRACE\r\n/usr/bin/redis-server 127.0.0.1:6379(logStackTrace+0xa6)[0x557117ad6f66]\r\n/usr/bin/redis-server 127.0.0.1:6379(_redisPanic+0x84)[0x557117ad5f04]\r\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x11390)[0x7fd68c2e1390]\r\n/usr/bin/redis-server 127.0.0.1:6379(_redisPanic+0x84)[0x557117ad5f04]\r\n/usr/bin/redis-server 127.0.0.1:6379(zaddGenericCommand+0x755)[0x557117ac59c5]\r\n/usr/bin/redis-server 127.0.0.1:6379(call+0x8e)[0x557117aa2e6e]\r\n/usr/bin/redis-server 127.0.0.1:6379(execCommand+0xcf)[0x557117ad560f]\r\n/usr/bin/redis-server 127.0.0.1:6379(call+0x8e)[0x557117aa2e6e]\r\n/usr/bin/redis-server 127.0.0.1:6379(processCommand+0x3ff)[0x557117aa5f8f]\r\n/usr/bin/redis-server 127.0.0.1:6379(processInputBuffer+0x4f)[0x557117ab060f]\r\n/usr/bin/redis-server 127.0.0.1:6379(readQueryFromClient+0xb2)[0x557117ab0752]\r\n/usr/bin/redis-server 127.0.0.1:6379(aeProcessEvents+0x137)[0x557117a9d277]\r\n/usr/bin/redis-server 127.0.0.1:6379(aeMain+0x2b)[0x557117a9d5db]\r\n/usr/bin/redis-server 127.0.0.1:6379(main+0x364)[0x557117a9c254]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7fd68bf26840]\r\n/usr/bin/redis-server 127.0.0.1:6379(_start+0x29)[0x557117a9c3c9]\r\n24343:M 27 Jul 12:40:10.354 # --- INFO OUTPUT\r\n24343:M 27 Jul 12:40:10.354 # # Server\r\nredis_version:3.0.6\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:256ef3a4da0a4c20\r\nredis_mode:standalone\r\nos:Linux 4.15.0-1098-gcp x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\ngcc_version:5.4.0\r\nprocess_id:24343\r\nrun_id:65b8223cb857c470a993b708f6d98f454086b4bc\r\ntcp_port:6379\r\nuptime_in_seconds:19\r\nuptime_in_days:0\r\nhz:10\r\nlru_clock:14758442\r\nconfig_file:/etc/redis/redis.conf\r\n\r\n# Clients\r\nconnected_clients:11\r\nclient_longest_output_list:0\r\nclient_biggest_input_buf:0\r\nblocked_clients:0\r\n\r\n# Memory\r\nused_memory:832752\r\nused_memory_human:813.23K\r\nused_memory_rss:3530752\r\nused_memory_peak:832752\r\nused_memory_peak_human:813.23K\r\nused_memory_lua:39936\r\nmem_fragmentation_ratio:4.24\r\nmem_allocator:jemalloc-3.6.0\r\n\r\n# Persistence\r\nloading:0\r\nrdb_changes_since_last_save:8\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1658925591\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\n\r\n# Stats\r\ntotal_connections_received:11\r\ntotal_commands_processed:90\r\ninstantaneous_ops_per_sec:1\r\ntotal_net_input_bytes:15403\r\ntotal_net_output_bytes:8256\r\ninstantaneous_input_kbps:0.56\r\ninstantaneous_output_kbps:0.49\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nevicted_keys:0\r\nkeyspace_hits:1\r\nkeyspace_misses:21\r\npubsub_channels:0\r\npubsub_patterns:2\r\nlatest_fork_usec:0\r\nmigrate_cached_sockets:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_repl_offset:0\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.02\r\nused_cpu_user:0.01\r\nused_cpu_sys_children:0.00\r\nused_cpu_user_children:0.00\r\n\r\n# Commandstats\r\ncmdstat_get:calls=1,usec=1,usec_per_call=1.00\r\ncmdstat_set:calls=1,usec=9,usec_per_call=9.00\r\ncmdstat_del:calls=5,usec=3,usec_per_call=0.60\r\ncmdstat_lpush:calls=1,usec=8,usec_per_call=8.00\r\ncmdstat_brpop:calls=17,usec=158,usec_per_call=9.29\r\ncmdstat_llen:calls=20,usec=7,usec_per_call=0.35\r\ncmdstat_sadd:calls=2,usec=11,usec_per_call=5.50\r\ncmdstat_srem:calls=1,usec=10,usec_per_call=10.00\r\ncmdstat_zrevrangebyscore:calls=1,usec=9,usec_per_call=9.00\r\ncmdstat_ping:calls=12,usec=24,usec_per_call=2.00\r\ncmdstat_multi:calls=7,usec=12,usec_per_call=1.71\r\ncmdstat_exec:calls=6,usec=22,usec_per_call=3.67\r\ncmdstat_psubscribe:calls=2,usec=7,usec_per_call=3.50\r\ncmdstat_publish:calls=11,usec=82,usec_per_call=7.45\r\ncmdstat_eval:calls=1,usec=23,usec_per_call=23.00\r\ncmdstat_evalsha:calls=1,usec=15,usec_per_call=15.00\r\ncmdstat_script:calls=1,usec=80,usec_per_call=80.00\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=4,expires=0,avg_ttl=0\r\nhash_init_value: 1658994522\r\n\r\n24343:M 27 Jul 12:40:10.354 # --- CLIENT LIST OUTPUT\r\n24343:M 27 Jul 12:40:10.354 # id=10 addr=127.0.0.1:57326 fd=13 name= age=17 idle=17 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=exec\r\nid=4 addr=127.0.0.1:57314 fd=7 name= age=18 idle=18 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=ping\r\nid=5 addr=127.0.0.1:57316 fd=8 name= age=18 idle=2 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=publish\r\nid=6 addr=127.0.0.1:57318 fd=9 name= age=18 idle=18 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=publish\r\nid=7 addr=127.0.0.1:57320 fd=10 name= age=17 idle=2 flags=N db=0 sub=0 psub=1 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=psubscribe\r\nid=8 addr=127.0.0.1:57322 fd=11 name= age=17 idle=17 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=sadd\r\nid=2 addr=127.0.0.1:57310 fd=5 name= age=18 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=brpop\r\nid=3 addr=127.0.0.1:57312 fd=6 name= age=18 idle=0 flags=x db=0 sub=0 psub=0 multi=2 qbuf=0 qbuf-free=32768 obl=27 oll=0 omem=0 events=rw cmd=exec\r\nid=9 addr=127.0.0.1:57324 fd=12 name= age=17 idle=17 flags=N db=0 sub=0 psub=1 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=psubscribe\r\nid=11 addr=127.0.0.1:57328 fd=14 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=lpush\r\nid=12 addr=127.0.0.1:57330 fd=15 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=mget\r\n\r\n24343:M 27 Jul 12:40:10.354 # --- CURRENT CLIENT INFO\r\n24343:M 27 Jul 12:40:10.354 # client: id=3 addr=127.0.0.1:57312 fd=6 name= age=18 idle=0 flags=x db=0 sub=0 psub=0 multi=2 qbuf=0 qbuf-free=32768 obl=27 oll=0 omem=0 events=rw cmd=exec\r\n24343:M 27 Jul 12:40:10.354 # argv[0]: 'ZADD'\r\n24343:M 27 Jul 12:40:10.354 # argv[1]: 'unacked_index'\r\n24343:M 27 Jul 12:40:10.354 # argv[2]: '1658925610.3525639'\r\n24343:M 27 Jul 12:40:10.354 # argv[3]: '41e456eb-d08a-480c-81f9-386204561616'\r\n24343:M 27 Jul 12:40:10.354 # key 'unacked_index' found in DB containing the following object:\r\n24343:M 27 Jul 12:40:10.354 # Object type: 3\r\n24343:M 27 Jul 12:40:10.354 # Object encoding: 5\r\n24343:M 27 Jul 12:40:10.354 # Object refcount: 1\r\n24343:M 27 Jul 12:40:10.354 # Sorted set size: 0\r\n24343:M 27 Jul 12:40:10.354 # --- REGISTERS\r\n24343:M 27 Jul 12:40:10.354 #\r\nRAX:0000000000000000 RBX:0000557117b18602\r\nRCX:00007fd68c723370 RDX:0000000000000009\r\nRDI:00007fd68b406000 RSI:000000000000003d\r\nRBP:0000557117b1aa14 RSP:00007fff7acc95b0\r\nR8 :00007fd68cc46740 R9 :00007fd68cc46740\r\nR10:0000000000000030 R11:0000000000000246\r\nR12:0000000000000546 R13:00007fd68b551000\r\nR14:00007fd68b4e5620 R15:00007fd68b4e5620\r\nRIP:0000557117ad5f04 EFL:0000000000010202\r\nCSGSFS:002b000000000033\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95bf) -> e8e29de9a0d70500\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95be) -> 0000000000000000\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95bd) -> 0000000000000001\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95bc) -> 00007fff7acc9620\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95bb) -> 0000000000000000\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95ba) -> 0000000000008009\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95b9) -> 00007fd68b4130a8\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95b8) -> 00007fd68b537fd0\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95b7) -> 0000000100000000\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95b6) -> 00000005008000c0\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95b5) -> 00007fd600000001\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95b4) -> 41d8b84c8a969068\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95b3) -> 0000557117ac59c5\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95b2) -> 0000000000000003\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95b1) -> 00007fd68b412f40\r\n24343:M 27 Jul 12:40:10.354 # (00007fff7acc95b0) -> 00007fd68b4130a8\r\n24343:M 27 Jul 12:40:10.354 # --- FAST MEMORY TEST\r\n24343:M 27 Jul 12:40:10.354 # Bio thread for job type #0 terminated\r\n24343:M 27 Jul 12:40:10.354 # Bio thread for job type #1 terminated\r\n24343:M 27 Jul 12:40:10.638 # Fast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n24343:M 27 Jul 12:40:10.638 #\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n```\r\n\r\n**Additional information**\r\n\r\n1. Ubuntu 16.04.7 LTS / Redis v=3.0.6 sha=00000000:0 malloc=jemalloc-3.6.0 bits=64 build=256ef3a4da0a4c20\r\n2. Just schedule a celery task (using Redis as a backend of course)\r\n",
  "state": "closed",
  "created_at": "2022-07-27T12:51:06Z",
  "updated_at": "2022-07-27T13:37:37Z",
  "closed_at": "2022-07-27T13:37:37Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1196746932,
      "user": "oranagra",
      "created_at": "2022-07-27T13:13:42Z",
      "body": "it's odd that it panics on `Unknown sObject encoding: 5orted set encoding`, but the crash log shows `Object encoding: 5`, which is ZIPLIST which **is** supported.\r\n\r\nIt's hard to say much more than that, except stating that this is a very old version. "
    },
    {
      "id": 1196755807,
      "user": "codefromhezad",
      "created_at": "2022-07-27T13:21:14Z",
      "body": "Thanks for your comment, I didn't try to update Redis since it was working perfectly fine but I should have thought about that.\r\n\r\nI just updated redis and it works again perfectly.\r\n\r\nI don't know if you want to keep this crash report open or not since it was such an old version ?\r\n\r\nAnyway, thanks again. "
    },
    {
      "id": 1196774617,
      "user": "oranagra",
      "created_at": "2022-07-27T13:37:37Z",
      "body": "we can argue it's unresolved, but being such an old version, no one is gonna dig into it anyway, so there's no reason to keep it open.\r\nalso, if you say an upgrade solved it, then maybe we can conclude it was already fixed (even though we don't know what it was).\r\nbottom line, let's close it."
    }
  ]
}