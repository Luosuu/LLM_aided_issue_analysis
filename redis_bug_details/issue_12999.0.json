{
  "issue_number": 12999.0,
  "title": "[BUG] Slave node attached to a slave node instead of a master node during upgrade. ",
  "body": "**Describe the bug**\r\n\r\nSlave node attached to a slave node instead of a master node during upgrade. \r\n\r\n**To reproduce**\r\n\r\n1. Create a new Redis node\r\n2. Attach Redis node to an existing master using CLUSTER REPLICATE\r\n3. Right when CLUSTER REPLICATE is executing Failover the said master so it is now a slave\r\n\r\n**Expected behavior**\r\nThe newly attached slave should be the slave for the new master instead of the old master which is a slave now.\r\n\r\n**Additional information**\r\n<details>\r\n<summary>Redis server info (same for all nodes) </summary>\r\n\r\n```bash\r\nold-redis-node:/data$ redis-cli info server\r\n# Server\r\nredis_version:7.0.12\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:275d31c4087c801\r\nredis_mode:cluster\r\nos:Linux 5.15.131.1-2.cm2 x86_64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:12.2.0\r\nprocess_id:15\r\nprocess_supervised:no\r\nrun_id:d5776a7bec7f7d96b3a160bb4fcc7fea7c3b2264\r\ntcp_port:6379\r\nserver_time_usec:1706440690803980\r\nuptime_in_seconds:131692\r\nuptime_in_days:1\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:11941874\r\nexecutable:/data/redis-server\r\nconfig_file:/redis-conf/redis.conf\r\nio_threads_active:0\r\n```\r\n</details>\r\n\r\n<details>\r\n  <summary>Replication info from the newly attached slave pov</summary>\r\n\r\n```bash\r\nnew-redis-slave:/data$ redis-cli cluster nodes \r\n976c785dcc9ef08cdc3083598c286bcbf95fb01f 192.168.3.145:6379@16379 myself,slave c8e441d4d6d69c94e2eab74ddb39e29a70d277d5 0 1706439383000 127 connected\r\nd5f97b1fab87d11389a5de1c76acfc8748ecabfc 192.168.5.210:6379@16379 slave 55dd6ef25618c8da767217744c00f87f64f0099b 0 1706439388367 116 connected\r\nedd3ed6d4a2301d4712cb0facc8e6b78b4d94835 192.168.4.239:6379@16379 slave ec38582b7e3032fb0b5113d654e51f59b67ae706 0 1706439387000 112 connected\r\n0e1999febc2b6d02c39c675c6959ec3c2f48c5cf 192.168.2.100:6379@16379 slave 3c69aa1f69d5eff460195669168a9c8fb0835114 0 1706439384000 122 connected\r\nc8e441d4d6d69c94e2eab74ddb39e29a70d277d5 192.168.1.171:6379@16379 slave 3c69aa1f69d5eff460195669168a9c8fb0835114 0 1706439388000 122 connected\r\n80f30f99160153a31f943f0322b77c2faceb698d 192.168.5.211:6379@16379 slave 2d01e4947cb903c306819888675998762621397b 0 1706439388000 117 connected\r\n7e57bb96b59c3c00392fab12e341c91331cbff38 192.168.1.169:6379@16379 slave ec38582b7e3032fb0b5113d654e51f59b67ae706 0 1706439387000 112 connected\r\n73586a8905a09508f56193621f18f99f8d763c7a 192.168.3.144:6379@16379 master - 0 1706439388869 121 connected 0-3276\r\n3c69aa1f69d5eff460195669168a9c8fb0835114 192.168.1.170:6379@16379 master - 0 1706439386358 122 connected 5462-8738\r\n7b9ee923858e39182e706ef03ac14f2833322396 192.168.1.172:6379@16379 slave c8e441d4d6d69c94e2eab74ddb39e29a70d277d5 0 1706439386559 127 connected\r\n55dd6ef25618c8da767217744c00f87f64f0099b 192.168.3.143:6379@16379 master - 0 1706439388000 116 connected 4371-5461 8739-10923\r\n2d01e4947cb903c306819888675998762621397b 192.168.4.241:6379@16379 master - 0 1706439387363 117 connected 10924-14200\r\n16bbeb514999a54b18a07887fe0186319add364f 192.168.5.209:6379@16379 slave 55dd6ef25618c8da767217744c00f87f64f0099b 0 1706439389371 116 connected\r\n0f434b51a03583c2685a418da93e7b2c65a5498e 192.168.2.98:6379@16379 slave 73586a8905a09508f56193621f18f99f8d763c7a 0 1706439386000 121 connected\r\ncc950a1a974cabd4870b87b0a1ba8abf72ef4a87 192.168.4.242:6379@16379 slave 2d01e4947cb903c306819888675998762621397b 0 1706439387000 117 connected\r\nec38582b7e3032fb0b5113d654e51f59b67ae706 192.168.4.240:6379@16379 master - 0 1706439389572 112 connected 3277-4370 14201-16383\r\ncb65167898c7273ef89f4ef96b31e8d754e68974 192.168.2.99:6379@16379 slave 73586a8905a09508f56193621f18f99f8d763c7a 0 1706439386000 121 connected\r\nnew-redis-slave:/data$ redis-cli info replication\r\n# Replication\r\nrole:slave\r\nmaster_host:192.168.1.171\r\nmaster_port:6379\r\nmaster_link_status:up\r\nmaster_last_io_seconds_ago:2\r\nmaster_sync_in_progress:0\r\nslave_read_repl_offset:43531741987\r\nslave_repl_offset:43531741987\r\nslave_priority:100\r\nslave_read_only:1\r\nreplica_announced:1\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:43e279cc982d9f477fc3c6ad7b70b7f4af09d576\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:43531741987\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:1\r\nrepl_backlog_size:209715200\r\nrepl_backlog_first_byte_offset:43322020819\r\nrepl_backlog_histlen:209721169\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary> Replication info from the old node </summary>\r\n```bash\r\nold-redis-node:/data$ redis-cli cluster nodes\r\n0e1999febc2b6d02c39c675c6959ec3c2f48c5cf 192.168.2.100:6379@16379 slave 3c69aa1f69d5eff460195669168a9c8fb0835114 0 1706440088307 122 connected\r\n73586a8905a09508f56193621f18f99f8d763c7a 192.168.3.144:6379@16379 master - 0 1706440088000 121 connected 0-3276\r\ncc950a1a974cabd4870b87b0a1ba8abf72ef4a87 192.168.4.242:6379@16379 slave 2d01e4947cb903c306819888675998762621397b 0 1706440091000 117 connected\r\n7e57bb96b59c3c00392fab12e341c91331cbff38 192.168.1.169:6379@16379 slave ec38582b7e3032fb0b5113d654e51f59b67ae706 0 1706440091000 112 connected\r\nc8e441d4d6d69c94e2eab74ddb39e29a70d277d5 192.168.1.171:6379@16379 myself,slave 3c69aa1f69d5eff460195669168a9c8fb0835114 0 1706440086000 122 connected\r\n2d01e4947cb903c306819888675998762621397b 192.168.4.241:6379@16379 master - 0 1706440090000 117 connected 10924-14200\r\nedd3ed6d4a2301d4712cb0facc8e6b78b4d94835 192.168.4.239:6379@16379 slave ec38582b7e3032fb0b5113d654e51f59b67ae706 0 1706440090316 112 connected\r\n0f434b51a03583c2685a418da93e7b2c65a5498e 192.168.2.98:6379@16379 slave 73586a8905a09508f56193621f18f99f8d763c7a 0 1706440092527 121 connected\r\n976c785dcc9ef08cdc3083598c286bcbf95fb01f 192.168.3.145:6379@16379 slave c8e441d4d6d69c94e2eab74ddb39e29a70d277d5 0 1706440092000 127 connected\r\n80f30f99160153a31f943f0322b77c2faceb698d 192.168.5.211:6379@16379 slave 2d01e4947cb903c306819888675998762621397b 0 1706440093332 117 connected\r\n16bbeb514999a54b18a07887fe0186319add364f 192.168.5.209:6379@16379 slave 55dd6ef25618c8da767217744c00f87f64f0099b 0 1706440091000 116 connected\r\n55dd6ef25618c8da767217744c00f87f64f0099b 192.168.3.143:6379@16379 master - 0 1706440090000 116 connected 4371-5461 8739-10923\r\n3c69aa1f69d5eff460195669168a9c8fb0835114 192.168.1.170:6379@16379 master - 0 1706440092326 122 connected 5462-8738\r\nec38582b7e3032fb0b5113d654e51f59b67ae706 192.168.4.240:6379@16379 master - 0 1706440092000 112 connected 3277-4370 14201-16383\r\nd5f97b1fab87d11389a5de1c76acfc8748ecabfc 192.168.5.210:6379@16379 slave 55dd6ef25618c8da767217744c00f87f64f0099b 0 1706440088000 116 connected\r\ncb65167898c7273ef89f4ef96b31e8d754e68974 192.168.2.99:6379@16379 slave 73586a8905a09508f56193621f18f99f8d763c7a 0 1706440091321 121 connected\r\n7b9ee923858e39182e706ef03ac14f2833322396 192.168.1.172:6379@16379 slave c8e441d4d6d69c94e2eab74ddb39e29a70d277d5 0 1706440088000 127 connected\r\nold-redis-node:/data$ redis-cli info replication\r\n# Replication\r\nrole:slave\r\nmaster_host:192.168.1.170\r\nmaster_port:6379\r\nmaster_link_status:up\r\nmaster_last_io_seconds_ago:0\r\nmaster_sync_in_progress:0\r\nslave_read_repl_offset:43531742953\r\nslave_repl_offset:43531742953\r\nslave_priority:100\r\nslave_read_only:1\r\nreplica_announced:1\r\nconnected_slaves:2\r\nslave0:ip=192.168.1.172,port=6379,state=online,offset=43531742939,lag=0\r\nslave1:ip=192.168.3.145,port=6379,state=online,offset=43531742939,lag=1\r\nmaster_failover_state:no-failover\r\nmaster_replid:43e279cc982d9f477fc3c6ad7b70b7f4af09d576\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:43531742953\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:1\r\nrepl_backlog_size:209715200\r\nrepl_backlog_first_byte_offset:43322020791\r\nrepl_backlog_histlen:209722163\r\n</details>\r\n",
  "state": "open",
  "created_at": "2024-01-28T11:20:52Z",
  "updated_at": "2024-01-28T11:20:52Z",
  "closed_at": null,
  "labels": [],
  "comments_data": []
}