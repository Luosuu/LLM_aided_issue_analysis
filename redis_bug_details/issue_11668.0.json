{
  "issue_number": 11668.0,
  "title": "[CRASH] OOM Crash for `srandmember`",
  "body": "Notice!\r\n- If a Redis module was involved, please open an issue in the module's repo instead!\r\n- If you're using docker on Apple M1, please make sure the image you're using was compiled for ARM!\r\n\r\n\r\n**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n546371:C 31 Dec 2022 06:37:57.158 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\r\n546371:C 31 Dec 2022 06:37:57.158 # Redis version=255.255.255, bits=64, commit=af0a4fe2, modified=0, pid=546371, just started\r\n546371:C 31 Dec 2022 06:37:57.158 # Configuration loaded\r\n546371:M 31 Dec 2022 06:37:57.159 * monotonic clock: POSIX clock_gettime\r\n546371:M 31 Dec 2022 06:37:57.159 * Running mode=standalone, port=6379.\r\n546371:M 31 Dec 2022 06:37:57.161 # Server initialized\r\n546371:M 31 Dec 2022 06:37:57.161 * Loading RDB produced by version 255.255.255\r\n546371:M 31 Dec 2022 06:37:57.161 * RDB age 9134 seconds\r\n546371:M 31 Dec 2022 06:37:57.161 * RDB memory usage when created 0.87 Mb\r\n546371:M 31 Dec 2022 06:37:57.161 * Done loading RDB, keys loaded: 2, keys expired: 0.\r\n546371:M 31 Dec 2022 06:37:57.161 * DB loaded from disk: 0.000 seconds\r\n546371:M 31 Dec 2022 06:37:57.161 * Ready to accept connections tcp\r\n546371:M 31 Dec 2022 06:38:08.830 # Out Of Memory allocating 15841173987392380928 bytes!\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n546371:M 31 Dec 2022 06:38:08.830 # ------------------------------------------------\r\n546371:M 31 Dec 2022 06:38:08.830 # !!! Software Failure. Press left mouse button to continue\r\n546371:M 31 Dec 2022 06:38:08.830 # Guru Meditation: Redis aborting for OUT OF MEMORY. Allocating 15841173987392380928 bytes! #server.c:6690\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n./src/redis-server 127.0.0.1:6379(redisOutOfMemoryHandler+0x36)[0x56316266a2b6]\r\n./src/redis-server 127.0.0.1:6379(zmalloc+0x64)[0x5631626625f4]\r\n./src/redis-server 127.0.0.1:6379(srandmemberWithCountCommand+0x58d)[0x5631626b3d8d]\r\n./src/redis-server 127.0.0.1:6379(call+0xc6)[0x563162656486]\r\n./src/redis-server 127.0.0.1:6379(processCommand+0xb10)[0x5631626579d0]\r\n./src/redis-server 127.0.0.1:6379(processInputBuffer+0x107)[0x563162677e07]\r\n./src/redis-server 127.0.0.1:6379(readQueryFromClient+0x348)[0x563162678368]\r\n./src/redis-server 127.0.0.1:6379(+0x1b50ac)[0x5631627820ac]\r\n./src/redis-server 127.0.0.1:6379(aeMain+0xf1)[0x56316264bd81]\r\n./src/redis-server 127.0.0.1:6379(main+0x3d4)[0x563162641264]\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x29d90)[0x7f7955de7d90]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0x80)[0x7f7955de7e40]\r\n./src/redis-server 127.0.0.1:6379(_start+0x25)[0x563162641a25]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:255.255.255\r\nredis_git_sha1:af0a4fe2\r\nredis_git_dirty:0\r\nredis_build_id:b21063553f60d4ba\r\nredis_mode:standalone\r\nos:Linux 5.4.0-135-generic x86_64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:11.3.0\r\nprocess_id:546371\r\nprocess_supervised:no\r\nrun_id:17465e333adf0bb66b9308f2c971d7e85617c51f\r\ntcp_port:6379\r\nserver_time_usec:1672468688830282\r\nuptime_in_seconds:11\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:11524304\r\nexecutable:/not_patched_redis/./src/redis-server\r\nconfig_file:/redis/redis.conf\r\nio_threads_active:0\r\nlistener0:name=tcp,bind=127.0.0.1,port=6379\r\n\r\n# Clients\r\nconnected_clients:1\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:20480\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:938784\r\nused_memory_human:916.78K\r\nused_memory_rss:8949760\r\nused_memory_rss_human:8.54M\r\nused_memory_peak:1111952\r\nused_memory_peak_human:1.06M\r\nused_memory_peak_perc:84.43%\r\nused_memory_overhead:866408\r\nused_memory_startup:864240\r\nused_memory_dataset:72376\r\nused_memory_dataset_perc:97.09%\r\nallocator_allocated:1464320\r\nallocator_active:1818624\r\nallocator_resident:14163968\r\ntotal_system_memory:134823165952\r\ntotal_system_memory_human:125.56G\r\nused_memory_lua:31744\r\nused_memory_vm_eval:31744\r\nused_memory_lua_human:31.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:32768\r\nused_memory_vm_total:64512\r\nused_memory_vm_total_human:63.00K\r\nused_memory_functions:184\r\nused_memory_scripts:184\r\nused_memory_scripts_human:184B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.24\r\nallocator_frag_bytes:354304\r\nallocator_rss_ratio:7.79\r\nallocator_rss_bytes:12345344\r\nrss_overhead_ratio:0.63\r\nrss_overhead_bytes:-5214208\r\nmem_fragmentation_ratio:9.77\r\nmem_fragmentation_bytes:8033480\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:1800\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.2.1\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:1\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1672468677\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:2\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_rewrites_consecutive_failures:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:1\r\ntotal_commands_processed:2\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:133\r\ntotal_net_output_bytes:200343\r\ntotal_net_repl_input_bytes:0\r\ntotal_net_repl_output_bytes:0\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\ninstantaneous_input_repl_kbps:0.00\r\ninstantaneous_output_repl_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:1\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\npubsubshard_channels:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:3\r\ntotal_writes_processed:4\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:1\r\nreply_buffer_expands:0\r\nacl_access_denied_auth:0\r\nacl_access_denied_cmd:0\r\nacl_access_denied_key:0\r\nacl_access_denied_channel:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:37b34ca66af5d81ab944aebc170acab21756a02e\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.011968\r\nused_cpu_user:0.012366\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:0.009679\r\nused_cpu_user_main_thread:0.014519\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_sadd:calls=1,usec=9,usec_per_call=9.00,rejected_calls=0,failed_calls=0\r\ncmdstat_command|docs:calls=1,usec=1682,usec_per_call=1682.00,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_sadd:p50=9.023,p99=9.023,p99.9=9.023\r\nlatency_percentiles_usec_command|docs:p50=1687.551,p99=1687.551,p99.9=1687.551\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=3,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=3 addr=127.0.0.1:55746 laddr=127.0.0.1:6379 fd=7 name= age=9 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=62 qbuf-free=20412 argv-mem=38 multi-mem=0 rbs=1024 rbp=22 obl=22 oll=0 omem=0 tot-mem=22334 events=r cmd=srandmember user=default redir=-1 resp=2\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=3 addr=127.0.0.1:55746 laddr=127.0.0.1:6379 fd=7 name= age=9 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=62 qbuf-free=20412 argv-mem=38 multi-mem=0 rbs=1024 rbp=22 obl=22 oll=0 omem=0 tot-mem=22334 events=r cmd=srandmember user=default redir=-1 resp=2\r\nargv[0]: '\"srandmember\"'\r\nargv[1]: '\"someset\"'\r\nargv[2]: '\"-1428663252545913856\"'\r\n546371:M 31 Dec 2022 06:38:08.831 # key 'someset' found in DB containing the following object:\r\n546371:M 31 Dec 2022 06:38:08.831 # Object type: 2\r\n546371:M 31 Dec 2022 06:38:08.831 # Object encoding: 11\r\n546371:M 31 Dec 2022 06:38:08.831 # Object refcount: 1\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nproto-max-bulk-len 512mb\r\nlazyfree-lazy-expire no\r\nclient-query-buffer-limit 1gb\r\nlazyfree-lazy-eviction no\r\nlist-compress-depth 0\r\nrepl-diskless-load disabled\r\nslave-read-only yes\r\nrepl-diskless-sync yes\r\nio-threads 1\r\nlazyfree-lazy-user-flush no\r\nio-threads-do-reads no\r\nreplica-read-only yes\r\nactivedefrag no\r\nlazyfree-lazy-server-del no\r\nlazyfree-lazy-user-del no\r\nsanitize-dump-payload no\r\n\r\n------ FAST MEMORY TEST ------\r\n546371:M 31 Dec 2022 06:38:08.831 # Bio thread for job type #0 terminated\r\n546371:M 31 Dec 2022 06:38:08.831 # Bio thread for job type #1 terminated\r\n546371:M 31 Dec 2022 06:38:08.831 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 56316293b000 (2306048 bytes)\r\n*** Preparing to test memory region 5631640dc000 (135168 bytes)\r\n*** Preparing to test memory region 7f7952a00000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7953200000 (6291456 bytes)\r\n*** Preparing to test memory region 7f7953915000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7954116000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7954917000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7955400000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7955dba000 (16384 bytes)\r\n*** Preparing to test memory region 7f7955fd9000 (53248 bytes)\r\n*** Preparing to test memory region 7f79560d3000 (8192 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n       Please report the crash by opening an issue on github:\r\n\r\n           http://github.com/redis/redis/issues\r\n\r\n  If a Redis module was involved, please open in the module's repo instead.\r\n\r\n  Suspect RAM error? Use redis-server --test-memory to verify it.\r\n\r\n  Some other issues could be detected by redis-server --check-system\r\n\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version\r\n```\r\nUbuntu 22.04.1 LTS\r\nRedis ver: built from commit af0a4fe20771603f0eab75a1f60748d124cf33c3\r\n```\r\n2. Steps to reproduce (if any)\r\n\r\nRun the following commands in the cli:\r\n```\r\nsadd someset somemember\r\nsrandmember someset -1428663252545913856\r\n```",
  "state": "closed",
  "created_at": "2022-12-31T06:43:05Z",
  "updated_at": "2023-01-05T06:21:58Z",
  "closed_at": "2023-01-05T06:21:58Z",
  "labels": [],
  "comments_data": []
}