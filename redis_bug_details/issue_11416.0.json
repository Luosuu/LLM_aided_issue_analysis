{
  "issue_number": 11416.0,
  "title": "[CRASH] `ZRANGESTORE` with binary keys leads to crash",
  "body": "**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n49510:M 21 Oct 2022 14:07:45.466 # === ASSERTION FAILED OBJECT CONTEXT ===\r\n49510:M 21 Oct 2022 14:07:45.467 # Object type: 3\r\n49510:M 21 Oct 2022 14:07:45.467 # Object encoding: 5\r\n49510:M 21 Oct 2022 14:07:45.467 # Object refcount: 1\r\n49510:M 21 Oct 2022 14:07:45.467 # === ASSERTION FAILED ===\r\n49510:M 21 Oct 2022 14:07:45.468 # ==> t_zset.c:1195 'eptr != NULL' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n0   redis-server                        0x0000000104250d9c zsetConvert.cold.2 + 40\r\n1   redis-server                        0x00000001041ad0e8 zsetConvert + 768\r\n2   redis-server                        0x00000001041ad3d8 zsetAdd + 488\r\n3   redis-server                        0x00000001041b381c zrangeResultEmitCBufferForStore + 76\r\n4   redis-server                        0x00000001041b0d44 genericZrangebyscoreCommand + 552\r\n5   redis-server                        0x00000001041b09c0 zrangeGenericCommand + 1008\r\n6   redis-server                        0x00000001041b05c4 zrangestoreCommand + 100\r\n7   redis-server                        0x0000000104170d48 call + 260\r\n8   redis-server                        0x0000000104171ce8 processCommand + 2632\r\n9   redis-server                        0x0000000104186410 processInputBuffer + 308\r\n10  redis-server                        0x000000010421c818 connSocketEventHandler + 288\r\n11  redis-server                        0x0000000104168390 aeProcessEvents + 792\r\n12  redis-server                        0x00000001041685fc aeMain + 32\r\n13  redis-server                        0x0000000104175530 main + 1432\r\n14  dyld                                0x000000010466d08c start + 520\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:6.2.6\r\nredis_git_sha1:190b28cb\r\nredis_git_dirty:1\r\nredis_build_id:b262be297d7fe9e5\r\nredis_mode:standalone\r\nos:Darwin 21.6.0 arm64\r\narch_bits:64\r\nmultiplexing_api:kqueue\r\natomicvar_api:c11-builtin\r\ngcc_version:4.2.1\r\nprocess_id:49510\r\nprocess_supervised:no\r\nrun_id:044dd95453bbe4169b9a960e7267fadd2a82139a\r\ntcp_port:6379\r\nserver_time_usec:1666354065466490\r\nuptime_in_seconds:93\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:5409681\r\nexecutable:/Users/mpaluch/git/data/spring-data-redis/work/redis/bin/redis-server\r\nconfig_file:/Users/mpaluch/git/data/spring-data-redis/work/redis-6379.conf\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:9\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:48\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:2347584\r\nused_memory_human:2.24M\r\nused_memory_rss:4358144\r\nused_memory_rss_human:4.16M\r\nused_memory_peak:2607552\r\nused_memory_peak_human:2.49M\r\nused_memory_peak_perc:90.03%\r\nused_memory_overhead:2269096\r\nused_memory_startup:1028560\r\nused_memory_dataset:78488\r\nused_memory_dataset_perc:5.95%\r\nallocator_allocated:2277872\r\nallocator_active:4320256\r\nallocator_resident:4320256\r\ntotal_system_memory:34359738368\r\ntotal_system_memory_human:32.00G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.90\r\nallocator_frag_bytes:2042384\r\nallocator_rss_ratio:1.00\r\nallocator_rss_bytes:0\r\nrss_overhead_ratio:1.01\r\nrss_overhead_bytes:37888\r\nmem_fragmentation_ratio:1.91\r\nmem_fragmentation_bytes:2080272\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:1048576\r\nmem_clients_slaves:34912\r\nmem_clients_normal:156976\r\nmem_aof_buffer:0\r\nmem_allocator:libc\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:4\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1666353972\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:0\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:11\r\ntotal_commands_processed:641\r\ninstantaneous_ops_per_sec:6\r\ntotal_net_input_bytes:33326\r\ntotal_net_output_bytes:226138\r\ninstantaneous_input_kbps:0.36\r\ninstantaneous_output_kbps:1.24\r\nrejected_connections:0\r\nsync_full:1\r\nsync_partial_ok:1\r\nsync_partial_err:1\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:4\r\nevicted_keys:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:1\r\npubsub_patterns:0\r\nlatest_fork_usec:239\r\ntotal_forks:1\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:628\r\ntotal_writes_processed:1140\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:2\r\nslave0:ip=127.0.0.1,port=6380,state=online,offset=20651,lag=1\r\nslave1:ip=127.0.0.1,port=6381,state=online,offset=20651,lag=1\r\nmaster_failover_state:no-failover\r\nmaster_replid:800c2c9bc1dcfadb32136aa5e30fad707db8f940\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:20651\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:1\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:1\r\nrepl_backlog_histlen:20651\r\n\r\n# CPU\r\nused_cpu_sys:0.211528\r\nused_cpu_user:0.175698\r\nused_cpu_sys_children:0.000478\r\nused_cpu_user_children:0.000079\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_subscribe:calls=3,usec=5,usec_per_call=1.67,rejected_calls=0,failed_calls=0\r\ncmdstat_client:calls=6,usec=3,usec_per_call=0.50,rejected_calls=0,failed_calls=0\r\ncmdstat_replconf:calls=186,usec=244,usec_per_call=1.31,rejected_calls=0,failed_calls=0\r\ncmdstat_psync:calls=2,usec=839,usec_per_call=419.50,rejected_calls=0,failed_calls=0\r\ncmdstat_ping:calls=272,usec=320,usec_per_call=1.18,rejected_calls=0,failed_calls=0\r\ncmdstat_flushall:calls=1,usec=4,usec_per_call=4.00,rejected_calls=0,failed_calls=0\r\ncmdstat_publish:calls=135,usec=1449,usec_per_call=10.73,rejected_calls=0,failed_calls=0\r\ncmdstat_zadd:calls=3,usec=40,usec_per_call=13.33,rejected_calls=0,failed_calls=0\r\ncmdstat_info:calls=30,usec=4380,usec_per_call=146.00,rejected_calls=0,failed_calls=0\r\ncmdstat_hello:calls=3,usec=19,usec_per_call=6.33,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=1,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=8 addr=127.0.0.1:57199 laddr=127.0.0.1:6379 fd=15 name=sentinel-ffe3bce9-pubsub age=93 idle=1 flags=P db=0 sub=1 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=17440 events=r cmd=subscribe user=default redir=-1\r\nid=3 addr=127.0.0.1:57194 laddr=127.0.0.1:6379 fd=8 name= age=93 idle=1 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=17456 events=r cmd=replconf user=default redir=-1\r\nid=9 addr=127.0.0.1:57200 laddr=127.0.0.1:6379 fd=9 name=sentinel-464fde9b-cmd age=93 idle=1 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=17440 events=r cmd=ping user=default redir=-1\r\nid=10 addr=127.0.0.1:57201 laddr=127.0.0.1:6379 fd=10 name=sentinel-464fde9b-pubsub age=93 idle=1 flags=P db=0 sub=1 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=17440 events=r cmd=subscribe user=default redir=-1\r\nid=4 addr=127.0.0.1:57195 laddr=127.0.0.1:6379 fd=11 name= age=93 idle=1 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=17456 events=r cmd=replconf user=default redir=-1\r\nid=13 addr=127.0.0.1:57254 laddr=127.0.0.1:6379 fd=18 name= age=84 idle=84 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=17440 events=r cmd=hello user=default redir=-1\r\nid=11 addr=127.0.0.1:57252 laddr=127.0.0.1:6379 fd=16 name= age=84 idle=84 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=17440 events=r cmd=flushall user=default redir=-1\r\nid=5 addr=127.0.0.1:57196 laddr=127.0.0.1:6379 fd=12 name=sentinel-1754c9fc-cmd age=93 idle=1 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=17440 events=r cmd=ping user=default redir=-1\r\nid=6 addr=127.0.0.1:57197 laddr=127.0.0.1:6379 fd=13 name=sentinel-1754c9fc-pubsub age=93 idle=1 flags=P db=0 sub=1 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=17440 events=r cmd=subscribe user=default redir=-1\r\nid=7 addr=127.0.0.1:57198 laddr=127.0.0.1:6379 fd=14 name=sentinel-ffe3bce9-cmd age=93 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=17440 events=r cmd=ping user=default redir=-1\r\nid=12 addr=127.0.0.1:57253 laddr=127.0.0.1:6379 fd=17 name= age=84 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=873 qbuf-free=64657 argv-mem=828 obl=0 oll=0 omem=0 tot-mem=83820 events=r cmd=zrangestore user=default redir=-1\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=12 addr=127.0.0.1:57253 laddr=127.0.0.1:6379 fd=17 name= age=84 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=873 qbuf-free=64657 argv-mem=828 obl=0 oll=0 omem=0 tot-mem=83820 events=r cmd=zrangestore user=default redir=-1\r\nargv[0]: 'ZRANGESTORE'\r\nargv[1]: '��'\r\nargv[2]: '��'\r\nargv[3]: '1.0'\r\nargv[4]: '2.0'\r\nargv[5]: 'BYSCORE'\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n       Please report the crash by opening an issue on github:\r\n\r\n           http://github.com/redis/redis/issues\r\n\r\n  Suspect RAM error? Use redis-server --test-memory to verify it.\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version: OSX 12, Mac M1\r\n2. Steps to reproduce (if any)\r\nInvoke `ZRANGESTORE` with binary keys\r\n",
  "state": "closed",
  "created_at": "2022-10-21T12:09:19Z",
  "updated_at": "2022-10-25T09:42:14Z",
  "closed_at": "2022-10-25T09:42:13Z",
  "labels": [
    "state:to-be-closed"
  ],
  "comments_data": [
    {
      "id": 1286916338,
      "user": "sundb",
      "created_at": "2022-10-21T12:47:14Z",
      "body": "It looks like it may not relate to the binary key, the crash is due to converting an empty ziplist to a skiplist.\r\nDo you have any reproduction steps?"
    },
    {
      "id": 1286932747,
      "user": "sundb",
      "created_at": "2022-10-21T13:02:11Z",
      "body": "@mp911de Is your `zset-max-ziplist-entries` config 0?"
    },
    {
      "id": 1287850822,
      "user": "oranagra",
      "created_at": "2022-10-22T16:41:19Z",
      "body": "seems like the crash that was reported and fixed in #10767.\r\n@mp911de let us know if we're wrong and `zset-max-ziplist-entries` isn't 0 (in which case we need a way to reproduce it)"
    },
    {
      "id": 1290101166,
      "user": "mp911de",
      "created_at": "2022-10-25T07:17:21Z",
      "body": "`zset-max-ziplist-entries` is `128`\r\n\r\n```\r\n127.0.0.1:6379> config get zset-max-ziplist-entries\r\n1) \"zset-max-ziplist-entries\"\r\n2) \"128\"\r\n```\r\n\r\nThe commands (via `redis-cli`) to reproduce the issue (tested against 6.2.7/e6f67092) are:\r\n\r\n```\r\n127.0.0.1:6379> \"ZADD\" \"\\xac\\xed\\x00\\x05t\\x00Lorg.springframework.data.redis.support.collections.RedisZSetIntegrationTests\" \"1.0\" \"\\xac\\xed\\x00\\x05sr\\x00%org.springframework.data.redis.Person\\x01I\\x199\\xf2\\xd4>m\\x02\\x00\\x04L\\x00\\aaddresst\\x00(Lorg/springframework/data/redis/Address;L\\x00\\x03aget\\x00\\x13Ljava/lang/Integer;L\\x00\\tfirstNamet\\x00\\x12Ljava/lang/String;L\\x00\\blastNameq\\x00~\\x00\\x03xpsr\\x00&org.springframework.data.redis.AddressDU\\xb9?\\x9d\\x9b\\x85{\\x02\\x00\\x02L\\x00\\x06numberq\\x00~\\x00\\x02L\\x00\\x06streetq\\x00~\\x00\\x03xpsr\\x00\\x11java.lang.Integer\\x12\\xe2\\xa0\\xa4\\xf7\\x81\\x878\\x02\\x00\\x01I\\x00\\x05valuexr\\x00\\x10java.lang.Number\\x86\\xac\\x95\\x1d\\x0b\\x94\\xe0\\x8b\\x02\\x00\\x00xp\\x00\\x00\\x00\\x01t\\x00$77ea4e70-f8bd-4341-862d-f5ca89a37533q\\x00~\\x00\\tq\\x00~\\x00\\nq\\x00~\\x00\\n\"\r\n(integer) 1\r\n127.0.0.1:6379> \"ZADD\" \"\\xac\\xed\\x00\\x05t\\x00Lorg.springframework.data.redis.support.collections.RedisZSetIntegrationTests\" \"2.0\" \"\\xac\\xed\\x00\\x05sr\\x00%org.springframework.data.redis.Person\\x01I\\x199\\xf2\\xd4>m\\x02\\x00\\x04L\\x00\\aaddresst\\x00(Lorg/springframework/data/redis/Address;L\\x00\\x03aget\\x00\\x13Ljava/lang/Integer;L\\x00\\tfirstNamet\\x00\\x12Ljava/lang/String;L\\x00\\blastNameq\\x00~\\x00\\x03xpsr\\x00&org.springframework.data.redis.AddressDU\\xb9?\\x9d\\x9b\\x85{\\x02\\x00\\x02L\\x00\\x06numberq\\x00~\\x00\\x02L\\x00\\x06streetq\\x00~\\x00\\x03xpsr\\x00\\x11java.lang.Integer\\x12\\xe2\\xa0\\xa4\\xf7\\x81\\x878\\x02\\x00\\x01I\\x00\\x05valuexr\\x00\\x10java.lang.Number\\x86\\xac\\x95\\x1d\\x0b\\x94\\xe0\\x8b\\x02\\x00\\x00xp\\x00\\x00\\x00\\x02t\\x00$f5d65152-6db6-4648-bde8-3dbf2d0b169bq\\x00~\\x00\\tq\\x00~\\x00\\nq\\x00~\\x00\\n\"\r\n(integer) 1\r\n127.0.0.1:6379> \"ZADD\" \"\\xac\\xed\\x00\\x05t\\x00Lorg.springframework.data.redis.support.collections.RedisZSetIntegrationTests\" \"3.0\" \"\\xac\\xed\\x00\\x05sr\\x00%org.springframework.data.redis.Person\\x01I\\x199\\xf2\\xd4>m\\x02\\x00\\x04L\\x00\\aaddresst\\x00(Lorg/springframework/data/redis/Address;L\\x00\\x03aget\\x00\\x13Ljava/lang/Integer;L\\x00\\tfirstNamet\\x00\\x12Ljava/lang/String;L\\x00\\blastNameq\\x00~\\x00\\x03xpsr\\x00&org.springframework.data.redis.AddressDU\\xb9?\\x9d\\x9b\\x85{\\x02\\x00\\x02L\\x00\\x06numberq\\x00~\\x00\\x02L\\x00\\x06streetq\\x00~\\x00\\x03xpsr\\x00\\x11java.lang.Integer\\x12\\xe2\\xa0\\xa4\\xf7\\x81\\x878\\x02\\x00\\x01I\\x00\\x05valuexr\\x00\\x10java.lang.Number\\x86\\xac\\x95\\x1d\\x0b\\x94\\xe0\\x8b\\x02\\x00\\x00xp\\x00\\x00\\x00\\x03t\\x00$1eb24dc5-c911-422a-8128-5b3baee0c5d9q\\x00~\\x00\\tq\\x00~\\x00\\nq\\x00~\\x00\\n\"\r\n(integer) 1\r\n127.0.0.1:6379> ZRANGESTORE dest \"\\xac\\xed\\x00\\x05t\\x00Lorg.springframework.data.redis.support.collections.RedisZSetIntegrationTests\" 2 3 BYSCORE\r\nError: Server closed the connection\r\n```"
    },
    {
      "id": 1290103497,
      "user": "mp911de",
      "created_at": "2022-10-25T07:19:40Z",
      "body": "I can also confirm that Redis 7.0.5 (1571907e/0) doesn't reproduce the issue."
    },
    {
      "id": 1290118341,
      "user": "sundb",
      "created_at": "2022-10-25T07:34:08Z",
      "body": "Sure, this crash was fixed in #10767.\r\nYour zset-max-ziplist-entries should also be the default value of 128, `ZRANGESTORE` command triggers the conversion when inserting 402 bytes of value into dest(empty listpack)."
    },
    {
      "id": 1290275677,
      "user": "oranagra",
      "created_at": "2022-10-25T09:42:13Z",
      "body": "so the crash is (also) when the first key being inserted by ZRANGESTORE tnto the zset is over the limit of `zset-max-ziplist-value`.\r\ni'll add that detail to the top comment of the PR that fixed it (will be backported to the next 6.2 release), but i guess we can close this one."
    }
  ]
}