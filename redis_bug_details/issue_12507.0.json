{
  "issue_number": 12507.0,
  "title": "[CRASH] Redis cluster 7.2.0 crashed by signal: 11, si_code: 1 when joining existing cluster (ubuntu 20.04)",
  "body": "Trying to upgrade our Redis Lab Cluster from 7.0 to 7.2 but nodes keep crashing on startup\r\nHave also tried to set up a completely new replica, there redis 7.2 works fine until i try to add the node to the cluster, then it also crashes.\r\n\r\nAfter downgrading to 7.0.12 the nodes works fine again - so seems to something specific to 7.2\r\n\r\n**Additional information**\r\nOS: Ubuntu 20.04\r\nHW: Virtual (VmWare)\r\n\r\n**Bug report:**\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\nRedis 7.2.0 crashed by signal: 11, si_code: 1\r\nAccessing address: (nil)\r\nCrashed running the instruction at: 0x562d0d6623fb\r\n\r\n------ REGISTERS ------\r\nRAX:3966386237303330 RBX:00007f241e76fa00\r\nRCX:0000000000000001 RDX:3235306133326465\r\nRDI:00007f241e76fa00 RSI:0000000000000000\r\nRBP:0000000000000000 RSP:00007ffcb3f46590\r\nR8 :0000000064dec2ad R9 :000000000ff7e624\r\nR10:00007ffcb3fdf080 R11:00007f241e770400\r\nR12:00007f241e76fa30 R13:0000018a06287589\r\nR14:00000000000000b9 R15:00007f241e76fa00\r\nRIP:0000562d0d6623fb EFL:0000000000010206\r\nCSGSFS:002b000000000033\r\n(00007ffcb3f4659f) -> 0000000000000400\r\n(00007ffcb3f4659e) -> 00007ffcb3f466b0\r\n(00007ffcb3f4659d) -> ddd7f1f3918dd200\r\n(00007ffcb3f4659c) -> 0000562d0dfd90e0\r\n(00007ffcb3f4659b) -> ddd7f1f3918dd200\r\n(00007ffcb3f4659a) -> 00007ffcb3f466b0\r\n(00007ffcb3f46599) -> 00007f241f05caad\r\n(00007ffcb3f46598) -> 00007f241ea1bb60\r\n(00007ffcb3f46597) -> 0000562d0d8660e0\r\n(00007ffcb3f46596) -> 0000562d0d8660e0\r\n(00007ffcb3f46595) -> 0000000000000001\r\n(00007ffcb3f46594) -> 0000562d0d8660e0\r\n(00007ffcb3f46593) -> 0000562d0d65cbd6\r\n(00007ffcb3f46592) -> 00007f24060cd000\r\n(00007ffcb3f46591) -> 00007f240b41c7d0\r\n(00007ffcb3f46590) -> 00007f24060cd050\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:7.2.0\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:3a1b7000f8371834\r\nredis_mode:cluster\r\nos:Linux 5.4.0-155-generic x86_64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:9.4.0\r\nprocess_id:3540560\r\nprocess_supervised:no\r\nrun_id:66c7f64c1fd1a8e265b162e3a810759c6cea4385\r\ntcp_port:6379\r\nserver_time_usec:1692320429449515\r\nuptime_in_seconds:1\r\nuptime_in_days:0\r\nhz:100\r\nconfigured_hz:100\r\nlru_clock:14598829\r\nexecutable:/usr/bin/redis-server\r\nconfig_file:/etc/redis/redis.conf\r\nio_threads_active:0\r\nlistener2:name=tls,bind=127.0.0.1,bind=10.3.48.124,port=6379\r\n# Clients\r\nconnected_clients:0\r\ncluster_connections:16\r\nmaxclients:1000\r\nclient_recent_max_input_buffer:0\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\ntotal_blocking_keys:0\r\ntotal_blocking_keys_on_nokey:0\r\n# Memory\r\nused_memory:305765264\r\nused_memory_human:291.60M\r\nused_memory_rss:318922752\r\nused_memory_rss_human:304.15M\r\nused_memory_peak:305765264\r\nused_memory_peak_human:291.60M\r\nused_memory_peak_perc:100.00%\r\nused_memory_overhead:34522872\r\nused_memory_startup:1268264\r\nused_memory_dataset:271242392\r\nused_memory_dataset_perc:89.08%\r\nallocator_allocated:302066304\r\nallocator_active:302301184\r\nallocator_resident:311668736\r\ntotal_system_memory:16742162432\r\ntotal_system_memory_human:15.59G\r\nused_memory_lua:31744\r\nused_memory_vm_eval:31744\r\nused_memory_lua_human:31.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:32768\r\nused_memory_vm_total:64512\r\nused_memory_vm_total_human:63.00K\r\nused_memory_functions:184\r\nused_memory_scripts:184\r\nused_memory_scripts_human:184B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.00\r\nallocator_frag_bytes:234880\r\nallocator_rss_ratio:1.03\r\nallocator_rss_bytes:9367552\r\nrss_overhead_ratio:1.02\r\nrss_overhead_bytes:7254016\r\nmem_fragmentation_ratio:1.06\r\nmem_fragmentation_bytes:17047752\r\nmem_not_counted_for_evict:8\r\nmem_replication_backlog:0\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:0\r\nmem_cluster_links:16008\r\nmem_aof_buffer:8\r\nmem_allocator:jemalloc-5.3.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1692320428\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:518644\r\naof_enabled:1\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_rewrites_consecutive_failures:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\naof_current_size:197591285\r\naof_base_size:197591285\r\naof_pending_rewrite:0\r\naof_buffer_length:0\r\naof_pending_bio_fsync:0\r\naof_delayed_fsync:0\r\n# Stats\r\ntotal_connections_received:0\r\ntotal_commands_processed:2\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:0\r\ntotal_net_output_bytes:0\r\ntotal_net_repl_input_bytes:0\r\ntotal_net_repl_output_bytes:0\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\ninstantaneous_input_repl_kbps:0.00\r\ninstantaneous_output_repl_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:518777\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\npubsubshard_channels:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:0\r\ntotal_writes_processed:0\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:0\r\nreply_buffer_expands:0\r\neventloop_cycles:2\r\neventloop_duration_sum:58115\r\neventloop_duration_cmd_sum:0\r\ninstantaneous_eventloop_cycles_per_sec:0\r\ninstantaneous_eventloop_duration_usec:0\r\nacl_access_denied_auth:0\r\nacl_access_denied_cmd:0\r\nacl_access_denied_key:0\r\nacl_access_denied_channel:0\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:d52983f364f9364b19f2c10cd846de059fd39830\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:10485760\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n# CPU\r\nused_cpu_sys:0.153794\r\nused_cpu_user:1.183030\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:0.153781\r\nused_cpu_user_main_thread:1.182937\r\n# Modules\r\nmodule:name=search,ver=20804,api=1,filters=0,usedby=[],using=[],options=[]\r\n# Commandstats\r\ncmdstat_info:calls=1,usec=21,usec_per_call=21.00,rejected_calls=0,failed_calls=0\r\ncmdstat_config|get:calls=1,usec=8,usec_per_call=8.00,rejected_calls=0,failed_calls=0\r\n# Errorstats\r\n# Latencystats\r\nlatency_percentiles_usec_info:p50=21.119,p99=21.119,p99.9=21.119\r\nlatency_percentiles_usec_config|get:p50=8.031,p99=8.031,p99.9=8.031\r\n# Cluster\r\ncluster_enabled:1\r\n# Keyspace\r\ndb0:keys=518644,expires=0,avg_ttl=0\r\n# Cluster info\r\ncluster_state:fail\r\ncluster_slots_assigned:16384\r\ncluster_slots_ok:16384\r\ncluster_slots_pfail:0\r\ncluster_slots_fail:0\r\ncluster_known_nodes:9\r\ncluster_size:1\r\ncluster_current_epoch:187\r\ncluster_my_epoch:185\r\ncluster_stats_messages_pong_sent:1\r\ncluster_stats_messages_sent:1\r\ncluster_stats_messages_ping_received:1\r\ncluster_stats_messages_received:1\r\ntotal_cluster_links_buffer_limit_exceeded:0\r\n\r\n------ CLUSTER NODES OUTPUT ------\r\n3b4c34db7a673629d5acafa3fd2f2d6de0212ade 10.3.48.128:0@16379,,tls-port=6379,shard-id=6d5d1e470c2147de434f691196176fc95e50ca75 slave \r\nde9123b19a3250036e53e65da8cd03e2e8ac7932 0 1692320428064 186 disconnected\r\ne2163f560a2e89955dd222d940f32d2917ed1a30 10.3.48.134:0@16379,,tls-port=6379,shard-id=1351b2c3cee680e1cdb199d4ab7364211b7a32c2 slave \r\n5c7101d30e77b341d923539492998fcadaca6392 0 1692320428064 187 disconnected\r\n8544cf7802fb5fc751c02029f553af7737c12f39 10.3.48.124:0@16379,,tls-port=6379,shard-id=031b66292ffa165413bed5d2ed51459ca2cf0ad7 myself,slave \r\n12ec951aeceeb2803feece639410231615b3dac3 0 1692320428064 185 connected\r\n5c7101d30e77b341d923539492998fcadaca6392 10.3.48.112:0@16379,,tls-port=6379,shard-id=a69d91dcac934e26e4562902e67cf43312964d2a master - 0 1692320428064 1\r\n10923-16383\r\n9c25abd4846d829426b1c439e28148654a5fd5bd 10.3.48.63:0@16379,,tls-port=6379,shard-id=0307b8f9ed23a052f0b87fba06270e9ab23fc8f2 slave 12ec951aeceeb2803feec\r\n0 1692320428064 185 disconnected\r\n5e93950692ef5dcc1f492e661f16880eeb127471 10.3.48.127:0@16379,,tls-port=6379,shard-id=44f1d80663b0b248978219969da897543080a7c5 slave \r\nde9123b19a3250036e53e65da8cd03e2e8ac7932 0 1692320428064 186 disconnected\r\n4f3ebae03f901cfb4a48f2fee01be2b99ee277d4 10.3.48.69:0@16379,,tls-port=6379,shard-id=427ae9b57255bd7e2b067887e73eac362d12345f slave 5c7101d30e77b341d9235\r\n0 1692320428064 187 disconnected\r\n12ec951aeceeb2803feece639410231615b3dac3 10.3.48.125:0@16379,,tls-port=6379,shard-id=f8fda916f49e56e8b866b8b874e4b66a38aeccf6 master - 0 1692320428064 1\r\n0-5460\r\nde9123b19a3250036e53e65da8cd03e2e8ac7932 10.3.48.66:0@16379,,tls-port=6379,shard-id=673c6db8a7d82eba1374b8d0bcab881605df5cdc master - 0 1692320428064 18\r\n5461-10922\r\n\r\n------ CLIENT LIST OUTPUT ------\r\n\r\n------ MODULES INFO OUTPUT ------\r\n# search_version\r\nsearch_version:2.8.4\r\nsearch_redis_version:7.2.0 - oss\r\n# search_index\r\nsearch_number_of_indexes:2\r\n# search_fields_statistics\r\nsearch_fields_numeric:Numeric=10,Sortable=2\r\nsearch_fields_tag:Tag=2\r\n# search_dialect_statistics\r\nsearch_dialect_1:0\r\nsearch_dialect_2:0\r\nsearch_dialect_3:0\r\nsearch_dialect_4:0\r\n# search_runtime_configurations\r\nsearch_concurrent_mode:OFF\r\nsearch_enableGC:ON\r\nsearch_minimal_term_prefix:2\r\nsearch_maximal_prefix_expansions:200\r\nsearch_query_timeout_ms:500\r\nsearch_timeout_policy:return\r\nsearch_cursor_read_size:1000\r\nsearch_cursor_max_idle_time:300000\r\nsearch_max_doc_table_size:1000000\r\nsearch_max_search_results:1000000\r\nsearch_max_aggregate_results:-1\r\nsearch_search_pool_size:20\r\nsearch_index_pool_size:8\r\nsearch_gc_scan_size:100\r\nsearch_min_phonetic_term_length:3\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nlazyfree-lazy-user-flush no\r\nrepl-diskless-load disabled\r\nslave-read-only yes\r\nlist-compress-depth 0\r\nsanitize-dump-payload no\r\nactivedefrag no\r\nreplica-read-only yes\r\nlazyfree-lazy-user-del no\r\nrepl-diskless-sync no\r\nproto-max-bulk-len 512mb\r\nio-threads 1\r\nclient-query-buffer-limit 1gb\r\nlazyfree-lazy-eviction no\r\nio-threads-do-reads no\r\nlazyfree-lazy-server-del no\r\nlazyfree-lazy-expire no\r\n------ FAST MEMORY TEST ------\r\nBio worker thread #0 terminated\r\nBio worker thread #1 terminated\r\nBio worker thread #2 terminated\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: (null) (base: (nil))\r\nModule: /usr/bin/redis-server 127.0.0.1:6379 [cluster] (base 0x562d0d568000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=(nil) -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n```\r\n\r\n\r\n",
  "state": "closed",
  "created_at": "2023-08-21T12:27:47Z",
  "updated_at": "2023-09-03T03:14:49Z",
  "closed_at": "2023-09-03T03:14:49Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1700658454,
      "user": "Believemenot",
      "created_at": "2023-08-31T09:10:07Z",
      "body": "i have same problem on updating 7.0.12 to 7.2 on working sharded cluster. on non sharded cluster upgrade from 7.0.12 to 7.2 works well"
    }
  ]
}