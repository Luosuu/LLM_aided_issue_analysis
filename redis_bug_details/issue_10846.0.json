{
  "issue_number": 10846.0,
  "title": "[CRASH] redis 7.0.1 crashes on start after upgrading from 7.0.0",
  "body": "```\r\nStarting Advanced key-value store...\r\n491342:C 10 Jun 2022 16:34:41.506 * Supervised by systemd. Please make sure you set appropriate values for TimeoutStartSec and TimeoutStopSec in your service unit.\r\n491342:C 10 Jun 2022 16:34:41.507 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\r\n491342:C 10 Jun 2022 16:34:41.507 # Redis version=7.0.1, bits=64, commit=00000000, modified=0, pid=491342, just started\r\n491342:C 10 Jun 2022 16:34:41.507 # Configuration loaded\r\n491342:M 10 Jun 2022 16:34:41.507 * monotonic clock: POSIX clock_gettime\r\n491342:M 10 Jun 2022 16:34:41.508 * Running mode=standalone, port=6379.\r\n491342:M 10 Jun 2022 16:34:41.508 # Server initialized\r\n[50B blob data]\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n491342:M 10 Jun 2022 16:34:41.508 # Redis 7.0.1 crashed by signal: 11, si_code: 1\r\n491342:M 10 Jun 2022 16:34:41.508 # Accessing address: 0x129c8\r\n491342:M 10 Jun 2022 16:34:41.508 # Crashed running the instruction at: 0x7f237834d668\r\n------ STACK TRACE ------\r\nEIP:\r\n/usr/lib/libjemalloc.so.2(malloc_usable_size+0xa8)[0x7f237834d668]\r\nBacktrace:\r\n/usr/lib/libc.so.6(+0x3e8e0)[0x7f2377c1f8e0]\r\n/usr/lib/libjemalloc.so.2(malloc_usable_size+0xa8)[0x7f237834d668]\r\n/usr/bin/redis-server 127.0.0.1:6379(sdsfree+0x21)[0x55a179a4d1b1]\r\n/usr/bin/redis-server 127.0.0.1:6379(linuxMemoryWarnings+0x79)[0x55a179a41669]\r\n/usr/bin/redis-server 127.0.0.1:6379(main+0x2ad)[0x55a179a333ad]\r\n/usr/lib/libc.so.6(+0x29290)[0x7f2377c0a290]\r\n/usr/lib/libc.so.6(__libc_start_main+0x8a)[0x7f2377c0a34a]\r\n/usr/bin/redis-server 127.0.0.1:6379(_start+0x25)[0x55a179a33a25]\r\n------ REGISTERS ------\r\n491342:M 10 Jun 2022 16:34:41.509 #\r\nRAX:00000000000129c8 RBX:00000000000129c8\r\nRCX:00007ffc42539a47 RDX:00007f2377712968\r\nRDI:00007f23777127b8 RSI:00007f23783c44e8\r\nRBP:00007ffc42539a48 RSP:00007ffc425396c0\r\nR8 :0000000000000001 R9 :0000000000000000\r\nR10:0000000000000000 R11:0000000000000246\r\nR12:00007ffc42539a48 R13:0000000000000000\r\nR14:00007f2377712968 R15:00007ffc42539a68\r\nRIP:00007f237834d668 EFL:0000000000010206\r\nCSGSFS:002b000000000033\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396cf) -> 00007f2377c65b06\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396ce) -> 0000000000000008\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396cd) -> 00007f237723c200\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396cc) -> 009fd62f67238b00\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396cb) -> 00007f23777127b8\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396ca) -> 00007f23777127c0\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396c9) -> 00007f2378352ff1\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396c8) -> 00000000000001b6\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396c7) -> 0000000000000000\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396c6) -> 0000000000000000\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396c5) -> b39fd62f67238b00\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396c4) -> 0000000000000000\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396c3) -> 00007f23774010c0\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396c2) -> 0000000000000024\r\n491342:M 10 Jun 2022 16:34:41.510 # (00007ffc425396c1) -> 0000000000005000\r\n491342:M 10 Jun 2022 16:34:41.511 # (00007ffc425396c0) -> 0000000000000040\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:7.0.1\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:4eba5fc3ec3dea2f\r\nredis_mode:standalone\r\nos:Linux 5.18.0-pf1 x86_64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:12.1.0\r\nprocess_id:491342\r\nprocess_supervised:systemd\r\nrun_id:f5c9da2b202336e58c4ebecc2e40fe04a6abcd50\r\ntcp_port:6379\r\nserver_time_usec:1654871681501872\r\nuptime_in_seconds:0\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:10704513\r\nexecutable:/usr/bin/redis-server\r\nconfig_file:/etc/redis/redis.conf\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:0\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:0\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:878432\r\nused_memory_human:857.84K\r\nused_memory_rss:0\r\nused_memory_rss_human:0B\r\nused_memory_peak:878432\r\nused_memory_peak_human:857.84K\r\nused_memory_peak_perc:inf%\r\nused_memory_overhead:200\r\nused_memory_startup:0\r\nused_memory_dataset:878232\r\nused_memory_dataset_perc:99.98%\r\nallocator_allocated:0\r\nallocator_active:0\r\nallocator_resident:0\r\ntotal_system_memory:2075303936\r\ntotal_system_memory_human:1.93G\r\nused_memory_lua:31744\r\nused_memory_vm_eval:31744\r\nused_memory_lua_human:31.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:32768\r\nused_memory_vm_total:64512\r\nused_memory_vm_total_human:63.00K\r\nused_memory_functions:200\r\nused_memory_scripts:200\r\nused_memory_scripts_human:200B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:-nan\r\nallocator_frag_bytes:0\r\nallocator_rss_ratio:-nan\r\nallocator_rss_bytes:0\r\nrss_overhead_ratio:-nan\r\nrss_overhead_bytes:0\r\nmem_fragmentation_ratio:-nan\r\nmem_fragmentation_bytes:0\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:0\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.3.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1654871681\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_rewrites_consecutive_failures:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:0\r\ntotal_commands_processed:0\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:0\r\ntotal_net_output_bytes:0\r\ntotal_net_repl_input_bytes:0\r\ntotal_net_repl_output_bytes:0\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\ninstantaneous_input_repl_kbps:0.00\r\ninstantaneous_output_repl_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:0\r\ntotal_writes_processed:0\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:0\r\nreply_buffer_expands:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:175542c754b2fa0bfcd03259385f11680d8c6185\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.009845\r\nused_cpu_user:0.036064\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000575\r\nused_cpu_sys_main_thread:0.009845\r\nused_cpu_user_main_thread:0.036064\r\n\r\n# Modules\r\n\r\n# Commandstats\r\n\r\n# Errorstats\r\n\r\n# Latencystats\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\n------ CLIENT LIST OUTPUT ------\r\n------ MODULES INFO OUTPUT ------\r\n------ CONFIG DEBUG OUTPUT ------\r\nio-threads 1\r\nrepl-diskless-load disabled\r\nlazyfree-lazy-user-del no\r\nrepl-diskless-sync yes\r\nio-threads-do-reads no\r\nlazyfree-lazy-server-del no\r\nreplica-read-only yes\r\nactivedefrag no\r\nlazyfree-lazy-user-flush no\r\nlazyfree-lazy-expire no\r\nproto-max-bulk-len 512mb\r\nslave-read-only yes\r\nclient-query-buffer-limit 1gb\r\nlist-compress-depth 0\r\nlazyfree-lazy-eviction no\r\nsanitize-dump-payload no\r\n------ FAST MEMORY TEST ------\r\n*** Preparing to test memory region 55a179c5c000 (122880 bytes)\r\n*** Preparing to test memory region 7f2376e00000 (6275072 bytes)\r\n*** Preparing to test memory region 7f2377400000 (2097152 bytes)\r\n*** Preparing to test memory region 7f2377710000 (28672 bytes)\r\n*** Preparing to test memory region 7f2377809000 (8192 bytes)\r\n*** Preparing to test memory region 7f237797d000 (4096 bytes)\r\n*** Preparing to test memory region 7f2377bde000 (12288 bytes)\r\n*** Preparing to test memory region 7f2377de0000 (61440 bytes)\r\n*** Preparing to test memory region 7f23780cc000 (16384 bytes)\r\n*** Preparing to test memory region 7f2378244000 (4096 bytes)\r\n*** Preparing to test memory region 7f23783bd000 (2138112 bytes)\r\n*** Preparing to test memory region 7f23785d3000 (8192 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: malloc_usable_size (base: 0x7f237834d5c0)\r\nModule: /usr/lib/libjemalloc.so.2 (base 0x7f237832c000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x7f237834d5c0 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n491342:M 10 Jun 2022 16:34:41.557 # dump of function (hexdump of 296 bytes):\r\nf30f1efa4156534881ec880100004889fb64488b0425280000004889842480010000488d05279127008038007437488b05e3e706006480b830030000000f85df0000004885db0f849300000064488b042500000000480305bce706004c8db0b0010000eb134885db74754989e64c89f767e8ea9c040031c04889d948c1e91e83e10f4889da4881e2000000c048c1e104498b3c0e4839d7754b48c1eb0981e3f8ff1f0049035c0e08488b0348c1e830488d0d8a8627004c8b34c164488b042528000000483b8424800100000f85fb0000004c89f04881c4880100005b415ec34531f6ebd6498d340e493996000100007563498b86080100004989be00010000498b7c0e084989be080100004889164989440e0848c1eb0981e3f8ff1f004801c3eb8664488b3c2500\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n       Please report the crash by opening an issue on github:\r\n           http://github.com/redis/redis/issues\r\n  If a Redis module was involved, please open in the module's repo instead.\r\n  Suspect RAM error? Use redis-server --test-memory to verify it.\r\n  Some other issues could be detected by redis-server --check-system\r\nredis.service: Main process exited, code=dumped, status=11/SEGV\r\nredis.service: Failed with result 'core-dump'.\r\nFailed to start Advanced key-value store.\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version\r\n\r\nArch Linux.\r\n\r\n2. Steps to reproduce (if any)\r\n\r\nUpgraded redis from 7.0.0 to 7.0.1. Downgrading back to 7.0.0 solves the issue.",
  "state": "closed",
  "created_at": "2022-06-10T14:47:52Z",
  "updated_at": "2022-06-11T19:34:05Z",
  "closed_at": "2022-06-11T19:27:45Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1152463884,
      "user": "oranagra",
      "created_at": "2022-06-10T15:09:15Z",
      "body": "looks like a regression from #10636\r\ncould it be that `/proc/sys/vm/overcommit_memory` is inaccessible?"
    },
    {
      "id": 1152470786,
      "user": "pfactum",
      "created_at": "2022-06-10T15:16:22Z",
      "body": "Yes, it is inaccessible. I run `redis` in a restricted mode with `ProcSubset=pid` set. Once I lift up this restriction, it starts fine, so thanks for the pointer.\r\n\r\nBut in any case, regardless of the file accessibility, it shouldn't perhaps crash?"
    },
    {
      "id": 1152472718,
      "user": "oranagra",
      "created_at": "2022-06-10T15:18:33Z",
      "body": "yeah, of course.. just trying to make sure the bug i see is the same one that you run into."
    },
    {
      "id": 1152487034,
      "user": "pfactum",
      "created_at": "2022-06-10T15:32:14Z",
      "body": "Yeah, I see. `checkOvercommit()` returns `-1` without allocating `error_msg`, and then in `linuxMemoryWarnings()` it is being `free()`'ed by `sdsfree()`. Right?"
    },
    {
      "id": 1152703410,
      "user": "enjoy-binbin",
      "created_at": "2022-06-10T20:12:55Z",
      "body": "> Yeah, I see. checkOvercommit() returns -1 without allocating error_msg, and then in linuxMemoryWarnings() it is being free()'ed by sdsfree(). Right?\r\n\r\nthanks for the report, yes (actually it was crash in `serverLog(LL_WARNING,\"WARNING %s\", err_msg);` not the sdsfree), i think we should return 0 in this case, also the log had two warning which i think it is odd (after patch #10841)\r\n```\r\n# WARNING WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.\r\n```"
    }
  ]
}