{
  "issue_number": 10221.0,
  "title": "[CRASH] c->cmd nullified within `cmd->proc` call.",
  "body": "**Crash report**\r\nThere was a crash in the cluster tests in GH actions.\r\nhttps://github.com/redis/redis/runs/5001700579?check_suite_focus=true#step:10:630\r\n\r\nit looks like the crash is due to a NULL `cmd` member in the client struct here:\r\n```\r\n    if (!(c->cmd->flags & (CMD_SKIP_MONITOR|CMD_ADMIN))) {\r\n```\r\n\r\nin the prints below we see `Cluster nodes are reachable` completes successfully, so it must be one of the commands in `Cluster nodes hard reset` that called `freeClientArgv` (or maybe even `freeClient`) from within `call()`,\r\n\r\nNote that it might be that the crash exists for a long time, but only now being reported due to the change in #10207\r\n\r\n```\r\nTesting unit: 06-slave-stop-cond.tcl\r\n05:44:02> (init) Restart killed instances: redis/0 redis/3 redis/6 redis/12 redis/15 OK\r\n05:44:02> Cluster nodes are reachable: OK\r\n05:44:02> Cluster nodes hard reset: FAILED: caught an error in the test I/O error reading reply\r\nI/O error reading reply\r\n    while executing\r\n\"foreach_redis_id id {\r\n        if {$::valgrind} {\r\n            set node_timeout 10000\r\n        } else {\r\n            set node_timeout 3000\r\n        }\r\n     ...\"\r\n    (\"uplevel\" body line 2)\r\n    invoked from within\r\n\"uplevel 1 $code\"\r\n    (procedure \"test\" line 6)\r\n    invoked from within\r\n\"test \"Cluster nodes hard reset\" {\r\n    foreach_redis_id id {\r\n        if {$::valgrind} {\r\n            set node_timeout 10000\r\n        } else {\r\n           ...\"\r\n    (file \"../tests/includes/init-tests.tcl\" line 28)\r\n    invoked from within\r\n\"source \"../tests/includes/init-tests.tcl\"\"\r\n```\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n6077:M 31 Jan 2022 05:44:02.861 # Redis 255.255.255 crashed by signal: 11, si_code: 1\r\n6077:M 31 Jan 2022 05:44:02.861 # Accessing address: 0x60\r\n6077:M 31 Jan 2022 05:44:02.861 # Crashed running the instruction at: 0x44a490\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n../../../src/redis-server *:30009 [cluster](call+0x170)[0x44a490]\r\n\r\nBacktrace:\r\n/lib64/libpthread.so.0(+0xf630)[0x7fc378620630]\r\n../../../src/redis-server *:30009 [cluster](call+0x170)[0x44a490]\r\n../../../src/redis-server *:30009 [cluster](processCommand+0x990)[0x44c470]\r\n../../../src/redis-server *:30009 [cluster](processCommandAndResetClient+0x1c)[0x46177c]\r\n../../../src/redis-server *:30009 [cluster](processInputBuffer+0xd1)[0x464111]\r\n../../../src/redis-server *:30009 [cluster](readQueryFromClient+0x238)[0x467028]\r\n../../../src/redis-server *:30009 [cluster][0x4f93f3]\r\n../../../src/redis-server *:30009 [cluster](aeProcessEvents+0x235)[0x442ed5]\r\n../../../src/redis-server *:30009 [cluster](aeMain+0x1d)[0x44321d]\r\n../../../src/redis-server *:30009 [cluster](main+0x406)[0x43f5b6]\r\n/lib64/libc.so.6(__libc_start_main+0xf5)[0x7fc378265555]\r\n../../../src/redis-server *:30009 [cluster][0x43f96a]\r\n\r\n------ REGISTERS ------\r\n6077:M 31 Jan 2022 05:44:02.862 # \r\nRAX:0000000000000000 RBX:00007fc37794a1c0\r\nRCX:000000000000007d RDX:0000000000000000\r\nRDI:00007fc377e1c530 RSI:0000000000000000\r\nRBP:000000000000000f RSP:00007ffd129f59f0\r\nR8 :000000000002823c R9 :000000000000007d\r\nR10:0000000000000002 R11:00007ffd129fa000\r\nR12:0000000000000001 R13:0000000000000000\r\nR14:000000000000c360 R15:00000000008203e0\r\nRIP:000000000044a490 EFL:0000000000010206\r\nCSGSFS:002b000000000033\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59ff) -> 00007fc37794a1c0\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59fe) -> 000000000000001b\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59fd) -> 00007fc377950de0\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59fc) -> 00007fc377e507c8\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59fb) -> 00007fc300000000\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59fa) -> 0000000000000000\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59f9) -> 000000000044c470\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59f8) -> 0000000000000000\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59f7) -> 0000000000000000\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59f6) -> 0000000000000000\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59f5) -> 0000000000000000\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59f4) -> 0000000000000000\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59f3) -> 00007fc37794a1c0\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59f2) -> 0000000000000000\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59f1) -> 000000000000007d\r\n6077:M 31 Jan 2022 05:44:02.862 # (00007ffd129f59f0) -> 000000000000c360\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:255.255.255\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:4233af117fee7f3d\r\nredis_mode:cluster\r\nos:Linux 5.11.0-1027-azure x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:atomic-builtin\r\ngcc_version:4.8.5\r\nprocess_id:6077\r\nprocess_supervised:no\r\nrun_id:c8b4aa2843acf6ded37aa05c165a239d8b15166a\r\ntcp_port:30009\r\nserver_time_usec:1643607842861736\r\nuptime_in_seconds:66\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:16217890\r\nexecutable:/__w/redis/redis/src/redis-server\r\nconfig_file:/__w/redis/redis/tests/cluster/tmp/redis_9/redis.conf\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:3\r\ncluster_connections:38\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:20480\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:2246088\r\nused_memory_human:2.14M\r\nused_memory_rss:12701696\r\nused_memory_rss_human:12.11M\r\nused_memory_peak:3836632\r\nused_memory_peak_human:3.66M\r\nused_memory_peak_perc:58.54%\r\nused_memory_overhead:1729724\r\nused_memory_startup:1605336\r\nused_memory_dataset:516364\r\nused_memory_dataset_perc:80.59%\r\nallocator_allocated:2751032\r\nallocator_active:3465216\r\nallocator_resident:6545408\r\ntotal_system_memory:7289606144\r\ntotal_system_memory_human:6.79G\r\nused_memory_lua:37888\r\nused_memory_vm_eval:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:37888\r\nused_memory_vm_total:75776\r\nused_memory_vm_total_human:74.00K\r\nused_memory_functions:184\r\nused_memory_scripts:184\r\nused_memory_scripts_human:184B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.26\r\nallocator_frag_bytes:714184\r\nallocator_rss_ratio:1.89\r\nallocator_rss_bytes:3080192\r\nrss_overhead_ratio:1.94\r\nrss_overhead_bytes:6156288\r\nmem_fragmentation_ratio:5.49\r\nmem_fragmentation_bytes:10387352\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:20508\r\nmem_total_replication_buffers:20504\r\nmem_clients_slaves:0\r\nmem_clients_normal:81936\r\nmem_cluster_links:21760\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.2.1\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:50016\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1643607842\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:0\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:503808\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:0\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:872448\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:9\r\ntotal_commands_processed:710\r\ninstantaneous_ops_per_sec:32\r\ntotal_net_input_bytes:398579\r\ntotal_net_output_bytes:2889291\r\ninstantaneous_input_kbps:0.93\r\ninstantaneous_output_kbps:83.38\r\nrejected_connections:0\r\nsync_full:5\r\nsync_partial_ok:0\r\nsync_partial_err:5\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:359\r\ntotal_forks:4\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:4\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:721\r\ntotal_writes_processed:685\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:1\r\nslave0:ip=127.0.0.1,port=30012,state=online,offset=1232,lag=0\r\nmaster_failover_state:no-failover\r\nmaster_replid:2a3a26533a4563723f1c93778b6506c069c23f7d\r\nmaster_replid2:6bc4c527c36524c7c5918b0fcd6fe689488721b8\r\nmaster_repl_offset:1273\r\nsecond_repl_offset:1233\r\nrepl_backlog_active:1\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:1071\r\nrepl_backlog_histlen:203\r\n\r\n# CPU\r\nused_cpu_sys:0.184028\r\nused_cpu_user:0.360055\r\nused_cpu_sys_children:0.002642\r\nused_cpu_user_children:0.009071\r\nused_cpu_sys_main_thread:0.180311\r\nused_cpu_user_main_thread:0.360623\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_set:calls=48,usec=77,usec_per_call=1.60,rejected_calls=0,failed_calls=0\r\ncmdstat_multi:calls=2,usec=0,usec_per_call=0.00,rejected_calls=0,failed_calls=0\r\ncmdstat_debug:calls=3,usec=69261,usec_per_call=23087.00,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|set-config-epoch:calls=2,usec=45,usec_per_call=22.50,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|reset:calls=2,usec=6464,usec_per_call=3232.00,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|replicate:calls=2,usec=444,usec_per_call=222.00,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|info:calls=13,usec=711,usec_per_call=54.69,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|meet:calls=2,usec=24,usec_per_call=12.00,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|nodes:calls=17,usec=2144,usec_per_call=126.12,rejected_calls=0,failed_calls=0\r\ncmdstat_psync:calls=5,usec=1218,usec_per_call=243.60,rejected_calls=0,failed_calls=0\r\ncmdstat_exec:calls=2,usec=6537,usec_per_call=3268.50,rejected_calls=0,failed_calls=0\r\ncmdstat_config|set:calls=13,usec=50,usec_per_call=3.85,rejected_calls=0,failed_calls=0\r\ncmdstat_config|rewrite:calls=2,usec=2409,usec_per_call=1204.50,rejected_calls=0,failed_calls=0\r\ncmdstat_info:calls=545,usec=37221,usec_per_call=68.30,rejected_calls=0,failed_calls=0\r\ncmdstat_replconf:calls=18,usec=41,usec_per_call=2.28,rejected_calls=0,failed_calls=0\r\ncmdstat_flushall:calls=3,usec=11753,usec_per_call=3917.67,rejected_calls=2,failed_calls=0\r\ncmdstat_select:calls=2,usec=1,usec_per_call=0.50,rejected_calls=0,failed_calls=0\r\ncmdstat_role:calls=17,usec=26,usec_per_call=1.53,rejected_calls=0,failed_calls=0\r\ncmdstat_ping:calls=12,usec=12,usec_per_call=1.00,rejected_calls=2,failed_calls=0\r\n\r\n# Errorstats\r\nerrorstat_LOADING:count=2\r\nerrorstat_READONLY:count=2\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_set:p50=1.003,p99=10.047,p99.9=10.047\r\nlatency_percentiles_usec_multi:p50=0.001,p99=0.001,p99.9=0.001\r\nlatency_percentiles_usec_debug:p50=1.003,p99=69730.303,p99.9=69730.303\r\nlatency_percentiles_usec_cluster|set-config-epoch:p50=22.015,p99=23.039,p99.9=23.039\r\nlatency_percentiles_usec_cluster|reset:p50=3194.879,p99=3293.183,p99.9=3293.183\r\nlatency_percentiles_usec_cluster|replicate:p50=196.607,p99=248.831,p99.9=248.831\r\nlatency_percentiles_usec_cluster|info:p50=56.063,p99=79.359,p99.9=79.359\r\nlatency_percentiles_usec_cluster|meet:p50=10.047,p99=14.015,p99.9=14.015\r\nlatency_percentiles_usec_cluster|nodes:p50=95.231,p99=282.623,p99.9=282.623\r\nlatency_percentiles_usec_psync:p50=150.527,p99=569.343,p99.9=569.343\r\nlatency_percentiles_usec_exec:p50=3244.031,p99=3309.567,p99.9=3309.567\r\nlatency_percentiles_usec_config|set:p50=3.007,p99=10.047,p99.9=10.047\r\nlatency_percentiles_usec_config|rewrite:p50=1130.495,p99=1286.143,p99.9=1286.143\r\nlatency_percentiles_usec_info:p50=66.047,p99=105.471,p99.9=178.175\r\nlatency_percentiles_usec_replconf:p50=2.007,p99=8.031,p99.9=8.031\r\nlatency_percentiles_usec_flushall:p50=1409.023,p99=9175.039,p99.9=9175.039\r\nlatency_percentiles_usec_select:p50=0.001,p99=1.003,p99.9=1.003\r\nlatency_percentiles_usec_role:p50=1.003,p99=4.015,p99.9=4.015\r\nlatency_percentiles_usec_ping:p50=1.003,p99=5.023,p99.9=5.023\r\n\r\n# Cluster\r\ncluster_enabled:1\r\n\r\n# Keyspace\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=12 addr=127.0.0.1:58648 laddr=127.0.0.1:30009 fd=52 name= age=51 idle=51 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=4 argv-mem=0 multi-mem=0 obl=0 oll=0 omem=0 tot-mem=20488 events=r cmd=NULL user=default redir=-1 resp=2\r\nid=18 addr=127.0.0.1:37012 laddr=127.0.0.1:30009 fd=51 name= age=0 idle=0 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 obl=0 oll=1 omem=20504 tot-mem=61464 events=r cmd=replconf user=default redir=-1 resp=2\r\nid=6 addr=127.0.0.1:56588 laddr=127.0.0.1:30009 fd=12 name= age=66 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 obl=0 oll=0 omem=0 tot-mem=40960 events=r cmd=flushall user=default redir=-1 resp=2\r\nid=9 addr=127.0.0.1:57610 laddr=127.0.0.1:30009 fd=48 name= age=63 idle=63 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=4 argv-mem=0 multi-mem=0 obl=0 oll=0 omem=0 tot-mem=20488 events=r cmd=NULL user=default redir=-1 resp=2\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nio-threads-do-reads no\r\nlazyfree-lazy-eviction no\r\nlazyfree-lazy-expire no\r\nlazyfree-lazy-server-del no\r\nlazyfree-lazy-user-del no\r\nlazyfree-lazy-user-flush no\r\nrepl-diskless-sync yes\r\nreplica-read-only yes\r\nactivedefrag no\r\nrepl-diskless-load disabled\r\nsanitize-dump-payload no\r\nio-threads 1\r\nlist-compress-depth 0\r\nproto-max-bulk-len 512mb\r\nclient-query-buffer-limit 1gb\r\n\r\n------ FAST MEMORY TEST ------\r\n6077:M 31 Jan 2022 05:44:02.864 # Bio thread for job type #0 terminated\r\n6077:M 31 Jan 2022 05:44:02.865 # Bio thread for job type #1 terminated\r\n6077:M 31 Jan 2022 05:44:02.865 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 85a000 (2293760 bytes)\r\n*** Preparing to test memory region 1556000 (135168 bytes)\r\n*** Preparing to test memory region 7fc36c000000 (135168 bytes)\r\n*** Preparing to test memory region 7fc371c00000 (16777216 bytes)\r\n*** Preparing to test memory region 7fc372c00000 (2097152 bytes)\r\n*** Preparing to test memory region 7fc372f7c000 (4194304 bytes)\r\n*** Preparing to test memory region 7fc37337d000 (16777216 bytes)\r\n*** Preparing to test memory region 7fc37437e000 (16777216 bytes)\r\n*** Preparing to test memory region 7fc37537f000 (16777216 bytes)\r\n*** Preparing to test memory region 7fc377380000 (15204352 bytes)\r\n*** Preparing to test memory region 7fc37860c000 (20480 bytes)\r\n*** Preparing to test memory region 7fc378829000 (16384 bytes)\r\n*** Preparing to test memory region 7fc379152000 (20480 bytes)\r\n*** Preparing to test memory region 7fc37915a000 (8192 bytes)\r\n*** Preparing to test memory region 7fc37915e000 (4096 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: call (base: 0x44a320)\r\nModule: ../../../src/redis-server *:30009 [cluster] (base 0x400000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x44a320 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n6077:M 31 Jan 2022 05:44:03.175 # dump of function (hexdump of 496 bytes):\r\n41574156415541545589f5534889fb4883ec184c8ba7d0000000448b2da7a042004c8b7f704c89e04825ff3fe7ff4585ed488987d0000000750a40f6c6100f84b4030000488b05adaa420048890424488b0512a742004889050bf44000488b05a4a34200488d50014885c048891596a342000f84b8030000830591a3420001ff15fb4a41004989c6488b43704889dfff5050ff15e84a41004989c1488b05c6a64200482b05bff340004d29f14c8b3545aa42004c898bb8000000832d4fa34200014885c07e084983878001000001488b83d000000048ba00000000000100004885d0741848bafffffffffffeffff4821d04883c840488983d00000008b1582a4420085d20f8456020000f6c4010f85cd02000040f6c501745341f6476140488b0d73ae4200bf6a4a5800b8184b5800480f44f84885c974274c89c848bacff753e3a59bc42048f7ea4c89c848c1f83f48c1fa074829c24839d10f8e11030000f683d0000000100f84d4020000488b437048f74060100800007531488b4b604885c90f84d9020000448b435c488b4318488b352aa142004889df4c894c24088b5028e84a7a02004c8b4c2408488b83d0000000a8100f845602000040f6c502741d8b0d56a842004d018f68010000498387700100000185c90f85d301000040f6c50c0f84a90000004889c281e200001800\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n```\r\n\r\n**Additional information**\r\n\r\nhappened in GH actions cluster tests on CentOS 7 with jemalloc",
  "state": "closed",
  "created_at": "2022-02-01T08:09:39Z",
  "updated_at": "2022-02-08T17:10:13Z",
  "closed_at": "2022-02-08T17:10:13Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1031134087,
      "user": "oranagra",
      "created_at": "2022-02-07T06:59:49Z",
      "body": "happen again on alpine jemalloc:\r\nhttps://github.com/redis/redis/runs/5086511859?check_suite_focus=true\r\n```\r\nTesting unit: 06-slave-stop-cond.tcl\r\n00:36:59> (init) Restart killed instances: redis/0 redis/6 redis/9 redis/12 redis/15 OK\r\n00:37:00> Cluster nodes are reachable: OK\r\n00:37:00> Cluster nodes hard reset: FAILED: caught an error in the test couldn't open socket: connection refused\r\ncouldn't open socket: connection refused\r\n    while executing\r\n\"foreach_redis_id id {\r\n        if {$::valgrind} {\r\n            set node_timeout 10000\r\n        } else {\r\n            set node_timeout [300](https://github.com/redis/redis/runs/5086511859?check_suite_focus=true#step:10:300)0\r\n        }\r\n     ...\"\r\n    (\"uplevel\" body line 2)\r\n    invoked from within\r\n\"uplevel 1 $code\"\r\n    (procedure \"test\" line 6)\r\n    invoked from within\r\n\"test \"Cluster nodes hard reset\" {\r\n```\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n34138:M 07 Feb 2022 00:37:00.199 # Redis 255.255.255 crashed by signal: 11, si_code: 1\r\n34138:M 07 Feb 2022 00:37:00.199 # Accessing address: 0x60\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:255.255.255\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:8f277be2a29eba5d\r\nredis_mode:cluster\r\nos:Linux 5.11.0-1028-azure x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:10.3.1\r\nprocess_id:34138\r\nprocess_supervised:no\r\nrun_id:cf5f90bd155049b69e9c336d870161f4e9c77553\r\ntcp_port:30003\r\nserver_time_usec:1644194220199170\r\nuptime_in_seconds:71\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:27052\r\nexecutable:/__w/redis/redis/src/redis-server\r\nconfig_file:/__w/redis/redis/tests/cluster/tmp/redis_3/redis.conf\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:3\r\ncluster_connections:38\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:20480\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:2367688\r\nused_memory_human:2.26M\r\nused_memory_rss:11137024\r\nused_memory_rss_human:10.62M\r\nused_memory_peak:4033560\r\nused_memory_peak_human:3.85M\r\nused_memory_peak_perc:58.70%\r\nused_memory_overhead:1742892\r\nused_memory_startup:1605360\r\nused_memory_dataset:624796\r\nused_memory_dataset_perc:81.96%\r\nallocator_allocated:2813736\r\nallocator_active:3575808\r\nallocator_resident:6774784\r\ntotal_system_memory:7284850688\r\ntotal_system_memory_human:6.78G\r\nused_memory_lua:37888\r\nused_memory_vm_eval:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:37888\r\nused_memory_vm_total:75776\r\nused_memory_vm_total_human:74.00K\r\nused_memory_functions:184\r\nused_memory_scripts:184\r\nused_memory_scripts_human:184B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.27\r\nallocator_frag_bytes:762072\r\nallocator_rss_ratio:1.89\r\nallocator_rss_bytes:3198976\r\nrss_overhead_ratio:1.64\r\nrss_overhead_bytes:43[622](https://github.com/redis/redis/runs/5086511859?check_suite_focus=true#step:10:622)40\r\nmem_fragmentation_ratio:4.53\r\nmem_fragmentation_bytes:8676840\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:20508\r\nmem_total_replication_buffers:20504\r\nmem_clients_slaves:0\r\nmem_clients_normal:82024\r\nmem_cluster_links:34816\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.2.1\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:53588\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1644194220\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:0\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:843776\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:12\r\ntotal_commands_processed:10811\r\ninstantaneous_ops_per_sec:32\r\ntotal_net_input_bytes:508789\r\ntotal_net_output_bytes:3837515\r\ninstantaneous_input_kbps:0.93\r\ninstantaneous_output_kbps:82.48\r\nrejected_connections:0\r\nsync_full:8\r\nsync_partial_ok:0\r\nsync_partial_err:8\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:10033\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:347\r\ntotal_forks:8\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:2\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:10824\r\ntotal_writes_processed:10822\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:3\r\nslave0:ip=127.0.0.1,port=30006,state=online,offset=1750,lag=0\r\nslave1:ip=127.0.0.1,port=30009,state=online,offset=1750,lag=0\r\nslave2:ip=127.0.0.1,port=30012,state=online,offset=1750,lag=0\r\nmaster_failover_state:no-failover\r\nmaster_replid:4a14654723b80174103446549afb7cc15a958e18\r\nmaster_replid2:39d1abe60180ab5e269a2a2263bdb5f5ebc66dd7\r\nmaster_repl_offset:1791\r\nsecond_repl_offset:1751\r\nrepl_backlog_active:1\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:1603\r\nrepl_backlog_histlen:189\r\n\r\n# CPU\r\nused_cpu_sys:0.392418\r\nused_cpu_user:0.718756\r\nused_cpu_sys_children:0.006688\r\nused_cpu_user_children:0.011559\r\nused_cpu_sys_main_thread:0.389122\r\nused_cpu_user_main_thread:0.719151\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_replconf:calls=74,usec=596,usec_per_call=8.05,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|meet:calls=2,usec=21,usec_per_call=10.50,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|addslots:calls=1,usec=207,usec_per_call=207.00,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|reset:calls=2,usec=7618,usec_per_call=3809.00,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|replicate:calls=1,usec=251,usec_per_call=251.00,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|info:calls=16,usec=981,usec_per_call=61.31,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|set-config-epoch:calls=2,usec=61,usec_per_call=30.50,rejected_calls=0,failed_calls=0\r\ncmdstat_cluster|nodes:calls=39,usec=5071,usec_per_call=130.03,rejected_calls=0,failed_calls=0\r\ncmdstat_debug:calls=3,usec=197092,usec_per_call=65697.34,rejected_calls=0,failed_calls=0\r\ncmdstat_config|set:calls=13,usec=51,usec_per_call=3.92,rejected_calls=0,failed_calls=0\r\ncmdstat_config|rewrite:calls=2,usec=8593,usec_per_call=4296.50,rejected_calls=0,failed_calls=0\r\ncmdstat_exec:calls=2,usec=7704,usec_per_call=3852.00,rejected_calls=0,failed_calls=0\r\ncmdstat_role:calls=17,usec=141,usec_per_call=8.29,rejected_calls=0,failed_calls=0\r\ncmdstat_set:calls=26,usec=95,usec_per_call=3.65,rejected_calls=0,failed_calls=0\r\ncmdstat_flushall:calls=3,usec=8365,usec_per_call=2788.33,rejected_calls=0,failed_calls=0\r\ncmdstat_info:calls=552,usec=[623](https://github.com/redis/redis/runs/5086511859?check_suite_focus=true#step:10:623)67,usec_per_call=112.98,rejected_calls=0,failed_calls=0\r\ncmdstat_lrange:calls=10033,usec=25226,usec_per_call=2.51,rejected_calls=0,failed_calls=0\r\ncmdstat_ping:calls=12,usec=8,usec_per_call=0.67,rejected_calls=2,failed_calls=0\r\ncmdstat_multi:calls=3,usec=2,usec_per_call=0.67,rejected_calls=0,failed_calls=0\r\ncmdstat_psync:calls=8,usec=3137,usec_per_call=392.12,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\nerrorstat_LOADING:count=2\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_replconf:p50=1.003,p99=129.023,p99.9=168.959\r\nlatency_percentiles_usec_cluster|meet:p50=10.047,p99=11.007,p99.9=11.007\r\nlatency_percentiles_usec_cluster|addslots:p50=207.871,p99=207.871,p99.9=207.871\r\nlatency_percentiles_usec_cluster|reset:p50=3686.399,p99=3948.543,p99.9=3948.543\r\nlatency_percentiles_usec_cluster|replicate:p50=251.903,p99=251.903,p99.9=251.903\r\nlatency_percentiles_usec_cluster|info:p50=63.231,p99=77.311,p99.9=77.311\r\nlatency_percentiles_usec_cluster|set-config-epoch:p50=30.079,p99=31.103,p99.9=31.103\r\nlatency_percentiles_usec_cluster|nodes:p50=105.471,p99=897.023,p99.9=897.023\r\nlatency_percentiles_usec_debug:p50=2.007,p99=197132.287,p99.9=197132.287\r\nlatency_percentiles_usec_config|set:p50=3.007,p99=11.007,p99.9=11.007\r\nlatency_percentiles_usec_config|rewrite:p50=1318.911,p99=7307.263,p99.9=7307.263\r\nlatency_percentiles_usec_exec:p50=3735.551,p99=3981.311,p99.9=3981.311\r\nlatency_percentiles_usec_role:p50=7.007,p99=23.039,p99.9=23.039\r\nlatency_percentiles_usec_set:p50=4.015,p99=8.031,p99.9=8.031\r\nlatency_percentiles_usec_flushall:p50=1351.679,p99=6029.311,p99.9=6029.311\r\nlatency_percentiles_usec_info:p50=112.127,p99=141.311,p99.9=190.463\r\nlatency_percentiles_usec_lrange:p50=2.007,p99=5.023,p99.9=15.039\r\nlatency_percentiles_usec_ping:p50=1.003,p99=1.003,p99.9=1.003\r\nlatency_percentiles_usec_multi:p50=1.003,p99=1.003,p99.9=1.003\r\nlatency_percentiles_usec_psync:p50=460.799,p99=581.[631](https://github.com/redis/redis/runs/5086511859?check_suite_focus=true#step:10:631),p99.9=581.631\r\n\r\n# Cluster\r\ncluster_enabled:1\r\n\r\n# Keyspace\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=16 addr=127.0.0.1:40062 laddr=127.0.0.1:30003 fd=44 name= age=0 idle=0 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 obl=0 oll=1 omem=20504 tot-mem=61464 events=r cmd=replconf user=default redir=-1 resp=2\r\nid=17 addr=127.0.0.1:40102 laddr=127.0.0.1:30003 fd=49 name= age=0 idle=0 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 obl=0 oll=1 omem=20504 tot-mem=61464 events=r cmd=replconf user=default redir=-1 resp=2\r\nid=6 addr=127.0.0.1:40481 laddr=127.0.0.1:30003 fd=12 name= age=71 idle=0 flags=x db=0 sub=0 psub=0 multi=2 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=88 obl=9 oll=0 omem=0 tot-mem=41048 events=r cmd=cluster|set-config-epoch user=default redir=-1 resp=2\r\nid=8 addr=127.0.0.1:39[699](https://github.com/redis/redis/runs/5086511859?check_suite_focus=true#step:10:699) laddr=127.0.0.1:30003 fd=52 name= age=67 idle=62 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 multi-mem=0 obl=0 oll=0 omem=0 tot-mem=20488 events=r cmd=lrange user=default redir=-1 resp=2\r\nid=11 addr=127.0.0.1:33449 laddr=127.0.0.1:30003 fd=53 name= age=53 idle=53 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 multi-mem=0 obl=0 oll=0 omem=0 tot-mem=20488 events=r cmd=set user=default redir=-1 resp=2\r\nid=15 addr=127.0.0.1:39952 laddr=127.0.0.1:30003 fd=36 name= age=1 idle=0 flags=S db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=20474 argv-mem=0 multi-mem=0 obl=0 oll=1 omem=20504 tot-mem=61464 events=r cmd=replconf user=default redir=-1 resp=2\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nio-threads-do-reads no\r\nlazyfree-lazy-eviction no\r\nlazyfree-lazy-expire no\r\nlazyfree-lazy-server-del no\r\nlazyfree-lazy-user-del no\r\nlazyfree-lazy-user-flush no\r\nrepl-diskless-sync yes\r\nreplica-read-only yes\r\nactivedefrag no\r\nrepl-diskless-load disabled\r\nsanitize-dump-payload no\r\nio-threads 1\r\nlist-compress-depth 0\r\nproto-max-bulk-len 512mb\r\nclient-query-buffer-limit 1gb\r\n```"
    },
    {
      "id": 1031461249,
      "user": "oranagra",
      "created_at": "2022-02-07T13:19:08Z",
      "body": "Looking at the above crashes, the current_client seems to be NULL in both cases (the `CURRENT CLIENT INFO` section is missing).\r\n\r\nI see that in the above crash logs (redis 9 and redis 3), in one case the master has just 1 slave, and in the other there are 3.\r\nwhen i run these tests locally, and print the number of slaves each master has at that point in time, i get 5 for all 3 masters.\r\nso i think it's safe to conclude that the released client is a slave, which means the command must have been a REPLCONF ACK.\r\n\r\nupdateSlavesWaitingBgsave has a couple of calls to freeClient (freeing the slave), and it is called from the done handler that's called from checkChildrenDone, which is used in replconfCommand, so could be called from REPLCONF ACK and then crash on its way out."
    }
  ]
}