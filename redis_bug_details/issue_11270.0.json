{
  "issue_number": 11270.0,
  "title": "[CRASH] <Redis 4.0.14 crashed by signal: 11>",
  "body": "I am useing redis 4.0.4 with cluster mode, one of the master is down yesterday, so the slave upgrade to master, when  i want to add a new slave for this master, it`s crashed.\r\n```\r\n**Crash report**\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n2220:S 15 Sep 02:39:37.714 # === ASSERTION FAILED OBJECT CONTEXT ===\r\n2220:S 15 Sep 02:39:37.714 # Object type: 0\r\n2220:S 15 Sep 02:39:37.714 # Object encoding: 0\r\n2220:S 15 Sep 02:39:37.714 # Object refcount: 1\r\n2220:S 15 Sep 02:39:37.714 # Object raw string len: 28\r\n2220:S 15 Sep 02:39:37.714 # Object raw string content: \"s:u:r:a:b:k:8976737_11794735\"\r\n2220:S 15 Sep 02:39:37.714 # === ASSERTION FAILED ===\r\n2220:S 15 Sep 02:39:37.714 # ==> db.c:171 'retval == DICT_OK' is not true\r\n2220:S 15 Sep 02:39:37.714 # (forcing SIGSEGV to print the bug report.)\r\n2220:S 15 Sep 02:39:37.714 # Redis 4.0.14 crashed by signal: 11\r\n2220:S 15 Sep 02:39:37.714 # Crashed running the instruction at: 0x466b0a\r\n2220:S 15 Sep 02:39:37.714 # Accessing address: 0xffffffffffffffff\r\n2220:S 15 Sep 02:39:37.714 # Failed assertion: retval == DICT_OK (db.c:171)\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n/usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster](_serverAssert+0x6a)[0x466b0a]\r\n\r\nBacktrace:\r\n/usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster](logStackTrace+0x29)[0x468a39]\r\n/usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster](sigsegvHandler+0xac)[0x4690dc]\r\n/lib64/libpthread.so.0(+0xf630)[0x7f3da2939630]\r\n/usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster](_serverAssert+0x6a)[0x466b0a]\r\n/usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster](dbAdd+0x87)[0x440d97]\r\n/usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster](rdbLoadRio+0x1c8)[0x44b118]\r\n/usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster](rdbLoad+0x3b)[0x44b74b]\r\n/usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster](readSyncBulkPayload+0x2b7)[0x443b67]\r\n/usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster](aeProcessEvents+0x2a0)[0x4267a0]\r\n/usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster](aeMain+0x2b)[0x426a6b]\r\n/usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster](main+0x49f)[0x42386f]\r\n/lib64/libc.so.6(__libc_start_main+0xf5)[0x7f3da257e555]\r\n/usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster][0x423b62]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:4.0.14\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:1cfc14537bf00bcf\r\nredis_mode:cluster\r\nos:Linux 3.10.0-1160.76.1.el7.x86_64 x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:atomic-builtin\r\ngcc_version:4.8.5\r\nprocess_id:2220\r\nrun_id:275401344e3af8464e47239fb583a74a0003d658\r\ntcp_port:7001\r\nuptime_in_seconds:1186\r\nuptime_in_days:0\r\nhz:10\r\nlru_clock:2282507\r\nexecutable:/usr/local/redis-cluster/src/redis-server\r\nconfig_file:/usr/local/redis-cluster/7001/redis.conf\r\n\r\n# Clients\r\nconnected_clients:2\r\nclient_longest_output_list:0\r\nclient_biggest_input_buf:0\r\nblocked_clients:0\r\n\r\n# Memory\r\nused_memory:44134283536\r\nused_memory_human:41.10G\r\nused_memory_rss:4411392\r\nused_memory_rss_human:4.21M\r\nused_memory_peak:44134283536\r\nused_memory_peak_human:41.10G\r\nused_memory_peak_perc:100.01%\r\nused_memory_overhead:20816645332\r\nused_memory_startup:3866824\r\nused_memory_dataset:23317638204\r\nused_memory_dataset_perc:52.84%\r\ntotal_system_memory:134908211200\r\ntotal_system_memory_human:125.64G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nmaxmemory:103079215104\r\nmaxmemory_human:96.00G\r\nmaxmemory_policy:volatile-ttl\r\nmem_fragmentation_ratio:0.00\r\nmem_allocator:jemalloc-4.0.3\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\n\r\n# Persistence\r\nloading:1\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1663226391\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nloading_start_time:1663226891\r\nloading_total_bytes:11150084948\r\nloading_loaded_bytes:11012145151\r\nloading_loaded_perc:98.76\r\nloading_eta_seconds:8\r\n\r\n# Stats\r\ntotal_connections_received:757\r\ntotal_commands_processed:1483\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:11150178591\r\ntotal_net_output_bytes:463805\r\ninstantaneous_input_kbps:111150.88\r\ninstantaneous_output_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nevicted_keys:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\n\r\n# Replication\r\nrole:slave\r\nmaster_host:172.17.0.182\r\nmaster_port:7002\r\nmaster_link_status:down\r\nmaster_last_io_seconds_ago:-1\r\nmaster_sync_in_progress:1\r\nslave_repl_offset:1\r\nmaster_sync_left_bytes:0\r\nmaster_sync_last_io_seconds_ago:686\r\nmaster_link_down_since_seconds:1663227577\r\nslave_priority:100\r\nslave_read_only:1\r\nconnected_slaves:0\r\nmaster_replid:dd2c0b9a66a09df8c74ebb0854c43313e289ad33\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:209715200\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:42.24\r\nused_cpu_user:678.73\r\nused_cpu_sys_children:0.00\r\nused_cpu_user_children:0.00\r\n\r\n# Commandstats\r\ncmdstat_client:calls=320,usec=642,usec_per_call=2.01\r\ncmdstat_cluster:calls=320,usec=139924,usec_per_call=437.26\r\ncmdstat_info:calls=843,usec=10596,usec_per_call=12.57\r\n\r\n# Cluster\r\ncluster_enabled:1\r\n\r\n# Keyspace\r\ndb0:keys=258097577,expires=258075369,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=16 addr=172.17.0.203:43064 fd=21 name= age=1170 idle=41 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=info\r\nid=18 addr=172.17.0.203:43080 fd=23 name= age=1170 idle=1 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=info\r\n\r\n------ REGISTERS ------\r\n2220:S 15 Sep 02:39:37.715 # \r\nRAX:0000000000000000 RBX:00000000000000ab\r\nRCX:00000000009d8260 RDX:0000000000012b60\r\nRDI:00007f3da2923760 RSI:0000000000000000\r\nRBP:00000000004fc52e RSP:00007ffd3aa949f0\r\nR8 :0000000000000001 R9 :00007f3da29237b8\r\nR10:00007f3da29237b8 R11:0000000000000206\r\nR12:00000000004f9cee R13:0000000000000000\r\nR14:0000000000000000 R15:00007ffd3aa94eb0\r\nRIP:0000000000466b0a EFL:0000000000010202\r\nCSGSFS:0000000000000033\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949ff) -> 0000018509907300\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949fe) -> 0000000000000000\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949fd) -> 0000000000000008\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949fc) -> 0000000000000013\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949fb) -> 0000000000000000\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949fa) -> 00007ffd3aa94f40\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949f9) -> 00000183400c4e6b\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949f8) -> 0000000000000000\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949f7) -> 000000000044b118\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949f6) -> 00007f3d9ba48000\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949f5) -> 00007f331b091cf0\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949f4) -> 00000185099073a5\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949f3) -> 0000000000440d97\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949f2) -> 00007f3d9ba48000\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949f1) -> 00007f331b091cf0\r\n2220:S 15 Sep 02:39:37.715 # (00007ffd3aa949f0) -> 00007f33152a48c0\r\n\r\n------ FAST MEMORY TEST ------\r\n2220:S 15 Sep 02:39:37.715 # Bio thread for job type #0 terminated\r\n2220:S 15 Sep 02:39:37.715 # Bio thread for job type #1 terminated\r\n2220:S 15 Sep 02:39:37.715 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 745000 (98304 bytes)\r\n*** Preparing to test memory region 9ca000 (135168 bytes)\r\n*** Preparing to test memory region 7f3315200000 (45170556928 bytes)\r\n*** Preparing to test memory region 7f3d999fe000 (8388608 bytes)\r\n*** Preparing to test memory region 7f3d9a1ff000 (8388608 bytes)\r\n*** Preparing to test memory region 7f3d9aa00000 (16777216 bytes)\r\n*** Preparing to test memory region 7f3d9ba00000 (2097152 bytes)\r\n*** Preparing to test memory region 7f3da2200000 (2097152 bytes)\r\n*** Preparing to test memory region 7f3da2925000 (20480 bytes)\r\n*** Preparing to test memory region 7f3da2b42000 (16384 bytes)\r\n*** Preparing to test memory region 7f3da3262000 (16384 bytes)\r\n*** Preparing to test memory region 7f3da326a000 (8192 bytes)\r\n*** Preparing to test memory region 7f3da326c000 (4096 bytes)\r\n*** Preparing to test memory region 7f3da326f000 (4096 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: _serverAssert (base: 0x466aa0)\r\nModule: /usr/local/redis-cluster/src/redis-server 172.17.0.183:7001 [cluster] (base 0x400000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x466aa0 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n2220:S 15 Sep 02:41:26.388 # dump of function (hexdump of 234 bytes):\r\n41548b054c0a2e004989fc554889f585c05389d37505e8f5fdffffbebe155000bf0300000031c0e8e432fcff4d89e089d94889eabed7155000bf0300000031c0e8cb32fcffbe50065000bf0300000031c04c8925e8092e0048892de9092e00891deb092e00e8a632fcffc60425ffffffff785b5d415cc3660f1f84000000000041544989fc55534883c4808b15c3092e0085d20f84e700000031c0be80065000bf03000000e86632fcff418b94249800000031c0bef2155000bf0300000031ed31dbe84932fcff418b54240831c0be05165000bf03000000e83332fcff418b54243831c0be15165000bf\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n       Please report the crash by opening an issue on github:\r\n\r\n           http://github.com/antirez/redis/issues\r\n\r\n  Suspect RAM error? Use redis-server --test-memory to verify it.\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS is centos 7.9 64 bit\r\n2. Steps to reproduce (if any)\r\n",
  "state": "open",
  "created_at": "2022-09-15T08:00:36Z",
  "updated_at": "2022-11-06T15:59:12Z",
  "closed_at": null,
  "labels": [],
  "comments_data": [
    {
      "id": 1304832404,
      "user": "oranagra",
      "created_at": "2022-11-06T15:59:12Z",
      "body": "looks like somehow, the key `s:u:r:a:b:k:8976737_11794735` exists twice in the rdb.\r\ni don't know how it's possible other than some memory corruption on the master.\r\nif you happen to be able to reproduce it from scratch (on a clean deployment), we can debug it, otherwise, i would suggest upgrading to a more recent version of redis, hoping that whatever caused it is solved (the version you're using is very old)"
    }
  ]
}