{
  "issue_number": 11569.0,
  "title": "[BUG] Redis server starts up with \"Error accepting a client connection: error:1408F10B:SSL routines:ssl3_get_record:wrong version number (conn: fd=9)\"",
  "body": "**Describe the bug**\r\n\r\nRedis server starts up with error \"Error accepting a client connection: error:1408F10B:SSL routines:ssl3_get_record:wrong version number (conn: fd=9)\" in redis.log.\r\n\r\n**To reproduce**\r\nconfiguration related to SSL is as below:\r\n`port 0\r\ntls-port 6379\r\ntls-cert-file /d/d1/jsm/certs/redis.crt\r\ntls-key-file /d/d1/jsm/certs/redis.key\r\ntls-ca-cert-file /d/d1/jsm/certs/ca.crt\r\ntls-auth-clients optional\r\ntls-protocols \"TLSv1.2 TLSv1.3\"\r\ntls-ciphers HIGH:!3DES`\r\n\r\n**Expected behavior**\r\nThe error is unexpected.\r\n\r\n**Additional information**\r\n\r\nNot sure what I missed but same configuration in another environment is working fine.\r\n",
  "state": "open",
  "created_at": "2022-12-02T08:08:52Z",
  "updated_at": "2024-01-30T13:14:21Z",
  "closed_at": null,
  "labels": [
    "state:to-be-closed"
  ],
  "comments_data": [
    {
      "id": 1334888631,
      "user": "duj4",
      "created_at": "2022-12-02T08:11:40Z",
      "body": "From output of \"client list\", the connection is from local and it seems local redis-cli is trying to connect to redis-server."
    },
    {
      "id": 1335817698,
      "user": "hwware",
      "created_at": "2022-12-02T20:37:03Z",
      "body": "Generally, the error \"Error accepting a client connection: error:1408F10B:SSL routines:ssl3_get_record:wrong version number (conn: fd=9)\" happens when one client connects to the redis server without ssl argument, I am not sure why it does not work on one environmentand it works on another environment.\r\n\r\nTry to compile the redis server by: make BUILD_TLS=yes. and follow the steps from https://redis.io/docs/management/security/encryption/ on every seperated environment, Thanks"
    },
    {
      "id": 1336340276,
      "user": "duj4",
      "created_at": "2022-12-04T07:28:42Z",
      "body": "hi @hwware , thanks for you reply. I installed redis 6.2.7 via yum and there is no manual build process in such case, meanwhile I configured the ssl related parameter in the configuration file. I reinstalled redis but issue kept still."
    },
    {
      "id": 1336345453,
      "user": "duj4",
      "created_at": "2022-12-04T08:05:50Z",
      "body": "hi @hwware , once I removed 127.0.0.1 from bind list and left local IP address only, the warning is gone. It seems there might be an unknown connection to the local server.\r\nBtw, how can I check whether the rpm is built with \"BUILD_TLS=yes\"?"
    },
    {
      "id": 1341245880,
      "user": "hwware",
      "created_at": "2022-12-07T16:34:57Z",
      "body": "> hi @hwware , once I removed 127.0.0.1 from bind list and left local IP address only, the warning is gone. It seems there might be an unknown connection to the local server. Btw, how can I check whether the rpm is built with \"BUILD_TLS=yes\"?\r\n\r\nSorry,  I have no exerpiece on non-manual build process, so I do not know how to check whether the rpm is built with \"BUILD_TLS=yes\". I think it should there is a way to build by manual."
    },
    {
      "id": 1343062931,
      "user": "yossigo",
      "created_at": "2022-12-08T17:31:50Z",
      "body": "@duj4 If your Redis package was not built with TLS support, the `tls-port` configuration parameter will not be supported and you'll get an error if you try to use it."
    },
    {
      "id": 1915455567,
      "user": "garry-t",
      "created_at": "2024-01-29T19:56:19Z",
      "body": "Same for me with version `Redis 7.2.4`, `Ubuntu 20.04`, `OpenSSL 1.1.1f`. Redis build with tls support after build run test all passed. Certificates were used self signed, generated by me and also used from script `./utils/gen-test-certs.sh`\r\n\r\n\r\nSame error for sentinel and for redis. \r\n\r\n`11964:M 29 Jan 2024 19:56:28.325 # Error accepting a client connection: error:1408F10B:SSL routines:ssl3_get_record:wrong version number (addr=127.0.0.1:33968 laddr=127.0.0.1:6380)`\r\n\r\n@yossigo Whether you forgot specify in docs important settings or redis in HA mode with TLS doesnt work completely\r\n\r\n\r\nRemoving 127.0.0.1 from bind address didnt help. \r\n\r\nredis.conf\r\n```\r\nport=0\r\n# TLS\r\ntls-port 6380\r\ntcp-backlog 10000\r\ntcp-keepalive 300\r\ntls-auth-clients no\r\ntls-protocols \"TLSv1.2 TLSv1.3\"\r\ntls-cert-file /opt/ssl/redis.crt\r\ntls-key-file  /opt/ssl/redis.key\r\ntls-ca-cert-file /opt/ssl/redis-ca.crt\r\ntls-session-caching yes\r\ntls-session-cache-size 20480\r\n\r\n```\r\n```\r\nredis-cli -h 10.0.0.4 -p 6380 -a <pass> --cacert /opt/ssl/redis-ca.crt --no-auth-warning ping\r\nI/O error\r\nI/O error\r\nError: Connection reset by peer\r\n```"
    },
    {
      "id": 1916822794,
      "user": "garry-t",
      "created_at": "2024-01-30T13:14:20Z",
      "body": "Finally I was able to find all issues: \r\n1.` 11964:M 29 Jan 2024 19:56:28.325 # Error accepting a client connection: error:1408F10B:SSL routines:ssl3_get_record:wrong version number (addr=127.0.0.1:33968 laddr=127.0.0.1:6380)` this errors were related to consul checks was missed `--tls` in redis-cli command. \r\n2. SENTINEL is not inherits TLS config from redis.conf so to make it work need to replicate in sentinel.conf configs from redis.conf \r\n\r\n```\r\n cat /opt/redis-conf/sentinel.conf \r\n# BEGIN ANSIBLE MANAGED BLOCK\r\n# redis-sentinel 7.2.4 configuration file\r\n# sentinel_26380.conf\r\n\r\nsupervised no\r\ndaemonize yes\r\npidfile \"/var/run/redis/redis-sentinel.pid\"\r\nlogfile \"/var/log/redis/redis-sentinel.log\"\r\nloglevel notice\r\ndir \"/opt/redis-server\"\r\nport 0\r\ntls-port 26380\r\nrequirepass \"PASS\"\r\nprotected-mode no\r\nsentinel announce-ip \"IP\"\r\ntls-cert-file \"/opt/ssl/redis.crt\"\r\ntls-key-file \"/opt/ssl/redis.key\"\r\ntls-ca-cert-file \"/opt/ssl/redis-ca.crt\"\r\ntls-auth-clients no\r\ntls-replication yes\r\nsentinel monitor master IP 6380 2\r\nsentinel auth-pass master PASS\r\nsentinel down-after-milliseconds master 5000\r\n\r\nsentinel master-reboot-down-after-period master 5000\r\n# END ANSIBLE MANAGED BLOCK\r\n\r\n```\r\n\r\n3. redis-py connects to sentinel via TLS but function call `discover-master` run via plain TCP.  This still not resolved. "
    }
  ]
}