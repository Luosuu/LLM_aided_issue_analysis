{
  "issue_number": 9251.0,
  "title": "[CRASH] redis crashed all the time, Redis 3.2.4 (00000000/0) 64 bit",
  "body": "**Crash report**\r\n\r\n```\r\n311691:M 19 Jul 10:25:25.310 # Background saving terminated by signal 11\r\n311691:M 19 Jul 10:25:31.014 * 1 changes in 900 seconds. Saving...\r\n311691:M 19 Jul 10:25:31.015 * Background saving started by pid 3762376\r\n3762376:C 19 Jul 10:25:31.018 * DB saved on disk\r\n3762376:C 19 Jul 10:25:31.018 * RDB: 2 MB of memory used by copy-on-write\r\n311691:M 19 Jul 10:25:31.115 * Background saving terminated with success\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n311691:M 19 Jul 10:28:56.963 # === ASSERTION FAILED OBJECT CONTEXT ===\r\n311691:M 19 Jul 10:28:56.963 # Object type: 0\r\n311691:M 19 Jul 10:28:56.963 # Object encoding: 8\r\n311691:M 19 Jul 10:28:56.963 # Object refcount: 1\r\n311691:M 19 Jul 10:28:56.963 # Object raw string len: 35\r\n311691:M 19 Jul 10:28:56.963 # Object raw string content: \"user_1161152998606789_cloud_id_info\"\r\n311691:M 19 Jul 10:28:56.963 # === ASSERTION FAILED ===\r\n311691:M 19 Jul 10:28:56.963 # ==> db.c:868 'dictFind(db->dict,key->ptr) != NULL' is not true\r\n311691:M 19 Jul 10:28:56.963 # (forcing SIGSEGV to print the bug report.)\r\n311691:M 19 Jul 10:28:56.963 # Redis 3.2.4 crashed by signal: 11\r\n311691:M 19 Jul 10:28:56.963 # Accessing address: 0xffffffffffffffff\r\n311691:M 19 Jul 10:28:56.964 # Failed assertion: dictFind(db->dict,key->ptr) != NULL (db.c:868)\r\n\r\n------ STACK TRACE ------\r\n/home/kookserver/redis/bin/redis-server 0.0.0.0:63790(logStackTrace+0x50)[0x462910]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:3.2.4\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:f06888ced81f3930\r\nredis_mode:standalone\r\nos:Linux 4.19.90-17.ky10.aarch64 aarch64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\ngcc_version:5.4.0\r\nprocess_id:311691\r\nrun_id:4014956573f9a415d9530a0fb52d5e39afd11057\r\ntcp_port:63790\r\nuptime_in_seconds:247313\r\nuptime_in_days:2\r\nhz:10\r\nlru_clock:16049000\r\nexecutable:/home/kookserver/redis/bin/redis-server\r\nconfig_file:/home/kookserver/redis/etc/redis.conf\r\n\r\n# Clients\r\nconnected_clients:3\r\nclient_longest_output_list:0\r\nclient_biggest_input_buf:0\r\nblocked_clients:0\r\n\r\n# Memory\r\nused_memory:2873584\r\nused_memory_human:2.74M\r\nused_memory_rss:9699328\r\nused_memory_rss_human:9.25M\r\nused_memory_peak:4879136\r\nused_memory_peak_human:4.65M\r\ntotal_system_memory:273689739264\r\ntotal_system_memory_human:254.89G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nmem_fragmentation_ratio:3.38\r\nmem_allocator:jemalloc-4.0.3\r\n\r\n# Persistence\r\nloading:0\r\nrdb_changes_since_last_save:13\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1626661531\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:0\r\nrdb_current_bgsave_time_sec:-1\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\n\r\n# Stats\r\ntotal_connections_received:709787\r\ntotal_commands_processed:2028355\r\ninstantaneous_ops_per_sec:6\r\ntotal_net_input_bytes:76637264\r\ntotal_net_output_bytes:46693496\r\ninstantaneous_input_kbps:0.21\r\ninstantaneous_output_kbps:0.03\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:9983\r\nevicted_keys:0\r\nkeyspace_hits:92877\r\nkeyspace_misses:1243856\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:214\r\nmigrate_cached_sockets:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_repl_offset:0\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:112.54\r\nused_cpu_user:74.11\r\nused_cpu_sys_children:344.23\r\nused_cpu_user_children:3741.68\r\n\r\n# Commandstats\r\ncmdstat_get:calls=771979,usec=1241333,usec_per_call=1.61\r\ncmdstat_set:calls=8586,usec=27148,usec_per_call=3.16\r\ncmdstat_setex:calls=2460,usec=11512,usec_per_call=4.68\r\ncmdstat_del:calls=6397,usec=7004,usec_per_call=1.09\r\ncmdstat_incr:calls=234,usec=937,usec_per_call=4.00\r\ncmdstat_mget:calls=8839,usec=30543,usec_per_call=3.46\r\ncmdstat_lpush:calls=755,usec=3262,usec_per_call=4.32\r\ncmdstat_rpop:calls=18081,usec=40673,usec_per_call=2.25\r\ncmdstat_lpop:calls=1230,usec=1131,usec_per_call=0.92\r\ncmdstat_llen:calls=515132,usec=451803,usec_per_call=0.88\r\ncmdstat_sadd:calls=11,usec=33,usec_per_call=3.00\r\ncmdstat_zadd:calls=3236,usec=24069,usec_per_call=7.44\r\ncmdstat_zrange:calls=10,usec=13,usec_per_call=1.30\r\ncmdstat_hget:calls=2,usec=2,usec_per_call=1.00\r\ncmdstat_select:calls=691307,usec=822086,usec_per_call=1.19\r\ncmdstat_expire:calls=22,usec=99,usec_per_call=4.50\r\ncmdstat_ttl:calls=71,usec=182,usec_per_call=2.56\r\ncmdstat_config:calls=1,usec=7,usec_per_call=7.00\r\ncmdstat_command:calls=2,usec=911,usec_per_call=455.50\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=2602,expires=2298,avg_ttl=212721240\r\ndb1:keys=17,expires=5,avg_ttl=2347257717\r\ndb2:keys=14,expires=4,avg_ttl=2296649039\r\ndb3:keys=19,expires=5,avg_ttl=2273085176\r\ndb4:keys=18,expires=4,avg_ttl=2343561638\r\ndb5:keys=15,expires=4,avg_ttl=2437089339\r\ndb6:keys=25,expires=7,avg_ttl=2275926638\r\ndb7:keys=16,expires=3,avg_ttl=2411884366\r\ndb8:keys=25,expires=8,avg_ttl=1745642452\r\ndb9:keys=14,expires=3,avg_ttl=2412334940\r\ndb10:keys=23,expires=3,avg_ttl=2347739224\r\ndb11:keys=13,expires=3,avg_ttl=2300156961\r\ndb12:keys=14,expires=2,avg_ttl=2477957852\r\ndb13:keys=12,expires=3,avg_ttl=2296784428\r\ndb14:keys=9,expires=1,avg_ttl=2349961100\r\ndb15:keys=315,expires=25,avg_ttl=6592608140\r\nhash_init_value: 1627120110\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=3727 addr=127.0.0.1:37660 fd=13 name= age=246576 idle=2 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=llen\r\nid=709657 addr=127.0.0.1:15552 fd=5 name= age=52 idle=2 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=rpop\r\nid=709788 addr=127.0.0.1:16558 fd=6 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=get\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=709788 addr=127.0.0.1:16558 fd=6 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=get\r\nargv[0]: 'GET'\r\nargv[1]: 'user_1161152998606789_cloud_id_info'\r\n\r\n------ REGISTERS ------\r\n```\r\n",
  "state": "closed",
  "created_at": "2021-07-19T08:26:00Z",
  "updated_at": "2021-09-09T13:19:55Z",
  "closed_at": "2021-09-09T13:19:55Z",
  "labels": [
    "state:to-be-closed"
  ],
  "comments_data": [
    {
      "id": 882397422,
      "user": "oranagra",
      "created_at": "2021-07-19T09:28:18Z",
      "body": "@UnderTreeTech this looks like a dup of #3892\r\nhowever, i can't figure out which commit solved it, possibly Antirez was referring to ed7e33105 which is about unaligned access, and i don't see how it can cause that assertion.\r\ni understand you can reproduce this, can you please try to upgrade to a more recent version?\r\npreferably this can be redis 6.2.x, but even 5.0.x would be enough (the first release that includes that fix)"
    },
    {
      "id": 882417983,
      "user": "UnderTreeTech",
      "created_at": "2021-07-19T10:02:20Z",
      "body": "@oranagra Yet there is another crash, I don't know if it's same as the previous one.\r\n\r\n**Crash report**\r\n\r\n```\r\n3790411:M 07 Jul 12:50:06.364 # Background saving terminated by signal 11\r\n3790411:M 07 Jul 12:50:12.070 * 1 changes in 900 seconds. Saving...\r\n3790411:M 07 Jul 12:50:12.070 * Background saving started by pid 1883553\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n1883553:C 07 Jul 12:50:12.075 # Redis 3.2.4 crashed by signal: 11\r\n1883553:C 07 Jul 12:50:12.075 # Accessing address: 0xffffffffffffffff\r\n1883553:C 07 Jul 12:50:12.075 # Failed assertion: <no assertion failed> (<no file>:0)\r\n\r\n------ STACK TRACE ------\r\nredis-rdb-bgsave 0.0.0.0:63790(logStackTrace+0x50)[0x462910]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:3.2.4\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:f06888ced81f3930\r\nredis_mode:standalone\r\nos:Linux 4.19.90-17.ky10.aarch64 aarch64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\ngcc_version:5.4.0\r\nprocess_id:1883553\r\nrun_id:614d8791a759b6501bd8a8eed527e41d82f84692\r\ntcp_port:63790\r\nuptime_in_seconds:177589\r\nuptime_in_days:2\r\nhz:10\r\nlru_clock:15020676\r\nexecutable:/home/kookserver/redis/bin/redis-server\r\nconfig_file:/home/kookserver/redis/etc/redis.conf\r\n\r\n# Clients\r\nconnected_clients:2\r\nclient_longest_output_list:0\r\nclient_biggest_input_buf:0\r\nblocked_clients:0\r\n\r\n# Memory\r\nused_memory:2279832\r\nused_memory_human:2.17M\r\nused_memory_rss:9699328\r\nused_memory_rss_human:9.25M\r\nused_memory_peak:3775592\r\nused_memory_peak_human:3.60M\r\ntotal_system_memory:273689739264\r\ntotal_system_memory_human:254.89G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nmem_fragmentation_ratio:4.25\r\nmem_allocator:jemalloc-4.0.3\r\n\r\n# Persistence\r\nloading:0\r\nrdb_changes_since_last_save:963\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1625623781\r\nrdb_last_bgsave_status:err\r\nrdb_last_bgsave_time_sec:0\r\nrdb_current_bgsave_time_sec:-1\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\n\r\n# Stats\r\ntotal_connections_received:572907\r\ntotal_commands_processed:1764259\r\ninstantaneous_ops_per_sec:5\r\ntotal_net_input_bytes:77480078\r\ntotal_net_output_bytes:142867610\r\ninstantaneous_input_kbps:0.18\r\ninstantaneous_output_kbps:0.03\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:4629\r\nevicted_keys:0\r\nkeyspace_hits:232531\r\nkeyspace_misses:979558\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:155\r\nmigrate_cached_sockets:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_repl_offset:0\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.00\r\nused_cpu_user:0.00\r\nused_cpu_sys_children:0.00\r\nused_cpu_user_children:0.00\r\n\r\n# Commandstats\r\ncmdstat_get:calls=723966,usec=1318101,usec_per_call=1.82\r\ncmdstat_set:calls=20527,usec=69335,usec_per_call=3.38\r\ncmdstat_setex:calls=7423,usec=35178,usec_per_call=4.74\r\ncmdstat_del:calls=22351,usec=36273,usec_per_call=1.62\r\ncmdstat_incr:calls=1160,usec=2568,usec_per_call=2.21\r\ncmdstat_mget:calls=19713,usec=76203,usec_per_call=3.87\r\ncmdstat_lpush:calls=702,usec=4574,usec_per_call=6.52\r\ncmdstat_rpop:calls=41102,usec=100347,usec_per_call=2.44\r\ncmdstat_lpop:calls=2870,usec=2728,usec_per_call=0.95\r\ncmdstat_llen:calls=372861,usec=410927,usec_per_call=1.10\r\ncmdstat_sadd:calls=8,usec=37,usec_per_call=4.62\r\ncmdstat_smembers:calls=420,usec=205,usec_per_call=0.49\r\ncmdstat_zadd:calls=6816,usec=61951,usec_per_call=9.09\r\ncmdstat_zrange:calls=64,usec=82,usec_per_call=1.28\r\ncmdstat_select:calls=543076,usec=697528,usec_per_call=1.28\r\ncmdstat_expire:calls=48,usec=226,usec_per_call=4.71\r\ncmdstat_keys:calls=1,usec=2858,usec_per_call=2858.00\r\ncmdstat_bgsave:calls=1,usec=257,usec_per_call=257.00\r\ncmdstat_ttl:calls=1137,usec=2027,usec_per_call=1.78\r\ncmdstat_config:calls=1,usec=6,usec_per_call=6.00\r\ncmdstat_command:calls=12,usec=5850,usec_per_call=487.50\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=4000,expires=3876,avg_ttl=110122322\r\ndb1:keys=10,expires=3,avg_ttl=2080292614\r\ndb2:keys=7,expires=3,avg_ttl=2269308100\r\ndb3:keys=4,expires=1,avg_ttl=2588190100\r\ndb4:keys=2,expires=1,avg_ttl=2492399750\r\ndb6:keys=8,expires=4,avg_ttl=2168892702\r\ndb7:keys=10,expires=4,avg_ttl=2432485973\r\ndb8:keys=12,expires=6,avg_ttl=2247515100\r\ndb9:keys=5,expires=2,avg_ttl=2556855355\r\ndb10:keys=15,expires=7,avg_ttl=2130602887\r\ndb11:keys=12,expires=4,avg_ttl=2407688042\r\ndb12:keys=15,expires=5,avg_ttl=2184908560\r\ndb13:keys=17,expires=8,avg_ttl=2148599533\r\ndb14:keys=7,expires=2,avg_ttl=2282269898\r\ndb15:keys=175,expires=22,avg_ttl=5853379431\r\nhash_init_value: 1625186169\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=13 addr=127.0.0.1:6422 fd=5 name= age=177584 idle=2 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=llen\r\nid=572892 addr=127.0.0.1:49834 fd=6 name= age=8 idle=3 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=rpop\r\n\r\n------ REGISTERS ------\r\n```"
    },
    {
      "id": 882444780,
      "user": "oranagra",
      "created_at": "2021-07-19T10:44:17Z",
      "body": "could this be due to the kernel bug mention in #8124? if not, it could still be related to the the unaligned access thing, although i would expect a SIGBUS rather than SIGSEGV.\r\nanyway, thanks for sharing, but i'd still like to try to reproduce this on a newer version."
    }
  ]
}