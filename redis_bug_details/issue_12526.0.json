{
  "issue_number": 12526.0,
  "title": "[BUG] used_memory is seemingly incorrect, larger than the server's capacity",
  "body": "**Describe the bug**\r\n\r\nThe used_memory is larger than the true value and the server's capacity. This prevents `maxmemory` configurations from properly functioning.\r\n\r\n**To reproduce**\r\n\r\nNot sure unfortunately, seems to happen randomly.\r\n\r\n**Expected behavior**\r\n\r\nValue to be accurate\r\n\r\n**Additional information**\r\n\r\nI have 8 instances of version 7.2 (compiled from source) running on the same Linux server, each with their own port. They all store hashes and have RediSearch run on each of them with the same index specifications. The server has 32G of memory and 1G swap. Most instances have the right memory usage (~2.93G), but some do not. The high used_memory is causing errors when a `maxmemory` is set.\r\n\r\nThe used_memory balloons higher relatively quickly (within a few hours of normal operation) after restarting the instances, but also randomly. Given the data we have and the usage of the instances, only a few MB of data is added daily to each server and no old hashes are deleted/updated.\r\n\r\nThere are no snapshots and automatic aof rewrites are turned off. Rewrites are triggered manually and were done so when the  data was fully loaded in the first time. Currently, aof incremental files are a few MB in size, for each instance.\r\n\r\n```\r\nfor p in $(seq 6379 6376); do\r\n  redis-cli -p $p info memory | grep used_memory_human\r\ndone\r\n\r\nused_memory_human:2.93G\r\nused_memory_human:2.93G\r\nused_memory_human:74.93G\r\nused_memory_human:2.93G\r\nused_memory_human:18.94G\r\nused_memory_human:2.93G\r\nused_memory_human:2.94G\r\nused_memory_human:10.94G\r\n```\r\n\r\n```\r\nfor p in $(seq 6379 6386); do\r\n  redis-cli -p $p info memory | grep \"used_memory:\"\r\ndone\r\n\r\nused_memory:3148271088\r\nused_memory:3150117232\r\nused_memory:80457651296\r\nused_memory:3147575024\r\nused_memory:20332828416\r\nused_memory:3145739552\r\nused_memory:3155594680\r\nused_memory:11741557472\r\n```\r\n\r\n```\r\nredis-cli -p 6381 info memory\r\n\r\n# Memory\r\nused_memory:80457650272\r\nused_memory_human:74.93G\r\nused_memory_rss:3250946048\r\nused_memory_rss_human:3.03G\r\nused_memory_peak:80457714544\r\nused_memory_peak_human:74.93G\r\nused_memory_peak_perc:100.00%\r\nused_memory_overhead:65090928\r\nused_memory_startup:1037984\r\nused_memory_dataset:80392559344\r\nused_memory_dataset_perc:99.92%\r\nallocator_allocated:80457852024\r\nallocator_active:80492441600\r\nallocator_resident:80591007744\r\ntotal_system_memory:33028308992\r\ntotal_system_memory_human:30.76G\r\nused_memory_lua:31744\r\nused_memory_vm_eval:31744\r\nused_memory_lua_human:31.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:32768\r\nused_memory_vm_total:64512\r\nused_memory_vm_total_human:63.00K\r\nused_memory_functions:184\r\nused_memory_scripts:184\r\nused_memory_scripts_human:184B\r\nmaxmemory:3670016000\r\nmaxmemory_human:3.42G\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.00\r\nallocator_frag_bytes:34589576\r\nallocator_rss_ratio:1.00\r\nallocator_rss_bytes:98566144\r\nrss_overhead_ratio:0.04\r\nrss_overhead_bytes:-77340061696\r\nmem_fragmentation_ratio:0.04\r\nmem_fragmentation_bytes:-77206665816\r\nmem_not_counted_for_evict:8\r\nmem_replication_backlog:0\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:50584\r\nmem_cluster_links:0\r\nmem_aof_buffer:8\r\nmem_allocator:jemalloc-5.3.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n```\r\n\r\n```\r\nps -o rss,%mem,command ax | grep redis-server\r\n\r\n3168452  9.8 /home/ubuntu/redis-7.2.0/src/redis-server *:6379\r\n3170876  9.8 /home/ubuntu/redis-7.2.0/src/redis-server *:6380\r\n3175704  9.8 /home/ubuntu/redis-7.2.0/src/redis-server *:6382\r\n3174868  9.8 /home/ubuntu/redis-7.2.0/src/redis-server *:6384\r\n3182932  9.8 /home/ubuntu/redis-7.2.0/src/redis-server *:6385\r\n3172908  9.8 /home/ubuntu/redis-7.2.0/src/redis-server *:6386\r\n3174752  9.8 /home/ubuntu/redis-7.2.0/src/redis-server *:6381\r\n3179896  9.8 /home/ubuntu/redis-7.2.0/src/redis-server *:6383\r\n```",
  "state": "closed",
  "created_at": "2023-08-29T23:54:56Z",
  "updated_at": "2023-09-01T17:29:31Z",
  "closed_at": "2023-09-01T17:29:31Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1698533185,
      "user": "sundb",
      "created_at": "2023-08-30T05:51:18Z",
      "body": "Could you give the `INFO ALL` output of instance with abnormal memory usage?"
    },
    {
      "id": 1699267268,
      "user": "fast-facts",
      "created_at": "2023-08-30T14:12:25Z",
      "body": "I had to restart the instances and move this to a dev server for testing. I recreated the problem on another server.\r\n\r\nI also discovered that this has to do with RediSearch's ft.aggregate, specifically the below command (note the large MAX argument). It does seem to me that we have a problem on our side with improper arguments that I'll address, but shouldn't this cause consistent behavior amongst all the instances, and not just some of them increasing in memory? The same command is run on all instances concurrently. Is this a better question for the RediSearch github?\r\n\r\n```\r\n\"FT.AGGREGATE\" \"idx\" \"@name:sales*\" \"LOAD\" \"1\" \"@__key\" \"SORTBY\" \"2\" \"@dr\" \"DESC\" \"MAX\" \"1000000000\" \"WITHCURSOR\" \"COUNT\" \"10\"\r\n```\r\n\r\n```\r\nredis-cli -p 6385 info all\r\n\r\n# Server\r\nredis_version:7.2.0\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:4e788b67d7426d9b\r\nredis_mode:standalone\r\nos:Linux 6.2.0-1009-aws aarch64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:11.4.0\r\nprocess_id:602382\r\nprocess_supervised:no\r\nrun_id:de444a2bec6268a78ad372b2412acd64110d0f56\r\ntcp_port:6385\r\nserver_time_usec:1693404347059772\r\nuptime_in_seconds:51280\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:15682747\r\nexecutable:/home/ubuntu/redis-7.2.0/src/redis-server\r\nconfig_file:/home/ubuntu/redis-7.2.0/redis.6385.conf\r\nio_threads_active:0\r\nlistener0:name=tcp,bind=*,bind=-::*,port=6385\r\n\r\n# Clients\r\nconnected_clients:6\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:20480\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\ntotal_blocking_keys:0\r\ntotal_blocking_keys_on_nokey:0\r\n\r\n# Memory\r\nused_memory:63284419952\r\nused_memory_human:58.94G\r\nused_memory_rss:3262771200\r\nused_memory_rss_human:3.04G\r\nused_memory_peak:63284432536\r\nused_memory_peak_human:58.94G\r\nused_memory_peak_perc:100.00%\r\nused_memory_overhead:65132216\r\nused_memory_startup:1037984\r\nused_memory_dataset:63219287736\r\nused_memory_dataset_perc:99.90%\r\nallocator_allocated:63284867160\r\nallocator_active:63324950528\r\nallocator_resident:63417421824\r\ntotal_system_memory:33028308992\r\ntotal_system_memory_human:30.76G\r\nused_memory_lua:31744\r\nused_memory_vm_eval:31744\r\nused_memory_lua_human:31.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:32768\r\nused_memory_vm_total:64512\r\nused_memory_vm_total_human:63.00K\r\nused_memory_functions:184\r\nused_memory_scripts:184\r\nused_memory_scripts_human:184B\r\nmaxmemory:3670016000\r\nmaxmemory_human:3.42G\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.00\r\nallocator_frag_bytes:40083368\r\nallocator_rss_ratio:1.00\r\nallocator_rss_bytes:92471296\r\nrss_overhead_ratio:0.05\r\nrss_overhead_bytes:-60154650624\r\nmem_fragmentation_ratio:0.05\r\nmem_fragmentation_bytes:-60021608584\r\nmem_not_counted_for_evict:8\r\nmem_replication_backlog:0\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:57752\r\nmem_cluster_links:0\r\nmem_aof_buffer:8\r\nmem_allocator:jemalloc-5.3.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:1586730\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1693353067\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:1180682\r\naof_enabled:1\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_rewrites_consecutive_failures:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\naof_current_size:545760562\r\naof_base_size:461764482\r\naof_pending_rewrite:0\r\naof_buffer_length:0\r\naof_pending_bio_fsync:0\r\naof_delayed_fsync:0\r\n\r\n# Stats\r\ntotal_connections_received:24126\r\ntotal_commands_processed:472872\r\ninstantaneous_ops_per_sec:9\r\ntotal_net_input_bytes:86228532\r\ntotal_net_output_bytes:400113401\r\ntotal_net_repl_input_bytes:0\r\ntotal_net_repl_output_bytes:0\r\ninstantaneous_input_kbps:0.15\r\ninstantaneous_output_kbps:10.12\r\ninstantaneous_input_repl_kbps:0.00\r\ninstantaneous_output_repl_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:328\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:206407\r\ncurrent_eviction_exceeded_time:206407\r\nkeyspace_hits:2488157\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\npubsubshard_channels:0\r\nlatest_fork_usec:58938\r\ntotal_forks:49\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:1829\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:399761\r\ntotal_writes_processed:374395\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:9372\r\nreply_buffer_expands:27685\r\neventloop_cycles:934292\r\neventloop_duration_sum:75246598\r\neventloop_duration_cmd_sum:26449189\r\ninstantaneous_eventloop_cycles_per_sec:19\r\ninstantaneous_eventloop_duration_usec:68\r\nacl_access_denied_auth:0\r\nacl_access_denied_cmd:0\r\nacl_access_denied_key:0\r\nacl_access_denied_channel:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:d2c7c76339e739a4f9c8d49e25e04edbc7107868\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:122807\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:52.920681\r\nused_cpu_user:136.129445\r\nused_cpu_sys_children:39.389500\r\nused_cpu_user_children:559.916304\r\nused_cpu_sys_main_thread:28.435854\r\nused_cpu_user_main_thread:126.717824\r\n\r\n# Modules\r\nmodule:name=search,ver=20804,api=1,filters=0,usedby=[],using=[],options=[]\r\n\r\n# Commandstats\r\ncmdstat_FT.INFO:calls=205,usec=19337,usec_per_call=94.33,rejected_calls=0,failed_calls=0\r\ncmdstat_config|get:calls=1,usec=3,usec_per_call=3.00,rejected_calls=0,failed_calls=0\r\ncmdstat_info:calls=75358,usec=7469391,usec_per_call=99.12,rejected_calls=0,failed_calls=0\r\ncmdstat_FT.AGGREGATE:calls=19,usec=5052,usec_per_call=265.89,rejected_calls=0,failed_calls=0\r\ncmdstat_hset:calls=122397,usec=18588519,usec_per_call=151.87,rejected_calls=0,failed_calls=0\r\ncmdstat_FT.SEARCH:calls=3,usec=46882,usec_per_call=15627.33,rejected_calls=0,failed_calls=0\r\ncmdstat_monitor:calls=1,usec=1,usec_per_call=1.00,rejected_calls=0,failed_calls=0\r\ncmdstat_ping:calls=256035,usec=75497,usec_per_call=0.29,rejected_calls=200,failed_calls=0\r\ncmdstat_multi:calls=205,usec=395,usec_per_call=1.93,rejected_calls=0,failed_calls=0\r\ncmdstat_dbsize:calls=14046,usec=9458,usec_per_call=0.67,rejected_calls=1629,failed_calls=0\r\ncmdstat_exec:calls=205,usec=18823195,usec_per_call=91820.47,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\nerrorstat_LOADING:count=1829\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_FT.INFO:p50=87.039,p99=198.655,p99.9=249.855\r\nlatency_percentiles_usec_config|get:p50=3.007,p99=3.007,p99.9=3.007\r\nlatency_percentiles_usec_info:p50=132.095,p99=161.791,p99.9=413.695\r\nlatency_percentiles_usec_FT.AGGREGATE:p50=249.855,p99=524.287,p99.9=524.287\r\nlatency_percentiles_usec_hset:p50=97.279,p99=720.895,p99.9=2392.063\r\nlatency_percentiles_usec_FT.SEARCH:p50=15335.423,p99=31195.135,p99.9=31195.135\r\nlatency_percentiles_usec_monitor:p50=1.003,p99=1.003,p99.9=1.003\r\nlatency_percentiles_usec_ping:p50=0.001,p99=1.003,p99.9=1.003\r\nlatency_percentiles_usec_multi:p50=1.003,p99=14.015,p99.9=17.023\r\nlatency_percentiles_usec_dbsize:p50=1.003,p99=3.007,p99.9=12.031\r\nlatency_percentiles_usec_exec:p50=88080.383,p99=217055.231,p99.9=249561.087\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=1181476,expires=0,avg_ttl=0\r\n```"
    },
    {
      "id": 1703096385,
      "user": "madolson",
      "created_at": "2023-09-01T17:29:15Z",
      "body": "Yes, you should open the issue here then: https://github.com/RediSearch/RediSearch"
    }
  ]
}