{
  "issue_number": 11868.0,
  "title": "[BUG] [err]: Active defrag in tests/unit/memefficiency.tcl",
  "body": "**Describe the bug**\r\nOne test fail\r\n\r\nA short description of the bug.\r\nTesting solo test\r\n[err]: Active defrag in tests/unit/memefficiency.tcl\r\nExpected 38 <= 30 (context: type eval line 113 cmd {assert {$max_latency <= 30}} proc ::test)\r\n\r\n**To reproduce**\r\nTry Make test on last version (wget https://download.redis.io/redis-stable.tar.gz) with tcl8.6\r\n\r\n**Expected behavior**\r\nPass\r\n\r\n**Additional information**\r\n\r\n[84/84 done]: unit/maxmemory (377 seconds)\r\nTesting solo test\r\n[ignore]: Test LPUSH and LPOP on plain nodes over 4GB: large memory flag not provided\r\n[ignore]: Test LINDEX and LINSERT on plain nodes over 4GB: large memory flag not provided\r\n[ignore]: Test LTRIM on plain nodes over 4GB: large memory flag not provided\r\n[ignore]: Test LREM on plain nodes over 4GB: large memory flag not provided\r\n[ignore]: Test LSET on plain nodes over 4GB: large memory flag not provided\r\n[ignore]: Test LMOVE on plain nodes over 4GB: large memory flag not provided\r\n[84/84 done]: list-large-memory (0 seconds)\r\nTesting solo test\r\n[ignore]: SADD, SCARD, SISMEMBER - large data: large memory flag not provided\r\n[84/84 done]: set-large-memory (1 seconds)\r\nTesting solo test\r\n[ignore]: BIT pos larger than UINT_MAX: large memory flag not provided\r\n[ignore]: SETBIT values larger than UINT32_MAX and lzf_compress/lzf_decompress correctly: large memory flag not provided\r\n[84/84 done]: bitops-large-memory (0 seconds)\r\nTesting solo test\r\n[ignore]: XADD one huge field: large memory flag not provided\r\n[ignore]: XADD one huge field - 1: large memory flag not provided\r\n[ignore]: several XADD big fields: large memory flag not provided\r\n[ignore]: single XADD big fields: large memory flag not provided\r\n[ignore]: hash with many big fields: large memory flag not provided\r\n[ignore]: hash with one huge field: large memory flag not provided\r\n[84/84 done]: violations (2 seconds)\r\nTesting solo test\r\n[err]: Active defrag in tests/unit/memefficiency.tcl\r\nExpected 38 <= 30 (context: type eval line 113 cmd {assert {$max_latency <= 30}} proc ::test)\r\n[ok]: Active defrag eval scripts (11348 ms)\r\n[ok]: Active defrag big keys (74509 ms)\r\n[ok]: Active defrag big list (64162 ms)\r\n[ok]: Active defrag edge case (91244 ms)\r\n[84/84 done]: defrag (328 seconds)\r\n\r\n                   The End\r\n\r\nExecution time of different units:\r\n  1 seconds - unit/info-command\r\n  1 seconds - unit/printver\r\n  2 seconds - unit/type/incr\r\n  4 seconds - unit/info\r\n  5 seconds - unit/auth\r\n  6 seconds - unit/keyspace\r\n  8 seconds - unit/protocol\r\n  1 seconds - unit/quit\r\n  11 seconds - unit/type/stream-cgroups\r\n  8 seconds - unit/multi\r\n  3 seconds - unit/acl-v2\r\n  11 seconds - unit/acl\r\n  20 seconds - unit/expire\r\n  31 seconds - unit/type/list\r\n  29 seconds - integration/block-repl\r\n  66 seconds - unit/aofrw\r\n  87 seconds - unit/type/hash\r\n  90 seconds - unit/scan\r\n  103 seconds - unit/type/string\r\n  103 seconds - unit/other\r\n  118 seconds - unit/type/set\r\n  77 seconds - integration/replication-3\r\n  128 seconds - unit/sort\r\n  132 seconds - unit/dump\r\n  48 seconds - integration/shutdown\r\n  22 seconds - integration/corrupt-dump-fuzzer\r\n  5 seconds - integration/convert-zipmap-hash-on-load\r\n  2 seconds - integration/convert-ziplist-hash-on-load\r\n  39 seconds - integration/aof-multi-part\r\n  3 seconds - integration/convert-ziplist-zset-on-load\r\n  4 seconds - integration/logging\r\n  137 seconds - integration/replication-2\r\n  25 seconds - integration/psync2-pingoff\r\n  27 seconds - integration/psync2-reg\r\n  65 seconds - integration/rdb\r\n  10 seconds - integration/failover\r\n  32 seconds - integration/psync2-master-restart\r\n  3 seconds - unit/pubsub\r\n  48 seconds - integration/psync2\r\n  10 seconds - integration/dismiss-mem\r\n  11 seconds - integration/redis-benchmark\r\n  3 seconds - unit/pubsubshard\r\n  3 seconds - unit/slowlog\r\n  86 seconds - integration/corrupt-dump\r\n  11 seconds - unit/functions\r\n  218 seconds - unit/type/list-3\r\n  2 seconds - unit/limits\r\n  131 seconds - integration/replication-buffer\r\n  7 seconds - unit/introspection-2\r\n  211 seconds - unit/latency-monitor\r\n  12 seconds - unit/bitfield\r\n  52 seconds - unit/introspection\r\n  50 seconds - unit/bitops\r\n  162 seconds - integration/aof\r\n  13 seconds - unit/lazyfree\r\n  5 seconds - unit/wait\r\n  3 seconds - unit/pause\r\n  1 seconds - unit/tls\r\n  4 seconds - unit/querybuf\r\n  5 seconds - unit/tracking\r\n  3 seconds - unit/oom-score-adj\r\n  3 seconds - unit/shutdown\r\n  8 seconds - unit/networking\r\n  86 seconds - unit/scripting\r\n  1 seconds - unit/violations\r\n  2 seconds - unit/replybufsize\r\n  3 seconds - unit/cluster-scripting\r\n  70 seconds - unit/memefficiency\r\n  6 seconds - unit/cluster/misc\r\n  6 seconds - unit/cluster/links\r\n  307 seconds - unit/type/list-2\r\n  128 seconds - integration/redis-cli\r\n  34 seconds - unit/cluster\r\n  317 seconds - unit/type/zset\r\n  237 seconds - integration/replication-psync\r\n  64 seconds - unit/pendingquerybuf\r\n  132 seconds - unit/obuf-limits\r\n  277 seconds - integration/replication-4\r\n  69 seconds - unit/client-eviction\r\n  365 seconds - unit/type/stream\r\n  169 seconds - unit/hyperloglog\r\n  306 seconds - unit/geo\r\n  559 seconds - integration/replication\r\n  377 seconds - unit/maxmemory\r\n  0 seconds - list-large-memory\r\n  1 seconds - set-large-memory\r\n  0 seconds - bitops-large-memory\r\n  2 seconds - violations\r\n  328 seconds - defrag\r\n\r\n!!! WARNING The following tests failed:\r\n\r\n*** [err]: Active defrag in tests/unit/memefficiency.tcl\r\nExpected 38 <= 30 (context: type eval line 113 cmd {assert {$max_latency <= 30}} proc ::test)\r\nCleanup: may take some time... OK\r\nmake[1]: *** [Makefile:427: test] Error 1\r\nmake[1]: Leaving directory '/down-redis/redis-stable/src'\r\nmake: *** [Makefile:6: test] Error 2",
  "state": "closed",
  "created_at": "2023-03-01T12:22:21Z",
  "updated_at": "2023-03-04T10:54:38Z",
  "closed_at": "2023-03-04T10:54:38Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1450301102,
      "user": "enjoy-binbin",
      "created_at": "2023-03-01T15:04:32Z",
      "body": "@rnek0 thanks for the report, this is a timing issue, for now you can just ignore it. Can you tell us the os, the system architecture\r\n\r\n@oranagra  I often see this failure on my Daily. In most cases, it failed in test-ubuntu-32bit (the AOF loading one), with the range in (31, 40), not sure why. do you think we need to update the threshold? "
    },
    {
      "id": 1451359849,
      "user": "oranagra",
      "created_at": "2023-03-02T06:21:24Z",
      "body": "well, it says:\r\n```\r\n                # due to high fragmentation, 100hz, and active-defrag-cycle-max set to 75,\r\n                # we expect max latency to be not much higher than 7.5ms but due to rare slowness threshold is set higher\r\n```\r\nbut considering the test machines are sometimes slow, and all sort of quirks could happen (which do not indicate a bug), and we've already set to 30, i suppose we can set it a little bit higher "
    },
    {
      "id": 1451535144,
      "user": "rnek0",
      "created_at": "2023-03-02T09:10:31Z",
      "body": "This is a small vm : \r\n\r\n> Debian GNU/Linux 11 (bullseye)  \r\n> \r\n> cat /etc/debian_version  \r\n11.6  \r\n\r\n> One proc  \r\n> cat /proc/cpuinfo | grep \"physical id\" | sort | uniq | wc -l  \r\n1  \r\n\r\n> One core  \r\n> cat /proc/cpuinfo | grep  proc | wc -l  \r\n1\r\n\r\n> lscpu | grep Architecture  \r\nArchitecture:                    x86_64   \r\n\r\nI had connection problems after installing with make install, so I took the maintainer version as indicated here:\r\n\r\n<https://redis.io/docs/getting-started/installation/install-redis-on-linux/>\r\n\r\nAfter that everything seems to be working fine.  \r\nIndeed it's more an indication for your tests than a real bug, the compilation ended well.\r\n\r\nthank you for your work\r\n\r\n"
    }
  ]
}