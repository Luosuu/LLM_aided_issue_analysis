{
  "issue_number": 12560.0,
  "title": "[CRASH] Redis OOM crash when memory is enough",
  "body": "**Crash report**\r\nAlways crash when query the redis with high multi-get load,  used_memory_human:6.64G\r\n\r\nWhen crashed , I restart from dump.db, but when query comes, crash again\r\n\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n8:M 07 Sep 2023 16:04:22.982 # ------------------------------------------------\r\n8:M 07 Sep 2023 16:04:22.982 # !!! Software Failure. Press left mouse button to continue\r\n8:M 07 Sep 2023 16:04:22.982 # Guru Meditation: Redis aborting for OUT OF MEMORY. Allocating 18446744004990074880 bytes! #server.c:6037\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n/opt/redis-stack/bin/redis-server *:6379(redisOutOfMemoryHandler+0x2f)[0x560cec8be20f]\r\n/opt/redis-stack/bin/redis-server *:6379(zcalloc+0x2e)[0x560cec8cba0e]\r\n/opt/redis-stack/lib/redisearch.so(RSIndexResult_IterateOffsets+0xf7)[0x7faab73991a7]\r\n/opt/redis-stack/lib/redisearch.so(RSIndexResult_IterateOffsets+0x159)[0x7faab7399209]\r\n/opt/redis-stack/lib/redisearch.so(RSIndexResult_IterateOffsets+0x159)[0x7faab7399209]\r\n/opt/redis-stack/lib/redisearch.so(IndexResult_MinOffsetDelta+0x10a)[0x7faab7388a6a]\r\n/opt/redis-stack/lib/redisearch.so(+0xcd51a)[0x7faab737751a]\r\n/opt/redis-stack/lib/redisearch.so(+0x105119)[0x7faab73af119]\r\n/opt/redis-stack/lib/redisearch.so(+0x1051f7)[0x7faab73af1f7]\r\n/opt/redis-stack/lib/redisearch.so(+0x104cba)[0x7faab73aecba]\r\n/opt/redis-stack/lib/redisearch.so(sendChunk+0xa6)[0x7faab734f906]\r\n/opt/redis-stack/lib/redisearch.so(AREQ_Execute+0x1d)[0x7faab735005d]\r\n/opt/redis-stack/lib/redisearch.so(RSSearchCommand+0xec)[0x7faab735086c]\r\n/opt/redis-stack/bin/redis-server *:6379(RedisModuleCommandDispatcher+0x67)[0x560cec950417]\r\n/opt/redis-stack/bin/redis-server *:6379(call+0xf0)[0x560cec8c1940]\r\n/opt/redis-stack/bin/redis-server *:6379(processCommand+0x643)[0x560cec8c3643]\r\n/opt/redis-stack/bin/redis-server *:6379(processCommandAndResetClient+0x20)[0x560cec8d6d20]\r\n/opt/redis-stack/bin/redis-server *:6379(processInputBuffer+0xea)[0x560cec8d967a]\r\n/opt/redis-stack/bin/redis-server *:6379(+0x1018ac)[0x560cec9728ac]\r\n/opt/redis-stack/bin/redis-server *:6379(aeProcessEvents+0x2ca)[0x560cec8b9e6a]\r\n/opt/redis-stack/bin/redis-server *:6379(aeMain+0x1d)[0x560cec8ba0fd]\r\n/opt/redis-stack/bin/redis-server *:6379(main+0x33a)[0x560cec8b650a]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf3)[0x7faab7fa2083]\r\n/opt/redis-stack/bin/redis-server *:6379(_start+0x2e)[0x560cec8b6a0e]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:6.2.12\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:4dbc2487343b0024\r\nredis_mode:standalone\r\nos:Linux 5.4.119-19-0009.11 x86_64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:9.4.0\r\nprocess_id:8\r\nprocess_supervised:no\r\nrun_id:874b72d4cc4811fb370b07e4ed6c2dc3080afd35\r\ntcp_port:6379\r\nserver_time_usec:1694102662954728\r\nuptime_in_seconds:179\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:16381062\r\nexecutable:/opt/redis-stack/bin/redis-server\r\nconfig_file:\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:2\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:24\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:7127339936\r\nused_memory_human:6.64G\r\nused_memory_rss:7058096128\r\nused_memory_rss_human:6.57G\r\nused_memory_peak:7127339936\r\nused_memory_peak_human:6.64G\r\nused_memory_peak_perc:100.00%\r\nused_memory_overhead:25248064\r\nused_memory_startup:1014560\r\nused_memory_dataset:7102091872\r\nused_memory_dataset_perc:99.66%\r\nallocator_allocated:7127313984\r\nallocator_active:7749009408\r\nallocator_resident:7816982528\r\ntotal_system_memory:16512040960\r\ntotal_system_memory_human:15.38G\r\nused_memory_lua:30720\r\nused_memory_lua_human:30.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.09\r\nallocator_frag_bytes:621695424\r\nallocator_rss_ratio:1.01\r\nallocator_rss_bytes:67973120\r\nrss_overhead_ratio:0.90\r\nrss_overhead_bytes:-758886400\r\nmem_fragmentation_ratio:0.99\r\nmem_fragmentation_bytes:-69044232\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:41008\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.1.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1694102483\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:2\r\ntotal_commands_processed:6\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:13114\r\ntotal_net_output_bytes:144236\r\ninstantaneous_input_kbps:0.02\r\ninstantaneous_output_kbps:20.85\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:6\r\nevicted_keys:0\r\nkeyspace_hits:1549796\r\nkeyspace_misses:178\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:5\r\ntotal_writes_processed:4\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:4a43287fb0b0b760d5e51efd79701a5911ab3e19\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:3.116882\r\nused_cpu_user:85.621699\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:3.044607\r\nused_cpu_user_main_thread:85.613195\r\n\r\n# Modules\r\nmodule:name=graph,ver=21010,api=1,filters=0,usedby=[],using=[ReJSON],options=[]\r\nmodule:name=search,ver=20609,api=1,filters=0,usedby=[],using=[ReJSON],options=[handle-io-errors]\r\nmodule:name=ReJSON,ver=20407,api=1,filters=0,usedby=[search|graph],using=[],options=[handle-io-errors]\r\nmodule:name=timeseries,ver=10810,api=1,filters=0,usedby=[],using=[],options=[handle-io-errors]\r\nmodule:name=bf,ver=20405,api=1,filters=0,usedby=[],using=[],options=[]\r\n\r\n# Commandstats\r\ncmdstat_FT.SEARCH:calls=1,usec=269,usec_per_call=269.00,rejected_calls=0,failed_calls=0\r\ncmdstat_get:calls=2,usec=61,usec_per_call=30.50,rejected_calls=0,failed_calls=0\r\ncmdstat_info:calls=2,usec=19,usec_per_call=9.50,rejected_calls=0,failed_calls=0\r\ncmdstat_mget:calls=1,usec=29,usec_per_call=29.00,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=418612,expires=91561,avg_ttl=1924955156\r\ndb1:keys=89,expires=86,avg_ttl=15621370\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=52 addr=172.17.0.1:49340 laddr=172.17.0.2:6379 fd=12 name= age=3 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=12804 qbuf-free=28150 argv-mem=12662 obl=0 oll=0 omem=0 tot-mem=74294 events=r cmd=FT.SEARCH user=default redir=-1\r\nid=53 addr=172.17.0.1:49352 laddr=172.17.0.2:6379 fd=13 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=get user=default redir=-1\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=52 addr=172.17.0.1:49340 laddr=172.17.0.2:6379 fd=12 name= age=3 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=12804 qbuf-free=28150 argv-mem=12662 obl=0 oll=0 omem=0 tot-mem=74294 events=r cmd=FT.SEARCH user=default redir=-1\r\nargv[0]: 'FT.SEARCH'\r\nargv[1]: 'sku:idx'\r\nargv[2]: '@n_comments:[817.8 inf] @category:(无线耳机) @brand:(大品牌) @price:[900.0 1000] @negative_ratio:[0 0.2797581622188262] (@combined:(音质好|适合女生)|(@pos_topics_vec:[VECTOR_RANGE $radius $query_vec_0] @pos_topics_vec:[VECTOR_RANGE $radius $query_vec_1]))'\r\nargv[3]: 'SCORER'\r\nargv[4]: 'BM25'\r\nargv[5]: 'WITHSCORES'\r\nargv[6]: 'LANGUAGE'\r\nargv[7]: 'chinese'\r\nargv[8]: 'DIALECT'\r\nargv[9]: '2'\r\nargv[10]: 'LIMIT'\r\nargv[11]: '0'\r\nargv[12]: '50'\r\nargv[13]: 'params'\r\nargv[14]: '6'\r\nargv[15]: 'radius'\r\nargv[16]: '0.2'\r\nargv[17]: 'query_vec_0'\r\nargv[18]: '}5W;`ف�|�E��7\u0010���e����<c�Q���D�\u0019B��nVټߕ�<\u001e��<z\u001c��\b�U�ຓ���'\r\nargv[19]: 'query_vec_1'\r\nargv[20]: '�1��Ӌ���~�:�B��E�������t�S��A\u0007����;��\u000f���<]C;<�Ч;��\u0007�ʡ���|�;�0\u000b=5̛;n9��v#I�;|\r\n;���<�\u0018E<\u001e \u001c��D'��������<�dn��F��i�w�b�%=A/\u001f;oV��y�\u0005�^t���\u001f�;&\u001b\u0003�\u001b��;ݷ�;ݷ�;(R����ֻ��!<�\"�<)i\u0018�Y�\u0005<\t�Ѽ��u�qsW��C'\r\n\r\n------ MODULES INFO OUTPUT ------\r\n# graph_executing commands\r\n\r\n# search_version\r\nsearch_version:2.6.9\r\nsearch_redis_version:6.2.12 - oss\r\n\r\n# search_index\r\nsearch_number_of_indexes:8\r\n\r\n# search_fields_statistics\r\nsearch_fields_text:Text=23\r\nsearch_fields_numeric:Numeric=24\r\nsearch_fields_tag:Tag=26\r\nsearch_fields_vector:Vector=7,HSNW=7\r\n\r\n# search_dialect_statistics\r\nsearch_dialect_1:1\r\nsearch_dialect_2:1\r\nsearch_dialect_3:0\r\n\r\n# search_runtime_configurations\r\nsearch_concurrent_mode:OFF\r\nsearch_enableGC:ON\r\nsearch_minimal_term_prefix:2\r\nsearch_maximal_prefix_expansions:200\r\nsearch_query_timeout_ms:500\r\nsearch_timeout_policy:return\r\nsearch_cursor_read_size:1000\r\nsearch_cursor_max_idle_time:300000\r\nsearch_max_doc_table_size:1000000\r\nsearch_max_search_results:10000\r\nsearch_max_aggregate_results:10000\r\nsearch_search_pool_size:20\r\nsearch_index_pool_size:8\r\nsearch_gc_scan_size:100\r\nsearch_min_phonetic_term_length:3\r\n\r\n# ReJSON_trace\r\nReJSON_trace:   0: redis_module::base_info_func\r\n   1: rejson::__info_func\r\n   2: modulesCollectInfo\r\n             at /__w/redis-stack/redis-stack/redis/src/module.c:7100:9\r\n   3: logModulesInfo\r\n             at /__w/redis-stack/redis-stack/redis/src/debug.c:1624:22\r\n   4: printCrashReport\r\n             at /__w/redis-stack/redis-stack/redis/src/debug.c:1896:5\r\n   5: _serverPanic\r\n             at /__w/redis-stack/redis-stack/redis/src/debug.c:1015:9\r\n   6: redisOutOfMemoryHandler\r\n             at /__w/redis-stack/redis-stack/redis/src/server.c:6037:5\r\n   7: zcalloc\r\n             at /__w/redis-stack/redis-stack/redis/src/zmalloc.c:180:15\r\n   8: RSIndexResult_IterateOffsets\r\n   9: RSIndexResult_IterateOffsets\r\n  10: RSIndexResult_IterateOffsets\r\n  11: IndexResult_MinOffsetDelta\r\n  12: BM25Scorer\r\n  13: rpscoreNext\r\n  14: rpsortNext_Accum\r\n  15: rploaderNext\r\n  16: sendChunk\r\n  17: AREQ_Execute\r\n  18: RSSearchCommand\r\n  19: RedisModuleCommandDispatcher\r\n             at /__w/redis-stack/redis-stack/redis/src/module.c:695:5\r\n  20: call\r\n             at /__w/redis-stack/redis-stack/redis/src/server.c:3750:5\r\n  21: processCommand\r\n             at /__w/redis-stack/redis-stack/redis/src/server.c:4297:9\r\n  22: processCommandAndResetClient\r\n             at /__w/redis-stack/redis-stack/redis/src/networking.c:2105:9\r\n  23: processInputBuffer\r\n             at /__w/redis-stack/redis-stack/redis/src/networking.c:2206:17\r\n  24: callHandler\r\n             at /__w/redis-stack/redis-stack/redis/src/connhelpers.h:79:18\r\n      connSocketEventHandler\r\n             at /__w/redis-stack/redis-stack/redis/src/connection.c:295:14\r\n  25: aeProcessEvents\r\n             at /__w/redis-stack/redis-stack/redis/src/ae.c:427:17\r\n  26: aeMain\r\n             at /__w/redis-stack/redis-stack/redis/src/ae.c:487:9\r\n  27: main\r\n             at /__w/redis-stack/redis-stack/redis/src/server.c:6474:5\r\n  28: __libc_start_main\r\n  29: _start\r\n\r\n\r\n------ FAST MEMORY TEST ------\r\n8:M 07 Sep 2023 16:04:23.060 # Bio thread for job type #0 terminated\r\n8:M 07 Sep 2023 16:04:23.060 # Bio thread for job type #1 terminated\r\n8:M 07 Sep 2023 16:04:23.060 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 560ceca8a000 (2281472 bytes)\r\n*** Preparing to test memory region 560cecfb2000 (405504 bytes)\r\n*** Preparing to test memory region 7fa8b0000000 (135168 bytes)\r\n*** Preparing to test memory region 7fa8b8000000 (8388608 bytes)\r\n*** Preparing to test memory region 7fa8b8800000 (7774142464 bytes)\r\n*** Preparing to test memory region 7faa87e46000 (596115456 bytes)\r\n*** Preparing to test memory region 7faaab6c7000 (8388608 bytes)\r\n*** Preparing to test memory region 7faaabec8000 (8388608 bytes)\r\n*** Preparing to test memory region 7faaac6c9000 (8388608 bytes)\r\n*** Preparing to test memory region 7faaaceca000 (8388608 bytes)\r\n*** Preparing to test memory region 7faaad986000 (8388608 bytes)\r\n*** Preparing to test memory region 7faaae187000 (8388608 bytes)\r\n*** Preparing to test memory region 7faaae988000 (8388608 bytes)\r\n*** Preparing to test memory region 7faaaf189000 (8388608 bytes)\r\n*** Preparing to test memory region 7faaaf98a000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab018b000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab098c000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab118d000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab198e000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab218f000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab2990000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab3191000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab3992000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab4193000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab60c3000 (12288 bytes)\r\n*** Preparing to test memory region 7faab60c7000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab68c8000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab72a7000 (12288 bytes)\r\n*** Preparing to test memory region 7faab75fd000 (12288 bytes)\r\n*** Preparing to test memory region 7faab7600000 (8388608 bytes)\r\n*** Preparing to test memory region 7faab7f1a000 (4096 bytes)\r\n*** Preparing to test memory region 7faab7f78000 (24576 bytes)\r\n*** Preparing to test memory region 7faab816c000 (16384 bytes)\r\n*** Preparing to test memory region 7faab818f000 (16384 bytes)\r\n*** Preparing to test memory region 7faab8466000 (16384 bytes)\r\n*** Preparing to test memory region 7faab8652000 (8192 bytes)\r\n*** Preparing to test memory region 7faab8685000 (4096 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version\r\nLinux VM-0-16-tencentos 5.4.119-19-0009.11\r\n8 core，16G ram\r\n\r\n3. Steps to reproduce (if any)\r\ndepends a  large dump file, can't share\r\n",
  "state": "closed",
  "created_at": "2023-09-08T03:10:08Z",
  "updated_at": "2023-09-08T03:24:27Z",
  "closed_at": "2023-09-08T03:24:27Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1711022432,
      "user": "sundb",
      "created_at": "2023-09-08T03:24:27Z",
      "body": "It seems that integer value overflow occurred and tried to allocate 18446744004990074880 bytes of memory.\r\nPlease raise this issue with the developer at https://github.com/RediSearch/RediSearch/security."
    }
  ]
}