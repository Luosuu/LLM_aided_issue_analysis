{
  "issue_number": 11712.0,
  "title": "[CRASH] redis server crashes randomly",
  "body": "**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n                _._                                                  \r\n           _.-``__ ''-._                                             \r\n      _.-``    `.  `_.  ''-._           Redis 3.2.12 (00000000/0) 64 bit\r\n  .-`` .-```.  ```\\/    _.,_ ''-._                                   \r\n (    '      ,       .-`  | `,    )     Running in standalone mode\r\n |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379\r\n |    `-._   `._    /     _.-'    |     PID: 1347\r\n  `-._    `-._  `-./  _.-'    _.-'                                   \r\n |`-._`-._    `-.__.-'    _.-'_.-'|                                  \r\n |    `-._`-._        _.-'_.-'    |           http://redis.io        \r\n  `-._    `-._`-.__.-'_.-'    _.-'                                   \r\n |`-._`-._    `-.__.-'    _.-'_.-'|                                  \r\n |    `-._`-._        _.-'_.-'    |                                  \r\n  `-._    `-._`-.__.-'_.-'    _.-'                                   \r\n      `-._    `-.__.-'    _.-'                                       \r\n          `-._        _.-'                                           \r\n              `-.__.-'                                               \r\n\r\n1347:M 13 Jan 19:18:09.103 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.\r\n1347:M 13 Jan 19:18:09.103 # Server started, Redis version 3.2.12\r\n1347:M 13 Jan 19:18:09.103 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and the\r\nn reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.\r\n1347:M 13 Jan 19:18:09.103 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the com\r\nmand 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disable\r\nd.\r\n1347:M 13 Jan 19:18:09.103 * The server is now ready to accept connections on port 6379\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n1347:M 14 Jan 17:20:23.097 # Redis 3.2.12 crashed by signal: 11\r\n1347:M 14 Jan 17:20:23.097 # Accessing address: 0xffff7dffea00\r\n1347:M 14 Jan 17:20:23.097 # Failed assertion: <no assertion failed> (<no file>:0)\r\n\r\n------ STACK TRACE ------\r\n/usr/bin/redis-server *:6379(logStackTrace+0x40)[0xaaaac0433ba8]\r\n/usr/bin/redis-server *:6379(sigsegvHandler+0x9c)[0xaaaac04342e4]\r\nlinux-vdso.so.1(__kernel_rt_sigreturn+0x0)[0xffff8767a668]\r\n/usr/bin/redis-server *:6379(dictFind+0x68)[0xaaaac03f7340]\r\n/usr/bin/redis-server *:6379(hashTypeGetFromHashTable+0x24)[0xaaaac0424eb8]\r\n/usr/bin/redis-server *:6379(hashTypeGetObject+0x3c)[0xaaaac042505c]\r\n/usr/bin/redis-server *:6379(hincrbyCommand+0x84)[0xaaaac04262b8]\r\n/usr/bin/redis-server *:6379(call+0x7c)[0xaaaac03facbc]\r\n/usr/bin/redis-server *:6379(processCommand+0x3e4)[0xaaaac03fdbf8]\r\n/usr/bin/redis-server *:6379(processInputBuffer+0x118)[0xaaaac040b000]\r\n/usr/bin/redis-server *:6379(aeProcessEvents+0x34c)[0xaaaac03f4fd0]\r\n/usr/bin/redis-server *:6379(aeMain+0x30)[0xaaaac03f51c4]\r\n/usr/bin/redis-server *:6379(main+0x340)[0xaaaac03f1e44]\r\n/lib64/libc.so.6(__libc_start_main+0xe4)[0xffff8737cda4]\r\n/usr/bin/redis-server *:6379(+0x21100)[0xaaaac03f2100]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:3.2.12\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:7dfac9c7a0dd06b5\r\nredis_mode:standalone\r\nos:Linux 4.14.301-224.520.amzn2.aarch64 aarch64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\ngcc_version:4.8.5\r\nprocess_id:1347\r\nrun_id:76358d803f21bf61f9d594e2a08e66a15c590423\r\ntcp_port:6379\r\nuptime_in_seconds:79334\r\nuptime_in_days:0\r\nhz:10\r\nlru_clock:12772439\r\nexecutable:/usr/bin/redis-server\r\nconfig_file:/etc/redis.conf\r\n\r\n# Clients\r\nconnected_clients:5\r\nclient_longest_output_list:0\r\nclient_biggest_input_buf:0\r\nblocked_clients:2\r\n\r\n# Memory\r\nused_memory:4269928\r\nused_memory_human:4.07M\r\nused_memory_rss:8261632\r\nused_memory_rss_human:7.88M\r\nused_memory_peak:4389536\r\nused_memory_peak_human:4.19M\r\ntotal_system_memory:2028507136\r\ntotal_system_memory_human:1.89G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nmem_fragmentation_ratio:1.93\r\nmem_allocator:jemalloc-3.6.0\r\n\r\n# Persistence\r\nloading:0\r\nrdb_changes_since_last_save:2115028\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1673637489\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\n\r\n# Stats\r\ntotal_connections_received:156928\r\ntotal_commands_processed:3437935\r\ninstantaneous_ops_per_sec:45\r\ntotal_net_input_bytes:289216487\r\ntotal_net_output_bytes:116334312\r\ninstantaneous_input_kbps:3.84\r\ninstantaneous_output_kbps:0.44\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:35823\r\nevicted_keys:0\r\nkeyspace_hits:378184\r\nkeyspace_misses:181322\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\nmigrate_cached_sockets:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_repl_offset:0\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:102.17\r\nused_cpu_user:62.34\r\nused_cpu_sys_children:0.00\r\nused_cpu_user_children:0.00\r\n\r\n# Commandstats\r\ncmdstat_get:calls=326527,usec=566347,usec_per_call=1.73\r\ncmdstat_setnx:calls=200,usec=527,usec_per_call=2.63\r\ncmdstat_setex:calls=8839,usec=26291,usec_per_call=2.97\r\ncmdstat_del:calls=209,usec=447,usec_per_call=2.14\r\ncmdstat_exists:calls=141427,usec=332477,usec_per_call=2.35\r\ncmdstat_incr:calls=29336,usec=69643,usec_per_call=2.37\r\ncmdstat_rpush:calls=310,usec=2163,usec_per_call=6.98\r\ncmdstat_blpop:calls=29098,usec=121848,usec_per_call=4.19\r\ncmdstat_hset:calls=39349,usec=83836,usec_per_call=2.13\r\ncmdstat_hsetnx:calls=136080,usec=218760,usec_per_call=1.61\r\ncmdstat_hget:calls=219506,usec=341094,usec_per_call=1.55\r\ncmdstat_hmset:calls=256,usec=2022,usec_per_call=7.90\r\ncmdstat_hincrby:calls=833671,usec=3589081,usec_per_call=4.31\r\ncmdstat_hincrbyfloat:calls=140062,usec=1700608,usec_per_call=12.14\r\ncmdstat_hdel:calls=502,usec=2308,usec_per_call=4.60\r\ncmdstat_hlen:calls=136,usec=268,usec_per_call=1.97\r\ncmdstat_hvals:calls=10594,usec=65206,usec_per_call=6.15\r\ncmdstat_hgetall:calls=548,usec=3066,usec_per_call=5.59\r\ncmdstat_expire:calls=1008539,usec=919200,usec_per_call=0.91\r\ncmdstat_keys:calls=3,usec=342,usec_per_call=114.00\r\ncmdstat_scan:calls=506341,usec=3074507,usec_per_call=6.07\r\ncmdstat_multi:calls=1316,usec=243,usec_per_call=0.18\r\ncmdstat_exec:calls=3948,usec=13331,usec_per_call=3.38\r\ncmdstat_persist:calls=256,usec=247,usec_per_call=0.96\r\ncmdstat_dump:calls=880,usec=5998,usec_per_call=6.82\r\ncmdstat_command:calls=2,usec=946,usec_per_call=473.00\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=932,expires=928,avg_ttl=24455372\r\nhash_init_value: 1673582029\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=568 addr=127.0.0.1:53262 fd=7 name= age=77321 idle=77317 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=keys\r\nid=156875 addr=172.30.0.205:34278 fd=8 name= age=22 idle=2 flags=b db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=blpop\r\nid=156872 addr=127.0.0.1:49302 fd=11 name= age=22 idle=2 flags=b db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=blpop\r\nid=156928 addr=127.0.0.1:49674 fd=6 name= age=2 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=hincrby\r\nid=156929 addr=127.0.0.1:49680 fd=9 name= age=2 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=expire\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=156928 addr=127.0.0.1:49674 fd=6 name= age=2 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=hincrby\r\nargv[0]: 'HINCRBY'\r\nargv[1]: 'stats:page:views:by_anon:in_day:19371'\r\nargv[2]: '3612bdd5525ef2bca9ffbd338480557c'\r\nargv[3]: '1'\r\n1347:M 14 Jan 17:20:23.098 # key 'stats:page:views:by_anon:in_day:19371' found in DB containing the following object:\r\n1347:M 14 Jan 17:20:23.098 # Object type: 4\r\n1347:M 14 Jan 17:20:23.098 # Object encoding: 2\r\n1347:M 14 Jan 17:20:23.098 # Object refcount: 1\r\n1347:M 14 Jan 17:20:23.098 # Hash size: 8204\r\n\r\n------ REGISTERS ------\r\n\r\n------ FAST MEMORY TEST ------\r\n1347:M 14 Jan 17:20:23.098 # Bio thread for job type #0 terminated\r\n1347:M 14 Jan 17:20:23.098 # Bio thread for job type #1 terminated\r\n*** Preparing to test memory region aaaac04d6000 (86016 bytes)\r\n*** Preparing to test memory region ffff7d800000 (8380416 bytes)\r\n*** Preparing to test memory region ffff7dfff000 (10485760 bytes)\r\n*** Preparing to test memory region ffff7ea00000 (18874368 bytes)\r\n*** Preparing to test memory region ffff86800000 (8388608 bytes)\r\n*** Preparing to test memory region ffff874df000 (16384 bytes)\r\n*** Preparing to test memory region ffff87514000 (16384 bytes)\r\n*** Preparing to test memory region ffff87569000 (4096 bytes)\r\n*** Preparing to test memory region ffff8766c000 (16384 bytes)\r\n.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version\r\nAmazon AMI2\r\n4.14.301-224.520.amzn2.aarch64\r\n\r\n3. Steps to reproduce (if any)\r\nUnknown. This has happened randomly twice in the last couple of days -- the redis server just crashes for no obvious reason.\r\n",
  "state": "closed",
  "created_at": "2023-01-14T18:28:10Z",
  "updated_at": "2023-01-19T18:27:10Z",
  "closed_at": "2023-01-18T08:54:51Z",
  "labels": [
    "state:to-be-closed"
  ],
  "comments_data": [
    {
      "id": 1383319829,
      "user": "modernjess",
      "created_at": "2023-01-16T01:08:50Z",
      "body": "This is the default redis available on Amazon AMI2 running ARM. I didn't realize it at the time, but there is a newer version hiding in linux-extras (redis 6) which I have enabled and upgraded to.\r\n\r\nTherefore, I don't have any vested interest in resolving this particular crash."
    },
    {
      "id": 1386698486,
      "user": "oranagra",
      "created_at": "2023-01-18T08:54:51Z",
      "body": "seems like a memory corruption issue, but considering it's a very old version, and not sure it was tested on ARM, i rather assume it was resolved with a later version, please report if you see it with the recent one.\r\np.s. not sure the data from that redis can be trusted, if the memory was corrupted and we take the data to the newer version, the old corruption can still cause odd crashes."
    },
    {
      "id": 1397424957,
      "user": "modernjess",
      "created_at": "2023-01-19T18:26:05Z",
      "body": "> seems like a memory corruption issue, but considering it's a very old version, and not sure it was tested on ARM, i rather assume it was resolved with a later version, please report if you see it with the recent one.\r\n\r\nWill do.\r\n\r\n> p.s. not sure the data from that redis can be trusted, if the memory was corrupted and we take the data to the newer version, the old corruption can still cause odd crashes.\r\n\r\nThanks for the tip. After the first crash, I disabled all persistence, as I am using redis strictly for cacheing and information that can be recreated (although at a time/processing cost) from elsewhere. I did have another crash with that version, even without using any of the previous data. Which was weird, because it had been running continuously in production without issue for approximately a year."
    }
  ]
}