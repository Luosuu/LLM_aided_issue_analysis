{
  "issue_number": 10968.0,
  "title": "[BUG] REDIS BUG REPORT by stream command",
  "body": "```\r\nXGROUP CREATE s:foo g:foo $ MKSTREAM\r\nXADD s:foo MAXLEN ~ 1 * foo 1\r\nXADD s:foo MAXLEN ~ 1 * foo 2\r\nXADD s:foo MAXLEN ~ 1 * foo 3\r\nXADD s:foo MAXLEN ~ 1 * foo 4\r\nXADD s:foo MAXLEN ~ 1 * foo 5\r\nXREADGROUP GROUP g:foo c:1 COUNT 1 STREAMS s:foo >\r\nXREADGROUP GROUP g:foo c:1 COUNT 1 STREAMS s:foo >\r\nXREADGROUP GROUP g:foo c:1 COUNT 1 STREAMS s:foo >\r\nXREADGROUP GROUP g:foo c:1 COUNT 1 STREAMS s:foo >\r\nXREADGROUP GROUP g:foo c:1 COUNT 1 STREAMS s:foo >\r\nXTRIM s:foo MAXLEN = 1\r\nXREADGROUP GROUP g:foo c:1 COUNT 10 STREAMS s:foo 0\r\nXAUTOCLAIM s:foo g:foo c:1 10 0 COUNT 1\r\n```\r\n\r\nThis doesn't always crash the redis server.\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n1:M 13 Jul 2022 03:52:39.436 # Redis 7.0.3 crashed by signal: 11, si_code: 1\r\n1:M 13 Jul 2022 03:52:39.436 # Accessing address: 0x7f3196beb080\r\n1:M 13 Jul 2022 03:52:39.436 # Crashed running the instruction at: 0x55b57c25f846\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\nredis-server *:6379(raxRemove+0x2a6)[0x55b57c25f846]\r\n\r\nBacktrace:\r\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x14140)[0x7f3178655140]\r\nredis-server *:6379(raxRemove+0x2a6)[0x55b57c25f846]\r\nredis-server *:6379(xautoclaimCommand+0x559)[0x55b57c2698a9]\r\nredis-server *:6379(call+0xcb)[0x55b57c1b417b]\r\nredis-server *:6379(processCommand+0x775)[0x55b57c1b67e5]\r\nredis-server *:6379(processInputBuffer+0xde)[0x55b57c1cd33e]\r\nredis-server *:6379(readQueryFromClient+0x300)[0x55b57c1d0da0]\r\nredis-server *:6379(+0x13dfa8)[0x55b57c277fa8]\r\nredis-server *:6379(aeProcessEvents+0x1ca)[0x55b57c1ab86a]\r\nredis-server *:6379(aeMain+0x1d)[0x55b57c1abc0d]\r\nredis-server *:6379(main+0x311)[0x55b57c1a7591]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xea)[0x7f31784a2d0a]\r\nredis-server *:6379(_start+0x2a)[0x55b57c1a7bea]\r\n\r\n------ REGISTERS ------\r\n1:M 13 Jul 2022 03:52:39.438 # \r\nRAX:000000001eb5df58 RBX:00007ffe7b6388b8\r\nRCX:00007f31780634b0 RDX:00007f317808d128\r\nRDI:0000000000000004 RSI:00007f317808d128\r\nRBP:0000000000000008 RSP:00007ffe7b638880\r\nR8 :000000001eb5df6c R9 :0000000000000008\r\nR10:00007f317808d100 R11:000000001eb5df58\r\nR12:0000000000000000 R13:00007f317808d020\r\nR14:00007f31780633d8 R15:00007f3178063300\r\nRIP:000055b57c25f846 EFL:0000000000010206\r\nCSGSFS:002b000000000033\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b63888f) -> 000055b57c1bd9f3\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b63888e) -> 0000000000000001\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b63888d) -> 00007ffe7b6388f0\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b63888c) -> 00007ffe7b638960\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b63888b) -> 000055b500000020\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b63888a) -> 00007f3178027020\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b638889) -> 00007f3178063510\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b638888) -> 00007f31780634b0\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b638887) -> 00007f31780633d8\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b638886) -> 0000000000000020\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b638885) -> 0000000000000000\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b638884) -> 00007ffe7b6388b8\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b638883) -> 00007f317808d120\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b638882) -> 000000007b638aa0\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b638881) -> 0000000000000000\r\n1:M 13 Jul 2022 03:52:39.438 # (00007ffe7b638880) -> 0000000000000000\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:7.0.3\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:7e8634db15543dd\r\nredis_mode:standalone\r\nos:Linux 5.10.102.1-microsoft-standard-WSL2 x86_64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:10.2.1\r\nprocess_id:1\r\nprocess_supervised:no\r\nrun_id:d92c5458259504c781b8a8315eb1a670873ed861\r\ntcp_port:6379\r\nserver_time_usec:1657684359436885\r\nuptime_in_seconds:548\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:13517191\r\nexecutable:/data/redis-server\r\nconfig_file:\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:1\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:8\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:1016072\r\nused_memory_human:992.26K\r\nused_memory_rss:13639680\r\nused_memory_rss_human:13.01M\r\nused_memory_peak:1089760\r\nused_memory_peak_human:1.04M\r\nused_memory_peak_perc:93.24%\r\nused_memory_overhead:864824\r\nused_memory_startup:862768\r\nused_memory_dataset:151248\r\nused_memory_dataset_perc:98.66%\r\nallocator_allocated:1393464\r\nallocator_active:1642496\r\nallocator_resident:5058560\r\ntotal_system_memory:8148529152\r\ntotal_system_memory_human:7.59G\r\nused_memory_lua:31744\r\nused_memory_vm_eval:31744\r\nused_memory_lua_human:31.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:32768\r\nused_memory_vm_total:64512\r\nused_memory_vm_total_human:63.00K\r\nused_memory_functions:184\r\nused_memory_scripts:184\r\nused_memory_scripts_human:184B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.18\r\nallocator_frag_bytes:249032\r\nallocator_rss_ratio:3.08\r\nallocator_rss_bytes:3416064\r\nrss_overhead_ratio:2.70\r\nrss_overhead_bytes:8581120\r\nmem_fragmentation_ratio:13.72\r\nmem_fragmentation_bytes:12645808\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:1800\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.2.1\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:21\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1657683811\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_rewrites_consecutive_failures:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:1\r\ntotal_commands_processed:14\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:1212\r\ntotal_net_output_bytes:171375\r\ntotal_net_repl_input_bytes:0\r\ntotal_net_repl_output_bytes:0\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\ninstantaneous_input_repl_kbps:0.00\r\ninstantaneous_output_repl_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:9\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:13\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\npubsubshard_channels:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:15\r\ntotal_writes_processed:16\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:1\r\nreply_buffer_expands:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:f3e83c9d77d754ae9331e1151c98649df94bee49\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.531926\r\nused_cpu_user:0.437161\r\nused_cpu_sys_children:0.002881\r\nused_cpu_user_children:0.004468\r\nused_cpu_sys_main_thread:0.523717\r\nused_cpu_user_main_thread:0.440399\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_xtrim:calls=1,usec=67,usec_per_call=67.00,rejected_calls=0,failed_calls=0\r\ncmdstat_xgroup|create:calls=1,usec=55,usec_per_call=55.00,rejected_calls=0,failed_calls=0\r\ncmdstat_xreadgroup:calls=6,usec=160,usec_per_call=26.67,rejected_calls=0,failed_calls=0\r\ncmdstat_command|docs:calls=1,usec=1036,usec_per_call=1036.00,rejected_calls=0,failed_calls=0\r\ncmdstat_xadd:calls=5,usec=120,usec_per_call=24.00,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_xtrim:p50=67.071,p99=67.071,p99.9=67.071\r\nlatency_percentiles_usec_xgroup|create:p50=55.039,p99=55.039,p99.9=55.039\r\nlatency_percentiles_usec_xreadgroup:p50=24.063,p99=39.167,p99.9=39.167\r\nlatency_percentiles_usec_command|docs:p50=1036.287,p99=1036.287,p99.9=1036.287\r\nlatency_percentiles_usec_xadd:p50=15.039,p99=62.207,p99.9=62.207\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=1,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=3 addr=127.0.0.1:55662 laddr=127.0.0.1:6379 fd=8 name= age=114 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=85 qbuf-free=20389 argv-mem=32 multi-mem=0 rbs=1024 rbp=4 obl=4 oll=2 omem=80 tot-mem=22448 events=r cmd=xautoclaim user=default redir=-1 resp=2\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=3 addr=127.0.0.1:55662 laddr=127.0.0.1:6379 fd=8 name= age=114 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=85 qbuf-free=20389 argv-mem=32 multi-mem=0 rbs=1024 rbp=4 obl=4 oll=2 omem=80 tot-mem=22448 events=r cmd=xautoclaim user=default redir=-1 resp=2\r\nargv[0]: '\"XAUTOCLAIM\"'\r\nargv[1]: '\"s:foo\"'\r\nargv[2]: '\"g:foo\"'\r\nargv[3]: '\"c:1\"'\r\nargv[4]: '\"10\"'\r\nargv[5]: '\"0\"'\r\nargv[6]: '\"COUNT\"'\r\nargv[7]: '\"1\"'\r\n1:M 13 Jul 2022 03:52:39.438 # key 's:foo' found in DB containing the following object:\r\n1:M 13 Jul 2022 03:52:39.438 # Object type: 6\r\n1:M 13 Jul 2022 03:52:39.438 # Object encoding: 10\r\n1:M 13 Jul 2022 03:52:39.438 # Object refcount: 1\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nlazyfree-lazy-server-del no\r\nlazyfree-lazy-user-del no\r\nlist-compress-depth 0\r\nlazyfree-lazy-expire no\r\nio-threads-do-reads no\r\nsanitize-dump-payload no\r\nrepl-diskless-sync yes\r\nslave-read-only yes\r\nproto-max-bulk-len 512mb\r\nactivedefrag no\r\nio-threads 1\r\nclient-query-buffer-limit 1gb\r\nlazyfree-lazy-eviction no\r\nreplica-read-only yes\r\nrepl-diskless-load disabled\r\nlazyfree-lazy-user-flush no\r\n\r\n------ FAST MEMORY TEST ------\r\n1:M 13 Jul 2022 03:52:39.438 # Bio thread for job type #0 terminated\r\n1:M 13 Jul 2022 03:52:39.439 # Bio thread for job type #1 terminated\r\n1:M 13 Jul 2022 03:52:39.439 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 55b57c40a000 (2301952 bytes)\r\n*** Preparing to test memory region 55b57d23f000 (270336 bytes)\r\n*** Preparing to test memory region 7f3175bfd000 (8388608 bytes)\r\n*** Preparing to test memory region 7f31763fe000 (8388608 bytes)\r\n*** Preparing to test memory region 7f3176bff000 (8388608 bytes)\r\n*** Preparing to test memory region 7f3177400000 (8388608 bytes)\r\n*** Preparing to test memory region 7f3177c00000 (8388608 bytes)\r\n*** Preparing to test memory region 7f3178476000 (24576 bytes)\r\n*** Preparing to test memory region 7f317863d000 (16384 bytes)\r\n*** Preparing to test memory region 7f317865f000 (16384 bytes)\r\n*** Preparing to test memory region 7f3178953000 (16384 bytes)\r\n*** Preparing to test memory region 7f3178b34000 (8192 bytes)\r\n*** Preparing to test memory region 7f3178b64000 (4096 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: raxRemove (base: 0x55b57c25f5a0)\r\nModule: redis-server *:6379 (base 0x55b57c13a000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x55b57c25f5a0 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n1:M 13 Jul 2022 03:52:39.528 # dump of function (hexdump of 806 bytes):\r\n41574531c04989ff4156415541544989cc554889d5534881ec48010000488d5c2438488d44242048c74424280000000048895c2420488d4c24184883ec0848c744243820000000c784244001000000000000c744241c00000000504c8d4c2424e82befffff595e4839c50f8538040000488b6c24180fb64500a8040f8517040000a8010f841f0400004d85e4740c4889efe85af3ffff49890424806500fe8b450049836f080183e0f80f8521040000493b2f750fe9200400000f1f80000000004889fd4889efe8751df6ff488b44242849836f10014885c00f84f275f4ff4c8b4424204883e8014889442428498b3cc00fb60748897c2418a8017513a804750a8b0783e0f883f808750549393f75b14885ed0f84c60300004889eee820fdffff488b4c24184889c24839c8744f488b4424284885c00f84bd030000488b742420488b7cc6f84885ff0f84aa0300008b37c1ee038d460448f7d883e0074801f0488d440704483b0874100f1f80000000004883c008483b0875f74889108b0283e0f983f8080f854f03000048895424188b84243801000085c00f853b030000488b442428488b7424204885c00f84af0300000f1f80000000004883e8014c8b34c64d85f60f8473030000410fb616f6c2010f855203000083e204750f418b1683e2f883fa080f853e0300004c897424184885c075c448c74424280000000048c744240800000000418b1689d0c1e80383e2f84189c34d89d80f84bc020000410fb6164c89f6bf0100000041b908000000eb370f1f80000000008b004189c34183e3f84183fb080f85c5020000c1e8034189c34b8d2c034881fdffffff1f0f87ae02000083c7014989e883c0044a8d2cdd0000000048f7d883e007f6c204490f45e983e2034531e480fa01410f94c44f8d5ce3fc4c01d880fa010f95c24801ee0fb6d2488d54d6f8488b040248894424180fb6104889c6f6c2010f8552020000f6c2040f8471ffffff448b204489e0c1e8034189c34b8d2c034881fdffffff1f0f872c02000083c7014183e4f80f8574ffffff48c7c0fcffffff4829e883e007488d7c050ce86816f6ff4989c44885c00f844002000089e88d14ed040000004189142425ffffff1f\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n```",
  "state": "closed",
  "created_at": "2022-07-13T04:00:05Z",
  "updated_at": "2022-07-18T08:36:20Z",
  "closed_at": "2022-07-18T08:36:20Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1182798651,
      "user": "sundb",
      "created_at": "2022-07-13T05:59:26Z",
      "body": "Thanks for your report, I reproduced your crash and perhaps you found a rax crash that we hadn't been able to reproduce before."
    },
    {
      "id": 1182817479,
      "user": "enjoy-binbin",
      "created_at": "2022-07-13T06:26:51Z",
      "body": "so look like it was introduced in #10227? @guybe7 FYI"
    },
    {
      "id": 1182822400,
      "user": "sundb",
      "created_at": "2022-07-13T06:34:00Z",
      "body": "~~@enjoy-binbin Good catch.~~\r\n~~It should be wrong to use `raxRemove` in iterator.~~\r\n~~https://github.com/redis/redis/blob/599e59ebc57283f52c60a8de56ec5f44d053109a/src/t_stream.c#L3418~~\r\nAlready re-raxSeek behide it."
    },
    {
      "id": 1183546552,
      "user": "oranagra",
      "created_at": "2022-07-13T18:30:33Z",
      "body": "@iplaylf2 thanks for reporting. We'll include a fix in the next release. \r\nMeanwhile, if you're suffering from this bug, a much bigger COUNT value for XAUTOCLAIM could hide it. Or just switch to XCLAIM. "
    }
  ]
}