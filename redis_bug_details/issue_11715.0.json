{
  "issue_number": 11715.0,
  "title": "[CRASH] server.c:2442 'listLength(server.tracking_pending_keys) == 0' is not true",
  "body": "Hi!\r\n\r\nI added a standalone Redis instance to our Thanos setup to act as a query/index/bucket cache. The instance crashes almost daily, usually when there is some heavy metrics query ongoing.\r\n\r\n**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n1:M 15 Jan 2023 18:37:25.910 * Background saving terminated with success\r\n1:M 15 Jan 2023 18:42:26.089 * 100 changes in 300 seconds. Saving...\r\n1:M 15 Jan 2023 18:42:26.120 * Background saving started by pid 149964\r\n149964:C 15 Jan 2023 18:42:43.756 * DB saved on disk\r\n149964:C 15 Jan 2023 18:42:43.796 * RDB: 30 MB of memory used by copy-on-write\r\n1:M 15 Jan 2023 18:42:43.878 * Background saving terminated with success\r\n1:M 15 Jan 2023 18:45:12.482 * 10000 changes in 60 seconds. Saving...\r\n1:M 15 Jan 2023 18:45:12.514 * Background saving started by pid 150704\r\n150704:C 15 Jan 2023 18:45:44.463 * DB saved on disk\r\n150704:C 15 Jan 2023 18:45:44.506 * RDB: 264 MB of memory used by copy-on-write\r\n1:M 15 Jan 2023 18:45:44.582 * Background saving terminated with success\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n1:M 15 Jan 2023 18:46:35.846 # === ASSERTION FAILED ===\r\n1:M 15 Jan 2023 18:46:35.846 # ==> server.c:2442 'listLength(server.tracking_pending_keys) == 0' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\nredis-server *:6379(+0x4b364)[0x55e37ab75364]\r\nredis-server *:6379(aeProcessEvents+0x1b0)[0x55e37ab71f10]\r\nredis-server *:6379(aeMain+0x25)[0x55e37ab72285]\r\nredis-server *:6379(main+0x326)[0x55e37ab6e2e6]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xea)[0x7fdddb82bd0a]\r\nredis-server *:6379(_start+0x2a)[0x55e37ab6e7ca]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:6.2.8\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:98494b835603ba45\r\nredis_mode:standalone\r\nos:Linux 5.10.135 x86_64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:10.2.1\r\nprocess_id:1\r\nprocess_supervised:no\r\nrun_id:e2fb880485c1dbf8fc8c3f5ecdc72e4a6d20cfa7\r\ntcp_port:6379\r\nserver_time_usec:1673808395841143\r\nuptime_in_seconds:33794\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:12864011\r\nexecutable:/redis-server\r\nconfig_file:\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:68\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:1139\r\nclient_recent_max_output_buffer:1742840\r\nblocked_clients:0\r\ntracking_clients:20\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:3650389304\r\nused_memory_human:3.40G\r\nused_memory_rss:4392181760\r\nused_memory_rss_human:4.09G\r\nused_memory_peak:3911698760\r\nused_memory_peak_human:3.64G\r\nused_memory_peak_perc:93.32%\r\nused_memory_overhead:178157435\r\nused_memory_startup:812000\r\nused_memory_dataset:3472231869\r\nused_memory_dataset_perc:95.14%\r\nallocator_allocated:3650570168\r\nallocator_active:4395503616\r\nallocator_resident:4460855296\r\ntotal_system_memory:33112240128\r\ntotal_system_memory_human:30.84G\r\nused_memory_lua:30720\r\nused_memory_lua_human:30.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:16567500800\r\nmaxmemory_human:15.43G\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.20\r\nallocator_frag_bytes:744933448\r\nallocator_rss_ratio:1.01\r\nallocator_rss_bytes:65351680\r\nrss_overhead_ratio:0.98\r\nrss_overhead_bytes:-68673536\r\nmem_fragmentation_ratio:1.20\r\nmem_fragmentation_bytes:741676360\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:4081307\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.1.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:422745\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1673808344\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:32\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:277131264\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:15902\r\ntotal_commands_processed:6482917\r\ninstantaneous_ops_per_sec:147284\r\ntotal_net_input_bytes:33956439657\r\ntotal_net_output_bytes:34097392051\r\ninstantaneous_input_kbps:16382.47\r\ninstantaneous_output_kbps:29372.94\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:728821\r\nexpired_stale_perc:0.71\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:6585\r\nevicted_keys:0\r\nkeyspace_hits:4091058\r\nkeyspace_misses:2367888\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:31658\r\ntotal_forks:115\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntracking_total_keys:1003824\r\ntracking_total_items:1908813\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:4683151\r\ntotal_writes_processed:2556987\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:d9dc7936975ebdf775073000b2d961ae7567c0ea\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:98.411621\r\nused_cpu_user:66.121712\r\nused_cpu_sys_children:196.935224\r\nused_cpu_user_children:1582.288453\r\nused_cpu_sys_main_thread:94.889139\r\nused_cpu_user_main_thread:66.041100\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_mget:calls=404558,usec=18771204,usec_per_call=46.40,rejected_calls=0,failed_calls=0\r\ncmdstat_ping:calls=349214,usec=268704,usec_per_call=0.77,rejected_calls=0,failed_calls=0\r\ncmdstat_config:calls=2253,usec=102889,usec_per_call=45.67,rejected_calls=0,failed_calls=0\r\ncmdstat_info:calls=2253,usec=156118,usec_per_call=69.29,rejected_calls=0,failed_calls=0\r\ncmdstat_latency:calls=2253,usec=3588,usec_per_call=1.59,rejected_calls=0,failed_calls=0\r\ncmdstat_setex:calls=365534,usec=1880596,usec_per_call=5.14,rejected_calls=0,failed_calls=0\r\ncmdstat_multi:calls=401960,usec=29502,usec_per_call=0.07,rejected_calls=0,failed_calls=0\r\ncmdstat_select:calls=131,usec=73,usec_per_call=0.56,rejected_calls=0,failed_calls=0\r\ncmdstat_hello:calls=20,usec=71,usec_per_call=3.55,rejected_calls=0,failed_calls=0\r\ncmdstat_set:calls=925213,usec=4013269,usec_per_call=4.34,rejected_calls=0,failed_calls=0\r\ncmdstat_slowlog:calls=4506,usec=12320,usec_per_call=2.73,rejected_calls=0,failed_calls=0\r\ncmdstat_client:calls=398007,usec=141382,usec_per_call=0.36,rejected_calls=0,failed_calls=0\r\ncmdstat_pttl:calls=3225059,usec=3944318,usec_per_call=1.22,rejected_calls=0,failed_calls=0\r\ncmdstat_exec:calls=401956,usec=13672789,usec_per_call=34.02,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=1937917,expires=1937917,avg_ttl=47987770\r\ndb1:keys=176090,expires=176090,avg_ttl=60195014\r\ndb2:keys=2397,expires=2397,avg_ttl=70262785\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=44 addr=10.140.84.24:42166 laddr=10.140.86.124:6379 fd=32 name= age=33746 idle=0 flags=t db=1 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=0\r\nid=33 addr=10.140.80.32:57870 laddr=10.140.86.124:6379 fd=23 name= age=33746 idle=0 flags=t db=1 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=0\r\nid=15820 addr=10.140.80.28:40420 laddr=10.140.86.124:6379 fd=33 name= age=89 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=34 addr=10.140.80.32:57886 laddr=10.140.86.124:6379 fd=24 name= age=33746 idle=0 flags=t db=1 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=0\r\nid=35 addr=10.140.80.32:57892 laddr=10.140.86.124:6379 fd=25 name= age=33746 idle=0 flags=t db=1 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=ping user=default redir=0\r\nid=8 addr=10.140.79.163:51988 laddr=10.140.86.124:6379 fd=10 name= age=33770 idle=0 flags=t db=1 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=ping user=default redir=0\r\nid=9 addr=10.140.79.163:39484 laddr=10.140.86.124:6379 fd=11 name= age=33770 idle=0 flags=t db=1 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=ping user=default redir=0\r\nid=15815 addr=10.140.76.252:40158 laddr=10.140.86.124:6379 fd=18 name= age=95 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15816 addr=10.140.76.252:40152 laddr=10.140.86.124:6379 fd=19 name= age=95 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=18 addr=10.140.80.32:40822 laddr=10.140.86.124:6379 fd=12 name= age=33756 idle=0 flags=xt db=0 sub=0 psub=0 multi=10000 qbuf=9 qbuf-free=40945 argv-mem=124302 obl=16358 oll=10 omem=205040 tot-mem=472702 events=r cmd=pttl user=default redir=0\r\nid=19 addr=10.140.80.32:40832 laddr=10.140.86.124:6379 fd=13 name= age=33756 idle=0 flags=xt db=0 sub=0 psub=0 multi=10000 qbuf=22 qbuf-free=40932 argv-mem=13608 obl=16367 oll=7 omem=143528 tot-mem=300496 events=r cmd=pttl user=default redir=0\r\nid=28 addr=10.140.84.24:42110 laddr=10.140.86.124:6379 fd=20 name= age=33750 idle=0 flags=t db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=40954 argv-mem=0 obl=16381 oll=12 omem=246048 tot-mem=307528 events=r cmd=set user=default redir=0\r\nid=29 addr=10.140.84.24:42116 laddr=10.140.86.124:6379 fd=21 name= age=33749 idle=0 flags=xt db=0 sub=0 psub=0 multi=8928 qbuf=2 qbuf-free=40952 argv-mem=184486 obl=16358 oll=7 omem=143528 tot-mem=471374 events=r cmd=pttl user=default redir=0\r\nid=20 addr=10.140.80.32:40808 laddr=10.140.86.124:6379 fd=14 name= age=33756 idle=0 flags=xt db=0 sub=0 psub=0 multi=8664 qbuf=29 qbuf-free=40925 argv-mem=224890 obl=16358 oll=8 omem=164032 tot-mem=532282 events=r cmd=pttl user=default redir=0\r\nid=21 addr=10.140.80.32:40830 laddr=10.140.86.124:6379 fd=15 name= age=33756 idle=0 flags=t db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=16358 oll=7 omem=143528 tot-mem=164056 events=r cmd=set user=default redir=0\r\nid=6 addr=10.140.79.163:51960 laddr=10.140.86.124:6379 fd=8 name= age=33771 idle=0 flags=t db=1 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=ping user=default redir=0\r\nid=7 addr=10.140.79.163:39468 laddr=10.140.86.124:6379 fd=9 name= age=33771 idle=0 flags=t db=1 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=ping user=default redir=0\r\nid=15817 addr=10.140.80.28:40404 laddr=10.140.86.124:6379 fd=26 name= age=92 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=32 addr=10.140.80.32:57868 laddr=10.140.86.124:6379 fd=22 name= age=33746 idle=0 flags=t db=1 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=ping user=default redir=0\r\nid=39 addr=10.140.84.24:42134 laddr=10.140.86.124:6379 fd=27 name= age=33746 idle=0 flags=t db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=40954 argv-mem=0 obl=16358 oll=9 omem=184536 tot-mem=246016 events=r cmd=set user=default redir=0\r\nid=15823 addr=10.140.80.28:40444 laddr=10.140.86.124:6379 fd=34 name= age=83 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15824 addr=10.140.80.28:40434 laddr=10.140.86.124:6379 fd=35 name= age=83 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15825 addr=10.140.80.28:40496 laddr=10.140.86.124:6379 fd=36 name= age=83 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15826 addr=10.140.80.28:40470 laddr=10.140.86.124:6379 fd=37 name= age=83 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15827 addr=10.140.80.28:40504 laddr=10.140.86.124:6379 fd=38 name= age=83 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15828 addr=10.140.80.28:40486 laddr=10.140.86.124:6379 fd=39 name= age=83 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15829 addr=10.140.80.28:40430 laddr=10.140.86.124:6379 fd=40 name= age=83 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15830 addr=10.140.80.28:40466 laddr=10.140.86.124:6379 fd=41 name= age=83 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15831 addr=10.140.80.28:40450 laddr=10.140.86.124:6379 fd=42 name= age=83 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15832 addr=10.140.80.28:40508 laddr=10.140.86.124:6379 fd=43 name= age=83 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15833 addr=10.140.80.28:40476 laddr=10.140.86.124:6379 fd=44 name= age=83 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15834 addr=10.140.80.28:40480 laddr=10.140.86.124:6379 fd=45 name= age=83 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15835 addr=10.140.76.252:45972 laddr=10.140.86.124:6379 fd=46 name= age=83 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15836 addr=10.140.76.252:45982 laddr=10.140.86.124:6379 fd=47 name= age=83 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15837 addr=10.140.76.252:46004 laddr=10.140.86.124:6379 fd=48 name= age=83 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\nid=15838 addr=10.140.76.252:46010 laddr=10.140.86.124:6379 fd=49 name= age=83 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\nid=15839 addr=10.140.76.252:46024 laddr=10.140.86.124:6379 fd=50 name= age=83 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\nid=15840 addr=10.140.76.252:46034 laddr=10.140.86.124:6379 fd=51 name= age=83 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\nid=15841 addr=10.140.76.252:46012 laddr=10.140.86.124:6379 fd=52 name= age=83 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15849 addr=10.140.76.252:50612 laddr=10.140.86.124:6379 fd=58 name= age=76 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\nid=15850 addr=10.140.76.252:50614 laddr=10.140.86.124:6379 fd=59 name= age=76 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\nid=15851 addr=10.140.76.252:50626 laddr=10.140.86.124:6379 fd=60 name= age=76 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15852 addr=10.140.76.252:50636 laddr=10.140.86.124:6379 fd=61 name= age=76 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15853 addr=10.140.76.252:50652 laddr=10.140.86.124:6379 fd=62 name= age=76 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15854 addr=10.140.76.252:50632 laddr=10.140.86.124:6379 fd=63 name= age=76 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15855 addr=10.140.76.252:50664 laddr=10.140.86.124:6379 fd=64 name= age=76 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\nid=15856 addr=10.140.76.252:50692 laddr=10.140.86.124:6379 fd=65 name= age=76 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\nid=15857 addr=10.140.76.252:50688 laddr=10.140.86.124:6379 fd=66 name= age=76 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15858 addr=10.140.76.252:50704 laddr=10.140.86.124:6379 fd=67 name= age=76 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\nid=15859 addr=10.140.76.252:50642 laddr=10.140.86.124:6379 fd=68 name= age=76 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\nid=15860 addr=10.140.76.252:50674 laddr=10.140.86.124:6379 fd=69 name= age=76 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\nid=15861 addr=10.140.76.252:50710 laddr=10.140.86.124:6379 fd=70 name= age=76 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\nid=15862 addr=10.140.76.252:50702 laddr=10.140.86.124:6379 fd=71 name= age=76 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15863 addr=10.140.76.252:50718 laddr=10.140.86.124:6379 fd=72 name= age=76 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15864 addr=10.140.76.252:50714 laddr=10.140.86.124:6379 fd=73 name= age=76 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15842 addr=10.140.76.252:45956 laddr=10.140.86.124:6379 fd=53 name= age=83 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15843 addr=10.140.76.252:46014 laddr=10.140.86.124:6379 fd=54 name= age=83 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15844 addr=10.140.76.252:45992 laddr=10.140.86.124:6379 fd=55 name= age=83 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=40 addr=10.140.84.24:42130 laddr=10.140.86.124:6379 fd=28 name= age=33746 idle=0 flags=t db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=40954 argv-mem=0 obl=16358 oll=6 omem=123024 tot-mem=184504 events=r cmd=set user=default redir=0\r\nid=41 addr=10.140.84.24:42150 laddr=10.140.86.124:6379 fd=29 name= age=33746 idle=0 flags=t db=1 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=40954 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=61448 events=r cmd=exec user=default redir=0\r\nid=42 addr=10.140.84.24:42160 laddr=10.140.86.124:6379 fd=30 name= age=33746 idle=0 flags=t db=1 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=40954 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=61448 events=r cmd=exec user=default redir=0\r\nid=43 addr=10.140.84.24:42164 laddr=10.140.86.124:6379 fd=31 name= age=33746 idle=0 flags=t db=1 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=40954 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=61448 events=r cmd=exec user=default redir=0\r\nid=15887 addr=10.140.76.252:55852 laddr=10.140.86.124:6379 fd=56 name= age=28 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15888 addr=10.140.76.252:55868 laddr=10.140.86.124:6379 fd=57 name= age=28 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15889 addr=10.140.76.252:55874 laddr=10.140.86.124:6379 fd=74 name= age=28 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15890 addr=10.140.76.252:55866 laddr=10.140.86.124:6379 fd=75 name= age=28 idle=27 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15809 addr=10.140.76.252:40146 laddr=10.140.86.124:6379 fd=16 name= age=102 idle=1 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20504 events=r cmd=mget user=default redir=-1\r\nid=15408 addr=10.140.76.252:58504 laddr=10.140.86.124:6379 fd=17 name= age=961 idle=28 flags=N db=2 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 argv-mem=0 obl=0 oll=0 omem=0 tot-mem=20496 events=r cmd=exec user=default redir=-1\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ FAST MEMORY TEST ------\r\n1:M 15 Jan 2023 18:46:35.847 # Bio thread for job type #0 terminated\r\n1:M 15 Jan 2023 18:46:35.847 # Bio thread for job type #1 terminated\r\n1:M 15 Jan 2023 18:46:35.847 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 55e37ad3d000 (2281472 bytes)\r\n*** Preparing to test memory region 55e37c806000 (270336 bytes)\r\n*** Preparing to test memory region 7fdc7c400000 (5437915136 bytes)\r\n*** Preparing to test memory region 7fddc07fc000 (411041792 bytes)\r\n*** Preparing to test memory region 7fddd8ffd000 (8388608 bytes)\r\n*** Preparing to test memory region 7fddd97fe000 (8388608 bytes)\r\n*** Preparing to test memory region 7fddd9fff000 (8388608 bytes)\r\n*** Preparing to test memory region 7fddda800000 (8388608 bytes)\r\n*** Preparing to test memory region 7fdddb000000 (8388608 bytes)\r\n*** Preparing to test memory region 7fdddb802000 (24576 bytes)\r\n*** Preparing to test memory region 7fdddb9d9000 (16384 bytes)\r\n*** Preparing to test memory region 7fdddb9fb000 (16384 bytes)\r\n*** Preparing to test memory region 7fdddbcef000 (16384 bytes)\r\n*** Preparing to test memory region 7fdddbed0000 (8192 bytes)\r\n*** Preparing to test memory region 7fdddbf06000 (4096 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version\r\n\r\n- Worker OS: Bottlerocket OS 1.10.1 (aws-k8s-1.21)\r\n- [Container image](https://hub.docker.com/layers/bitnami/redis/6.2.8-debian-11-r11/images/sha256-43597d2799f9dc4fea8d647e2dd8b3dc0b147605cbaba75fd9f1440b73fff54f?context=explore)\r\n\r\n2. Steps to reproduce (if any)\r\n\r\n- Use a standalone instance (16 GB RAM / 1 CPU) as a query / index / bucket cache for Thanos (three databases).\r\n- Run a heavy query with Grafana, which causes Thanos components to both read from and write to the cache.",
  "state": "closed",
  "created_at": "2023-01-16T06:56:31Z",
  "updated_at": "2023-02-21T16:14:43Z",
  "closed_at": "2023-02-21T16:14:43Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1386828798,
      "user": "oranagra",
      "created_at": "2023-01-18T10:30:50Z",
      "body": "i can't figure it out.\r\ntried comparing 6.2.8 to 7.0 to see maybe there's a bug that's already fixed.\r\ntried looking at sensitive areas like blocking commands, but i see this deployment doesn't use them (also no modules being used).\r\nsuspected maybe it's somehow related to use of multi-exec and multiple databases, but i don't see how such a thing can cause that issue.\r\n@madolson @soloestoy @guybe7 @huangzhw maybe you can think of something."
    },
    {
      "id": 1407709110,
      "user": "yossigo",
      "created_at": "2023-01-29T16:27:50Z",
      "body": "@oranagra Could it be related to key expiration in an unexpected or uncommon flow?"
    },
    {
      "id": 1433246792,
      "user": "ranshid",
      "created_at": "2023-02-16T15:15:40Z",
      "body": "I think I have a theory:\r\nWe can see that some clients multi size is 10K so maybe it caused the trackingLimitUsedSlots that limits the size of the tracking table to push invalidations, but later on bail from the processCommand without calling after_command.\r\nWill try to reproduce. I am just having a hard time understanding what can cause the processCommand to bail"
    },
    {
      "id": 1433436255,
      "user": "madolson",
      "created_at": "2023-02-16T17:16:49Z",
      "body": "Also, just to reinforce that theory. The default max tracked items is 1 million, and this node crashed with `tracking_total_keys:1003824` items. Which is just over the limit."
    },
    {
      "id": 1433438241,
      "user": "madolson",
      "created_at": "2023-02-16T17:17:48Z",
      "body": "Also, unless I'm really off, won't just a regular `queued` command in a multi-exec cause this? "
    },
    {
      "id": 1433473173,
      "user": "madolson",
      "created_at": "2023-02-16T17:44:27Z",
      "body": "~~I don't have an answer, but~~ I managed to corrupt the reply protocol. \r\n1. If you reduce the number of tracked items to 5.\r\n2. On client one, execute:\r\n```\r\nclient tracking on\r\nmget foo1 foo2 foo3 foo4 foo6\r\nmulti\r\n```\r\n\r\n3. On client two, execute:\r\n```\r\nclient tracking on\r\nmget bar1 bar2 bar3 bar4 bar5\r\n```\r\n\r\n4. Then back on client one execute:\r\n```\r\nping\r\nexec\r\n```\r\n\r\nThe multi-response get's interleaved with the invalidations:\r\n```\r\n127.0.0.1:6379> client tracking on\r\nOK\r\n127.0.0.1:6379> mget foo1 foo2 foo3 foo4 foo6\r\n1) \"5\"\r\n2) (nil)\r\n3) (nil)\r\n4) (nil)\r\n5) (nil)\r\n127.0.0.1:6379> multi\r\nOK\r\n127.0.0.1:6379(TX)> ping\r\n1) \"invalidate\"\r\n2) 1) \"foo3\"\r\n127.0.0.1:6379(TX)> exec\r\n1) \"invalidate\"\r\n2) 1) \"foo2\"\r\n```\r\n\r\nNote these have to be in the same event loop, so I disabled the serverCron while running this test. EDIT: This also can cause it to crash. Let me write a TCL case to reproduce this."
    }
  ]
}