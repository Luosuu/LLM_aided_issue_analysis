{
  "issue_number": 11610.0,
  "title": "[CRASH] 7.0.5 installed from redislabs ppa crashed",
  "body": "Notice!\r\n- If a Redis module was involved, please open an issue in the module's repo instead!\r\n- If you're using docker on Apple M1, please make sure the image you're using was compiled for ARM!\r\n\r\n\r\n**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n(gdb) bt full\r\n#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50\r\n        set = {__val = {0, 139748469180824, 0, 140734866257039, 3616731346761019888, 128, 140734866256976, 2, 63, 140734866256368,\r\n            94322896223653, 140734866256752, 140734866256976, 139748471443354, 140734866256944, 139748472313904}}\r\n        pid = <optimized out>\r\n        tid = <optimized out>\r\n        ret = <optimized out>\r\n#1  0x00007f19b9f8f859 in __GI_abort () at abort.c:79\r\n        save_stage = 1\r\n        act = {__sigaction_handler = {sa_handler = 0x7fff63b5f43f, sa_sigaction = 0x7fff63b5f43f}, sa_mask = {__val = {\r\n              4199936040484592316, 18446744073709545184, 94322896266112, 139743462238400, 140734866262240, 4199936040296897212,\r\n              4288720840637012668, 0, 94322919711168, 0, 0, 94322896243096, 47, 140734866262240, 139748471467637, 0}},\r\n          sa_flags = -330405376, sa_restorer = 0x7fff00000001}\r\n        sigs = {__val = {32, 0 <repeats 15 times>}}\r\n#2  0x00007f19b9ff9fcc in __libc_message (action=do_abort, fmt=0x7f19ba123ebe \"%s\", fmt=0x7f19ba123ebe \"%s\", action=do_abort)\r\n    at ../sysdeps/posix/libc_fatal.c:155\r\n        ap = {{gp_offset = 24, fp_offset = 32537, overflow_arg_area = 0x7fff63b5f480, reg_save_area = 0x7fff63b5f420}}\r\n        fd = <optimized out>\r\n        list = 0x0\r\n        nlist = 1\r\n        cp = 0x7f19ba123ec0 \"\"\r\n#3  0x00007f19b9ffa2e0 in __GI___libc_fatal (\r\n    message=message@entry=0x7f19ba1790d8 \"libgcc_s.so.1 must be installed for pthread_cancel to work\\n\")\r\n    at ../sysdeps/posix/libc_fatal.c:164\r\nNo locals.\r\n#4  0x00007f19ba175ad9 in pthread_cancel_init () at ../sysdeps/nptl/unwind-forcedunwind.c:65\r\n        resume = <optimized out>\r\n        personality = <optimized out>\r\n        forcedunwind = <optimized out>\r\n        getcfa = <optimized out>\r\n        handle = 0x0\r\n#5  0x00007f19ba1720a4 in __pthread_cancel (th=139748453226240) at pthread_cancel.c:38\r\n        pd = 0x7f19b8e99700\r\n        result = <optimized out>\r\n        oldval = <optimized out>\r\n        newval = <optimized out>\r\n#6  0x000055c942a866e5 in bioKillThreads () at bio.c:313\r\n        err = <optimized out>\r\n        j = 0\r\n#7  0x000055c942a6d9ef in killThreads () at debug.c:1875\r\nNo locals.\r\n#8  doFastMemoryTest () at debug.c:1884\r\nNo locals.\r\n--Type <RET> for more, q to quit, c to continue without paging-- c\r\n#9  0x000055c942a70b7f in sigsegvHandler (sig=6, info=0x7fff63b5f670, secret=0x7fff63b5f540) at debug.c:1982\r\n        uc = 0x7fff63b5f540\r\n        eip = 0x7f19b9fb000b <__GI_raise+203>\r\n#10 <signal handler called>\r\nNo locals.\r\n#11 __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50\r\n        set = {__val = {0, 139748469180824, 0, 140734866261311, 11, 128, 2, 80, 139748465213248, 94322895730709, 94322897245392, 139748469180328, 94321776787458, 139745350909952, 94321776787457, 139748472313904}}\r\n        pid = <optimized out>\r\n        tid = <optimized out>\r\n        ret = <optimized out>\r\n#12 0x00007f19b9f8f859 in __GI_abort () at abort.c:79\r\n        save_stage = 1\r\n        act = {__sigaction_handler = {sa_handler = 0x7fff63b604ef, sa_sigaction = 0x7fff63b604ef}, sa_mask = {__val = {4199936044253174460, 18446744073709545184, 94322896266112, 139743462238400, 140734866262240, 4199936044099033788, 4288720840637012668, 0, 94322919711168, 0, 0, 94322896243096, 47, 140734866262240, 139748471467637, 0}}, sa_flags = -330405376, sa_restorer = 0x7fff00000001}\r\n        sigs = {__val = {32, 0 <repeats 15 times>}}\r\n#13 0x00007f19b9ff9fcc in __libc_message (action=do_abort, fmt=0x7f19ba123ebe \"%s\", fmt=0x7f19ba123ebe \"%s\", action=do_abort) at ../sysdeps/posix/libc_fatal.c:155\r\n        ap = {{gp_offset = 24, fp_offset = 32537, overflow_arg_area = 0x7fff63b60530, reg_save_area = 0x7fff63b604d0}}\r\n        fd = <optimized out>\r\n        list = 0x0\r\n        nlist = 1\r\n        cp = 0x7f19ba123ec0 \"\"\r\n#14 0x00007f19b9ffa2e0 in __GI___libc_fatal (message=message@entry=0x7f19ba1790d8 \"libgcc_s.so.1 must be installed for pthread_cancel to work\\n\") at ../sysdeps/posix/libc_fatal.c:164\r\nNo locals.\r\n#15 0x00007f19ba175ad9 in pthread_cancel_init () at ../sysdeps/nptl/unwind-forcedunwind.c:65\r\n        resume = <optimized out>\r\n        personality = <optimized out>\r\n        forcedunwind = <optimized out>\r\n        getcfa = <optimized out>\r\n        handle = 0x0\r\n#16 0x00007f19ba1720a4 in __pthread_cancel (th=139748453226240) at pthread_cancel.c:38\r\n        pd = 0x7f19b8e99700\r\n        result = <optimized out>\r\n        oldval = <optimized out>\r\n        newval = <optimized out>\r\n#17 0x000055c942a866e5 in bioKillThreads () at bio.c:313\r\n        err = <optimized out>\r\n        j = 0\r\n#18 0x000055c942a6d9ef in killThreads () at debug.c:1875\r\nNo locals.\r\n#19 doFastMemoryTest () at debug.c:1884\r\nNo locals.\r\n#20 0x000055c942a6dec3 in _serverPanic (file=0x55c942b83707 \"server.c\", line=6580, msg=<optimized out>) at debug.c:1107\r\n        ap = {{gp_offset = 32, fp_offset = 48, overflow_arg_area = 0x7fff63b607c0, reg_save_area = 0x7fff63b606f0}}\r\n        fmtmsg = \"Redis aborting for OUT OF MEMORY. Allocating 528443 bytes!\\000\\000\\000\\000\\000\\000<\\000\\000\\000\\000\\000\\000\\000\\327\\006\\266c\\377\\177\\000\\000o\\006\\266c\\377\\177\\000\\000o\\006\\266c\\377\\177\\000\\000\\250\\aݹ\\031\\177\\000\\000\\000jN\\354<\\000\\000\\000o\\006\\266c\\377\\177\\000\\000\\000\\020\\n\\000\\000\\000\\000\\000`\\205;S\\031\\177\\000\\000\\017\\251\\241B\\311U\\000\\001\\240\\262\\300B\\311U\\000\\000\\000jN췐i\\277\\033\\070\\270B\\311U\\000\\000\\000\\000\\000\\000\\000\\000\\000\\000\\300\\t\\240\\271\\031\\177\\000\\000\\250\\aݹ\\031\\177\\000\\000\\000\\000\\n\\000\\000\\000\\000\\000@\\000\\000\\000\\000\\000\\000\\000\"...\r\n#21 0x000055c942a0961f in redisOutOfMemoryHandler (allocation_size=528443) at server.c:6580\r\nNo locals.\r\n#22 0x000055c942a1a9ae in zmalloc_usable (size=size@entry=528443, usable=usable@entry=0x7fff63b607f0) at zmalloc.c:143\r\n        ptr = 0x0\r\n#23 0x000055c942a27bec in _addReplyProtoToList (c=0x7f1988555a00, s=0x7f188f6d28c0 \"\\\\Inventory\\\\Entity\\\\InventoryItem\", len=528427) at networking.c:369\r\n        usable_size = 0\r\n        size = 528427\r\n        ln = <optimized out>\r\n        tail = <optimized out>\r\n#24 0x000055c942a27d3f in addReply (c=0x7f1988555a00, obj=0x7f195cce4380) at networking.c:416\r\n        buf = \"\\000\\200\\211\\271\\031\\177\\000\\000WX\\243B\\311U\\000\\000\\200\\372\\006!\\031\\177\\000\\000\\017\\000\\000\\000\\000\\000\\000\"\r\n        len = <optimized out>\r\n#25 0x000055c942a29bb4 in addReplyBulk (c=0x7f1988555a00, obj=0x7f195cce4380) at networking.c:993\r\nNo locals.\r\n#26 0x000055c942a49203 in getGenericCommand (c=0x7f1988555a00) at t_string.c:324\r\n        o = 0x7f195cce4380\r\n#27 0x000055c942a0d90f in call (c=0x7f1988555a00, flags=15) at server.c:3319\r\n        dirty = <optimized out>\r\n        client_old_flags = 0\r\n        real_cmd = 0x55c942c2fcb0 <redisCommandTable+114576>\r\n        prev_core_propagates = <optimized out>\r\n        call_timer = 1670842699209995\r\n        monotonic_start = 0\r\n        duration = <optimized out>\r\n        zmalloc_used = <optimized out>\r\n#28 0x000055c942a0ee1d in processCommand (c=c@entry=0x7f1988555a00) at server.c:3953\r\n        err = 0x7f18d720c6c5 \"*2\\r\\n$3\\r\\nGET\\r\\n$32\\r\\ninventory_76561199381052974_csgo\\r\\n\"\r\n        cmd_flags = 16386\r\n        is_read_command = <optimized out>\r\n        is_write_command = <optimized out>\r\n        is_denyoom_command = <optimized out>\r\n        is_denystale_command = <optimized out>\r\n        is_denyloading_command = <optimized out>\r\n        is_may_replicate_command = <optimized out>\r\n        is_deny_async_loading_command = 0\r\n        obey_client = <optimized out>\r\n        acl_errpos = 1119400080\r\n        acl_retval = 0\r\n        deny_write_type = <optimized out>\r\n#29 0x000055c942a26630 in processCommandAndResetClient (c=c@entry=0x7f1988555a00) at networking.c:2444\r\n        deadclient = 0\r\n        old_client = 0x0\r\n#30 0x000055c942a293f8 in processInputBuffer (c=0x7f1988555a00) at networking.c:2548\r\nNo locals.\r\n#31 0x000055c942a2cbd8 in readQueryFromClient (conn=<optimized out>) at networking.c:2684\r\n        c = 0x7f1988555a00\r\n        nread = 52\r\n        big_arg = <optimized out>\r\n        qblen = <optimized out>\r\n        readlen = 20474\r\n#32 0x000055c942ad630c in callHandler (handler=<optimized out>, conn=0x7f199a3d8900) at connhelpers.h:79\r\nNo locals.\r\n#33 connSocketEventHandler (el=<optimized out>, fd=<optimized out>, clientData=0x7f199a3d8900, mask=<optimized out>) at connection.c:310\r\n        conn = 0x7f199a3d8900\r\n        invert = 0\r\n        call_write = <optimized out>\r\n        call_read = 1\r\n#34 0x000055c942a048ca in aeProcessEvents (eventLoop=eventLoop@entry=0x7f19b982b0f0, flags=flags@entry=27) at ae.c:436\r\n        fd = <optimized out>\r\n        mask = 1\r\n        invert = <optimized out>\r\n        fe = <optimized out>\r\n        fired = 0\r\n        j = 0\r\n        tv = {tv_sec = 0, tv_usec = 8869}\r\n        tvp = <optimized out>\r\n        usUntilTimer = <optimized out>\r\n        processed = 0\r\n        numevents = 1\r\n#35 0x000055c942a04c8d in aeMain (eventLoop=0x7f19b982b0f0) at ae.c:496\r\nNo locals.\r\n#36 0x000055c942a007ba in main (argc=<optimized out>, argv=0x7fff63b60c48) at server.c:7075\r\n        tv = {tv_sec = 1670723146, tv_usec = 502223}\r\n        j = <optimized out>\r\n        config_from_stdin = <optimized out>\r\n        hashseed = \"\\021\\215\\020\\235>\\242u\\325\\373\\203 \\302\\016\\347\\232~\"\r\n        exec_name = <optimized out>\r\n        background = <optimized out>\r\n(gdb)\r\n\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version - ubuntu 20.04\r\n2. Steps to reproduce (if any)\r\n",
  "state": "closed",
  "created_at": "2022-12-12T13:20:01Z",
  "updated_at": "2022-12-14T17:39:50Z",
  "closed_at": "2022-12-14T17:39:50Z",
  "labels": [
    "state:to-be-closed"
  ],
  "comments_data": [
    {
      "id": 1346884558,
      "user": "shipitsin-ilia",
      "created_at": "2022-12-12T17:02:37Z",
      "body": "in gdb backtrace I see `fmtmsg = \"Redis aborting for OUT OF MEMORY.`, but I do not see that in redis log, shouldn't it be there ?\r\n\r\nbtw, I noticed that 7.0.6 was released today, I'll try it"
    },
    {
      "id": 1348139032,
      "user": "oranagra",
      "created_at": "2022-12-13T10:21:50Z",
      "body": "yes, the OOM panic should have been in the log.\r\ndid you get a crash log? or did running it in gdb prevented that?\r\ni wonder how much memory redis consumed and and how much memory was on the OS.\r\n\r\nthe one thing that's new in 7.0.6 in that regard, is an improved warning about bad overcommit setting, see https://github.com/redis/redis/pull/11357\r\nthis can cause OOM panic even if there is enough memory see https://github.com/jemalloc/jemalloc/issues/1328"
    },
    {
      "id": 1349604798,
      "user": "shipitsin-ilia",
      "created_at": "2022-12-13T19:52:27Z",
      "body": "I have core dump, redis binary. Thus I was able to extract \"bt full\" (see above).\r\nI did not get anything like \"out of memory\" in redis logs.\r\n\r\nI have full \"redis-server.log\", I can share it privately"
    },
    {
      "id": 1349605720,
      "user": "shipitsin-ilia",
      "created_at": "2022-12-13T19:53:27Z",
      "body": "redis was running on itself (supervised by systemd as usual), no gdb."
    },
    {
      "id": 1349610927,
      "user": "shipitsin-ilia",
      "created_at": "2022-12-13T19:58:55Z",
      "body": "as for warning, I'm afraid nobody will look at logs as soon as redis starts and ready to serve requests.\r\nif it is possible to refuse to start in that case, it might get an attention"
    },
    {
      "id": 1350501417,
      "user": "oranagra",
      "created_at": "2022-12-14T06:55:19Z",
      "body": "please check and report what value you have with `/proc/sys/vm/overcommit_memory` and which version of jemalloc you're using (INFO MEMORY).\r\n\r\nyou're saying that you don't see something similar to these prints in the log:\r\n```\r\nOut Of Memory allocating %zu bytes!\r\n------------------------------------------------\r\n!!! Software Failure. Press left mouse button to continue\r\nGuru Meditation: Redis aborting for OUT OF MEMORY. Allocating %zu bytes!\r\n------ STACK TRACE ------\r\n```\r\n\r\nyou're welcome to send the log over to oran@redis.com"
    },
    {
      "id": 1351488801,
      "user": "shipitsin-ilia",
      "created_at": "2022-12-14T14:21:52Z",
      "body": "```\r\n$ cat /proc/sys/vm/overcommit_memory\r\n2\r\n$\r\n```\r\n\r\n\r\nindeed, there are such messages, I did not notice them earlier\r\n\r\n```\r\n# grep 'Out Of Memory allocating' redis-server.log\r\n123965:M 11 Dec 2022 01:45:37.419 # Out Of Memory allocating 2046331 bytes!\r\n28673:M 12 Dec 2022 10:58:19.210 # Out Of Memory allocating 528443 bytes!\r\n#\r\n```\r\n\r\nas for jemalloc, I cannot check now, it was redis-7.0.5, we updated to 7.0.6, it is not possible to install 7.0.5, it is gone from PPA.\r\n\r\nlog sent"
    },
    {
      "id": 1351621290,
      "user": "oranagra",
      "created_at": "2022-12-14T15:21:33Z",
      "body": "your overcommit_memory setting is bad (as indicated by the above jemalloc issue i shared).\r\nit causes VM fragmentation which then leads to being unable to allocate memory (despite having free memory).\r\nyou may be able to tweak that using `vm.max_map_count` as suggested in #10234, but the right solution is to change `overcommit_memory` to 1 (as advised by redis on startup)"
    },
    {
      "id": 1351835112,
      "user": "shipitsin-ilia",
      "created_at": "2022-12-14T17:39:49Z",
      "body": "thanks. we'll review overcommit settings."
    }
  ]
}