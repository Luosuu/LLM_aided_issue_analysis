{
  "issue_number": 11619.0,
  "title": "make test fails on alpine 3.16 image [BUG]",
  "body": "Hi,\r\nI'm trying to build redis on alpine 3.16 but when running \"make test\" it fails with the following output:\r\n```\r\n[err]: CONFIG SET oom-score-adj works as expected in tests/unit/oom-score-adj.tcl\r\nExpected [get_oom_score_adj] == [expr 1000 + 10] (context: type eval line 8 cmd {assert {[get_oom_score_adj] == [expr $base + 10]}} proc ::test)\r\n[exception]: Executing test client: invalid argument.\r\ninvalid argument\r\n    while executing\r\n\"close $fd\"\r\n    (procedure \"set_oom_score_adj\" line 7)\r\n    invoked from within\r\n\"set_oom_score_adj $other_val2\"\r\n    (\"uplevel\" body line 9)\r\n    invoked from within\r\n\"uplevel 1 $code\"\r\n    (procedure \"test\" line 51)\r\n    invoked from within\r\n\"test {CONFIG SET oom-score-adj-values doesn't touch proc when disabled} {\r\n            set orig_osa [get_oom_score_adj]\r\n            \r\n            set ot...\"\r\n    (\"uplevel\" body line 82)\r\n    invoked from within\r\n\"uplevel 1 $code \"\r\n    (procedure \"start_server\" line 3)\r\n    invoked from within\r\n\"start_server {tags {\"oom-score-adj external:skip\"}} {\r\n        proc get_oom_score_adj {{pid \"\"}} {\r\n            if {$pid == \"\"} {\r\n                set pi...\"\r\n    (file \"tests/unit/oom-score-adj.tcl\" line 5)\r\n    invoked from within\r\n\"source $path\"\r\n    (procedure \"execute_test_file\" line 4)\r\n    invoked from within\r\n\"execute_test_file $data\"\r\n    (procedure \"test_client_main\" line 10)\r\n    invoked from within\r\n\"test_client_main $::test_server_port \"\r\nKilling still running Redis server 1322\r\nKilling still running Redis server 2822\r\nKilling still running Redis server 2844\r\nKilling still running Redis server 2897\r\nKilling still running Redis server 3120\r\nKilling still running Redis server 3152\r\nKilling still running Redis server 3487\r\nKilling still running Redis server 3541\r\nKilling still running Redis server 3567\r\nKilling still running Redis server 3596\r\nKilling still running Redis server 3615\r\nKilling still running Redis server 3632\r\nKilling still running Redis server 3649\r\nKilling still running Redis server 3666\r\nKilling still running Redis server 3688\r\nKilling still running Redis server 3706\r\nKilling still running Redis server 3722\r\nKilling still running Redis server 3986\r\nKilling still running Redis server 4287\r\nKilling still running Redis server 4663\r\nKilling still running Redis server 4717\r\nKilling still running Redis server 5398\r\nKilling still running Redis server 5486\r\nKilling still running Redis server 6467\r\nKilling still running Redis server 6618\r\nKilling still running Redis server 6653\r\nKilling still running Redis server 6679\r\nKilling still running Redis server 6718\r\nKilling still running Redis server 6771\r\nKilling still running Redis server 6814\r\nKilling still running Redis server 6841\r\nKilling still running Redis server 6856\r\nKilling still running Redis server 6931\r\nKilling still running Redis server 6983\r\nKilling still running Redis server 7014\r\nKilling still running Redis server 7105\r\nKilling still running Redis server 7340\r\nKilling still running Redis server 7492\r\nKilling still running Redis server 7694\r\nKilling still running Redis server 7757\r\nKilling still running Redis server 7822\r\nKilling still running Redis server 8042\r\nKilling still running Redis server 8936\r\nKilling still running Redis server 9024\r\nKilling still running Redis server 9323\r\nKilling still running Redis server 9598\r\nKilling still running Redis server 9879\r\nKilling still running Redis server 10020\r\nKilling still running Redis server 10343\r\nKilling still running Redis server 10427\r\nKilling still running Redis server 10455\r\nKilling still running Redis server 10503\r\nKilling still running Redis server 11572\r\nKilling still running Redis server 11779\r\nKilling still running Redis server 11802\r\nI/O error reading reply\r\n    while executing\r\n\"{*}$r del $k\"\r\n    (\"uplevel\" body line 2)\r\n    invoked from within\r\n\"uplevel 1 [lindex $args $path]\"\r\n    (procedure \"randpath\" line 3)\r\n    invoked from within\r\n\"randpath {\r\n                {*}$r set $k $v\r\n            } {\r\n                {*}$r lpush $k $v\r\n            } {\r\n                {*}$r sadd $k $v\r\n        ...\"\r\n    (procedure \"createComplexDataset\" line 36)\r\n    invoked from within\r\n\"createComplexDataset $r $ops\"\r\n    (procedure \"bg_complex_data\" line 5)\r\n    invoked from within\r\n\"bg_complex_data [lindex $argv 0] [lindex $argv 1] [lindex $argv 2] [lindex $argv 3] [lindex $argv 4]\"\r\n    (file \"tests/helpers/bg_complex_data.tcl\" line 13)\r\nI/O error reading reply\r\n    while executing\r\n\"{*}$r type $k\"\r\n    (procedure \"findKeyWithType\" line 7)\r\n    invoked from within\r\n\"findKeyWithType {*}$r zset\"\r\n    (\"uplevel\" body line 2)\r\n    invoked from within\r\n\"uplevel 1 [lindex $args $path]\"\r\n    (procedure \"randpath\" line 3)\r\n    invoked from within\r\n\"randpath {{*}$r zadd $k $d $v}  {{*}$r zrem $k $v}  {\r\n                            set otherzset [findKeyWithType {*}$r zset]\r\n                         ...\"\r\n    (procedure \"createComplexDataset\" line 74)\r\n    invoked from within\r\n\"createComplexDataset $r $ops\"\r\n    (procedure \"bg_complex_data\" line 5)\r\n    invoked from within\r\n\"bg_complex_data [lindex $argv 0] [lindex $argv 1] [lindex $argv 2] [lindex $argv 3] [lindex $argv 4]\"\r\n    (file \"tests/helpers/bg_complex_data.tcl\" line 13)\r\nI/O error reading reply\r\n    while executing\r\n\"{*}$r type $k\"\r\n    (procedure \"createComplexDataset\" line 33)\r\n    invoked from within\r\n\"createComplexDataset $r $ops\"\r\n    (procedure \"bg_complex_data\" line 5)\r\n    invoked from within\r\n\"bg_complex_data [lindex $argv 0] [lindex $argv 1] [lindex $argv 2] [lindex $argv 3] [lindex $argv 4]\"\r\n    (file \"tests/helpers/bg_complex_data.tcl\" line 13)\r\nKilling still running Redis server 11861\r\nKilling still running Redis server 11857\r\nKilling still running Redis server 11892\r\nKilling still running Redis server 11969\r\nKilling still running Redis server 12040\r\nKilling still running Redis server 12058\r\nKilling still running Redis server 12500\r\nKilling still running Redis server 12716\r\nKilling still running Redis server 12748\r\nKilling still running Redis server 12848\r\nI/O error reading reply\r\n    while executing\r\n\"$r set [expr rand()] [expr rand()]\"\r\n    (procedure \"gen_write_load\" line 7)\r\n    invoked from within\r\n\"gen_write_load [lindex $argv 0] [lindex $argv 1] [lindex $argv 2] [lindex $argv 3]\"\r\n    (file \"tests/helpers/gen_write_load.tcl\" line 18)\r\nKilling still running Redis server 12954\r\nI/O error reading reply\r\n    while executing\r\n\"{*}$r type $k\"\r\n    (procedure \"findKeyWithType\" line 7)\r\n    invoked from within\r\n\"findKeyWithType {*}$r zset\"\r\n    (\"uplevel\" body line 2)\r\n    invoked from within\r\n\"uplevel 1 [lindex $args $path]\"\r\n    (procedure \"randpath\" line 3)\r\n    invoked from within\r\n\"randpath {{*}$r zadd $k $d $v}  {{*}$r zrem $k $v}  {\r\n                            set otherzset [findKeyWithType {*}$r zset]\r\n                         ...\"\r\n    (procedure \"createComplexDataset\" line 74)\r\n    invoked from within\r\n\"createComplexDataset $r $ops\"\r\n    (procedure \"bg_complex_data\" line 5)\r\n    invoked from within\r\n\"bg_complex_data [lindex $argv 0] [lindex $argv 1] [lindex $argv 2] [lindex $argv 3] [lindex $argv 4]\"\r\n    (file \"tests/helpers/bg_complex_data.tcl\" line 13)\r\nKilling still running Redis server 12998\r\nI/O error reading reply\r\n    while executing\r\n\"{*}$r type $k\"\r\n    (procedure \"findKeyWithType\" line 7)\r\n    invoked from within\r\n\"findKeyWithType {*}$r zset\"\r\n    (\"uplevel\" body line 2)\r\n    invoked from within\r\n\"uplevel 1 [lindex $args $path]\"\r\n    (procedure \"randpath\" line 3)\r\n    invoked from within\r\n\"randpath {{*}$r zadd $k $d $v}  {{*}$r zrem $k $v}  {\r\n                            set otherzset [findKeyWithType {*}$r zset]\r\n                         ...\"\r\n    (procedure \"createComplexDataset\" line 74)\r\n    invoked from within\r\n\"createComplexDataset $r $ops\"\r\n    (procedure \"bg_complex_data\" line 5)\r\n    invoked from within\r\n\"bg_complex_data [lindex $argv 0] [lindex $argv 1] [lindex $argv 2] [lindex $argv 3] [lindex $argv 4]\"\r\n    (file \"tests/helpers/bg_complex_data.tcl\" line 13)\r\nKilling still running Redis server 13117\r\nI/O error reading reply\r\n    while executing\r\n\"{*}$r zadd $k $d $v\"\r\n    (\"uplevel\" body line 2)\r\n    invoked from within\r\n\"uplevel 1 [lindex $args $path]\"\r\n    (procedure \"randpath\" line 3)\r\n    invoked from within\r\n\"randpath {\r\n                {*}$r set $k $v\r\n            } {\r\n                {*}$r lpush $k $v\r\n            } {\r\n                {*}$r sadd $k $v\r\n        ...\"\r\n    (procedure \"createComplexDataset\" line 36)\r\n    invoked from within\r\n\"createComplexDataset $r $ops\"\r\n    (procedure \"bg_complex_data\" line 5)\r\n    invoked from within\r\n\"bg_complex_data [lindex $argv 0] [lindex $argv 1] [lindex $argv 2] [lindex $argv 3] [lindex $argv 4]\"\r\n    (file \"tests/helpers/bg_complex_data.tcl\" line 13)\r\nmake[2]: *** [Makefile:447: test] Error 1\r\n```\r\n\r\nTo build redis before testing I ran:\r\nmake distclean && make V=1 MALLOC=libc && make test",
  "state": "open",
  "created_at": "2022-12-14T08:16:17Z",
  "updated_at": "2022-12-14T14:02:32Z",
  "closed_at": null,
  "labels": [],
  "comments_data": [
    {
      "id": 1351335073,
      "user": "sundb",
      "created_at": "2022-12-14T13:15:00Z",
      "body": "@nadavtsa What version are you using?  From the logs, I guess you should be using 7.x.\r\nAre you running in docker or on mac M1? \r\nDo you fail every time or just this once?"
    },
    {
      "id": 1351387379,
      "user": "oranagra",
      "created_at": "2022-12-14T13:47:23Z",
      "body": "For the record, we do run our daily tests on alpine (`alpine:latest` image): https://github.com/redis/redis/actions/runs/3690431795/jobs/6247418673\r\n\r\nAs far as i can tell, this specific failure looks more like a TCL issue (not a redis issue)"
    },
    {
      "id": 1351412173,
      "user": "nadavtsa",
      "created_at": "2022-12-14T14:02:08Z",
      "body": "@sundb \r\nI'm using redis 7.0.5 and running in docker.\r\nI actually solved this issue by setting the oom_score_adj of all processes to zero before building redis with the following loop:\r\n```\r\nfor d in /proc/* ; do [[ -d \"$d\" && -f \"$d\"/oom_score_adj ]] && echo \"0\" > \"$d\"/oom_score_adj ; done\r\n```\r\n\r\nIt seems that for some reason, before building Redis, the oom_score_adj  of some processes was already set close enough to 1000 and when the oom  test ran the commands:\r\n```\r\nr config set oom-score-adj-values \"10 20 30\"\r\nr config set oom-score-adj yes\r\n```\r\nThe OOM Killer was called and killed the process."
    }
  ]
}