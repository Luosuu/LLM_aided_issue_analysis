{
  "issue_number": 2634.0,
  "title": "Redis server crashed",
  "body": "Try to mass insert 2763546222 ~= 2.7 billion records using redis pipe mode.  That is to call \"set key value\" 2.7 billion times where key is a numeric value of length 10, and value is another numeric value of length 14.  All 2.7 billion keys are all unique.\n\nServer crashed with the following message.\n\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\n37805:M 20 Jun 04:41:54.898 #     Redis 3.0.2 crashed by signal: 11\n37805:M 20 Jun 04:41:54.898 #     Failed assertion: <no assertion failed> (<no file>:0)\n37805:M 20 Jun 04:41:54.898 # --- STACK TRACE\nredis-server *:6379(logStackTrace+0x43)[0x450283]\nredis-server *:6379(dictAddRaw+0xe4)[0x41d114]\n/lib64/libpthread.so.0[0x3117a0f500]\nredis-server *:6379(dictAddRaw+0xe4)[0x41d114]\nredis-server *:6379(dictAdd+0x1e)[0x41d23e]\nredis-server *:6379(dbAdd+0x34)[0x431134]\nredis-server *:6379(setKey+0x76)[0x431466]\nredis-server *:6379(setGenericCommand+0xa4)[0x439594]\nredis-server *:6379(setCommand+0xea)[0x4398fa]\nredis-server *:6379(call+0x72)[0x420112]\nredis-server *:6379(processCommand+0x3e5)[0x420735]\nredis-server *:6379(processInputBuffer+0x4f)[0x42c5bf]\nredis-server *:6379(readQueryFromClient+0xc2)[0x42c702]\nredis-server *:6379(aeProcessEvents+0x13c)[0x41a4dc]\nredis-server *:6379(aeMain+0x2b)[0x41a79b]\nredis-server *:6379(main+0x2cd)[0x423bdd]\n/lib64/libc.so.6(__libc_start_main+0xfd)[0x311761ecdd]\nredis-server *:6379[0x419af9]\n37805:M 20 Jun 04:41:54.914 # --- INFO OUTPUT\n37805:M 20 Jun 04:41:54.915 # # Server\nredis_version:3.0.2\nredis_git_sha1:00000000\nredis_git_dirty:0\nredis_build_id:f9a4c13bf0cfce29\nredis_mode:standalone\nos:Linux 2.6.32-358.el6.x86_64 x86_64\narch_bits:64\nmultiplexing_api:epoll\ngcc_version:4.4.7\nprocess_id:37805\nrun_id:9b626c2d541b006e50ae52a9a778150f245dff09\ntcp_port:6379\nuptime_in_seconds:6101\nuptime_in_days:0\nhz:10\nlru_clock:8711954\nconfig_file:/opt/my-redis-db/conf/my-redis.conf\n# Clients\n\nconnected_clients:1\nclient_longest_output_list:0\nclient_biggest_input_buf:16305\nblocked_clients:0\n# Memory\n\nused_memory:183038796968\nused_memory_human:170.47G\nused_memory_rss:151509647360\nused_memory_peak:183038796968\nused_memory_peak_human:170.47G\nused_memory_lua:36864\nmem_fragmentation_ratio:0.83\nmem_allocator:jemalloc-3.6.0\n# Persistence\n\nloading:0\nrdb_changes_since_last_save:200404158\nrdb_bgsave_in_progress:0\nrdb_last_save_time:1434775314\nrdb_last_bgsave_status:ok\nrdb_last_bgsave_time_sec:1345\nrdb_current_bgsave_time_sec:-1\naof_enabled:0\naof_rewrite_in_progress:0\naof_rewrite_scheduled:0\naof_last_rewrite_time_sec:-1\naof_current_rewrite_time_sec:-1\naof_last_bgrewrite_status:ok\naof_last_write_status:ok\n# Stats\n\ntotal_connections_received:35\ntotal_commands_processed:1323671514\ninstantaneous_ops_per_sec:367836\ntotal_net_input_bytes:67350126470\ntotal_net_output_bytes:9388657003\ninstantaneous_input_kbps:18320.00\ninstantaneous_output_kbps:1796.08\nrejected_connections:0\nsync_full:0\nsync_partial_ok:0\nsync_partial_err:0\nexpired_keys:0\nevicted_keys:0\nkeyspace_hits:1\nkeyspace_misses:0\npubsub_channels:0\npubsub_patterns:0\nlatest_fork_usec:4774105\nmigrate_cached_sockets:0\n# Replication\n\nrole:master\nconnected_slaves:0\nmaster_repl_offset:0\nrepl_backlog_active:0\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:0\nrepl_backlog_histlen:0\n# CPU\n\nused_cpu_sys:237.57\nused_cpu_user:3324.40\nused_cpu_sys_children:189.85\nused_cpu_user_children:4272.21\n# Commandstats\n\ncmdstat_get:calls=1,usec=15,usec_per_call=15.00\ncmdstat_set:calls=1323671445,usec=1521108636,usec_per_call=1.15\ncmdstat_select:calls=32,usec=91,usec_per_call=2.84\ncmdstat_echo:calls=29,usec=15,usec_per_call=0.52\ncmdstat_info:calls=7,usec=218,usec_per_call=31.14\n# Cluster\n\ncluster_enabled:0\n# Keyspace\n\ndb0:keys=1250787121,expires=0,avg_ttl=0\nhash_init_value: 1434577653\n\n37805:M 20 Jun 04:41:54.915 # --- CLIENT LIST OUTPUT\n37805:M 20 Jun 04:41:54.915 # id=36 addr=127.0.0.1:54284 fd=5 name= age=44 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=16305 qbuf-free=16473 ob\nl=1610 oll=0 omem=0 events=rw cmd=set\n\n37805:M 20 Jun 04:41:54.915 # --- CURRENT CLIENT INFO\n37805:M 20 Jun 04:41:54.915 # client: id=36 addr=127.0.0.1:54284 fd=5 name= age=44 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=16305 qbuf-free=\n16473 obl=1610 oll=0 omem=0 events=rw cmd=set\n37805:M 20 Jun 04:41:54.915 # argv[0]: 'SET'\n37805:M 20 Jun 04:41:54.915 # argv[1]: '1499545777'\n37805:M 20 Jun 04:41:54.915 # argv[2]: '1190385878.238'\n37805:M 20 Jun 04:41:54.915 # --- REGISTERS\n37805:M 20 Jun 04:41:54.915 #\nRAX:00007f022dc00000 RBX:00007f0a2dc3bc00\nRCX:000000000000001a RDX:0000000000000002\nRDI:00007f0a2dc3bc00 RSI:0000000000000001\nRBP:00007f2d83c11200 RSP:00007fff5c0356b0\nR8 :0000000004c09fd9 R9 :000000000000001a\nR10:0000000000000006 R11:ffffffffffffffd8\nR12:00007f0a2dc3bbe8 R13:00007f2d83c11230\nR14:ffffffffde8edb42 R15:00000000de8edb42\nRIP:000000000041d114 EFL:0000000000010206\nCSGSFS:0000000000000033\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356bf) -> 00007f0de2006af0\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356be) -> 00007f2d83d52000\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356bd) -> 0000000000431134\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356bc) -> 00007f2d83d52000\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356bb) -> 00007f0a2dc3c580\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356ba) -> 00007f0de2006af0\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356b9) -> 000000000041d23e\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356b8) -> 0000000000000000\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356b7) -> 0000000000000000\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356b6) -> 0000000000000000\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356b5) -> 00007f0a2dc3c580\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356b4) -> 00007f0a2dc3c580\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356b3) -> 00007f2d83c11200\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356b2) -> 00007f0a2dc3bbe0\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356b1) -> 00007f2d83c11240\n37805:M 20 Jun 04:41:54.915 # (00007fff5c0356b0) -> 0000000000000000\n37805:M 20 Jun 04:41:54.915 # --- FAST MEMORY TEST\n37805:M 20 Jun 04:41:54.916 # Bio thread for job type #0 terminated\n37805:M 20 Jun 04:41:54.916 # Bio thread for job type #1 terminated\n37805:M 20 Jun 05:10:01.780 # Fast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if poss\nible.\n37805:M 20 Jun 05:10:01.780 #\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\n",
  "state": "open",
  "created_at": "2015-06-22T17:53:50Z",
  "updated_at": "2015-06-22T18:01:21Z",
  "closed_at": null,
  "labels": [
    "non critical bug",
    "crash report"
  ],
  "comments_data": [
    {
      "id": 114199759,
      "user": "antirez",
      "created_at": "2015-06-22T17:58:37Z",
      "body": "Very probable bad memory module, please inspect your systems with a test running for some time. As a first start you may want to try with `redis-server --test-memory`.\n"
    },
    {
      "id": 114199961,
      "user": "antirez",
      "created_at": "2015-06-22T17:59:24Z",
      "body": "No sorry, noticed only now the amount of items you tried to insert. This is a bug :-)\n"
    },
    {
      "id": 114200405,
      "user": "antirez",
      "created_at": "2015-06-22T18:00:55Z",
      "body": "Ok so, let's try to fix this issue:\n1. Could you try if this is easy to reproduce?\n2. GDB trace please? there is a guide at redis.io to provide it..\n\nThanks.\n"
    }
  ]
}