{
  "issue_number": 9636.0,
  "title": "[CRASH]",
  "body": "**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n1:M 15 Oct 2021 19:55:18.339 # Redis 6.2.3 crashed by signal: 11, si_code: 1\r\n1:M 15 Oct 2021 19:55:18.340 # Accessing address: 0xffffffffffffffc9\r\n1:M 15 Oct 2021 19:55:18.340 # Crashed running the instruction at: 0x40040220f1\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n/usr/lib/redis/modules/redisearch.so(DocTable_Get+0x41)[0x40040220f1]\r\n\r\nBacktrace:\r\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x12730)[0x400217e730]\r\n/usr/lib/redis/modules/redisearch.so(DocTable_Get+0x41)[0x40040220f1]\r\n/usr/lib/redis/modules/redisearch.so(+0xb461d)[0x400403461d]\r\n/usr/lib/redis/modules/redisearch.so(Indexer_Add+0x55)[0x4004034af5]\r\n/usr/lib/redis/modules/redisearch.so(Document_AddToIndexes+0x14d)[0x4004024c6d]\r\n/usr/lib/redis/modules/redisearch.so(AddDocumentCtx_Submit+0x116)[0x4004024e76]\r\n/usr/lib/redis/modules/redisearch.so(IndexSpec_UpdateWithHash+0xba)[0x400405166a]\r\n/usr/lib/redis/modules/redisearch.so(Indexes_UpdateMatchingWithSchemaRules+0x45)[0x4004051c35]\r\n/usr/lib/redis/modules/redisearch.so(HashNotificationCallback+0x11d)[0x400403d15d]\r\n/usr/local/bin/redis-server *:6379(moduleNotifyKeyspaceEvent+0xbe)[0x40000d570e]\r\n/usr/local/bin/redis-server *:6379(notifyKeyspaceEvent+0x21)[0x40000c3131]\r\n/usr/local/bin/redis-server *:6379(hsetCommand+0xfd)[0x400009016d]\r\n/usr/local/bin/redis-server *:6379(call+0xad)[0x400004cc6d]\r\n/usr/local/bin/redis-server *:6379(processCommand+0x5b3)[0x400004e7a3]\r\n/usr/local/bin/redis-server *:6379(processCommandAndResetClient+0x1c)[0x4000061f3c]\r\n/usr/local/bin/redis-server *:6379(processInputBuffer+0xea)[0x40000645aa]\r\n/usr/local/bin/redis-server *:6379(+0xf3bd8)[0x40000f3bd8]\r\n/usr/local/bin/redis-server *:6379(aeProcessEvents+0x2a1)[0x4000045ce1]\r\n/usr/local/bin/redis-server *:6379(aeMain+0x1d)[0x4000045f3d]\r\n/usr/local/bin/redis-server *:6379(main+0x314)[0x40000426f4]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xeb)[0x40021b109b]\r\n/usr/local/bin/redis-server *:6379(_start+0x2a)[0x4000042bda]\r\n\r\n------ REGISTERS ------\r\n1:M 15 Oct 2021 19:55:18.344 # \r\nRAX:0000000000000001 RBX:000000400be35d00\r\nRCX:00000000000f4240 RDX:000000400bbbc8b0\r\nRDI:000000400bac4608 RSI:0000000000000003\r\nRBP:000000400bac4580 RSP:0000004001c17408\r\nR8 :000000400295dc30 R9 :00000040022c85f0\r\nR10:000000400234fd30 R11:00000040023174a0\r\nR12:000000400bac4608 R13:0000004001c1b470\r\nR14:000000400bac4580 R15:0000004004237108\r\nRIP:00000040040220f1 EFL:0000000000000202\r\nCSGSFS:002b000000000033\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c17417) -> 0000000000000000\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c17416) -> 0000000000000000\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c17415) -> 0000000000000000\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c17414) -> 0000000000000000\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c17413) -> 0000000000000000\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c17412) -> 0000000100000000\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c17411) -> 000000400bac4580\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c17410) -> 0000000000000000\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c1740f) -> 0000004001c2d6d0\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c1740e) -> 0000000000000000\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c1740d) -> 0000004001c19470\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c1740c) -> 000000400be35d00\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c1740b) -> 000000400be35300\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c1740a) -> 0000000000000020\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c17409) -> 0000000000000000\r\n1:M 15 Oct 2021 19:55:18.344 # (0000004001c17408) -> 000000400403461d\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:6.2.3\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:33cdf76a1080ed11\r\nredis_mode:standalone\r\nos:Linux 5.10.47-linuxkit x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:8.3.0\r\nprocess_id:1\r\nprocess_supervised:no\r\nrun_id:356d958df5ab8dd186d5d5941ebd8b8d8c51e82b\r\ntcp_port:6379\r\nserver_time_usec:1634327718338771\r\nuptime_in_seconds:17\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:6937766\r\nexecutable:/usr/local/bin/redis-server\r\nconfig_file:\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:1\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:8\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:5509304\r\nused_memory_human:5.25M\r\nused_memory_rss:0\r\nused_memory_rss_human:0B\r\nused_memory_peak:5589208\r\nused_memory_peak_human:5.33M\r\nused_memory_peak_perc:98.57%\r\nused_memory_overhead:5317928\r\nused_memory_startup:5317816\r\nused_memory_dataset:191376\r\nused_memory_dataset_perc:99.94%\r\nallocator_allocated:5823000\r\nallocator_active:6262784\r\nallocator_resident:9768960\r\ntotal_system_memory:2085416960\r\ntotal_system_memory_human:1.94G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.08\r\nallocator_frag_bytes:439784\r\nallocator_rss_ratio:1.56\r\nallocator_rss_bytes:3506176\r\nrss_overhead_ratio:0.00\r\nrss_overhead_bytes:-9768960\r\nmem_fragmentation_ratio:0.00\r\nmem_fragmentation_bytes:-5444608\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.1.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:5\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1634327701\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:3\r\ntotal_commands_processed:11\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:661\r\ntotal_net_output_bytes:1298\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nkeyspace_hits:4\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:1\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:9\r\ntotal_writes_processed:6\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:d1b4b16a906e9e313a22bc96d0a82726cb0d408e\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.089429\r\nused_cpu_user:0.417337\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:0.080766\r\nused_cpu_user_main_thread:0.404841\r\n\r\n# Modules\r\nmodule:name=search,ver=20012,api=1,filters=0,usedby=[],using=[],options=[]\r\nmodule:name=rg,ver=10007,api=1,filters=0,usedby=[],using=[ai],options=[]\r\nmodule:name=graph,ver=20411,api=1,filters=0,usedby=[],using=[],options=[]\r\nmodule:name=timeseries,ver=10410,api=1,filters=0,usedby=[],using=[],options=[]\r\nmodule:name=ReJSON,ver=10008,api=1,filters=0,usedby=[],using=[],options=[]\r\nmodule:name=ai,ver=10003,api=1,filters=0,usedby=[rg],using=[],options=[]\r\nmodule:name=bf,ver=20206,api=1,filters=0,usedby=[],using=[],options=[]\r\n\r\n# Commandstats\r\ncmdstat_hset:calls=2,usec=6047,usec_per_call=3023.50,rejected_calls=0,failed_calls=0\r\ncmdstat_FT.CREATE:calls=1,usec=3164,usec_per_call=3164.00,rejected_calls=0,failed_calls=0\r\ncmdstat_config:calls=1,usec=482,usec_per_call=482.00,rejected_calls=0,failed_calls=0\r\ncmdstat_FT.SEARCH:calls=1,usec=4265,usec_per_call=4265.00,rejected_calls=0,failed_calls=0\r\ncmdstat_FT.INFO:calls=2,usec=2834,usec_per_call=1417.00,rejected_calls=0,failed_calls=1\r\ncmdstat_info:calls=4,usec=2038,usec_per_call=509.50,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\nerrorstat_Unknown:count=1\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=2,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=17 addr=192.168.16.1:60870 laddr=192.168.16.2:6379 fd=13 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=108 qbuf-free=40846 argv-mem=66 obl=4 oll=0 omem=0 tot-mem=61554 events=r cmd=hset user=default redir=-1\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=17 addr=192.168.16.1:60870 laddr=192.168.16.2:6379 fd=13 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=108 qbuf-free=40846 argv-mem=66 obl=4 oll=0 omem=0 tot-mem=61554 events=r cmd=hset user=default redir=-1\r\nargv[0]: 'HSET'\r\nargv[1]: 'org:1'\r\nargv[2]: 'name'\r\nargv[3]: 'Dropcontact SAS'\r\nargv[4]: 'keys'\r\nargv[5]: 'dropcontact.io www.dropcontact.com'\r\n1:M 15 Oct 2021 19:55:18.347 # key 'org:1' found in DB containing the following object:\r\n1:M 15 Oct 2021 19:55:18.347 # Object type: 4\r\n1:M 15 Oct 2021 19:55:18.347 # Object encoding: 5\r\n1:M 15 Oct 2021 19:55:18.347 # Object refcount: 1\r\n\r\n------ MODULES INFO OUTPUT ------\r\n# rg\r\nrg_nexecutions:0\r\nrg_nregistrations:0\r\n\r\n# rg_regisrations\r\n\r\n# rg_python_stats\r\nrg_TotalAllocated:10561476\r\nrg_PeakAllocated:4043256\r\nrg_CurrAllocated:3733377\r\n\r\n# rg_python_requirements\r\n\r\n# graph_executing commands\r\n\r\n# ai_git\r\nai_git_sha:7f808a934dff121e188cb76fdfcc3eb1f9ec7cbf\r\n\r\n# ai_load_time_configs\r\nai_threads_per_queue:1\r\nai_inter_op_parallelism:0\r\nai_intra_op_parallelism:0\r\n\r\n------ FAST MEMORY TEST ------\r\n1:M 15 Oct 2021 19:55:18.352 # Bio thread for job type #0 terminated\r\n1:M 15 Oct 2021 19:55:18.352 # Bio thread for job type #1 terminated\r\n1:M 15 Oct 2021 19:55:18.352 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 4000201000 (2682880 bytes)\r\n*** Preparing to test memory region 4001c57000 (12288 bytes)\r\n*** Preparing to test memory region 4001de0000 (8192 bytes)\r\n*** Preparing to test memory region 4002168000 (16384 bytes)\r\n*** Preparing to test memory region 4002189000 (16384 bytes)\r\n*** Preparing to test memory region 400234a000 (40960 bytes)\r\n*** Preparing to test memory region 4002600000 (2097152 bytes)\r\n*** Preparing to test memory region 4002954000 (2097152 bytes)\r\n*** Preparing to test memory region 4003000000 (4194304 bytes)\r\n*** Preparing to test memory region 400377e000 (4096 bytes)\r\n*** Preparing to test memory region 4003780000 (8388608 bytes)\r\n*** Preparing to test memory region 4004235000 (12288 bytes)\r\n*** Preparing to test memory region 4004239000 (8388608 bytes)\r\n*** Preparing to test memory region 40052b6000 (12288 bytes)\r\n*** Preparing to test memory region 40052ee000 (8388608 bytes)\r\n*** Preparing to test memory region 4005aef000 (8388608 bytes)\r\n*** Preparing to test memory region 40062f0000 (8388608 bytes)\r\n*** Preparing to test memory region 4006af1000 (8388608 bytes)\r\n*** Preparing to test memory region 40072f2000 (8388608 bytes)\r\n*** Preparing to test memory region 4007af3000 (8388608 bytes)\r\n*** Preparing to test memory region 40082f4000 (8388608 bytes)\r\n*** Preparing to test memory region 4009175000 (143360 bytes)\r\n*** Preparing to test memory region 40091aa000 (8388608 bytes)\r\n*** Preparing to test memory region 40099ab000 (8388608 bytes)\r\n*** Preparing to test memory region 400a1ac000 (8388608 bytes)\r\n*** Preparing to test memory region 400a9ad000 (8388608 bytes)\r\n*** Preparing to test memory region 400b1ae000 (8388608 bytes)\r\n*** Preparing to test memory region 400b9ae000 (5767168 bytes)\r\n*** Preparing to test memory region 400bf45000 (4096 bytes)\r\n*** Preparing to test memory region 400bf63000 (8388608 bytes)\r\n*** Preparing to test memory region 400c764000 (8388608 bytes)\r\n*** Preparing to test memory region 400cf65000 (8388608 bytes)\r\n*** Preparing to test memory region 400d766000 (8388608 bytes)\r\n*** Preparing to test memory region 400df67000 (8388608 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: DocTable_Get (base: 0x40040220b0)\r\nModule: /usr/lib/redis/modules/redisearch.so (base 0x4003f80000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x40040220b0 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n1:M 15 Oct 2021 19:55:19.226 # dump of function (hexdump of 193 bytes):\r\n31c04885f67429483b77107723488b4f0889f24839ce733889d2483b5718734848c1e20448035730488b024885c07511c30f1f8000000000488b40084885c0741f483b70c875f14883e838c30f1f40004889f031d248f7f1ebbe660f1f440000c30f1f800000000031c0c30f1f44000031c04885f6745348397710724d488b4f0889f24839ce72084889f031d248f7f189d231c0483b5718733048c1e204480357307426488b124885d2750deb1c6690488b52084885d27417483972c875f1f642\r\n```\r\n\r\n**Additional information**\r\n\r\n1. Mac OS / ARM Chip - with redislabs/redismod docker \r\n2. Add some data, create a simple index. \r\n3. Query once: it's ok - Query twice: it crashes\r\n",
  "state": "closed",
  "created_at": "2021-10-15T20:02:00Z",
  "updated_at": "2021-10-17T10:50:39Z",
  "closed_at": "2021-10-16T15:13:55Z",
  "labels": [],
  "comments_data": [
    {
      "id": 944629068,
      "user": "itamarhaber",
      "created_at": "2021-10-15T20:07:02Z",
      "body": "Hi @patoch\r\n\r\nAs this is a RediSearch issue, kindly close it and resubmit against https://github.com/redisearch/redisearch"
    },
    {
      "id": 944930568,
      "user": "oranagra",
      "created_at": "2021-10-16T15:13:55Z",
      "body": "Wow, 7 different modules. \r\nredis search is the one that crashed, but maybe it's due to that mix. When submitting a bug report in https://github.com/RediSearch/RediSearch pease be sure to turn their attention to your configuration. "
    },
    {
      "id": 945090933,
      "user": "patoch",
      "created_at": "2021-10-17T10:50:39Z",
      "body": "I will post it to the RediSearch forum and will turn off unused modules.\r\nMany thanks,\r\n"
    }
  ]
}