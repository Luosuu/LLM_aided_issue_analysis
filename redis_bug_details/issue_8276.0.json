{
  "issue_number": 8276.0,
  "title": "[CRASH]Redis 4.0.14 crashed by signal: 11",
  "body": "```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n61053:C 31 Dec 02:07:03.746 # Redis 4.0.14 crashed by signal: 11\r\n61053:C 31 Dec 02:07:03.746 # Crashed running the instruction at: 0x43308f\r\n61053:C 31 Dec 02:07:03.746 # Accessing address: (nil)\r\n61053:C 31 Dec 02:07:03.746 # Failed assertion: <no assertion failed> (<no file>:0)\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](lzf_compress+0x3f)[0x43308f]\r\n\r\nBacktrace:\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](logStackTrace+0x29)[0x468ad9]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](sigsegvHandler+0xac)[0x46917c]\r\n/lib64/libpthread.so.0(+0xf5f0)[0x7f1e09abb5f0]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](lzf_compress+0x3f)[0x43308f]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](rdbSaveLzfStringObject+0x4b)[0x447b8b]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](rdbSaveRawString+0x17e)[0x447f3e]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](rdbSaveObject+0x30f)[0x448eff]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](rdbSaveKeyValuePair+0x94)[0x4492c4]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](rdbSaveRio+0x286)[0x4497d6]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](rdbSave+0x78)[0x449c68]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](rdbSaveBackground+0x7c)[0x449e8c]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](serverCron+0x6f0)[0x42d4a0]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](aeProcessEvents+0x32f)[0x4268cf]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](aeMain+0x2b)[0x426b0b]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster](main+0x49f)[0x42390f]\r\n/lib64/libc.so.6(__libc_start_main+0xf5)[0x7f1e09700505]\r\nredis-rdb-bgsave 10.253.74.173:6381 [cluster][0x423c02]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:4.0.14\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:94c7b25a309bc889\r\nredis_mode:cluster\r\nos:Linux 4.7.1-1.el7.elrepo.x86_64 x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:atomic-builtin\r\ngcc_version:4.8.5\r\nprocess_id:61053\r\nrun_id:7606b913365382894ec13e04a906ae0547947ebe\r\ntcp_port:6381\r\nuptime_in_seconds:535755\r\nuptime_in_days:6\r\nhz:10\r\nlru_clock:15515356\r\nexecutable:/app/upay/apps/redis_6381/./src/redis-server\r\nconfig_file:/app/upay/apps/redis_6381/./conf/redis.conf\r\n\r\n# Clients\r\nconnected_clients:12\r\nclient_longest_output_list:0\r\nclient_biggest_input_buf:7\r\nblocked_clients:0\r\n\r\n# Memory\r\nused_memory:41448619976\r\nused_memory_human:38.60G\r\nused_memory_rss:44859101184\r\nused_memory_rss_human:41.78G\r\nused_memory_peak:42884184360\r\nused_memory_peak_human:39.94G\r\nused_memory_peak_perc:96.65%\r\nused_memory_overhead:9030279725\r\nused_memory_startup:1517680\r\nused_memory_dataset:32418340251\r\nused_memory_dataset_perc:78.22%\r\ntotal_system_memory:540893372416\r\ntotal_system_memory_human:503.75G\r\nused_memory_lua:43008\r\nused_memory_lua_human:42.00K\r\nmaxmemory:53687091200\r\nmaxmemory_human:50.00G\r\nmaxmemory_policy:volatile-ttl\r\nmem_fragmentation_ratio:1.08\r\nmem_allocator:jemalloc-4.0.3\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nrdb_changes_since_last_save:160210465\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1608819958\r\nrdb_last_bgsave_status:err\r\nrdb_last_bgsave_time_sec:958\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:2462715904\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:64140\r\ntotal_commands_processed:159482324\r\ninstantaneous_ops_per_sec:4639\r\ntotal_net_input_bytes:25540664169\r\ntotal_net_output_bytes:29925586\r\ninstantaneous_input_kbps:321.51\r\ninstantaneous_output_kbps:0.03\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nevicted_keys:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:2164504\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\n\r\n# Replication\r\nrole:slave\r\nmaster_host:10.253.74.174\r\nmaster_port:6383\r\nmaster_link_status:up\r\nmaster_last_io_seconds_ago:4\r\nmaster_sync_in_progress:0\r\nslave_repl_offset:208639444100\r\nslave_priority:100\r\nslave_read_only:1\r\nconnected_slaves:0\r\nmaster_replid:8c7fbf103cb8d00a2e549473267293f77b716cd3\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:208639444100\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:1\r\nrepl_backlog_size:536870912\r\nrepl_backlog_first_byte_offset:208102573189\r\nrepl_backlog_histlen:536870912\r\n\r\n# CPU\r\nused_cpu_sys:138.57\r\nused_cpu_user:606.79\r\nused_cpu_sys_children:0.00\r\nused_cpu_user_children:0.00\r\n\r\n# Commandstats\r\ncmdstat_set:calls=6,usec=97,usec_per_call=16.17\r\ncmdstat_time:calls=32,usec=164,usec_per_call=5.12\r\ncmdstat_pexpire:calls=17854780,usec=111097501,usec_per_call=6.22\r\ncmdstat_exec:calls=70,usec=1703,usec_per_call=24.33\r\ncmdstat_lpush:calls=18583640,usec=312910476,usec_per_call=16.84\r\ncmdstat_del:calls=14137914,usec=547544060,usec_per_call=38.73\r\ncmdstat_incrby:calls=25826698,usec=39064248,usec_per_call=1.51\r\ncmdstat_sadd:calls=24,usec=338,usec_per_call=14.08\r\ncmdstat_info:calls=13,usec=1813,usec_per_call=139.46\r\ncmdstat_hset:calls=6,usec=63,usec_per_call=10.50\r\ncmdstat_setnx:calls=12618273,usec=477222386,usec_per_call=37.82\r\ncmdstat_multi:calls=35,usec=8,usec_per_call=0.23\r\ncmdstat_select:calls=1,usec=2,usec_per_call=2.00\r\ncmdstat_cluster:calls=1866,usec=1455788,usec_per_call=780.17\r\ncmdstat_ping:calls=174689,usec=684171,usec_per_call=3.92\r\ncmdstat_sdiffstore:calls=1,usec=140,usec_per_call=140.00\r\ncmdstat_lrem:calls=70284247,usec=990254843,usec_per_call=14.09\r\ncmdstat_command:calls=5,usec=9981,usec_per_call=1996.20\r\ncmdstat_srem:calls=24,usec=67,usec_per_call=2.79\r\n\r\n# Cluster\r\ncluster_enabled:1\r\n\r\n# Keyspace\r\ndb0:keys=133461287,expires=30721589,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=6 addr=10.253.74.174:6383 fd=53 name= age=532233 idle=4 flags=M db=0 sub=0 psub=0 multi=-1 qbuf=7 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=lrem\r\nid=64138 addr=?:0 fd=56 name= age=26 idle=26 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=NULL\r\nid=64141 addr=?:0 fd=60 name= age=20 idle=20 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=NULL\r\nid=64142 addr=?:0 fd=58 name= age=12 idle=12 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=NULL\r\nid=64143 addr=?:0 fd=61 name= age=12 idle=12 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=NULL\r\nid=64135 addr=?:0 fd=41 name= age=70 idle=10 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=ping\r\nid=64140 addr=?:0 fd=59 name= age=24 idle=24 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=NULL\r\nid=64144 addr=?:0 fd=55 name= age=9 idle=9 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=NULL\r\nid=64139 addr=?:0 fd=35 name= age=24 idle=24 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=NULL\r\nid=64136 addr=?:0 fd=42 name= age=52 idle=22 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=ping\r\nid=64133 addr=?:0 fd=54 name= age=89 idle=29 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=ping\r\nid=64137 addr=?:0 fd=57 name= age=40 idle=9 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=0 obl=0 oll=0 omem=0 events=r cmd=ping\r\n\r\n------ REGISTERS ------\r\n61053:C 31 Dec 02:07:03.748 # \r\nRAX:00007f1372c00000 RBX:8000007f341d64d6\r\nRCX:000000001a064e3e RDX:00007f1372c00000\r\nRDI:8000007f1a171696 RSI:00007f1372c00001\r\nRBP:00007f138cc64e3e RSP:00007ffd90dd32a8\r\nR8 :0000000000000000 R9 :0000000000000000\r\nR10:0000000000000003 R11:0000000000000002\r\nR12:8000007f341d64d8 R13:0000000000000108\r\nR14:000000001a064e3e R15:0000000000000001\r\nRIP:000000000043308f EFL:0000000000010202\r\nCSGSFS:002b000000000033\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32b7) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32b6) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32b5) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32b4) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32b3) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32b2) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32b1) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32b0) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32af) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32ae) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32ad) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32ac) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32ab) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32aa) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32a9) -> 0000000000000000\r\n61053:C 31 Dec 02:07:03.748 # (00007ffd90dd32a8) -> 0000000000000000\r\n\r\n------ FAST MEMORY TEST ------\r\n*** Preparing to test memory region 745000 (98304 bytes)\r\n*** Preparing to test memory region 244f000 (135168 bytes)\r\n*** Preparing to test memory region 7f1372c00000 (469762048 bytes)\r\n*** Preparing to test memory region 7f138ec00000 (44862275584 bytes)\r\n*** Preparing to test memory region 7f1e00dfe000 (8388608 bytes)\r\n*** Preparing to test memory region 7f1e015ff000 (8388608 bytes)\r\n*** Preparing to test memory region 7f1e01e00000 (14680064 bytes)\r\n*** Preparing to test memory region 7f1e02c00000 (2097152 bytes)\r\n*** Preparing to test memory region 7f1e09400000 (2097152 bytes)\r\n*** Preparing to test memory region 7f1e09aa7000 (20480 bytes)\r\n*** Preparing to test memory region 7f1e09cc4000 (16384 bytes)\r\n*** Preparing to test memory region 7f1e0a3e4000 (16384 bytes)\r\n*** Preparing to test memory region 7f1e0a3ec000 (8192 bytes)\r\n*** Preparing to test memory region 7f1e0a3ee000 (4096 bytes)\r\n*** Preparing to test memory region 7f1e0a3f1000 (4096 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: lzf_compress (base: 0x433050)\r\nModule: redis-rdb-bgsave 10.253.74.173:6381 [cluster] (base 0x400000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x433050 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n61053:C 31 Dec 02:10:59.846 # dump of function (hexdump of 191 bytes):\r\n85f60f84c801000085c90f84c0010000415789c989f64531c94156415541bd0801000041544c8d2437488d720155488d2c0a53498d5c24fe4881ec90ff03000fb6070fb64f01c1e00809c84889f9eb2a4839ee0f83b40200004c8d41010fb6094183c1014183f9204c8d5601880e0f84a80200004c89d64c89c14839d90f835d010000440fb65902c1e0084989ce4189c04929fe410fb6c34409c0448d14804189c041c1e8084529d0450fb7c04e8d448488458b104589304989ce4901fa4d\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n       Please report the crash by opening an issue on github:\r\n\r\n           http://github.com/antirez/redis/issues\r\n\r\n  Suspect RAM error? Use redis-server --test-memory to verify it.\r\n```",
  "state": "open",
  "created_at": "2020-12-31T10:01:46Z",
  "updated_at": "2021-04-01T09:16:07Z",
  "closed_at": null,
  "labels": [],
  "comments_data": [
    {
      "id": 753508651,
      "user": "oranagra",
      "created_at": "2021-01-02T17:57:26Z",
      "body": "@EternalSpring can you please upload the executable that produced this crash, maybe i'll be able to tell which type of value was it that caused that crash."
    },
    {
      "id": 811591038,
      "user": "EternalSpring",
      "created_at": "2021-04-01T02:26:28Z",
      "body": "[redis-server.zip](https://github.com/redis/redis/files/6240537/redis-server.zip)\r\n  @oranagra The executable file has been uploaded,thanks for help"
    },
    {
      "id": 811673039,
      "user": "oranagra",
      "created_at": "2021-04-01T06:17:23Z",
      "body": "luckily we do have debug information and line numbers.\r\nstack trace points to a list object, and it looks like the `node->zl` member is NULL.\r\n\r\n```\r\n0x43308f is in lzf_compress (lzf_c.c:139).\r\n0x447b8b is in rdbSaveLzfStringObject (rdb.c:319).\r\n0x447f3e is in rdbSaveRawString (rdb.c:392).\r\n0x448eff is in rdbSaveObject (rdb.c:666).\r\n0x4492c4 is in rdbSaveKeyValuePair (rdb.c:821).\r\n0x4497d6 is in rdbSaveRio (rdb.c:930).\r\n0x449c68 is in rdbSave (rdb.c:1024).\r\n0x449e8c is in rdbSaveBackground (rdb.c:1080).\r\n0x42d4a0 is in serverCron (server.c:1100).\r\n0x4268cf is in aeProcessEvents (ae.c:333).\r\n0x426b0b is in aeMain (ae.c:498).\r\n```\r\n\r\ni suppose such a thing could have happened when deleting elements from the list and forgetting to delete the quicklist node when it got empty, but i'm not currently aware of any such bug that was recently fixed or reported.\r\nsince this version is quite old, i can only guess that maybe it was fixed since then (in more recent versions), but i'm not certain."
    },
    {
      "id": 811702193,
      "user": "EternalSpring",
      "created_at": "2021-04-01T07:18:21Z",
      "body": "@oranagra Thanks for the answer, Is it possible that it is caused by a certain configuration ? Can this problem be avoided by adjusting the parameters ?\r\n(FYI : Linux version 4.7.1-1.el7.elrepo.x86_64 (mockbuild@Build64R7) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC) ) #1 SMP Wed Aug 17 12:55:37 EDT 2016)"
    },
    {
      "id": 811774030,
      "user": "oranagra",
      "created_at": "2021-04-01T09:16:07Z",
      "body": "@EternalSpring no, i don't think it could be configuration or OS.\r\nit's either a bug in redis, a module (if you used any), or a memory corruption."
    }
  ]
}