{
  "issue_number": 9460.0,
  "title": "[CRASH] redisgraph crashed",
  "body": "**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n22696:M 03 Sep 2021 14:28:42.461 # Redis 6.2.5 crashed by signal: 11, si_code: 1\r\n22696:M 03 Sep 2021 14:28:42.461 # Accessing address: 0x19\r\n22696:M 03 Sep 2021 14:28:42.461 # Crashed running the instruction at: 0x7f357a41e50c\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n/root/redis/redisgraph.so(AR_EXP_FromASTNode+0x2c)[0x7f357a41e50c]\r\n\r\nBacktrace:\r\n/lib64/libpthread.so.0(+0xf630)[0x7f3581bf3630]\r\n/root/redis/redisgraph.so(AR_EXP_FromASTNode+0x2c)[0x7f357a41e50c]\r\n/root/redis/redisgraph.so(+0x163e3b)[0x7f357a41ee3b]\r\n/root/redis/redisgraph.so(AR_EXP_FromASTNode+0x7)[0x7f357a41e4e7]\r\n/root/redis/redisgraph.so(parse_params+0x14d)[0x7f357a45a63d]\r\n/root/redis/redisgraph.so(ExecutionCtx_FromQuery+0x15)[0x7f357a42c1c5]\r\n/root/redis/redisgraph.so(Graph_Query+0x3e)[0x7f357a42bfbe]\r\n/root/redis/redisgraph.so(+0x1acacf)[0x7f357a467acf]\r\n/lib64/libpthread.so.0(+0x7ea5)[0x7f3581bebea5]\r\n/lib64/libc.so.6(clone+0x6d)[0x7f35819149fd]\r\n\r\n------ REGISTERS ------\r\n22696:M 03 Sep 2021 14:28:42.463 # \r\nRAX:0000000000000000 RBX:0000000000000000\r\nRCX:00007f3581dfb300 RDX:0000000000008000\r\nRDI:0000000000000000 RSI:0000000000008000\r\nRBP:0000000000000003 RSP:00007f3579090410\r\nR8 :00007f357909027c R9 :0000000000000000\r\nR10:0000000000000003 R11:000000000001ffff\r\nR12:00007f3565a080c0 R13:00007f3558009180\r\nR14:00007f3565a15000 R15:0000000000000000\r\nRIP:00007f357a41e50c EFL:0000000000010246\r\nCSGSFS:0000000000000033\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f357909041f) -> 00007f3558000ee8\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f357909041e) -> 00007f3558000dc0\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f357909041d) -> 00007f3558000bb0\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f357909041c) -> 0000000000000001\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f357909041b) -> 00007f3558000d50\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f357909041a) -> 00007f357aabd660\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f3579090419) -> 0000000000000000\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f3579090418) -> 0000000000000000\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f3579090417) -> 00007f358189b78c\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f3579090416) -> 0000000000000000\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f3579090415) -> 0000000000000001\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f3579090414) -> 00007f3581436140\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f3579090413) -> 00007f35580095d0\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f3579090412) -> 0000000000000008\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f3579090411) -> 00007f357a41ee3b\r\n22696:M 03 Sep 2021 14:28:42.463 # (00007f3579090410) -> 00007f3565a08090\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:6.2.5\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:8c2255e45a519e6a\r\nredis_mode:standalone\r\nos:Linux 3.10.0-1160.36.2.el7.x86_64 x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:atomic-builtin\r\ngcc_version:4.8.5\r\nprocess_id:22696\r\nprocess_supervised:no\r\nrun_id:9481a3e7dafe097b2e27c443a4131c78785c8143\r\ntcp_port:6379\r\nserver_time_usec:1630668522461176\r\nuptime_in_seconds:15\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:3278570\r\nexecutable:/root/redis/redis-6.2.5/src/redis-server\r\nconfig_file:/root/redis/redis-6.2.5/redis.conf\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:1\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:16\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:1\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:2106688\r\nused_memory_human:2.01M\r\nused_memory_rss:15122432\r\nused_memory_rss_human:14.42M\r\nused_memory_peak:2106688\r\nused_memory_peak_human:2.01M\r\nused_memory_peak_perc:101.14%\r\nused_memory_overhead:863568\r\nused_memory_startup:843000\r\nused_memory_dataset:1243120\r\nused_memory_dataset_perc:98.37%\r\nallocator_allocated:1113568\r\nallocator_active:1433600\r\nallocator_resident:6324224\r\ntotal_system_memory:404089925632\r\ntotal_system_memory_human:376.34G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.29\r\nallocator_frag_bytes:320032\r\nallocator_rss_ratio:4.41\r\nallocator_rss_bytes:4890624\r\nrss_overhead_ratio:2.39\r\nrss_overhead_bytes:8798208\r\nmem_fragmentation_ratio:17.50\r\nmem_fragmentation_bytes:14258472\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:20496\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.1.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1630668507\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:1\r\ntotal_commands_processed:2\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:578\r\ntotal_net_output_bytes:20880\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nkeyspace_hits:0\r\nkeyspace_misses:1\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:2\r\ntotal_writes_processed:1\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:34638af7d76761cb31f9d5e6b39df24dcee44941\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.006197\r\nused_cpu_user:0.010328\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:0.000000\r\nused_cpu_user_main_thread:0.001912\r\n\r\n# Modules\r\nmodule:name=graph,ver=20407,api=1,filters=0,usedby=[],using=[],options=[]\r\n\r\n# Commandstats\r\ncmdstat_command:calls=1,usec=394,usec_per_call=394.00,rejected_calls=0,failed_calls=0\r\ncmdstat_graph.QUERY:calls=1,usec=94,usec_per_call=94.00,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=1,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=5 addr=172.18.85.28:48056 laddr=172.18.85.28:6379 fd=9 name= age=3 idle=0 flags=b db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=40954 argv-mem=536 obl=0 oll=0 omem=0 tot-mem=62000 events=r cmd=graph.QUERY user=default redir=-1\r\n\r\n------ MODULES INFO OUTPUT ------\r\n# graph_executing commands\r\ngraph_command:GRAPH.QUERY CYPHER contacts=[RosterUser(msisdn=901, domain=d1, nick=n1,isBip=false), RosterUser(msisdn=902, domain=d2, nick=n2, isBip=true), RosterUser(msisdn=903,  domain=d3, nick=n3, isBip=false), RosterUser(msisdn=904, domain=d4, nick=n4, isBip=true)] UNWIND $contacts AS 'c' MERGE ('u':user{msisdn:'906333101331'})  ON CREATE SET 'u'.domain = 'alcar.ihgzt.com.tr', 'u'.isBip = true  ON MATCH SET 'u'.domain = 'alcar.ihgzt.com.tr', 'u'.isBip = true  MERGE (:user{msisdn:c.msisdn}) MERGE ('u')-[r:knows{nick:'c'.nick}]->('c')\r\n\r\n------ FAST MEMORY TEST ------\r\n22696:M 03 Sep 2021 14:28:42.463 # main thread terminated\r\n22696:M 03 Sep 2021 14:28:42.463 # Bio thread for job type #0 terminated\r\n22696:M 03 Sep 2021 14:28:42.463 # Bio thread for job type #1 terminated\r\n22696:M 03 Sep 2021 14:28:42.463 # Bio thread for job type #2 terminated\r\n\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: AR_EXP_FromASTNode (base: 0x7f357a41e4e0)\r\nModule: /root/redis/redisgraph.so (base 0x7f357a2bb000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x7f357a41e4e0 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n22696:M 03 Sep 2021 14:28:42.463 # dump of function (hexdump of 172 bytes):\r\n4154e88900000031d231f64989c44889c7e8aa1f000041837c242001740a4c89e0415cc30f1f4000498b0424440fb64019418b44241085c07ee4498b4c241883e8014489c6488b394c8d4cc108e82effffff84c075184883c1084939c974bf488b394489c6e816ffffff84c074e831c0488d3d51164400e874bdffff4c89e0415cc366662e0f1f8400000000000f1f004157415641554989fd415455534883ec48e85a5d3f0089c3488b0561\r\nFunction at 0x7f357a4204a0 is AR_EXP_ReduceToScalar\r\nFunction at 0x7f357a41a2d0 is ErrorCtx_SetError\r\nFunction at 0x7f357a8142e0 is cypher_astnode_type\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version\r\nRed Hat Enterprise Linux Server release 7.9 (Maipo)\r\n2. Steps to reproduce (if any)\r\nwhile executing the following command redis graph is crashed\r\nalso redis started with \r\n/root/redis/redis-6.2.5/src/redis-server /root/redis/redis-6.2.5/redis.conf --loadmodule /root/redis/redisgraph.so \r\n\r\n\r\nGRAPH.QUERY \"roster\" \"CYPHER contacts=[RosterUser(msisdn=901, domain=d1, nick=n1, isBip=false), RosterUser(msisdn=902, domain=d2, nick=n2, isBip=true), RosterUser(msisdn=903, domain=d3, nick=n3, isBip=false), RosterUser(msisdn=904, domain=d4, nick=n4, isBip=true)] UNWIND $contacts AS c MERGE (u:user{msisdn:'906333101331'})  ON CREATE SET u.domain = 'alcar.ihgzt.com.tr', u.isBip = true  ON MATCH SET u.domain = 'alcar.ihgzt.com.tr', u.isBip = true  MERGE (:user{msisdn:c.msisdn})  MERGE (u)-[r:knows{nick:c.nick}]->(c)\"",
  "state": "closed",
  "created_at": "2021-09-03T11:35:48Z",
  "updated_at": "2021-09-03T11:57:12Z",
  "closed_at": "2021-09-03T11:57:12Z",
  "labels": [],
  "comments_data": [
    {
      "id": 912481063,
      "user": "sundb",
      "created_at": "2021-09-03T11:55:31Z",
      "body": "redisgraph is not maintained by the redis community, you can create pr at https://github.com/RedisGraph/RedisGraph."
    },
    {
      "id": 912482014,
      "user": "oranagra",
      "created_at": "2021-09-03T11:57:12Z",
      "body": "@hector690 Please open in RedisGraph repo (https://github.com/RedisGraph/RedisGraph). \r\n@swilly22 FYI"
    }
  ]
}