{
  "issue_number": 5345.0,
  "title": "[CRASH] LOLWUT with terminal-columns < 2 yields negative canvas width and borks",
  "body": "😆 ❓ \r\n\r\n```\r\n127.0.0.1:6379> LOLWUT 1 1\r\nCould not connect to Redis at 127.0.0.1:6379: Connection refused\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n48692:M 13 Sep 2018 00:34:04.575 # ------------------------------------------------\r\n48692:M 13 Sep 2018 00:34:04.575 # !!! Software Failure. Press left mouse button to continue\r\n48692:M 13 Sep 2018 00:34:04.575 # Guru Meditation: Redis aborting for OUT OF MEMORY #server.c:3878\r\n48692:M 13 Sep 2018 00:34:04.575 # (forcing SIGSEGV in order to print the stack trace)\r\n48692:M 13 Sep 2018 00:34:04.575 # ------------------------------------------------\r\n48692:M 13 Sep 2018 00:34:04.575 # Redis 999.999.999 crashed by signal: 11\r\n48692:M 13 Sep 2018 00:34:04.575 # Crashed running the instruction at: 0x10248f31e\r\n48692:M 13 Sep 2018 00:34:04.575 # Accessing address: 0xffffffffffffffff\r\n48692:M 13 Sep 2018 00:34:04.575 # Failed assertion: <no assertion failed> (<no file>:0)\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n0   redis-server                        0x000000010248f31e _serverPanic + 334\r\n\r\nBacktrace:\r\n0   redis-server                        0x0000000102490dce logStackTrace + 110\r\n1   redis-server                        0x000000010249119d sigsegvHandler + 253\r\n2   libsystem_platform.dylib            0x00007fff5dd1df5a _sigtramp + 26\r\n3   ???                                 0x0000000000000400 0x0 + 1024\r\n4   redis-server                        0x0000000102446307 redisOutOfMemoryHandler + 55\r\n5   redis-server                        0x0000000102449d90 zmalloc + 32\r\n6   redis-server                        0x00000001024d5383 lwDrawSchotter + 115\r\n7   redis-server                        0x00000001024d5938 lolwutCommand + 216\r\n8   redis-server                        0x0000000102443133 call + 211\r\n9   redis-server                        0x0000000102443b04 processCommand + 1556\r\n10  redis-server                        0x000000010245413d processInputBuffer + 477\r\n11  redis-server                        0x000000010243adce aeProcessEvents + 750\r\n12  redis-server                        0x000000010243b0fb aeMain + 43\r\n13  redis-server                        0x0000000102446dd0 main + 1712\r\n14  libdyld.dylib                       0x00007fff5da0f015 start + 1\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:999.999.999\r\nredis_git_sha1:b278d352\r\nredis_git_dirty:0\r\nredis_build_id:baf5b1ceba728c47\r\nredis_mode:standalone\r\nos:Darwin 17.7.0 x86_64\r\narch_bits:64\r\nmultiplexing_api:kqueue\r\natomicvar_api:atomic-builtin\r\ngcc_version:4.2.1\r\nprocess_id:48692\r\nrun_id:f75313f11fe86f4af94acfd10ebbaebfcd231d00\r\ntcp_port:6379\r\nuptime_in_seconds:12\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:10061388\r\nexecutable:<redacted>/redis-server\r\nconfig_file:\r\n\r\n# Clients\r\nconnected_clients:1\r\nclient_recent_max_input_buffer:2\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\n\r\n# Memory\r\nused_memory:1037824\r\nused_memory_human:1013.50K\r\nused_memory_rss:2236416\r\nused_memory_rss_human:2.13M\r\nused_memory_peak:1037824\r\nused_memory_peak_human:1013.50K\r\nused_memory_peak_perc:100.16%\r\nused_memory_overhead:1034726\r\nused_memory_startup:985040\r\nused_memory_dataset:3098\r\nused_memory_dataset_perc:5.87%\r\nallocator_allocated:1002896\r\nallocator_active:2198528\r\nallocator_resident:2198528\r\ntotal_system_memory:17179869184\r\ntotal_system_memory_human:16.00G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:2.19\r\nallocator_frag_bytes:1195632\r\nallocator_rss_ratio:1.00\r\nallocator_rss_bytes:0\r\nrss_overhead_ratio:1.02\r\nrss_overhead_bytes:37888\r\nmem_fragmentation_ratio:2.23\r\nmem_fragmentation_bytes:1233520\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:49686\r\nmem_aof_buffer:0\r\nmem_allocator:libc\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1536788032\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:1\r\ntotal_commands_processed:2\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:58\r\ntotal_net_output_bytes:14\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nevicted_keys:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_replid:96bf0c89e67cb9b9c6d95f9196c7b8053151a3e1\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.016671\r\nused_cpu_user:0.010023\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\n\r\n# Commandstats\r\ncmdstat_ping:calls=2,usec=5,usec_per_call=2.50\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=3 addr=127.0.0.1:52495 fd=8 name= age=4 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=30 qbuf-free=32738 obl=0 oll=0 omem=0 events=r cmd=lolwut\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=3 addr=127.0.0.1:52495 fd=8 name= age=4 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=30 qbuf-free=32738 obl=0 oll=0 omem=0 events=r cmd=lolwut\r\nargv[0]: 'LOLWUT'\r\nargv[1]: '1'\r\nargv[2]: '1'\r\n\r\n------ REGISTERS ------\r\n48692:M 13 Sep 2018 00:34:04.584 #\r\nRAX:dc2b562a32a40064 RBX:0000000102511d4b\r\nRCX:00007fff965233c8 RDX:00001c0000001d03\r\nRDI:0000000000012068 RSI:0000000000001d00\r\nRBP:00007ffeed7c9650 RSP:00007ffeed7c9460\r\nR8 :00007fff96501f78 R9 :0000000000000040\r\nR10:00007fff96501f70 R11:ffffffffffffffff\r\nR12:00007fc225500370 R13:000000000000000c\r\nR14:0000000000000f26 R15:0000000102506127\r\nRIP:000000010248f31e EFL:0000000000010202\r\nCS :000000000000002b FS:0000000000000000  GS:0000000000000000\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c946f) -> 0000000000000000\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c946e) -> 0000000000000000\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c946d) -> 0000000000000000\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c946c) -> 0000000000000000\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c946b) -> ffffffffffffffff\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c946a) -> ffffffffffffffff\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c9469) -> 0000000000000000\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c9468) -> 0000000000000000\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c9467) -> 0000000000000000\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c9466) -> 0000000000000000\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c9465) -> 0000000000000040\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c9464) -> 00007fff96501f78\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c9463) -> 00007fff965233c8\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c9462) -> 3fe0000000000000\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c9461) -> 0000000000000000\r\n48692:M 13 Sep 2018 00:34:04.584 # (00007ffeed7c9460) -> 0000000000000000\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: _serverPanic (base: 0x10248f1d0)\r\nModule: /Users/itamar/src/redis/src/redis-server (base 0x102436000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x10248f1d0 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n48692:M 13 Sep 2018 00:34:04.584 # dump of function (hexdump of 462 bytes):\r\n554889e541574156534881ecd80100004889d34189f64989ff84c074380f298540feffff0f298d50feffff0f299560feffff0f299d70feffff0f29a580feffff0f29ad90feffff0f29b5a0feffff0f29bdb0feffff4c898d38feffff4c898530feffff48898d28feffff488b05d70d0900488b00488945e0488d8510feffff488945d0488d4510488945c8c745c430000000c745c018000000488dbdc0feffff4c8d4dc0be0001000031d2b9000100004989d8e82e380700488d1dd992090083bb1c0c000000751b488d35662b0800bf03040000e8c7f5faffc7831c0c000001000000488d1d912a0800bf0300000031c04889dee8b7f7faff488d35ac2a0800bf0300000031c0e8a4f7faff488d35d32a0800488d95c0feffffbf0300000031c04c89f94589f0e884f7faff488d35ce2a0800bf0300000031c0e871f7faffbf0300000031c04889dee862f7faffc60425ffffffff78488b05eb0c0900488b00483b45e0750e4881c4d80100005b415e415f5dc3e8493707000f1f8000000000554889e54157415641554154534881ec281000004989fe488b05aa0c0900488b00488945d0458b66404183fc024d8b7e48498b4708488b58087517488d355c7207004889dfe8883a070085c00f84\r\nFunction at 0x102502ab6 is bit_tohex\r\nFunction at 0x10243e870 is serverLogRaw\r\nFunction at 0x10243ea80 is serverLog\r\nFunction at 0x102502a92 is bit_tohex\r\nFunction at 0x102502e22 is bit_tohex\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n```",
  "state": "closed",
  "created_at": "2018-09-12T21:35:27Z",
  "updated_at": "2018-09-13T10:50:30Z",
  "closed_at": "2018-09-13T06:11:02Z",
  "labels": [],
  "comments_data": [
    {
      "id": 420806931,
      "user": "itamarhaber",
      "created_at": "2018-09-12T21:39:12Z",
      "body": "I believe an easy fix would be:\r\n\r\nlolwut.c:264\r\n```c\r\n    if (cols < 2) cols = 2;\r\n```"
    },
    {
      "id": 420894708,
      "user": "antirez",
      "created_at": "2018-09-13T06:09:59Z",
      "body": "Thanks @itamarhaber, fixed in a slightly different way to make sure you can still have a correct single column output."
    },
    {
      "id": 420966085,
      "user": "itamarhaber",
      "created_at": "2018-09-13T10:50:30Z",
      "body": "Good to know that LOLWUT supports single column operations, thanks! \r\n\r\nIn our use case we plan to start small and use it very judiciously, but if all goes well it will probably need to scale to multiple columns."
    }
  ]
}