{
  "issue_number": 8351.0,
  "title": "[BUG] redis pod does not work on arm64 kube worker node",
  "body": "**Describe the bug**\r\n\r\nGetting fast memory issue.\r\n\r\n**To reproduce**\r\n\r\n`kubectl create -f redis-deployment-definition.yaml`\r\n\r\nWhat special configuration is required to run redis pod on an arm64 worker node.\r\n\r\n\r\nI modified the deployment config as shown below:\r\nbelow is my **redis-deployment-definition.yaml**\r\n```\r\napiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  labels:\r\n    component: redis\r\n  name: redis\r\nspec:\r\n  selector:\r\n    matchLabels:\r\n      component: redis\r\n  replicas: 1\r\n  template:\r\n    metadata:\r\n      labels:\r\n        component: redis\r\n    spec:\r\n      containers:\r\n        - name: redis\r\n          image: redis:rc-buster\r\n          ports:\r\n            - containerPort: 6379\r\n          resources:\r\n            limits:\r\n              memory: 400Mi\r\n              cpu: 1\r\n            requests:\r\n              memory: 200Mi\r\n              cpu: 500m\r\n\r\n      restartPolicy: Always\r\n      nodeSelector:\r\n        boardType: rockpro64-arm64\r\n```\r\n\r\n\r\nA description of what you expected to happen.\r\n\r\n**Additional information**\r\n\r\nAny additional information that is relevant to the problem.\r\n\r\nError I am getting \r\n\r\n```\r\n1:C 17 Jan 2021 20:34:14.005 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\r\n1:C 17 Jan 2021 20:34:14.005 # Redis version=6.1.241, bits=64, commit=00000000, modified=0, pid=1, just started\r\n1:C 17 Jan 2021 20:34:14.005 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf\r\n1:M 17 Jan 2021 20:34:14.010 * monotonic clock: POSIX clock_gettime\r\n1:M 17 Jan 2021 20:34:14.012 * Running mode=standalone, port=6379.\r\n1:M 17 Jan 2021 20:34:14.013 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.\r\n1:M 17 Jan 2021 20:34:14.013 # Server initialized\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n1:M 17 Jan 2021 20:34:14.013 # === ASSERTION FAILED ===\r\n1:M 17 Jan 2021 20:34:14.013 # ==> server.c:5239 '!ret' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\nredis-server *:6379(linuxMadvFreeForkBugCheck+0x2e0)[0x555f99caa0]\r\nredis-server *:6379(main+0x3ac)[0x555f98d924]\r\n/lib/aarch64-linux-gnu/libc.so.6(__libc_start_main+0xe4)[0x7fa836dd24]\r\nredis-server *:6379(+0x42cd0)[0x555f98dcd0]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:6.1.241\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:f73a8ce7d18e1a7e\r\nredis_mode:standalone\r\nos:Linux 4.4.190-1233-rockchip-ayufan-gd3f1be0ed310 aarch64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:8.3.0\r\nprocess_id:1\r\nprocess_supervised:no\r\nrun_id:d7bd1367ce4f031c1084bc823155a1da71674c8a\r\ntcp_port:6379\r\nserver_time_usec:1610915653995871\r\nuptime_in_seconds:-1\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:302917\r\nexecutable:/data/redis-server\r\nconfig_file:\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:0\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:0\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:817576\r\nused_memory_human:798.41K\r\nused_memory_rss:0\r\nused_memory_rss_human:0B\r\nused_memory_peak:817576\r\nused_memory_peak_human:798.41K\r\nused_memory_peak_perc:inf%\r\nused_memory_overhead:0\r\nused_memory_startup:0\r\nused_memory_dataset:817576\r\nused_memory_dataset_perc:100.00%\r\nallocator_allocated:0\r\nallocator_active:0\r\nallocator_resident:0\r\ntotal_system_memory:2085765120\r\ntotal_system_memory_human:1.94G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:nan\r\nallocator_frag_bytes:0\r\nallocator_rss_ratio:nan\r\nallocator_rss_bytes:0\r\nrss_overhead_ratio:nan\r\nrss_overhead_bytes:0\r\nmem_fragmentation_ratio:nan\r\nmem_fragmentation_bytes:0\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.1.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\ncurrent_cow_size:0\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1610915654\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:0\r\ntotal_commands_processed:0\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:0\r\ntotal_net_output_bytes:0\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:0\r\ntotal_writes_processed:0\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_replid:948654150bf6d84c72889c5480580b6e60dfc866\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.044000\r\nused_cpu_user:0.056000\r\nused_cpu_sys_children:0.008000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:0.040000\r\nused_cpu_user_main_thread:0.048000\r\n\r\n# Modules\r\n\r\n# Commandstats\r\n\r\n# Errorstats\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\n\r\n------ CLIENT LIST OUTPUT ------\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ FAST MEMORY TEST ------\r\n*** Preparing to test memory region 555fb3d000 (708608 bytes)\r\n*** Preparing to test memory region 5576a55000 (270336 bytes)\r\n*** Preparing to test memory region 7fa7500000 (13631488 bytes)\r\n*** Preparing to test memory region 7fa84bb000 (16384 bytes)\r\n*** Preparing to test memory region 7fa84ea000 (16384 bytes)\r\n*** Preparing to test memory region 7fa8791000 (16384 bytes)\r\n*** Preparing to test memory region 7fa8873000 (4096 bytes)\r\n*** Preparing to test memory region 7fa8952000 (4096 bytes)\r\n*** Preparing to test memory region 7fa8954000 (32768 bytes)\r\n.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n       Please report the crash by opening an issue on github:\r\n\r\n           http://github.com/redis/redis/issues\r\n\r\n  Suspect RAM error? Use redis-server --test-memory to verify it.\r\n```\r\n\r\n",
  "state": "closed",
  "created_at": "2021-01-17T20:57:52Z",
  "updated_at": "2021-01-28T08:33:46Z",
  "closed_at": "2021-01-28T08:33:46Z",
  "labels": [],
  "comments_data": [
    {
      "id": 761882676,
      "user": "yossigo",
      "created_at": "2021-01-17T21:25:19Z",
      "body": "Because of a serious bug in some versions of the Linux kernel on arm64, Redis attempts to test kernel behavior and produce a warning/refuse to start. In your case it seems like the test itself fails for some reason (perhaps due to container restrictions?).\r\n\r\nTo get some idea of what happens, can you please apply the following patch and see what error is produced in the logs (as a side effect Redis will also start):\r\n\r\n```\r\ndiff --git a/src/server.c b/src/server.c\r\nindex 90b9045ea..13678036c 100644\r\n--- a/src/server.c\r\n+++ b/src/server.c\r\n@@ -5236,7 +5236,10 @@ int linuxMadvFreeForkBugCheck(void) {\r\n #define MADV_FREE 8\r\n #endif\r\n     ret = madvise(q, 4096, MADV_FREE);\r\n-    serverAssert(!ret);\r\n+    if (ret < 0) {\r\n+        serverLog(LL_WARNING, \"madvise failed: errno=%d\", errno);\r\n+        return 0;\r\n+    }\r\n \r\n     /* Write to the page after being marked for freeing, this is supposed to take\r\n      * ownership of that page again. */\r\n```"
    },
    {
      "id": 764542474,
      "user": "yossigo",
      "created_at": "2021-01-21T10:36:44Z",
      "body": "Update: have been trying to reproduce this on an arm64 board (`Linux pine64 5.10.4-sunxi64 #20.11.7 SMP Tue Jan 5 23:28:09 CET 2021 aarch64 aarch64 aarch64 GNU/Linux`) with both docker and microk8s (running the above deployment) without success.\r\n\r\nI assume this might have something to do with the specific kernel in use, but can't tell for sure. Unless we learn something new I think 6.2 should treat such errors as test failure (which can be manually ignored if necessary)."
    },
    {
      "id": 764593744,
      "user": "oranagra",
      "created_at": "2021-01-21T11:56:34Z",
      "body": "@sanfx can you please apply the change Yossi suggested and share the results?"
    }
  ]
}