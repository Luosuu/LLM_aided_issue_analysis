{
  "issue_number": 8531.0,
  "title": "[BUG] Redis fails to compile if HAVE_MALLOC_SIZE is not defined",
  "body": "**Describe the bug**\r\n\r\nCompiling Redis 6.2.0 on a system without `malloc_usable_size()` or similar with `USE_JEMALLOC=No` results in a build failure. The following is seen on OpenBSD -current (amd64 with clang 10.0.1):\r\n\r\n```\r\nzmalloc.c:60:5: error: function-like macro 'sizeof' is not defined\r\n#if PREFIX_SIZE > 0\r\n    ^\r\nzmalloc.c:56:22: note: expanded from macro 'PREFIX_SIZE'\r\n#define PREFIX_SIZE (sizeof(size_t))\r\n                     ^\r\n1 error generated.\r\n```\r\n\r\nhttps://github.com/redis/redis/blob/8e83bcd2acb18370e2d6cea3718339792322e80f/src/zmalloc.c#L60-L64\r\n\r\nThe issue is that at the preprocessing stage keywords like sizeof do not exist (see C11 6.10, footnote 166), so if HAVE_MALLOC_SIZE is not defined, the above conditional won't be accepted by either clang or gcc.\r\n\r\nhttps://github.com/redis/redis/blob/8e83bcd2acb18370e2d6cea3718339792322e80f/src/zmalloc.c#L50-L58\r\n\r\n**To reproduce**\r\n\r\nCompile Redis 6.2.0 on a system without `malloc_usable_size()` or similar with `USE_JEMALLOC=No`.\r\n\r\n**Expected behavior**\r\n\r\nRedis compiles\r\n\r\n**Additional information**\r\n\r\nI think the following diff would make sense, which I can submit as a PR if that's acceptable.\r\nI expect all versions having a version of https://github.com/redis/redis/pull/8522 to be affected.\r\n\r\n```diff\r\n--- src/zmalloc.c.orig\r\n+++ src/zmalloc.c\r\n@@ -28,6 +28,7 @@\r\n  * POSSIBILITY OF SUCH DAMAGE.\r\n  */\r\n\r\n+#include <assert.h>\r\n #include <stdio.h>\r\n #include <stdlib.h>\r\n #include <stdint.h>\r\n@@ -57,7 +58,7 @@ void zlibc_free(void *ptr) {\r\n #endif\r\n #endif\r\n\r\n-#if PREFIX_SIZE > 0\r\n+#ifndef HAVE_MALLOC_SIZE\r\n #define ASSERT_NO_SIZE_OVERFLOW(sz) assert((sz) + PREFIX_SIZE > (sz))\r\n #else\r\n #define ASSERT_NO_SIZE_OVERFLOW(sz)\r\n```\r\n",
  "state": "closed",
  "created_at": "2021-02-23T08:51:20Z",
  "updated_at": "2021-02-23T15:08:50Z",
  "closed_at": "2021-02-23T15:08:50Z",
  "labels": [],
  "comments_data": []
}