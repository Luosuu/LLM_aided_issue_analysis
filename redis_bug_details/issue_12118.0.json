{
  "issue_number": 12118.0,
  "title": "[CRASH] SIGBUS on Android arm 32-bit due to unaligned memory access",
  "body": "Notice!\r\n- If a Redis module was involved, please open an issue in the module's repo instead!\r\n- If you're using docker on Apple M1, please make sure the image you're using was compiled for ARM!\r\n\r\n\r\n**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n6048:M 03 May 2023 02:54:39.433 # Redis 7.0.11 crashed by signal: 7, si_code: 1\r\n6048:M 03 May 2023 02:54:39.433 # Accessing address: 0xed2b90f4\r\n6048:M 03 May 2023 02:54:39.433 # Crashed running the instruction at: 0xb14f4788\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n/data/data/com.termux/files/usr/bin/redis-server(hdr_init_preallocated+0x1f) [0xb14f4788]\r\n\r\nBacktrace:\r\n\r\n------ REGISTERS ------\r\n6048:M 03 May 2023 02:54:39.433 #\r\nR10:000000000000000f R9 :0000000000701368\r\nR8 :00000000b15139b8 R7 :00000000ff953560\r\nR6 :00000000b15139b8 R5 :00000000ff9535a0\r\nR4 :00000000ed055dc4 R3 :00000000ed2b90f4\r\nR2 :00000000ff953590 R1 :00000000ff953570\r\nR0 :00000000ed2b90e4 EC :0000000000000800\r\nfp: 0000000000000000 ip:0000000000000000\r\npc:00000000b14f4788 sp:00000000ff953550\r\ncpsr:00000000a0010030 fault_address:00000000ed2b90f4\r\n\r\n6048:M 03 May 2023 02:54:39.434 # (ff95355f) -> 00000000\r\n6048:M 03 May 2023 02:54:39.434 # (ff95355e) -> 00000002\r\n6048:M 03 May 2023 02:54:39.434 # (ff95355d) -> 00000000\r\n6048:M 03 May 2023 02:54:39.434 # (ff95355c) -> 00000000\r\n6048:M 03 May 2023 02:54:39.434 # (ff95355b) -> 00000000\r\n6048:M 03 May 2023 02:54:39.434 # (ff95355a) -> 3b9aca00\r\n6048:M 03 May 2023 02:54:39.434 # (ff953559) -> 00000000\r\n6048:M 03 May 2023 02:54:39.434 # (ff953558) -> 00000001\r\n6048:M 03 May 2023 02:54:39.434 # (ff953557) -> ff953570\r\n6048:M 03 May 2023 02:54:39.434 # (ff953556) -> 00000002\r\n6048:M 03 May 2023 02:54:39.434 # (ff953555) -> b14f4821\r\n6048:M 03 May 2023 02:54:39.434 # (ff953554) -> ff9535c8\r\n6048:M 03 May 2023 02:54:39.434 # (ff953553) -> b15139b8\r\n6048:M 03 May 2023 02:54:39.434 # (ff953552) -> ed2b90e4\r\n6048:M 03 May 2023 02:54:39.434 # (ff953551) -> ed055dc4\r\n6048:M 03 May 2023 02:54:39.434 # (ff953550) -> 00000000\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:7.0.11\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:bd455d9376abd13e\r\nredis_mode:standalone\r\nos:Linux 4.9.82-perf+ armv8l\r\narch_bits:32\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:4.2.1\r\nprocess_id:6048\r\nprocess_supervised:no\r\nrun_id:c9d0de36f0667818ad49fa96cf2f3d42c43e5819\r\ntcp_port:6379\r\nserver_time_usec:1683050079426274\r\nuptime_in_seconds:4\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:5328479\r\nexecutable:/data/data/com.termux/files/home/redis-server\r\nconfig_file:\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:1\r\ncluster_connections:0\r\nmaxclients:4064\r\nclient_recent_max_input_buffer:0\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:693904\r\nused_memory_human:677.64K\r\nused_memory_rss:2936832\r\nused_memory_rss_human:2.80M\r\nused_memory_peak:693904\r\nused_memory_peak_human:677.64K\r\nused_memory_peak_perc:142.53%\r\nused_memory_overhead:469687\r\nused_memory_startup:469566\r\nused_memory_dataset:224217\r\nused_memory_dataset_perc:99.95%\r\nallocator_allocated:469666\r\nallocator_active:2914304\r\nallocator_resident:2914304\r\ntotal_system_memory:3623464960\r\ntotal_system_memory_human:3.37G\r\nused_memory_lua:22528\r\nused_memory_vm_eval:22528\r\nused_memory_lua_human:22.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:23552\r\nused_memory_vm_total:46080\r\nused_memory_vm_total_human:45.00K\r\nused_memory_functions:121\r\nused_memory_scripts:121\r\nused_memory_scripts_human:121B\r\nmaxmemory:3221225472\r\nmaxmemory_human:3.00G\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:6.21\r\nallocator_frag_bytes:2444638\r\nallocator_rss_ratio:1.00\r\nallocator_rss_bytes:0\r\nrss_overhead_ratio:1.01\r\nrss_overhead_bytes:22528\r\nmem_fragmentation_ratio:6.25\r\nmem_fragmentation_bytes:2467166\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:0\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:libc\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1683050075\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_rewrites_consecutive_failures:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:1\r\ntotal_commands_processed:0\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:27\r\ntotal_net_output_bytes:0\r\ntotal_net_repl_input_bytes:0\r\ntotal_net_repl_output_bytes:0\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\ninstantaneous_input_repl_kbps:0.00\r\ninstantaneous_output_repl_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:2\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\npubsubshard_channels:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:1\r\ntotal_writes_processed:0\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:0\r\nreply_buffer_expands:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:c1ce4ebd91eff65fe8cb75998d5a8a5e71d56295\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.020000\r\nused_cpu_user:0.060000\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:0.020000\r\nused_cpu_user_main_thread:0.060000\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_command|docs:calls=1,usec=7345,usec_per_call=7345.00,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\n\r\n# Latencystats\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=3 addr=127.0.0.1:44438 laddr=127.0.0.1:6379 fd=8 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=27 qbuf-free=16357 argv-mem=11 multi-mem=0 rbs=16384 rbp=16384 obl=16384 oll=10 omem=164040 tot-mem=197361 events=r cmd=command|docs user=default redir=-1 resp=2\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=3 addr=127.0.0.1:44438 laddr=127.0.0.1:6379 fd=8 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=27 qbuf-free=16357 argv-mem=11 multi-mem=0 rbs=16384 rbp=16384 obl=16384 oll=10 omem=164040 tot-mem=197361 events=r cmd=command|docs user=default redir=-1 resp=2\r\nargv[0]: '\"COMMAND\"'\r\nargv[1]: '\"DOCS\"'\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nlazyfree-lazy-eviction no\r\nlazyfree-lazy-server-del no\r\nproto-max-bulk-len 512mb\r\nio-threads 1\r\nactivedefrag no\r\nreplica-read-only yes\r\nio-threads-do-reads no\r\nlazyfree-lazy-expire no\r\nrepl-diskless-sync yes\r\nclient-query-buffer-limit 1gb\r\nlazyfree-lazy-user-del no\r\nlist-compress-depth 0\r\nlazyfree-lazy-user-flush no\r\nrepl-diskless-load disabled\r\nslave-read-only yes\r\nsanitize-dump-payload no\r\n\r\n------ FAST MEMORY TEST ------\r\n6048:M 03 May 2023 02:54:39.437 # Bio thread for job type #0 terminated\r\n6048:M 03 May 2023 02:54:39.438 # Bio thread for job type #1 terminated\r\n6048:M 03 May 2023 02:54:39.438 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region b1537000 (77824 bytes)\r\n*** Preparing to test memory region eb780000 (524288 bytes)\r\n*** Preparing to test memory region ed000000 (1048576 bytes)\r\n*** Preparing to test memory region ed228000 (4096 bytes)\r\n*** Preparing to test memory region ed280000 (1048576 bytes)\r\n*** Preparing to test memory region ed477000 (4096 bytes)\r\n*** Preparing to test memory region ed479000 (24576 bytes)\r\n*** Preparing to test memory region ed56f000 (4096 bytes)\r\n*** Preparing to test memory region ed571000 (4096 bytes)\r\n*** Preparing to test memory region ed597000 (4096 bytes)\r\n*** Preparing to test memory region ed598000 (4096 bytes)\r\n*** Preparing to test memory region ed5b8000 (4096 bytes)\r\n*** Preparing to test memory region ed5ba000 (4096 bytes)\r\n*** Preparing to test memory region ed5db000 (4096 bytes)\r\n*** Preparing to test memory region ed61c000 (4096 bytes)\r\n*** Preparing to test memory region ed61d000 (4096 bytes)\r\n*** Preparing to test memory region ed61e000 (4096 bytes)\r\n*** Preparing to test memory region ed61f000 (4096 bytes)\r\n*** Preparing to test memory region ed620000 (4096 bytes)\r\n*** Preparing to test memory region ed622000 (4096 bytes)\r\n*** Preparing to test memory region ed624000 (4096 bytes)\r\n*** Preparing to test memory region ed626000 (8192 bytes)\r\n*** Preparing to test memory region ed629000 (4096 bytes)\r\n*** Preparing to test memory region ed631000 (12288 bytes)\r\n*** Preparing to test memory region ed6c1000 (4096 bytes)\r\n*** Preparing to test memory region ed6c5000 (294912 bytes)\r\n*** Preparing to test memory region ed70e000 (24576 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: hdr_init_preallocated (base: 0xb14f4769)\r\nModule: /data/data/com.termux/files/usr/bin/redis-server (base 0xb13e2000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0xb14f4769 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n6048:M 03 May 2023 02:54:39.494 # dump of function (hexdump of 159 bytes):\r\nb503af4df804bd0a46034662f9cd0a01f1300543f9cd0a62f9cd0afaff200243f99d0712681a604a6ad1e90a61c2610f4ac0e908610aa138cdc264002261f9cf0a8264c0e91622c0e90a340565303040f9cd0a02605df804bbf0bd00bf00bfffffffffffffff7f00000000000000000000f03ff0b503af4df804bd94b0184c7c4424682468139402ac0194bc680094fff7eefeb8b9109808216cf771fb88b1\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version\r\n\r\nAndroid 8.1 with arm 32-bit userland.\r\n\r\n2. Steps to reproduce (if any)\r\n\r\nOriginally reported in https://github.com/termux/termux-packages/issues/15849. I'm going to submit a PR to fix this.",
  "state": "closed",
  "created_at": "2023-05-02T18:18:55Z",
  "updated_at": "2023-05-02T18:24:51Z",
  "closed_at": "2023-05-02T18:24:51Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1531945474,
      "user": "xtkoba",
      "created_at": "2023-05-02T18:24:51Z",
      "body": "Ah OK, this is already fixed in unstable branch by commit https://github.com/redis/redis/commit/f3f6f7c0d66f136146a912e06c8fbe31ecfbc977."
    }
  ]
}