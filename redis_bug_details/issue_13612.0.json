{
  "issue_number": 13612.0,
  "title": "[BUG] High RSS Memory Usage Even with Active Defrag",
  "body": "**Describe the bug**\r\n\r\nHello! We have been observing a strange issue since upgrading our redis standalone servers from 6.2.5 to 7.2.5. Occasionally, one of our redis servers will start growing in RSS memory until the system is running out of memory. We have activedefrag enabled and it starts running during this time but it doesn't seem to help. Can someone help take a look and see what is going on? I captured some data when this occurred last. If we need more data I will have to wait until it happens again to get back with it.\r\n\r\n\r\n`MEMORY STATS`\r\n```\r\n 1) \"peak.allocated\"\r\n 2) (integer) 9155310640\r\n 3) \"total.allocated\"\r\n 4) (integer) 9088238672\r\n 5) \"startup.allocated\"\r\n 6) (integer) 859496\r\n 7) \"replication.backlog\"\r\n 8) (integer) 0\r\n 9) \"clients.slaves\"\r\n10) (integer) 0\r\n11) \"clients.normal\"\r\n12) (integer) 18185184\r\n13) \"cluster.links\"\r\n14) (integer) 0\r\n15) \"aof.buffer\"\r\n16) (integer) 0\r\n17) \"lua.caches\"\r\n18) (integer) 1416\r\n19) \"functions.caches\"\r\n20) (integer) 184\r\n21) \"db.0\"\r\n22) 1) \"overhead.hashtable.main\"\r\n    2) (integer) 547207768\r\n    3) \"overhead.hashtable.expires\"\r\n    4) (integer) 382011752\r\n    5) \"overhead.hashtable.slot-to-keys\"\r\n    6) (integer) 0\r\n23) \"overhead.total\"\r\n24) (integer) 948265800\r\n25) \"keys.count\"\r\n26) (integer) 10324751\r\n27) \"keys.bytes-per-key\"\r\n28) (integer) 880\r\n29) \"dataset.bytes\"\r\n30) (integer) 8139972872\r\n31) \"dataset.percentage\"\r\n32) \"89.57447814941406\"\r\n33) \"peak.percentage\"\r\n34) \"99.26740264892578\"\r\n35) \"allocator.allocated\"\r\n36) (integer) 9088373168\r\n37) \"allocator.active\"\r\n38) (integer) 12528521216\r\n39) \"allocator.resident\"\r\n40) (integer) 12667953152\r\n41) \"allocator-fragmentation.ratio\"\r\n42) \"1.3785219192504883\"\r\n43) \"allocator-fragmentation.bytes\"\r\n44) (integer) 3440148048\r\n45) \"allocator-rss.ratio\"\r\n46) \"1.0111291408538818\"\r\n47) \"allocator-rss.bytes\"\r\n48) (integer) 139431936\r\n49) \"rss-overhead.ratio\"\r\n50) \"0.9998315572738647\"\r\n51) \"rss-overhead.bytes\"\r\n52) (integer) -2134016\r\n53) \"fragmentation\"\r\n54) \"1.393649697303772\"\r\n55) \"fragmentation.bytes\"\r\n56) (integer) 3577581536\r\n```\r\n\r\n`MALLOC-STATS`\r\n```\r\n___ Begin jemalloc statistics ___\r\nVersion: \"5.3.0-0-g0\"\r\nBuild-time option settings\r\n  config.cache_oblivious: false\r\n  config.debug: false\r\n  config.fill: true\r\n  config.lazy_lock: false\r\n  config.malloc_conf: \"\"\r\n  config.opt_safety_checks: false\r\n  config.prof: false\r\n  config.prof_libgcc: false\r\n  config.prof_libunwind: false\r\n  config.stats: true\r\n  config.utrace: false\r\n  config.xmalloc: false\r\nRun-time option settings\r\n  opt.abort: false\r\n  opt.abort_conf: false\r\n  opt.cache_oblivious: false\r\n  opt.confirm_conf: false\r\n  opt.retain: true\r\n  opt.dss: \"secondary\"\r\n  opt.narenas: 8\r\n  opt.percpu_arena: \"disabled\"\r\n  opt.oversize_threshold: 8388608\r\n  opt.hpa: false\r\n  opt.hpa_slab_max_alloc: 65536\r\n  opt.hpa_hugification_threshold: 1992294\r\n  opt.hpa_hugify_delay_ms: 10000\r\n  opt.hpa_min_purge_interval_ms: 5000\r\n  opt.hpa_dirty_mult: \"0.25\"\r\n  opt.hpa_sec_nshards: 4\r\n  opt.hpa_sec_max_alloc: 32768\r\n  opt.hpa_sec_max_bytes: 262144\r\n  opt.hpa_sec_bytes_after_flush: 131072\r\n  opt.hpa_sec_batch_fill_extra: 0\r\n  opt.metadata_thp: \"disabled\"\r\n  opt.mutex_max_spin: 600\r\n  opt.background_thread: false (background_thread: true)\r\n  opt.dirty_decay_ms: 10000 (arenas.dirty_decay_ms: 10000)\r\n  opt.muzzy_decay_ms: 0 (arenas.muzzy_decay_ms: 0)\r\n  opt.lg_extent_max_active_fit: 6\r\n  opt.junk: \"false\"\r\n  opt.zero: false\r\n  opt.tcache: true\r\n  opt.tcache_max: 32768\r\n  opt.tcache_nslots_small_min: 20\r\n  opt.tcache_nslots_small_max: 200\r\n  opt.tcache_nslots_large: 20\r\n  opt.lg_tcache_nslots_mul: 1\r\n  opt.tcache_gc_incr_bytes: 65536\r\n  opt.tcache_gc_delay_bytes: 0\r\n  opt.lg_tcache_flush_small_div: 1\r\n  opt.lg_tcache_flush_large_div: 1\r\n  opt.thp: \"default\"\r\n  opt.stats_print: false\r\n  opt.stats_print_opts: \"\"\r\n  opt.stats_print: false\r\n  opt.stats_print_opts: \"\"\r\n  opt.stats_interval: -1\r\n  opt.stats_interval_opts: \"\"\r\n  opt.zero_realloc: \"free\"\r\nArenas: 9\r\nQuantum size: 8\r\nPage size: 4096\r\nMaximum thread-cached size class: 32768\r\nNumber of bin size classes: 39\r\nNumber of thread-cache bin size classes: 44\r\nNumber of large size classes: 196\r\nAllocated: 9088438136, active: 12537638912, metadata: 139436448 (n_thp 0), resident: 12677103616, mapped: 12690853888, retained: 1994452992\r\nCount of realloc(non-null-ptr, 0) calls: 0\r\nBackground threads: 1, num_runs: 74773, run_interval: 9706952082 ns\r\n                           n_lock_ops (#/sec)       n_waiting (#/sec)      n_spin_acq (#/sec)  n_owner_switch (#/sec)   total_wait_ns   (#/sec)     max_wait_ns  max_n_thds\r\nbackground_thread            15920251      21               0       0               0       0               1       0               0         0               0           0\r\nmax_per_bg_thd                8447672      11               0       0               0       0               3       0               0         0               0           0\r\nctl                          31840495      43               0       0               0       0               1       0               0         0               0           0\r\nprof                                0       0               0       0               0       0               0       0               0         0               0           0\r\nprof_thds_data                      0       0               0       0               0       0               0       0               0         0               0           0\r\nprof_dump                           0       0               0       0               0       0               0       0               0         0               0           0\r\nprof_recent_alloc                   0       0               0       0               0       0               0       0               0         0               0           0\r\nprof_recent_dump                    0       0               0       0               0       0               0       0               0         0               0           0\r\nprof_stats                          0       0               0       0               0       0               0       0               0         0               0           0\r\nMerged arenas stats:\r\nassigned threads: 1\r\nuptime: 725830571650076\r\ndss allocation precedence: \"N/A\"\r\ndecaying:  time       npages       sweeps     madvises       purged\r\n   dirty:   N/A           30        59808       593498      1893267\r\n   muzzy:   N/A            0            0            0            0\r\n                            allocated         nmalloc   (#/sec)         ndalloc   (#/sec)       nrequests   (#/sec)           nfill   (#/sec)          nflush   (#/sec)\r\nsmall:                     8760041336       554242742       763       446073706       614     67182704643     92559        85734598       118        29525034        40\r\nlarge:                      328396800         1215150         1         1214086         1        11320091        15         1215150         1          859012         1\r\ntotal:                     9088438136       555457892       765       447287792       616     67194024734     92575        86949748       119        30384046        41\r\n\r\nactive:                   12537638912\r\nmapped:                   12690853888\r\nretained:                  1994452992\r\nbase:                       139338144\r\ninternal:                       98304\r\nmetadata_thp:                       0\r\ntcache_bytes:                  103760\r\ntcache_stashed_bytes:               0\r\nresident:                 12677103616\r\nabandoned_vm:                       0\r\nextent_avail:                       1\r\n                           n_lock_ops (#/sec)       n_waiting (#/sec)      n_spin_acq (#/sec)  n_owner_switch (#/sec)   total_wait_ns   (#/sec)     max_wait_ns  max_n_thds\r\nlarge                        15829375      21               0       0               0       0               2       0               0         0               0           0\r\nextent_avail                 17998331      24               0       0               2       0          104942       0               0         0               0           0\r\nextents_dirty                22838844      31               0       0              58       0          119674       0               0         0               0           0\r\nextents_muzzy                15864762      21               0       0               0       0               2       0               0         0               0           0\r\nextents_retained             17626774      24               0       0               6       0          119698       0               0         0               0           0\r\ndecay_dirty                  17250502      23               0       0               1       0          297186       0               0         0               0           0\r\ndecay_muzzy                  15978550      22               0       0               0       0          296934       0               0         0               0           0\r\nbase                         32529371      44               0       0               0       0               2       0               0         0               0           0\r\ntcache_list                  15829376      21               0       0               0       0               2       0               0         0               0           0\r\nhpa_shard                           0       0               0       0               0       0               0       0               0         0               0           0\r\nhpa_shard_grow                      0       0               0       0               0       0               0       0               0         0               0           0\r\nhpa_sec                             0       0               0       0               0       0               0       0               0         0               0           0\r\nbins:           size ind    allocated      nmalloc (#/sec)      ndalloc (#/sec)    nrequests   (#/sec)  nshards      curregs     curslabs  nonfull_slabs regs pgs   util       nfills (#/sec)     nflushes (#/sec)       nslabs     nreslabs (#/sec)      n_lock_ops (#/sec)       n_waiting (#/sec)      n_spin_acq (#/sec)  n_owner_switch (#/sec)   total_wait_ns   (#/sec)     max_wait_ns  max_n_thds\r\n                   8   0         5992      1460121       2      1459372       2    165227552       227        1          749            2              0  512   1  0.731       908665       1       751437       1           19        15835       0        17489496      24               0       0               0       0               2       0               0         0               0           0\r\n                  16   1    165063952     53338498      73     43022001      59  19912092842     27433        1     10316497        42768          21276  256   1  0.942     10855872      14      1551039       2        78512     23817166      32        73137144     100               0       0               0       0         6578224       9               0         0               0           0\r\n                  24   2    865151040    164045682     226    127997722     176   8437774623     11625        1     36047960        73048          55411  512   3  0.963     14373712      19      2039254       2        95160     65526118      90       198481414     273               0       0               0       0        24699694      34               0         0               0           0\r\n                  32   3    328121216     47508388      65     37254600      51  11295660858     15562        1     10253788        85030          40353  128   1  0.942      6842004       9      1592562       2       158625     18131374      24        69605730      95               0       0               0       0         7114564       9               0         0               0           0\r\n                  40   4         5440       534324       0       534188       0   2931833591      4039        1          136            1              0  512   5  0.265       521512       0       251277       0            1            0       0        16602165      22               0       0               0       0               2       0               0         0               0           0\r\n                  48   5       109056      1985674       2      1983402       2    354711849       488        1         2272           21             15  256   3  0.422      1258241       1      1048496       1          353       817728       1        18185250      25               0       0               0       0           57184       0               0         0               0           0\r\n                  56   6    905802688     71069706      97     54894658      75   1922065392      2648        1     16175048        33453          17199  512   7  0.944      9502332      13      1586140       2        54004     24549924      33        94025222     129               0       0               0       0        10067686      13               0         0               0           0\r\n                  64   7    220889984     20255554      27     16804148      23   9163599655     12624        1      3451406        57263          27030   64   1  0.941      3259472       4      1498164       2       134042      7486391      10        37275666      51               0       0               0       0         2912754       4               0         0               0           0\r\n                  80   8     68633040     10648106      14      9790193      13   4291824716      5912        1       857913         3689           3351  256   5  0.908      2192822       3      1504358       2        13474      4109182       5        26367533      36               0       0               0       0         1574130       2               0         0               0           0\r\n                  96   9     17339232      2499640       3      2319023       3    859528950      1184        1       180617         1532            682  128   3  0.921      1000405       1      1121574       1         4790      1638823       2        18579568      25               0       0               0       0          370174       0               0         0               0           0\r\n                 112  10     62473936      5700197       7      5142394       7    574210007       791        1       557803         2320           1654  256   7  0.939      2136234       2      1322845       1         5747      3710376       5        20741666      28               0       0               0       0          476220       0               0         0               0           0\r\n                 128  11     80135040     18561135      25     17935080      24    337172693       464        1       626055        22087          19550   32   1  0.885      6767882       9      1566604       2       107037     12767896      17        32374751      44               0       0               0       0         1755476       2               0         0               0           0\r\n                 160  12   2426561600     56990302      78     41824292      57   2579470684      3553        1     15166010       119315          44864  128   5  0.993      7166304       9      1513051       2       186127     23672807      32        88689395     122               0       0               0       0        12148526      16               0         0               0           0\r\n                 192  13   1408278144     31675569      43     24340787      33   2049712618      2823        1      7334782       119689          58758   64   3  0.957      5002488       6      1479207       2       200693     12090507      16        52419929      72               0       0               0       0         6362682       8               0         0               0           0\r\n                 224  14    949042304     29418908      40     25182112      34   2048964999      2822        1      4236796        74111          69745  128   7  0.446      2849561       3      1491051       2       110749      8303720      11        60875629      83               0       0               0       0         1408028       1               0         0               0           0\r\n                 256  15     20811776      1491703       2      1410407       1     44440621        61        1        81296         5296           1595   16   1  0.959       747211       1       776031       1        21314      1062821       1        17647301      24               0       0               0       0          228230       0               0         0               0           0\r\n                 320  16    322758720     17105458      23     16096837      22    163920020       225        1      1008621       115337         111938   64   5  0.136      1210962       1      1267071       1       206011      1561018       2        48252296      66               0       0               0       0         1153456       1               0         0               0           0\r\n                 384  17    492847104      4230320       5      2946864       4     22604066        31        1      1283456        40108              0   32   3      1      1338847       1      1067491       1        67691      1704949       2        20171049      27               0       0               0       0          333398       0               0         0               0           0\r\n                 448  18     13349056      1277906       1      1248109       1      3152267         4        1        29797          475            213   64   7  0.980      1040379       1       630996       0         1311      1153062       1        17614587      24               0       0               0       0           63762       0               0         0               0           0\r\n                 512  19     40167936      1413530       1      1335077       1      3221982         4        1        78453         9822            119    8   1  0.998       968131       1       722665       0        27368      1087814       1        17760997      24               0       0               0       0           98412       0               0         0               0           0\r\n                 640  20    116151680      1510154       2      1328667       1      3868401         5        1       181487         5672              0   32   5  0.999       984093       1       630889       0        11067      1151388       1        17813467      24               0       0               0       0           51560       0               0         0               0           0\r\n                 768  21    130656000       800815       1       630690       0      2335944         3        1       170125        10633              0   16   3  0.999       507694       0       285925       0        17375       566498       0        16834672      23               0       0               0       0           25354       0               0         0               0           0\r\n                 896  22     84373632       633803       0       539636       0      1370478         1        1        94167         2943              0   32   7  0.999       443954       0       367760       0         4943       224736       0        16705338      23               0       0               0       0           14328       0               0         0               0           0\r\n                1024  23     28119040      4382005       6      4354545       5      6779850         9        1        27460         6869             15    4   1  0.999      1908121       2      1613523       2        32073      4316967       5        19406739      26               0       0               0       0           13934       0               0         0               0           0\r\n                1280  24      4357120        68112       0        64708       0        78116         0        1         3404          213              1   16   5  0.998        61798       0        39568       0          408        52685       0        15937093      21               0       0               0       0            7270       0               0         0               0           0\r\n                1536  25      1015296        50198       0        49537       0        43369         0        1          661           87             20    8   3  0.949        38045       0        36189       0          342        38659       0        15906588      21               0       0               0       0            3350       0               0         0               0           0\r\n                1792  26       684544        41289       0        40907       0        53208         0        1          382           26             12   16   7  0.918        38242       0        29987       0          107        23204       0        15899656      21               0       0               0       0            2710       0               0         0               0           0\r\n                2048  27      1288192      4957078       6      4956449       6      6486777         8        1          629          319              9    2   1  0.985      1431194       1      1285085       1       360643      4650579       6        18909840      26               0       0               0       0            6118       0               0         0               0           0\r\n                2560  28       768000        14111       0        13811       0        13860         0        1          300           43             24    8   5  0.872        13441       0        10157       0           86         8192       0        15854369      21               0       0               0       0            1646       0               0         0               0           0\r\n                3072  29       439296        34197       0        34054       0        32242         0        1          143           40             13    4   3  0.893        31317       0        30906       0          153         9327       0        15892405      21               0       0               0       0             850       0               0         0               0           0\r\n                3584  30       340480        17907       0        17812       0        17699         0        1           95           13              2    8   7  0.913        17454       0        16204       0           55         3026       0        15863489      21               0       0               0       0             532       0               0         0               0           0\r\n                4096  31      1421312       461127       0       460780       0       376549         0        1          347          347              0    1   1      1       259944       0       344160       0       461127            0       0        16896310      23               0       0               0       0            3288       0               0         0               0           0\r\n                5120  32       378880        15199       0        15125       0        15139         0        1           74           21              5    4   5  0.880        14958       0        13920       0           85         2254       0        15858668      21               0       0               0       0             400       0               0         0               0           0\r\n                6144  33       344064         4787       0         4731       0         4623         0        1           56           31              5    2   3  0.903         4363       0         2799       0          467         3298       0        15837168      21               0       0               0       0             238       0               0         0               0           0\r\n                7168  34       157696         2176       0         2154       0         2143         0        1           22            7              4    4   7  0.785         1950       0         1161       0          110         1194       0        15832719      21               0       0               0       0             110       0               0         0               0           0\r\n                8192  35      1540096        21667       0        21479       0        18668         0        1          188          188              0    1   2      1        17908       0        19952       0        21667            0       0        15889896      21               0       0               0       0            1888       0               0         0               0           0\r\n               10240  36       276480         2210       0         2183       0         2255         0        1           27           16              4    2   5  0.843         2092       0         1407       0          253         1760       0        15833207      21               0       0               0       0              96       0               0         0               0           0\r\n               12288  37       110592        13676       0        13667       0        13732         0        1            9            9              0    1   3      1        13509       0        13024       0        13676            0       0        15869608      21               0       0               0       0              48       0               0         0               0           0\r\n               14336  38        71680         1510       0         1505       0         1605         0        1            5            4              2    2   7  0.625         1485       0         1105       0          282          813       0        15832266      21               0       0               0       0              34       0               0         0               0           0\r\nlarge:          size ind    allocated      nmalloc (#/sec)      ndalloc (#/sec)    nrequests (#/sec)  curlextents\r\n               16384  39      1769472       316178       0       316070       0       364172       0          108\r\n               20480  40     15667200       832600       1       831835       1     10874836      14          765\r\n               24576  41       737280         5624       0         5594       0         7639       0           30\r\n               28672  42       802816        17034       0        17006       0        29725       0           28\r\n               32768  43      1277952         1189       0         1150       0         1194       0           39\r\n               40960  44        40960          248       0          247       0          248       0            1\r\n               49152  45            0         2541       0         2541       0         2541       0            0\r\n               57344  46            0        35906       0        35906       0        35906       0            0\r\n               65536  47      1900544          957       0          928       0          957       0           29\r\n               81920  48        81920         1249       0         1248       0         1249       0            1\r\n               98304  49            0          113       0          113       0          113       0            0\r\n              114688  50            0          301       0          301       0          301       0            0\r\n              131072  51      1835008          266       0          252       0          266       0           14\r\n              163840  52            0          298       0          298       0          298       0            0\r\n              196608  53            0           90       0           90       0           90       0            0\r\n              229376  54            0          125       0          125       0          125       0            0\r\n              262144  55      6553600          133       0          108       0          133       0           25\r\n              327680  56       327680          112       0          111       0          112       0            1\r\n              393216  57            0           50       0           50       0           50       0            0\r\n              458752  58            0            8       0            8       0            8       0            0\r\n              524288  59      5242880           43       0           33       0           43       0           10\r\n              655360  60       655360            8       0            7       0            8       0            1\r\n              786432  61            0            8       0            8       0            8       0            0\r\n              917504  62            0           20       0           20       0           20       0            0\r\n             1048576  63      2097152           18       0           16       0           18       0            2\r\n                     ---\r\n             2097152  67     12582912           12       0            6       0           12       0            6\r\n                     ---\r\n             4194304  71      8388608            5       0            3       0            5       0            2\r\n                     ---\r\n             8388608  75            0            3       0            3       0            3       0            0\r\n                     ---\r\n            16777216  79            0            3       0            3       0            3       0            0\r\n                     ---\r\n            33554432  83            0            3       0            3       0            3       0            0\r\n                     ---\r\n            67108864  87            0            3       0            3       0            3       0            0\r\n                     ---\r\n           134217728  91    268435456            2       0            0       0            2       0            2\r\n                     ---\r\nextents:        size ind       ndirty        dirty       nmuzzy        muzzy    nretained     retained       ntotal        total\r\n                4096   0           10        40960            0            0        21144     86605824        21154     86646784\r\n                8192   1           10        81920            0            0        15494    126926848        15504    127008768\r\n                     ---\r\n             8388608  39            0            0            0            0            1      8388608            1      8388608\r\n            10485760  40            0            0            0            0            1     10485760            1     10485760\r\n                     ---\r\n            16777216  43            0            0            0            0            1     16777216            1     16777216\r\n            20971520  44            0            0            0            0            1     20971520            1     20971520\r\n                     ---\r\n            33554432  47            0            0            0            0            2     67108864            2     67108864\r\n            41943040  48            0            0            0            0            1     41943040            1     41943040\r\n                     ---\r\n            67108864  51            0            0            0            0            1     67108864            1     67108864\r\n            83886080  52            0            0            0            0            1     83886080            1     83886080\r\n                     ---\r\n          1342177280  68            0            0            0            0            1   1464250368            1   1464250368\r\n                     ---\r\nBytes in small extent cache: 0\r\nHPA shard stats:\r\n  Purge passes: 0 (0 / sec)\r\n  Purges: 0 (0 / sec)\r\n  Hugeifies: 0 (0 / sec)\r\n  Dehugifies: 0 (0 / sec)\r\n\r\n  In full slabs:\r\n      npageslabs: 0 huge, 0 nonhuge\r\n      nactive: 0 huge, 0 nonhuge\r\n      ndirty: 0 huge, 0 nonhuge\r\n      nretained: 0 huge, 0 nonhuge\r\n  In empty slabs:\r\n      npageslabs: 0 huge, 0 nonhuge\r\n      nactive: 0 huge, 0 nonhuge\r\n      ndirty: 0 huge, 0 nonhuge\r\n      nretained: 0 huge, 0 nonhuge\r\n\r\n                size ind npageslabs_huge    nactive_huge     ndirty_huge  npageslabs_nonhuge     nactive_nonhuge      ndirty_nonhuge   nretained_nonhuge\r\n                     ---\r\narenas[0]:\r\nassigned threads: 1\r\nuptime: 725830571650076\r\ndss allocation precedence: \"secondary\"\r\ndecaying:  time       npages       sweeps     madvises       purged\r\n   dirty: 10000           30        59808       593486      1801107\r\n   muzzy:     0            0            0            0            0\r\n                            allocated         nmalloc   (#/sec)         ndalloc   (#/sec)       nrequests   (#/sec)           nfill   (#/sec)          nflush   (#/sec)\r\nsmall:                     8760041336       554242742       763       446073706       614     67182704643     92559        85734598       118        29525034        40\r\nlarge:                       59961344         1215136         1         1214074         1        11320077        15         1215136         1          859012         1\r\ntotal:                     8820002680       555457878       765       447287780       616     67194024720     92575        86949734       119        30384046        41\r\n\r\nactive:                   12269203456\r\nmapped:                   12420321280\r\nretained:                  1677783040\r\nbase:                       139244752\r\ninternal:                       98304\r\nmetadata_thp:                       0\r\ntcache_bytes:                  103760\r\ntcache_stashed_bytes:               0\r\nresident:                 12408573952\r\nabandoned_vm:                       0\r\nextent_avail:                       0\r\n                           n_lock_ops (#/sec)       n_waiting (#/sec)      n_spin_acq (#/sec)  n_owner_switch (#/sec)   total_wait_ns   (#/sec)     max_wait_ns  max_n_thds\r\nlarge                         7960125      10               0       0               0       0               1       0               0         0               0           0\r\nextent_avail                 10129062      13               0       0               2       0          104941       0               0         0               0           0\r\nextents_dirty                14969568      20               0       0              58       0          119673       0               0         0               0           0\r\nextents_muzzy                 7995512      11               0       0               0       0               1       0               0         0               0           0\r\nextents_retained              9757493      13               0       0               6       0          119697       0               0         0               0           0\r\ndecay_dirty                   9234703      12               0       0               1       0          148985       0               0         0               0           0\r\ndecay_muzzy                   8034898      11               0       0               0       0          148831       0               0         0               0           0\r\nbase                         16790858      23               0       0               0       0               1       0               0         0               0           0\r\ntcache_list                   7960126      10               0       0               0       0               1       0               0         0               0           0\r\nhpa_shard                           0       0               0       0               0       0               0       0               0         0               0           0\r\nhpa_shard_grow                      0       0               0       0               0       0               0       0               0         0               0           0\r\nhpa_sec                             0       0               0       0               0       0               0       0               0         0               0           0\r\nbins:           size ind    allocated      nmalloc (#/sec)      ndalloc (#/sec)    nrequests   (#/sec)  nshards      curregs     curslabs  nonfull_slabs regs pgs   util       nfills (#/sec)     nflushes (#/sec)       nslabs     nreslabs (#/sec)      n_lock_ops (#/sec)       n_waiting (#/sec)      n_spin_acq (#/sec)  n_owner_switch (#/sec)   total_wait_ns   (#/sec)     max_wait_ns  max_n_thds\r\n                   8   0         5992      1460121       2      1459372       2    165227552       227        1          749            2              0  512   1  0.731       908665       1       751437       1           19        15835       0         9620246      13               0       0               0       0               1       0               0         0               0           0\r\n                  16   1    165063952     53338498      73     43022001      59  19912092842     27433        1     10316497        42768          21276  256   1  0.942     10855872      14      1551039       2        78512     23817166      32        65267894      89               0       0               0       0         6578223       9               0         0               0           0\r\n                  24   2    865151040    164045682     226    127997722     176   8437774623     11625        1     36047960        73048          55411  512   3  0.963     14373712      19      2039254       2        95160     65526118      90       190612164     262               0       0               0       0        24699693      34               0         0               0           0\r\n                  32   3    328121216     47508388      65     37254600      51  11295660858     15562        1     10253788        85030          40353  128   1  0.942      6842004       9      1592562       2       158625     18131374      24        61736480      85               0       0               0       0         7114563       9               0         0               0           0\r\n                  40   4         5440       534324       0       534188       0   2931833591      4039        1          136            1              0  512   5  0.265       521512       0       251277       0            1            0       0         8732915      12               0       0               0       0               1       0               0         0               0           0\r\n                  48   5       109056      1985674       2      1983402       2    354711849       488        1         2272           21             15  256   3  0.422      1258241       1      1048496       1          353       817728       1        10316000      14               0       0               0       0           57183       0               0         0               0           0\r\n                  56   6    905802688     71069706      97     54894658      75   1922065392      2648        1     16175048        33453          17199  512   7  0.944      9502332      13      1586140       2        54004     24549924      33        86155972     118               0       0               0       0        10067685      13               0         0               0           0\r\n                  64   7    220889984     20255554      27     16804148      23   9163599655     12624        1      3451406        57263          27030   64   1  0.941      3259472       4      1498164       2       134042      7486391      10        29406416      40               0       0               0       0         2912753       4               0         0               0           0\r\n                  80   8     68633040     10648106      14      9790193      13   4291824716      5912        1       857913         3689           3351  256   5  0.908      2192822       3      1504358       2        13474      4109182       5        18498283      25               0       0               0       0         1574129       2               0         0               0           0\r\n                  96   9     17339232      2499640       3      2319023       3    859528950      1184        1       180617         1532            682  128   3  0.921      1000405       1      1121574       1         4790      1638823       2        10710318      14               0       0               0       0          370173       0               0         0               0           0\r\n                 112  10     62473936      5700197       7      5142394       7    574210007       791        1       557803         2320           1654  256   7  0.939      2136234       2      1322845       1         5747      3710376       5        12872416      17               0       0               0       0          476219       0               0         0               0           0\r\n                 128  11     80135040     18561135      25     17935080      24    337172693       464        1       626055        22087          19550   32   1  0.885      6767882       9      1566604       2       107037     12767896      17        24505501      33               0       0               0       0         1755475       2               0         0               0           0\r\n                 160  12   2426561600     56990302      78     41824292      57   2579470684      3553        1     15166010       119315          44864  128   5  0.993      7166304       9      1513051       2       186127     23672807      32        80820145     111               0       0               0       0        12148525      16               0         0               0           0\r\n                 192  13   1408278144     31675569      43     24340787      33   2049712618      2823        1      7334782       119689          58758   64   3  0.957      5002488       6      1479207       2       200693     12090507      16        44550679      61               0       0               0       0         6362681       8               0         0               0           0\r\n                 224  14    949042304     29418908      40     25182112      34   2048964999      2822        1      4236796        74111          69745  128   7  0.446      2849561       3      1491051       2       110749      8303720      11        53006379      73               0       0               0       0         1408027       1               0         0               0           0\r\n                 256  15     20811776      1491703       2      1410407       1     44440621        61        1        81296         5296           1595   16   1  0.959       747211       1       776031       1        21314      1062821       1         9778051      13               0       0               0       0          228229       0               0         0               0           0\r\n                 320  16    322758720     17105458      23     16096837      22    163920020       225        1      1008621       115337         111938   64   5  0.136      1210962       1      1267071       1       206011      1561018       2        40383046      55               0       0               0       0         1153455       1               0         0               0           0\r\n                 384  17    492847104      4230320       5      2946864       4     22604066        31        1      1283456        40108              0   32   3      1      1338847       1      1067491       1        67691      1704949       2        12301799      16               0       0               0       0          333397       0               0         0               0           0\r\n                 448  18     13349056      1277906       1      1248109       1      3152267         4        1        29797          475            213   64   7  0.980      1040379       1       630996       0         1311      1153062       1         9745337      13               0       0               0       0           63761       0               0         0               0           0\r\n                 512  19     40167936      1413530       1      1335077       1      3221982         4        1        78453         9822            119    8   1  0.998       968131       1       722665       0        27368      1087814       1         9891747      13               0       0               0       0           98411       0               0         0               0           0\r\n                 640  20    116151680      1510154       2      1328667       1      3868401         5        1       181487         5672              0   32   5  0.999       984093       1       630889       0        11067      1151388       1         9944217      13               0       0               0       0           51559       0               0         0               0           0\r\n                 768  21    130656000       800815       1       630690       0      2335944         3        1       170125        10633              0   16   3  0.999       507694       0       285925       0        17375       566498       0         8965422      12               0       0               0       0           25353       0               0         0               0           0\r\n                 896  22     84373632       633803       0       539636       0      1370478         1        1        94167         2943              0   32   7  0.999       443954       0       367760       0         4943       224736       0         8836088      12               0       0               0       0           14327       0               0         0               0           0\r\n                1024  23     28119040      4382005       6      4354545       5      6779850         9        1        27460         6869             15    4   1  0.999      1908121       2      1613523       2        32073      4316967       5        11537489      15               0       0               0       0           13933       0               0         0               0           0\r\n                1280  24      4357120        68112       0        64708       0        78116         0        1         3404          213              1   16   5  0.998        61798       0        39568       0          408        52685       0         8067843      11               0       0               0       0            7269       0               0         0               0           0\r\n                1536  25      1015296        50198       0        49537       0        43369         0        1          661           87             20    8   3  0.949        38045       0        36189       0          342        38659       0         8037338      11               0       0               0       0            3349       0               0         0               0           0\r\n                1792  26       684544        41289       0        40907       0        53208         0        1          382           26             12   16   7  0.918        38242       0        29987       0          107        23204       0         8030406      11               0       0               0       0            2709       0               0         0               0           0\r\n                2048  27      1288192      4957078       6      4956449       6      6486777         8        1          629          319              9    2   1  0.985      1431194       1      1285085       1       360643      4650579       6        11040590      15               0       0               0       0            6117       0               0         0               0           0\r\n                2560  28       768000        14111       0        13811       0        13860         0        1          300           43             24    8   5  0.872        13441       0        10157       0           86         8192       0         7985119      11               0       0               0       0            1645       0               0         0               0           0\r\n                3072  29       439296        34197       0        34054       0        32242         0        1          143           40             13    4   3  0.893        31317       0        30906       0          153         9327       0         8023155      11               0       0               0       0             849       0               0         0               0           0\r\n                3584  30       340480        17907       0        17812       0        17699         0        1           95           13              2    8   7  0.913        17454       0        16204       0           55         3026       0         7994239      11               0       0               0       0             531       0               0         0               0           0\r\n                4096  31      1421312       461127       0       460780       0       376549         0        1          347          347              0    1   1      1       259944       0       344160       0       461127            0       0         9027060      12               0       0               0       0            3287       0               0         0               0           0\r\n                5120  32       378880        15199       0        15125       0        15139         0        1           74           21              5    4   5  0.880        14958       0        13920       0           85         2254       0         7989418      11               0       0               0       0             399       0               0         0               0           0\r\n                6144  33       344064         4787       0         4731       0         4623         0        1           56           31              5    2   3  0.903         4363       0         2799       0          467         3298       0         7967918      10               0       0               0       0             237       0               0         0               0           0\r\n                7168  34       157696         2176       0         2154       0         2143         0        1           22            7              4    4   7  0.785         1950       0         1161       0          110         1194       0         7963469      10               0       0               0       0             109       0               0         0               0           0\r\n                8192  35      1540096        21667       0        21479       0        18668         0        1          188          188              0    1   2      1        17908       0        19952       0        21667            0       0         8020646      11               0       0               0       0            1887       0               0         0               0           0\r\n               10240  36       276480         2210       0         2183       0         2255         0        1           27           16              4    2   5  0.843         2092       0         1407       0          253         1760       0         7963957      10               0       0               0       0              95       0               0         0               0           0\r\n               12288  37       110592        13676       0        13667       0        13732         0        1            9            9              0    1   3      1        13509       0        13024       0        13676            0       0         8000358      11               0       0               0       0              47       0               0         0               0           0\r\n               14336  38        71680         1510       0         1505       0         1605         0        1            5            4              2    2   7  0.625         1485       0         1105       0          282          813       0         7963016      10               0       0               0       0              33       0               0         0               0           0\r\nlarge:          size ind    allocated      nmalloc (#/sec)      ndalloc (#/sec)    nrequests (#/sec)  curlextents\r\n               16384  39      1769472       316178       0       316070       0       364172       0          108\r\n               20480  40     15667200       832600       1       831835       1     10874836      14          765\r\n               24576  41       737280         5624       0         5594       0         7639       0           30\r\n               28672  42       802816        17034       0        17006       0        29725       0           28\r\n               32768  43      1277952         1189       0         1150       0         1194       0           39\r\n               40960  44        40960          248       0          247       0          248       0            1\r\n               49152  45            0         2541       0         2541       0         2541       0            0\r\n               57344  46            0        35906       0        35906       0        35906       0            0\r\n               65536  47      1900544          957       0          928       0          957       0           29\r\n               81920  48        81920         1249       0         1248       0         1249       0            1\r\n               98304  49            0          113       0          113       0          113       0            0\r\n              114688  50            0          301       0          301       0          301       0            0\r\n              131072  51      1835008          266       0          252       0          266       0           14\r\n              163840  52            0          298       0          298       0          298       0            0\r\n              196608  53            0           90       0           90       0           90       0            0\r\n              229376  54            0          125       0          125       0          125       0            0\r\n              262144  55      6553600          133       0          108       0          133       0           25\r\n              327680  56       327680          112       0          111       0          112       0            1\r\n              393216  57            0           50       0           50       0           50       0            0\r\n              458752  58            0            8       0            8       0            8       0            0\r\n              524288  59      5242880           43       0           33       0           43       0           10\r\n              655360  60       655360            8       0            7       0            8       0            1\r\n              786432  61            0            8       0            8       0            8       0            0\r\n              917504  62            0           20       0           20       0           20       0            0\r\n             1048576  63      2097152           18       0           16       0           18       0            2\r\n                     ---\r\n             2097152  67     12582912           12       0            6       0           12       0            6\r\n                     ---\r\n             4194304  71      8388608            5       0            3       0            5       0            2\r\n                     ---\r\nextents:        size ind       ndirty        dirty       nmuzzy        muzzy    nretained     retained       ntotal        total\r\n                4096   0           10        40960            0            0        21144     86605824        21154     86646784\r\n                8192   1           10        81920            0            0        15494    126926848        15504    127008768\r\n                     ---\r\n          1342177280  68            0            0            0            0            1   1464250368            1   1464250368\r\n                     ---\r\nBytes in small extent cache: 0\r\nHPA shard stats:\r\n  Purge passes: 0 (0 / sec)\r\n  Purges: 0 (0 / sec)\r\n  Hugeifies: 0 (0 / sec)\r\n  Dehugifies: 0 (0 / sec)\r\n\r\n  In full slabs:\r\n      npageslabs: 0 huge, 0 nonhuge\r\n      nactive: 0 huge, 0 nonhuge\r\n      ndirty: 0 huge, 0 nonhuge\r\n      nretained: 0 huge, 0 nonhuge\r\n  In empty slabs:\r\n      npageslabs: 0 huge, 0 nonhuge\r\n      nactive: 0 huge, 0 nonhuge\r\n      ndirty: 0 huge, 0 nonhuge\r\n      nretained: 0 huge, 0 nonhuge\r\n\r\n                size ind npageslabs_huge    nactive_huge     ndirty_huge  npageslabs_nonhuge     nactive_nonhuge      ndirty_nonhuge   nretained_nonhuge\r\n                     ---\r\narenas[8]:\r\nassigned threads: 0\r\nuptime: 717554192152229\r\ndss allocation precedence: \"secondary\"\r\ndecaying:  time       npages       sweeps     madvises       purged\r\n   dirty:     0            0            0           12        92160\r\n   muzzy:     0            0            0            0            0\r\n                            allocated         nmalloc   (#/sec)         ndalloc   (#/sec)       nrequests   (#/sec)           nfill   (#/sec)          nflush   (#/sec)\r\nsmall:                              0               0         0               0         0               0         0               0         0               0         0\r\nlarge:                      268435456              14         0              12         0              14         0              14         0               0         0\r\ntotal:                      268435456              14         0              12         0              14         0              14         0               0         0\r\n\r\nactive:                     268435456\r\nmapped:                     270532608\r\nretained:                   316669952\r\nbase:                           93392\r\ninternal:                           0\r\nmetadata_thp:                       0\r\ntcache_bytes:                       0\r\ntcache_stashed_bytes:               0\r\nresident:                   268529664\r\nabandoned_vm:                       0\r\nextent_avail:                       1\r\n                           n_lock_ops (#/sec)       n_waiting (#/sec)      n_spin_acq (#/sec)  n_owner_switch (#/sec)   total_wait_ns   (#/sec)     max_wait_ns  max_n_thds\r\nlarge                         7869250      10               0       0               0       0               1       0               0         0               0           0\r\nextent_avail                  7869269      10               0       0               0       0               1       0               0         0               0           0\r\nextents_dirty                 7869276      10               0       0               0       0               1       0               0         0               0           0\r\nextents_muzzy                 7869250      10               0       0               0       0               1       0               0         0               0           0\r\nextents_retained              7869281      10               0       0               0       0               1       0               0         0               0           0\r\ndecay_dirty                   8015799      11               0       0               0       0          148201       0               0         0               0           0\r\ndecay_muzzy                   7943652      11               0       0               0       0          148103       0               0         0               0           0\r\nbase                         15738513      21               0       0               0       0               1       0               0         0               0           0\r\ntcache_list                   7869250      10               0       0               0       0               1       0               0         0               0           0\r\nhpa_shard                           0       0               0       0               0       0               0       0               0         0               0           0\r\nhpa_shard_grow                      0       0               0       0               0       0               0       0               0         0               0           0\r\nhpa_sec                             0       0               0       0               0       0               0       0               0         0               0           0\r\nbins:           size ind    allocated      nmalloc (#/sec)      ndalloc (#/sec)    nrequests   (#/sec)  nshards      curregs     curslabs  nonfull_slabs regs pgs   util       nfills (#/sec)     nflushes (#/sec)       nslabs     nreslabs (#/sec)      n_lock_ops (#/sec)       n_waiting (#/sec)      n_spin_acq (#/sec)  n_owner_switch (#/sec)   total_wait_ns   (#/sec)     max_wait_ns  max_n_thds\r\n                     ---\r\nlarge:          size ind    allocated      nmalloc (#/sec)      ndalloc (#/sec)    nrequests (#/sec)  curlextents\r\n                     ---\r\n             8388608  75            0            3       0            3       0            3       0            0\r\n                     ---\r\n            16777216  79            0            3       0            3       0            3       0            0\r\n                     ---\r\n            33554432  83            0            3       0            3       0            3       0            0\r\n                     ---\r\n            67108864  87            0            3       0            3       0            3       0            0\r\n                     ---\r\n           134217728  91    268435456            2       0            0       0            2       0            2\r\n                     ---\r\nextents:        size ind       ndirty        dirty       nmuzzy        muzzy    nretained     retained       ntotal        total\r\n                     ---\r\n             8388608  39            0            0            0            0            1      8388608            1      8388608\r\n            10485760  40            0            0            0            0            1     10485760            1     10485760\r\n                     ---\r\n            16777216  43            0            0            0            0            1     16777216            1     16777216\r\n            20971520  44            0            0            0            0            1     20971520            1     20971520\r\n                     ---\r\n            33554432  47            0            0            0            0            2     67108864            2     67108864\r\n            41943040  48            0            0            0            0            1     41943040            1     41943040\r\n                     ---\r\n            67108864  51            0            0            0            0            1     67108864            1     67108864\r\n            83886080  52            0            0            0            0            1     83886080            1     83886080\r\n                     ---\r\nBytes in small extent cache: 0\r\nHPA shard stats:\r\n  Purge passes: 0 (0 / sec)\r\n  Purges: 0 (0 / sec)\r\n  Hugeifies: 0 (0 / sec)\r\n  Dehugifies: 0 (0 / sec)\r\n\r\n  In full slabs:\r\n      npageslabs: 0 huge, 0 nonhuge\r\n      nactive: 0 huge, 0 nonhuge\r\n      ndirty: 0 huge, 0 nonhuge\r\n      nretained: 0 huge, 0 nonhuge\r\n  In empty slabs:\r\n      npageslabs: 0 huge, 0 nonhuge\r\n      nactive: 0 huge, 0 nonhuge\r\n      ndirty: 0 huge, 0 nonhuge\r\n      nretained: 0 huge, 0 nonhuge\r\n\r\n                size ind npageslabs_huge    nactive_huge     ndirty_huge  npageslabs_nonhuge     nactive_nonhuge      ndirty_nonhuge   nretained_nonhuge\r\n                     ---\r\n--- End jemalloc statistics ---\r\n```\r\n\r\n**To reproduce**\r\n\r\nUnsure what causes this issue to reproduce.\r\n\r\n**Expected behavior**\r\n\r\nI expect active defrag running to help with external memory fragmentation\r\n",
  "state": "open",
  "created_at": "2024-10-21T23:08:10Z",
  "updated_at": "2024-10-30T07:41:21Z",
  "closed_at": null,
  "labels": [
    "memory efficiency"
  ],
  "comments_data": [
    {
      "id": 2427969949,
      "user": "RohanNagar",
      "created_at": "2024-10-22T00:21:20Z",
      "body": "Happened again today, here's some more data. Running `memory purge` does not help either.\r\n\r\n`INFO ALL`\r\n```\r\n# Server\r\nredis_version:7.2.5\r\nredis_git_sha1:ba8435db\r\nredis_git_dirty:0\r\nredis_build_id:3074ab5ecf741c27\r\nredis_mode:standalone\r\nos:Linux 4.18.0-553.22.1.el8_10.x86_64 x86_64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:8.5.0\r\nprocess_id:4376\r\nprocess_supervised:systemd\r\nrun_id:e811f080646ab2775a9a7f8cace050c05a7dfc92\r\ntcp_port:6379\r\nserver_time_usec:1729555801281191\r\nuptime_in_seconds:1133405\r\nuptime_in_days:13\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:1502553\r\nexecutable:/usr/sbin/redis-server\r\nconfig_file:/etc/redis.conf\r\nio_threads_active:0\r\nlistener0:name=tcp,bind=0.0.0.0,port=6379\r\nlistener1:name=unix,bind=/var/run/redis_sock/redis-6379.sock\r\nlistener2:name=tls,bind=0.0.0.0,port=7379\r\n\r\n# Clients\r\nconnected_clients:737\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:32768\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\ntotal_blocking_keys:0\r\ntotal_blocking_keys_on_nokey:0\r\n\r\n# Memory\r\nused_memory:9088235600\r\nused_memory_human:8.46G\r\nused_memory_rss:12318998528\r\nused_memory_rss_human:11.47G\r\nused_memory_peak:10576946736\r\nused_memory_peak_human:9.85G\r\nused_memory_peak_perc:85.92%\r\nused_memory_overhead:492113104\r\nused_memory_startup:859624\r\nused_memory_dataset:8596122496\r\nused_memory_dataset_perc:94.59%\r\nallocator_allocated:9088345344\r\nallocator_active:12174733312\r\nallocator_resident:12318003200\r\ntotal_system_memory:16524062720\r\ntotal_system_memory_human:15.39G\r\nused_memory_lua:45056\r\nused_memory_vm_eval:45056\r\nused_memory_lua_human:44.00K\r\nused_memory_scripts_eval:1416\r\nnumber_of_cached_scripts:3\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:32768\r\nused_memory_vm_total:77824\r\nused_memory_vm_total_human:76.00K\r\nused_memory_functions:184\r\nused_memory_scripts:1600\r\nused_memory_scripts_human:1.56K\r\nmaxmemory:9088234496\r\nmaxmemory_human:8.46G\r\nmaxmemory_policy:allkeys-lru\r\nallocator_frag_ratio:1.34\r\nallocator_frag_bytes:3086387968\r\nallocator_rss_ratio:1.01\r\nallocator_rss_bytes:143269888\r\nrss_overhead_ratio:1.00\r\nrss_overhead_bytes:995328\r\nmem_fragmentation_ratio:1.36\r\nmem_fragmentation_bytes:3230781472\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:15918376\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.3.0\r\nactive_defrag_running:3\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:3855724342\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1728422396\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_rewrites_consecutive_failures:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:543749\r\ntotal_commands_processed:14896539480\r\ninstantaneous_ops_per_sec:23278\r\ntotal_net_input_bytes:1879293071321\r\ntotal_net_output_bytes:507751839476\r\ntotal_net_repl_input_bytes:0\r\ntotal_net_repl_output_bytes:0\r\ninstantaneous_input_kbps:2897.23\r\ninstantaneous_output_kbps:775.56\r\ninstantaneous_input_repl_kbps:0.00\r\ninstantaneous_output_repl_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:334\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:147716\r\nevicted_keys:186471833\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:17441\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:3265529322\r\nkeyspace_misses:786302739\r\npubsub_channels:0\r\npubsub_patterns:0\r\npubsubshard_channels:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:47437824\r\nactive_defrag_misses:644438217\r\nactive_defrag_key_hits:24995110\r\nactive_defrag_key_misses:40306569\r\ntotal_active_defrag_time:682394696\r\ncurrent_active_defrag_time:60226072\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:3\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:7080869174\r\ntotal_writes_processed:7080287466\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:5614803\r\nreply_buffer_expands:5846381\r\neventloop_cycles:6389187531\r\neventloop_duration_sum:134357470753\r\neventloop_duration_cmd_sum:44913538693\r\ninstantaneous_eventloop_cycles_per_sec:8754\r\ninstantaneous_eventloop_duration_usec:31\r\nacl_access_denied_auth:0\r\nacl_access_denied_cmd:0\r\nacl_access_denied_key:0\r\nacl_access_denied_channel:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:c0aae4db6311168f7d6c653c893f1d239d1b4e76\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:70291.693001\r\nused_cpu_user:66864.358432\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:70286.924357\r\nused_cpu_user_main_thread:66862.782976\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_hget:calls=4014097266,usec=7164352079,usec_per_call=1.78,rejected_calls=0,failed_calls=0\r\ncmdstat_ping:calls=72511,usec=99811,usec_per_call=1.38,rejected_calls=0,failed_calls=0\r\ncmdstat_auth:calls=56674,usec=131705,usec_per_call=2.32,rejected_calls=0,failed_calls=0\r\ncmdstat_del:calls=3002555646,usec=3529269530,usec_per_call=1.18,rejected_calls=0,failed_calls=0\r\ncmdstat_acl|list:calls=1,usec=6,usec_per_call=6.00,rejected_calls=0,failed_calls=0\r\ncmdstat_acl|save:calls=3,usec=5859,usec_per_call=1953.00,rejected_calls=0,failed_calls=0\r\ncmdstat_acl|setuser:calls=3,usec=75,usec_per_call=25.00,rejected_calls=0,failed_calls=0\r\ncmdstat_info:calls=18891,usec=4233845,usec_per_call=224.12,rejected_calls=0,failed_calls=0\r\ncmdstat_set:calls=37734400,usec=50401772,usec_per_call=1.34,rejected_calls=0,failed_calls=0\r\ncmdstat_latency|latest:calls=18891,usec=30860,usec_per_call=1.63,rejected_calls=0,failed_calls=0\r\ncmdstat_latency|reset:calls=18891,usec=31469,usec_per_call=1.67,rejected_calls=0,failed_calls=0\r\ncmdstat_hgetall:calls=395,usec=2737807,usec_per_call=6931.16,rejected_calls=0,failed_calls=0\r\ncmdstat_hdel:calls=200,usec=397,usec_per_call=1.99,rejected_calls=0,failed_calls=0\r\ncmdstat_expire:calls=3284830546,usec=2776575965,usec_per_call=0.85,rejected_calls=0,failed_calls=0\r\ncmdstat_eval:calls=3,usec=139,usec_per_call=46.33,rejected_calls=0,failed_calls=0\r\ncmdstat_hello:calls=414564,usec=3532850,usec_per_call=8.52,rejected_calls=0,failed_calls=0\r\ncmdstat_hset:calls=504814497,usec=756635259,usec_per_call=1.50,rejected_calls=0,failed_calls=0\r\ncmdstat_get:calls=37734400,usec=19816984,usec_per_call=0.53,rejected_calls=0,failed_calls=0\r\ncmdstat_client|setinfo:calls=74432,usec=8017,usec_per_call=0.11,rejected_calls=0,failed_calls=0\r\ncmdstat_evalsha:calls=4014097266,usec=41303237567,usec_per_call=10.29,rejected_calls=0,failed_calls=3\r\n\r\n# Errorstats\r\nerrorstat_NOSCRIPT:count=3\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_hget:p50=2.007,p99=9.023,p99.9=17.023\r\nlatency_percentiles_usec_ping:p50=1.003,p99=6.015,p99.9=19.071\r\nlatency_percentiles_usec_auth:p50=2.007,p99=12.031,p99.9=28.031\r\nlatency_percentiles_usec_del:p50=1.003,p99=5.023,p99.9=16.063\r\nlatency_percentiles_usec_acl|list:p50=6.015,p99=6.015,p99.9=6.015\r\nlatency_percentiles_usec_acl|save:p50=1769.471,p99=2375.679,p99.9=2375.679\r\nlatency_percentiles_usec_acl|setuser:p50=9.023,p99=58.111,p99.9=58.111\r\nlatency_percentiles_usec_info:p50=208.895,p99=378.879,p99.9=679.935\r\nlatency_percentiles_usec_set:p50=1.003,p99=12.031,p99.9=24.063\r\nlatency_percentiles_usec_latency|latest:p50=1.003,p99=6.015,p99.9=17.023\r\nlatency_percentiles_usec_latency|reset:p50=1.003,p99=7.007,p99.9=18.047\r\nlatency_percentiles_usec_hgetall:p50=1.003,p99=43.007,p99.9=1002438.655\r\nlatency_percentiles_usec_hdel:p50=1.003,p99=9.023,p99.9=13.055\r\nlatency_percentiles_usec_expire:p50=1.003,p99=2.007,p99.9=14.015\r\nlatency_percentiles_usec_eval:p50=29.055,p99=82.431,p99.9=82.431\r\nlatency_percentiles_usec_hello:p50=7.007,p99=26.111,p99.9=40.191\r\nlatency_percentiles_usec_hset:p50=1.003,p99=10.047,p99.9=24.063\r\nlatency_percentiles_usec_get:p50=0.001,p99=2.007,p99.9=17.023\r\nlatency_percentiles_usec_client|setinfo:p50=0.001,p99=1.003,p99.9=1.003\r\nlatency_percentiles_usec_evalsha:p50=9.023,p99=35.071,p99.9=64.255\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=3232782,expires=3232782,avg_ttl=599116703\r\n```\r\n\r\nMEMORY STATS\r\n```\r\n 1) \"peak.allocated\"\r\n 2) (integer) 10576946736\r\n 3) \"total.allocated\"\r\n 4) (integer) 9088233360\r\n 5) \"startup.allocated\"\r\n 6) (integer) 859624\r\n 7) \"replication.backlog\"\r\n 8) (integer) 0\r\n 9) \"clients.slaves\"\r\n10) (integer) 0\r\n11) \"clients.normal\"\r\n12) (integer) 15919144\r\n13) \"cluster.links\"\r\n14) (integer) 0\r\n15) \"aof.buffer\"\r\n16) (integer) 0\r\n17) \"lua.caches\"\r\n18) (integer) 1416\r\n19) \"functions.caches\"\r\n20) (integer) 184\r\n21) \"db.0\"\r\n22) 1) \"overhead.hashtable.main\"\r\n    2) (integer) 263527688\r\n    3) \"overhead.hashtable.expires\"\r\n    4) (integer) 211803704\r\n    5) \"overhead.hashtable.slot-to-keys\"\r\n    6) (integer) 0\r\n23) \"overhead.total\"\r\n24) (integer) 492111760\r\n25) \"keys.count\"\r\n26) (integer) 3232749\r\n27) \"keys.bytes-per-key\"\r\n28) (integer) 2811\r\n29) \"dataset.bytes\"\r\n30) (integer) 8596121600\r\n31) \"dataset.percentage\"\r\n32) \"94.59413146972656\"\r\n33) \"peak.percentage\"\r\n34) \"85.92491912841797\"\r\n35) \"allocator.allocated\"\r\n36) (integer) 9088323640\r\n37) \"allocator.active\"\r\n38) (integer) 12174626816\r\n39) \"allocator.resident\"\r\n40) (integer) 12317818880\r\n41) \"allocator-fragmentation.ratio\"\r\n42) \"1.3395899534225464\"\r\n43) \"allocator-fragmentation.bytes\"\r\n44) (integer) 3086303176\r\n45) \"allocator-rss.ratio\"\r\n46) \"1.0117615461349487\"\r\n47) \"allocator-rss.bytes\"\r\n48) (integer) 143192064\r\n49) \"rss-overhead.ratio\"\r\n50) \"1.0001137256622314\"\r\n51) \"rss-overhead.bytes\"\r\n52) (integer) 1400832\r\n53) \"fragmentation\"\r\n54) \"1.355513095855713\"\r\n55) \"fragmentation.bytes\"\r\n56) (integer) 3230986296\r\n```"
    },
    {
      "id": 2428205778,
      "user": "sundb",
      "created_at": "2024-10-22T04:25:28Z",
      "body": "@RohanNagar  what was the memory footprint before upgration?\r\ncan you give the report from `redis-cli --bigkeys`?"
    },
    {
      "id": 2434329078,
      "user": "RohanNagar",
      "created_at": "2024-10-24T05:24:45Z",
      "body": "Hi @sundb before the upgrade, memory would reach maxmemory and stay there. RSS memory would never climb like this, definitely never climbed much higher than the dataset memory.\r\n\r\nOur keyspace is pretty large so `redis-cli --bigkeys` takes a long time. I will try to run it tomorrow and give the result. Are you thinking some large keys could cause this issue?"
    },
    {
      "id": 2434379786,
      "user": "sundb",
      "created_at": "2024-10-24T06:08:15Z",
      "body": "feel like it doesn't relate to big keys.\r\nIt may be related to the change in the size (224bytes and 320 bytes) of some structures, resulting in a higher fragmentation rate of these two bin.\r\nplease wait for me to take some time to verify these two versions.\r\n\r\n```\r\nbins:           size ind    allocated      nmalloc (#/sec)      ndalloc (#/sec)    nrequests   (#/sec)  nshards      curregs     curslabs  nonfull_slabs regs pgs   util       nfills (#/sec)     nflushes (#/sec)       nslabs     nreslabs (#/sec)      n_lock_ops (#/sec)       n_waiting (#/sec)      n_spin_acq (#/sec)  n_owner_switch (#/sec)   total_wait_ns   (#/sec)     max_wait_ns  max_n_thds\r\n                 224  14    949042304     29418908      40     25182112      34   2048964999      2822        1      4236796        74111          69745  128   7  0.446      2849561       3      1491051       2       110749      8303720      11        53006379      73               0       0               0       0         1408027       1               0         0               0           0\r\n                 320  16    322758720     17105458      23     16096837      22    163920020       225        1      1008621       115337         111938   64   5  0.136      1210962       1      1267071       1       206011      1561018       2        40383046      55               0       0               0       0         1153455       1               0         0               0           0\r\n```"
    },
    {
      "id": 2446074460,
      "user": "RohanNagar",
      "created_at": "2024-10-30T07:37:33Z",
      "body": "Hi @sundb, have you had a chance to take a look at this?"
    },
    {
      "id": 2446079236,
      "user": "sundb",
      "created_at": "2024-10-30T07:41:20Z",
      "body": "@RohanNagar sorry, i'm busy in other place, please give me more time."
    }
  ]
}