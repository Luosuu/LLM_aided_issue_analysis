{
  "issue_number": 12876.0,
  "title": "[BUG] Redis crashing 7.2.2",
  "body": "**Describe the bug**\r\nIt crashes out of nowhere.\r\n**To reproduce**\r\nNo idea, it just does out of nowhere, i really don't know how it happens.\r\nSteps to reproduce the behavior and/or a minimal code sample.\r\n\r\n**Expected behavior**\r\n\r\nA description of what you expected to happen.\r\n\r\n**Additional information**\r\n\r\nAny additional information that is relevant to the problem.\r\n\r\nI have the logs of the crash\r\n\r\n------ FAST MEMORY TEST ------\r\n45622:C 20 Dec 2023 09:07:38.510 # Bio worker thread #0 terminated\r\n77690:M 20 Dec 2023 09:07:38.603 # Background saving terminated by signal 11\r\n77690:M 20 Dec 2023 09:07:44.023 * 1 changes in 3600 seconds. Saving...\r\n77690:M 20 Dec 2023 09:07:44.043 * Background saving started by pid 45710\r\n\r\n\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n45710:C 20 Dec 2023 09:07:44.471 # Redis 7.2.1 crashed by signal: 11, si_code: 128\r\n45710:C 20 Dec 2023 09:07:44.471 # Accessing address: (nil)\r\n45710:C 20 Dec 2023 09:07:44.471 # Crashed running the instruction at: 0x557b62873aaf\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\nredis-rdb-bgsave 0.0.0.0:6379(dictNext+0x8f)[0x557b62873aaf]\r\n\r\nBacktrace:\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x42520)[0x7f3e654c8520]\r\nredis-rdb-bgsave 0.0.0.0:6379(dictNext+0x8f)[0x557b62873aaf]\r\nredis-rdb-bgsave 0.0.0.0:6379(rdbSaveObject+0x5b3)[0x557b628bf393]\r\nredis-rdb-bgsave 0.0.0.0:6379(rdbSaveKeyValuePair+0x8e)[0x557b628bfc9e]\r\nredis-rdb-bgsave 0.0.0.0:6379(rdbSaveDb+0x21a)[0x557b628c005a]\r\nredis-rdb-bgsave 0.0.0.0:6379(rdbSaveRio+0x1f4)[0x557b628c03c4]\r\nredis-rdb-bgsave 0.0.0.0:6379(+0xd54fd)[0x557b628c04fd]\r\nredis-rdb-bgsave 0.0.0.0:6379(rdbSave+0x9e)[0x557b628c0c1e]\r\nredis-rdb-bgsave 0.0.0.0:6379(rdbSaveBackground+0xf8)[0x557b628c0e98]\r\nredis-rdb-bgsave 0.0.0.0:6379(serverCron+0x952)[0x557b6287ae72]\r\nredis-rdb-bgsave 0.0.0.0:6379(aeProcessEvents+0x2a5)[0x557b628779c5]\r\nredis-rdb-bgsave 0.0.0.0:6379(aeMain+0x1d)[0x557b62877bbd]\r\nredis-rdb-bgsave 0.0.0.0:6379(main+0x39b)[0x557b6286debb]\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x29d90)[0x7f3e654afd90]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0x80)[0x7f3e654afe40]\r\nredis-rdb-bgsave 0.0.0.0:6379(_start+0x25)[0x557b6286e555]\r\n\r\n------ REGISTERS ------\r\n45710:C 20 Dec 2023 09:07:44.472 # \r\nRAX:0008000000000000 RBX:00007f3e516557a0\r\nRCX:0000000000000000 RDX:0000000000000000\r\nRDI:00007f3e516557a0 RSI:00007f3e572c9c63\r\nRBP:0000000000000000 RSP:00007ffd1b0f98b0\r\nR8 :00007f3e572c9c87 R9 :00000000000000b0\r\nR10:0000000000000034 R11:00007f3e64c01f40\r\nR12:00007f3e566927a0 R13:000000000002d073\r\nR14:0000557b62a697d8 R15:00007f3e572c9c63\r\nRIP:0000557b62873aaf EFL:0000000000010293\r\nCSGSFS:002b000000000033\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98bf) -> 0000000000000000\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98be) -> 0000000000000000\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98bd) -> 0000000000000000\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98bc) -> 0000000000000000\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98bb) -> 0000000000000000\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98ba) -> 0000000000000000\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98b9) -> 0000000000000000\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98b8) -> 0000000000000000\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98b7) -> 00000000007bf9db\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98b6) -> 0000000000000000\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98b5) -> 0000557b628bf393\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98b4) -> 00007f3e516557a0\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98b3) -> 0000557b62a697b0\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98b2) -> 00007ffd1b0f9d10\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98b1) -> 00000000007bfa00\r\n45710:C 20 Dec 2023 09:07:44.472 # (00007ffd1b0f98b0) -> 00007f3e516557a0\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:7.2.1\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:95712a67f5005c28\r\nredis_mode:standalone\r\nos:Linux 5.15.0-84-generic x86_64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:11.4.0\r\nprocess_id:45710\r\nprocess_supervised:systemd\r\nrun_id:eed7cfd59e7c010b0ace94a744675c5c12bec044\r\ntcp_port:6379\r\nserver_time_usec:1703063264023764\r\nuptime_in_seconds:171793\r\nuptime_in_days:1\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:8564448\r\nexecutable:/usr/bin/redis-server\r\nconfig_file:/etc/redis/redis.conf\r\nio_threads_active:0\r\nlistener0:name=tcp,bind=0.0.0.0,port=6379\r\n\r\n# Clients\r\nconnected_clients:343\r\ncluster_connections:0\r\nmaxclients:65503\r\nclient_recent_max_input_buffer:20480\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\ntotal_blocking_keys:0\r\ntotal_blocking_keys_on_nokey:0\r\n\r\n# Memory\r\nused_memory:281650984\r\nused_memory_human:268.60M\r\nused_memory_rss:406597632\r\nused_memory_rss_human:387.76M\r\nused_memory_peak:13953735392\r\nused_memory_peak_human:13.00G\r\nused_memory_peak_perc:2.02%\r\nused_memory_overhead:5363536\r\nused_memory_startup:4519664\r\nused_memory_dataset:276287448\r\nused_memory_dataset_perc:99.70%\r\nallocator_allocated:281930744\r\nallocator_active:282726400\r\nallocator_resident:407941120\r\ntotal_system_memory:134950866944\r\ntotal_system_memory_human:125.68G\r\nused_memory_lua:31744\r\nused_memory_vm_eval:31744\r\nused_memory_lua_human:31.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:32768\r\nused_memory_vm_total:64512\r\nused_memory_vm_total_human:63.00K\r\nused_memory_functions:184\r\nused_memory_scripts:184\r\nused_memory_scripts_human:184B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.00\r\nallocator_frag_bytes:795656\r\nallocator_rss_ratio:1.44\r\nallocator_rss_bytes:125214720\r\nrss_overhead_ratio:1.00\r\nrss_overhead_bytes:-1343488\r\nmem_fragmentation_ratio:1.44\r\nmem_fragmentation_bytes:124948616\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:841144\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.3.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:12425\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1703047069\r\nrdb_last_bgsave_status:err\r\nrdb_last_bgsave_time_sec:0\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:5120\r\nrdb_last_cow_size:8056832\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:49\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_rewrites_consecutive_failures:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:16765074\r\ntotal_commands_processed:517731645\r\ninstantaneous_ops_per_sec:1919\r\ntotal_net_input_bytes:23914278262\r\ntotal_net_output_bytes:114731546598\r\ntotal_net_repl_input_bytes:0\r\ntotal_net_repl_output_bytes:0\r\ninstantaneous_input_kbps:92.81\r\ninstantaneous_output_kbps:327.62\r\ninstantaneous_input_repl_kbps:0.00\r\ninstantaneous_output_repl_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:1258\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:95596155\r\nkeyspace_misses:57570659\r\npubsub_channels:117\r\npubsub_patterns:0\r\npubsubshard_channels:0\r\nlatest_fork_usec:19803\r\ntotal_forks:5119\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:16444642\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:432160086\r\ntotal_writes_processed:1164103301\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:670415\r\nreply_buffer_expands:344378\r\neventloop_cycles:435162358\r\neventloop_duration_sum:8995321934\r\neventloop_duration_cmd_sum:734420265\r\ninstantaneous_eventloop_cycles_per_sec:3699\r\ninstantaneous_eventloop_duration_usec:12\r\nacl_access_denied_auth:0\r\nacl_access_denied_cmd:0\r\nacl_access_denied_key:0\r\nacl_access_denied_channel:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:8a8a9e95e53156f4d4921e12b0a69a7cf6c150e9\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.044057\r\nused_cpu_user:0.384497\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:0.044057\r\nused_cpu_user_main_thread:0.384497\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_zscore:calls=55839492,usec=12911192,usec_per_call=0.23,rejected_calls=0,failed_calls=0\r\ncmdstat_keys:calls=1,usec=42,usec_per_call=42.00,rejected_calls=1,failed_calls=0\r\ncmdstat_zrevrange:calls=24749,usec=330292,usec_per_call=13.35,rejected_calls=0,failed_calls=0\r\ncmdstat_zrevrank:calls=86317,usec=239768,usec_per_call=2.78,rejected_calls=0,failed_calls=0\r\ncmdstat_bgsave:calls=3,usec=59766,usec_per_call=19922.00,rejected_calls=1,failed_calls=0\r\ncmdstat_publish:calls=39043759,usec=252584750,usec_per_call=6.47,rejected_calls=0,failed_calls=0\r\ncmdstat_hdel:calls=627,usec=4047,usec_per_call=6.45,rejected_calls=0,failed_calls=0\r\ncmdstat_quit:calls=16764165,usec=3421518,usec_per_call=0.20,rejected_calls=0,failed_calls=0\r\ncmdstat_hget:calls=97213214,usec=57990646,usec_per_call=0.60,rejected_calls=0,failed_calls=0\r\ncmdstat_hset:calls=1875269,usec=7223666,usec_per_call=3.85,rejected_calls=0,failed_calls=0\r\ncmdstat_zadd:calls=14571205,usec=51016666,usec_per_call=3.50,rejected_calls=0,failed_calls=0\r\ncmdstat_command:calls=0,usec=0,usec_per_call=0.00,rejected_calls=3,failed_calls=0\r\ncmdstat_command|docs:calls=0,usec=0,usec_per_call=0.00,rejected_calls=3,failed_calls=0\r\ncmdstat_zincrby:calls=36155570,usec=260582242,usec_per_call=7.21,rejected_calls=0,failed_calls=0\r\ncmdstat_client|setname:calls=466283,usec=414531,usec_per_call=0.89,rejected_calls=0,failed_calls=0\r\ncmdstat_lastsave:calls=16,usec=13,usec_per_call=0.81,rejected_calls=0,failed_calls=0\r\ncmdstat_zrange:calls=17,usec=315,usec_per_call=18.53,rejected_calls=0,failed_calls=0\r\ncmdstat_zcount:calls=3025,usec=24591,usec_per_call=8.13,rejected_calls=0,failed_calls=0\r\ncmdstat_info:calls=1,usec=99,usec_per_call=99.00,rejected_calls=4,failed_calls=0\r\ncmdstat_zrem:calls=91987,usec=246057,usec_per_call=2.67,rejected_calls=0,failed_calls=0\r\ncmdstat_auth:calls=16765071,usec=25101634,usec_per_call=1.50,rejected_calls=0,failed_calls=0\r\ncmdstat_subscribe:calls=671,usec=2691,usec_per_call=4.01,rejected_calls=0,failed_calls=0\r\ncmdstat_ping:calls=238830203,usec=62265739,usec_per_call=0.26,rejected_calls=16444629,failed_calls=0\r\n\r\n# Errorstats\r\nerrorstat_ERR:count=2\r\nerrorstat_LOADING:count=621\r\nerrorstat_MISCONF:count=16444008\r\nerrorstat_NOAUTH:count=11\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_zscore:p50=0.001,p99=1.003,p99.9=4.015\r\nlatency_percentiles_usec_keys:p50=42.239,p99=42.239,p99.9=42.239\r\nlatency_percentiles_usec_zrevrange:p50=13.055,p99=34.047,p99.9=63.231\r\nlatency_percentiles_usec_zrevrank:p50=3.007,p99=10.047,p99.9=23.039\r\nlatency_percentiles_usec_bgsave:p50=19529.727,p99=20971.519,p99.9=20971.519\r\nlatency_percentiles_usec_publish:p50=4.015,p99=63.231,p99.9=93.183\r\nlatency_percentiles_usec_hdel:p50=6.015,p99=16.063,p99.9=22.015\r\nlatency_percentiles_usec_quit:p50=0.001,p99=1.003,p99.9=3.007\r\nlatency_percentiles_usec_hget:p50=0.001,p99=3.007,p99.9=11.007\r\nlatency_percentiles_usec_hset:p50=3.007,p99=14.015,p99.9=29.055\r\nlatency_percentiles_usec_zadd:p50=2.007,p99=19.071,p99.9=35.071\r\nlatency_percentiles_usec_zincrby:p50=6.015,p99=22.015,p99.9=40.191\r\nlatency_percentiles_usec_client|setname:p50=1.003,p99=2.007,p99.9=12.031\r\nlatency_percentiles_usec_lastsave:p50=1.003,p99=2.007,p99.9=2.007\r\nlatency_percentiles_usec_zrange:p50=16.063,p99=46.079,p99.9=46.079\r\nlatency_percentiles_usec_zcount:p50=8.031,p99=21.119,p99.9=36.095\r\nlatency_percentiles_usec_info:p50=99.327,p99=99.327,p99.9=99.327\r\nlatency_percentiles_usec_zrem:p50=2.007,p99=8.031,p99.9=22.015\r\nlatency_percentiles_usec_auth:p50=1.003,p99=4.015,p99.9=16.063\r\nlatency_percentiles_usec_subscribe:p50=3.007,p99=17.023,p99.9=42.239\r\nlatency_percentiles_usec_ping:p50=0.001,p99=1.003,p99.9=5.023\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=50,expires=0,avg_ttl=0\r\n",
  "state": "open",
  "created_at": "2023-12-20T17:46:42Z",
  "updated_at": "2023-12-26T16:10:21Z",
  "closed_at": null,
  "labels": [],
  "comments_data": [
    {
      "id": 1866772771,
      "user": "hpatro",
      "created_at": "2023-12-21T18:37:56Z",
      "body": "@PedroMPagani Would it be possible to share the dataset or if it was generated via benchmark tool? From the latency stats, it looks like it has bunch of sorted sets/hash. \r\n\r\nHow frequently does it happen? The crash happens during `bgsave` (snapshot). Not sure, if it happens on each `bgsave` operation."
    },
    {
      "id": 1866779356,
      "user": "PedroMPagani",
      "created_at": "2023-12-21T18:43:58Z",
      "body": "Hey hpatro, it does not happen on every save, my logs have 100s of saves before, my config for save is the default every minute.\r\n\r\nI can share the dataset there's no sensible data on it(there is a small one but its ipv4s of our machines - so if possiblke i'd like to share this privately), yes it's a lot of sorted sets and hashsets, thisi s a minecraft network and its all leaderboards and player skins texture.\r\nwhere should I upload the file, here?\r\n\r\n@hpatro \r\n"
    },
    {
      "id": 1868491126,
      "user": "oranagra",
      "created_at": "2023-12-24T11:08:52Z",
      "body": "@PedroMPagani is there anything in `dmesg` when it happens? (asking because of `si_code: 128`)\r\nhow was redis built? anything that could be unusual?\r\n\r\nsomewhat similar to https://github.com/redis/redis/issues/9551"
    },
    {
      "id": 1868492229,
      "user": "oranagra",
      "created_at": "2023-12-24T11:14:58Z",
      "body": "did you have the `DUMPING CODE AROUND EIP` section in the crash report? can you attach it?"
    },
    {
      "id": 1868504407,
      "user": "PedroMPagani",
      "created_at": "2023-12-24T12:22:35Z",
      "body": "I don't see anything on dmesg on the redis port, is there a way to make it fast reading? what exactly would I be looking for there"
    },
    {
      "id": 1868516562,
      "user": "oranagra",
      "created_at": "2023-12-24T13:24:05Z",
      "body": "i recently saw something like this:\r\n> [901206.570455] traps: redis-server[1203536] general protection fault\r\n\r\nit was due to misaligned memory and MMX instructions."
    },
    {
      "id": 1869618131,
      "user": "MeirShpilraien",
      "created_at": "2023-12-26T15:31:42Z",
      "body": "@oranagra the dmesg will only show this error if you run with `--crash-log-enabled no` option."
    },
    {
      "id": 1869639243,
      "user": "oranagra",
      "created_at": "2023-12-26T16:10:20Z",
      "body": "ohh, right."
    }
  ]
}