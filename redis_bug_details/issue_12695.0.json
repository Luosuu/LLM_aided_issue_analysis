{
  "issue_number": 12695.0,
  "title": "[CRASH] Assertion Failed when running rebalance command when upgrading from 7.0.11 to 7.2.2",
  "body": "\r\n**Crash report**\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n12758:M 27 Oct 2023 04:19:55.632 # === ASSERTION FAILED ===\r\n12758:M 27 Oct 2023 04:19:55.632 # ==> cluster.c:5349 '(n->slot_info_pairs_count + 1) < (2 * n->numslots)' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterReplyShards+0x40)[0x4fe880]\r\n/usr/local/bin/redis-server *:6379 [cluster](call+0x14c)[0x46e3ac]\r\n/usr/local/bin/redis-server *:6379 [cluster](processCommand+0x37c)[0x46ed3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](processInputBuffer+0xdc)[0x48dc3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](readQueryFromClient+0x2e8)[0x48e0e8]\r\n/usr/local/bin/redis-server *:6379 [cluster][0x578388]\r\n/usr/local/bin/redis-server *:6379 [cluster](aeMain+0x108)[0x46528c]\r\n/usr/local/bin/redis-server *:6379 [cluster](main+0x3a0)[0x45a7c0]\r\n/lib64/libc.so.6(+0x35a78)[0xffff97887a78]\r\n/lib64/libc.so.6(__libc_start_main+0x9c)[0xffff97887b5c]\r\n/usr/local/bin/redis-server *:6379 [cluster](_start+0x30)[0x45afb0]\r\n\r\n------ INFO OUTPUT ------\r\n12758:M 27 Oct 2023 04:19:55.633 # === ASSERTION FAILED ===\r\n12758:M 27 Oct 2023 04:19:55.633 # ==> cluster.c:5349 '(n->slot_info_pairs_count + 1) < (2 * n->numslots)' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterReplyShards+0x40)[0x4fe880]\r\n/usr/local/bin/redis-server *:6379 [cluster](call+0x14c)[0x46e3ac]\r\n/usr/local/bin/redis-server *:6379 [cluster](processCommand+0x37c)[0x46ed3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](processInputBuffer+0xdc)[0x48dc3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](readQueryFromClient+0x2e8)[0x48e0e8]\r\n/usr/local/bin/redis-server *:6379 [cluster][0x578388]\r\n/usr/local/bin/redis-server *:6379 [cluster](aeMain+0x108)[0x46528c]\r\n/usr/local/bin/redis-server *:6379 [cluster](main+0x3a0)[0x45a7c0]\r\n/lib64/libc.so.6(+0x35a78)[0xffff97887a78]\r\n/lib64/libc.so.6(__libc_start_main+0x9c)[0xffff97887b5c]\r\n/usr/local/bin/redis-server *:6379 [cluster](_start+0x30)[0x45afb0]\r\n\r\n------ INFO OUTPUT ------\r\n12758:M 27 Oct 2023 04:19:55.634 # === ASSERTION FAILED ===\r\n12758:M 27 Oct 2023 04:19:55.634 # ==> cluster.c:5349 '(n->slot_info_pairs_count + 1) < (2 * n->numslots)' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterReplyShards+0x40)[0x4fe880]\r\n/usr/local/bin/redis-server *:6379 [cluster](call+0x14c)[0x46e3ac]\r\n/usr/local/bin/redis-server *:6379 [cluster](processCommand+0x37c)[0x46ed3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](processInputBuffer+0xdc)[0x48dc3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](readQueryFromClient+0x2e8)[0x48e0e8]\r\n/usr/local/bin/redis-server *:6379 [cluster][0x578388]\r\n/usr/local/bin/redis-server *:6379 [cluster](aeMain+0x108)[0x46528c]\r\n/usr/local/bin/redis-server *:6379 [cluster](main+0x3a0)[0x45a7c0]\r\n/lib64/libc.so.6(+0x35a78)[0xffff97887a78]\r\n/lib64/libc.so.6(__libc_start_main+0x9c)[0xffff97887b5c]\r\n/usr/local/bin/redis-server *:6379 [cluster](_start+0x30)[0x45afb0]\r\n\r\n------ INFO OUTPUT ------\r\n12758:M 27 Oct 2023 04:19:55.635 # === ASSERTION FAILED ===\r\n12758:M 27 Oct 2023 04:19:55.635 # ==> cluster.c:5349 '(n->slot_info_pairs_count + 1) < (2 * n->numslots)' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterReplyShards+0x40)[0x4fe880]\r\n/usr/local/bin/redis-server *:6379 [cluster](call+0x14c)[0x46e3ac]\r\n/usr/local/bin/redis-server *:6379 [cluster](processCommand+0x37c)[0x46ed3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](processInputBuffer+0xdc)[0x48dc3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](readQueryFromClient+0x2e8)[0x48e0e8]\r\n/usr/local/bin/redis-server *:6379 [cluster][0x578388]\r\n/usr/local/bin/redis-server *:6379 [cluster](aeMain+0x108)[0x46528c]\r\n/usr/local/bin/redis-server *:6379 [cluster](main+0x3a0)[0x45a7c0]\r\n/lib64/libc.so.6(+0x35a78)[0xffff97887a78]\r\n/lib64/libc.so.6(__libc_start_main+0x9c)[0xffff97887b5c]\r\n/usr/local/bin/redis-server *:6379 [cluster](_start+0x30)[0x45afb0]\r\n\r\n------ INFO OUTPUT ------\r\n12758:M 27 Oct 2023 04:19:55.636 # === ASSERTION FAILED ===\r\n12758:M 27 Oct 2023 04:19:55.636 # ==> cluster.c:5349 '(n->slot_info_pairs_count + 1) < (2 * n->numslots)' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterReplyShards+0x40)[0x4fe880]\r\n/usr/local/bin/redis-server *:6379 [cluster](call+0x14c)[0x46e3ac]\r\n/usr/local/bin/redis-server *:6379 [cluster](processCommand+0x37c)[0x46ed3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](processInputBuffer+0xdc)[0x48dc3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](readQueryFromClient+0x2e8)[0x48e0e8]\r\n/usr/local/bin/redis-server *:6379 [cluster][0x578388]\r\n/usr/local/bin/redis-server *:6379 [cluster](aeMain+0x108)[0x46528c]\r\n/usr/local/bin/redis-server *:6379 [cluster](main+0x3a0)[0x45a7c0]\r\n/lib64/libc.so.6(+0x35a78)[0xffff97887a78]\r\n/lib64/libc.so.6(__libc_start_main+0x9c)[0xffff97887b5c]\r\n/usr/local/bin/redis-server *:6379 [cluster](_start+0x30)[0x45afb0]\r\n\r\n------ INFO OUTPUT ------\r\n12758:M 27 Oct 2023 04:19:55.637 # === ASSERTION FAILED ===\r\n12758:M 27 Oct 2023 04:19:55.637 # ==> cluster.c:5349 '(n->slot_info_pairs_count + 1) < (2 * n->numslots)' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterReplyShards+0x40)[0x4fe880]\r\n/usr/local/bin/redis-server *:6379 [cluster](call+0x14c)[0x46e3ac]\r\n/usr/local/bin/redis-server *:6379 [cluster](processCommand+0x37c)[0x46ed3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](processInputBuffer+0xdc)[0x48dc3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](readQueryFromClient+0x2e8)[0x48e0e8]\r\n/usr/local/bin/redis-server *:6379 [cluster][0x578388]\r\n/usr/local/bin/redis-server *:6379 [cluster](aeMain+0x108)[0x46528c]\r\n/usr/local/bin/redis-server *:6379 [cluster](main+0x3a0)[0x45a7c0]\r\n/lib64/libc.so.6(+0x35a78)[0xffff97887a78]\r\n/lib64/libc.so.6(__libc_start_main+0x9c)[0xffff97887b5c]\r\n/usr/local/bin/redis-server *:6379 [cluster](_start+0x30)[0x45afb0]\r\n\r\n------ INFO OUTPUT ------\r\n12758:M 27 Oct 2023 04:19:55.639 # === ASSERTION FAILED ===\r\n12758:M 27 Oct 2023 04:19:55.639 # ==> cluster.c:5349 '(n->slot_info_pairs_count + 1) < (2 * n->numslots)' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterReplyShards+0x40)[0x4fe880]\r\n/usr/local/bin/redis-server *:6379 [cluster](call+0x14c)[0x46e3ac]\r\n/usr/local/bin/redis-server *:6379 [cluster](processCommand+0x37c)[0x46ed3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](processInputBuffer+0xdc)[0x48dc3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](readQueryFromClient+0x2e8)[0x48e0e8]\r\n/usr/local/bin/redis-server *:6379 [cluster][0x578388]\r\n/usr/local/bin/redis-server *:6379 [cluster](aeMain+0x108)[0x46528c]\r\n/usr/local/bin/redis-server *:6379 [cluster](main+0x3a0)[0x45a7c0]\r\n/lib64/libc.so.6(+0x35a78)[0xffff97887a78]\r\n/lib64/libc.so.6(__libc_start_main+0x9c)[0xffff97887b5c]\r\n/usr/local/bin/redis-server *:6379 [cluster](_start+0x30)[0x45afb0]\r\n\r\n------ INFO OUTPUT ------\r\n12758:M 27 Oct 2023 04:19:55.640 # === ASSERTION FAILED ===\r\n12758:M 27 Oct 2023 04:19:55.640 # ==> cluster.c:5349 '(n->slot_info_pairs_count + 1) < (2 * n->numslots)' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterReplyShards+0x40)[0x4fe880]\r\n/usr/local/bin/redis-server *:6379 [cluster](call+0x14c)[0x46e3ac]\r\n/usr/local/bin/redis-server *:6379 [cluster](processCommand+0x37c)[0x46ed3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](processInputBuffer+0xdc)[0x48dc3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](readQueryFromClient+0x2e8)[0x48e0e8]\r\n/usr/local/bin/redis-server *:6379 [cluster][0x578388]\r\n/usr/local/bin/redis-server *:6379 [cluster](aeMain+0x108)[0x46528c]\r\n/usr/local/bin/redis-server *:6379 [cluster](main+0x3a0)[0x45a7c0]\r\n/lib64/libc.so.6(+0x35a78)[0xffff97887a78]\r\n/lib64/libc.so.6(__libc_start_main+0x9c)[0xffff97887b5c]\r\n/usr/local/bin/redis-server *:6379 [cluster](_start+0x30)[0x45afb0]\r\n\r\n------ INFO OUTPUT ------\r\n12758:M 27 Oct 2023 04:19:55.642 # === ASSERTION FAILED ===\r\n12758:M 27 Oct 2023 04:19:55.642 # ==> cluster.c:5349 '(n->slot_info_pairs_count + 1) < (2 * n->numslots)' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterReplyShards+0x40)[0x4fe880]\r\n/usr/local/bin/redis-server *:6379 [cluster](call+0x14c)[0x46e3ac]\r\n/usr/local/bin/redis-server *:6379 [cluster](processCommand+0x37c)[0x46ed3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](processInputBuffer+0xdc)[0x48dc3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](readQueryFromClient+0x2e8)[0x48e0e8]\r\n/usr/local/bin/redis-server *:6379 [cluster][0x578388]\r\n/usr/local/bin/redis-server *:6379 [cluster](aeMain+0x108)[0x46528c]\r\n/usr/local/bin/redis-server *:6379 [cluster](main+0x3a0)[0x45a7c0]\r\n/lib64/libc.so.6(+0x35a78)[0xffff97887a78]\r\n/lib64/libc.so.6(__libc_start_main+0x9c)[0xffff97887b5c]\r\n/usr/local/bin/redis-server *:6379 [cluster](_start+0x30)[0x45afb0]\r\n\r\n------ INFO OUTPUT ------\r\n12758:M 27 Oct 2023 04:19:55.644 # === ASSERTION FAILED ===\r\n12758:M 27 Oct 2023 04:19:55.644 # ==> cluster.c:5349 '(n->slot_info_pairs_count + 1) < (2 * n->numslots)' is not true\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterGenNodesDescription+0x58)[0x4fcff8]\r\n/usr/local/bin/redis-server *:6379 [cluster](logServerInfo+0x260)[0x4ea180]\r\n/usr/local/bin/redis-server *:6379 [cluster](printCrashReport+0x18)[0x4ea718]\r\n/usr/local/bin/redis-server *:6379 [cluster](_serverAssert+0x154)[0x4ea954]\r\n/usr/local/bin/redis-server *:6379 [cluster](slowlogInit+0x0)[0x4fcf40]\r\n/usr/local/bin/redis-server *:6379 [cluster](clusterReplyShards+0x40)[0x4fe880]\r\n/usr/local/bin/redis-server *:6379 [cluster](call+0x14c)[0x46e3ac]\r\n/usr/local/bin/redis-server *:6379 [cluster](processCommand+0x37c)[0x46ed3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](processInputBuffer+0xdc)[0x48dc3c]\r\n/usr/local/bin/redis-server *:6379 [cluster](readQueryFromClient+0x2e8)[0x48e0e8]\r\n/usr/local/bin/redis-server *:6379 [cluster][0x578388]\r\n/usr/local/bin/redis-server *:6379 [cluster](aeMain+0x108)[0x46528c]\r\n/usr/local/bin/redis-server *:6379 [cluster](main+0x3a0)[0x45a7c0]\r\n/lib64/libc.so.6(+0x35a78)[0xffff97887a78]\r\n/lib64/libc.so.6(__libc_start_main+0x9c)[0xffff97887b5c]\r\n/usr/local/bin/redis-server *:6379 [cluster](_start+0x30)[0x45afb0]\r\n...\r\n```\r\nAssertion failed error keeps going on for a long time\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version\r\nAmazon Linux 2023, redis-version 7.2.2\r\n3. Steps to reproduce (if any)\r\n -  Running a rebalance command between a cluster with a mixture of 7.0.11 and new 7.2.2 nodes\r\n```\r\nredis-cli --cluster rebalance xxx:6379 --cluster-use-empty-masters --cluster-pipeline 1000 --cluster-weight d9a5864cf277e6f6cb21ea60a3cf0015ddf662a3=0\r\n```\r\nThe rebalance commands get stuck and on investigation, this assertion was found.\r\n",
  "state": "closed",
  "created_at": "2023-10-25T23:03:51Z",
  "updated_at": "2024-01-08T04:54:43Z",
  "closed_at": "2024-01-08T04:54:42Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1817958373,
      "user": "salarali",
      "created_at": "2023-11-19T19:45:04Z",
      "body": "Any updates on this? "
    },
    {
      "id": 1825368905,
      "user": "enjoy-binbin",
      "created_at": "2023-11-24T09:21:12Z",
      "body": "@salarali thanks for the report, i am taking a look. Although it's a bit tortuous, I found a way to reproduce it."
    },
    {
      "id": 1827036077,
      "user": "enjoy-binbin",
      "created_at": "2023-11-27T02:35:20Z",
      "body": "@PingXie since you are here, can you also take a look?\r\n\r\nthis somehow like #12805, if the node is a master, we may need to add it to the shard lins.\r\n```\r\nif (ext_shardid == NULL) clusterAddNodeToShard(sender->shard_id, sender);\r\n```\r\n\r\nthe reason for the issue is, like if we have A (7.2) -> B (7.0), B is A master\r\n\r\nin node A view, A does not know the B's shard id, so in here, we are not able to clear the B's slot_info.\r\n```\r\nvoid addShardReplyForClusterShards(client *c, list *nodes) {\r\n    ...\r\n    addReplyBulkCString(c, \"nodes\");\r\n    addReplyArrayLen(c, listLength(nodes));\r\n    listIter li;\r\n    listRewind(nodes, &li);\r\n    for (listNode *ln = listNext(&li); ln != NULL; ln = listNext(&li)) {\r\n        clusterNode *n = listNodeValue(ln);\r\n        addNodeDetailsToShardReply(c, n);\r\n        clusterFreeNodesSlotsInfo(n);\r\n    }\r\n```\r\n\r\nBut in here, we will keep increasing B's slot info, and eventually encountering the assert:\r\n```\r\nvoid clusterGenNodesSlotsInfo(int filter) {\r\n    ...\r\n        /* Generate slots info when occur different node with start\r\n         * or end of slot. */\r\n        if (i == CLUSTER_SLOTS || n != server.cluster->slots[i]) {\r\n            if (!(n->flags & filter)) {\r\n                if (!n->slot_info_pairs) {\r\n                    n->slot_info_pairs = zmalloc(2 * n->numslots * sizeof(uint16_t));\r\n                }\r\n                serverAssert((n->slot_info_pairs_count + 1) < (2 * n->numslots));\r\n                n->slot_info_pairs[n->slot_info_pairs_count++] = start;\r\n                n->slot_info_pairs[n->slot_info_pairs_count++] = i-1;\r\n            }\r\n            if (i == CLUSTER_SLOTS) break;\r\n            n = server.cluster->slots[i];\r\n            start = i;\r\n        }\r\n}\r\n```"
    },
    {
      "id": 1827085730,
      "user": "PingXie",
      "created_at": "2023-11-27T03:52:00Z",
      "body": "@enjoy-binbin, it looks like your fix for #12805 might resolve this issue too. With that fix in place, every 7.2 node (like `A` in your example) should keep its shard view consistent. And if there's another replica in the mix, like `A'`, in the same shard as `A` and `B`, it'll follow the same shard structure, though with a different ID. That's totally fine for a setup with different versions running. From what we talked about in #12805, once everyone's on 7.2, we should see the shard structures and IDs line up. That's when the shard IDs will really start to make sense.\r\n\r\nBtw, is re-sharding required to trigger this bug? Generally, I'd lean towards updating all nodes to the same version before doing something as involved as re-sharding. Most folks update the whole cluster first, which is a good call – it keeps things straightforward and avoids the quirks you might run into with a mixed-version setup."
    },
    {
      "id": 1827087912,
      "user": "enjoy-binbin",
      "created_at": "2023-11-27T03:55:46Z",
      "body": "the fix in #12805 won't help, since we will first check whether sender's shard_id has changed, if it changed, we will add it to the shard list. and in this case, if the sender is a master, we won't change the shard_id, so we are not able to add it the the shard lins"
    },
    {
      "id": 1827103708,
      "user": "PingXie",
      "created_at": "2023-11-27T04:22:08Z",
      "body": ">in node A view, A does not know the B's shard id, so in here, we are not able to clear the B's slot_info.\r\n\r\nWhen a 7.2 node `A` replicates from a 7.0 (primary) node `B`, `A` should inherit `B`'s shard id, even it is randomly generated on node `A`. With the fix for #12805, I'd assume node `B`'s shard ID remain stable on node `A` hence these two will remain in the same shard. So the statement above is not my understanding.\r\n\r\nWhat are the repro steps? Or is it possible for you to share the core dump somehow? It is a bit hard to be certain just by looking at the source code.\r\n\r\n"
    },
    {
      "id": 1827126738,
      "user": "enjoy-binbin",
      "created_at": "2023-11-27T04:58:50Z",
      "body": "my reproduce step:\r\n```\r\nstep A:\r\n7.0 cluster\r\n./utils/create-cluster/create-cluster stop && ./utils/create-cluster/create-cluster clean\r\n./utils/create-cluster/create-cluster start && ./utils/create-cluster/create-cluster create\r\n\r\nstep B:\r\n7.2 node\r\nrm -rf nodes.conf && ./src/redis-server redis.conf --cluster-enabled yes --port 7000\r\n\r\nstep C:\r\n./src/redis-cli -p 30001 cluster meet 127.0.0.1 7000\r\n./src/redis-cli --cluster rebalance 127.0.0.1:30001 --cluster-use-empty-masters --cluster-pipeline 1000 --cluster-weight d1a8056b89c9790a6ad836320e7c6f7dfc9fd282=0\r\n\r\nstep D:\r\n./src/redis-cli -p 7000 cluster shards\r\n```\r\n\r\nI should be doing the C and D step repeatedly, and CLUSTER SHARDS will response with this (we can see the slots section keeps expanding):\r\n```\r\n1) 1) \"slots\"            \r\n   2)  1) (integer) 0       \r\n       2) (integer) 5461\r\n       3) (integer) 0                                  \r\n       4) (integer) 5461\r\n       5) (integer) 0       \r\n       6) (integer) 5461\r\n       7) (integer) 0   \r\n       8) (integer) 5461         \r\n       9) (integer) 0       \r\n      10) (integer) 5461\r\n      11) (integer) 0 \r\n      12) (integer) 5461         \r\n   3) \"nodes\"               \r\n   4) 1)  1) \"id\"    \r\n          2) \"a447baa52a5d5564fbf27974e93e4f0825746d00\"\r\n          3) \"port\"                                    \r\n          4) (integer) 30004\r\n          5) \"ip\"          \r\n          6) \"127.0.0.1\"\r\n          7) \"endpoint\"                                \r\n          8) \"127.0.0.1\"\r\n          9) \"role\"        \r\n         10) \"replica\"\r\n         11) \"replication-offset\"\r\n         12) (integer) 13566     \r\n         13) \"health\"     \r\n         14) \"online\"\r\n```\r\n\r\nThe steps to reproduce are quite messy. I upgraded randomly locally.\r\n\r\nyean, with the fix for #12805, there shard id will remain in the same shard. However, the shard id of a certain master has not been added to the shardi d list. Maybe there is something missing somewhere.\r\n```c\r\n# the code in here will check memcmp, and since the sender' shard id is not changed, \r\n# so we won't add it to the shard id list\r\nstatic void updateShardId(clusterNode *node, const char *shard_id) {\r\n    if (shard_id && memcmp(node->shard_id, shard_id, CLUSTER_NAMELEN) != 0) {\r\n        clusterRemoveNodeFromShard(node);\r\n        memcpy(node->shard_id, shard_id, CLUSTER_NAMELEN);\r\n        clusterAddNodeToShard(shard_id, node);\r\n        clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG);\r\n    }\r\n    if (shard_id && myself != node && myself->slaveof == node) {\r\n        if (memcmp(myself->shard_id, shard_id, CLUSTER_NAMELEN) != 0) {\r\n            /* shard-id can diverge right after a rolling upgrade\r\n             * from pre-7.2 releases */\r\n            clusterRemoveNodeFromShard(myself);\r\n            memcpy(myself->shard_id, shard_id, CLUSTER_NAMELEN);\r\n            clusterAddNodeToShard(shard_id, myself);\r\n            clusterDoBeforeSleep(CLUSTER_TODO_SAVE_CONFIG|CLUSTER_TODO_FSYNC_CONFIG);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nThat’s why I plan to add this:\r\n```c\r\nif (ext_shardid == NULL and is_master) clusterAddNodeToShard(sender->shard_id, sender);\r\n```\r\n\r\nSo the essential reason is that in the shard id list, that is, server.cluster->shards, #12805 will only add the replica, but not the master, causing this problem"
    },
    {
      "id": 1827190565,
      "user": "PingXie",
      "created_at": "2023-11-27T06:22:19Z",
      "body": "Got it, this sounds more like a case where a 7.2 node is just observing a 7.0 shard, not actually replicating from it. Makes me wonder if we even need to go through re-sharding to reproduce this bug?\r\n\r\n>with the fix for https://github.com/redis/redis/pull/12805, there shard id will remain in the same shard. However, the shard id of a certain master has not been added to the shardi d list. Maybe there is something missing somewhere.\r\n\r\nDid you get a chance to try this out with your latest changes in #12805? The earlier commits had this issue, but I thought your last update would've fixed it for both v7.0 primary and replica nodes.\r\n"
    },
    {
      "id": 1827203487,
      "user": "enjoy-binbin",
      "created_at": "2023-11-27T06:33:36Z",
      "body": "> Makes me wonder if we even need to go through re-sharding to reproduce this bug?\r\n\r\nI feel it's not needed, i just follow the issue idea, and then i got an env that could be reproduced stably and didn't want to break it.\r\n\r\n> Did you get a chance to try this out with your latest changes in https://github.com/redis/redis/pull/12805? The earlier commits had this issue, but I thought your last update would've fixed it for both v7.0 primary and replica nodes.\r\n\r\ni did try it (even earlier), it don't work. the new commit indeed will call `updateShardId`, but the `memcmp` check will prevent us add it to the shard id list."
    },
    {
      "id": 1827240102,
      "user": "PingXie",
      "created_at": "2023-11-27T07:06:47Z",
      "body": "You are right. Now I see two potential issues with `updateShardId` \r\n\r\n1. Guarding the shard dictionary update on the shard id change. These should've been two orthogonal decisions.\r\n2. The duplication of the shard dictionary update logic for both the incoming node `n` and `myself`\r\n\r\nDo you like to propose a change?"
    },
    {
      "id": 1827256710,
      "user": "enjoy-binbin",
      "created_at": "2023-11-27T07:19:18Z",
      "body": "i am happy to make the change and test it, but a little confused. Do you have any ideas, or can you elaborate a bit more?"
    },
    {
      "id": 1831207684,
      "user": "PingXie",
      "created_at": "2023-11-29T04:43:06Z",
      "body": "Thinking about this more, a better and (more) correct fix would to update the shard topology when a 7.0 replica is connected to its 7.0 primary for the very first time. More specifically, we need to inject a `updateShardId(sender, master->shard_id)` call on [cluster_legacy.c:2947](https://github.com/redis/redis/blob/unstable/src/cluster_legacy.c#L2946). This should fix the issue."
    },
    {
      "id": 1831410106,
      "user": "enjoy-binbin",
      "created_at": "2023-11-29T08:11:47Z",
      "body": "> we need to inject a updateShardId(sender, master->shard_id) call\r\n\r\nI tried it, it didn't work.\r\n\r\nLuckily I found the minimal steps to reproduce:\r\n```\r\n# 7.0 cluster\r\n./utils/create-cluster/create-cluster stop && ./utils/create-cluster/create-cluster clean\r\n./utils/create-cluster/create-cluster start && ./utils/create-cluster/create-cluster create\r\n\r\n# 7.2 node\r\nrm -rf nodes.conf && ./src/redis-server redis.conf --cluster-enabled yes --port 6379\r\n\r\n# 7.2 node replicate with a 7.0 node\r\n./src/redis-cli -p 30001 cluster meet 127.0.0.1 6379\r\n./src/redis-cli -p 6379 cluster replicate d808332a59dc44d4cf8cd0f54c2ea18e34ded7fa\r\n./src/redis-cli -p 6379 cluster shards && ./src/redis-cli -p 6379 cluster shards\r\n```\r\n\r\nso the reason is that a 7.2 node is a 7.0 node 's slave, the shard id dict does not have the 7.0 node, so when we issue cluster shards in 7.2 node, it went here: https://github.com/redis/redis/issues/12695#issuecomment-1827036077"
    },
    {
      "id": 1838052199,
      "user": "PingXie",
      "created_at": "2023-12-04T08:24:55Z",
      "body": ">so the reason is that a 7.2 node is a 7.0 node 's slave, the shard id dict does not have the 7.0 node, so when we issue cluster shards in 7.2 node, it went here: https://github.com/redis/redis/issues/12695#issuecomment-1827036077\r\n\r\nThis looks like a different issue than observed in your previous https://github.com/redis/redis/issues/12695#issuecomment-1827036077. I think we should still keep the change I proposed in https://github.com/redis/redis/issues/12695#issuecomment-1831207684.\r\n\r\nWe could continue with the fix proposed in https://github.com/redis/redis/issues/12695#issuecomment-1827240102 but an alternative could be fixing the underlying assumption of `updateShardId`, which is that the shard dict should be always in sync with the node's shard_id. In this sense, I wonder if we should consider a fix of calling `clusterAddNodeToShard` at https://github.com/redis/redis/blob/unstable/src/cluster_legacy.c#L2161 and https://github.com/redis/redis/blob/unstable/src/cluster_legacy.c#L1615, when the node in question is a primary and if its shard_id is not in the shard dict yet."
    },
    {
      "id": 1838062607,
      "user": "enjoy-binbin",
      "created_at": "2023-12-04T08:32:02Z",
      "body": ">  I wonder if we should consider a fix of calling clusterAddNodeToShard at https://github.com/redis/redis/blob/unstable/src/cluster_legacy.c#L2161 and https://github.com/redis/redis/blob/unstable/src/cluster_legacy.c#L1615, when the node in question is a primary and if its shard_id is not in the shard dict yet.\r\n\r\nWow, that's actually what I thought at first, shard dict should be always in sync with the node's shard_id. The first time I tried it, it didn't fix the issue, so I dropped it and considered fixing it with a smaller diff.\r\n\r\nI actually agree with this idea. We didn’t add shard dict synchronously in some places, which feels like a hidden danger.\r\n\r\nI will try to open a new PR later to add all these changes we mentioned (for better review)"
    },
    {
      "id": 1840218160,
      "user": "enjoy-binbin",
      "created_at": "2023-12-05T08:09:36Z",
      "body": "@PingXie thanks! I verified that adding it to clusterRenameNode can fix this issue https://github.com/redis/redis/issues/12695#issuecomment-1831410106. please take a look with the fix #12832. "
    }
  ]
}