{
  "issue_number": 10836.0,
  "title": "[CRASH] Custom module works in debug but not release mode",
  "body": "**Crash report**\r\n\r\nA module is involved, but it's my own doing.  Version of Redis is 7.0, and I've tried both a local install and the Docker image with the same result.  Basically, I have a need to have `boost::geometry` server-side on Redis, and I've been using C++14.  When I run in release mode using CLion, the seg faults happen in my first pic below, and the second pic is the call stack.  If I need to, I can share very similar code.\r\n\r\nI've verified with `cout` statements that all of my save commands go through okay in release mode, so this is happening with something after that when Redis wraps up the save.  When I run it with Valgrind with the module built in release mode, it saves the RDB just fine (sample output after crash report), and compiling with `-Wall` doesn't show anything too frightening.  I am just dipping my toes back into C/C++, so I am very confused.\r\n\r\n![image](https://user-images.githubusercontent.com/21989132/172703678-438df187-f879-495d-87df-5f839b37d580.png)\r\n![image](https://user-images.githubusercontent.com/21989132/172703791-8c626a61-fe1d-439c-9508-e762073b6b0a.png)\r\n\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n29912:M 08 Jun 2022 19:40:39.338 # Redis 7.0.0 crashed by signal: 11, si_code: 2\r\n29912:M 08 Jun 2022 19:40:39.338 # Accessing address: 0x7ffcb19a9a70\r\n29912:M 08 Jun 2022 19:40:39.338 # Crashed running the instruction at: 0x7ffcb19a9a70\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n[0x7ffcb19a9a70]\r\n\r\nBacktrace:\r\n/usr/lib64/libpthread.so.0(+0x118e0)[0x7f7fd75678e0]\r\n[0x7ffcb19a9a70]\r\n\r\n------ REGISTERS ------\r\n29912:M 08 Jun 2022 19:40:39.338 # \r\nRAX:0000000000000001 RBX:00007ffcb19a8840\r\nRCX:0000000000000002 RDX:0000000000000001\r\nRDI:00007ffcb19a8720 RSI:0000000000000002\r\nRBP:00007f7fd6c3a1e0 RSP:00007ffcb19a8708\r\nR8 :00000000025bf500 R9 :00007ffcb19a86f0\r\nR10:0000000000000030 R11:0000000000000003\r\nR12:0000000000000002 R13:00007f7fd6c271a0\r\nR14:0000000000000000 R15:0000000000000000\r\nRIP:00007ffcb19a9a70 EFL:0000000000010206\r\nCSGSFS:002b000000000033\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a8717) -> 7ffffffeb19a8800\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a8716) -> 00000000004d2b4b\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a8715) -> 00007ffcb19a8840\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a8714) -> 0000000000000000\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a8713) -> 0000000000000002\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a8712) -> 0000000000444ad3\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a8711) -> 00007f7fffffffff\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a8710) -> 0000000000000000\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a870f) -> 0000000000000000\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a870e) -> 0000000000000000\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a870d) -> 00007f7fd6c3a1e0\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a870c) -> 00007ffcb19a8840\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a870b) -> 000000000000000c\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a870a) -> f7007f7fd6cd0000\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a8709) -> 00007ffcb19a8840\r\n29912:M 08 Jun 2022 19:40:39.338 # (00007ffcb19a8708) -> 000000000047824d\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:7.0.0\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:fb73256ddd51d273\r\nredis_mode:standalone\r\nos:Linux 4.14.256-197.484.amzn2.x86_64 x86_64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:7.3.1\r\nprocess_id:29912\r\nprocess_supervised:no\r\nrun_id:fe1d4eb1301d9c15df4f95f9863c58cf939506c9\r\ntcp_port:6379\r\nserver_time_usec:1654717238612018\r\nuptime_in_seconds:10\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:10550070\r\nexecutable:/tmp/tmp.ZNd7dv6XXd/redis-server\r\nconfig_file:/tmp/tmp.ZNd7dv6XXd/redis.conf\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:1\r\ncluster_connections:0\r\nmaxclients:4064\r\nclient_recent_max_input_buffer:8\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:485603856\r\nused_memory_human:463.11M\r\nused_memory_rss:592535552\r\nused_memory_rss_human:565.09M\r\nused_memory_peak:485603856\r\nused_memory_peak_human:463.11M\r\nused_memory_peak_perc:100.00%\r\nused_memory_overhead:608920\r\nused_memory_startup:608624\r\nused_memory_dataset:484994936\r\nused_memory_dataset_perc:100.00%\r\nallocator_allocated:485636544\r\nallocator_active:502837248\r\nallocator_resident:653000704\r\ntotal_system_memory:73756090368\r\ntotal_system_memory_human:68.69G\r\nused_memory_lua:31744\r\nused_memory_vm_eval:31744\r\nused_memory_lua_human:31.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:32768\r\nused_memory_vm_total:64512\r\nused_memory_vm_total_human:63.00K\r\nused_memory_functions:184\r\nused_memory_scripts:184\r\nused_memory_scripts_human:184B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.04\r\nallocator_frag_bytes:17200704\r\nallocator_rss_ratio:1.30\r\nallocator_rss_bytes:150163456\r\nrss_overhead_ratio:0.91\r\nrss_overhead_bytes:-60465152\r\nmem_fragmentation_ratio:1.22\r\nmem_fragmentation_bytes:106958296\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:0\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.2.1\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1654717228\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_rewrites_consecutive_failures:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:9\r\ntotal_commands_processed:8\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:738\r\ntotal_net_output_bytes:14275\r\ninstantaneous_input_kbps:0.01\r\ninstantaneous_output_kbps:0.15\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:17\r\ntotal_writes_processed:8\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:0\r\nreply_buffer_expands:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:c337ecfac082e7734ffe4557fc9944a85036d526\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.617492\r\nused_cpu_user:8.918874\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:0.419496\r\nused_cpu_user_main_thread:4.422677\r\n\r\n# Modules\r\nmodule:name=RedisVect,ver=1,api=1,filters=0,usedby=[],using=[],options=[]\r\n\r\n# Commandstats\r\ncmdstat_CoreZones.print:calls=1,usec=472,usec_per_call=472.00,rejected_calls=0,failed_calls=0\r\ncmdstat_RedisVect.setcorebndpoly:calls=1,usec=3,usec_per_call=3.00,rejected_calls=0,failed_calls=0\r\ncmdstat_RedisVect.fromcsv:calls=1,usec=4047177,usec_per_call=4047177.00,rejected_calls=0,failed_calls=0\r\ncmdstat_RedisVect.addchannel:calls=3,usec=78065,usec_per_call=26021.67,rejected_calls=0,failed_calls=0\r\ncmdstat_RedisVect.setchanpolys:calls=1,usec=2698088,usec_per_call=2698088.00,rejected_calls=0,failed_calls=0\r\ncmdstat_RedisVect.setchanbndpoly:calls=1,usec=17,usec_per_call=17.00,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_CoreZones.print:p50=473.087,p99=473.087,p99.9=473.087\r\nlatency_percentiles_usec_RedisVect.setcorebndpoly:p50=3.007,p99=3.007,p99.9=3.007\r\nlatency_percentiles_usec_RedisVect.fromcsv:p50=1002438.655,p99=1002438.655,p99.9=1002438.655\r\nlatency_percentiles_usec_RedisVect.addchannel:p50=15400.959,p99=54001.663,p99.9=54001.663\r\nlatency_percentiles_usec_RedisVect.setchanpolys:p50=1002438.655,p99=1002438.655,p99.9=1002438.655\r\nlatency_percentiles_usec_RedisVect.setchanbndpoly:p50=17.023,p99=17.023,p99.9=17.023\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=2,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=12 addr=127.0.0.1:53872 laddr=127.0.0.1:6379 fd=8 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=14 qbuf-free=20460 argv-mem=4 multi-mem=0 rbs=16384 rbp=16384 obl=0 oll=0 omem=0 tot-mem=37644 events=r cmd=save user=default redir=-1 resp=2\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=12 addr=127.0.0.1:53872 laddr=127.0.0.1:6379 fd=8 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=14 qbuf-free=20460 argv-mem=4 multi-mem=0 rbs=16384 rbp=16384 obl=0 oll=0 omem=0 tot-mem=37644 events=r cmd=save user=default redir=-1 resp=2\r\nargv[0]: '\"save\"'\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nsanitize-dump-payload no\r\nio-threads 1\r\nlazyfree-lazy-server-del no\r\nrepl-diskless-sync yes\r\nrepl-diskless-load disabled\r\nlazyfree-lazy-eviction no\r\nslave-read-only yes\r\nreplica-read-only yes\r\nlazyfree-lazy-user-flush no\r\nlazyfree-lazy-user-del no\r\nclient-query-buffer-limit 1gb\r\nlazyfree-lazy-expire no\r\nlist-compress-depth 0\r\nproto-max-bulk-len 512mb\r\nactivedefrag no\r\nio-threads-do-reads no\r\n\r\n------ FAST MEMORY TEST ------\r\n29912:M 08 Jun 2022 19:40:39.338 # Bio thread for job type #0 terminated\r\n29912:M 08 Jun 2022 19:40:39.338 # Bio thread for job type #1 terminated\r\n29912:M 08 Jun 2022 19:40:39.339 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 86f000 (2297856 bytes)\r\n*** Preparing to test memory region 25bc000 (3760128 bytes)\r\n*** Preparing to test memory region 7f7effc00000 (138547200 bytes)\r\n*** Preparing to test memory region 7f7f0c600000 (60952576 bytes)\r\n*** Preparing to test memory region 7f7f14000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f18000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f1c000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f20000000 (37781504 bytes)\r\n*** Preparing to test memory region 7f7f244fe000 (15728640 bytes)\r\n*** Preparing to test memory region 7f7f265ff000 (18874368 bytes)\r\n*** Preparing to test memory region 7f7f28000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f2c000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f30000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f34000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f38000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f3c000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f40000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f441f9000 (6291456 bytes)\r\n*** Preparing to test memory region 7f7f457fc000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7f463ff000 (18874368 bytes)\r\n*** Preparing to test memory region 7f7f47600000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7f47e00000 (58744832 bytes)\r\n*** Preparing to test memory region 7f7f4c000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f50000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f54000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f58000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f5c000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f60000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f64000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f68000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f6c000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f70000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f74000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f78000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f7c000000 (67244032 bytes)\r\n*** Preparing to test memory region 7f7f84080000 (66719744 bytes)\r\n*** Preparing to test memory region 7f7f8c000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f90000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f94000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f98000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7f9c000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7fa0000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7fa4000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7fa8000000 (135168 bytes)\r\n*** Preparing to test memory region 7f7fac07f000 (5767168 bytes)\r\n*** Preparing to test memory region 7f7fac600000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7face00000 (12582912 bytes)\r\n*** Preparing to test memory region 7f7fadb00000 (508559360 bytes)\r\n*** Preparing to test memory region 7f7fcc07f000 (12058624 bytes)\r\n*** Preparing to test memory region 7f7fccc00000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7fcd400000 (6291456 bytes)\r\n*** Preparing to test memory region 7f7fcdbac000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7fce3ad000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7fcebae000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7fcf942000 (16384 bytes)\r\n*** Preparing to test memory region 7f7fcfc30000 (4096 bytes)\r\n*** Preparing to test memory region 7f7fd6800000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7fd7552000 (16384 bytes)\r\n*** Preparing to test memory region 7f7fd7770000 (16384 bytes)\r\n*** Preparing to test memory region 7f7fd80db000 (32768 bytes)\r\n*** Preparing to test memory region 7f7fd80e5000 (4096 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS is Amazon Linux 2\r\n2. I can't share the code at this point, but I could work up an equivalent example if needed\r\n3. Example chunk of Valgrind output below\r\n\r\n```\r\n==17404== Conditional jump or move depends on uninitialised value(s)\r\n==17404==    at 0x4D2B3F: rdbSaveModulesAux (module.c:6659)\r\n==17404==    by 0x47877B: rdbSaveRio (rdb.c:1347)\r\n==17404==    by 0x47B1A2: rdbSave (rdb.c:1421)\r\n==17404==    by 0x47D099: saveCommand (rdb.c:3481)\r\n==17404==    by 0x449A1E: call (server.c:3265)\r\n==17404==    by 0x44C6AA: processCommand (server.c:3906)\r\n==17404==    by 0x46017B: processCommandAndResetClient (networking.c:2438)\r\n==17404==    by 0x462799: processInputBuffer (networking.c:2542)\r\n==17404==    by 0x465720: readQueryFromClient (networking.c:2673)\r\n==17404==    by 0x4F4F74: callHandler (connhelpers.h:79)\r\n==17404==    by 0x4F4F74: connSocketEventHandler (connection.c:310)\r\n==17404==    by 0x44257C: aeProcessEvents (ae.c:436)\r\n==17404==    by 0x4428F7: aeMain (ae.c:496)\r\n```\r\n",
  "state": "closed",
  "created_at": "2022-06-08T20:11:48Z",
  "updated_at": "2022-06-08T21:08:43Z",
  "closed_at": "2022-06-08T21:08:43Z",
  "labels": [],
  "comments_data": [
    {
      "id": 1150417388,
      "user": "herter4171",
      "created_at": "2022-06-08T21:08:43Z",
      "body": "Figured it out.  In my use of `RedisModule_CreateDataType`, I had a non-pointer `RedisModuleTypeMethods` passed in via `&`, so apparently it was going away."
    }
  ]
}