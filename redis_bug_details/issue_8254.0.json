{
  "issue_number": 8254.0,
  "title": "[CRASH]5.0.4 crashed in slotToKeyUpdateKey",
  "body": "```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n33532:M 28 Dec 2020 07:13:15.502 # Redis 5.0.4 crashed by signal: 7\r\n33532:M 28 Dec 2020 07:13:15.502 # Crashed running the instruction at: 0x4a8e10\r\n33532:M 28 Dec 2020 07:13:15.502 # Accessing address: 0x7f97e9eb56c0\r\n33532:M 28 Dec 2020 07:13:15.502 # Failed assertion: <no assertion failed> (<no file>:0)\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\nredis-server 192.168.0.69:6379 [cluster](raxRemove+0x1b0)[0x4a8e10]\r\n\r\nBacktrace:\r\nredis-server 192.168.0.69:6379 [cluster](logStackTrace+0x45)[0x473a85]\r\nredis-server 192.168.0.69:6379 [cluster](sigsegvHandler+0xb9)[0x474249]\r\n/lib/x86_64-linux-gnu/libpthread.so.0(+0x11390)[0x7f97f2e4e390]\r\nredis-server 192.168.0.69:6379 [cluster](raxRemove+0x1b0)[0x4a8e10]\r\nredis-server 192.168.0.69:6379 [cluster](slotToKeyUpdateKey+0x1ad)[0x44721d]\r\nredis-server 192.168.0.69:6379 [cluster](dbSyncDelete+0x52)[0x447352]\r\nredis-server 192.168.0.69:6379 [cluster][0x4a3dd5]\r\nredis-server 192.168.0.69:6379 [cluster](activeExpireCycle+0x182)[0x4a3f82]\r\nredis-server 192.168.0.69:6379 [cluster](databasesCron+0x11f)[0x42e26f]\r\nredis-server 192.168.0.69:6379 [cluster](serverCron+0x220)[0x430da0]\r\nredis-server 192.168.0.69:6379 [cluster](aeProcessEvents+0x3f5)[0x429a85]\r\nredis-server 192.168.0.69:6379 [cluster](aeMain+0x2b)[0x429c2b]\r\nredis-server 192.168.0.69:6379 [cluster](main+0x4ae)[0x4267de]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7f97f2a93840]\r\nredis-server 192.168.0.69:6379 [cluster](_start+0x29)[0x426a49]\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:5.0.4\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:b249ac8b3c7d8c7\r\nredis_mode:cluster\r\nos:Linux 4.15.0-45-generic x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:atomic-builtin\r\ngcc_version:5.4.0\r\nprocess_id:33532\r\nrun_id:c0892389162372d75467e97aadabb0c3a5d8b5ac\r\ntcp_port:6379\r\nuptime_in_seconds:4719686\r\nuptime_in_days:54\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:15275275\r\nexecutable:/etc/redis/redis-server\r\nconfig_file:/etc/redis/redis.conf\r\n\r\n# Clients\r\nconnected_clients:261\r\nclient_recent_max_input_buffer:229698\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\n\r\n# Memory\r\nused_memory:598769312\r\nused_memory_human:571.03M\r\nused_memory_rss:745025536\r\nused_memory_rss_human:710.51M\r\nused_memory_peak:2161489632\r\nused_memory_peak_human:2.01G\r\nused_memory_peak_perc:27.70%\r\nused_memory_overhead:104165628\r\nused_memory_startup:1449400\r\nused_memory_dataset:494603684\r\nused_memory_dataset_perc:82.80%\r\nallocator_allocated:598927512\r\nallocator_active:722550784\r\nallocator_resident:755195904\r\ntotal_system_memory:135092023296\r\ntotal_system_memory_human:125.81G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:17179869184\r\nmaxmemory_human:16.00G\r\nmaxmemory_policy:volatile-lru\r\nallocator_frag_ratio:1.21\r\nallocator_frag_bytes:123623272\r\nallocator_rss_ratio:1.05\r\nallocator_rss_bytes:32645120\r\nrss_overhead_ratio:0.99\r\nrss_overhead_bytes:-10170368\r\nmem_fragmentation_ratio:1.24\r\nmem_fragmentation_bytes:146216256\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:1048576\r\nmem_clients_slaves:16922\r\nmem_clients_normal:4711882\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.1.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nrdb_changes_since_last_save:248829920\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1604391134\r\n\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:0\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:262144\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:259619\r\ntotal_commands_processed:926619730\r\ninstantaneous_ops_per_sec:146\r\ntotal_net_input_bytes:456115770367\r\ntotal_net_output_bytes:698497281880\r\ninstantaneous_input_kbps:158.15\r\ninstantaneous_output_kbps:159.41\r\nrejected_connections:0\r\nsync_full:1\r\nsync_partial_ok:0\r\nsync_partial_err:1\r\nexpired_keys:138294263\r\nexpired_stale_perc:9.22\r\nexpired_time_cap_reached_count:0\r\nevicted_keys:0\r\nkeyspace_hits:83856971\r\nkeyspace_misses:109228285\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:329\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:1\r\n\r\nslave0:ip=192.168.0.70,port=6379,state=online,offset=444416674721,lag=1\r\nmaster_replid:7fbc2da68c9faa16528eb7cb1052cec71cb7236e\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:444416676995\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:1\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:444415628420\r\nrepl_backlog_histlen:1048576\r\n\r\n# CPU\r\nused_cpu_sys:51288.945064\r\nused_cpu_user:29942.506431\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.001241\r\n\r\n# Commandstats\r\ncmdstat_hincrby:calls=1,usec=18,usec_per_call=18.00\r\ncmdstat_client:calls=256313,usec=837615,usec_per_call=3.27\r\ncmdstat_expire:calls=37444892,usec=156970893,usec_per_call=4.19\r\ncmdstat_command:calls=8,usec=13859,usec_per_call=1732.38\r\ncmdstat_zadd:calls=6512481,usec=149226268,usec_per_call=22.91\r\ncmdstat_psync:calls=1,usec=498,usec_per_call=498.00\r\ncmdstat_incrby:calls=2624993,usec=38098547,usec_per_call=14.51\r\ncmdstat_cluster:calls=256325,usec=25347999,usec_per_call=98.89\r\ncmdstat_exists:calls=55947,usec=492528,usec_per_call=8.80\r\ncmdstat_zcard:calls=1336777,usec=6722317,usec_per_call=5.03\r\ncmdstat_config:calls=256313,usec=31873755,usec_per_call=124.35\r\ncmdstat_del:calls=8392415,usec=120397738,usec_per_call=14.35\r\ncmdstat_replconf:calls=4709551,usec=9815185,usec_per_call=2.08\r\ncmdstat_hset:calls=19093079,usec=124741104,usec_per_call=6.53\r\ncmdstat_zrange:calls=1359335,usec=15413299,usec_per_call=11.34\r\ncmdstat_slowlog:calls=512626,usec=3954641,usec_per_call=7.71\r\ncmdstat_zincrby:calls=1053855,usec=34504902,usec_per_call=32.74\r\ncmdstat_scard:calls=1239165,usec=12351916,usec_per_call=9.97\r\ncmdstat_ping:calls=460018225,usec=379073594,usec_per_call=0.82\r\ncmdstat_ttl:calls=7762409,usec=31571712,usec_per_call=4.07\r\ncmdstat_zscore:calls=1280761,usec=25218768,usec_per_call=19.69\r\ncmdstat_set:calls=12828905,usec=216990817,usec_per_call=16.91\r\ncmdstat_setnx:calls=28624066,usec=987638197,usec_per_call=34.50\r\ncmdstat_get:calls=173243714,usec=3919323560,usec_per_call=22.62\r\ncmdstat_latency:calls=256313,usec=767788,usec_per_call=3.00\r\ncmdstat_zrem:calls=6377452,usec=39555158,usec_per_call=6.20\r\ncmdstat_smembers:calls=418914,usec=4219592,usec_per_call=10.07\r\ncmdstat_zrevrange:calls=3872823,usec=66207603,usec_per_call=17.10\r\ncmdstat_info:calls=256315,usec=87730378,usec_per_call=342.28\r\n\r\ncmdstat_hget:calls=2068787,usec=19933919,usec_per_call=9.64\r\ncmdstat_zrangebyscore:calls=446624,usec=14094285,usec_per_call=31.56\r\ncmdstat_sadd:calls=23796558,usec=306493027,usec_per_call=12.88\r\ncmdstat_setex:calls=120263787,usec=3214369553,usec_per_call=26.73\r\n\r\n# Cluster\r\ncluster_enabled:1\r\n\r\n# Keyspace\r\ndb0:keys=1474942,expires=532306,avg_ttl=133850645\r\n\r\n------ REGISTERS ------\r\n33532:M 28 Dec 2020 07:13:15.505 #\r\nRAX:0000000000000004 RBX:0000000000000008\r\nRCX:00007f97e6abcb48 RDX:0000000000000000\r\nRDI:000000000000005f RSI:0000000000000007\r\nRBP:00007f97e6abcb44 RSP:00007ffc18350800\r\nR8 :000000000000004f R9 :0000000000000030\r\nR10:0000000000000006 R11:0000000000000002\r\nR12:00007ffc183509a0 R13:000000000000001d\r\nR14:00007f97e9eb56c0 R15:0000000000000016\r\nRIP:00000000004a8e10 EFL:0000000000010246\r\nCSGSFS:002b000000000033\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc1835080f) -> d380cd9daf7c1300\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc1835080e) -> 0000000000000000\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc1835080d) -> 00007f97e6abcb40\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc1835080c) -> 00007f97e0c3a540\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc1835080b) -> 00007f97d4bcab20\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc1835080a) -> 00007f96f9029b10\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc18350809) -> 00007f97e73bb040\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc18350808) -> 00007f97ee57a200\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc18350807) -> 00007f97efd16000\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc18350806) -> 0000000000000020\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc18350805) -> 0000000000000007\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc18350804) -> 00007ffc18350838\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc18350803) -> 0000000000000000\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc18350802) -> 00007f97f26285d0\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc18350801) -> 00007f97f26285d0\r\n33532:M 28 Dec 2020 07:13:15.505 # (00007ffc18350800) -> 00007ffc18350838\r\n\r\n------ FAST MEMORY TEST ------\r\n33532:M 28 Dec 2020 07:13:15.506 # Bio thread for job type #0 terminated\r\n33532:M 28 Dec 2020 07:13:15.506 # Bio thread for job type #1 terminated\r\n33532:M 28 Dec 2020 07:13:15.506 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 7ad000 (2248704 bytes)\r\n*** Preparing to test memory region 2090000 (135168 bytes)\r\n*** Preparing to test memory region 7f964fa00000 (6926893056 bytes)\r\n*** Preparing to test memory region 7f97ec872000 (63963136 bytes)\r\n*** Preparing to test memory region 7f97f0573000 (8388608 bytes)\r\n*** Preparing to test memory region 7f97f0d74000 (8388608 bytes)\r\n*** Preparing to test memory region 7f97f1575000 (8388608 bytes)\r\n*** Preparing to test memory region 7f97f2200000 (8388608 bytes)\r\n*** Preparing to test memory region 7f97f2e39000 (16384 bytes)\r\n*** Preparing to test memory region 7f97f3056000 (16384 bytes)\r\n*** Preparing to test memory region 7f97f396f000 (24576 bytes)\r\n\r\n```",
  "state": "open",
  "created_at": "2020-12-28T02:09:23Z",
  "updated_at": "2020-12-28T08:22:46Z",
  "closed_at": null,
  "labels": [],
  "comments_data": [
    {
      "id": 751628731,
      "user": "oranagra",
      "created_at": "2020-12-28T08:21:52Z",
      "body": "This looks a bit similar to: #7719 #7356, #5693, #4220, which we where unable to locate and resolve so far.\r\n@hnotyet any chance you are able to reproduce it?"
    }
  ]
}