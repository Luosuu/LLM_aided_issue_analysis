{
  "issue_number": 12010.0,
  "title": "[BUG] Identified a bug in rewrite loadmodule",
  "body": "Hi @soloestoy!\r\n \r\nI maintain a `secondary.conf`configuration file for loadmodule and other configurations and include them it in the `primary.conf` file which I use to start the redis-server (**Redis version=7.0.10**).\r\n\r\nThe primary.conf and secondary.conf look like this,\r\n### **primary.conf**\r\n```\r\n...\r\ninclude /home/vikram/redis7/secondary.conf\r\n...\r\n```\r\n### **secondary.conf**\r\n```\r\n...\r\nloadmodule /home/vikram/redis7/aclcheck.so\r\n...\r\n```\r\n1. I did not encounter any errors when I first started the redis-server with`primary.conf`.\r\n\r\n`redis7>./redis-server ./primary.conf`\r\n\r\n```\r\n10755:C 04 Apr 2023 15:16:09.690 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\r\n10755:C 04 Apr 2023 15:16:09.690 # Redis version=7.0.10, bits=64, commit=00000000, modified=0, pid=10755, just started\r\n10755:C 04 Apr 2023 15:16:09.690 # Configuration loaded\r\n10755:M 04 Apr 2023 15:16:09.692 * monotonic clock: POSIX clock_gettime\r\n10755:M 04 Apr 2023 15:16:09.693 # Server initialized\r\n10755:M 04 Apr 2023 15:16:09.694 * Module 'aclcheck' loaded from /home/vikram/redis7/aclcheck.so\r\n10755:M 04 Apr 2023 15:16:09.695 * Ready to accept connections\r\n```\r\n2. Then after executing `CONFIG REWRITE` , the `primary.conf` file was appended with 'loadmodule /home/vikram/redis7/aclcheck.so' as said in #4848.\r\n\r\n`redis7>./redis-cli CONFIG REWRITE`\r\n\r\n### **primary.conf** file after `CONFIG REWRITE`\r\n```\r\ninclude /home/vikram/redis7/secondary.conf\r\n\r\n# Generated by CONFIG REWRITE\r\n...\r\nloadmodule /home/vikram/redis7/aclcheck.so\r\n...\r\n```\r\n\r\n3. Now on redis-server restart, I am facing the below error because during startup there are two loadmodule directives for the same module, one from `secondary.conf` and one from `primary.conf`.\r\n```\r\nredis7> ./redis-server ./primary.conf\r\n\r\n11671:C 04 Apr 2023 15:17:37.469 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\r\n11671:C 04 Apr 2023 15:17:37.469 # Redis version=7.0.10, bits=64, commit=00000000, modified=0, pid=11671, just started\r\n11671:C 04 Apr 2023 15:17:37.469 # Configuration loaded\r\n11671:M 04 Apr 2023 15:17:37.470 * monotonic clock: POSIX clock_gettime\r\n11671:M 04 Apr 2023 15:17:37.472 # Server initialized\r\n11671:M 04 Apr 2023 15:17:37.473 * Module 'aclcheck' loaded from /home/vikram/redis7/aclcheck.so\r\n11671:M 04 Apr 2023 15:17:37.473 # Module /home/vikram/redis7/aclcheck.so initialization failed. Module not loaded\r\n11671:M 04 Apr 2023 15:17:37.473 # Can't load module from /home/vikram/redis7/aclcheck.so: server aborting\r\n```\r\n\r\n_Originally posted by @vikram-krishna-s in https://github.com/redis/redis/issues/4848#issuecomment-1495673440_\r\n            ",
  "state": "open",
  "created_at": "2023-04-07T06:38:18Z",
  "updated_at": "2023-05-18T06:51:36Z",
  "closed_at": null,
  "labels": [],
  "comments_data": [
    {
      "id": 1501308896,
      "user": "soloestoy",
      "created_at": "2023-04-10T02:16:41Z",
      "body": "interesting, we didn't consider the `include` file when `CONFIG REWRITE`, so the configs in `include` may be wrong after rewrite, and the `loadmodule` is the very special one.\r\n\r\nSeems we need exclude configs in `include` file when rewriting, thinking."
    },
    {
      "id": 1501577238,
      "user": "enjoy-binbin",
      "created_at": "2023-04-10T09:00:55Z",
      "body": "a link that I feel is related to recently #11736"
    },
    {
      "id": 1552570669,
      "user": "oranagra",
      "created_at": "2023-05-18T06:51:36Z",
      "body": "> Seems we need exclude configs in include file when rewriting, thinking.\r\n\r\n@soloestoy can you elaborate?\r\n\r\njust keep a flag for each config that was loaded from included file, and avoid writing it to the main one on a rewrite?\r\nnote that configs can be repeated (exist in both, one overrides the other), and some directives like modules and acl, can be repeated without overriding each other.\r\nso this trivial approach will solve some cases, where it's a clear cut where the configs are, but not others.\r\n\r\ni imagine that properly solving the problem and allowing these two features to be mixed is too complicated and we should just either disallow that, or advise against it.\r\nbut i'm obviously open for suggestions.."
    }
  ]
}