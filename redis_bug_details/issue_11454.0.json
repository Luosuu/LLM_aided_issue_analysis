{
  "issue_number": 11454.0,
  "title": "[CRASH] AQ redis-qa cache failure [CRITICAL]",
  "body": "**Crash report**\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n19798:M 31 Oct 2022 09:19:29.013 # ------------------------------------------------\r\n19798:M 31 Oct 2022 09:19:29.013 # !!! Software Failure. Press left mouse button to continue\r\n19798:M 31 Oct 2022 09:19:29.013 # Guru Meditation: Duplicated key found in RDB file #rdb.c:2289\r\n19798:M 31 Oct 2022 09:19:29.013 # (forcing SIGSEGV in order to print the stack trace)\r\n19798:M 31 Oct 2022 09:19:29.013 # ------------------------------------------------\r\n19798:M 31 Oct 2022 09:19:29.013 # Redis 6.0.5 crashed by signal: 11\r\n19798:M 31 Oct 2022 09:19:29.013 # Crashed running the instruction at: 0x473b67\r\n19798:M 31 Oct 2022 09:19:29.013 # Accessing address: 0xffffffffffffffff\r\n19798:M 31 Oct 2022 09:19:29.013 # Failed assertion: <no assertion failed> (<no file>:0)\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n/gns/area/certified/external/redis/io/redisbinary/redis-bin-6.0.5-6.0.5/redis-bin-6.0.5/redis-6.0.5/redis-server 0.0.0.0:6380(_serverPanic+0x117)[0x473b67]\r\n\r\nBacktrace:\r\n/gns/area/certified/external/redis/io/redisbinary/redis-bin-6.0.5-6.0.5/redis-bin-6.0.5/redis-6.0.5/redis-server 0.0.0.0:6380(logStackTrace+0x29)[0x475bc9]\r\n/gns/area/certified/external/redis/io/redisbinary/redis-bin-6.0.5-6.0.5/redis-bin-6.0.5/redis-6.0.5/redis-server 0.0.0.0:6380(sigsegvHandler+0xa6)[0x476266]\r\n/lib64/libpthread.so.0(+0xf630)[0x7f7e28155630]\r\n/gns/area/certified/external/redis/io/redisbinary/redis-bin-6.0.5-6.0.5/redis-bin-6.0.5/redis-6.0.5/redis-server 0.0.0.0:6380(_serverPanic+0x117)[0x473b67]\r\n/gns/area/certified/external/redis/io/redisbinary/redis-bin-6.0.5-6.0.5/redis-bin-6.0.5/redis-6.0.5/redis-server 0.0.0.0:6380(rdbLoadRio+0xb20)[0x45a860]\r\n/gns/area/certified/external/redis/io/redisbinary/redis-bin-6.0.5-6.0.5/redis-bin-6.0.5/redis-6.0.5/redis-server 0.0.0.0:6380(rdbLoad+0x4c)[0x45a91c]\r\n/gns/area/certified/external/redis/io/redisbinary/redis-bin-6.0.5-6.0.5/redis-bin-6.0.5/redis-6.0.5/redis-server 0.0.0.0:6380(loadDataFromDisk+0x91)[0x439061]\r\n/gns/area/certified/external/redis/io/redisbinary/redis-bin-6.0.5-6.0.5/redis-bin-6.0.5/redis-6.0.5/redis-server 0.0.0.0:6380(main+0x429)[0x42c1d9]\r\n/lib64/libc.so.6(__libc_start_main+0xf5)[0x7f7e27d9a555]\r\n/gns/area/certified/external/redis/io/redisbinary/redis-bin-6.0.5-6.0.5/redis-bin-6.0.5/redis-6.0.5/redis-server 0.0.0.0:6380[0x42c4fd]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:6.0.5\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:465a69a185d30a05\r\nredis_mode:standalone\r\nos:Linux 3.10.0-1160.76.1.el7.x86_64 x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\natomicvar_api:atomic-builtin\r\ngcc_version:4.9.1\r\nprocess_id:19798\r\nrun_id:3d6fa1b3d5cda2789dcbeb52eb9462881cb7b21e\r\ntcp_port:6380\r\nuptime_in_seconds:6\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:6263578\r\nexecutable:/gns/area/certified/external/redis/io/redisbinary/redis-bin-6.0.5-6.0.5/redis-bin-6.0.5/redis-6.0.5/redis-server\r\nconfig_file:\r\n\r\n# Clients\r\nconnected_clients:0\r\nclient_recent_max_input_buffer:0\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:3301747056\r\nused_memory_human:3.07G\r\nused_memory_rss:0\r\nused_memory_rss_human:0B\r\nused_memory_peak:3310134000\r\nused_memory_peak_human:3.08G\r\nused_memory_peak_perc:99.75%\r\nused_memory_overhead:817120\r\nused_memory_startup:804912\r\nused_memory_dataset:3300929936\r\nused_memory_dataset_perc:100.00%\r\nallocator_allocated:0\r\nallocator_active:0\r\nallocator_resident:0\r\ntotal_system_memory:50477309952\r\ntotal_system_memory_human:47.01G\r\nused_memory_lua:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts:0\r\nused_memory_scripts_human:0B\r\nnumber_of_cached_scripts:0\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:-nan\r\nallocator_frag_bytes:0\r\nallocator_rss_ratio:-nan\r\nallocator_rss_bytes:0\r\nrss_overhead_ratio:-nan\r\nrss_overhead_bytes:0\r\nmem_fragmentation_ratio:-nan\r\nmem_fragmentation_bytes:0\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.1.0\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\n\r\n# Persistence\r\nloading:1\r\nrdb_changes_since_last_save:0\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1667207962\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_last_cow_size:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\nloading_start_time:1667207962\r\nloading_total_bytes:1380282883\r\nloading_loaded_bytes:1004713772\r\nloading_loaded_perc:72.79\r\nloading_eta_seconds:2\r\n\r\n# Stats\r\ntotal_connections_received:1\r\ntotal_commands_processed:0\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:0\r\ntotal_net_output_bytes:0\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_replid:77d1aac0b57519ff7f1d265fdd323f73308aa3c9\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:1.996870\r\nused_cpu_user:5.036283\r\nused_cpu_sys_children:0.084851\r\nused_cpu_user_children:0.043630\r\n\r\n# Modules\r\n\r\n# Commandstats\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=202,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\n\r\n------ REGISTERS ------\r\n19798:M 31 Oct 2022 09:19:29.014 # \r\nRAX:0000000000000000 RBX:000000000055b969\r\nRCX:ffffffffffffffff RDX:0000000000000000\r\nRDI:0000000000000000 RSI:00007f7e28141a00\r\nRBP:00000000000008f1 RSP:00007ffd1c672230\r\nR8 :00007f7e29339080 R9 :00007f7e27dc52cd\r\nR10:2d2d2d2d2d2d2d2d R11:0000000000000000\r\nR12:ffffffffffffffff R13:00007f7e262098c3\r\nR14:00007f7e2624d8b0 R15:00007f7e26306000\r\nRIP:0000000000473b67 EFL:0000000000010202\r\nCSGSFS:ffff000000000033\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c67223f) -> 00000000004494fd\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c67223e) -> 0000000000000000\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c67223d) -> 00007ffd1c6728f0\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c67223c) -> 00007ffd1c6722e4\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c67223b) -> 000000000043cab6\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c67223a) -> 00007f7e2624d8b0\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c672239) -> 0000000000000000\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c672238) -> 0000000000000000\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c672237) -> 656c696620424452\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c672236) -> 206e6920646e756f\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c672235) -> 662079656b206465\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c672234) -> 746163696c707544\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c672233) -> 00007ffd1c672350\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c672232) -> 00007ffd1c672420\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c672231) -> 0000003000000018\r\n19798:M 31 Oct 2022 09:19:29.014 # (00007ffd1c672230) -> 00007ffd1c6728f0\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ FAST MEMORY TEST ------\r\n19798:M 31 Oct 2022 09:19:29.014 # Bio thread for job type #0 terminated\r\n19798:M 31 Oct 2022 09:19:29.014 # Bio thread for job type #1 terminated\r\n19798:M 31 Oct 2022 09:19:29.014 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 5cc000 (2277376 bytes)\r\n*** Preparing to test memory region 1066000 (270336 bytes)\r\n*** Preparing to test memory region 7f7d33000000 (3437232128 bytes)\r\n*** Preparing to test memory region 7f7dffe7c000 (603455488 bytes)\r\n*** Preparing to test memory region 7f7e23dfd000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7e245fe000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7e24dff000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7e25600000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7e25e00000 (8388608 bytes)\r\n*** Preparing to test memory region 7f7e26bc5000 (8192 bytes)\r\n*** Preparing to test memory region 7f7e26ddf000 (8192 bytes)\r\n*** Preparing to test memory region 7f7e28141000 (20480 bytes)\r\n*** Preparing to test memory region 7f7e2835e000 (16384 bytes)\r\n*** Preparing to test memory region 7f7e287c1000 (16384 bytes)\r\n*** Preparing to test memory region 7f7e29337000 (45056 bytes)\r\n*** Preparing to test memory region 7f7e29361000 (20480 bytes)\r\n*** Preparing to test memory region 7f7e29368000 (4096 bytes)\r\n.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: _serverPanic (base: 0x473a50)\r\nModule: /gns/area/certified/external/redis/io/redisbinary/redis-bin-6.0.5-6.0.5/redis-bin-6.0.5/redis-6.0.5/redis-server 0.0.0.0:6380 (base 0x400000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x473a50 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n19798:M 31 Oct 2022 09:19:41.751 # dump of function (hexdump of 407 bytes):\r\n555389f54889fb4881ecd801000084c048898c24380100004c898424400100004c898c244801000074400f298424500100000f298c24600100000f299424700100000f299c24800100000f29a424900100000f29ac24a00100000f29b424b00100000f29bc24c0010000488d8424f0010000488d4c2408488d7c2420be000100004889442410488d842420010000c744240818000000c744240c300000004889442418e8a870fbff8b05562c380085c07505e839f6ffffbe90e85600bf0300000031c0e8b8f4fbffbec8e85600bf0300000031c0e8a7f4fbff488d5424204189e84889d9bed5d05500bf0300000031c0e88bf4fbffbe08e95600bf0300000031c0e87af4fbffbe90e85600bf0300000031c0e869f4fbffc60425ffffffff784881c4d80100005b5dc30f1f800000000041574156415541544989f455534889d34889fdba040000004889df4881ece80200000fb6014989cd488d74241483e00f0fc889442414e8a5f6ffff4889ef4c89e6e8aa96fdff410fb655004889c589d083e00f0f84c70000003c010f843f0200003c020f849702\r\nFunction at 0x432fd0 is serverLog\r\nFunction at 0x473260 is mixDigest\r\nFunction at 0x44d270 is getExpire\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n```\r\n",
  "state": "open",
  "created_at": "2022-10-31T09:36:25Z",
  "updated_at": "2022-11-02T17:29:07Z",
  "closed_at": null,
  "labels": [],
  "comments_data": [
    {
      "id": 1297905374,
      "user": "CharlesChen888",
      "created_at": "2022-11-01T01:46:07Z",
      "body": "Looks like you have duplicated key in RDB file."
    },
    {
      "id": 1300686716,
      "user": "oranagra",
      "created_at": "2022-11-02T15:30:58Z",
      "body": "how was that RDB produced? same redis version just doing a restart?"
    },
    {
      "id": 1300953061,
      "user": "josidd",
      "created_at": "2022-11-02T17:16:48Z",
      "body": "Yes it was the same version of Redis (6.0.5) doing a restart "
    },
    {
      "id": 1300964290,
      "user": "oranagra",
      "created_at": "2022-11-02T17:21:29Z",
      "body": "well, i'm clueless. without being able to reproduce it (know the sequence of commands that caused it) not sure we can do much.\r\nmaybe somehow the file on the disk got corrupted.\r\nmaybe if you'll analyze that rdb file with some tool (e.g. redis-rdb-tools) you'll find the name and type of that duplicate key and this could be a hint leading us to some realization."
    },
    {
      "id": 1300972315,
      "user": "josidd",
      "created_at": "2022-11-02T17:25:02Z",
      "body": "It found an empty '' duplicate key in the rdb file\r\n\r\n```\r\n27565:C 31 Oct 2022 18:18:50.795 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\r\n27565:C 31 Oct 2022 18:18:50.795 # Redis version=6.0.5, bits=64, commit=00000000, modified=0, pid=27565, just started\r\n27565:C 31 Oct 2022 18:18:50.795 # Configuration loaded\r\n27565:M 31 Oct 2022 18:18:50.796 * Increased maximum number of open files to 10032 (it was originally set to 1024).\r\n27565:M 31 Oct 2022 18:18:50.797 * Running mode=standalone, port=6380.\r\n27565:M 31 Oct 2022 18:18:50.797 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.\r\n27565:M 31 Oct 2022 18:18:50.797 # Server initialized\r\n27565:M 31 Oct 2022 18:18:50.797 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.\r\n27565:M 31 Oct 2022 18:18:50.798 * Loading RDB produced by version 6.0.5\r\n27565:M 31 Oct 2022 18:18:50.798 * RDB age 257423 seconds\r\n27565:M 31 Oct 2022 18:18:50.798 * RDB memory usage when created 4319.92 Mb\r\n27565:M 31 Oct 2022 18:18:56.863 # RDB has duplicated key '' in DB 0\r\n```"
    },
    {
      "id": 1300981992,
      "user": "oranagra",
      "created_at": "2022-11-02T17:29:07Z",
      "body": "does your application create such keys? do you have any clue what type it is and what it contains?\r\nagain maybe redis-rdb-tools or alike can help here."
    }
  ]
}