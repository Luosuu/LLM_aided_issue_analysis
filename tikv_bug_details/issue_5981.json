{
  "issue_number": 5981,
  "title": "May meet panic when processing merge with leader changed",
  "body": "```\r\n[2019/11/20 08:27:55.718 +00:00] [INFO] [raft.rs:723] [\"[region 194622] 194623 became follower at term 7\"]\r\n[2019/11/20 08:27:55.766 +00:00] [INFO] [raft.rs:793] [\"[region 194618] 194619 became leader at term 7\"]\r\n[2019/11/20 08:27:55.766 +00:00] [INFO] [apply.rs:1781] [\"asking delegate to stop\"] [source_region_id=\r\n194618] [peer_id=194623] [region_id=194622]\r\n[2019/11/20 08:27:55.767 +00:00] [INFO] [peer.rs:1926] [\"no need to catch up logs\"] [peer_id=194619] [\r\nregion_id=194618]\r\n[2019/11/20 08:27:55.767 +00:00] [INFO] [apply.rs:1037] [\"execute admin command\"] [command=\"cmd_type:\r\nPrepareMerge prepare_merge { min_index: 7 target { id: 194622 start_key: 7480000000000000FF375F7280000\r\n00000FF0735AA0000000000FA end_key: 7480000000000000FF375F728000000000FF11F4880000000000FA region_epoch\r\n { conf_ver: 226 version: 3558 } peers { id: 194623 store_id: 2573 } peers { id: 194624 store_id: 5 }\r\npeers { id: 194625 store_id: 4 } } }\"] [index=7] [term=6] [peer_id=194619] [region_id=194618]\r\n[2019/11/20 08:27:55.767 +00:00] [INFO] [apply.rs:2423] [\"remove delegate from apply delegates\"] [peer_id=194619] [region_id=194618]\r\n[2019/11/20 08:27:55.767 +00:00] [INFO] [router.rs:446] [\"[region 194618] shutdown mailbox\"]\r\n[2019/11/20 08:27:55.767 +00:00] [INFO] [apply.rs:2537] [\"source logs are all applied now\"] [peer_id=194619] [region_id=194618]\r\n[2019/11/20 08:27:55.767 +00:00] [INFO] [apply.rs:1802] [\"execute CommitMerge\"] [source_region=\"id: 194618 start_key: 7480000000000000FF375F728000000000FF021B710000000000FA end_key: 7480000000000000FF375F728000000000FF0735AA0000000000FA region_epoch { conf_ver: 227 version: 3557 } peers { id: 194619 store_id: 2573 } peers { id: 194620 store_id: 5 } peers { id: 194621 store_id: 4 }\"] [index=9] [term=7] [entries=1] [commit=7] [peer_id=194623] [region_id=194622]\r\n[2019/11/20 08:27:55.767 +00:00] [INFO] [apply.rs:2486] [\"all pending logs are applied\"] [peer_id=194623] [region_id=194622]\r\n[2019/11/20 08:27:55.768 +00:00] [INFO] [peer.rs:1817] [\"failed to schedule merge, rollback\"] [err=\"\\\"[src/raftstore/store/fsm/peer.rs:1670]: target region changed id: 194622 start_key: 7480000000000000FF375F728000000000FF0735AA0000000000FA end_key: 7480000000000000FF375F728000000000FF11F4880000000000FA region_epoch { conf_ver: 226 version: 3558 } peers { id: 194623 store_id: 2573 } peers { id: 194624 store_id: 5 } peers { id: 194625 store_id: 4 } -> id: 194622 start_key: 7480000000000000FF375F728000000000FF021B710000000000FA end_key: 7480000000000000FF375F728000000000FF11F4880000000000FA region_epoch { conf_ver: 226 version: 3559 } peers { id: 194623 store_id: 2573 } peers { id: 194624 store_id: 5 } peers { id: 194625 store_id: 4 }\\\"\"] [peer_id=194619] [region_id=194618]\r\n\r\n[2019/11/20 08:27:56.176 +00:00] [FATAL] [lib.rs:499] [\"called `Option::unwrap()` on a `None` value\"]\r\n[backtrace=\"stack backtrace:\\n   0:     0x55651bc73f1d - backtrace::backtrace::libunwind::trace::h122d\r\n66dac2be4a06\\n                        at /rust/registry/src/github.com-1ecc6299db9ec823/backtrace-0.2.\r\n3/src/backtrace/libunwind.rs:54\\n                         - backtrace::backtrace::trace::he4cfcde9cffe\r\na318\\n                        at /rust/registry/src/github.com-1ecc6299db9ec823/backtrace-0.2.3/src/ba\r\ncktrace/mod.rs:70\\n   1:     0x55651bc68530 - tikv_util::set_panic_hook::{{closure}}::hf7713bf9280c815\r\n1\\n                        at /home/jenkins/.target/release/build/backtrace-e20a32a05fd0b8fe/out/captu\r\nre.rs:79\\n   2:     0x55651be0f8ef - std::panicking::rust_panic_with_hook::h8d2408723e9a2bd4\\n\r\n                at src/libstd/panicking.rs:479\\n   3:     0x55651be0f6cd - std::panicking::continue_pa\r\nnic_fmt::hb2aaa9386c4e5e80\\n                        at src/libstd/panicking.rs:382\\n   4:     0x55651b\r\ne1ee35 - rust_begin_unwind\\n                        at src/libstd/panicking.rs:309\\n   5:     0x55651b\r\ne299db - core::panicking::panic_fmt::h79e840586f23493b\\n                        at src/libcore/panicki\r\nng.rs:85\\n   6:     0x55651be2b1da - core::panicking::panic::h8bb9a06d7b2ed3d1\\n\r\n  at src/libcore/panicking.rs:49\\n   7:     0x55651b33c48b - tikv::raftstore::store::fsm::peer::PeerFs\r\nmDelegate<T,C>::on_apply_res::h074ecda5164b66d4\\n                        at src/raftstore/store/fsm/pe\r\ner.rs:0\\n   8:     0x55651b33d59b - tikv::raftstore::store::fsm::peer::PeerFsmDelegate<T,C>::handle_ms\r\ngs::hac1b2c314294e92f\\n                        at src/raftstore/store/fsm/peer.rs:298\\n   9:     0x556\r\n51b32fe4d - <tikv::raftstore::store::fsm::store::RaftPoller<T,C> as tikv::raftstore::store::fsm::batch\r\n::PollHandler<tikv::raftstore::store::fsm::peer::PeerFsm,tikv::raftstore::store::fsm::store::StoreFsm>\r\n>::handle_normal::h605f4aab414ed9d6\\n                        at src/raftstore/store/fsm/store.rs:645\\n                         - tikv::raftstore::store::fsm::batch::Poller<N,C,Handler>::poll::ha04d23ea304cc900\\n                        at src/raftstore/store/fsm/batch.rs:338\\n                         - tikv::raftstore::store::fsm::batch::BatchSystem<N,C>::spawn::{{closure}}::h14aad1b554086b39\\n                        at src/raftstore/store/fsm/batch.rs:409\\n                         - std::sys_common::backtrace::__rust_begin_short_backtrace::ha92645fe57e23690\\n                        at /rustc/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src/libstd/sys_common/backtrace.rs:77\\n  10:     0x55651b32e701 - std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}::h692a056199e7c1c6\\n                        at /rustc/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src/libstd/thread/mod.rs:470\\n                         - <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once::hb07374a75f87cf80\\n                        at /rustc/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src/libstd/panic.rs:309\\n                         - std::panicking::try::do_call::hb53bf923f28b7ed0\\n                        at /rustc/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src/libstd/panicking.rs:294\\n                         - std::panicking::try::h33b86de5b0e12f20\\n                        at /rustc/0e4a56b4b04ea98bb16caada30cb2418dd06e250//src/libpanic_abort/lib.rs:29\\n                         - std::panic::catch_unwind::h239dc9f0a10cb4e4\\n                        at /rustc/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src/libstd/panic.rs:388\\n                         - std::thread::Builder::spawn_unchecked::{{closure}}::h67d23195f413a410\\n                        at /rustc/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src/libstd/thread/mod.rs:469\\n                         - core::ops::function::FnOnce::call_once{{vtable.shim}}::h6e0bab430e326d51\\n                        at /rustc/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src/libcore/ops/function.rs:231\\n  11:     0x55651be1de3e - <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once::he71721d2d956d451\\n                        at /rustc/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src/liballoc/boxed.rs:746\\n  12:     0x55651be2016b - <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once::he520045b8d28ce5c\\n                        at /rustc/0e4a56b4b04ea98bb16caada30cb2418dd06e250/src/liballoc/boxed.rs:746\\n                         - std::sys_common::thread::start_thread::h2e98d1272dc6d74b\\n                        at src/libstd/sys_common/thread.rs:13\\n                         - std::sys::unix::thread::Thread::new::thread_start::h18485805666ccd3c\\n                        at src/libstd/sys/unix/thread.rs:79\\n  13:     0x7f4ce0681d2b - <unknown>\\n  14:     0x7f4cdfd95e3e - __clone\\n  15:                0x0 - <unknown>\"] [location=src/libcore/option.rs:347] [thread_name=raftstore-2573-0]\r\n```\r\n\r\nseems the stack is a little incomplete, I suspect the panic happens here https://github.com/tikv/tikv/blob/master/src/raftstore/store/fsm/peer.rs#L1832\r\n\r\n",
  "state": "closed",
  "created_at": "2019-11-20T10:20:56Z",
  "updated_at": "2020-07-20T06:46:03Z",
  "closed_at": "2020-07-20T06:46:03Z",
  "labels": [
    "type/bug"
  ],
  "comments_data": [
    {
      "id": 555938687,
      "user": "Connor1996",
      "created_at": "2019-11-20T10:21:15Z",
      "body": "/cc @gengliqi @BusyJay "
    },
    {
      "id": 569732753,
      "user": "gengliqi",
      "created_at": "2019-12-30T16:54:45Z",
      "body": "I suspect this panic happens here.\r\nhttps://github.com/tikv/tikv/blob/8376bb6b8458d3ba0cc179f9158fb0e931abbb26/src/raftstore/store/peer.rs#L1650\r\nThe stack may be as below.\r\nhttps://github.com/tikv/tikv/blob/8376bb6b8458d3ba0cc179f9158fb0e931abbb26/src/raftstore/store/fsm/peer.rs#L625-L636\r\nhttps://github.com/tikv/tikv/blob/8376bb6b8458d3ba0cc179f9158fb0e931abbb26/src/raftstore/store/peer.rs#L1242-L1257\r\nhttps://github.com/tikv/tikv/blob/8376bb6b8458d3ba0cc179f9158fb0e931abbb26/src/raftstore/store/peer.rs#L1009-L1023\r\n\r\nWhen executing on_ready_commit_merge, the target peer removes some source data in StoreMeta which is dangerous because at this time source peer is still running.\r\n\r\nSo I think the better way to handle this problem is to let the source peer applies all log and destroys itself before the target peer applies commit merge log. \r\nThis method can also remove merge_locks in StoreMeta which can make the sync logic more clear.\r\n\r\n/cc @Connor1996 @BusyJay "
    },
    {
      "id": 569872680,
      "user": "BusyJay",
      "created_at": "2019-12-31T06:23:20Z",
      "body": "Which version of TiKV does the stack belong to? The stack shows that the panic happens in `on_apply_res`, how can it be related to `collect_ready`?"
    },
    {
      "id": 570123954,
      "user": "Connor1996",
      "created_at": "2020-01-02T05:53:49Z",
      "body": "> Which version of TiKV does the stack belong to? The stack shows that the panic happens in `on_apply_res`, how can it be related to `collect_ready`?\r\n\r\nSorry about that, I forget to record the concrete version. I check the `v3.0.5` and find all the log's locations are consistent, so we can simply assume that it belongs to `v3.0.5`.\r\n\r\n"
    },
    {
      "id": 570124228,
      "user": "BusyJay",
      "created_at": "2020-01-02T05:56:22Z",
      "body": "So I guess what @gengliqi found is an unrelated problem that also needs to be fixed."
    }
  ]
}