{
  "issue_number": 9970,
  "title": "index out of bounds: the len is 4 but the index is 4",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n```bash\r\n[tidb@vm4 bin]$ ./tikv-server -V\r\nTiKV\r\nRelease Version:   5.0.0-rc.x\r\nEdition:           Community\r\nGit Commit Hash:   4807a3d610f2809bd6cc5b1e7645dbb01d5e9e52\r\nGit Commit Branch: heads/refs/tags/v5.0.0-nightly\r\nUTC Build Time:    2021-04-02 16:35:25\r\nRust Version:      rustc 1.51.0-nightly (bc39d4d9c 2021-01-15)\r\nEnable Features:   jemalloc mem-profiling portable sse protobuf-codec test-engines-rocksdb cloud-aws cloud-gcp\r\nProfile:           dist_release\r\n```\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\nsorry, I can't find out the SQL which leads to this error occurs. The stack logs may be useful to find it out.\r\n### What did you expect?\r\ntikv doesn't exit and  restart \r\n### What did happened?\r\ntikv exited with fatal error and  restart \r\n```bash\r\n[2021/04/06 20:24:41.775 +08:00] [FATAL] [lib.rs:465] [\"index out of bounds: the len is 4 but the index is 4\"] [backtrace=\"stack backtrace:\\n   0: tikv_util::set_panic_hook::{{closure}}\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tikv_util/src/lib.rs:464\\n   1: std::panicking::rust_panic_with_hook\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/panicking.rs:595\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/panicking.rs:497\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/sys_common/backtrace.rs:141\\n   4: rust_begin_unwind\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/panicking.rs:493\\n   5: core::panicking::panic_fmt\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/core/src/panicking.rs:92\\n   6: core::panicking::panic_bounds_check\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/core/src/panicking.rs:69\\n   7: core::unicode::unicode_data::skip_search\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/core/src/unicode/unicode_data.rs:75\\n      core::unicode::unicode_data::white_space::lookup\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/core/src/unicode/unicode_data.rs:541\\n   8: core::char::methods::<impl char>::is_whitespace\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/char/methods.rs:794\\n      core::str::<impl str>::trim::{{closure}}\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/str/mod.rs:1727\\n      <F as core::str::pattern::MultiCharEq>::matches\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/str/pattern.rs:600\\n      <core::str::pattern::MultiCharEqSearcher<C> as core::str::pattern::Searcher>::next\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/str/pattern.rs:644\\n      core::str::pattern::Searcher::next_reject\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/str/pattern.rs:242\\n      <core::str::pattern::CharPredicateSearcher<F> as core::str::pattern::Searcher>::next_reject\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/str/pattern.rs:736\\n      core::str::<impl str>::trim_matches\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/str/mod.rs:1926\\n      core::str::<impl str>::trim\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/str/mod.rs:1727\\n   9: tidb_query_datatype::codec::mysql::time::parser::parse\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_datatype/src/codec/mysql/time/mod.rs:565\\n      tidb_query_datatype::codec::mysql::time::Time::parse\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_datatype/src/codec/mysql/time/mod.rs:738\\n  10: tidb_query_expr::impl_cast::cast_string_as_time\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_expr/src/impl_cast.rs:1148\\n  11: <tidb_query_expr::types::function::Arg<Arg0_,tidb_query_expr::types::function::Null> as tidb_query_expr::impl_cast::CastStringAsTime_Fn>::eval\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_expr/src/impl_cast.rs:1140\\n      <tidb_query_expr::impl_cast::CastStringAsTime_Evaluator as tidb_query_expr::types::function::Evaluator>::eval\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_expr/src/impl_cast.rs:1140\\n      <tidb_query_expr::types::function::ArgConstructor<A,E> as tidb_query_expr::types::function::Evaluator>::eval\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_expr/src/types/function.rs:259\\n      tidb_query_expr::impl_cast::cast_string_as_time_fn_meta::run\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_expr/src/impl_cast.rs:1140\\n  12: tidb_query_expr::types::expr_eval::<impl tidb_query_expr::types::expr::RpnExpression>::eval_decoded\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_expr/src/types/expr_eval.rs:248\\n  13: <tidb_query_executors::fast_hash_aggr_executor::FastHashAggregationImpl as tidb_query_executors::util::aggr_executor::AggregationExecutorImpl<Src>>::process_batch_input\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_expr/src/types/expr_eval.rs:161\\n  14: tidb_query_executors::util::aggr_executor::AggregationExecutor<Src,I>::handle_next_batch\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/util/aggr_executor.rs:205\\n      <tidb_query_executors::util::aggr_executor::AggregationExecutor<Src,I> as tidb_query_executors::interface::BatchExecutor>::next_batch\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/util/aggr_executor.rs:282\\n      <tidb_query_executors::fast_hash_aggr_executor::BatchFastHashAggregationExecutor<Src> as tidb_query_executors::interface::BatchExecutor>::next_batch\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/fast_hash_aggr_executor.rs:49\\n      <tidb_query_common::execute_stats::WithSummaryCollector<C,T> as tidb_query_executors::interface::BatchExecutor>::next_batch\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/interface.rs:108\\n  15: <alloc::boxed::Box<T> as tidb_query_executors::interface::BatchExecutor>::next_batch\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/interface.rs:77\\n      tidb_query_executors::runner::BatchExecutorsRunner<SS>::internal_handle_request\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/runner.rs:529\\n  16: tidb_query_executors::runner::BatchExecutorsRunner<SS>::handle_request::{{closure}}\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/runner.rs:414\\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/future/mod.rs:80\\n      <tikv::coprocessor::dag::BatchDAGHandler as tikv::coprocessor::RequestHandler>::handle_request::__handle_request::{{closure}}\\n             at /home/jenkins/agent/workspace/optimization-build-tidb-linux-amd/go/src/github.com/pingcap/tikv/src/coprocessor/dag/mod.rs:105\\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/future/mod.rs:80\\n      <core::pin::Pin<P> as core::future::future::Future>::poll\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/future/future.rs:119\\n      <minitrace::future::TraceWrapped<T> as core::future::future::Future>::poll\\n             at /rust/git/checkouts/minitrace-rust-4a91d55623f07cfc/de69110/src/future.rs:107\\n[2021/04/06 20:24:57.103 +08:00] [INFO] [lib.rs:89] [\"Welcome to TiKV\"]\r\n```",
  "state": "closed",
  "created_at": "2021-04-07T02:13:09Z",
  "updated_at": "2021-04-12T06:02:35Z",
  "closed_at": "2021-04-12T06:02:35Z",
  "labels": [
    "type/bug",
    "sig/coprocessor",
    "severity/critical"
  ],
  "comments_data": [
    {
      "id": 814608392,
      "user": "sticnarf",
      "created_at": "2021-04-07T05:19:12Z",
      "body": "In TiKV, `cast_string_as_time` assumes the string is a valid UTF-8:\r\n\r\nhttps://github.com/tikv/tikv/blob/a301acfabf/components/tidb_query_expr/src/impl_cast.rs#L1150\r\n\r\nHowever, in this case it is not. I don't know the source of this non-valid UTF-8 string.\r\n\r\nAnyway, I think it is not a good idea to make a valid UTF-8 assumption. IMHO it is better to return an unsupported encoding error instead of letting TiKV panic.\r\n\r\ncc @iosmanthus "
    },
    {
      "id": 814694457,
      "user": "wan1y",
      "created_at": "2021-04-07T07:58:34Z",
      "body": "Steps to reproduce:\r\n```mysql\r\nDROP TABLE IF EXISTS `t1`;\r\nCREATE TABLE `t1`  (\r\n  `COL1` varbinary(10) NOT NULL,\r\n  `COL2` varchar(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL\r\n) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci ROW_FORMAT = Compact;\r\n\r\nINSERT INTO `t1` VALUES (0x07BB1818FB3D828D9109, '蕚鹓羓凢唱販蜀璾貈鼸');\r\n\r\nmysql> select count(col2) from t1 group by year(col1);\r\n9002 - TiKV server timeout\r\n```"
    }
  ]
}