{
  "issue_number": 10658,
  "title": "Fail to profile TiKV in aarch64",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nTiKV v5.1.0\r\ntiup v1.5.2\r\nlibgcc_s-7.3.0-20190804.so.1\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n```\r\nLinux localhost.localdomain 4.19.90-23.8.v2101.ky10.aarch64 #1 SMP Mon May 17 17:07:38 CST 2021 aarch64 aarch64 aarch64 GNU/Linux\r\n```\r\n```\r\nprocessor       : 63\r\nmodel name      : HUAWEI,Kunpeng 920\r\nBogoMIPS        : 200.00\r\nFeatures        : fp asimd evtstrm aes pmull sha1 sha2 crc32 atomics fphp asimdhp cpuid asimdrdm jscvt fcma dcpop asimddp asimdfhm\r\nCPU implementer : 0x48\r\nCPU architecture: 8\r\nCPU variant     : 0x1\r\nCPU part        : 0xd01\r\nCPU revision    : 0\r\n```\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nRun a TiKV and use the http API to profile it.\r\n\r\n### What did you expect?\r\nSucceed in profiling.\r\n\r\n### What did happened?\r\n\r\nTiKV cores dump.\r\n```\r\n#0  0x0000fffd7b6aceb4 in ?? () from /lib64/libgcc_s.so.1\r\n#1  0x0000fffd7b6ae534 in _Unwind_Backtrace () from /lib64/libgcc_s.so.1\r\n#2  0x0000aaac01eedb58 in backtrace::backtrace::libunwind::trace (cb=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.37/src/backtrace/libunwind.rs:88\r\n#3  backtrace::backtrace::trace_unsynchronized (cb=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.37/src/backtrace/mod.rs:66\r\n#4  pprof::profiler::perf_signal_handler (_signal=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/pprof-0.4.2/src/profiler.rs:128\r\n#5  <signal handler called>\r\n```\r\n\r\n",
  "state": "closed",
  "created_at": "2021-08-03T07:47:52Z",
  "updated_at": "2022-05-19T03:44:38Z",
  "closed_at": "2022-05-19T03:44:38Z",
  "labels": [
    "type/bug",
    "severity/minor",
    "sig/diagnosis"
  ],
  "comments_data": [
    {
      "id": 891619940,
      "user": "youjiali1995",
      "created_at": "2021-08-03T07:49:58Z",
      "body": "cc @YangKeao "
    },
    {
      "id": 891755848,
      "user": "Lily2025",
      "created_at": "2021-08-03T11:08:12Z",
      "body": "/severity major"
    },
    {
      "id": 893186074,
      "user": "sticnarf",
      "created_at": "2021-08-05T05:57:10Z",
      "body": "I can reproduce it on my own ARM server:\r\n\r\n```\r\nUsing host libthread_db library \"/lib64/libthread_db.so.1\".\r\nCore was generated by `bin/tikv-server --addr 0.0.0.0:20160 --advertise-addr 172.31.59.15:20160 --stat'.\r\nProgram terminated with signal SIGSEGV, Segmentation fault.\r\n#0  0x0000ffffb6315670 in aarch64_fallback_frame_state (context=0xffffab18a090, context=0xffffab18a090, fs=0xffffab18a450) at ./md-unwind-support.h:74\r\n74        if (pc[0] != MOVZ_X8_8B || pc[1] != SVC_0)\r\n[Current thread is 1 (Thread 0xffffab18f670 (LWP 2081))]\r\nwarning: Missing auto-load script at offset 0 in section .debug_gdb_scripts\r\nof file /data/deploy/tikv-20160/bin/tikv-server.\r\nUse `info auto-load python-scripts [REGEXP]' to list them.\r\n(gdb) bt\r\n#0  0x0000ffffb6315670 in aarch64_fallback_frame_state (context=0xffffab18a090, context=0xffffab18a090, fs=0xffffab18a450) at ./md-unwind-support.h:74\r\n#1  uw_frame_state_for (context=context@entry=0xffffab18a090, fs=fs@entry=0xffffab18a450) at ../../../libgcc/unwind-dw2.c:1257\r\n#2  0x0000ffffb6316d48 in _Unwind_Backtrace (trace=0xaaaae073b594<error reading variable>, trace_argument=0xffffab18b770) at ../../../libgcc/unwind.inc:290\r\n#3  0x0000aaaae0a98e4c in backtrace::backtrace::libunwind::trace (cb=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.37/src/backtrace/libunwind.rs:88\r\n#4  backtrace::backtrace::trace_unsynchronized (cb=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.37/src/backtrace/mod.rs:66\r\n#5  pprof::profiler::perf_signal_handler (_signal=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/pprof-0.4.2/src/profiler.rs:128\r\n#6  <signal handler called>\r\nDwarf Error: Cannot find DIE at 0xae370 referenced from DIE at 0x15942c [in module /data/deploy/tikv-20160/bin/tikv-server]\r\n(gdb) p pc\r\n$1 = (unsigned int *) 0x97700\r\n(gdb) p pc[0]\r\nCannot access memory at address 0x97700\r\n```\r\n\r\nHopefully this provides some more debug information.\r\n\r\nIt seems to go into the no dwarf info routine at:https://github.com/gcc-mirror/gcc/blob/releases/gcc-7.3.0/libgcc/unwind-dw2.c#L1257, and the return address is not correct:https://github.com/gcc-mirror/gcc/blob/releases/gcc-7.3.0/libgcc/config/aarch64/linux-unwind.h#L63\r\n\r\nThis is quite like https://github.com/tikv/tikv/issues/9765, but happens on aarch64.\r\nThe root cause should be different because stack probing is not implemented for aarch64."
    },
    {
      "id": 895107114,
      "user": "YangKeao",
      "created_at": "2021-08-09T10:15:55Z",
      "body": "I guass the problem is that `backtrace-rs` cannot handle an ARM signal frame. Handling a signal frame on ARM needs some special way (e.g. in [rustc](https://github.com/rust-lang/rust/blob/master/library/panic_unwind/src/gcc.rs#L205-L207 ) )."
    },
    {
      "id": 1004568423,
      "user": "tonyxuqqi",
      "created_at": "2022-01-04T06:58:53Z",
      "body": "/assign tonyxuqqi"
    },
    {
      "id": 1004571180,
      "user": "YangKeao",
      "created_at": "2022-01-04T07:05:16Z",
      "body": "@tonyxuqqi The detailed mechanism of why `libgcc` cannot handle the arm signal frame (occasionally) is still unclear. Some previous dig inside the libgcc has been recorded here: https://github.com/tikv/pprof-rs/issues/75 ."
    },
    {
      "id": 1024034737,
      "user": "breezewish",
      "created_at": "2022-01-28T09:27:05Z",
      "body": "@mornyx is also working on this."
    },
    {
      "id": 1024035990,
      "user": "mornyx",
      "created_at": "2022-01-28T09:28:41Z",
      "body": "/assign"
    }
  ]
}