{
  "issue_number": 13599,
  "title": "rawkv: unit test \"test_storage::test_raw_put_key_guard\" is not correct and unstable",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\nUnit test \"test_storage::test_raw_put_key_guard\" is not correct [here](https://github.com/tikv/tikv/blob/11a340c3ec54fdbe1582a4b6eb669f43aa924ba2/tests/failpoints/cases/test_storage.rs#L1524). `must_get_none(&cluster.get_engine(1), b\"rk3\");` is expected to get a value as `v3`.\r\n\r\nMoreover, this case is unstable.\r\nSee [here](https://ci.pingcap.net/blue/organizations/jenkins/tikv_ghpr_test/detail/tikv_ghpr_test/27997/pipeline/)\r\n```\r\n[2022-10-13T09:32:30.271Z] failures:\r\n[2022-10-13T09:32:30.271Z]     cases::test_storage::test_raw_put_key_guard\r\n[2022-10-13T09:32:30.271Z] \r\n[2022-10-13T09:32:30.271Z] test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 225 filtered out; finished in 0.62s\r\n[2022-10-13T09:32:30.271Z] \r\n[2022-10-13T09:32:30.271Z] \r\n[2022-10-13T09:32:30.271Z] --- TRY 3 STDERR:                              tests::failpoints cases::test_storage::test_raw_put_key_guard ---\r\n[2022-10-13T09:32:30.271Z] thread 'cases::test_storage::test_raw_put_key_guard' panicked at 'called `Option::unwrap()` on a `None` value', tests/failpoints/cases/test_storage.rs:1519:23\r\n[2022-10-13T09:32:30.271Z] stack backtrace:\r\n[2022-10-13T09:32:30.271Z]    0: rust_begin_unwind\r\n[2022-10-13T09:32:30.271Z]              at /rustc/0f4bcadb46006bc484dad85616b484f93879ca4e/library/std/src/panicking.rs:584:5\r\n[2022-10-13T09:32:30.271Z]    1: core::panicking::panic_fmt\r\n[2022-10-13T09:32:30.271Z]              at /rustc/0f4bcadb46006bc484dad85616b484f93879ca4e/library/core/src/panicking.rs:142:14\r\n[2022-10-13T09:32:30.271Z]    2: core::panicking::panic\r\n[2022-10-13T09:32:30.271Z]              at /rustc/0f4bcadb46006bc484dad85616b484f93879ca4e/library/core/src/panicking.rs:48:5\r\n[2022-10-13T09:32:30.271Z]    3: core::option::Option<T>::unwrap\r\n[2022-10-13T09:32:30.271Z]    4: failpoints::cases::test_storage::test_raw_put_key_guard\r\n[2022-10-13T09:32:30.271Z]              at /home/jenkins/tikv-src/tests/failpoints/cases/test_storage.rs:1519:16\r\n[2022-10-13T09:32:30.271Z]    5: failpoints::cases::test_storage::test_raw_put_key_guard::{{closure}}\r\n[2022-10-13T09:32:30.271Z]              at /home/jenkins/tikv-src/tests/failpoints/cases/test_storage.rs:1484:1\r\n[2022-10-13T09:32:30.271Z]    6: core::ops::function::FnOnce::call_once\r\n[2022-10-13T09:32:30.271Z]              at /rustc/0f4bcadb46006bc484dad85616b484f93879ca4e/library/core/src/ops/function.rs:248:5\r\n[2022-10-13T09:32:30.271Z]    7: test_util::runner::run_test_with_hook::{{closure}}::{{closure}}\r\n[2022-10-13T09:32:30.271Z]    8: core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n[2022-10-13T09:32:30.271Z]    9: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n[2022-10-13T09:32:30.271Z]              at /rustc/0f4bcadb46006bc484dad85616b484f93879ca4e/library/alloc/src/boxed.rs:1935:9\r\n[2022-10-13T09:32:30.271Z] note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n[2022-10-13T09:32:30.271Z] thread '<unnamed>' panicked at 'called `Result::unwrap()` on an `Err` value: RpcFailure(RpcStatus { code: 14-UNAVAILABLE, message: \"Socket closed\", details: [] })', tests/failpoints/cases/test_storage.rs:1513:42\r\n[2022-10-13T09:32:30.271Z] stack backtrace:\r\n[2022-10-13T09:32:30.271Z]    0: rust_begin_unwind\r\n[2022-10-13T09:32:30.271Z]              at /rustc/0f4bcadb46006bc484dad85616b484f93879ca4e/library/std/src/panicking.rs:584:5\r\n[2022-10-13T09:32:30.271Z]    1: core::panicking::panic_fmt\r\n[2022-10-13T09:32:30.271Z]              at /rustc/0f4bcadb46006bc484dad85616b484f93879ca4e/library/core/src/panicking.rs:142:14\r\n[2022-10-13T09:32:30.271Z]    2: core::result::unwrap_failed\r\n[2022-10-13T09:32:30.271Z]              at /rustc/0f4bcadb46006bc484dad85616b484f93879ca4e/library/core/src/result.rs:1814:5\r\n[2022-10-13T09:32:30.271Z]    3: core::result::Result<T,E>::unwrap\r\n[2022-10-13T09:32:30.271Z]    4: failpoints::cases::test_storage::test_raw_put_key_guard::{{closure}}\r\n[2022-10-13T09:32:30.271Z]              at /home/jenkins/tikv-src/tests/failpoints/cases/test_storage.rs:1513:17\r\n[2022-10-13T09:32:30.271Z] note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\n[2022-10-13T09:32:30.271Z] \r\n[2022-10-13T09:32:30.271Z] error: test run failed\r\n```\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n\r\nmaster (11a340c3ec54fdbe1582a4b6eb669f43aa924ba2)\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\nCI.\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nSubmit PR to trigger Ci.\r\n\r\n### What did you expect?\r\n\r\nCase \"test_storage::test_raw_put_key_guard\" succeed.\r\n\r\n### What did happened?\r\n\r\nCase \"test_storage::test_raw_put_key_guard\" failed.",
  "state": "closed",
  "created_at": "2022-10-13T10:56:14Z",
  "updated_at": "2022-10-17T11:03:54Z",
  "closed_at": "2022-10-17T11:03:54Z",
  "labels": [
    "type/bug",
    "severity/minor"
  ],
  "comments_data": [
    {
      "id": 1277430649,
      "user": "pingyu",
      "created_at": "2022-10-13T11:03:04Z",
      "body": "cc @haojinming "
    }
  ]
}