{
  "issue_number": 16994,
  "title": "in-memory-engine: tikv crash due to an assert failure",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nmaster  #381f5c0a034f5c0ed300cb1c1812254cc9ec3ad2\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\nRun some insert test with cache enabled, the memory usage is near the hard-limit so that evict range will happen\r\n### What did you expect?\r\nNo issue\r\n### What did happened?\r\nCrash\r\n\r\n[2024/05/10 10:14:37.246 -07:00] [INFO] [background.rs:793] [\"start memory usage check and evict\"] [mem_usage(MB)=25599] [thread_id=28]\r\n[2024/05/10 10:14:37.246 -07:00] [WARN] [write_batch.rs:244] [\"the memory usage of in-memory engine reaches to hard limit\"] [memory_usage(MB)=25599.999939918518] [range=\"CacheRange { tag: \\\"[region_id=1326]\\\", range_start: 7A745F3130305F6952686F6E64615F72325F445362775656744B4C7A, range_end: 7A745F3130305F7231FF375F5A6D61684E52FF635A6E5400000000FB }\"] [thread_id=279]\r\n[2024/05/10 10:14:37.246 -07:00] [WARN] [write_batch.rs:244] [\"the memory usage of in-memory engine reaches to hard limit\"] [memory_usage(MB)=25599.999939918518] [range=\"CacheRange { tag: \\\"[region_id=1334]\\\", range_start: 7A7200000100000000FB, range_end: 7A745F3130305F694B617468795F7234365F644F5975544854576867 }\"] [thread_id=280]\r\n[2024/05/10 10:14:37.246 -07:00] [INFO] [write_batch.rs:200] [\"memory acquire failed due to reaching hard limit\"] [range_end=7A745F3130305F694B617468795F7234365F644F5975544854576867] [range_start=7A7200000100000000FB] [thread_id=280]\r\n[2024/05/10 10:14:37.246 -07:00] [INFO] [write_batch.rs:200] [\"memory acquire failed due to reaching hard limit\"] [range_end=7A745F3130305F7231FF375F5A6D61684E52FF635A6E5400000000FB] [range_start=7A745F3130305F6952686F6E64615F72325F445362775656744B4C7A] [thread_id=279]\r\n[2024/05/10 10:14:37.246 -07:00] [INFO] [background.rs:793] [\"start memory usage check and evict\"] [mem_usage(MB)=25599] [thread_id=28]\r\n[2024/05/10 10:14:37.246 -07:00] [INFO] [range_manager.rs:312] [\"evict range in cache range engine\"] [range_end=7A745F3130305F694B617468795F7234365F644F5975544854576867] [range_start=7A7200000100000000FB] [thread_id=280]\r\n[2024/05/10 10:14:37.246 -07:00] [INFO] [range_manager.rs:312] [\"evict range in cache range engine\"] [range_end=7A745F3130305F7231FF375F5A6D61684E52FF635A6E5400000000FB] [range_start=7A745F3130305F6952686F6E64615F72325F445362775656744B4C7A] [thread_id=279]\r\n[2024/05/10 10:14:37.247 -07:00] [WARN] [write_batch.rs:244] [\"the memory usage of in-memory engine reaches to hard limit\"] [memory_usage(MB)=25600.00772190094] [range=\"CacheRange { tag: \\\"[region_id=1332]\\\", range_start: 7A745F3130305F694B617468795F7234365F644F5975544854576867, range_end: 7A745F3130305F6952686F6E64615F72325F445362775656744B4C7A }\"] [thread_id=279]\r\n[2024/05/10 10:14:37.247 -07:00] [INFO] [write_batch.rs:200] [\"memory acquire failed due to reaching hard limit\"] [range_end=7A745F3130305F6952686F6E64615F72325F445362775656744B4C7A] [range_start=7A745F3130305F694B617468795F7234365F644F5975544854576867] [thread_id=279]\r\n[2024/05/10 10:14:37.247 -07:00] [INFO] [background.rs:793] [\"start memory usage check and evict\"] [mem_usage(MB)=25600] [thread_id=28]\r\n[2024/05/10 10:14:37.247 -07:00] [WARN] [write_batch.rs:244] [\"the memory usage of in-memory engine reaches to hard limit\"] [memory_usage(MB)=25600.00772190094] [range=\"CacheRange { tag: \\\"[region_id=1324]\\\", range_start: 7A745F3130305F7231FF375F5A6D61684E52FF635A6E5400000000FB, range_end: 7A7480000000000000FF105F728000000000FF0000600000000000FA }\"] [thread_id=280]\r\n[2024/05/10 10:14:37.247 -07:00] [INFO] [write_batch.rs:200] [\"memory acquire failed due to reaching hard limit\"] [range_end=7A7480000000000000FF105F728000000000FF0000600000000000FA] [range_start=7A745F3130305F7231FF375F5A6D61684E52FF635A6E5400000000FB] [thread_id=280]\r\n[2024/05/10 10:14:37.247 -07:00] [INFO] [background.rs:793] [\"start memory usage check and evict\"] [mem_usage(MB)=25600] [thread_id=28]\r\n[2024/05/10 10:14:37.247 -07:00] [INFO] [range_manager.rs:312] [\"evict range in cache range engine\"] [range_end=7A745F3130305F6952686F6E64615F72325F445362775656744B4C7A] [range_start=7A745F3130305F694B617468795F7234365F644F5975544854576867] [thread_id=279]\r\n[2024/05/10 10:14:37.248 -07:00] [FATAL] [lib.rs:477] [\"assertion failed: (left_range.is_some() || right_range.is_some()) || &range_key == evict_range\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\\n   1: std::panicking::rust_panic_with_hook\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n   4: rust_begin_unwind\\n   5: core::panicking::panic_fmt\\n   6: core::panicking::panic\\n   7: region_cache_memory_engine::range_manager::RangeManager::evict_range\\n   8: <region_cache_memory_engine::write_batch::RangeCacheWriteBatch as engine_traits::write_batch::WriteBatch>::write_opt\\n   9: <hybrid_engine::write_batch::HybridEngineWriteBatch<EK> as engine_traits::write_batch::WriteBatch>::write_callback_opt::{{closure}}\\n  10: _ZN7rocksdb11WriteThread6Writer10ConsumeOneEm\\n  11: _ZN7rocksdb6DBImpl19MultiBatchWriteImplERKNS_12WriteOptionsEOSt6vectorIPNS_10WriteBatchESaIS6_EEPNS_13WriteCallbackEPmmSC_PNS_17PostWriteCallbackE\\n  12: _ZN7rocksdb6DBImpl15MultiBatchWriteERKNS_12WriteOptionsEOSt6vectorIPNS_10WriteBatchESaIS6_EEPNS_17PostWriteCallbackE\\n  13: crocksdb_write_multi_batch_callback\\n  14: rocksdb::rocksdb::DB::multi_batch_write_callback\\n  15: <engine_rocks::write_batch::RocksWriteBatchVec as engine_traits::write_batch::WriteBatch>::write_callback_opt\\n  16: raftstore::store::fsm::apply::ApplyContext<EK>::write_to_db\\n  17: raftstore::store::fsm::apply::ApplyContext<EK>::flush\\n  18: <raftstore::store::fsm::apply::ApplyPoller<EK> as batch_system::batch::PollHandler<raftstore::store::fsm::apply::ApplyFsm<EK>,raftstore::store::fsm::apply::ControlFsm>>::end\\n  19: batch_system::batch::Poller<N,C,Handler>::poll\\n  20: std::sys_common::backtrace::__rust_begin_short_backtrace\\n  21: core::ops::function::FnOnce::call_once{{vtable.shim}}\\n  22: std::sys::unix::thread::Thread::new::thread_start\\n  23: start_thread\\n             at /build/glibc-e2p3jK/glibc-2.31/nptl/pthread_create.c:477:8\\n  24: clone\\n             at /build/glibc-e2p3jK/glibc-2.31/misc/../sysdeps/unix/sysv/linux/x86_64/clone.S:95\\n\"] [location=components/region_cache_memory_engine/src/range_manager.rs:320] [thread_name=apply-0] [thread_id=279]\r\n",
  "state": "closed",
  "created_at": "2024-05-10T17:23:16Z",
  "updated_at": "2024-05-10T17:35:15Z",
  "closed_at": "2024-05-10T17:35:15Z",
  "labels": [
    "type/bug"
  ],
  "comments_data": [
    {
      "id": 2105007318,
      "user": "tonyxuqqi",
      "created_at": "2024-05-10T17:35:15Z",
      "body": "It should be fixed by https://github.com/tikv/tikv/pull/16959"
    }
  ]
}