{
  "issue_number": 9171,
  "title": "TiKV server panic when running with TiCDC",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n\r\nmaster, \"Git Commit Hash:   5bd92d7fa32a2b6d21e03c69258edc1565ebd7ec\"\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nRunning TiCDC integration test, the basic system structure is \r\n\r\nupstream: 3 TiKVs, 2 TiDBs, 1 PD\r\ndownstream: 1 TiKV, 1 TiDB, 1 PD\r\n\r\nUse TiCDC to replicate upstream data change to downstream\r\n\r\n### What did you expect?\r\n\r\nRunning CI normally\r\n\r\n### What did happened?\r\n\r\nCI source:\r\n\r\n- https://internal.pingcap.net/idc-jenkins/blue/organizations/jenkins/cdc_ghpr_integration_test/detail/cdc_ghpr_integration_test/3365/pipeline/87/\r\n- https://internal.pingcap.net/idc-jenkins/blue/organizations/jenkins/cdc_ghpr_integration_test/detail/cdc_ghpr_integration_test/3366/pipeline\r\n\r\nTiKV panic happens\r\n\r\n- panic 1, original log: https://internal.pingcap.net/idc-jenkins/blue/rest/organizations/jenkins/pipelines/cdc_ghpr_integration_test/runs/3365/nodes/84/steps/244/log/?start=0\r\n```\r\n[2020-12-02T06:01:05.442Z] [2020/12/02 14:00:24.065 +08:00] [FATAL] [lib.rs:482] [\"7480000000000000335F728000000000000001@421236263768031235, commit@421236263768031237 is not tracked, region 65\"] [backtrace=\"stack backtrace:\r\n   0: tikv_util::set_panic_hook::{{closure}}\r\n             at components/tikv_util/src/lib.rs:481\r\n   1: std::panicking::rust_panic_with_hook\r\n             at library/std/src/panicking.rs:581\r\n   2: std::panicking::begin_panic_handler::{{closure}}\r\n             at library/std/src/panicking.rs:484\r\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\r\n             at library/std/src/sys_common/backtrace.rs:141\r\n   4: rust_begin_unwind\r\n             at library/std/src/panicking.rs:483\r\n   5: std::panicking::begin_panic_fmt\r\n             at library/std/src/panicking.rs:437\r\n   6: resolved_ts::Resolver::untrack_lock\r\n             at components/resolved_ts/src/lib.rs:92\r\n   7: cdc::delegate::Delegate::sink_data\r\n             at components/cdc/src/delegate.rs:586\r\n      cdc::delegate::Delegate::on_batch\r\n             at components/cdc/src/delegate.rs:436\r\n   8: cdc::endpoint::Endpoint<T>::on_multi_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/cdc/src/endpoint.rs:566\r\n      <cdc::endpoint::Endpoint<T> as tikv_util::worker::pool::Runnable>::run\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/cdc/src/endpoint.rs:995\r\n   9: tikv_util::worker::pool::Worker::start_with_timer_impl::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tikv_util/src/worker/pool.rs:425\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/core/src/future/mod.rs:80\r\n  10: <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/6bbea16/src/task/future.rs:261\r\n  11: <tikv_util::yatp_pool::YatpPoolRunner<T> as yatp::pool::runner::Runner>::handle\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tikv_util/src/yatp_pool/mod.rs:93\r\n      yatp::pool::worker::WorkerThread<T,R>::run\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/6bbea16/src/pool/worker.rs:48\r\n      yatp::pool::builder::LazyBuilder<T>::build::{{closure}}\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/6bbea16/src/pool/builder.rs:91\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/sys_common/backtrace.rs:125\r\n  12: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/thread/mod.rs:470\r\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/panic.rs:308\r\n      std::panicking::try::do_call\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/panicking.rs:381\r\n      std::panicking::try\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/panicking.rs:345\r\n      std::panic::catch_unwind\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/panic.rs:382\r\n      std::thread::Builder::spawn_unchecked::{{closure}}\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/thread/mod.rs:469\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/core/src/ops/function.rs:227\r\n  13: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/alloc/src/boxed.rs:1042\r\n      <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/alloc/src/boxed.rs:1042\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at library/std/src/sys/unix/thread.rs:89\r\n  14: start_thread\r\n  15: __clone\r\n\"] [location=components/resolved_ts/src/lib.rs:92] [thread_name=cdc-0]\r\n```\r\n\r\n- panic 2 original log: https://internal.pingcap.net/idc-jenkins/blue/rest/organizations/jenkins/pipelines/cdc_ghpr_integration_test/runs/3366/nodes/84/steps/261/log/?start=0\r\n\r\n```\r\n[2020-12-02T06:32:55.307Z] [2020/12/02 14:13:17.779 +08:00] [FATAL] [lib.rs:482] [\"assertion failed: `(left == right)`\r\n  left: `3`,\r\n right: `4`\"] [backtrace=\"stack backtrace:\r\n   0: tikv_util::set_panic_hook::{{closure}}\r\n             at components/tikv_util/src/lib.rs:481\r\n   1: std::panicking::rust_panic_with_hook\r\n             at library/std/src/panicking.rs:581\r\n   2: std::panicking::begin_panic_handler::{{closure}}\r\n             at library/std/src/panicking.rs:484\r\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\r\n             at library/std/src/sys_common/backtrace.rs:141\r\n   4: rust_begin_unwind\r\n             at library/std/src/panicking.rs:483\r\n   5: std::panicking::begin_panic_fmt\r\n             at library/std/src/panicking.rs:437\r\n   6: tikv::storage::txn::commands::prewrite::one_pc_commit_ts\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/txn/commands/prewrite.rs:0\r\n   7: tikv::storage::txn::commands::prewrite::Prewriter<K>::write_result\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/txn/commands/prewrite.rs:480\r\n      tikv::storage::txn::commands::prewrite::Prewriter<K>::process_write\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/txn/commands/prewrite.rs:371\r\n      <tikv::storage::txn::commands::prewrite::Prewrite as tikv::storage::txn::commands::WriteCommand<S,L>>::process_write\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/txn/commands/prewrite.rs:196\r\n      tikv::storage::txn::commands::Command::process_write\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/txn/commands/mod.rs:529\r\n   8: tikv::storage::txn::scheduler::Scheduler<E,L>::process_write\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/txn/scheduler.rs:630\r\n      tikv::storage::txn::scheduler::Scheduler<E,L>::process_by_worker::{{closure}}::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/txn/scheduler.rs:574\r\n      tikv::storage::kv::with_tls_engine::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/kv/mod.rs:398\r\n      std::thread::local::LocalKey<T>::try_with\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/thread/local.rs:272\r\n      std::thread::local::LocalKey<T>::with\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/thread/local.rs:248\r\n      tikv::storage::kv::with_tls_engine\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/kv/mod.rs:396\r\n      tikv::storage::txn::scheduler::Scheduler<E,L>::process_by_worker::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/txn/scheduler.rs:573\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/core/src/future/mod.rs:80\r\n      tikv_util::yatp_pool::future_pool::FuturePool::spawn::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tikv_util/src/yatp_pool/future_pool.rs:112\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/core/src/future/mod.rs:80\r\n   9: <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/6bbea16/src/task/future.rs:261\r\n  10: <tikv_util::yatp_pool::YatpPoolRunner<T> as yatp::pool::runner::Runner>::handle\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tikv_util/src/yatp_pool/mod.rs:93\r\n      yatp::pool::worker::WorkerThread<T,R>::run\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/6bbea16/src/pool/worker.rs:48\r\n      yatp::pool::builder::LazyBuilder<T>::build::{{closure}}\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/6bbea16/src/pool/builder.rs:91\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/sys_common/backtrace.rs:125\r\n  11: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/thread/mod.rs:470\r\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/panic.rs:308\r\n      std::panicking::try::do_call\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/panicking.rs:381\r\n      std::panicking::try\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/panicking.rs:345\r\n      std::panic::catch_unwind\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/panic.rs:382\r\n      std::thread::Builder::spawn_unchecked::{{closure}}\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/std/src/thread/mod.rs:469\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/core/src/ops/function.rs:227\r\n  12: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/alloc/src/boxed.rs:1042\r\n      <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at /rustc/b1496c6e606dd908dd651ac2cce89815e10d7fc5/library/alloc/src/boxed.rs:1042\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at library/std/src/sys/unix/thread.rs:89\r\n  13: start_thread\r\n  14: __clone\r\n\"] [location=/home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/txn/commands/prewrite.rs:640] [thread_name=sched-worker-pool-7]\r\n```",
  "state": "closed",
  "created_at": "2020-12-02T07:51:08Z",
  "updated_at": "2020-12-18T11:20:05Z",
  "closed_at": "2020-12-18T11:20:05Z",
  "labels": [
    "type/bug",
    "severity/major"
  ],
  "comments_data": [
    {
      "id": 737063342,
      "user": "sticnarf",
      "created_at": "2020-12-02T08:03:44Z",
      "body": "The second problem is an invalid assertion. This assertion is not valid when there are some mutations that needn't be written (like `CheckNotExists`)."
    },
    {
      "id": 737066177,
      "user": "youjiali1995",
      "created_at": "2020-12-02T08:09:56Z",
      "body": "The first problem is caused by 1PC. TiKV doesn't write locks and commits it directly in this case."
    },
    {
      "id": 737066425,
      "user": "MyonKeminta",
      "created_at": "2020-12-02T08:10:30Z",
      "body": "The first panic is caused by TiDB mistakenly enabled 1PC by default, which is currently not compatible with CDC."
    },
    {
      "id": 737103234,
      "user": "youjiali1995",
      "created_at": "2020-12-02T09:22:36Z",
      "body": "> The first panic is caused by TiDB mistakenly enabled 1PC by default, which is currently not compatible with CDC.\r\n\r\nPlease create an issue for it. @MyonKeminta "
    },
    {
      "id": 737122449,
      "user": "MyonKeminta",
      "created_at": "2020-12-02T09:56:35Z",
      "body": "Ok.\r\nhttps://github.com/tikv/sig-transaction/issues/78\r\nhttps://github.com/tikv/tikv/projects/47#card-48310879"
    }
  ]
}