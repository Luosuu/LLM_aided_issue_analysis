{
  "issue_number": 17840,
  "title": "tikv panic in on_raft_gc_log_tick after region is merged",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n```\r\n\"[2024/11/14 01:40:44.755 +00:00] [FATAL] [lib.rs:509] [\"called `Option::unwrap()` on a `None` value\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\r\n             at tikv/components/tikv_util/src/lib.rs:508:18\r\n   1: <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2032:9\r\n      std::panicking::rust_panic_with_hook\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:692:13\r\n   2: std::panicking::begin_panic_handler::{{closure}}\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:577:13\r\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:137:18\r\n   4: rust_begin_unwind\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:575:5\r\n   5: core::panicking::panic_fmt\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:65:14\r\n   6: core::panicking::panic\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:114:5\r\n   7: raftstore::store::entry_storage::EntryStorage<EK,ER>::term\r\n   8: <raftstore::store::peer_storage::PeerStorage<EK,ER> as raft::storage::Storage>::term\r\n             at tikv/components/raftstore/src/store/peer_storage.rs:273:9\r\n      raft::raft_log::RaftLog<T>::term\r\n             at root/.cargo/git/checkouts/raft-rs-42b8049ef2e3af07/2357cb2/src/raft_log.rs:131:18\r\n   9: raftstore::store::peer::Peer<EK,ER>::get_index_term\r\n             at tikv/components/raftstore/src/store/peer.rs:1307:15\r\n      raftstore::store::fsm::peer::PeerFsmDelegate<EK,ER,T>::on_raft_gc_log_tick\r\n             at tikv/components/raftstore/src/store/fsm/peer.rs:5456:20\r\n  10: raftstore::store::fsm::peer::PeerFsmDelegate<EK,ER,T>::handle_msgs\r\n             at tikv/components/raftstore/src/store/fsm/peer.rs:674:48\r\n  11: <raftstore::store::fsm::store::RaftPoller<EK,ER,T> as batch_system::batch::PollHandler<raftstore::store::fsm::peer::PeerFsm<EK,ER>,raftstore::store::fsm::store::StoreFsm<EK>>>::handle_normal\r\n             at tikv/components/raftstore/src/store/fsm/store.rs:971:9\r\n  12: batch_system::batch::Poller<N,C,Handler>::poll\r\n             at tikv/components/batch-system/src/batch.rs:430:27\r\n  13: batch_system::batch::BatchSystem<N,C>::start_poller::{{closure}}\r\n             at tikv/components/batch-system/src/batch.rs:600:17\r\n      <std::thread::Builder as tikv_util::sys::thread::StdThreadBuildWrapper>::spawn_wrapper::{{closure}}\r\n             at tikv/components/tikv_util/src/sys/thread.rs:415:23\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:121:18\r\n  14: std::thread::Builder::spawn_unchecked_::{{closure}}::{{closure}}\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:551:17\r\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panic/unwind_safe.rs:271:9\r\n      std::panicking::try::do_call\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:483:40\r\n      std::panicking::try\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:447:19\r\n      std::panic::catch_unwind\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panic.rs:137:14\r\n      std::thread::Builder::spawn_unchecked_::{{closure}}\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:550:30\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:513:5\r\n  15: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2000:9\r\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2000:9\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at root/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/unix/thread.rs:108:17\r\n  16: start_thread\r\n  17: __clone3\r\n\"] [location=/tikv/components/raftstore/src/store/entry_storage.rs:952] [thread_name=raftstore-1693-0]\",\r\n```\r\n\r\nrelated logs before this panic:\r\n```\r\n\"[2024/11/14 01:40:44.469 +00:00] [INFO] [pd.rs:1567] [\\\"try to merge\\\"] [merge=\\\"target { id: 138832049 start_key: ? end_key: ? region_epoch { conf_ver: 7127 version: 992958 } peers { id: 138832050 store_id: 205 } peers { id: 138832052 store_id: 431 } peers { id: 540299072 store_id: 1693 } }\\\"] [region_id=139238551]\",\r\n  \"[2024/11/14 01:40:44.480 +00:00] [INFO] [apply.rs:1612] [\\\"execute admin command\\\"] [command=\\\"cmd_type: PrepareMerge prepare_merge { min_index: 305 target { id: 138832049 start_key: ? end_key: ? region_epoch { conf_ver: 7127 version: 992958 } peers { id: 138832050 store_id: 205 } peers { id: 138832052 store_id: 431 } peers { id: 540299072 store_id: 1693 } } }\\\"] [index=305] [term=188] [peer_id=1010311597] [region_id=139238551]\",\r\n  \"[2024/11/14 01:40:44.486 +00:00] [INFO] [endpoint.rs:177] [\\\"region met split/merge command, stop tracking since key range changed, wait for re-register\\\"] [req_type=PrepareMerge]\",\r\n  \"[2024/11/14 01:40:44.486 +00:00] [INFO] [endpoint.rs:414] [\\\"deregister observe region\\\"] [observe_id=ObserveId(12870)] [region_id=139238551] [store_id=Some(1693)]\",\r\n  \"[2024/11/14 01:40:44.486 +00:00] [INFO] [endpoint.rs:337] [\\\"register observe region\\\"] [region=\\\"id: 139238551 start_key: ? end_key: ? region_epoch { conf_ver: 7182 version: 992922 } peers { id: 1010311597 store_id: 1693 } peers { id: 1292018290 store_id: 205 } peers { id: 1292018291 store_id: 431 }\\\"]\",\r\n  \"[2024/11/14 01:40:44.497 +00:00] [INFO] [apply.rs:2764] [\\\"asking delegate to stop\\\"] [source_region_id=139238551] [peer_id=540299072] [region_id=138832049]\",\r\n  \"[2024/11/14 01:40:44.497 +00:00] [INFO] [apply.rs:3798] [\\\"source logs are all applied now\\\"] [peer_id=1010311597] [region_id=139238551]\",\r\n  \"[2024/11/14 01:40:44.497 +00:00] [INFO] [apply.rs:3723] [\\\"remove delegate from apply delegates\\\"] [peer_id=1010311597] [region_id=139238551]\",\r\n  \"[2024/11/14 01:40:44.497 +00:00] [INFO] [router.rs:345] [\\\"[region 139238551] shutdown mailbox\\\"]\",\r\n  \"[2024/11/14 01:40:44.499 +00:00] [INFO] [apply.rs:2786] [\\\"execute CommitMerge\\\"] [source_region=\\\"id: 139238551 start_key: ? end_key: ? region_epoch { conf_ver: 7182 version: 992922 } peers { id: 1010311597 store_id: 1693 } peers { id: 1292018290 store_id: 205 } peers { id: 1292018291 store_id: 431 }\\\"] [index=263] [term=168] [entries=1] [commit=305] [peer_id=540299072] [region_id=138832049]\",\r\n  \"[2024/11/14 01:40:44.502 +00:00] [INFO] [util.rs:1459] [\\\"reset safe_ts due to merge\\\"] [peer_id=540299072] [region_id=138832049] [safe_ts=453915034481075508] [target_safe_ts=453915034481075508] [source_safe_ts=453915035398572863]\",\r\n  \"[2024/11/14 01:40:44.502 +00:00] [INFO] [peer.rs:5626] [\\\"require updating max ts\\\"] [initial_status=721556491646] [region_id=138832049]\",\r\n  \"[2024/11/14 01:40:44.502 +00:00] [INFO] [peer.rs:4726] [\\\"merge finished\\\"] [target_region=\\\"Some(id: 138832049 start_key: ? end_key: ? region_epoch { conf_ver: 7127 version: 992958 } peers { id: 138832050 store_id: 205 } peers { id: 138832052 store_id: 431 } peers { id: 540299072 store_id: 1693 })\\\"] [peer_id=1010311597] [region_id=139238551]\",\r\n  \"[2024/11/14 01:40:44.502 +00:00] [INFO] [peer.rs:3574] [\\\"delays destroy\\\"] [reason=UnFlushLogGc] [merged_by_target=true] [peer_id=1010311597] [region_id=139238551]\",\r\n  \"[2024/11/14 01:40:44.502 +00:00] [INFO] [pd.rs:1707] [\\\"succeed to update max timestamp\\\"] [region_id=138832049]\",\r\n  \"[2024/11/14 01:40:44.510 +00:00] [INFO] [peer.rs:3584] [\\\"starts destroy\\\"] [merged_by_target=true] [peer_id=1010311597] [region_id=139238551]\",\r\n  \"[2024/11/14 01:40:44.510 +00:00] [INFO] [peer.rs:1459] [\\\"begin to destroy\\\"] [peer_id=1010311597] [region_id=139238551]\",\r\n  \"[2024/11/14 01:40:44.510 +00:00] [INFO] [pd.rs:1637] [\\\"remove peer statistic record in pd\\\"] [region_id=139238551]\",\r\n  \"[2024/11/14 01:40:44.510 +00:00] [INFO] [peer_storage.rs:1020] [\\\"finish clear peer meta\\\"] [takes=2.138Âµs] [raft_key=1] [apply_key=1] [meta_key=1] [region_id=139238551]\",\r\n  \"[2024/11/14 01:40:44.510 +00:00] [INFO] [endpoint.rs:414] [\\\"deregister observe region\\\"] [observe_id=ObserveId(12873)] [region_id=139238551] [store_id=Some(1693)]\",\r\n  \"[2024/11/14 01:40:44.512 +00:00] [WARN] [scanner.rs:95] [\\\"resolved_ts scan get snapshot failed\\\"] [err=\\\"Other(\\\\\\\"scan task cancelled\\\\\\\")\\\"]\",\r\n  \"[2024/11/14 01:40:44.518 +00:00] [INFO] [peer.rs:1563] [\\\"peer destroy itself\\\"] [keep_data=true] [clean=true] [takes=8.271467ms] [peer_id=1010311597] [region_id=139238551]\",\r\n  \"[2024/11/14 01:40:44.518 +00:00] [INFO] [router.rs:345] [\\\"[region 139238551] shutdown mailbox\\\"]\",\r\n```\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nv6.5.4\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\n### What did you expect?\r\n\r\n### What did happened?\r\n",
  "state": "closed",
  "created_at": "2024-11-18T06:17:20Z",
  "updated_at": "2024-11-19T10:37:22Z",
  "closed_at": "2024-11-19T10:37:22Z",
  "labels": [
    "type/bug",
    "severity/major",
    "affects-6.5",
    "affects-7.1",
    "affects-7.5",
    "affects-8.1",
    "affects-8.5"
  ],
  "comments_data": []
}