{
  "issue_number": 10265,
  "title": "BR backup random fails \"SignatureDoesNotMatch\" for HCP S3 storage",
  "body": "## Bug Report\r\n\r\n```sh\r\nexport AWS_ACCESS_KEY_ID=${AccessKey}\r\nexport AWS_SECRET_ACCESS_KEY=${SecretKey}\r\nbr backup db --db test --pd \"192.168.1.1:2379\" --storage \"s3://tidb/test_1/\" \\\r\n  --send-credentials-to-tikv=true --s3.endpoint \"http://a.hcp.b.c.com/\" \\\r\n  --log-file backup_db_test_1.log --ratelimit 20 --concurrency 6 --checksum-concurrency 1\r\n```\r\n\r\nBR puts lock successful, but TiKV fails to put backup sst randomly.\r\nThe s3 compatible storage is [HCP S3](https://knowledge.hitachivantara.com/Documents/Storage/HCP_for_Cloud_Scale/1.0.0/Adminstering_HCP_for_cloud_scale/Getting_started/02_Support_for_Amazon_S3_API).\r\n\r\n```\r\n[2021/05/28 10:47:26.361 +08:00] [ERROR] [backup.go:31] [\"failed to backup\"] [error=\"msg:\"Io(Custom { kind: Other, error: \"failed to put object Request ID: None Body: <?xml version=\\\\\\\\'1.0\\\\\\\\' encoding=\\\\\\\\'UTF-8\\\\\\\\'?>\r\n<Error>\r\n <Code>SignatureDoesNotMatch</Code>\r\n <Message>The request signature we calculated does not match the signature you provided. Check your HCP Secret Access Key and signing method.</Message>\r\n <RequestId>1622169935275</RequestId>\r\n <HostId>BASE64HOSTID==</HostId>\r\n <AWSAccessKeyId>BASE64KEYID==</AWSAccessKeyId>\r\n <SignatureProvided>3ad9b2eea165a2293a2b7fbd2697729394b41c64bb0f2e133b7fbcd574efb560</SignatureProvided>\r\n <StringToSign>AWS4-HMAC-SHA256\r\n20210528T024535Z\r\n20210528/us-east-1/s3/aws4_request\r\nd5c2e014f7e55b8d2338035e1229a8ac2c28976c888da8a2592a07eed72dfd31</StringToSign>\r\n <StringToSignBytes>65 87 83 52 45 72 77 65 67 45 83 72 65 50 53 54 10 50 48 50 49 48 53 50 56 84 48 50 52 53 51 53 90 10 50 48 50 49 48 53 50 56 47 117 115 45 101 97 115 116 45 49 47 115 51 47 97 119 115 52 95 114 101 113 117 101 115 116 10 100 53 99 50 101 48 49 52 102 55 101 53 53 98 56 100 50 51 51 56 48 51 53 101 49 50 50 57 97 56 97 99 50 99 50 56 57 55 54 99 56 56 56 100 97 56 97 50 53 57 50 97 48 55 101 101 100 55 50 100 102 100 51 49</StringToSignBytes>\r\n</Error>\r\n\r\n\" })\" : [BR:KV:ErrKVUnknown]unknown tikv error\"] [errorVerbose=\"[BR:KV:ErrKVUnknown]unknown tikv error\r\nmsg:\"Io(Custom { kind: Other, error: \"failed to put object Request ID: None Body: <?xml version=\\\\\\\\'1.0\\\\\\\\' encoding=\\\\\\\\'UTF-8\\\\\\\\'?>\r\n<Error>\r\n <Code>SignatureDoesNotMatch</Code>\r\n <Message>The request signature we calculated does not match the signature you provided. Check your HCP Secret Access Key and signing method.</Message>\r\n <RequestId>1622169935275</RequestId>\r\n <HostId>BASE64HOSTID==</HostId>\r\n <AWSAccessKeyId>BASE64KEYID==</AWSAccessKeyId>\r\n <SignatureProvided>3ad9b2eea165a2293a2b7fbd2697729394b41c64bb0f2e133b7fbcd574efb560</SignatureProvided>\r\n <StringToSign>AWS4-HMAC-SHA256\r\n20210528T024535Z\r\n20210528/us-east-1/s3/aws4_request\r\nd5c2e014f7e55b8d2338035e1229a8ac2c28976c888da8a2592a07eed72dfd31</StringToSign>\r\n <StringToSignBytes>65 87 83 52 45 72 77 65 67 45 83 72 65 50 53 54 10 50 48 50 49 48 53 50 56 84 48 50 52 53 51 53 90 10 50 48 50 49 48 53 50 56 47 117 115 45 101 97 115 116 45 49 47 115 51 47 97 119 115 52 95 114 101 113 117 101 115 116 10 100 53 99 50 101 48 49 52 102 55 101 53 53 98 56 100 50 51 51 56 48 51 53 101 49 50 50 57 97 56 97 99 50 99 50 56 57 55 54 99 56 56 56 100 97 56 97 50 53 57 50 97 48 55 101 101 100 55 50 100 102 100 51 49</StringToSignBytes>\r\n</Error>\r\n\r\n\" })\" \r\ngithub.com/pingcap/br/pkg/backup.(*pushDown).pushBackup\r\n\tgithub.com/pingcap/br@/pkg/backup/push.go:113\r\ngithub.com/pingcap/br/pkg/backup.(*Client).BackupRange\r\n\tgithub.com/pingcap/br@/pkg/backup/client.go:524\r\ngithub.com/pingcap/br/pkg/backup.(*Client).BackupRanges.func2.1\r\n\tgithub.com/pingcap/br@/pkg/backup/client.go:459\r\ngithub.com/pingcap/br/pkg/utils.(*WorkerPool).ApplyOnErrorGroup.func1\r\n\tgithub.com/pingcap/br@/pkg/utils/worker.go:63\r\ngolang.org/x/sync/errgroup.(*Group).Go.func1\r\n\tgolang.org/x/sync@v0.0.0-20201020160332-67f06af15bc9/errgroup/errgroup.go:57\r\nruntime.goexit\r\n\truntime/asm_amd64.s:1357\"] [stack=\"github.com/pingcap/br/cmd.runBackupCommand\r\n\tgithub.com/pingcap/br@/cmd/backup.go:31\r\ngithub.com/pingcap/br/cmd.newDBBackupCommand.func1\r\n\tgithub.com/pingcap/br@/cmd/backup.go:105\r\ngithub.com/spf13/cobra.(*Command).execute\r\n\tgithub.com/spf13/cobra@v1.0.0/command.go:842\r\ngithub.com/spf13/cobra.(*Command).ExecuteC\r\n\tgithub.com/spf13/cobra@v1.0.0/command.go:950\r\ngithub.com/spf13/cobra.(*Command).Execute\r\n\tgithub.com/spf13/cobra@v1.0.0/command.go:887\r\nmain.main\r\n\tgithub.com/pingcap/br@/main.go:58\r\nruntime.main\r\n\truntime/proc.go:203\"]\r\n```\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n\r\nTiKV v4.0.10\r\n\r\n### Steps to reproduce\r\n\r\nRun backup\r\n\r\n### What did you expect?\r\n\r\nBackup success.\r\n\r\n### What did happened?\r\n\r\nBackup fail",
  "state": "closed",
  "created_at": "2021-05-28T10:42:09Z",
  "updated_at": "2021-06-01T04:21:50Z",
  "closed_at": "2021-06-01T04:21:50Z",
  "labels": [
    "type/bug",
    "component/backup-restore"
  ],
  "comments_data": [
    {
      "id": 851793035,
      "user": "kennytm",
      "created_at": "2021-06-01T04:20:12Z",
      "body": "this is caused by pingcap/br#992. the endpoint has an extra trailing `/`. we will remove the `/` in BR."
    }
  ]
}