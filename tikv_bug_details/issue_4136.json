{
  "issue_number": 4136,
  "title": "TiKV fails to start with IPV6 address",
  "body": "**What version of Rust are you using?**\r\nRust Version:      rustc 1.29.0-nightly (4f3c7a472 2018-07-17)\r\n\r\n**What operating system and CPU are you using?**\r\nCentOS Linux release 7.4.1708 (Core)\r\n\r\n**What did you do?**\r\nI tried to start a tikv server with IPV6 address through --addr parameter:\r\n`./tikv-server --addr [2018::f816:3eff:fea5:ac16]:15013`\r\n\r\n**What did you expect to see?**\r\nThe tikv server starts successfully.\r\n\r\n**What did you see instead?**\r\nThe log shows that it connected to PD (which has successfully started with IPV6 address) and started to listen\r\n```\r\n[2019/01/28 07:46:48.979 +00:00] [INFO] [util.rs:465] [\"connected to PD leader \\\"http://[2018::f816:3eff:fe98:3c2f]:15003\\\"\"]\r\n[2019/01/28 07:46:48.979 +00:00] [INFO] [util.rs:394] [\"All PD endpoints are consistent: [\\\"[2018::f816:3eff:fe98:3c2f]:15003\\\"]\"]\r\n[2019/01/28 07:46:48.980 +00:00] [INFO] [tikv-server.rs:459] [\"connect to PD cluster 6650364636408364861\"]\r\n[2019/01/28 07:46:48.981 +00:00] [INFO] [mod.rs:343] [\"starting working thread: addr-resolver\"]\r\n[2019/01/28 07:46:49.631 +00:00] [INFO] [mod.rs:343] [\"starting working thread: storage-scheduler\"]\r\n[2019/01/28 07:46:49.632 +00:00] [INFO] [mod.rs:343] [\"starting working thread: gc-worker\"]\r\n[2019/01/28 07:46:49.633 +00:00] [INFO] [mod.rs:623] [\"Storage started.\"]\r\n[2019/01/28 07:46:49.705 +00:00] [INFO] [server.rs:111] [\"listening on [2018::f816:3eff:fea5:ac16]:15013\"]\r\n```\r\nBut after several seconds the tikv server crashed with error info:\r\n```\r\n[2019/01/28 07:47:07.639 +00:00] [ERROR] [unknown:40] [\"{\\\"created\\\":\\\"@1548661627.638584022\\\",\\\"description\\\":\\\"OS Error\\\",\\\"errno\\\":-2,\\\"file\\\":\\\"/home/jenkins/.cargo/registry/src/github.com-1ecc6299db9ec823/grpcio-sys-0.4.2/grpc/src/core/lib/iomgr/resolve_address_posix.cc\\\",\\\"file_line\\\":108,\\\"os_error\\\":\\\"Name or service not known\\\",\\\"syscall\\\":\\\"getaddrinfo\\\",\\\"target_address\\\":\\\"2018::f816:3eff:fea5:ac16:15013\\\"}\"]\r\n[2019/01/28 07:47:07.642 +00:00] [ERROR] [tikv-server.rs:216] [\"failed to create server: Grpc(BindFail(\\\"2018::f816:3eff:fea5:ac16\\\", 15013))\"]\r\n```\r\n\r\nI've tried in both 2.1.2 and 3.0.0-beta version, and it crashed with the same problem.\r\nI noticed the brackets in IPV6 address are lost in the error info above. I don't know if it matters.",
  "state": "closed",
  "created_at": "2019-01-28T08:23:23Z",
  "updated_at": "2020-08-28T11:32:43Z",
  "closed_at": "2020-08-28T11:32:43Z",
  "labels": [
    "type/bug",
    "component/gRPC"
  ],
  "comments_data": [
    {
      "id": 458093980,
      "user": "siddontang",
      "created_at": "2019-01-28T11:27:45Z",
      "body": "seem we haven't supported IPv6\r\nPlease vefity it @overvenus "
    },
    {
      "id": 458123379,
      "user": "overvenus",
      "created_at": "2019-01-28T13:05:44Z",
      "body": "@funow Thank you for your feedback!\r\n\r\nCould you show `ifconfig` and `sysctl -a | grep \"ipv6\"`?"
    },
    {
      "id": 458365489,
      "user": "funow",
      "created_at": "2019-01-29T01:04:21Z",
      "body": "ifconfig eth0\r\n```\r\neth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1450\r\n        inet 192.168.100.19  netmask 255.255.255.0  broadcast 192.168.100.255\r\n        inet6 fe80::f816:3eff:fea5:ac16  prefixlen 64  scopeid 0x20<link>\r\n        inet6 2018::f816:3eff:fea5:ac16  prefixlen 64  scopeid 0x0<global>\r\n        ether fa:16:3e:a5:ac:16  txqueuelen 1000  (Ethernet)\r\n        RX packets 384009889  bytes 169745025081 (158.0 GiB)\r\n        RX errors 0  dropped 0  overruns 0  frame 0\r\n        TX packets 396937209  bytes 170957559699 (159.2 GiB)\r\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\r\n```\r\nsysctl -a | grep \"ipv6\"\r\n```\r\nsysctl: reading key \"net.ipv6.conf.all.stable_secret\"\r\nnet.ipv6.anycast_src_echo_reply = 0\r\nnet.ipv6.bindv6only = 0\r\nnet.ipv6.conf.all.accept_dad = 1\r\nnet.ipv6.conf.all.accept_ra = 1\r\nnet.ipv6.conf.all.accept_ra_defrtr = 1\r\nnet.ipv6.conf.all.accept_ra_pinfo = 1\r\nnet.ipv6.conf.all.accept_ra_rt_info_max_plen = 0\r\nnet.ipv6.conf.all.accept_ra_rtr_pref = 1\r\nnet.ipv6.conf.all.accept_redirects = 1\r\nnet.ipv6.conf.all.accept_source_route = 0\r\nnet.ipv6.conf.all.autoconf = 1\r\nnet.ipv6.conf.all.dad_transmits = 1\r\nnet.ipv6.conf.all.disable_ipv6 = 0\r\nnet.ipv6.conf.all.force_mld_version = 0\r\nnet.ipv6.conf.all.force_tllao = 0\r\nnet.ipv6.conf.all.forwarding = 0\r\nnet.ipv6.conf.all.hop_limit = 64\r\nnet.ipv6.conf.all.max_addresses = 16\r\nnet.ipv6.conf.all.max_desync_factor = 600\r\nnet.ipv6.conf.all.mc_forwarding = 0\r\nnet.ipv6.conf.all.mldv1_unsolicited_report_interval = 10000\r\nnet.ipv6.conf.all.mldv2_unsolicited_report_interval = 1000\r\nnet.ipv6.conf.all.mtu = 1280\r\nnet.ipv6.conf.all.ndisc_notify = 0\r\nnet.ipv6.conf.all.optimistic_dad = 0\r\nnet.ipv6.conf.all.proxy_ndp = 0\r\nnet.ipv6.conf.all.regen_max_retry = 3\r\nnet.ipv6.conf.all.router_probe_interval = 60\r\nnet.ipv6.conf.all.router_solicitation_delay = 1\r\nnet.ipv6.conf.all.router_solicitation_interval = 4\r\nnet.ipv6.conf.all.router_solicitations = 3\r\nsysctl: reading key \"net.ipv6.conf.default.stable_secret\"\r\nnet.ipv6.conf.all.temp_prefered_lft = 86400\r\nnet.ipv6.conf.all.temp_valid_lft = 604800\r\nnet.ipv6.conf.all.use_tempaddr = 0\r\nnet.ipv6.conf.default.accept_dad = 1\r\nnet.ipv6.conf.default.accept_ra = 1\r\nnet.ipv6.conf.default.accept_ra_defrtr = 1\r\nnet.ipv6.conf.default.accept_ra_pinfo = 1\r\nnet.ipv6.conf.default.accept_ra_rt_info_max_plen = 0\r\nnet.ipv6.conf.default.accept_ra_rtr_pref = 1\r\nnet.ipv6.conf.default.accept_redirects = 1\r\nnet.ipv6.conf.default.accept_source_route = 0\r\nnet.ipv6.conf.default.autoconf = 1\r\nnet.ipv6.conf.default.dad_transmits = 1\r\nnet.ipv6.conf.default.disable_ipv6 = 0\r\nnet.ipv6.conf.default.force_mld_version = 0\r\nnet.ipv6.conf.default.force_tllao = 0\r\nnet.ipv6.conf.default.forwarding = 0\r\nnet.ipv6.conf.default.hop_limit = 64\r\nnet.ipv6.conf.default.max_addresses = 16\r\nnet.ipv6.conf.default.max_desync_factor = 600\r\nnet.ipv6.conf.default.mc_forwarding = 0\r\nnet.ipv6.conf.default.mldv1_unsolicited_report_interval = 10000\r\nnet.ipv6.conf.default.mldv2_unsolicited_report_interval = 1000\r\nnet.ipv6.conf.default.mtu = 1280\r\nnet.ipv6.conf.default.ndisc_notify = 0\r\nnet.ipv6.conf.default.optimistic_dad = 0\r\nnet.ipv6.conf.default.proxy_ndp = 0\r\nnet.ipv6.conf.default.regen_max_retry = 3\r\nnet.ipv6.conf.default.router_probe_interval = 60\r\nnet.ipv6.conf.default.router_solicitation_delay = 1\r\nnet.ipv6.conf.default.router_solicitation_interval = 4\r\nnet.ipv6.conf.default.router_solicitations = 3\r\nsysctl: reading key \"net.ipv6.conf.eth0.stable_secret\"\r\nnet.ipv6.conf.default.temp_prefered_lft = 86400\r\nnet.ipv6.conf.default.temp_valid_lft = 604800\r\nnet.ipv6.conf.default.use_tempaddr = 0\r\nnet.ipv6.conf.eth0.accept_dad = 1\r\nnet.ipv6.conf.eth0.accept_ra = 0\r\nnet.ipv6.conf.eth0.accept_ra_defrtr = 0\r\nnet.ipv6.conf.eth0.accept_ra_pinfo = 0\r\nnet.ipv6.conf.eth0.accept_ra_rt_info_max_plen = 0\r\nnet.ipv6.conf.eth0.accept_ra_rtr_pref = 0\r\nnet.ipv6.conf.eth0.accept_redirects = 1\r\nnet.ipv6.conf.eth0.accept_source_route = 0\r\nnet.ipv6.conf.eth0.autoconf = 1\r\nnet.ipv6.conf.eth0.dad_transmits = 1\r\nnet.ipv6.conf.eth0.disable_ipv6 = 0\r\nnet.ipv6.conf.eth0.force_mld_version = 0\r\nnet.ipv6.conf.eth0.force_tllao = 0\r\nnet.ipv6.conf.eth0.forwarding = 0\r\nnet.ipv6.conf.eth0.hop_limit = 64\r\nnet.ipv6.conf.eth0.max_addresses = 16\r\nnet.ipv6.conf.eth0.max_desync_factor = 600\r\nnet.ipv6.conf.eth0.mc_forwarding = 0\r\nnet.ipv6.conf.eth0.mldv1_unsolicited_report_interval = 10000\r\nnet.ipv6.conf.eth0.mldv2_unsolicited_report_interval = 1000\r\nnet.ipv6.conf.eth0.mtu = 1450\r\nnet.ipv6.conf.eth0.ndisc_notify = 0\r\nnet.ipv6.conf.eth0.optimistic_dad = 0\r\nnet.ipv6.conf.eth0.proxy_ndp = 0\r\nnet.ipv6.conf.eth0.regen_max_retry = 3\r\nnet.ipv6.conf.eth0.router_probe_interval = 60\r\nnet.ipv6.conf.eth0.router_solicitation_delay = 1\r\nnet.ipv6.conf.eth0.router_solicitation_interval = 4\r\nnet.ipv6.conf.eth0.router_solicitations = 3\r\nsysctl: reading key \"net.ipv6.conf.lo.stable_secret\"\r\nnet.ipv6.conf.eth0.temp_prefered_lft = 86400\r\nnet.ipv6.conf.eth0.temp_valid_lft = 604800\r\nnet.ipv6.conf.eth0.use_tempaddr = 0\r\nnet.ipv6.conf.lo.accept_dad = -1\r\nnet.ipv6.conf.lo.accept_ra = 1\r\nnet.ipv6.conf.lo.accept_ra_defrtr = 1\r\nnet.ipv6.conf.lo.accept_ra_pinfo = 1\r\nnet.ipv6.conf.lo.accept_ra_rt_info_max_plen = 0\r\nnet.ipv6.conf.lo.accept_ra_rtr_pref = 1\r\nnet.ipv6.conf.lo.accept_redirects = 1\r\nnet.ipv6.conf.lo.accept_source_route = 0\r\nnet.ipv6.conf.lo.autoconf = 1\r\nnet.ipv6.conf.lo.dad_transmits = 1\r\nnet.ipv6.conf.lo.disable_ipv6 = 0\r\nnet.ipv6.conf.lo.force_mld_version = 0\r\nnet.ipv6.conf.lo.force_tllao = 0\r\nnet.ipv6.conf.lo.forwarding = 0\r\nnet.ipv6.conf.lo.hop_limit = 64\r\nnet.ipv6.conf.lo.max_addresses = 16\r\nnet.ipv6.conf.lo.max_desync_factor = 600\r\nnet.ipv6.conf.lo.mc_forwarding = 0\r\nnet.ipv6.conf.lo.mldv1_unsolicited_report_interval = 10000\r\nnet.ipv6.conf.lo.mldv2_unsolicited_report_interval = 1000\r\nnet.ipv6.conf.lo.mtu = 65536\r\nnet.ipv6.conf.lo.ndisc_notify = 0\r\nnet.ipv6.conf.lo.optimistic_dad = 0\r\nnet.ipv6.conf.lo.proxy_ndp = 0\r\nnet.ipv6.conf.lo.regen_max_retry = 3\r\nnet.ipv6.conf.lo.router_probe_interval = 60\r\nnet.ipv6.conf.lo.router_solicitation_delay = 1\r\nnet.ipv6.conf.lo.router_solicitation_interval = 4\r\nnet.ipv6.conf.lo.router_solicitations = 3\r\nnet.ipv6.conf.lo.temp_prefered_lft = 86400\r\nnet.ipv6.conf.lo.temp_valid_lft = 604800\r\nnet.ipv6.conf.lo.use_tempaddr = -1\r\nnet.ipv6.icmp.ratelimit = 1000\r\nnet.ipv6.idgen_delay = 1\r\nnet.ipv6.idgen_retries = 3\r\nnet.ipv6.ip6frag_high_thresh = 4194304\r\nnet.ipv6.ip6frag_low_thresh = 3145728\r\nnet.ipv6.ip6frag_secret_interval = 600\r\nnet.ipv6.ip6frag_time = 60\r\nnet.ipv6.ip_nonlocal_bind = 0\r\nnet.ipv6.mld_max_msf = 64\r\nnet.ipv6.mld_qrv = 2\r\nnet.ipv6.neigh.default.anycast_delay = 100\r\nnet.ipv6.neigh.default.app_solicit = 0\r\nnet.ipv6.neigh.default.base_reachable_time_ms = 30000\r\nnet.ipv6.neigh.default.delay_first_probe_time = 5\r\nnet.ipv6.neigh.default.gc_interval = 30\r\nnet.ipv6.neigh.default.gc_stale_time = 60\r\nnet.ipv6.neigh.default.gc_thresh1 = 128\r\nnet.ipv6.neigh.default.gc_thresh2 = 512\r\nnet.ipv6.neigh.default.gc_thresh3 = 1024\r\nnet.ipv6.neigh.default.locktime = 0\r\nnet.ipv6.neigh.default.mcast_solicit = 3\r\nnet.ipv6.neigh.default.proxy_delay = 80\r\nnet.ipv6.neigh.default.proxy_qlen = 64\r\nnet.ipv6.neigh.default.retrans_time_ms = 1000\r\nnet.ipv6.neigh.default.ucast_solicit = 3\r\nnet.ipv6.neigh.default.unres_qlen = 31\r\nnet.ipv6.neigh.default.unres_qlen_bytes = 65536\r\nnet.ipv6.neigh.eth0.anycast_delay = 100\r\nnet.ipv6.neigh.eth0.app_solicit = 0\r\nnet.ipv6.neigh.eth0.base_reachable_time_ms = 30000\r\nnet.ipv6.neigh.eth0.delay_first_probe_time = 5\r\nnet.ipv6.neigh.eth0.gc_stale_time = 60\r\nnet.ipv6.neigh.eth0.locktime = 0\r\nnet.ipv6.neigh.eth0.mcast_solicit = 3\r\nnet.ipv6.neigh.eth0.proxy_delay = 80\r\nnet.ipv6.neigh.eth0.proxy_qlen = 64\r\nnet.ipv6.neigh.eth0.retrans_time_ms = 1000\r\nnet.ipv6.neigh.eth0.ucast_solicit = 3\r\nnet.ipv6.neigh.eth0.unres_qlen = 31\r\nnet.ipv6.neigh.eth0.unres_qlen_bytes = 65536\r\nnet.ipv6.neigh.lo.anycast_delay = 100\r\nnet.ipv6.neigh.lo.app_solicit = 0\r\nnet.ipv6.neigh.lo.base_reachable_time_ms = 30000\r\nnet.ipv6.neigh.lo.delay_first_probe_time = 5\r\nnet.ipv6.neigh.lo.gc_stale_time = 60\r\nnet.ipv6.neigh.lo.locktime = 0\r\nnet.ipv6.neigh.lo.mcast_solicit = 3\r\nnet.ipv6.neigh.lo.proxy_delay = 80\r\nnet.ipv6.neigh.lo.proxy_qlen = 64\r\nnet.ipv6.neigh.lo.retrans_time_ms = 1000\r\nnet.ipv6.neigh.lo.ucast_solicit = 3\r\nnet.ipv6.neigh.lo.unres_qlen = 31\r\nnet.ipv6.neigh.lo.unres_qlen_bytes = 65536\r\nnet.ipv6.route.gc_elasticity = 9\r\nnet.ipv6.route.gc_interval = 30\r\nnet.ipv6.route.gc_min_interval = 0\r\nnet.ipv6.route.gc_min_interval_ms = 500\r\nnet.ipv6.route.gc_thresh = 1024\r\nnet.ipv6.route.gc_timeout = 60\r\nnet.ipv6.route.max_size = 16384\r\nnet.ipv6.route.min_adv_mss = 1220\r\nnet.ipv6.route.mtu_expires = 600\r\nnet.ipv6.xfrm6_gc_thresh = 32768\r\n```\r\n"
    },
    {
      "id": 459419713,
      "user": "overvenus",
      "created_at": "2019-01-31T16:54:19Z",
      "body": "It is indeed caused by losting brackets. We lost brackets at this line https://github.com/pingcap/grpc-rs/blob/64eb515abd29005107cafb633d97c548147d0691/src/server.rs#L99."
    }
  ]
}