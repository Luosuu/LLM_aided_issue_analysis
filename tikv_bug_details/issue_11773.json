{
  "issue_number": 11773,
  "title": "cloud: build failed when `grpc` or `dylib` backend enabled.",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nMaster.\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\nLinux ip-172-16-5-31 3.10.0-862.14.4.el7.x86_64 #1 SMP Wed Sep 26 15:12:11 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\nIntel(R) Xeon(R) CPU E5-2630 v4 @ 2.20GHz * 2\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n`ENABLE_FEATURES=cloud-storage-dylib make build` or `ENABLE_FEATURES=cloud-storage-grpc make build`\r\n\r\n### What did you expect?\r\nbuild success.\r\n\r\n### What did happened?\r\nfailed to build.\r\n\r\n```\r\nSome errors have detailed explanations: E0050, E0053, E0061, E0195, E0277, E0412, E0432, E0433, E0599...\r\nFor more information about an error, try `rustc --explain E0050`.\r\nerror: could not compile `external_storage` due to 19 previous errors\r\nwarning: build failed, waiting for other jobs to finish...\r\nerror: build failed\r\nmake: *** [Makefile:155: build] Error 101\r\n```\r\n\r\nNOTE: \r\nThose features is never enabled by any build path in the `makefile`. I'm not sure this problem really matters. \r\n",
  "state": "open",
  "created_at": "2022-01-04T07:02:17Z",
  "updated_at": "2022-01-10T20:10:28Z",
  "closed_at": null,
  "labels": [
    "type/bug",
    "severity/minor"
  ],
  "comments_data": [
    {
      "id": 1004571996,
      "user": "YuJuncen",
      "created_at": "2022-01-04T07:07:08Z",
      "body": "This might be caused by the refactoring of external storage (#11770 and #11166). But according to the error message, seems there are more errors than expected. ðŸ¤”\r\n\r\nI guess maybe these features haven't get ready for now? Or how can I build them properly? cc @gregwebs \r\n\r\n<details>\r\n\r\n```\r\n  --> components/external_storage/src/request.rs:11:5\r\n   |\r\n11 | use tokio_util::compat::Tokio02AsyncReadCompatExt;\r\n   |     ^^^^^^^^^^^^^^^^^^^^-------------------------\r\n   |     |                   |\r\n   |     |                   help: a similar name exists in the module: `TokioAsyncReadCompatExt`\r\n   |     no `Tokio02AsyncReadCompatExt` in `compat`\r\n\r\nerror[E0432]: unresolved import `anyhow`\r\n --> components/external_storage/src/dylib_client.rs:8:5\r\n  |\r\n8 | use anyhow::Context;\r\n  |     ^^^^^^ use of undeclared crate or module `anyhow`\r\n\r\nerror[E0432]: unresolved import `anyhow`\r\n --> components/external_storage/src/request.rs:3:5\r\n  |\r\n3 | use anyhow::Context;\r\n  |     ^^^^^^ use of undeclared crate or module `anyhow`\r\n\r\nerror[E0433]: failed to resolve: use of undeclared crate or module `anyhow`\r\n  --> components/external_storage/src/dylib_client.rs:71:16\r\n   |\r\n71 |         (|| -> anyhow::Result<()> {\r\n   |                ^^^^^^ use of undeclared crate or module `anyhow`\r\n\r\nerror[E0433]: failed to resolve: use of undeclared crate or module `anyhow`\r\n  --> components/external_storage/src/request.rs:21:12\r\n   |\r\n21 |     (|| -> anyhow::Result<proto::ExternalStorageWriteRequest> {\r\n   |            ^^^^^^ use of undeclared crate or module `anyhow`\r\n\r\nerror[E0433]: failed to resolve: could not find `ExternalStorageWriteRequest` in `proto`\r\n  --> components/external_storage/src/request.rs:39:30\r\n   |\r\n39 |         let mut req = proto::ExternalStorageWriteRequest::default();\r\n   |                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^ could not find `ExternalStorageWriteRequest` in `proto`\r\n\r\nerror[E0433]: failed to resolve: use of undeclared crate or module `anyhow`\r\n  --> components/external_storage/src/request.rs:75:36\r\n   |\r\n75 | pub fn anyhow_to_io_log_error(err: anyhow::Error) -> io::Error {\r\n   |                                    ^^^^^^ use of undeclared crate or module `anyhow`\r\n\r\nerror[E0412]: cannot find type `ExternalStorageWriteRequest` in module `proto`\r\n    --> components/external_storage/src/request.rs:20:24\r\n     |\r\n20   | ) -> io::Result<proto::ExternalStorageWriteRequest> {\r\n     |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: a struct with a similar name exists: `ExternalStorageSaveRequest`\r\n     | \r\n    ::: /data4/juncen/developer/tikv/target/debug/build/kvproto-ae98678c965d5aa6/out/protos/brpb.rs:7377:1\r\n     |\r\n7377 | pub struct ExternalStorageSaveRequest {\r\n     | ------------------------------------- similarly named struct `ExternalStorageSaveRequest` defined here\r\n\r\nerror[E0412]: cannot find type `ExternalStorageWriteRequest` in module `proto`\r\n    --> components/external_storage/src/request.rs:21:34\r\n     |\r\n21   |     (|| -> anyhow::Result<proto::ExternalStorageWriteRequest> {\r\n     |                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: a struct with a similar name exists: `ExternalStorageSaveRequest`\r\n     | \r\n    ::: /data4/juncen/developer/tikv/target/debug/build/kvproto-ae98678c965d5aa6/out/protos/brpb.rs:7377:1\r\n     |\r\n7377 | pub struct ExternalStorageSaveRequest {\r\n     | ------------------------------------- similarly named struct `ExternalStorageSaveRequest` defined here\r\n\r\nerror[E0195]: lifetime parameters or bounds on method `write` do not match the trait declaration\r\n  --> components/external_storage/src/dylib_client.rs:64:13\r\n   |\r\n64 |     fn write(\r\n   |             ^ lifetimes do not match method in trait\r\n   | \r\n  ::: components/external_storage/src/lib.rs:68:1\r\n   |\r\n68 | #[async_trait]\r\n   | -------------- lifetimes in impl do not match this method in trait\r\n\r\nerror[E0053]: method `read` has an incompatible type for trait\r\n  --> components/external_storage/src/dylib_client.rs:91:5\r\n   |\r\n91 |     fn read(&self, _name: &str) -> Box<dyn AsyncRead + Unpin> {\r\n   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected trait `futures::AsyncRead + Unpin + std::marker::Send`, found trait `futures::AsyncRead + Unpin`\r\n   | \r\n  ::: components/external_storage/src/lib.rs:78:5\r\n   |\r\n78 |     fn read(&self, name: &str) -> Box<DynAsyncReadRef<'_>>;\r\n   |     ------------------------------------------------------- type in trait\r\n   |\r\n   = note: expected fn pointer `fn(&dylib_client::ExternalStorageClient, &str) -> Box<dyn futures::AsyncRead + Unpin + std::marker::Send>`\r\n              found fn pointer `fn(&dylib_client::ExternalStorageClient, &str) -> Box<(dyn futures::AsyncRead + Unpin + 'static)>`\r\n\r\nerror[E0050]: method `restore` has 5 parameters but the declaration in trait `ExternalStorage::restore` has 6\r\n   --> components/external_storage/src/dylib_client.rs:96:9\r\n    |\r\n96  | /         &self,\r\n97  | |         storage_name: &str,\r\n98  | |         restore_name: std::path::PathBuf,\r\n99  | |         expected_length: u64,\r\n100 | |         speed_limiter: &Limiter,\r\n    | |_______________________________^ expected 6 parameters, found 5\r\n    | \r\n   ::: components/external_storage/src/lib.rs:82:9\r\n    |\r\n82  | /         &self,\r\n83  | |         storage_name: &str,\r\n84  | |         restore_name: std::path::PathBuf,\r\n85  | |         expected_length: u64,\r\n86  | |         speed_limiter: &Limiter,\r\n87  | |         file_crypter: Option<FileEncryptionInfo>,\r\n    | |________________________________________________- trait requires 6 parameters\r\n\r\n   Compiling pd_client v0.1.0 (/data4/juncen/developer/tikv/components/pd_client)\r\nerror[E0624]: associated function `new` is private\r\n   --> components/external_storage/src/dylib_client.rs:32:28\r\n    |\r\n32  |     let runtime = Builder::new()\r\n    |                            ^^^ private associated function\r\n    | \r\n   ::: /data4/juncen/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/builder.rs:117:5\r\n    |\r\n117 |     pub(crate) fn new(kind: Kind) -> Builder {\r\n    |     ---------------------------------------- private associated function defined here\r\n\r\nerror[E0061]: this function takes 1 argument but 0 arguments were supplied\r\n   --> components/external_storage/src/dylib_client.rs:32:19\r\n    |\r\n32  |     let runtime = Builder::new()\r\n    |                   ^^^^^^^^^^^^-- supplied 0 arguments\r\n    |                   |\r\n    |                   expected 1 argument\r\n    |\r\nnote: associated function defined here\r\n   --> /data4/juncen/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/builder.rs:117:19\r\n    |\r\n117 |     pub(crate) fn new(kind: Kind) -> Builder {\r\n    |                   ^^^\r\n\r\nerror[E0599]: no method named `basic_scheduler` found for struct `tokio::runtime::Builder` in the current scope\r\n  --> components/external_storage/src/dylib_client.rs:33:10\r\n   |\r\n33 |         .basic_scheduler()\r\n   |          ^^^^^^^^^^^^^^^ method not found in `tokio::runtime::Builder`\r\n\r\nerror[E0061]: this function takes 0 arguments but 1 argument was supplied\r\n   --> components/external_storage/src/request.rs:27:17\r\n    |\r\n27  |           runtime.enter(|| {\r\n    |  _________________^^^^^_-\r\n    | |                 |\r\n    | |                 expected 0 arguments\r\n28  | |             block_on(async {\r\n29  | |                 let msg = |action: &str| format!(\"{} file {:?}\", action, &file_path);\r\n30  | |                 let f = tokio::fs::File::create(file_path.clone())\r\n...   |\r\n37  | |             })\r\n38  | |         })?;\r\n    | |_________- supplied 1 argument\r\n    |\r\nnote: associated function defined here\r\n   --> /data4/juncen/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/mod.rs:499:16\r\n    |\r\n499 |         pub fn enter(&self) -> EnterGuard<'_> {\r\n    |                ^^^^^\r\n\r\nerror[E0599]: no method named `context` found for enum `Result` in the current scope\r\n  --> components/external_storage/src/request.rs:32:22\r\n   |\r\n32 |                     .context(msg(\"create\"))?;\r\n   |                      ^^^^^^^ method not found in `Result<tokio::fs::File, futures_io::Error>`\r\n\r\nerror[E0599]: no method named `context` found for enum `Result` in the current scope\r\n  --> components/external_storage/src/request.rs:36:22\r\n   |\r\n36 |                     .context(msg(\"copy\"))\r\n   |                      ^^^^^^^ method not found in `Result<u64, futures_io::Error>`\r\n\r\nerror[E0277]: the `?` operator can only be applied to values that implement `Try`\r\n   --> components/external_storage/src/request.rs:27:9\r\n    |\r\n27  | /         runtime.enter(|| {\r\n28  | |             block_on(async {\r\n29  | |                 let msg = |action: &str| format!(\"{} file {:?}\", action, &file_path);\r\n30  | |                 let f = tokio::fs::File::create(file_path.clone())\r\n...   |\r\n37  | |             })\r\n38  | |         })?;\r\n    | |___________^ the `?` operator cannot be applied to type `EnterGuard<'_>`\r\n    |\r\n    = help: the trait `Try` is not implemented for `EnterGuard<'_>`\r\nnote: required by `branch`\r\n   --> /data4/juncen/.rustup/toolchains/nightly-2021-07-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/try_trait.rs:218:5\r\n    |\r\n218 |     fn branch(self) -> ControlFlow<Self::Residual, Self::Output>;\r\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\nSome errors have detailed explanations: E0050, E0053, E0061, E0195, E0277, E0412, E0432, E0433, E0599...\r\nFor more information about an error, try `rustc --explain E0050`.\r\nerror: could not compile `external_storage` due to 19 previous errors\r\nwarning: build failed, waiting for other jobs to finish...\r\nerror: build failed\r\nmake: *** [Makefile:155: build] Error 101\r\n```\r\n\r\n</details>"
    },
    {
      "id": 1004573033,
      "user": "YuJuncen",
      "created_at": "2022-01-04T07:09:28Z",
      "body": "/label type/bug"
    },
    {
      "id": 1004573045,
      "user": "ti-chi-bot",
      "created_at": "2022-01-04T07:09:29Z",
      "body": "@YuJuncen: The label(s) `type/bug` cannot be applied. These labels are supported: `challenge-program, compatibility-breaker, high-performance, hptc, needs-cherry-pick-2.1, needs-cherry-pick-3.0, needs-cherry-pick-3.1, needs-cherry-pick-4.0, needs-cherry-pick-5.0, needs-cherry-pick-5.1, needs-cherry-pick-5.2, needs-cherry-pick-5.3, needs-cherry-pick-5.4, wontfix, do-not-merge/cherry-pick-not-approved`.\n\n<details>\n\nIn response to [this](https://github.com/tikv/tikv/issues/11773#issuecomment-1004573033):\n\n>/label type/bug\n\n\nInstructions for interacting with me using PR comments are available [here](https://prow.tidb.io/command-help).  If you have questions or suggestions related to my behavior, please file an issue against the [ti-community-infra/tichi](https://github.com/ti-community-infra/tichi/issues/new?title=Prow%20issue:) repository.\n</details>"
    },
    {
      "id": 1004573323,
      "user": "YuJuncen",
      "created_at": "2022-01-04T07:10:02Z",
      "body": "/type bug"
    },
    {
      "id": 1004727950,
      "user": "Lily2025",
      "created_at": "2022-01-04T11:24:18Z",
      "body": "/severity Moderate"
    },
    {
      "id": 1007192544,
      "user": "YuJuncen",
      "created_at": "2022-01-07T07:18:48Z",
      "body": "@Lily2025 The failure of those 2 features hasn't made any problem. And them probably(I guess) only for testing or development usage. This build would fail at least from https://github.com/tikv/tikv/pull/11166 get merged (which is 2 months ago) and I haven't get any complain about that. \r\n\r\nSo I guess we can make it a minor bug?\r\n\r\n/severity Minor"
    },
    {
      "id": 1007353905,
      "user": "xiejiandong",
      "created_at": "2022-01-07T12:02:14Z",
      "body": "The issue can observed from release v5.1.0-alphaï¼Œv5.1ï¼Œv5.2ï¼Œv5.3ï¼Œv5.4-alpha ï¼› But v5.0.6 is good;\r\nOne error exampleï¼š\r\n![image](https://user-images.githubusercontent.com/730786/148541448-2450ba74-542e-44a7-98ab-334b5b8b1839.png)\r\n"
    },
    {
      "id": 1007840824,
      "user": "xiejiandong",
      "created_at": "2022-01-08T00:30:52Z",
      "body": "Hi, @Lily2025ï¼Œcan you refer the issue fix to https://github.com/tikv/tikv/pull/11820\r\nThis bug might fixed by @gregwebs "
    },
    {
      "id": 1009301900,
      "user": "gregwebs",
      "created_at": "2022-01-10T20:10:28Z",
      "body": "PR is available now."
    }
  ]
}