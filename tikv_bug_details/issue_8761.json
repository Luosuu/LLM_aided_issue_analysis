{
  "issue_number": 8761,
  "title": " Mutex conflict of encryption makes pd-worker deal with heartbeat slow.",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\nTiKV manages encryption keys and files in a hashmap with mutex. It will cause serious conflict when multiple thread try to \r\n update it.\r\nThere is stack info of conflict.\r\n```\r\nThread 76 (LWP 125):\r\n#0  0x00007f154f93e3f5 in pthread_rwlock_wrlock () from target:/usr/glibc-compat/lib/libpthread.so.0\r\n#1  0x000056144c875a0a in <encryption::manager::DataKeyManager as engine_traits::encryption::EncryptionKeyManager>::get_file (self=<optimized out>, fname=...) at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/sys/unix/rwlock.rs:71\r\n#2  0x000056144c8bbd81 in <engine_rocks::encryption::WrappedEncryptionKeyManager<T> as rocksdb::encryption::EncryptionKeyManager>::get_file (self=<optimized out>, fname=...) at components/engine_rocks/src/encryption.rs:38\r\n#3  0x000056144cdc624e in rocksdb::encryption::encryption_key_manager_get_file (ctx=0x7f1514f1d8e0, fname=0x7f0c64227c98 \"/var/lib/tikv/db/436261.sst\", file_info=0x7f14ac3f0560) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/src/encryption.rs:95\r\n#4  0x000056144d59139a in crocksdb_encryption_key_manager_impl_t::GetFile (this=<optimized out>, fname=..., file_info=<optimized out>) at crocksdb/c.cc:3765\r\n#5  0x000056144d7276aa in rocksdb::encryption::AESEncryptionProvider::CreateCipherStream (this=<optimized out>, fname=..., result=0x7f14ac3f06a0) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/encryption/encryption.cc:226\r\n#6  0x000056144d72f2cc in rocksdb::EncryptedEnv::NewRandomAccessFile (this=0x7f1514f1f100, fname=..., result=0x7f14ac3f0820, options=...) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/env/env_encryption.cc:474\r\n#7  0x000056144d727d85 in rocksdb::encryption::KeyManagedEncryptedEnv::NewRandomAccessFile (this=<optimized out>, fname=..., result=0x7f14ac3f0820, options=...) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/encryption/encryption.cc:290\r\n#8  0x000056144d6fa5f0 in rocksdb::Version::GetTableProperties (this=this@entry=0x7f14fef28000, tp=tp@entry=0x7f14ac3f09a0, file_meta=0x7f1504426500, fname=fname@entry=0x7f14ac3f0990) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/db/version_set.cc:1221\r\n#9  0x000056144d705bf6 in rocksdb::Version::GetPropertiesOfTablesInRange (this=this@entry=0x7f14fef28000, range=range@entry=0x7f103ec2e300, n=n@entry=1, props=props@entry=0x7f10d00c9440) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/db/version_set.cc:1297\r\n#10 0x000056144d636b55 in rocksdb::DBImpl::GetPropertiesOfTablesInRange (this=0x7f15050c6000, column_family=<optimized out>, range=0x7f103ec2e300, n=1, props=0x7f10d00c9440) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/db/db_impl/db_impl.cc:2544\r\n#11 0x000056144d5a13da in crocksdb_get_properties_of_tables_in_range (db=0x7f154f0a9be8, cf=0x7f154f0a9be0, num_ranges=<optimized out>, start_keys=<optimized out>, start_keys_lens=<optimized out>, limit_keys=<optimized out>, limit_keys_lens=0x7f13e09718f0, errptr=0x7f14ac3f0b70) at crocksdb/c.cc:4846\r\n#12 0x000056144c88adc4 in engine_rocks::table_properties::<impl engine_traits::table_properties::TablePropertiesExt for engine_rocks::engine::RocksEngine>::get_properties_of_tables_in_range (self=<optimized out>, cf=<optimized out>, ranges=...) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/src/rocksdb.rs:1777\r\n#13 0x000056144c48f100 in raftstore::coprocessor::split_check::size::get_region_approximate_size_cf (db=0x7f14ac3f2798, cfname=..., region=<optimized out>, large_threshold=0) at /home/jenkins/agent/workspace/ld_tikv_multi_branch_release-4.0/tikv/components/engine_traits/src/table_properties.rs:39\r\n#14 0x000056144c4870f4 in raftstore::coprocessor::split_check::size::get_region_approximate_size (db=0x7f14ac3f2798, region=0x7f14ac3f13d0, large_threshold=0) at /home/jenkins/agent/workspace/ld_tikv_multi_branch_release-4.0/tikv/components/raftstore/src/coprocessor/split_check/size.rs:211\r\n#15 0x000056144c48187d in <raftstore::store::worker::pd::Runner<T> as tikv_util::worker::future::Runnable<raftstore::store::worker::pd::Task>>::run (self=0x7f14ac3f26d8, task=..., handle=0x7f14ac3f2698) at components/raftstore/src/store/worker/pd.rs:953\r\n#16 0x000056144c47f1e9 in futures::task_impl::Spawn<T>::enter::{{closure}} () at /home/jenkins/agent/workspace/ld_tikv_multi_branch_release-4.0/tikv/components/tikv_util/src/worker/future.rs:108\r\n#17 0x000056144c47ec6b in futures::task_impl::Spawn<T>::enter::{{closure}} () at /rust/registry/src/github.com-1ecc6299db9ec823/futures-0.1.29/src/task_impl/std/mod.rs:83\r\n#18 0x000056144c47da48 in std::sys_common::backtrace::__rust_begin_short_backtrace (f=...) at /rust/registry/src/github.com-1ecc6299db9ec823/futures-0.1.29/src/task_impl/std/mod.rs:83\r\n#19 0x000056144c47ccd9 in core::ops::function::FnOnce::call_once{{vtable-shim}} () at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/thread/mod.rs:469\r\n#20 0x000056144cf7347f in <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once () at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/liballoc/boxed.rs:1022\r\n#21 0x000056144cf75ec0 in std::sys::unix::thread::Thread::new::thread_start () at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/liballoc/boxed.rs:1022\r\n#22 0x00007f154f938f30 in ?? () from target:/usr/glibc-compat/lib/libpthread.so.0\r\n#23 0x00007f154f84627f in clone () from target:/usr/glibc-compat/lib/libc.so.6\r\n\r\nThread 28 (LWP 58):\r\n#0  0x00007f154f93e3f5 in pthread_rwlock_wrlock () from target:/usr/glibc-compat/lib/libpthread.so.0\r\n#1  0x000056144c875a0a in <encryption::manager::DataKeyManager as engine_traits::encryption::EncryptionKeyManager>::get_file (self=<optimized out>, fname=...) at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/sys/unix/rwlock.rs:71\r\n#2  0x000056144c8bbd81 in <engine_rocks::encryption::WrappedEncryptionKeyManager<T> as rocksdb::encryption::EncryptionKeyManager>::get_file (self=<optimized out>, fname=...) at components/engine_rocks/src/encryption.rs:38\r\n#3  0x000056144cdc624e in rocksdb::encryption::encryption_key_manager_get_file (ctx=0x7f1514f1d8e0, fname=0x7f14e4004a18 \"/var/lib/tikv/db/1937991.sst\", file_info=0x7f15093f9180) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/src/encryption.rs:95\r\n#4  0x000056144d59139a in crocksdb_encryption_key_manager_impl_t::GetFile (this=<optimized out>, fname=..., file_info=<optimized out>) at crocksdb/c.cc:3765\r\n#5  0x000056144d7276aa in rocksdb::encryption::AESEncryptionProvider::CreateCipherStream (this=<optimized out>, fname=..., result=0x7f15093f92c0) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/encryption/encryption.cc:226\r\n#6  0x000056144d72ea24 in rocksdb::EncryptedEnv::NewWritableFile (this=0x7f1514f1f100, fname=..., result=0x7f15093f94f0, options=...) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/env/env_encryption.cc:515\r\n#7  0x000056144d72817f in rocksdb::encryption::KeyManagedEncryptedEnv::NewWritableFile (this=0x7f154f1f9d80, fname=..., result=0x7f15093f94f0, options=...) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/encryption/encryption.cc:314\r\n#8  0x000056144d7d7672 in rocksdb::NewWritableFile (env=<optimized out>, fname=..., result=result@entry=0x7f15093f94f0, options=...) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/util/file_reader_writer.cc:1043\r\n#9  0x000056144d95a847 in rocksdb::CompactionJob::OpenCompactionOutputFile (this=this@entry=0x7f15093fa0a0, sub_compact=sub_compact@entry=0x7f14e3ee9b80) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/db/compaction/compaction_job.cc:1445\r\n#10 0x000056144d95bfca in rocksdb::CompactionJob::ProcessKeyValueCompaction (this=this@entry=0x7f15093fa0a0, sub_compact=0x7f14e3ee9b80) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/db/compaction/compaction_job.cc:923\r\n#11 0x000056144d95d900 in rocksdb::CompactionJob::Run (this=this@entry=0x7f15093fa0a0) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/db/compaction/compaction_job.cc:590\r\n#12 0x000056144d67f7f1 in rocksdb::DBImpl::BackgroundCompaction (this=this@entry=0x7f15050c6000, made_progress=made_progress@entry=0x7f15093fa50e, job_context=job_context@entry=0x7f15093fa530, log_buffer=log_buffer@entry=0x7f15093fa700, prepicked_compaction=prepicked_compaction@entry=0x0, thread_pri=thread_pri@entry=rocksdb::Env::LOW) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/db/db_impl/db_impl_compaction_flush.cc:2759\r\n#13 0x000056144d6841b2 in rocksdb::DBImpl::BackgroundCallCompaction (this=this@entry=0x7f15050c6000, prepicked_compaction=prepicked_compaction@entry=0x0, bg_thread_pri=bg_thread_pri@entry=rocksdb::Env::LOW) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/db/db_impl/db_impl_compaction_flush.cc:2317\r\n#14 0x000056144d6846aa in rocksdb::DBImpl::BGWorkCompaction (arg=<optimized out>) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/db/db_impl/db_impl_compaction_flush.cc:2092\r\n#15 0x000056144d98c02a in rocksdb::ThreadPoolImpl::Impl::BGThread (this=this@entry=0x7f154f01fea0, thread_id=thread_id@entry=4) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/util/threadpool_imp.cc:266\r\n#16 0x000056144d98c21e in rocksdb::ThreadPoolImpl::Impl::BGThreadWrapper (arg=0x7f1514f1dc70) at /rust/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/41afbae/librocksdb_sys/rocksdb/util/threadpool_imp.cc:307\r\n#17 0x000056144d8d8830 in execute_native_thread_routine ()\r\n#18 0x00007f154f938f30 in ?? () from target:/usr/glibc-compat/lib/libpthread.so.0\r\n#19 0x00007f154f84627f in clone () from target:/usr/glibc-compat/lib/libc.so.6\r\n```\r\n\r\nThere is code about encryption:\r\n```\r\nimpl EncryptionKeyManager for DataKeyManager {\r\n    // Get key to open existing file.\r\n    fn get_file(&self, fname: &str) -> IoResult<FileEncryptionInfo> {\r\n        let mut dicts = self.dicts.write().unwrap();\r\n        .........\r\n   }\r\n}\r\n```\r\nSee more details in https://github.com/tikv/tikv/blob/master/components/encryption/src/manager/mod.rs#L497\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nv4.0.6\r\n\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\nOpen encryption and make a large compaction flow. Compaction job will create and delete files which will acquire lock for encryption.\r\n\r\n### What did you expect?\r\n\r\n### What did happened?\r\n\r\n- TiKV can not report to PD because the report thread hung for mutex conflict.\r\n- TiKV OOM because a large of heartbeat msg sent to the report thread waiting in channel.",
  "state": "closed",
  "created_at": "2020-09-28T04:36:35Z",
  "updated_at": "2020-10-21T07:01:58Z",
  "closed_at": "2020-10-21T07:01:53Z",
  "labels": [
    "type/bug",
    "sig/engine",
    "component/security",
    "severity/major",
    "need-more-info"
  ],
  "comments_data": [
    {
      "id": 706765001,
      "user": "yiwu-arbug",
      "created_at": "2020-10-11T20:37:40Z",
      "body": "https://github.com/tikv/tikv/pull/8805"
    },
    {
      "id": 713355629,
      "user": "ti-srebot",
      "created_at": "2020-10-21T07:01:57Z",
      "body": "## Please edit this comment to complete the following information\n\n### Not a bug\n\n1. Remove the 'type/bug' label\n2. Add notes to indicate why it is not a bug\n\n### Duplicate bug\n\n1. Add the 'type/duplicate' label\n2. Add the link to the original bug\n\n### Bug\n\nNote: Make Sure that 'component', and 'severity' labels are added\nExample for how to fill out the template: https://github.com/pingcap/tidb/issues/20100\n\n#### 1. Root Cause Analysis (RCA)\n<!-- Write down the reason why this bug occurs -->\n\n#### 2. Symptom\n\n<!-- What will the user see when this bug occurs. The error message may be in the terminal, log or monitoring -->\n\n#### 3. All Trigger Conditions\n\n<!-- All the user scenarios that may trigger this bug -->\n\n#### 4. Workaround (optional)\n\n#### 5. Affected versions\n\n<!--\nIn the format of [start_version:end_version], multiple version ranges are\naccepted. If the bug only affects the unreleased version, please input:\n\"unreleased\". For example:\n\nNotes:\n  1. Do not use any white spaces in '[]'.\n  2. The range in '[]' is a closed interval\n  3. The version format is `v$Major.$Minor.$Patch`, the $Majoy and $Minor\n     number in a version range should be the same. [v3.0.1:v3.1.2] is\n     invalid because the $Minor number of the version range is different.\n\nExample 1: [v3.0.1:v3.0.5], [v4.0.1:v4.0.5]\nExample 2: unreleased\n-->\n\n#### 6. Fixed versions\n\n<!--\nThe first released version that contains this fix in each minor version. If the bug's affected version has been released, the fixed version should be a detailed version number; If the bug doesn't affect any released version, the fixed version can be \"master\". \n\nExample 1: v3.0.13, v4.0.5\nExample 2: master\n-->"
    }
  ]
}