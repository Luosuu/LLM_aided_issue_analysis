{
  "issue_number": 8783,
  "title": "maybe_create_peer_internal fails due to hashmap entry not found",
  "body": "## Bug Report\r\n\r\nPanic found when enables the random-merge scheduler.\r\n\r\n```\r\n[2020/10/04 08:27:59.846 +08:00] [FATAL] [lib.rs:481] [\"no entry found for key\"] [backtrace=\"stack backtrace:\r\n   0: tikv_util::set_panic_hook::{{closure}}\r\n             at components/tikv_util/src/lib.rs:480\r\n   1: std::panicking::rust_panic_with_hook\r\n             at src/libstd/panicking.rs:524\r\n   2: rust_begin_unwind\r\n             at src/libstd/panicking.rs:431\r\n   3: core::panicking::panic_fmt\r\n             at src/libcore/panicking.rs:85\r\n   4: core::option::expect_failed\r\n             at src/libcore/option.rs:1261\r\n   5: core::option::Option<T>::expect\r\n             at /home/stn/.rustup/toolchains/nightly-2020-07-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore/option.rs:344\r\n      <std::collections::hash::map::HashMap<K,V,S> as core::ops::index::Index<&Q>>::index\r\n             at /home/stn/.rustup/toolchains/nightly-2020-07-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libstd/collections/hash/map.rs:1034\r\n      raftstore::store::fsm::store::StoreFsmDelegate<EK,ER,T,C>::maybe_create_peer_internal\r\n             at /home/stn/tikv/components/raftstore/src/store/fsm/store.rs:1728\r\n      raftstore::store::fsm::store::StoreFsmDelegate<EK,ER,T,C>::maybe_create_peer\r\n             at /home/stn/tikv/components/raftstore/src/store/fsm/store.rs:1671\r\n      raftstore::store::fsm::store::StoreFsmDelegate<EK,ER,T,C>::on_raft_message\r\n             at /home/stn/tikv/components/raftstore/src/store/fsm/store.rs:1603\r\n   6: raftstore::store::fsm::store::StoreFsmDelegate<EK,ER,T,C>::handle_msgs\r\n             at /home/stn/tikv/components/raftstore/src/store/fsm/store.rs:575\r\n      <raftstore::store::fsm::store::RaftPoller<EK,ER,T,C> as batch_system::batch::PollHandler<raftstore::store::fsm::peer::PeerFsm<EK,ER>,raftstore::store::fsm::store::StoreFsm<EK>>>::handle_control\r\n             at /home/stn/tikv/components/raftstore/src/store/fsm/store.rs:823\r\n      batch_system::batch::Poller<N,C,Handler>::poll\r\n             at /home/stn/tikv/components/batch-system/src/batch.rs:284\r\n   7: batch_system::batch::BatchSystem<N,C>::spawn::{{closure}}\r\n             at /home/stn/tikv/components/batch-system/src/batch.rs:396\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at /home/stn/.rustup/toolchains/nightly-2020-07-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libstd/sys_common/backtrace.rs:130\r\n   8: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\r\n             at /home/stn/.rustup/toolchains/nightly-2020-07-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libstd/thread/mod.rs:475\r\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /home/stn/.rustup/toolchains/nightly-2020-07-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libstd/panic.rs:318\r\n      std::panicking::try::do_call\r\n             at /home/stn/.rustup/toolchains/nightly-2020-07-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libstd/panicking.rs:342\r\n      std::panicking::try\r\n             at /home/stn/.rustup/toolchains/nightly-2020-07-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libstd/panicking.rs:319\r\n      std::panic::catch_unwind\r\n             at /home/stn/.rustup/toolchains/nightly-2020-07-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libstd/panic.rs:394\r\n      std::thread::Builder::spawn_unchecked::{{closure}}\r\n             at /home/stn/.rustup/toolchains/nightly-2020-07-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libstd/thread/mod.rs:474\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at /home/stn/.rustup/toolchains/nightly-2020-07-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore/ops/function.rs:233\r\n   9: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/liballoc/boxed.rs:1078\r\n      <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/liballoc/boxed.rs:1078\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at src/libstd/sys/unix/thread.rs:87\r\n  10: start_thread\r\n  11: __clone\r\n\"] [location=/home/stn/tikv/components/raftstore/src/store/fsm/store.rs:1728] [thread_name=raftstore-2-0]\r\n```\r\n\r\n### What version of TiKV are you using?\r\n\r\nmaster\r\n\r\nlog: https://drive.google.com/file/d/1cjP6GnYNt0jER7OHbiD-QXt_DygTLIcs/view?usp=sharing\r\n",
  "state": "closed",
  "created_at": "2020-10-04T03:46:05Z",
  "updated_at": "2021-11-23T10:41:09Z",
  "closed_at": "2021-01-14T16:17:51Z",
  "labels": [
    "type/bug",
    "severity/critical"
  ],
  "comments_data": [
    {
      "id": 708298415,
      "user": "gengliqi",
      "created_at": "2020-10-14T10:01:18Z",
      "body": "The bug is located in function `on_ready_split_region` which is introduced by https://github.com/tikv/tikv/pull/8084.\r\nhttps://github.com/tikv/tikv/blob/7c9850040ba58d48f0f1a93345c0392dffb2fc5b/components/raftstore/src/store/fsm/peer.rs#L2084-L2112\r\nLine 2111 `continue` means this region has already existed so it should be skipped.\r\nBut line 2087-2090 has already added this region to `region_ranges` which leads to metadata inconsistency."
    },
    {
      "id": 711491586,
      "user": "cosven",
      "created_at": "2020-10-19T03:32:10Z",
      "body": "I've met the same problem with tidb nightly build (docker).\r\n```\r\nTiKV\r\nRelease Version:   4.1.0-alpha\r\nEdition:           Community\r\nGit Commit Hash:   482bd12170a1802941bbd1ceed37c0672341c4ab\r\nGit Commit Branch: master\r\nUTC Build Time:    2020-10-17 01:49:19\r\nRust Version:      rustc 1.46.0-nightly (16957bd4d 2020-06-30)\r\nEnable Features:   jemalloc mem-profiling portable sse protobuf-codec\r\nProfile:           dist_release\r\n```"
    },
    {
      "id": 713007178,
      "user": "gengliqi",
      "created_at": "2020-10-20T17:04:45Z",
      "body": "> I've met the same problem with tidb nightly build (docker).\r\n> \r\n> ```\r\n> TiKV\r\n> Release Version:   4.1.0-alpha\r\n> Edition:           Community\r\n> Git Commit Hash:   482bd12170a1802941bbd1ceed37c0672341c4ab\r\n> Git Commit Branch: master\r\n> UTC Build Time:    2020-10-17 01:49:19\r\n> Rust Version:      rustc 1.46.0-nightly (16957bd4d 2020-06-30)\r\n> Enable Features:   jemalloc mem-profiling portable sse protobuf-codec\r\n> Profile:           dist_release\r\n> ```\r\n\r\nGood! Does your TiKV run with some chaos?"
    },
    {
      "id": 713249665,
      "user": "cosven",
      "created_at": "2020-10-21T02:20:05Z",
      "body": ">  Does your TiKV run with some chaos?\r\n\r\nNo, I just turned on shuffer-region/shuffer-leader/random-merge."
    },
    {
      "id": 964750897,
      "user": "vivid392845427",
      "created_at": "2021-11-10T03:21:05Z",
      "body": "```\r\nthis issue still exists in the 4.0 branch，does this issue need to merge to 4.0-release?\r\n\r\nstack information：\r\n[2021/11/09 22:15:09.919 +00:00] [FATAL] [lib.rs:481] [\"no entry found for key\"] [backtrace=\"stack backtrace:\\n   0: tikv_util::set_panic_hook::{{closure}}\\n             at components/tikv_util/src/lib.rs:480\\n   1: std::panicking::rust_panic_with_hook\\n             at src/libstd/panicking.rs:475\\n   2: rust_begin_unwind\\n             at src/libstd/panicking.rs:375\\n   3: core::panicking::panic_fmt\\n             at src/libcore/panicking.rs:84\\n   4: core::option::expect_failed\\n             at src/libcore/option.rs:1188\\n   5: core::option::Option<T>::expect\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libcore/option.rs:348\\n      <std::collections::hash::map::HashMap<K,V,S> as core::ops::index::Index<&Q>>::index\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/collections/hash/map.rs:1035\\n      raftstore::store::fsm::store::StoreFsmDelegate<T,C>::maybe_create_peer_internal\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/raftstore/src/store/fsm/store.rs:1691\\n      raftstore::store::fsm::store::StoreFsmDelegate<T,C>::maybe_create_peer\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/raftstore/src/store/fsm/store.rs:1634\\n      raftstore::store::fsm::store::StoreFsmDelegate<T,C>::on_raft_message\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/raftstore/src/store/fsm/store.rs:1566\\n   6: raftstore::store::fsm::store::StoreFsmDelegate<T,C>::handle_msgs\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/raftstore/src/store/fsm/store.rs:489\\n      <raftstore::store::fsm::store::RaftPoller<T,C> as batch_system::batch::PollHandler<raftstore::store::fsm::peer::PeerFsm<engine_rocks::engine::RocksEngine>,raftstore::store::fsm::store::StoreFsm>>::handle_control\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/raftstore/src/store/fsm/store.rs:772\\n   7: batch_system::batch::Poller<N,C,Handler>::poll\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/batch-system/src/batch.rs:387\\n   8: batch_system::batch::BatchSystem<N,C>::spawn::{{closure}}\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/batch-system/src/batch.rs:518\\n      std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/sys_common/backtrace.rs:136\\n   9: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/thread/mod.rs:469\\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panic.rs:318\\n      std::panicking::try::do_call\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panicking.rs:292\\n      std::panicking::try\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8//src/libpanic_unwind/lib.rs:78\\n      std::panic::catch_unwind\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panic.rs:394\\n      std::thread::Builder::spawn_unchecked::{{closure}}\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/thread/mod.rs:468\\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libcore/ops/function.rs:232\\n  10: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/liballoc/boxed.rs:1022\\n  11: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/liballoc/boxed.rs:1022\\n      std::sys_common::thread::start_thread\\n             at src/libstd/sys_common/thread.rs:13\\n      std::sys::unix::thread::thread::new::thread_start\\n             at src/libstd/sys/unix/thread.rs:80\\n  12: <unknown>\\n  13: clone\\n\"] [location=src/libcore/option.rs:1188] [thread_name=raftstore-1-1]\r\n[2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:94] [\"Welcome to TiKV\"]\r\n\r\ntikv version：\r\n[2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:94] [\"Welcome to TiKV\"]\r\n[2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] []\r\n[2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Release Version:   4.0.15\"]\r\n[2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Edition:           Community\"]\r\n[2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Git Commit Hash:   0a0482dee0a0cf135f56b9f90b412ea641ec3ae2\"]\r\n[2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Git Commit Branch: heads/refs/tags/v4.0.15\"]\r\n[2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"UTC Build Time:    2021-09-23 09:52:40\"]\r\n[2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Rust Version:      rustc 1.42.0-nightly (0de96d37f 2019-12-19)\"]\r\n[2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Enable Features:   jemalloc mem-profiling portable sse protobuf-codec\"]\r\n[2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Profile:           dist_release\"]\r\n```"
    },
    {
      "id": 976387852,
      "user": "gengliqi",
      "created_at": "2021-11-23T10:41:09Z",
      "body": "> ```\r\n> this issue still exists in the 4.0 branch，does this issue need to merge to 4.0-release?\r\n> \r\n> stack information：\r\n> [2021/11/09 22:15:09.919 +00:00] [FATAL] [lib.rs:481] [\"no entry found for key\"] [backtrace=\"stack backtrace:\\n   0: tikv_util::set_panic_hook::{{closure}}\\n             at components/tikv_util/src/lib.rs:480\\n   1: std::panicking::rust_panic_with_hook\\n             at src/libstd/panicking.rs:475\\n   2: rust_begin_unwind\\n             at src/libstd/panicking.rs:375\\n   3: core::panicking::panic_fmt\\n             at src/libcore/panicking.rs:84\\n   4: core::option::expect_failed\\n             at src/libcore/option.rs:1188\\n   5: core::option::Option<T>::expect\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libcore/option.rs:348\\n      <std::collections::hash::map::HashMap<K,V,S> as core::ops::index::Index<&Q>>::index\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/collections/hash/map.rs:1035\\n      raftstore::store::fsm::store::StoreFsmDelegate<T,C>::maybe_create_peer_internal\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/raftstore/src/store/fsm/store.rs:1691\\n      raftstore::store::fsm::store::StoreFsmDelegate<T,C>::maybe_create_peer\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/raftstore/src/store/fsm/store.rs:1634\\n      raftstore::store::fsm::store::StoreFsmDelegate<T,C>::on_raft_message\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/raftstore/src/store/fsm/store.rs:1566\\n   6: raftstore::store::fsm::store::StoreFsmDelegate<T,C>::handle_msgs\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/raftstore/src/store/fsm/store.rs:489\\n      <raftstore::store::fsm::store::RaftPoller<T,C> as batch_system::batch::PollHandler<raftstore::store::fsm::peer::PeerFsm<engine_rocks::engine::RocksEngine>,raftstore::store::fsm::store::StoreFsm>>::handle_control\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/raftstore/src/store/fsm/store.rs:772\\n   7: batch_system::batch::Poller<N,C,Handler>::poll\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/batch-system/src/batch.rs:387\\n   8: batch_system::batch::BatchSystem<N,C>::spawn::{{closure}}\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_v4.0.15/tikv/components/batch-system/src/batch.rs:518\\n      std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/sys_common/backtrace.rs:136\\n   9: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/thread/mod.rs:469\\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panic.rs:318\\n      std::panicking::try::do_call\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panicking.rs:292\\n      std::panicking::try\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8//src/libpanic_unwind/lib.rs:78\\n      std::panic::catch_unwind\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panic.rs:394\\n      std::thread::Builder::spawn_unchecked::{{closure}}\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/thread/mod.rs:468\\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libcore/ops/function.rs:232\\n  10: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/liballoc/boxed.rs:1022\\n  11: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/liballoc/boxed.rs:1022\\n      std::sys_common::thread::start_thread\\n             at src/libstd/sys_common/thread.rs:13\\n      std::sys::unix::thread::thread::new::thread_start\\n             at src/libstd/sys/unix/thread.rs:80\\n  12: <unknown>\\n  13: clone\\n\"] [location=src/libcore/option.rs:1188] [thread_name=raftstore-1-1]\r\n> [2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:94] [\"Welcome to TiKV\"]\r\n> \r\n> tikv version：\r\n> [2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:94] [\"Welcome to TiKV\"]\r\n> [2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] []\r\n> [2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Release Version:   4.0.15\"]\r\n> [2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Edition:           Community\"]\r\n> [2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Git Commit Hash:   0a0482dee0a0cf135f56b9f90b412ea641ec3ae2\"]\r\n> [2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Git Commit Branch: heads/refs/tags/v4.0.15\"]\r\n> [2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"UTC Build Time:    2021-09-23 09:52:40\"]\r\n> [2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Rust Version:      rustc 1.42.0-nightly (0de96d37f 2019-12-19)\"]\r\n> [2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Enable Features:   jemalloc mem-profiling portable sse protobuf-codec\"]\r\n> [2021/11/09 22:15:12.942 +00:00] [INFO] [lib.rs:96] [\"Profile:           dist_release\"]\r\n> ```\r\n\r\nhttps://github.com/tikv/tikv/pull/9584 this bug fix PR has been merged. \r\nMaybe another bug? How about uploading the TiKV log?"
    }
  ]
}