{
  "issue_number": 16236,
  "title": "tikv v7.4.0 crash",
  "body": "[2023/12/23 20:07:45.518 +08:00] [FATAL] [lib.rs:510] [\"group properties is not set\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/lib.rs:509:18\r\n   1: <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2032:9\r\n      std::panicking::rust_panic_with_hook\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:692:13\r\n   2: std::panicking::begin_panic_handler::{{closure}}\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:577:13\r\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:137:18\r\n   4: rust_begin_unwind\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:575:5\r\n   5: core::panicking::panic_fmt\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:65:14\r\n   6: tikv_util::thread_group::is_shutdown::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/thread_group.rs:50:13\r\n      std::thread::local::LocalKey<T>::try_with\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:446:16\r\n      std::thread::local::LocalKey<T>::with\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:422:9\r\n      tikv_util::thread_group::is_shutdown\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/thread_group.rs:46:5\r\n   7: <tikv_util::callback::MustCall<T,C,A> as core::ops::drop::Drop>::drop\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/callback.rs:48:17\r\n      core::ptr::drop_in_place<tikv_util::callback::MustCall<raftstore::store::msg::WriteResponse,alloc::boxed::Box<<tikv::server::raftkv::RaftKv<engine_rocks::engine::RocksEngine,raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,engine_rocks::engine::RocksEngine>> as tikv_kv::Engine>::async_write::{{closure}}>,tikv::server::raftkv::drop_on_applied_callback>>\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:490:1\r\n      core::ptr::drop_in_place<tikv_util::callback::must_call<raftstore::store::msg::WriteResponse,alloc::boxed::Box<<tikv::server::raftkv::RaftKv<engine_rocks::engine::RocksEngine,raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,engine_rocks::engine::RocksEngine>> as tikv_kv::Engine>::async_write::{{closure}}>,tikv::server::raftkv::drop_on_applied_callback>::{{closure}}>\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:490:1\r\n   8: core::ptr::drop_in_place<alloc::boxed::Box<dyn core::ops::function::FnOnce<(raftstore::store::msg::WriteResponse,)>+Output = ()+core::marker::Send>>\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:490:1\r\n      core::ptr::drop_in_place<raftstore::store::msg::Callback<engine_rocks::snapshot::RocksSnapshot>>\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ptr/mod.rs:490:1\r\n   9: core::ptr::drop_in_place<crossbeam_channel::err::TrySendError<raftstore::store::msg::RaftCommand<engine_rocks::snapshot::RocksSnapshot>>>\r\n      raftstore::router::handle_send_error\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/router.rs:270:1\r\n      raftstore::router::send_command_impl::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/router.rs:112:22\r\n      core::result::Result<T,E>::map_err\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/result.rs:861:27\r\n      raftstore::router::send_command_impl\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/router.rs:110:5\r\n      raftstore::router::RaftStoreRouter::send_command\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/router.rs:57:9\r\n  10: <tikv::server::raftkv::RaftKv<E,S> as tikv_kv::Engine>::async_write\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/server/raftkv/mod.rs:572:19\r\n  11: tikv_kv::write\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_kv/src/lib.rs:708:19\r\n      tikv::storage::Storage<E,L,F>::delete_range\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/storage/mod.rs:1635:19\r\n      tikv::server::service::kv::future_delete_range\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/server/service/kv.rs:1553:15\r\n  12: <tikv::server::service::kv::Service<E,L,F> as kvproto::protos::tikvpb_grpc::Tikv>::kv_delete_range\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/server/service/kv.rs:207:24\r\n      kvproto::protos::tikvpb_grpc::create_tikv::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/.target/x86_64-unknown-linux-gnu/release/build/kvproto-3b4557dea3832524/out/protos/tikvpb_grpc.rs:1750:9\r\n      grpcio::call::server::execute_unary\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/grpcio-0.10.4/src/call/server.rs:745:5\r\n      grpcio::server::ServiceBuilder::add_unary_handler::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/grpcio-0.10.4/src/server.rs:196:13\r\n      <grpcio::server::Handler<F> as grpcio::server::CloneableHandler>::handle\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/grpcio-0.10.4/src/server.rs:54:9\r\n  13: grpcio::call::server::execute\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/grpcio-0.10.4/src/call/server.rs:844:5\r\n  14: grpcio::call::server::UnaryRequestContext::handle\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/grpcio-0.10.4/src/call/server.rs:251:20\r\n      grpcio::task::callback::UnaryRequest::resolve\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/grpcio-0.10.4/src/task/callback.rs:62:9\r\n      grpcio::task::CallTag::resolve\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/grpcio-0.10.4/src/task/mod.rs:178:42\r\n      grpcio::env::poll_queue\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/grpcio-0.10.4/src/env.rs:30:9\r\n  15: grpcio::env::EnvBuilder::build::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/grpcio-0.10.4/src/env.rs:107:21\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:121:18\r\n  16: std::thread::Builder::spawn_unchecked_::{{closure}}::{{closure}}\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:551:17\r\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panic/unwind_safe.rs:271:9\r\n      std::panicking::try::do_call\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:483:40\r\n      std::panicking::try\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:447:19\r\n      std::panic::catch_unwind\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panic.rs:137:14\r\n      std::thread::Builder::spawn_unchecked_::{{closure}}\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:550:30\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:513:5\r\n  17: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2000:9\r\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2000:9\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/unix/thread.rs:108:17\r\n  18: start_thread\r\n  19: __clone\r\n\"] [location=components/tikv_util/src/thread_group.rs:50] [thread_name=grpc-server-4]\r\n",
  "state": "closed",
  "created_at": "2023-12-25T06:56:23Z",
  "updated_at": "2024-01-03T02:48:33Z",
  "closed_at": "2024-01-03T02:48:33Z",
  "labels": [
    "type/bug",
    "severity/major",
    "affects-5.4",
    "affects-6.1",
    "affects-6.5",
    "affects-7.1",
    "affects-7.5"
  ],
  "comments_data": [
    {
      "id": 1871783344,
      "user": "pingyu",
      "created_at": "2023-12-29T06:29:09Z",
      "body": "The panic seems to be caused by thread group properties was not set for gRPC threads.\r\n\r\nInvoke `tikv_util::thread_group::set_properties` in [`after_start`](https://github.com/tikv/tikv/blob/4702b9bf6ed8d72d20bedf3de184f63111055b8e/components/server/src/server.rs#L332) should be able to fix the issue.\r\n\r\n@vzong Is there any way to reproduce this issue ?"
    },
    {
      "id": 1871860963,
      "user": "vzong",
      "created_at": "2023-12-29T09:10:15Z",
      "body": "We haven't been able to reproduce the crash scenario, such a crash has occurred only once. \r\nThe service shouldn't crash regardless of the status of any properties. This appears to be a bug."
    }
  ]
}