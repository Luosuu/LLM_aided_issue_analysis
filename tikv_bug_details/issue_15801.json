{
  "issue_number": 15801,
  "title": "Panic every 5 minute after restore from backup",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\nCommit a9676d148e61f741ce9ee699f992b9ce06f91706\r\n<!-- You can run `tikv-server --version` -->\r\n\r\n### What operating system and CPU are you using?\r\nUbuntu 20.04\r\n ```\r\nprocessor       : 0\r\nvendor_id       : AuthenticAMD\r\ncpu family      : 23\r\nmodel           : 49\r\nmodel name      : AMD EPYC 7B12\r\nstepping        : 0\r\nmicrocode       : 0x1000065\r\ncpu MHz         : 2249.998\r\ncache size      : 512 KB\r\nphysical id     : 0\r\nsiblings        : 8\r\ncore id         : 0\r\ncpu cores       : 4\r\napicid          : 0\r\ninitial apicid  : 0\r\nfpu             : yes\r\nfpu_exception   : yes\r\ncpuid level     : 13\r\nwp              : yes\r\nflags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm constant_tsc rep_good nopl nonstop\r\nbugs            : sysret_ss_attrs null_seg spectre_v1 spectre_v2 spec_store_bypass retbleed\r\nbogomips        : 4499.99\r\nTLB size        : 3072 4K pages\r\nclflush size    : 64\r\ncache_alignment : 64\r\naddress sizes   : 48 bits physical, 48 bits virtual\r\n* 8 cores\r\n```\r\n\r\n### Steps to reproduce\r\nCreate backup from 3h ago snapshot with tidb br.\r\nrestore db.\r\nGet \r\n```\r\nError: Clustered index option mismatch. Restored cluster's @@tidb_enable_clustered_index should be ON (backup table = true, created table = false).: [BR:Restore:ErrRestoreModeMismatch]restore mode mismatch\r\n```\r\nRestore all table in db one by one.\r\n\r\n\r\n### What did you expect?\r\nBackup restored\r\n### What did happened?\r\nTables restored, but tikv is panicking every 5 minutes.\r\n```\r\n[\"index out of bounds: the len is 3 but the index is 3\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/lib.rs:496:18\r\n   1: <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2032:9\r\n      std::panicking::rust_panic_with_hook\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:692:13\r\n   2: std::panicking::begin_panic_handler::{{closure}}\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:579:13\r\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:137:18\r\n   4: rust_begin_unwind\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:575:5\r\n   5: core::panicking::panic_fmt\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:65:14\r\n   6: core::panicking::panic_bounds_check\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:150:5\r\n   7: tidb_query_datatype::codec::datum_codec::decode_enum_datum\r\n   8: <&[u8] as tidb_query_datatype::codec::datum_codec::RawDatumDecoder<tidb_query_datatype::codec::mysql::enums::Enum>>::decode\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tidb_query_datatype/src/codec/datum_codec.rs:604:9\r\n      tidb_query_datatype::codec::batch::lazy_column::LazyBatchColumn::ensure_decoded\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tidb_query_datatype/src/codec/batch/lazy_column.rs:181:9\r\n   9: tidb_query_expr::types::expr_eval::<impl tidb_query_expr::types::expr::RpnExpression>::ensure_columns_decoded\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tidb_query_expr/src/types/expr_eval.rs:194:17\r\n  10: tidb_query_expr::types::expr_eval::<impl tidb_query_expr::types::expr::RpnExpression>::eval\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tidb_query_expr/src/types/expr_eval.rs:173:9\r\n      tidb_query_executors::selection_executor::BatchSelectionExecutor<Src>::handle_src_result\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/selection_executor.rs:82:19\r\n      <tidb_query_executors::selection_executor::BatchSelectionExecutor<Src> as tidb_query_executors::interface::BatchExecutor>::next_batch::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/selection_executor.rs:182:25\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:91:19\r\n  11: <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/future.rs:124:9\r\n      <tidb_query_common::execute_stats::WithSummaryCollector<C,T> as tidb_query_executors::interface::BatchExecutor>::next_batch::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/interface.rs:114:54\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:91:19\r\n  12: <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/future.rs:124:9\r\n      <alloc::boxed::Box<T> as tidb_query_executors::interface::BatchExecutor>::next_batch::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/interface.rs:82:39\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:91:19\r\n  13: <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/future.rs:124:9\r\n      tidb_query_executors::runner::BatchExecutorsRunner<SS>::internal_handle_request::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/runner.rs:650:71\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:91:19\r\n  14: <tikv_util::quota_limiter::CpuObserveFuture<F> as core::future::future::Future>::poll\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/quota_limiter.rs:169:19\r\n      tidb_query_executors::runner::BatchExecutorsRunner<SS>::handle_request::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tidb_query_executors/src/runner.rs:514:21\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:91:19\r\n      <tikv::coprocessor::dag::BatchDagHandler as tikv::coprocessor::RequestHandler>::handle_request::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/coprocessor/dag/mod.rs:124:50\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:91:19\r\n  15: <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/future.rs:124:9\r\n      <tikv::coprocessor::interceptors::deadline::DeadlineChecker<F> as core::future::future::Future>::poll\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/coprocessor/interceptors/deadline.rs:37:9\r\n      <tikv::coprocessor::interceptors::tracker::Tracker<F,E> as core::future::future::Future>::poll\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/coprocessor/interceptors/tracker.rs:54:19\r\n      <tikv::coprocessor::interceptors::concurrency_limiter::ConcurrencyLimiter<PF,F> as core::future::future::Future>::poll\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/coprocessor/interceptors/concurrency_limiter.rs:112:15\r\n      tikv::coprocessor::endpoint::Endpoint<E>::handle_unary_request_impl::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/coprocessor/endpoint.rs:440:86\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:91:19\r\n      <resource_metering::InTags<T> as core::future::future::Future>::poll\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/resource_metering/src/lib.rs:266:9\r\n      tikv::read_pool::ReadPoolHandle::spawn_handle::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/read_pool.rs:207:28\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:91:19\r\n  16: tikv::read_pool::ReadPoolHandle::spawn::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/read_pool.rs:170:34\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:91:19\r\n      <resource_control::future::ControlledFuture<F> as core::future::future::Future>::poll\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/resource_control/src/future.rs:39:19\r\n      <tracker::tls::TrackedFuture<F> as core::future::future::Future>::poll::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tracker/src/tls.rs:64:23\r\n      std::thread::local::LocalKey<T>::try_with\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:446:16\r\n      std::thread::local::LocalKey<T>::with\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:422:9\r\n      <tracker::tls::TrackedFuture<F> as core::future::future::Future>::poll\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tracker/src/tls.rs:62:9\r\n      yatp::task::future::RawTask<F>::poll\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/5523a9a/src/task/future.rs:59:9\r\n  17: yatp::task::future::TaskCell::poll\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/5523a9a/src/task/future.rs:103:9\r\n      <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/5523a9a/src/task/future.rs:387:20\r\n  18: <tikv_util::yatp_pool::YatpPoolRunner<T> as yatp::pool::runner::Runner>::handle\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/yatp_pool/mod.rs:193:24\r\n      <yatp::queue::multilevel::TrackedRunner<R> as yatp::pool::runner::Runner>::handle\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/5523a9a/src/queue/multilevel.rs:285:19\r\n  19: yatp::pool::worker::WorkerThread<T,R>::run\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/5523a9a/src/pool/worker.rs:48:13\r\n      yatp::pool::builder::LazyBuilder<T>::build::{{closure}}\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/5523a9a/src/pool/builder.rs:114:25\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:121:18\r\n  20: std::thread::Builder::spawn_unchecked_::{{closure}}::{{closure}}\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:551:17\r\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panic/unwind_safe.rs:271:9\r\n      std::panicking::try::do_call\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:483:40\r\n      std::panicking::try\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:447:19\r\n      std::panic::catch_unwind\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panic.rs:137:14\r\n      std::thread::Builder::spawn_unchecked_::{{closure}}\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:550:30\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:513:5\r\n  21: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2000:9\r\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2000:9\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/unix/thread.rs:108:17\r\n  22: start_thread\r\n  23: clone\r\n```",
  "state": "open",
  "created_at": "2023-10-19T11:39:28Z",
  "updated_at": "2024-08-07T05:31:46Z",
  "closed_at": null,
  "labels": [
    "type/bug",
    "component/backup-restore",
    "severity/moderate"
  ],
  "comments_data": [
    {
      "id": 1770893469,
      "user": "0xdeafbeef",
      "created_at": "2023-10-19T12:36:26Z",
      "body": "Update, found an issue.\r\nSteps to reproduce:\r\n\r\n1. Drop database\r\n2. Recreate it, changing the schema a bit - make clustered key non-clustered.\r\n3. Back up data from a snapshot before dropping db. Backup will have clustered keys\r\n4. Restore from snapshot\r\n5. Database will try to decode keys with wrong schema\r\n6. Cycle of panics"
    },
    {
      "id": 1772200083,
      "user": "BornChanger",
      "created_at": "2023-10-20T07:07:54Z",
      "body": "/component backup-restore"
    },
    {
      "id": 1772332794,
      "user": "YuJuncen",
      "created_at": "2023-10-20T08:47:57Z",
      "body": "BR only support restoring tables to a cluster which either:\r\n- Without table using the same name, in this case BR will try to create the table.\r\n- A table with the same name and a compatible schema. In most cases, \"compatible\" means \"the same\".\r\n\r\nWhen the schema isn't compatible, BR will do a restore without warranties. That is, it ingests the KV represents the upstream data to the cluster(**without** any efforts of modifying them compatible), the restored tables may be unavailable. 😢"
    }
  ]
}