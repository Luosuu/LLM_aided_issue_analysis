{
  "issue_number": 9615,
  "title": "commit merge and post_apply can make tikv panic",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\nv4.0.9 \r\n\r\nBecause `on_ready_commit_merge` will remove source read delegate,\r\n\r\nhttps://github.com/tikv/tikv/blob/bf92a4a9b56f410f3c0eefe8056c22923a08ceee/components/raftstore/src/store/fsm/peer.rs#L2774\r\n\r\nand `post_apply` will update read_delegate\r\n\r\nhttps://github.com/tikv/tikv/blob/bf92a4a9b56f410f3c0eefe8056c22923a08ceee/components/raftstore/src/store/peer.rs#L2094-L2095\r\n\r\n. If `post_apply` on source is executed after `on_ready_commit_merge` on target, and before `on_merge_result`, TiKV will panic as it can't find the read delegate.\r\n\r\n/cc @gengliqi @NingLin-P ",
  "state": "closed",
  "created_at": "2021-02-01T10:10:49Z",
  "updated_at": "2022-01-14T12:25:20Z",
  "closed_at": "2022-01-14T12:25:20Z",
  "labels": [
    "type/bug",
    "sig/raft",
    "severity/minor"
  ],
  "comments_data": [
    {
      "id": 771375414,
      "user": "NingLin-P",
      "created_at": "2021-02-02T05:35:30Z",
      "body": "The target region will not execute the `CommitMerge` command until the source region catches up logs. \r\n\r\n1. target region apply `CommitMerge` and wait for the source region's `LogsUpToDate` message\r\n2. source region\r\n    a. catch up logs and apply `PrepareMerge` \r\n    b. enter `on_ready_result` and then send `LogsUpToDate`\r\n    c. return from `on_ready_result` and `on_apply`\r\n3. target region execute the `CommitMerge` command and then `on_ready_commit_merge`\r\n\r\nThe case may occur if step 3 happened between 2.b and 2.c, but this should be very rare."
    },
    {
      "id": 921718964,
      "user": "vivid392845427",
      "created_at": "2021-09-17T11:23:04Z",
      "body": "run tipocket testcase tipocket-bank2-tiflash1 occur this issueï¼Œstack as follow:\r\n[2021/09/14 07:38:39.905 +00:00] [FATAL] [lib.rs:465] [\"called `Option::unwrap()` on a `None` value\"] [backtrace=\"stack backtrace:\\n   0: tikv_util::set_panic_hook::{{closure}}\\n             at components/tikv_util/src/lib.rs:464\\n   1: std::panicking::rust_panic_with_hook\\n             at library/std/src/panicking.rs:626\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n             at library/std/src/panicking.rs:517\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n             at library/std/src/sys_common/backtrace.rs:141\\n   4: rust_begin_unwind\\n             at library/std/src/panicking.rs:515\\n   5: core::panicking::panic_fmt\\n             at library/core/src/panicking.rs:92\\n   6: core::panicking::panic\\n             at library/core/src/panicking.rs:50\\n   7: core::option::Option<T>::unwrap\\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/core/src/option.rs:722\\n      raftstore::store::peer::Peer<EK,ER>::post_apply\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/raftstore/src/store/peer.rs:2197\\n      raftstore::store::fsm::peer::PeerFsmDelegate<EK,ER,T>::on_apply_res\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/raftstore/src/store/fsm/peer.rs:1268\\n      raftstore::store::fsm::peer::PeerFsmDelegate<EK,ER,T>::handle_msgs\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/raftstore/src/store/fsm/peer.rs:618\\n   8: <raftstore::store::fsm::store::RaftPoller<EK,ER,T> as batch_system::batch::PollHandler<raftstore::store::fsm::peer::PeerFsm<EK,ER>,raftstore::store::fsm::store::StoreFsm<EK>>>::handle_normal\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/raftstore/src/store/fsm/store.rs:896\\n   9: batch_system::batch::Poller<N,C,Handler>::poll\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/batch-system/src/batch.rs:310\\n  10: batch_system::batch::BatchSystem<N,C>::start_poller::{{closure}}\\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/batch-system/src/batch.rs:422\\n      std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/sys_common/backtrace.rs:125\\n  11: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/thread/mod.rs:476\\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/panic.rs:347\\n      std::panicking::try::do_call\\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/panicking.rs:401\\n      std::panicking::try\\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/panicking.rs:365\\n      std::panic::catch_unwind\\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/panic.rs:434\\n      std::thread::Builder::spawn_unchecked::{{closure}}\\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/thread/mod.rs:475\\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/core/src/ops/function.rs:227\\n  12: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/alloc/src/boxed.rs:1572\\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/alloc/src/boxed.rs:1572\\n      std::sys::unix::thread::thread::new::thread_start\\n             at library/std/src/sys/unix/thread.rs:91\\n  13: <unknown>\\n  14: clone\\n\"] [location=/home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/raftstore/src/store/peer.rs:2197] [thread_name=raftstore-4-0]\r\n\r\ntikv version:\r\n[2021/09/14 06:35:54.353 +00:00] [INFO] [lib.rs:80] [\"Welcome to TiKV\"]\r\n[2021/09/14 06:35:54.353 +00:00] [INFO] [lib.rs:85] [\"Release Version:   5.3.0-alpha\"]\r\n[2021/09/14 06:35:54.353 +00:00] [INFO] [lib.rs:85] [\"Edition:           Community\"]\r\n[2021/09/14 06:35:54.353 +00:00] [INFO] [lib.rs:85] [\"Git Commit Hash:   d377cfda49c0f2fbd5e7b4501dfdfbe310f1fe90\"]\r\n[2021/09/14 06:35:54.353 +00:00] [INFO] [lib.rs:85] [\"Git Commit Branch: master\"]\r\n[2021/09/14 06:35:54.353 +00:00] [INFO] [lib.rs:85] [\"UTC Build Time:    Unknown (env var does not exist when building)\"]\r\n"
    },
    {
      "id": 1013075120,
      "user": "BusyJay",
      "created_at": "2022-01-14T12:25:20Z",
      "body": "Duplicated with #11852."
    }
  ]
}