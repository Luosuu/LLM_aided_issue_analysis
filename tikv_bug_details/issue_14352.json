{
  "issue_number": 14352,
  "title": "[Dynamic Regions] multiple rocksdb panic with too many open files",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n[2023/03/05 18:59:20.132 +00:00] [INFO] [[lib.rs:85](http://lib.rs:85/)] [\"Welcome to TiKV\"]\r\n[2023/03/05 18:59:20.132 +00:00] [INFO] [[lib.rs:90](http://lib.rs:90/)] [\"Release Version:   6.7.0-alpha\"]\r\n[2023/03/05 18:59:20.132 +00:00] [INFO] [[lib.rs:90](http://lib.rs:90/)] [\"Edition:           Community\"]\r\n[2023/03/05 18:59:20.132 +00:00] [INFO] [[lib.rs:90](http://lib.rs:90/)] [\"Git Commit Hash:   d74fd1325280999b367424ee332c49e11bbf80b0\"]\r\n[2023/03/05 18:59:20.132 +00:00] [INFO] [[lib.rs:90](http://lib.rs:90/)] [\"Git Commit Branch: heads/refs/tags/v6.7.0-alpha\"]\r\n[2023/03/05 18:59:20.132 +00:00] [INFO] [[lib.rs:90](http://lib.rs:90/)] [\"UTC Build Time:    Unknown (env var does not exist when building)\"]\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n```\r\nmysql> select count(distinct REGION_ID) from TIKV_REGION_STATUS;\r\n+---------------------------+\r\n| count(distinct REGION_ID) |\r\n+---------------------------+\r\n|                     13766 |\r\n+---------------------------+\r\n```\r\n```\r\ncat /proc/184/limits\r\nLimit                     Soft Limit           Hard Limit           Units\r\nMax cpu time              unlimited            unlimited            seconds\r\nMax file size             unlimited            unlimited            bytes\r\nMax data size             unlimited            unlimited            bytes\r\nMax stack size            8388608              unlimited            bytes\r\nMax core file size        unlimited            unlimited            bytes\r\nMax resident set          unlimited            unlimited            bytes\r\nMax processes             unlimited            unlimited            processes\r\nMax open files            82920                1048576              files\r\nMax locked memory         65536                65536                bytes\r\nMax address space         unlimited            unlimited            bytes\r\nMax file locks            unlimited            unlimited            locks\r\nMax pending signals       772557               772557               signals\r\nMax msgqueue size         819200               819200               bytes\r\nMax nice priority         0                    0\r\nMax realtime priority     0                    0\r\nMax realtime timeout      unlimited            unlimited            us\r\n```\r\n\r\n```\r\n[2023/03/06 05:57:04.333 +00:00] [FATAL] [[lib.rs:497](http://lib.rs:497/)] [\"called `Result::unwrap()` on an `Err` value: Os { code: 24, kind: Uncategorized, message: \\\"Too many open files\\\" }\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/tikv_util/src/lib.rs:496:18\\n](http://github.com/pingcap/tikv/components/tikv_util/src/lib.rs:496:18/n)   1: <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/[boxed.rs:2032](http://boxed.rs:2032/):9\\n      std::panicking::rust_panic_with_hook\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:692](http://panicking.rs:692/):13\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:579](http://panicking.rs:579/):13\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/[backtrace.rs:137](http://backtrace.rs:137/):18\\n   4: rust_begin_unwind\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:575](http://panicking.rs:575/):5\\n   5: core::panicking::panic_fmt\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/[panicking.rs:65](http://panicking.rs:65/):14\\n   6: core::result::unwrap_failed\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/[result.rs:1791](http://result.rs:1791/):5\\n   7: core::result::Result<T,E>::unwrap\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/[result.rs:1113](http://result.rs:1113/):23\\n      engine_rocks::util::db_exist\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/engine_rocks/src/util.rs:153:5\\n](http://github.com/pingcap/tikv/components/engine_rocks/src/util.rs:153:5/n)   8: engine_rocks::util::new_engine_opt\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/engine_rocks/src/util.rs:56:9\\n](http://github.com/pingcap/tikv/components/engine_rocks/src/util.rs:56:9/n)   9: <tikv::server::engine_factory::KvEngineFactory as engine_traits::tablet::TabletFactory<engine_rocks::engine::RocksEngine>>::open_tablet\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/src/server/engine_factory.rs:209:13\\n](http://github.com/pingcap/tikv/src/server/engine_factory.rs:209:13/n)  10: raftstore_v2::operation::ready::snapshot::<impl raftstore_v2::raft::peer::Peer<EK,ER>>::on_applied_snapshot\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/raftstore-v2/src/operation/ready/snapshot.rs:238:26\\n](http://github.com/pingcap/tikv/components/raftstore-v2/src/operation/ready/snapshot.rs:238:26/n)      raftstore_v2::operation::ready::<impl raftstore_v2::raft::peer::Peer<EK,ER>>::on_persisted\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/raftstore-v2/src/operation/ready/mod.rs:656:13\\n](http://github.com/pingcap/tikv/components/raftstore-v2/src/operation/ready/mod.rs:656:13/n)  11: raftstore_v2::fsm::peer::PeerFsmDelegate<EK,ER,T>::on_msgs\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/raftstore-v2/src/fsm/peer.rs:276:22\\n](http://github.com/pingcap/tikv/components/raftstore-v2/src/fsm/peer.rs:276:22/n)  12: <raftstore_v2::batch::store::StorePoller<EK,ER,T> as batch_system::batch::PollHandler<raftstore_v2::fsm::peer::PeerFsm<EK,ER>,raftstore_v2::fsm::store::StoreFsm>>::handle_normal\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/raftstore-v2/src/batch/store.rs:230:9\\n](http://github.com/pingcap/tikv/components/raftstore-v2/src/batch/store.rs:230:9/n)      batch_system::batch::Poller<N,C,Handler>::poll\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/batch-system/src/batch.rs:380:27\\n](http://github.com/pingcap/tikv/components/batch-system/src/batch.rs:380:27/n)  13: batch_system::batch::BatchSystem<N,C>::start_poller::{{closure}}\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/batch-system/src/batch.rs:550:17\\n](http://github.com/pingcap/tikv/components/batch-system/src/batch.rs:550:17/n)      <std::thread::Builder as tikv_util::sys::thread::StdThreadBuildWrapper>::spawn_wrapper::{{closure}}\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/tikv_util/src/sys/thread.rs:427:23\\n](http://github.com/pingcap/tikv/components/tikv_util/src/sys/thread.rs:427:23/n)      std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/[backtrace.rs:121](http://backtrace.rs:121/):18\\n  14: std::thread::Builder::spawn_unchecked_::{{closure}}::{{closure}}\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/[mod.rs:551](http://mod.rs:551/):17\\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panic/[unwind_safe.rs:271](http://unwind_safe.rs:271/):9\\n      std::panicking::try::do_call\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:483](http://panicking.rs:483/):40\\n      std::panicking::try\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:447](http://panicking.rs:447/):19\\n      std::panic::catch_unwind\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panic.rs:137](http://panic.rs:137/):14\\n      std::thread::Builder::spawn_unchecked_::{{closure}}\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/[mod.rs:550](http://mod.rs:550/):30\\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/[function.rs:513](http://function.rs:513/):5\\n  15: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/[boxed.rs:2000](http://boxed.rs:2000/):9\\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/[boxed.rs:2000](http://boxed.rs:2000/):9\\n      std::sys::unix::thread::Thread::new::thread_start\\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/unix/[thread.rs:108](http://thread.rs:108/):17\\n  16: start_thread\\n  17: clone\\n\"] [location=components/engine_rocks/src/[util.rs:153](http://util.rs:153/)] [thread_name=rs-5-0]\r\n```\r\n### What did you expect?\r\n\r\n### What did happened?\r\n",
  "state": "closed",
  "created_at": "2023-03-06T13:48:38Z",
  "updated_at": "2023-03-28T05:20:26Z",
  "closed_at": "2023-03-28T05:20:26Z",
  "labels": [
    "type/bug",
    "severity/moderate",
    "feature/developing"
  ],
  "comments_data": []
}