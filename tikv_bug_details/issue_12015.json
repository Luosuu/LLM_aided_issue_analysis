{
  "issue_number": 12015,
  "title": "backup: TiKV panic when execute \"br backup raw\" with an empty key entry",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\ntikv-server: v5.5.0-nightly-20220220\r\n$ ~/.tiup/components/tikv/v5.5.0-nightly-20220220/tikv-server --version\r\nTiKV\r\nRelease Version:   5.4.0-alpha\r\nEdition:           Community\r\nGit Commit Hash:   b1b470f9baa0e0b4acee10229676ce73167bf9a2\r\nGit Commit Branch: heads/refs/tags/v5.5.0-alpha\r\nUTC Build Time:    2022-02-18 14:53:57\r\nRust Version:      rustc 1.60.0-nightly (1e12aef3f 2022-02-13)\r\nEnable Features:   jemalloc mem-profiling portable sse test-engines-rocksdb cloud-aws cloud-gcp cloud-azure\r\nProfile:           dist_release\r\n\r\nbr: v5.5.0-nightly-20220220\r\n$ ~/.tiup/components/br/v5.5.0-nightly-20220220/br -V\r\nRelease Version: v5.5.0-alpha\r\nGit Commit Hash: 171a35486036e8ea5b168c2d4d29f4639df1611d\r\nGit Branch: heads/refs/tags/v5.5.0-alpha\r\nGo Version: go1.16.4\r\nUTC Build Time: 2022-02-20 14:51:31\r\nRace Enabled: false\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\nCentOS Linux release 7.6.1810 (Core)\r\nIntel(R) Xeon(R) CPU E5-2630 v4 @ 2.20GHz\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n1. raw_put an entry with empty key by client-go\r\n2. tiup br:nightly backup raw --pd 127.0.0.1:33968 -s \"local:///xxx\" --cf default\r\n\r\n### What did you expect?\r\nBackup successfully without error.\r\n\r\n### What did happened?\r\nTiKV panic at https://github.com/tikv/tikv/blob/b1b470f9baa0e0b4acee10229676ce73167bf9a2/components/backup/src/writer.rs#L392\r\nBacktrace:\r\n```\r\n[2022/02/23 22:51:54.802 +08:00] [FATAL] [lib.rs:466] [\"assertion failed: !k.is_empty()\"][backtrace=\"\r\n   0: tikv_util::set_panic_hook::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/lib.rs:465:18\r\n   1: std::panicking::rust_panic_with_hook\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/panicking.rs:702:17\r\n   2: std::panicking::begin_panic_handler::{{closure}}\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/panicking.rs:586:13\r\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/sys_common/backtrace.rs:138:18\r\n   4: rust_begin_unwind\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/panicking.rs:584:5\r\n   5: core::panicking::panic_fmt\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/core/src/panicking.rs:143:14\r\n   6: core::panicking::panic\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/core/src/panicking.rs:48:5\r\n   7: backup::writer::BackupRawKVWriter::write\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/backup/src/writer.rs:392:13\r\n   8: backup::endpoint::BackupRange::backup_raw\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/backup/src/endpoint.rs:465:29\r\n      backup::endpoint::BackupRange::backup_raw_kv_to_file::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/backup/src/endpoint.rs:503:26\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/core/src/future/mod.rs:84:19\r\n      backup::endpoint::Endpoint<E,R>::spawn_backup_worker::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/backup/src/endpoint.rs:867:30\r\n   9: <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/core/src/future/mod.rs:84:19\r\n      backup::utils::DaemonRuntime::spawn::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/backup/src/utils.rs:20:14\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/core/src/future/mod.rs:84:19\r\n      tokio::runtime::task::core::CoreStage<T>::poll::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/core.rs:161:17\r\n      tokio::loom::std::unsafe_cell::UnsafeCell<T>::with_mut\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/loom/std/unsafe_cell.rs:14:9\r\n      tokio::runtime::task::core::CoreStage<T>::poll\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/core.rs:151:13\r\n      tokio::runtime::task::harness::poll_future::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/harness.rs:461:19\r\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/core/src/panic/unwind_safe.rs:271:9\r\n      std::panicking::try::do_call\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/panicking.rs:492:40\r\n      std::panicking::try\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/panicking.rs:456:19\r\n      std::panic::catch_unwind\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/panic.rs:137:14\r\n      tokio::runtime::task::harness::poll_future\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/harness.rs:449:18\r\n  10: tokio::runtime::task::harness::Harness<T,S>::poll_inner\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/harness.rs:98:27\r\n      tokio::runtime::task::harness::Harness<T,S>::poll\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/harness.rs:53:15\r\n      tokio::runtime::task::raw::poll\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/raw.rs:113:5\r\n  11: tokio::runtime::task::raw::RawTask::poll\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/raw.rs:70:18\r\n      tokio::runtime::task::LocalNotified<S>::run\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/mod.rs:343:9\r\n      tokio::runtime::thread_pool::worker::Context::run_task::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/thread_pool/worker.rs:420:13\r\n      tokio::coop::with_budget::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/coop.rs:106:9\r\n      std::thread::local::LocalKey<T>::try_with\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/thread/local.rs:413:16\r\n      std::thread::local::LocalKey<T>::with\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/thread/local.rs:389:9\r\n      tokio::coop::with_budget\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/coop.rs:99:5\r\n      tokio::coop::budget\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/coop.rs:76:5\r\n      tokio::runtime::thread_pool::worker::Context::run_task\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/thread_pool/worker.rs:419:9\r\n  12: tokio::runtime::thread_pool::worker::Context::run\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/thread_pool/worker.rs:386:24\r\n      tokio::runtime::thread_pool::worker::run::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/thread_pool/worker.rs:371:17\r\n      tokio::macros::scoped_tls::ScopedKey<T>::set\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/macros/scoped_tls.rs:61:9\r\n      tokio::runtime::thread_pool::worker::run\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/thread_pool/worker.rs:368:5\r\n      tokio::runtime::thread_pool::worker::Launch::launch::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/thread_pool/worker.rs:347:45\r\n      <tokio::runtime::blocking::task::BlockingTask<T> as core::future::future::Future>::poll\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/blocking/task.rs:42:21\r\n      tokio::runtime::task::core::CoreStage<T>::poll::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/core.rs:161:17\r\n      tokio::loom::std::unsafe_cell::UnsafeCell<T>::with_mut\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/loom/std/unsafe_cell.rs:14:9\r\n      tokio::runtime::task::core::CoreStage<T>::poll\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/core.rs:151:13\r\n      tokio::runtime::task::harness::poll_future::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/harness.rs:461:19\r\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/core/src/panic/unwind_safe.rs:271:9\r\n      std::panicking::try::do_call\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/panicking.rs:492:40\r\n      std::panicking::try\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/panicking.rs:456:19\r\n      std::panic::catch_unwind\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/panic.rs:137:14\r\n      tokio::runtime::task::harness::poll_future\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/harness.rs:449:18\r\n      tokio::runtime::task::harness::Harness<T,S>::poll_inner\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/harness.rs:98:27\r\n      tokio::runtime::task::harness::Harness<T,S>::poll\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/harness.rs:53:15\r\n      tokio::runtime::task::raw::poll\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/raw.rs:113:5\r\n  13: tokio::runtime::task::raw::RawTask::poll\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/raw.rs:70:18\r\n      tokio::runtime::task::UnownedTask<S>::run\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/task/mod.rs:379:9\r\n      tokio::runtime::blocking::pool::Inner::run\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/blocking/pool.rs:265:17\r\n      tokio::runtime::blocking::pool::Spawner::spawn_thread::{{closure}}\r\n             at /rust/registry/src/github.com-1ecc6299db9ec823/tokio-1.12.0/src/runtime/blocking/pool.rs:245:17\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/sys_common/backtrace.rs:122:18\r\n  14: std::thread::Builder::spawn_unchecked_::{{closure}}::{{closure}}\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/thread/mod.rs:498:17\r\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/core/src/panic/unwind_safe.rs:271:9\r\n      std::panicking::try::do_call\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/panicking.rs:492:40\r\n      std::panicking::try\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/panicking.rs:456:19\r\n      std::panic::catch_unwind\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/panic.rs:137:14\r\n      std::thread::Builder::spawn_unchecked_::{{closure}}\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/thread/mod.rs:497:30\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/core/src/ops/function.rs:227:5\r\n  15: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/alloc/src/boxed.rs:1854:9\r\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/alloc/src/boxed.rs:1854:9\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at /rustc/1e12aef3fab243407f9d71ba9956cb2a1bf105d5/library/std/src/sys/unix/thread.rs:108:17\r\n  16: start_thread\r\n  17: clone\r\n\"] [location=/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/backup/src/writer.rs:392] [thread_name=bkwkr]\r\n```\r\n",
  "state": "closed",
  "created_at": "2022-02-24T06:32:29Z",
  "updated_at": "2022-04-30T08:15:27Z",
  "closed_at": "2022-04-30T08:15:27Z",
  "labels": [
    "type/bug",
    "severity/moderate"
  ],
  "comments_data": [
    {
      "id": 1049540685,
      "user": "pingyu",
      "created_at": "2022-02-24T06:37:14Z",
      "body": "/assign"
    },
    {
      "id": 1049540779,
      "user": "pingyu",
      "created_at": "2022-02-24T06:37:28Z",
      "body": "/type bug"
    },
    {
      "id": 1067499543,
      "user": "Lily2025",
      "created_at": "2022-03-15T02:34:23Z",
      "body": "/severity Moderate"
    },
    {
      "id": 1076016823,
      "user": "pingyu",
      "created_at": "2022-03-23T07:34:05Z",
      "body": "cc @zz-jason @haojinming "
    },
    {
      "id": 1113946717,
      "user": "pingyu",
      "created_at": "2022-04-30T08:15:27Z",
      "body": "This issue is fixed by #12303"
    }
  ]
}