{
  "issue_number": 10091,
  "title": "CDC old value cache keeps grow after all regions are deregistered",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n![image](https://user-images.githubusercontent.com/2150711/116336807-c483a300-a80b-11eb-953e-e203db617856.png)\r\n![image](https://user-images.githubusercontent.com/2150711/116336823-cb121a80-a80b-11eb-8138-ad903f669316.png)\r\n\r\nAfter all regions are deregistered, TiKV should add more old values to cache.\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\n```\r\n# create a changefeed with old value enabled.\r\nsysbench --db-driver=mysql --mysql-host=172.16.5.33 --mysql-port=47904 --mysql-user=root --time=15000 --report-interval=10 --threads=64 --mysql-db=test --tables=1 --table-size=6000000 oltp_write_only prepare && \\\r\nsleep 60 && sysbench --db-driver=mysql --mysql-host=172.16.5.33 --mysql-port=47904 --mysql-user=root --time=15000 --report-interval=10 --threads=64 --mysql-db=test --tables=1 --table-size=6000000 oltp_write_only run\r\nkill -SIGSTOP CDCPID\r\n```\r\n\r\n<details> <summary> TiKV log </summary>\r\n\r\n```\r\n[2021/04/28 10:02:01.058 +08:00] [INFO] [<unknown>] [\"ipv4:172.16.5.33:45240: Keepalive watchdog fired. Closing transport.\"]\r\n[2021/04/28 10:02:01.058 +08:00] [INFO] [service.rs:350] [\"cdc receive closed\"] [conn_id=ConnID(19)] [downstream=ipv4:172.16.5.33:45240]\r\n[2021/04/28 10:02:01.058 +08:00] [WARN] [service.rs:375] [\"cdc send failed\"] [conn_id=ConnID(19)] [downstream=ipv4:172.16.5.33:45240] [error=RemoteStopped]\r\n[2021/04/28 10:02:01.058 +08:00] [INFO] [endpoint.rs:344] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"conn\\\", conn_id: ConnID(19) }\"]\r\n[2021/04/28 10:02:01.058 +08:00] [INFO] [endpoint.rs:344] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"conn\\\", conn_id: ConnID(19) }\"]\r\n[2021/04/28 10:02:01.066 +08:00] [INFO] [<unknown>] [\"ipv4:172.16.5.33:45242: Keepalive watchdog fired. Closing transport.\"]\r\n[2021/04/28 10:02:01.066 +08:00] [INFO] [service.rs:350] [\"cdc receive closed\"] [conn_id=ConnID(20)] [downstream=ipv4:172.16.5.33:45242]\r\n[2021/04/28 10:02:01.066 +08:00] [INFO] [endpoint.rs:344] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"conn\\\", conn_id: ConnID(20) }\"]\r\n[2021/04/28 10:02:01.066 +08:00] [WARN] [service.rs:375] [\"cdc send failed\"] [conn_id=ConnID(20)] [downstream=ipv4:172.16.5.33:45242] [error=RemoteStopped]\r\n[2021/04/28 10:02:01.066 +08:00] [INFO] [endpoint.rs:344] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"conn\\\", conn_id: ConnID(20) }\"]\r\n[2021/04/28 10:02:03.538 +08:00] [INFO] [service.rs:350] [\"cdc receive closed\"] [conn_id=ConnID(21)] [downstream=ipv4:172.16.5.33:45262]\r\n[2021/04/28 10:02:03.539 +08:00] [INFO] [endpoint.rs:344] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"conn\\\", conn_id: ConnID(21) }\"]\r\n[2021/04/28 10:02:03.539 +08:00] [WARN] [service.rs:375] [\"cdc send failed\"] [conn_id=ConnID(21)] [downstream=ipv4:172.16.5.33:45262] [error=RemoteStopped]\r\n[2021/04/28 10:02:03.546 +08:00] [INFO] [endpoint.rs:344] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"conn\\\", conn_id: ConnID(21) }\"]\r\n[2021/04/28 10:02:03.870 +08:00] [INFO] [size.rs:168] [\"approximate size over threshold, need to do split check\"] [threshold=150994944] [size=156820425] [region_id=2]\r\n[2021/04/28 10:02:04.361 +08:00] [INFO] [split_check.rs:302] [\"update approximate size and keys with accurate value\"] [keys=354265] [size=154807406] [region_id=2]\r\n[2021/04/28 10:02:04.362 +08:00] [INFO] [peer.rs:3611] [\"on split\"] [source=\"split checker\"] [split_keys=\"key 7480000000000000FF335F728000000005FF8FAA280000000000FAFA1BA7285603FFCA\"] [peer_id=3] [region_id=2]\r\n[2021/04/28 10:02:04.362 +08:00] [INFO] [pd.rs:554] [\"try to batch split region\"] [task=batch_split] [region=\"id: 2 start_key: 7480000000000000FF335F728000000005FF8DE8410000000000FA region_epoch { conf_ver: 1 version: 838 } peers { id: 3 store_id: 1 }\"] [new_region_ids=\"[\r\n[2021/04/28 10:02:04.363 +08:00] [INFO] [apply.rs:1292] [\"execute admin command\"] [command=\"cmd_type: BatchSplit splits { requests { split_key: 7480000000000000FF335F728000000005FF8FAA280000000000FA new_region_id: 1882 new_peer_ids: 1883 } right_derive: true }\"] [index=80\r\n[2021/04/28 10:02:04.363 +08:00] [INFO] [apply.rs:2131] [\"split region\"] [keys=\"key 7480000000000000FF335F728000000005FF8FAA280000000000FA\"] [region=\"id: 2 start_key: 7480000000000000FF335F728000000005FF8DE8410000000000FA region_epoch { conf_ver: 1 version: 838 } peers {\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [peer.rs:2223] [\"notify pd with split\"] [split_count=2] [peer_id=3] [region_id=2]\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [peer.rs:2302] [\"insert new region\"] [region=\"id: 1882 start_key: 7480000000000000FF335F728000000005FF8DE8410000000000FA end_key: 7480000000000000FF335F728000000005FF8FAA280000000000FA region_epoch { conf_ver: 1 version: 839 } peers\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [peer.rs:190] [\"create peer\"] [peer_id=1883] [region_id=1882]\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [raft.rs:2443] [\"switched to configuration\"] [config=\"Configuration { voters: Configuration { incoming: Configuration { voters: {1883} }, outgoing: Configuration { voters: {} } }, learners: {}, learners_next: {}, auto_leave: false }\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [raft.rs:1064] [\"became follower at term 5\"] [term=5] [raft_id=1883] [region_id=1882]\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [raft.rs:375] [newRaft] [peers=\"Configuration { incoming: Configuration { voters: {1883} }, outgoing: Configuration { voters: {} } }\"] [\"last term\"=5] [\"last index\"=5] [applied=5] [commit=5] [term=5] [raft_id=1883] [region_id=1882]\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [raw_node.rs:285] [\"RawNode created with id 1883.\"] [id=1883] [raft_id=1883] [region_id=1882]\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [raft.rs:1488] [\"starting a new election\"] [term=5] [raft_id=1883] [region_id=1882]\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [raft.rs:1114] [\"became pre-candidate at term 5\"] [term=5] [raft_id=1883] [region_id=1882]\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [raft.rs:1088] [\"became candidate at term 6\"] [term=6] [raft_id=1883] [region_id=1882]\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [raft.rs:1172] [\"became leader at term 6\"] [term=6] [raft_id=1883] [region_id=1882]\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [peer.rs:3611] [\"require updating max ts\"] [initial_status=25769805454] [region_id=1882]\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [endpoint.rs:223] [\"register observe region\"] [region=\"id: 1882 start_key: 7480000000000000FF335F728000000005FF8DE8410000000000FA end_key: 7480000000000000FF335F728000000005FF8FAA280000000000FA region_epoch { conf_ver: 1 version: 83\r\n[2021/04/28 10:02:04.364 +08:00] [INFO] [pd.rs:982] [\"succeed to update max timestamp\"] [region_id=1882]\r\n[2021/04/28 10:02:04.365 +08:00] [INFO] [scheduler.rs:391] [\"get snapshot failed\"] [err=\"Request(message: \\\"EpochNotMatch current epoch of region 2 is conf_ver: 1 version: 839, but you sent conf_ver: 1 version: 838\\\" epoch_not_match { current_regions { id: 2 start_key: 74\r\n[2021/04/28 10:02:04.365 +08:00] [INFO] [scheduler.rs:391] [\"get snapshot failed\"] [err=\"Request(message: \\\"EpochNotMatch current epoch of region 2 is conf_ver: 1 version: 839, but you sent conf_ver: 1 version: 838\\\" epoch_not_match { current_regions { id: 2 start_key: 74\r\n[2021/04/28 10:02:04.365 +08:00] [INFO] [scheduler.rs:391] [\"get snapshot failed\"] [err=\"Request(message: \\\"EpochNotMatch current epoch of region 2 is conf_ver: 1 version: 839, but you sent conf_ver: 1 version: 838\\\" epoch_not_match { current_regions { id: 2 start_key: 74\r\n[2021/04/28 10:02:04.365 +08:00] [INFO] [scheduler.rs:391] [\"get snapshot failed\"] [err=\"Request(message: \\\"EpochNotMatch current epoch of region 2 is conf_ver: 1 version: 839, but you sent conf_ver: 1 version: 838\\\" epoch_not_match { current_regions { id: 2 start_key: 74\r\n[2021/04/28 10:02:04.365 +08:00] [INFO] [scheduler.rs:391] [\"get snapshot failed\"] [err=\"Request(message: \\\"EpochNotMatch current epoch of region 2 is conf_ver: 1 version: 839, but you sent conf_ver: 1 version: 838\\\" epoch_not_match { current_regions { id: 2 start_key: 74\r\n[2021/04/28 10:02:10.562 +08:00] [INFO] [<unknown>] [\"ipv4:172.16.5.33:45203: Keepalive watchdog fired. Closing transport.\"]\r\n[2021/04/28 10:02:10.562 +08:00] [INFO] [service.rs:350] [\"cdc receive closed\"] [conn_id=ConnID(18)] [downstream=ipv4:172.16.5.33:45203]\r\n[2021/04/28 10:02:10.562 +08:00] [INFO] [endpoint.rs:344] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"conn\\\", conn_id: ConnID(18) }\"]\r\n[2021/04/28 10:02:10.562 +08:00] [WARN] [service.rs:375] [\"cdc send failed\"] [conn_id=ConnID(18)] [downstream=ipv4:172.16.5.33:45203] [error=RemoteStopped]\r\n[2021/04/28 10:02:10.562 +08:00] [INFO] [endpoint.rs:344] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"conn\\\", conn_id: ConnID(18) }\"]\r\n[2021/04/28 10:02:10.562 +08:00] [INFO] [<unknown>] [\"ipv4:172.16.5.33:45206: Keepalive watchdog fired. Closing transport.\"]\r\n[2021/04/28 10:02:10.562 +08:00] [INFO] [service.rs:350] [\"cdc receive closed\"] [conn_id=ConnID(17)] [downstream=ipv4:172.16.5.33:45206]\r\n[2021/04/28 10:02:10.562 +08:00] [WARN] [service.rs:375] [\"cdc send failed\"] [conn_id=ConnID(17)] [downstream=ipv4:172.16.5.33:45206] [error=RemoteStopped]\r\n[2021/04/28 10:02:10.562 +08:00] [INFO] [endpoint.rs:344] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"conn\\\", conn_id: ConnID(17) }\"]\r\n[2021/04/28 10:02:10.562 +08:00] [INFO] [endpoint.rs:344] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"conn\\\", conn_id: ConnID(17) }\"]\r\n[2021/04/28 10:02:11.196 +08:00] [INFO] [tracker.rs:248] [slow-query] [perf_stats.internal_delete_skipped_count=0] [perf_stats.internal_key_skipped_count=230567] [perf_stats.block_read_byte=58208852] [perf_stats.block_read_count=1510] [perf_stats.block_cache_hit_count=28]\r\n[2021/04/28 10:02:28.106 +08:00] [INFO] [tracker.rs:248] [slow-query] [perf_stats.internal_delete_skipped_count=0] [perf_stats.internal_key_skipped_count=230349] [perf_stats.block_read_byte=58226987] [perf_stats.block_read_count=1514] [perf_stats.block_cache_hit_count=26]\r\n[2021/04/28 10:02:43.875 +08:00] [INFO] [size.rs:168] [\"approximate size over threshold, need to do split check\"] [threshold=150994944] [size=162088236] [region_id=2]\r\n[2021/04/28 10:02:44.582 +08:00] [INFO] [split_check.rs:302] [\"update approximate size and keys with accurate value\"] [keys=374075] [size=163454334] [region_id=2]\r\n[2021/04/28 10:02:44.583 +08:00] [INFO] [peer.rs:3611] [\"on split\"] [source=\"split checker\"] [split_keys=\"key 7480000000000000FF335F728000000005FF916C0F0000000000FAFA1BA725FE03FFE8\"] [peer_id=3] [region_id=2]\r\n[2021/04/28 10:02:44.583 +08:00] [INFO] [pd.rs:554] [\"try to batch split region\"] [task=batch_split] [region=\"id: 2 start_key: 7480000000000000FF335F728000000005FF8FAA280000000000FA region_epoch { conf_ver: 1 version: 839 } peers { id: 3 store_id: 1 }\"] [new_region_ids=\"[\r\n[2021/04/28 10:02:44.584 +08:00] [INFO] [apply.rs:1292] [\"execute admin command\"] [command=\"cmd_type: BatchSplit splits { requests { split_key: 7480000000000000FF335F728000000005FF916C0F0000000000FA new_region_id: 1884 new_peer_ids: 1885 } right_derive: true }\"] [index=80\r\n[2021/04/28 10:02:44.584 +08:00] [INFO] [apply.rs:2131] [\"split region\"] [keys=\"key 7480000000000000FF335F728000000005FF916C0F0000000000FA\"] [region=\"id: 2 start_key: 7480000000000000FF335F728000000005FF8FAA280000000000FA region_epoch { conf_ver: 1 version: 839 } peers {\r\n[2021/04/28 10:02:44.584 +08:00] [INFO] [peer.rs:2223] [\"notify pd with split\"] [split_count=2] [peer_id=3] [region_id=2]\r\n[2021/04/28 10:02:44.584 +08:00] [INFO] [peer.rs:2302] [\"insert new region\"] [region=\"id: 1884 start_key: 7480000000000000FF335F728000000005FF8FAA280000000000FA end_key: 7480000000000000FF335F728000000005FF916C0F0000000000FA region_epoch { conf_ver: 1 version: 840 } peers\r\n```\r\n\r\n</details>\r\n\r\n### What did you expect?\r\n\r\nNo more old values are added to the cache after regions deregistered.\r\n",
  "state": "closed",
  "created_at": "2021-04-28T02:29:56Z",
  "updated_at": "2022-02-15T07:41:39Z",
  "closed_at": "2022-02-15T07:41:39Z",
  "labels": [
    "type/bug",
    "difficulty/easy",
    "component/CDC",
    "severity/minor"
  ],
  "comments_data": [
    {
      "id": 837985583,
      "user": "overvenus",
      "created_at": "2021-05-11T07:27:50Z",
      "body": "@ben1009 Could you take a look?"
    },
    {
      "id": 1015473867,
      "user": "Rustin170506",
      "created_at": "2022-01-18T14:37:07Z",
      "body": "/assign\r\n\r\nI will take a look."
    }
  ]
}