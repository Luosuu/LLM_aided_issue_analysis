{
  "issue_number": 15712,
  "title": "[dr-autosync] flashback hang for more than 30min on second call",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nv6.5.5\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\n```\r\n[2023/09/26 11:04:31.343 +08:00] [INFO] [cmd.go:141] [\"Start remote command\"] [cmd=\"tiup ctl:v6.5.5 tikv --pd  pd3-peer.dr-autosync-hongmei-testbednqxzd:2379 flashback -v 444516650759749645 |tee /tmp/flashback_2023-09-26T11:04:31+08:00.log\"] [nodename=tiup]\r\n[2023/09/26 11:04:31.433 +08:00] [INFO] [cluster.go:1168] [\"Starting component `ctl`: /root/.tiup/components/ctl/v6.5.5/ctl /root/.tiup/components/ctl/v6.5.5/ctl tikv --pd pd3-peer.dr-autosync-hongmei-testbednqxzd:2379 flashback -v 444516650759749645\\r\\n\"]\r\n[2023/09/26 11:04:31.761 +08:00] [INFO] [cluster.go:1168] [\"flashback whole cluster with version 444516650759749645 from [] to []\\r\\n\"]\r\n[2023/09/26 11:05:36.045 +08:00] [INFO] [cluster.go:1168] [\"flashback all stores success!\\r\\n\"]\r\n[2023/09/26 11:05:36.107 +08:00] [INFO] [cluster.go:1160] [\"cmd stdout read eof\"]\r\n[2023/09/26 11:05:36.107 +08:00] [INFO] [cmd.go:188] [\"Remote command finished\"] [cmd=\"tiup ctl:v6.5.5 tikv --pd  pd3-peer.dr-autosync-hongmei-testbednqxzd:2379 flashback -v 444516650759749645 |tee /tmp/flashback_2023-09-26T11:04:31+08:00.log\"] [exitcode=0] []\r\n[2023/09/26 11:05:36.107 +08:00] [INFO] [cmd.go:201] [\"All cmd goroutine are finished\"] []\r\n[2023/09/26 11:05:36.107 +08:00] [INFO] [cluster.go:1137] [\"flashback output\"] [output=\"Starting component `ctl`: /root/.tiup/components/ctl/v6.5.5/ctl /root/.tiup/components/ctl/v6.5.5/ctl tikv --pd pd3-peer.dr-autosync-hongmei-testbednqxzd:2379 flashback -v 444516650759749645\\r\\n\\nflashback whole cluster with version 444516650759749645 from [] to []\\r\\n\\nflashback all stores success!\\r\\n\"]\r\n\r\n[2023/09/26 11:06:48.722 +08:00] [INFO] [utils.go:332] [\"run command\"] [command=\"/root/.tiup/components/ctl/v6.5.5/tikv-ctl -V\"] [node=tiup]\r\n2023-09-26T11:06:48.725+0800\tINFO\tk8s/client.go:132\tit should be noted that a long-running command will not be interrupted even the use case has ended. For more information, please refer to https://github.com/pingcap/test-infra/discussions/129\r\n[2023/09/26 11:06:48.823 +08:00] [INFO] [utils.go:346] [stdout] [stdout=]\r\nTiKV Control (tikv-ctl) \r\nRelease Version:   6.5.5\r\nEdition:           Community\r\nGit Commit Hash:   d7f7809ecdd3da92fe203f98676bd782fc0be5d7\r\nGit Commit Branch: heads/refs/tags/v6.5.5\r\nUTC Build Time:    2023-09-14 06:50:27\r\nRust Version:      rustc 1.67.0-nightly (96ddd32c4 2022-11-14)\r\nEnable Features:   pprof-fp jemalloc mem-profiling portable sse test-engine-kv-rocksdb test-engine-raft-raft-engine cloud-aws cloud-gcp cloud-azure\r\nProfile:           dist_release\r\n[2023/09/26 11:06:48.823 +08:00] [INFO] [cluster.go:1198] [\"tikv-ctl version\"] [version=\"TiKV Control (tikv-ctl) \\nRelease Version:   6.5.5\\nEdition:           Community\\nGit Commit Hash:   d7f7809ecdd3da92fe203f98676bd782fc0be5d7\\nGit Commit Branch: heads/refs/tags/v6.5.5\\nUTC Build Time:    2023-09-14 06:50:27\\nRust Version:      rustc 1.67.0-nightly (96ddd32c4 2022-11-14)\\nEnable Features:   pprof-fp jemalloc mem-profiling portable sse test-engine-kv-rocksdb test-engine-raft-raft-engine cloud-aws cloud-gcp cloud-azure\\nProfile:           dist_release\"]\r\n2023-09-26T11:06:48.830+0800\tINFO\tk8s/client.go:220\tit should be noted that a long-running command will not be interrupted even the use case has ended. For more information, please refer to https://github.com/pingcap/test-infra/discussions/129\r\n[2023/09/26 11:06:48.830 +08:00] [INFO] [cmd.go:141] [\"Start remote command\"] [cmd=\"tiup ctl:v6.5.5 tikv --pd  pd3-peer.dr-autosync-hongmei-testbednqxzd:2379 flashback -v 444516138399039547 |tee /tmp/flashback_2023-09-26T11:06:48+08:00.log\"] [nodename=tiup]\r\n[2023/09/26 11:06:48.917 +08:00] [INFO] [cluster.go:1168] [\"Starting component `ctl`: /root/.tiup/components/ctl/v6.5.5/ctl /root/.tiup/components/ctl/v6.5.5/ctl tikv --pd pd3-peer.dr-autosync-hongmei-testbednqxzd:2379 flashback -v 444516138399039547\\r\\n\"]\r\n[2023/09/26 11:06:49.238 +08:00] [INFO] [cluster.go:1168] [\"flashback whole cluster with version 444516138399039547 from [] to []\\r\\n\"]\r\n[2023/09/26 11:07:01.421 +08:00] [INFO] [cluster.go:1168] [\"flashback key_range start_key: 7480000000000000FF585F728000000001FFC965780000000000FA end_key: 7480000000000000FF5A5F698000000000FF0000010380000000FF0000000403800000FF0000000002038000FF000000000B740380FF0000000000000600FE with start_ts 444516954073464833, commit_ts 0 need to retry, err is RpcFailure(RpcStatus { code: 2-UNKNOWN, message: \\\"exec prepare flashback failed.\\\", details: [] })\\r\\n\"]\r\n[2023/09/26 11:07:01.421 +08:00] [INFO] [cluster.go:1168] [\"prepare flashback region 7496 with start_ts TimeStamp(444516954073464833) to version 444516138399039547 failed, error: start_key: 7480000000000000FF585F728000000001FFC965780000000000FA end_key: 7480000000000000FF5A5F698000000000FF0000010380000000FF0000000403800000FF0000000002038000FF000000000B740380FF0000000000000600FE\\r\\n\"]\r\n[2023/09/26 11:07:07.349 +08:00] [INFO] [cluster.go:1168] [\"flashback key_range start_key: 7480000000000000FF545F728000000005FFFAC4930000000000FA end_key: 7480000000000000FF555F728000000000FF0008190000000000FA with start_ts 444516954073464833, commit_ts 0 need to retry, err is RpcFailure(RpcStatus { code: 2-UNKNOWN, message: \\\"exec prepare flashback failed.\\\", details: [] })\\r\\n\"]\r\n[2023/09/26 11:07:07.349 +08:00] [INFO] [cluster.go:1168] [\"prepare flashback region 17348 with start_ts TimeStamp(444516954073464833) to version 444516138399039547 failed, error: start_key: 7480000000000000FF545F728000000005FFFAC4930000000000FA end_key: 7480000000000000FF555F728000000000FF0008190000000000FA\\r\\n\"]\r\n[2023/09/26 11:11:56.573 +08:00] [INFO] [cluster.go:1168] [\"flashback key_range start_key: 7480000000000000FF585F728000000001FFC965780000000000FA end_key: 7480000000000000FF5A5F698000000000FF0000010380000000FF0000000403800000FF0000000002038000FF000000000B740380FF0000000000000600FE with start_ts 444516954073464833, commit_ts 444516962881503233 need to retry, err is RpcFailure(RpcStatus { code: 2-UNKNOWN, message: \\\"exec finish flashback failed.\\\", details: [] })\\r\\n\"]\r\n[2023/09/26 11:11:56.573 +08:00] [INFO] [cluster.go:1168] [\"finish flashback region 7496 with start_ts TimeStamp(444516954073464833) to version 444516138399039547 failed, error: start_key: 7480000000000000FF585F728000000001FFC965780000000000FA end_key: 7480000000000000FF5A5F698000000000FF0000010380000000FF0000000403800000FF0000000002038000FF000000000B740380FF0000000000000600FE\\r\\n\"]\r\n[2023/09/26 11:11:56.575 +08:00] [INFO] [cluster.go:1168] [\"flashback key_range start_key: 7480000000000000FF585F728000000001FFC965780000000000FA end_key: 7480000000000000FF5A5F698000000000FF0000010380000000FF0000000403800000FF0000000002038000FF000000000B740380FF0000000000000600FE with start_ts 444516954073464833, commit_ts 444516962881503233 need to retry, err is RpcFailure(RpcStatus { code: 2-UNKNOWN, message: \\\"exec finish flashback failed.\\\", details: [] })\\r\\n\"]\r\n[2023/09/26 11:11:56.575 +08:00] [INFO] [cluster.go:1168] [\"finish flashback region 7496 with start_ts TimeStamp(444516954073464833) to version 444516138399039547 failed, error: start_key: 7480000000000000FF585F728000000001FFC965780000000000FA end_key: 7480000000000000FF5A5F698000000000FF0000010380000000FF0000000403800000FF0000000002038000FF000000000B740380FF0000000000000600FE\\r\\n\"]\r\n[2023/09/26 11:11:56.575 +08:00] [INFO] [cluster.go:1171] [\"max line number acheived, cancel\"]\r\n[2023/09/26 11:11:56.575 +08:00] [INFO] [cluster.go:1137] [\"flashback output\"] [output=\"Starting component `ctl`: /root/.tiup/components/ctl/v6.5.5/ctl /root/.tiup/components/ctl/v6.5.5/ctl tikv --pd pd3-peer.dr-autosync-hongmei-testbednqxzd:2379 flashback -v 444516138399039547\\r\\n\\nflashback whole cluster with version 444516138399039547 from [] to []\\r\\n\\nflashback key_range start_key: 7480000000000000FF585F728000000001FFC965780000000000FA end_key: 7480000000000000FF5A5F698000000000FF0000010380000000FF0000000403800000FF0000000002038000FF000000000B740380FF0000000000000600FE with start_ts 444516954073464833, commit_ts 0 need to retry, err is RpcFailure(RpcStatus { code: 2-UNKNOWN, message: \\\"exec prepare flashback failed.\\\", details: [] })\\r\\n\\nprepare flashback region 7496 with start_ts TimeStamp(444516954073464833) to version 444516138399039547 failed, error: start_key: 7480000000000000FF585F728000000001FFC965780000000000FA end_key: 7480000000000000FF5A5F698000000000FF0000010380000000FF0000000403800000FF0000000002038000FF000000000B740380FF0000000000000600FE\\r\\n\\nflashback key_range start_key: 7480000000000000FF545F728000000005FFFAC4930000000000FA end_key: 7480000000000000FF555F728000000000FF0008190000000000FA with start_ts 444516954073464833, commit_ts 0 need to retry, err is RpcFailure(RpcStatus { code: 2-UNKNOWN, message: \\\"exec prepare flashback failed.\\\", details: [] })\\r\\n\\nprepare flashback region 17348 with start_ts TimeStamp(444516954073464833) to version 444516138399039547 failed, error: start_key: 7480000000000000FF545F728000000005FFFAC4930000000000FA end_key: 7480000000000000FF555F728000000000FF0008190000000000FA\\r\\n\\nflashback key_range start_key: 7480000000000000FF585F728000000001FFC965780000000000FA end_key: 7480000000000000FF5A5F698000000000FF0000010380000000FF0000000403800000FF0000000002038000FF000000000B740380FF0000000000000600FE with start_ts 444516954073464833, commit_ts 444516962881503233 need to retry, err is RpcFailure(RpcStatus { code: 2-UNKNOWN, message: \\\"exec finish flashback failed.\\\", details: [] })\\r\\n\\nfinish flashback region 7496 with start_ts TimeStamp(444516954073464833) to version 444516138399039547 failed, error: start_key: 7480000000000000FF585F728000000001FFC965780000000000FA end_key: 7480000000000000FF5A5F698000000000FF0000010380000000FF0000000403800000FF0000000002038000FF000000000B740380FF0000000000000600FE\\r\\n\\nflashback key_range start_key: 7480000000000000FF585F728000000001FFC965780000000000FA end_key: 7480000000000000FF5A5F698000000000FF0000010380000000FF0000000403800000FF0000000002038000FF000000000B740380FF0000000000000600FE with start_ts 444516954073464833, commit_ts 444516962881503233 need to retry, err is RpcFailure(RpcStatus { code: 2-UNKNOWN, message: \\\"exec finish flashback failed.\\\", details: [] })\\r\\n\\nfinish flashback region 7496 with start_ts TimeStamp(444516954073464833) to version 444516138399039547 failed, error: start_key: 7480000000000000FF585F728000000001FFC965780000000000FA end_key: 7480000000000000FF5A5F698000000000FF0000010380000000FF0000000403800000FF0000000002038000FF000000000B740380FF0000000000000600FE\\r\\n\"]\r\n[2023/09/26 11:49:13.581 +08:00] [INFO] [cmd.go:160] [\"Stop remote command since context is done\"] [cmd=\"tiup ctl:v6.5.5 tikv --pd  pd3-peer.dr-autosync-hongmei-testbednqxzd:2379 flashback -v 444516138399039547 |tee /tmp/flashback_2023-09-26T11:06:48+08:00.log\"] [nodename=tiup]\r\n\r\n```\r\n\r\n### What did you expect?\r\nThe second call flashback can be succeeded.\r\n\r\n### What did happened?\r\nHang for more than 30min.\r\n\r\n",
  "state": "closed",
  "created_at": "2023-09-28T03:55:07Z",
  "updated_at": "2023-11-24T10:40:16Z",
  "closed_at": "2023-11-24T10:40:16Z",
  "labels": [
    "type/bug",
    "severity/critical",
    "affects-6.5",
    "affects-7.5"
  ],
  "comments_data": [
    {
      "id": 1738396478,
      "user": "mayjiang0203",
      "created_at": "2023-09-28T03:55:37Z",
      "body": "/assign @HuSharp \r\n/severity critical"
    },
    {
      "id": 1738396999,
      "user": "mayjiang0203",
      "created_at": "2023-09-28T03:56:38Z",
      "body": "/remove-label may-affects-5.3\r\n/remove-label may-affects-5.4\r\n/remove-label may-affects-6.1\r\n/label affects-6.5\r\n/label affects-7.1"
    },
    {
      "id": 1824078175,
      "user": "HuSharp",
      "created_at": "2023-11-23T09:42:04Z",
      "body": "Root: \r\nAfter `PrepareFlashback` the region and the region leader transfer, when executing `FinishFlashback` will meet `notLeader`. Since the tikv ctl retry `FinishFlashback` for the same peer, it just keeps doing useless retries.\r\n\r\nSolution:\r\nneet to support backoff load key range to identify peer in finish flashback when meet `notLeader` or `regionNotFound`"
    }
  ]
}