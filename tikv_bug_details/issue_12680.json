{
  "issue_number": 12680,
  "title": "RawKV API V2 timestamp causality violation",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nmaster, commit 4facb625c18d2b74cfae4c4c472c75e991fe990e\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\nCentOS 7.6\r\nIntel(R) Xeon(R) CPU E5-2630 v4 @ 2.20GHz\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n1. Setup a real cluster with 2 x TiDB + 3 x PD + 4 x TiKV by TiUP cluster.\r\n2. Add `shuffle-leader-scheduler`, `shuffle-region-scheduler`, `random-merge-scheduler`, and periodic split region by \"operator add split-region 1 --policy=approximate\".\r\n3. Run a 800 threads program and each thread running the following codes repeatedly:\r\n```go\r\n\tTry(cli.Put(ctx, key, value0))\r\n\tTry(cli.Put(ctx, key, value1))\r\n\r\n\t// Verify order by Get\r\n\tres := Try(cli.Get(ctx, key)).([]byte)\r\n\tExpect(res).To(Equal(value1), \"key: %v\", string(key))\r\n\r\n\t// Verify order by Scan\r\n\tkeys, values, err := cli.Scan(ctx, key, append(key, 0), 100)\r\n\tExpect(err).Should(Succeed())\r\n\tExpect(len(keys)).To(Equal(1))\r\n\tExpect(keys[0]).To(Equal(key))\r\n\tExpect(values[0]).To(Equal(value1))\r\n\r\n\t// Verify Delete\r\n\tTry(cli.Delete(ctx, key))\r\n\tres = Try(cli.Get(ctx, key)).([]byte)\r\n\tExpect(res).To(BeEmpty(), \"key: %v\", string(key))\r\n\r\n\t// Verify again\r\n\tTry(cli.Put(ctx, key, value1))\r\n\tTry(cli.Put(ctx, key, value0))\r\n\tres = Try(cli.Get(ctx, key)).([]byte)\r\n\tExpect(res).To(Equal(value0), \"key: %v\", string(key))\r\n```\r\n\r\n### What did you expect?\r\nExpect succeed.\r\n\r\n### What did happened?\r\nFailure on \"Verify Delete\".\r\n```\r\n    key: rcc0000000014514500\r\n    Expected\r\n        <[]uint8 | len:73, cap:80>: 14514501_0000000000000000000000000000000000000000000000000000000000000000\r\n    to be empty\r\n```\r\n\r\n### Analysis\r\nSuppose:\r\n1. Store 1, with timestamp 200, region 1 (leader), region 2 (follower)\r\n2. Store 2, with timestamp 100, region 1 (follower), region 2 (leader)\r\n\r\nThen, merge region 1 to 2:\r\n1. Store 1, with timestamp 200, region 2 (follower)\r\n2. Store 2, with timestamp 100, region 2 (leader)\r\n\r\nNow, mutations of keys in the range of region 1 before merge, will write into region 2 in store 2, with a timestamp smaller than 200.\r\n\r\n##### Records in RocksDB\r\n```\r\n# ~/tikv-ctl --data-dir /data/tidb-data/tikv-20160/ raw-scan -f \"zrcc00000\\37700014514\\377500\\000\\000\\000\\000\\000\\372\" -t \"zrcc00000\\37700014514\\377500\\000\\000\\000\\000\\000\\373\"\r\nkey: \"zrcc00000\\37700014514\\377500\\000\\000\\000\\000\\000\\372\\371\\373\\353X>\\323\\376\\002\", value: \"14514501_0000000000000000000000000000000000000000000000000000000000000000\\000\"\r\nkey: \"zrcc00000\\37700014514\\377500\\000\\000\\000\\000\\000\\372\\371\\373\\353X>\\323\\376\\314\", value: \"14514500_0000000000000000000000000000000000000000000000000000000000000000\\000\"\r\nkey: \"zrcc00000\\37700014514\\377500\\000\\000\\000\\000\\000\\372\\371\\373\\353X?\\233\\375_\", value: \"\\002\"\r\n```\r\nThe records from top to bottom is`put(value1), ts 433494174867390973`, `put(value0), ts 433494174867390771`, and `delete 433494174854283936`. The timestamp of `delete` is smaller than expected.\r\n\r\n##### Timestamp tracing\r\n(binary string of key `rcc0000000014514500` is `7263633030303030FF3030303134353134FF3530300000000000FA`)\r\nStore 1\r\n```\r\n...\r\n[2022/05/27 18:57:23.559 +08:00] [INFO] [observer.rs:191] [\"causal_ts tracing: pre_propose_query, append_ts\"] [key=7263633030303030FF3030303134353134FF3530300000000000FAF9FBEB583ED3FECC] [ts=TimeStamp(433494174867390771)] [region=98115]\r\n[2022/05/27 18:57:23.570 +08:00] [INFO] [observer.rs:191] [\"causal_ts tracing: pre_propose_query, append_ts\"] [key=7263633030303030FF3030303134353134FF3530300000000000FAF9FBEB583ED3FE02] [ts=TimeStamp(433494174867390973)] [region=98115]\r\n...\r\n[2022/05/27 18:57:23.572 +08:00] [INFO] [pd.rs:1463] [\"try to merge\"] [merge=\"target { id: 96772 start_key: 7263633030303030FF3030303135373630FF3530300000000000FA end_key: 7263633030303030FF3030303136303836FF3337350000000000FA region_epoch { conf_ver: 4716 version: 70 } peers { id: 96774 store_id: 1 } peers { id: 96775 store_id: 6 } peers { id: 97803 store_id: 5 } }\"] [region_id=98115]\r\n...\r\n```\r\n\r\nStore 2\r\n```\r\n...\r\n[2022/05/27 18:57:23.600 +08:00] [INFO] [apply.rs:1395] [\"execute admin command\"] [command=\"cmd_type: PrepareMerge prepare_merge { min_index: 82 target { id: 96772 start_key: 7263633030303030FF3030303135373630FF3530300000000000FA end_key: 7263633030303030FF3030303136303836FF3337350000000000FA region_epoch { conf_ver: 4716 version: 70 } peers { id: 96774 store_id: 1 } peers { id: 96775 store_id: 6 } peers { id: 97803 store_id: 5 } } }\"] [index=83] [term=7] [peer_id=98118] [region_id=98115]\r\n...\r\n[2022/05/27 18:57:23.615 +08:00] [INFO] [apply.rs:2533] [\"execute CommitMerge\"] [source_region=\"id: 98115 start_key: 7263633030303030FF3030303133323132FF3132350000000000FA end_key: 7263633030303030FF3030303135373630FF3530300000000000FA region_epoch { conf_ver: 4717 version: 71 } peers { id: 98116 store_id: 1 } peers { id: 98117 store_id: 6 } peers { id: 98118 store_id: 5 }\"] [index=718] [term=7] [entries=2] [commit=83] [peer_id=97803] [region_id=96772]\r\n...\r\n[2022/05/27 18:57:23.624 +08:00] [INFO] [observer.rs:191] [\"causal_ts tracing: pre_propose_query, append_ts\"] [key=7263633030303030FF3030303134353134FF3530300000000000FAF9FBEB583F9BFD5F] [ts=TimeStamp(433494174854283936)] [region=96772]\r\n...\r\n```\r\n",
  "state": "closed",
  "created_at": "2022-05-28T08:14:35Z",
  "updated_at": "2022-05-30T12:52:27Z",
  "closed_at": "2022-05-30T12:52:27Z",
  "labels": [
    "type/bug",
    "severity/critical",
    "affects-6.1",
    "needs-cherry-pick-release-6.1"
  ],
  "comments_data": []
}