{
  "issue_number": 14113,
  "title": "[dynamic regions] TiKV panics with \"default not found\"",
  "body": "## Bug Report\r\n\r\n```\r\n[2023/01/31 18:35:34.919 +08:00] [INFO] [mod.rs:315] [on_apply_res] [apply_trace=\"ApplyTrace { data_cfs: [Progress { flushed: 19062634, last_modified: 19063733 }, Pro\r\ngress { flushed: 19062634, last_modified: 19063733 }, Progress { flushed: 19049747, last_modified: 19063610 }], admin: Progress { flushed: 19049747, last_modified: 18\r\n925353 }, persisted_applied: 19049747, last_flush_trigger: 0, try_persist: false }\"] [apply_res=\"ApplyRes { applied_index: 19063975, applied_term: 8, admin_result: []\r\n, modifications: [19063975, 19063975, 19063974], metrics: ApplyMetrics { size_diff_hint: 6053827, delete_keys_hint: 0, written_bytes: 6246985, written_keys: 27664, lo\r\nck_cf_written_bytes: 0 } }\"] [peer_id=318] [region_id=297]\r\n[2023/01/31 18:35:34.975 +08:00] [FATAL] [lib.rs:496] [\"[region_id=297] [tablet_index=18925353] default not found in []\"] [backtrace=\"   0: tikv_util::set_panic_hook:\r\n:{{closure}}\\n             at /home/pingcap/jay/tikv/components/tikv_util/src/lib.rs:495:18\\n   1: <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call\\n  \r\n           at /home/pingcap/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2032:9\\n      std::panickin\r\ng::rust_panic_with_hook\\n             at /home/pingcap/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.r\r\ns:692:13\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n             at /home/pingcap/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rus\r\ntlib/src/rust/library/std/src/panicking.rs:579:13\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n             at /home/pingcap/.rustup/toolchains/nigh\r\ntly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:137:18\\n   4: rust_begin_unwind\\n             at /home/pingcap/.r\r\nustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:575:5\\n   5: core::panicking::panic_fmt\\n             a\r\nt /home/pingcap/.rustup/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:65:14\\n   6: engine_traits::flush::P\r\nersistenceListener::on_flush_completed\\n             at /home/pingcap/jay/tikv/components/engine_traits/src/flush.rs:160:25\\n      <engine_rocks::event_listener::Rock\r\nsPersistenceListener as rocksdb::event_listener::EventListener>::on_flush_completed\\n             at /home/pingcap/jay/tikv/components/engine_rocks/src/event_listener\r\n.rs:197:9\\n      rocksdb::event_listener::on_flush_completed\\n             at /home/pingcap/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/14e4fe7/src/event_liste\r\nner.rs:302:5\\n   7: _ZN24crocksdb_eventlistener_t16OnFlushCompletedEPN7rocksdb2DBERKNS0_12FlushJobInfoE\\n             at /home/pingcap/.cargo/git/checkouts/rust-rocks\r\ndb-a9a28e74c6ead8ef/14e4fe7/librocksdb_sys/crocksdb/c.cc:2451:23\\n   8: _ZN7rocksdb6DBImpl22NotifyOnFlushCompletedEPNS_16ColumnFamilyDataERKNS_16MutableCFOptionsEPSt4\r\nlistISt10unique_ptrINS_12FlushJobInfoESt14default_deleteIS8_EESaISB_EE\\n             at /home/pingcap/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/14e4fe7/libro\r\ncksdb_sys/rocksdb/db/db_impl/db_impl_compaction_flush.cc:913:35\\n   9: _ZN7rocksdb6DBImpl25FlushMemTableToOutputFileEPNS_16ColumnFamilyDataERKNS_16MutableCFOptionsEPb\r\nPNS_10JobContextEPNS_19SuperVersionContextERSt6vectorImSaImEEmPNS_15SnapshotCheckerEPNS_9LogBufferENS_3Env8PriorityE\\n             at /home/pingcap/.cargo/git/checkou\r\nts/rust-rocksdb-a9a28e74c6ead8ef/14e4fe7/librocksdb_sys/rocksdb/db/db_impl/db_impl_compaction_flush.cc:351:27\\n  10: _ZN7rocksdb6DBImpl27FlushMemTablesToOutputFilesER\r\nKNS_10autovectorINS0_10BGFlushArgELm8EEEPbPNS_10JobContextEPNS_9LogBufferENS_3Env8PriorityE\\n             at /home/pingcap/.cargo/git/checkouts/rust-rocksdb-a9a28e74c\r\n6ead8ef/14e4fe7/librocksdb_sys/rocksdb/db/db_impl/db_impl_compaction_flush.cc:399:29\\n  11: _ZN7rocksdb6DBImpl15BackgroundFlushEPbPNS_10JobContextEPNS_9LogBufferEPNS_\r\n11FlushReasonENS_3Env8PriorityE\\n             at /home/pingcap/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/14e4fe7/librocksdb_sys/rocksdb/db/db_impl/db_impl_co\r\nmpaction_flush.cc:2824:41\\n  12: _ZN7rocksdb6DBImpl19BackgroundCallFlushENS_3Env8PriorityE\\n             at /home/pingcap/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6\r\nead8ef/14e4fe7/librocksdb_sys/rocksdb/db/db_impl/db_impl_compaction_flush.cc:2864:51\\n  13: _ZNKSt8functionIFvvEEclEv\\n             at /opt/rh/devtoolset-8/root/usr/i\r\nnclude/c++/8/bits/std_function.h:687:14\\n      _ZN7rocksdb14ThreadPoolImpl4Impl8BGThreadEm\\n             at /home/pingcap/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6\r\nead8ef/14e4fe7/librocksdb_sys/rocksdb/util/threadpool_imp.cc:266:9\\n  14: _ZN7rocksdb14ThreadPoolImpl4Impl15BGThreadWrapperEPv\\n             at /home/pingcap/.cargo/g\r\nit/checkouts/rust-rocksdb-a9a28e74c6ead8ef/14e4fe7/librocksdb_sys/rocksdb/util/threadpool_imp.cc:307:15\\n  15: execute_native_thread_routine\\n  16: start_thread\\n  17\r\n: clone3\\n\"] [location=components/engine_traits/src/flush.rs:160] [thread_name=<unnamed>]\r\n```",
  "state": "closed",
  "created_at": "2023-01-31T11:25:36Z",
  "updated_at": "2023-02-08T06:28:01Z",
  "closed_at": "2023-02-08T06:28:01Z",
  "labels": [
    "type/bug",
    "severity/moderate",
    "feature/developing"
  ],
  "comments_data": [
    {
      "id": 1414138214,
      "user": "BusyJay",
      "created_at": "2023-02-02T17:52:26Z",
      "body": "I reproduce the problem and there indeed is a reorder of flush complete records:\r\n```\r\n[2023/02/02 20:37:53.762 +08:00][5][INFO] [251_13119688][db/flush_job.cc:946] [lock] [JOB 385] Level-0 flush table #61020: 32858346 bytes OK\r\n[2023/02/02 20:37:54.047 +08:00][5][INFO] [251_13119688](Original Log Time 2023/02/02-20:37:54.009792) [db/db_impl/db_impl_compaction_flush.cc:301] [lock] Level summary: base level 6 level multiplier 10.00 max bytes base 134217728 files[1 0 0 0 0 0 4] max score 1.00\r\n[2023/02/02 20:37:54.751 +08:00][5][INFO] [251_13119688][db/flush_job.cc:946] [lock] [JOB 388] Level-0 flush table #61034: 21214984 bytes OK\r\n[2023/02/02 20:37:54.751 +08:00][5][INFO] [251_13119688](Original Log Time 2023/02/02-20:37:54.751310) [db/db_impl/db_impl_compaction_flush.cc:301] [lock] Level summary: base level 6 level multiplier 10.00 max bytes base 134217728 files[0 0 0 0 0 0 5] max score 0.00\r\n[2023/02/02 20:37:54.899 +08:00][5][INFO] [251_13119688][db/flush_job.cc:946] [lock] [JOB 387] Level-0 flush table #61029: 45351480 bytes OK\r\n[2023/02/02 20:37:55.059 +08:00][5][INFO] [251_13119688][db/flush_job.cc:946] [lock] [JOB 389] Level-0 flush table #61037: 19563984 bytes OK\r\n```\r\nTiKV panics with\r\n```\r\n[2023/02/02 20:37:55.151 +08:00] [FATAL] [lib.rs:496] [\"[region_id=251] [tablet_index=13119688] lock 4279779160 not found in DebugFlushProgress { prs: [FlushProgress \r\n{ cf: \\\"write\\\", apply_index: 13454988, earliest_seqno: 4277544754 }], op_logs: ;279779160ite 13129258 0;sealed lock 13129258 0;flushed write 4174686369;flushed lock \r\n4174721388;sealed write 13138468 4174721388;sealed lock 13138468 4174721388;sealed default 13138468 0;flushed default 4177701961;sealed lock 13138468 4177701959;flush\r\ned write 4177701958;flushed lock 4177701959;flushed lock 4177701963;sealed write 13143830 4177701959;flushed write 4179514595;sealed lock 13143830 4177701965;flushed \r\nlock 4179514755;sealed lock 13149565 4179514755;flushed lock 4181480781;sealed lock 13150582 4181480781;sealed write 13150631 4179514755;flushed lock 4181792484;flush\r\ned write 4181805218;sealed lock 13152227 4181792484;flushed lock 4182321135;sealed lock 13153352 4182321135;flushed lock 4182673152;sealed lock 13157589 4182673152;fl\r\nushed lock 4183981111;sealed write 13157845 4181806659;sealed lock 13158606 4183981111;flushed write 4184104570;flushed lock 4184292872;sealed lock 13160060 418429287\r\n2;flushed lock 4184815621;sealed lock 13161274 4184815621;flushed lock 4185317993;sealed lock 13162621 4185317993;flushed lock 4185739975;sealed lock 13163494 4185739\r\n975;flushed lock 4185996107;sealed write 13164987 4184104571;sealed lock 13164987 4185996107;sealed lock 13166160 4186467653;flushed lock 4186467653;flushed write 418\r\n6467652;flushed lock 4186812770;sealed lock 13167211 4186812770;flushed lock 4187221705;sealed lock 13168290 4187221705;flushed lock 4187458239;sealed lock 13169682 4\r\n187458239;flushed lock 4187947299;sealed lock 13170677 4187947299;flushed lock 4188181684;sealed lock 13172525 4188181684;sealed write 13173067 4186467653;sealed lock\r\n 13173613 4188748412;flushed lock 4188748412;flushed lock 4189210034;flushed write 4188966789;sealed lock 13174530 4189210034;flushed lock 4189406194;sealed lock 1317\r\n6914 4189406194;flushed lock 4190206856;sealed lock 13179854 4190206856;flushed lock 4191110931;sealed lock 13184911 4191110931;sealed write 13184911 4188966790;flush\r\ned lock 4192692609;flushed write 4192692320;sealed write 13195565 4192692609;sealed lock 13195565 4192692609;flushed lock 4195986933;flushed write 4195957769;sealed w\r\nrite 13204610 4195986933;sealed lock 13204610 4195986933;flushed write 4198883449;flushed lock 4198883450;sealed write 13216537 4198883450;sealed lock 13216537 419888\r\n3450;flushed write 4202703359;flushed lock 4202703520;sealed write 13225261 4202703520;sealed lock 13225261 4202703520;flushed lock 4205780017;flushed write 420577987\r\n2;sealed write 13232616 4205780017;sealed lock 13232616 4205780017;flushed lock 4208165864;flushed write 4208156720;sealed lock 13233574 4208165864;flushed lock 42084\r\n72365;sealed lock 13234791 4208472365;flushed lock 4208885536;sealed lock 13236630 4208885536;flushed lock 4209536951;sealed lock 13238154 4209536951;flushed lock 421\r\n0038889;sealed lock 13239291 4210038889;sealed write 13239937 4208165864;flushed lock 4210374301;sealed lock 13240771 4210374301;flushed lock 4210857970;flushed write\r\n 4210579234;sealed lock 13243226 4210857970;flushed lock 4211521839;sealed lock 13244131 4211521839;flushed lock 4211941231;sealed lock 13245269 4211941231;flushed lo\r\nck 4212270986;sealed lock 13246541 4212270986;flushed lock 4212623906;sealed write 13246911 4210579235;flushed write 4212831237;sealed lock 13247730 4212623906;flushe\r\nd lock 4212979422;sealed lock 13248780 4212979422;flushed lock 4213338270;sealed lock 13249860 4213338270;flushed lock 4213669973;sealed lock 13250677 4213669973;flus\r\nhed lock 4213979452;sealed lock 13251620 4213979452;flushed lock 4214315316;sealed lock 13252858 4214315316;flushed lock 4214679369;sealed lock 13253775 4214679369;fl\r\nushed lock 4214992043;sealed lock 13254819 4214992043;sealed write 13254819 4212837446;flushed lock 4215335371;flushed write 4215323695;sealed lock 13255784 421533537\r\n1;flushed lock 4215587365;sealed lock 13259406 4215587365;flushed lock 4216815319;sealed write 13269971 4215335371;sealed lock 13269971 4216815319;flushed lock 422030\r\n1506;flushed write 4220301505;sealed write 13280652 4220301506;sealed lock 13280652 4220301506;flushed lock 4223664133;flushed write 4223664132;sealed lock 13285366 4\r\n223664133;sealed lock  ; ; }\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\\n   1: std::panicking::rust_panic_with_hook\\n   2: std::panicking::begin_panic\r\n_handler::{{closure}}\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n   4: rust_begin_unwind\\n   5: core::panicking::panic_fmt\\n   6: engine_traits::f\r\nlush::PersistenceListener::on_flush_completed\\n   7: _ZN24crocksdb_eventlistener_t16OnFlushCompletedEPN7rocksdb2DBERKNS0_12FlushJobInfoE\\n   8: _ZN7rocksdb6DBImpl22No\r\ntifyOnFlushCompletedEPNS_16ColumnFamilyDataERKNS_16MutableCFOptionsEPSt4listISt10unique_ptrINS_12FlushJobInfoESt14default_deleteIS8_EESaISB_EE\\n   9: _ZN7rocksdb6DBIm\r\npl25FlushMemTableToOutputFileEPNS_16ColumnFamilyDataERKNS_16MutableCFOptionsEPbPNS_10JobContextEPNS_19SuperVersionContextERSt6vectorImSaImEEmPNS_15SnapshotCheckerEPNS\r\n_9LogBufferENS_3Env8PriorityE\\n  10: _ZN7rocksdb6DBImpl27FlushMemTablesToOutputFilesERKNS_10autovectorINS0_10BGFlushArgELm8EEEPbPNS_10JobContextEPNS_9LogBufferENS_3En\r\nv8PriorityE\\n  11: _ZN7rocksdb6DBImpl15BackgroundFlushEPbPNS_10JobContextEPNS_9LogBufferEPNS_11FlushReasonENS_3Env8PriorityE\\n  12: _ZN7rocksdb6DBImpl19BackgroundCall\r\nFlushENS_3Env8PriorityE\\n  13: _ZN7rocksdb14ThreadPoolImpl4Impl8BGThreadEm\\n  14: _ZN7rocksdb14ThreadPoolImpl4Impl15BGThreadWrapperEPv\\n  15: execute_native_thread_ro\r\nutine\\n  16: start_thread\\n  17: clone3\\n\"] [location=components/engine_traits/src/flush.rs:230] [thread_name=<unnamed>]\r\n```\r\n\r\nThough the logs actually shows that job 388 is waiting for 387 as level0 file count is still 0."
    }
  ]
}