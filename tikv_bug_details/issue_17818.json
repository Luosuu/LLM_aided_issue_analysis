{
  "issue_number": 17818,
  "title": "tikv panic [lib.rs:480] [\\\"called `Result::unwrap()` on an `Err` value: Other(Os { code: 103, kind: ConnectionAborted, message: \\\\\\\"Software caused connection abort\\\\\\\" })\\\"",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n./tikv-server -V\r\n TiKV \r\nRelease Version:   8.5.0-alpha\r\nEdition:           Community\r\nGit Commit Hash:   e63166590d526bafcdf64dbc23a1bf126ae0127d\r\nGit Commit Branch: heads/refs/tags/v8.5.0-alpha-inmemoryengine-enable-pr17806\r\nUTC Build Time:    2024-11-12 07:57:20\r\nRust Version:      rustc 1.77.0-nightly (89e2160c4 2023-12-27)\r\nEnable Features:   memory-engine pprof-fp jemalloc mem-profiling portable sse test-engine-kv-rocksdb test-engine-raft-raft-engine trace-async-tasks openssl-vendored\r\nProfile:           dist_release\r\n2024-11-13T23:29:40.181+0800\t\r\n\r\n### What operating system and CPU are you using?\r\n8c/32g\r\n\r\n### Steps to reproduce\r\n1、enable In-memory Engine\r\n2、enable titan\r\n2、run mussel workload\r\n3、injection one tikv io delay 50ms\r\n\r\n### What did you expect?\r\nno panic\r\n\r\n### What did happened?\r\none tikv panic\r\n`{\"log\":\"[lib.rs:480] [\\\"called `Result::unwrap()` on an `Err` value: Other(Os { code: 103, kind: ConnectionAborted, message: \\\\\\\"Software caused connection abort\\\\\\\" })\\\"] [backtrace=\\\"   0: tikv_util::set_panic_hook::{{closure}}\\\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/lib.rs:479:18\\\\n   1: <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2029:9\\\\n      std::panicking::rust_panic_with_hook\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:783:13\\\\n   2: std::panicking::begin_panic_handler::{{closure}}\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:657:13\\\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:171:18\\\\n   4: rust_begin_unwind\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:645:5\\\\n   5: core::panicking::panic_fmt\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:72:14\\\\n   6: core::result::unwrap_failed\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/result.rs:1649:5\\\\n   7: core::result::Result<T,E>::unwrap\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/result.rs:1073:23\\\\n      server::server::TikvServer<ER,F>::init_storage_stats_task::{{closure}}\\\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/server/src/server.rs:1419:33\\\\n      tikv_util::worker::pool::Worker::spawn_interval_task::{{closure}}\\\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/worker/pool.rs:419:17\\\\n      <tracker::tls::TrackedFuture<F> as core::future::future::Future>::poll::{{closure}}\\\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tracker/src/tls.rs:64:23\\\\n      std::thread::local::LocalKey<T>::try_with\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:270:16\\\\n      std::thread::local::LocalKey<T>::with\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:246:9\\\\n      <tracker::tls::TrackedFuture<F> as core::future::future::Future>::poll\\\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tracker/src/tls.rs:62:27\\\\n      <futures_util::future::future::map::Map<Fut,F> as core::future::future::Future>::poll\\\\n             at var/cache/cargohome/registry/src/index.crates.io-6f17d22bba15001f/futures-util-0.3.31/src/future/future/map.rs:55:37\\\\n      <futures_util::future::future::Map<Fut,F> as core::future::future::Future>::poll\\\\n             at var/cache/cargohome/registry/src/index.crates.io-6f17d22bba15001f/futures-util-0.3.31/src/lib.rs:86:13\\\\n      yatp::task::future::RawTask<F>::poll\\\\n             at var/cache/cargohome/git/checkouts/yatp-e704b73c3ee279b6/793be4d/src/task/future.rs:59:9\\\\n   8: yatp::task::future::TaskCell::poll\\\\n             at var/cache/cargohome/git/checkouts/yatp-e704b73c3ee279b6/793be4d/src/task/future.rs:103:9\\\\n      <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\\\\n             at var/cache/cargohome/git/checkouts/yatp-e704b73c3ee279b6/793be4d/src/task/future.rs:387:20\\\\n   9: <tikv_util::yatp_pool::YatpPoolRunner<T> as yatp::pool::runner::Runner>::handle\\\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/yatp_pool/mod.rs:199:24\\\\n      yatp::pool::worker::WorkerThread<T,R>::run\\\\n             at var/cache/cargohome/git/checkouts/yatp-e704b73c3ee279b6/793be4d/src/pool/worker.rs:48:13\\\\n      yatp::pool::builder::LazyBuilder<T>::build::{{closure}}\\\\n             at var/cache/cargohome/git/checkouts/yatp-e704b73c3ee279b6/793be4d/src/pool/builder.rs:114:25\\\\n      std::sys_common::backtrace::__rust_begin_short_backtrace\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:155:18\\\\n  10: std::thread::Builder::spawn_unchecked_::{{closure}}::{{closure}}\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:529:17\\\\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panic/unwind_safe.rs:272:9\\\\n      std::panicking::try::do_call\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:552:40\\\\n      std::panicking::try\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:516:19\\\\n      std::panic::catch_unwind\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panic.rs:142:14\\\\n      std::thread::Builder::spawn_unchecked_::{{closure}}\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:528:30\\\\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:250:5\\\\n  11: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2015:9\\\\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2015:9\\\\n      std::sys::unix::thread::Thread::new::thread_start\\\\n             at rust/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/unix/thread.rs:108:17\\\\n  12: start_thread\\\\n  13: __GI___clone\\\\n\\\"] [location=components/server/src/server.rs:1419] [thread_name=background-0] [thread_id=16]\",\"container\":\"tikv\",\"pod\":\"tc-tikv-2\",\"level\":\"FATAL\",\"namespace\":\"endless-ha-test-mussel-tps-7681762-1-807\"}`\r\n",
  "state": "open",
  "created_at": "2024-11-14T01:42:55Z",
  "updated_at": "2024-11-15T08:18:11Z",
  "closed_at": null,
  "labels": [
    "type/bug",
    "severity/major",
    "may-affects-5.4",
    "may-affects-6.1",
    "may-affects-6.5",
    "may-affects-7.1",
    "may-affects-7.5",
    "may-affects-8.1",
    "impact/panic",
    "may-affects-8.5"
  ],
  "comments_data": [
    {
      "id": 2475183871,
      "user": "Lily2025",
      "created_at": "2024-11-14T01:46:18Z",
      "body": "/assign overvenus"
    },
    {
      "id": 2475184506,
      "user": "Lily2025",
      "created_at": "2024-11-14T01:46:54Z",
      "body": "/severity critical  "
    },
    {
      "id": 2475298031,
      "user": "Lily2025",
      "created_at": "2024-11-14T02:43:24Z",
      "body": "/remove-severity  critical\r\n/severity major"
    },
    {
      "id": 2476668456,
      "user": "overvenus",
      "created_at": "2024-11-14T15:15:58Z",
      "body": "The test runs with an IO failure injector, causing a 50ms delay.\r\nA panic occurs due to the `statx` syscall returning an unexpected error, \"Software caused connection abort,\" originating from the failure injection layer.\r\n\r\nIt's easy to fix this specific panic by ignoring the error and skipping remaining work when an error occurs. However, it's challenging to fix other places using the `statx` syscall, where ignoring the error is not possible.\r\n\r\nAdditionally, the error message suggests that the failure injection layer has bugs, as it should cause a delay instead of an error.\r\n"
    }
  ]
}