{
  "issue_number": 11541,
  "title": "Unexpected panic when scan_next",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nmaster (c04fd41029c28f54e934830f63424f0aa34e2654)\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\nk8s\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nrun tipocket bank2 or ledger on master branch.\r\n\r\n### What did you expect?\r\n\r\ntikv run normally during the test\r\n\r\n### What did happened?\r\n\r\ntikv panicked\r\n```\r\n   0: tikv_util::set_panic_hook::{{closure}}\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tikv_util/src/lib.rs:464:18\r\n   1: std::panicking::rust_panic_with_hook\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/panicking.rs:626:17\r\n   2: std::panicking::begin_panic_handler::{{closure}}\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/panicking.rs:517:13\r\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/sys_common/backtrace.rs:141:18\r\n   4: rust_begin_unwind\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/panicking.rs:515:5\r\n   5: core::panicking::panic_fmt\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/core/src/panicking.rs:92:14\r\n   6: core::panicking::panic\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/core/src/panicking.rs:50:5\r\n   7: tikv::storage::mvcc::reader::scanner::forward::ForwardScanner<S,P>::move_write_cursor_to_ts\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/mvcc/reader/scanner/forward.rs:298:9\r\n      tikv::storage::mvcc::reader::scanner::forward::ForwardScanner<S,P>::read_next\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/mvcc/reader/scanner/forward.rs:276:43\r\n      <tikv::storage::mvcc::reader::scanner::Scanner<S> as tikv::storage::txn::store::Scanner>::next\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/storage/mvcc/reader/scanner/mod.rs:203:45\r\n   8: <tikv::coprocessor::dag::storage_impl::TiKVStorage<S> as tidb_query_common::storage::Storage>::scan_next\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/coprocessor/dag/storage_impl.rs:72:18\r\n   9: tidb_query_common::storage::scanner::RangesScanner<T>::next\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_common/src/storage/scanner.rs:88:21\r\n  10: tidb_query_executors::util::scan_executor::ScanExecutor<S,I>::fill_column_vec\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_executors/src/util/scan_executor.rs:104:28\r\n      <tidb_query_executors::util::scan_executor::ScanExecutor<S,I> as tidb_query_executors::interface::BatchExecutor>::next_batch\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_executors/src/util/scan_executor.rs:171:26\r\n      <tidb_query_executors::index_scan_executor::BatchIndexScanExecutor<S> as tidb_query_executors::interface::BatchExecutor>::next_batch\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_executors/src/index_scan_executor.rs:144:9\r\n      <tidb_query_common::execute_stats::WithSummaryCollector<C,T> as tidb_query_executors::interface::BatchExecutor>::next_batch\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_executors/src/interface.rs:108:22\r\n  11: <alloc::boxed::Box<T> as tidb_query_executors::interface::BatchExecutor>::next_batch\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_executors/src/interface.rs:77:9\r\n      tidb_query_executors::runner::BatchExecutorsRunner<SS>::internal_handle_request\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_executors/src/runner.rs:549:26\r\n  12: tidb_query_executors::runner::BatchExecutorsRunner<SS>::handle_request::{{closure}}\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_executors/src/runner.rs:426:41\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/core/src/future/mod.rs:80:19\r\n      <tikv::coprocessor::dag::BatchDAGHandler as tikv::coprocessor::RequestHandler>::handle_request::__handle_request::{{closure}}\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/coprocessor/dag/mod.rs:111:22\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/core/src/future/mod.rs:80:19\r\n  13: <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/core/src/future/future.rs:119:9\r\n      <tikv::coprocessor::interceptors::deadline::DeadlineChecker<F> as core::future::future::Future>::poll\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/coprocessor/interceptors/deadline.rs:34:9\r\n      <tikv::coprocessor::interceptors::tracker::Tracker<F> as core::future::future::Future>::poll\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/coprocessor/interceptors/tracker.rs:49:19\r\n  14: <tikv::coprocessor::interceptors::concurrency_limiter::ConcurrencyLimiter<PF,F> as core::future::future::Future>::poll\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/coprocessor/interceptors/concurrency_limiter.rs:111:15\r\n  15: tikv::coprocessor::endpoint::Endpoint<E>::handle_unary_request_impl::{{closure}}\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/coprocessor/endpoint.rs:392:13\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/core/src/future/mod.rs:80:19\r\n      <resource_metering::InTags<T> as core::future::future::Future>::poll\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/resource_metering/src/lib.rs:159:9\r\n      tikv::read_pool::ReadPoolHandle::spawn_handle::{{closure}}\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/read_pool.rs:145:27\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/core/src/future/mod.rs:80:19\r\n  16: tikv::read_pool::ReadPoolHandle::spawn::{{closure}}\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/read_pool.rs:121:25\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/core/src/future/mod.rs:80:19\r\n      yatp::task::future::RawTask<F>::poll\r\n             at rust/git/checkouts/yatp-e704b73c3ee279b6/d564d19/src/task/future.rs:59:9\r\n  17: yatp::task::future::TaskCell::poll\r\n             at rust/git/checkouts/yatp-e704b73c3ee279b6/d564d19/src/task/future.rs:103:9\r\n      <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\r\n             at rust/git/checkouts/yatp-e704b73c3ee279b6/d564d19/src/task/future.rs:387:20\r\n  18: <tikv_util::yatp_pool::YatpPoolRunner<T> as yatp::pool::runner::Runner>::handle\r\n             at home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tikv_util/src/yatp_pool/mod.rs:104:24\r\n      <yatp::queue::multilevel::MultilevelRunner<R> as yatp::pool::runner::Runner>::handle\r\n             at rust/git/checkouts/yatp-e704b73c3ee279b6/d564d19/src/queue/multilevel.rs:245:19\r\n      yatp::pool::worker::WorkerThread<T,R>::run\r\n             at rust/git/checkouts/yatp-e704b73c3ee279b6/d564d19/src/pool/worker.rs:48:13\r\n      yatp::pool::builder::LazyBuilder<T>::build::{{closure}}\r\n             at rust/git/checkouts/yatp-e704b73c3ee279b6/d564d19/src/pool/builder.rs:91:25\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/sys_common/backtrace.rs:125:18\r\n  19: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/thread/mod.rs:476:17\r\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/panic.rs:347:9\r\n      std::panicking::try::do_call\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/panicking.rs:401:40\r\n      std::panicking::try\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/panicking.rs:365:19\r\n      std::panic::catch_unwind\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/panic.rs:434:14\r\n      std::thread::Builder::spawn_unchecked::{{closure}}\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/thread/mod.rs:475:30\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/core/src/ops/function.rs:227:5\r\n  20: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/alloc/src/boxed.rs:1572:9\r\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/alloc/src/boxed.rs:1572:9\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at rustc/2faabf579323f5252329264cc53ba9ff803429a3/library/std/src/sys/unix/thread.rs:91:17\r\n  21: <unknown>\r\n  22: clone\r\n```",
  "state": "closed",
  "created_at": "2021-12-02T04:17:23Z",
  "updated_at": "2021-12-31T05:11:25Z",
  "closed_at": "2021-12-02T13:49:52Z",
  "labels": [
    "type/bug",
    "sig/transaction",
    "severity/major"
  ],
  "comments_data": []
}