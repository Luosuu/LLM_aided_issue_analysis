{
  "issue_number": 13194,
  "title": "v6.2.0: run in dr-auto-sync mode, tikv will down after reset min resovled ts",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n\r\nsh-4.2# ./tikv-server -V\r\nTiKV\r\nRelease Version:   6.2.0-alpha\r\nEdition:           Community\r\nGit Commit Hash:   c7234fdb403fa5b69ce69ca91501448ac5194236\r\nGit Commit Branch: heads/refs/tags/v6.2.0\r\nUTC Build Time:    2022-07-29 15:07:02\r\nRust Version:      rustc 1.62.0-nightly (7c4b47696 2022-04-30)\r\nEnable Features:   pprof-fp jemalloc mem-profiling portable sse test-engine-kv-rocksdb test-engine-raft-raft-engine cloud-aws cloud-gcp cloud-azure\r\nProfile:           dist_release\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\nSwitch from primary cluster to backup cluster when replication mode works in sync_recover mode, after that, use following command to set min resolved ts for every tikvs.\r\n\r\ntiup ctl:v6.2.0 tikv --host xxtikvxxx reset-to-version -v xxx\r\n\r\nPlan:  1110238\r\nCase: oltp_tiup_dr_autosync_fun_004\r\nclinic: 7126571720171612607\r\n\r\n### What did you expect?\r\nAfter reset version, cluster works fine.\r\n\r\n\r\n### What did happened?\r\n```\r\n\r\n[2022/08/01 00:59:44.859 +08:00] [INFO] [util.go:48] [\"Step: Reset to MinResolvedTs\"] [callBy=drcluster.go:824]\r\n[2022/08/01 00:59:44.859 +08:00] [INFO] [drcluster.go:827] [\"will run cmd\"] [cmd:=\"tiup ctl:v6.2.0 pd -u http://pd3-peer.endless-oltp-tps-1110238-1-959:2379 min-resolved-ts\"]\r\n[2022/08/01 00:59:45.290 +08:00] [INFO] [drcluster.go:829] [\"cmd output\"] [\"cmd output:\"=\"{\\n  \\\"is_real_time\\\": true,\\n  \\\"min_resolved_ts\\\": 434971950060666963,\\n  \\\"persist_interval\\\": \\\"1s\\\"\\n}\"]\r\n[2022/08/01 00:59:45.290 +08:00] [INFO] [drcluster.go:834] [minResolvedTs] [minResolvedTsInt:=434971950060666940]\r\n[2022/08/01 00:59:45.290 +08:00] [INFO] [drcluster.go:838] [\"Will run cmd\"] [command=\"tiup ctl:v6.2.0 tikv --host tikv4-peer:20160 reset-to-version -v 434971950060666944\"]\r\n[2022/08/01 00:59:46.703 +08:00] [INFO] [drcluster.go:840] [\"cmd output\"] [\"cmd output:\"=]\r\n[2022/08/01 00:59:46.703 +08:00] [INFO] [drcluster.go:838] [\"Will run cmd\"] [command=\"tiup ctl:v6.2.0 tikv --host tikv5-peer:20160 reset-to-version -v 434971950060666944\"]\r\n2022-08-01T00:59:45.293+0800\tINFO\tk8s/client.go:131\tit should be noted that a long-running command will not be interrupted even the use case has ended. For more information, please refer to https://github.com/pingcap/test-infra/discussions/129\r\n2022-08-01T00:59:46.706+0800\tINFO\tk8s/client.go:131\tit should be noted that a long-running command will not be interrupted even the use case has ended. For more information, please refer to https://github.com/pingcap/test-infra/discussions/129\r\n2022-08-01T00:59:47.768+0800\tINFO\tk8s/client.go:131\tit should be noted that a long-running command will not be interrupted even the use case has ended. For more information, please refer to https://github.com/pingcap/test-infra/discussions/129\r\n[2022/08/01 00:59:47.765 +08:00] [INFO] [drcluster.go:840] [\"cmd output\"] [\"cmd output:\"=]\r\n[2022/08/01 00:59:47.765 +08:00] [INFO] [drcluster.go:838] [\"Will run cmd\"] [command=\"tiup ctl:v6.2.0 tikv --host tikv6-peer:20160 reset-to-version -v 434971950060666944\"]\r\n[2022/08/01 00:59:48.673 +08:00] [INFO] [drcluster.go:840] [\"cmd output\"] [\"cmd output:\"=]\r\n[2022/08/01 00:59:48.673 +08:00] [INFO] [util.go:48] [\"Step: Verify bank ACID.\"] [callBy=drautosync.go:276]\r\n[2022/08/01 00:59:48.696 +08:00] [INFO] [run.go:335] [\"[%s] SELECT SUM(balance) to verify use tso %d\"] [client=bank2] [tso=434972075933040644]\r\n[2022/08/01 01:29:30.699 +08:00] [ERROR] [run.go:364] [\"Error 1105: context deadline exceeded\"] [stack=\"github.com/pingcap/endless/pkg/workload/bank.(*Bank2Client).Verify\\n\\t/home/project/endless/pkg/workload/bank/run.go:364\\ngithub.com/pingcap/endless/testcase/oltp/tiuptest/drautosync.VerifyACID\\n\\t/home/project/endless/testcase/oltp/tiuptest/drautosync/drautosync.go:280\\ngithub.com/pingcap/endless/testcase/oltp/tiuptest/drautosync.DownPrimaryAndVerifyACID\\n\\t/home/project/endless/testcase/oltp/tiuptest/drautosync/drautosync.go:311\\ngithub.com/pingcap/endless/testcase/oltp/tiuptest/drautosync.(*DrCaseOptions).SwitchToBackupCluster.func3\\n\\t/home/project/endless/testcase/oltp/tiuptest/drautosync/drautosync.go:195\\ngithub.com/pingcap/endless/pkg/util.WithGinkgoRecover.func1\\n\\t/home/project/endless/pkg/util/fastfail.go:18\\ngolang.org/x/sync/errgroup.(*Group).Go.func1\\n\\t/root/go/pkg/mod/golang.org/x/sync@v0.0.0-20210220032951-036812b2e83c/errgroup/errgroup.go:57\"]\r\n```\r\ntikv keep reporting following error, pd mark tikvs disconnection.\r\n![image](https://user-images.githubusercontent.com/9443637/182103373-6e0a0800-95d6-4e92-b7a1-b4642c92d024.png)\r\n",
  "state": "closed",
  "created_at": "2022-08-01T08:06:06Z",
  "updated_at": "2022-08-08T03:50:48Z",
  "closed_at": "2022-08-08T03:50:48Z",
  "labels": [
    "type/bug",
    "severity/major",
    "affects-6.2"
  ],
  "comments_data": [
    {
      "id": 1200869368,
      "user": "mayjiang0203",
      "created_at": "2022-08-01T08:14:22Z",
      "body": "/type bug\r\n/severity Major\r\n/assign @longfangsong "
    },
    {
      "id": 1207597730,
      "user": "mayjiang0203",
      "created_at": "2022-08-08T03:00:44Z",
      "body": "/assign @lhy1024 \r\n/remove-assign @longfangsong"
    }
  ]
}