{
  "issue_number": 13958,
  "title": "PITR: data inconsistency after PITR with log containing flashback data. ",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nv6.5.0-alpha\r\n\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n- run sysbench prepare finish\r\n- create full-snapshot and start log backup task\r\n- run sysbench run finish\r\n- do flashback \r\n- PITR restore all of backuped log.\r\n\r\n### What did you expect?\r\n- PiTR successfully and sync-diff check passed\r\n\r\n### What did happened?\r\n- data inconsistency in down-cluster.\r\n",
  "state": "closed",
  "created_at": "2022-12-19T02:29:02Z",
  "updated_at": "2022-12-20T03:21:15Z",
  "closed_at": "2022-12-19T09:20:55Z",
  "labels": [
    "type/bug",
    "severity/critical",
    "affects-6.5"
  ],
  "comments_data": [
    {
      "id": 1357037126,
      "user": "joccau",
      "created_at": "2022-12-19T03:23:00Z",
      "body": "```\r\n{                                                                                                                    |  {\r\n   \"key\": \"7480000000000000585F72D0000000000005B0\",                                                                    |   \"key\": \"7480000000000000585F72D0000000000005B0\",\r\n   \"region_id\": 5059,                                                                                                  |   \"region_id\": 7781,\r\n   \"value\": {                                                                                                          |   \"value\": {\r\n    \"info\": {                                                                                                          |    \"info\": {\r\n     \"writes\": [                                                                                                     |     \"writes\": [\r\n      {      \r\n       // record 1 ，普通 put 记录                                                                                                          |      {\r\n       \"start_ts\": 438094694683770883,     2022-12-16 21:50:33.895 +0800 CST                                           |       \"start_ts\": 438094694683770883,\r\n       \"commit_ts\": 438094695155630088     2022-12-16 21:50:35.695 +0800 CST                                           |       \"commit_ts\": 438094695155630088\r\n      },                                                                                                               |      },\r\n      {     \r\n       // record 2 ， rollback 记录                                                                                                          |      {\r\n       \"type\": 3,                                                                                                      |  --------------------------------------------------------------------------------------------------------------------\r\n       \"start_ts\": 438094694683770883,     2022-12-16 21:50:33.895 +0800 CST                                           |  --------------------------------------------------------------------------------------------------------------------\r\n       \"commit_ts\": 438094694683770883     2022-12-16 21:50:33.895 +0800 CST                                           |  --------------------------------------------------------------------------------------------------------------------\r\n      },                                                                                                               |  --------------------------------------------------------------------------------------------------------------------\r\n      {                                                                                                                |  --------------------------------------------------------------------------------------------------------------------\r\n       \"start_ts\": 438092487156039722,     2022-12-16 19:30:12.845 +0800 CST                                           |       \"start_ts\": 438092487156039722,\r\n       \"commit_ts\": 438092487156039729     2022-12-16 19:30:12.845 +0800 CST                                           |       \"commit_ts\": 438092487156039729\r\n      },                                                                                                               |      },\r\n      {                                                                                                                |      {\r\n       \"start_ts\": 438091655976058927,     2022-12-16 18:37:22.145 +0800 CST                                           |       \"start_ts\": 438091655976058927,\r\n       \"commit_ts\": 438091655976058932     2022-12-16 18:37:22.145 +0800 CST                                           |       \"commit_ts\": 438091655976058932\r\n-     },                                                                                                               |-     },\r\n      {                                                                                                                |      {\r\n       \"start_ts\": 438091335072481290,     2022-12-16 18:16:57.995 +0800 CST                                           |       \"start_ts\": 438091335072481290,\r\n       \"commit_ts\": 438091335400161285     2022-12-16 18:16:59.245 +0800 CST                                           |       \"commit_ts\": 438091335400161285\r\n      }                                                                                                                |      }\r\n     ],                                                                                                                |     ],\r\n     \"values\": [                                                                                                       |     \"values\": [\r\n      {                                                                                                                |  --------------------------------------------------------------------------------------------------------------------\r\n       \"start_ts\": 438094694683770883,                                                                                 |  --------------------------------------------------------------------------------------------------------------------\r\n       \"value\": \"gAEEAAAAAQAAAAIAAAADAAAABAAAAAIAAAACkAEAApQBAAqUAQDIARulRablf++JARlWLCtAif0TgdD6OwZiWb8nixRJd00HWZFwMu|  --------------------------------------------------------------------------------------------------------------------\r\n      },                                                                                                               |  --------------------------------------------------------------------------------------------------------------------\r\n      {                                                                                                                |      {\r\n       \"start_ts\": 438092487156039722,                                                                                 |       \"start_ts\": 438092487156039722,\r\n       \"value\": \"gAEFAAAAAQAAAAIAAAADAAAABAAAAAUAAAACAAAAApABAAKUAQAKlAEAEpQBAMgBG6VFpuV/74kBGVYsK0CJ/ROB0Po7BmJZvyeLFE|       \"value\": \"gAEFAAAAAQAAAAIAAAADAAAABAAAAAUAAAACAAAAApABAAKUAQAKlAEAEpQBAMgBG6VFpuV/74kBGVYsK0CJ/ROB0Po7BmJZvyeLF\r\n      },                                                                                                               |      },\r\n      {                                                                                                                |      {\r\n       \"start_ts\": 438091655976058927,                                                                                 |       \"start_ts\": 438091655976058927,\r\n-      \"value\": \"gAEFAAAAAQAAAAIAAAADAAAABAAAAAUAAAACAAAAApABAAKUAQAKlAEAEpQBAMgBG6VFpuV/74kBGVYsK0CJ/ROB0Po7BmJZvyeLFE|-      \"value\": \"gAEFAAAAAQAAAAIAAAADAAAABAAAAAUAAAACAAAAApABAAKUAQAKlAEAEpQBAMgBG6VFpuV/74kBGVYsK0CJ/ROB0Po7BmJZvyeLF\r\n|     },                                                                                                               ||     },\r\n|     {                                                                                                                ||     {\r\n|      \"start_ts\": 438091335072481290,                                                                                 ||      \"start_ts\": 438091335072481290,\r\n|      \"value\": \"gAEEAAAAAQAAAAIAAAADAAAABAAAAAIAAAACkAEAApQBAAqUAQDIARulRablf++JARlWLCtAif0TgdD6OwZiWb8nixRJd00HWZFwMu||      \"value\": \"gAEEAAAAAQAAAAIAAAADAAAABAAAAAIAAAACkAEAApQBAAqUAQDIARulRablf++JARlWLCtAif0TgdD6OwZiWb8nixRJd00HWZFwM\r\n|     }                                                                                                                ||     }\r\n|    ]                                                                                                                 ||    ]\r\n|   }                                                                                                                  ||   }\r\n|  }                                                                                                                   ||  }\r\n| }                                                                                                                    || }\r\n  ~                                                                                                                    |  ~\r\n  ~                                                                                                                    |  ~\r\n  ~                                                                                                                    |  ~\r\n```\r\n\r\nThe write-cf from record1 may find the default-cf of record1 or default-cf of record2，because the default key of these two records is the same。"
    }
  ]
}