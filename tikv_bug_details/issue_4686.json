{
  "issue_number": 4686,
  "title": "Resource deadlock avoided (os error 35) on panic hook",
  "body": "## Bug Report\r\n```\r\n[2019/05/11 09:21:25.447 +08:00] [FATAL] [lib.rs:499] [\"failed to join thread: Resource deadlock avoided (os error 35)\"] [backtrace=\"stack backtrace:\r\n   0:     0x55c77cb0417d - backtrace::backtrace::libunwind::trace::he6fe63a08c34070b\r\n                        at /home/stn/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.2.3/src/backtrace/libunwind.rs:54\r\n                         - backtrace::backtrace::trace::hb59f2aed9e9a8ad6\r\n                        at /home/stn/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.2.3/src/backtrace/mod.rs:70\r\n   1:     0x55c77caf8128 - tikv_util::set_panic_hook::{{closure}}::he6ee89059c0097b0\r\n                        at /home/stn/tikv/target/release/build/backtrace-ecf759b27a1a46bd/out/capture.rs:79\r\n   2:     0x55c77ccc169f - rust_panic_with_hook\r\n                        at src/libstd/panicking.rs:478\r\n   3:     0x55c77ccc145e - continue_panic_fmt\r\n                        at src/libstd/panicking.rs:381\r\n   4:     0x55c77ccc140b - begin_panic_fmt\r\n                        at src/libstd/panicking.rs:336\r\n   5:     0x55c77c232745 - core::ptr::real_drop_in_place::h1d9a90a568c2ed00\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641//src/libstd/sys/unix/thread.rs:168\r\n   6:     0x55c77c9853ea - core::ptr::real_drop_in_place::h6c8f92d576fe3992\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libcore/ptr.rs:193\r\n                         - core::ptr::drop_in_place::ha09994fefc96ba34\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libcore/ptr.rs:183\r\n                         - alloc::sync::Arc<T>::drop_slow::h02f0b281b6a3e892\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/liballoc/sync.rs:553\r\n   7:     0x55c77c5e3230 - <alloc::sync::Arc<T> as core::ops::drop::Drop>::drop::hbdf383fd8c7cee6b\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/liballoc/sync.rs:1011\r\n                         - core::ptr::real_drop_in_place::h33225a462d0a16db\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libcore/ptr.rs:193\r\n                         - core::ptr::real_drop_in_place::h1d2f7d3861884207\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libcore/ptr.rs:193\r\n                         - core::ptr::drop_in_place::ha0dc25cf34f67cb8\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libcore/ptr.rs:183\r\n                         - alloc::sync::Arc<T>::drop_slow::h40aba6c2c64e98c2\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/liballoc/sync.rs:553\r\n   8:     0x55c77ccbf619 - <alloc::sync::Arc<T> as core::ops::drop::Drop>::drop::h78f03f6e19dadc54\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/liballoc/sync.rs:1011\r\n                         - core::ptr::real_drop_in_place::hb698c03222a416f4\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libcore/ptr.rs:193\r\n                         - core::mem::drop::h06056800795dd72a\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libcore/mem.rs:777\r\n                         - arc_swap::ArcSwapAny<T,S>::store::hf3fce8213b97ed23\r\n                        at /home/stn/.cargo/registry/src/github.com-1ecc6299db9ec823/arc-swap-0.3.7/src/lib.rs:910\r\n                         - slog_global::set_global::h19a04169727f7914\r\n                        at /home/stn/.cargo/git/checkouts/slog-global-bfb0f375084418ec/91904ad/lib.rs:40\r\n   9:     0x55c77caf8452 - tikv_util::logger::init_log::h6919efbf186c68c2\r\n                        at components/tikv_util/src/logger/mod.rs:53\r\n                         - tikv_util::set_panic_hook::{{closure}}::he6ee89059c0097b0\r\n                        at components/tikv_util/src/lib.rs:513\r\n  10:     0x55c77ccc169f - rust_panic_with_hook\r\n                        at src/libstd/panicking.rs:478\r\n  11:     0x55c77ccc145e - continue_panic_fmt\r\n                        at src/libstd/panicking.rs:381\r\n  12:     0x55c77ccc140b - begin_panic_fmt\r\n                        at src/libstd/panicking.rs:336\r\n  13:     0x55c77c3a0f8c - <slog::Fuse<D> as slog::Drain>::log::{{closure}}::h51b3bbcb36a2e12b\r\n                        at /home/stn/tikv/<::std::macros::panic macros>:8\r\n  14:     0x55c77c1f7b6b - core::result::Result<T,E>::unwrap_or_else::h0d32f61399309e8a\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libcore/result.rs:766\r\n                         - <slog::Fuse<D> as slog::Drain>::log::h544080cfbfafed30\r\n                        at /home/stn/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1902\r\n                         - slog_async::AsyncCoreBuilder<D>::spawn_thread::{{closure}}::had930e8c2a88078a\r\n                        at /home/stn/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-async-2.3.0/lib.rs:290\r\n                         - std::sys_common::backtrace::__rust_begin_short_backtrace::h7136c0616bf9c802\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libstd/sys_common/backtrace.rs:136\r\n  15:     0x55c77c221d02 - std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}::h287d598f5dc88875\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libstd/thread/mod.rs:469\r\n                         - <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once::h97a86910bbec273f\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libstd/panic.rs:309\r\n                         - std::panicking::try::do_call::h22bcd80be8c9ff98\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libstd/panicking.rs:293\r\n                         - std::panicking::try::h6755bb180dd55f02\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641//src/libpanic_unwind/lib.rs:85\r\n                         - std::panic::catch_unwind::hd2301e740d2454d9\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libstd/panic.rs:388\r\n                         - std::thread::Builder::spawn_unchecked::{{closure}}::h1cd0fa80de608757\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libstd/thread/mod.rs:468\r\n                         - core::ops::function::FnOnce::call_once{{vtable.shim}}::h150def8b8f7ff825\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/libcore/ops/function.rs:231\r\n  16:     0x55c77ccd3eee - call_once<(),FnOnce<()>>\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/liballoc/boxed.rs:704\r\n  17:     0x55c77ccd668f - call_once<(),alloc::boxed::Box<FnOnce<()>>>\r\n                        at /rustc/e305df1846a6d985315917ae0c81b74af8b4e641/src/liballoc/boxed.rs:704\r\n                         - start_thread\r\n                        at src/libstd/sys_common/thread.rs:13\r\n                         - thread_start\r\n                        at src/libstd/sys/unix/thread.rs:79\r\n  18:     0x7f8ee0df3fa2 - start_thread\r\n  19:     0x7f8ee0aff82e - clone\r\n  20:                0x0 - <unknown>\"] [location=src/libstd/sys/unix/thread.rs:168] [thread_name=slogger]\r\n```\r\n",
  "state": "closed",
  "created_at": "2019-05-11T05:02:57Z",
  "updated_at": "2020-08-28T11:10:15Z",
  "closed_at": "2020-08-28T11:10:15Z",
  "labels": [
    "type/bug"
  ],
  "comments_data": [
    {
      "id": 553331622,
      "user": "overvenus",
      "created_at": "2019-11-13T10:06:23Z",
      "body": "Looks like the log threads panicked, and it tries to join itself in the panic hook that leads to the deadlock.\r\n\r\nA quick workaround is to return slog_global logger and just `mem::forget`.\r\n\r\nCc @breeswish "
    }
  ]
}