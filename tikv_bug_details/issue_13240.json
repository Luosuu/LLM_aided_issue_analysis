{
  "issue_number": 13240,
  "title": "all tikv panic when pd down for some time",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n./tikv-server -V\r\n TiKV \r\nRelease Version:   6.2.0-alpha\r\nEdition:           Community\r\nGit Commit Hash:   fbf4c33f8e6cc037d2638f7237c8494172c93328\r\nGit Commit Branch: heads/refs/tags/v6.2.0\r\nUTC Build Time:    2022-08-05 09:07:12\r\nRust Version:      rustc 1.62.0-nightly (7c4b47696 2022-04-30)\r\nEnable Features:   pprof-fp jemalloc mem-profiling portable sse test-engine-kv-rocksdb test-engine-raft-raft-engine cloud-aws cloud-gcp cloud-azure\r\nProfile:           dist_release\r\n./pd-server -V\r\n Release Version: v6.2.0\r\nEdition: Community\r\nGit Commit Hash: e3d48eb1247d9b879bf8f65a7adaf6665c6a3b68\r\nGit Branch: heads/refs/tags/v6.2.0\r\nUTC Build Time:  2022-08-04 10:04:26\r\n\r\n### What operating system and CPU are you using?\r\n8core„ÄÅ16g\r\n\r\n### Steps to reproduce\r\ninject pd down for 5min\r\n\r\n### What did you expect?\r\nall tikv are normal\r\n\r\n### What did happened?\r\nall tikv panic\r\n[2022/08/06 21:24:57.412 +00:00] [ERROR] [[util.rs:625](http://util.rs:625/)] [\"connect failed\"] [error=\"Grpc(RpcFailure(RpcStatus { code: 4-DEADLINE_EXCEEDED, message: \\\"Deadline Exceeded\\\", details: [] }))\"] [endpoints=http://tc-pd-2.tc-pd-peer.endless-oltp-tps-1081134-1-59.svc:2379/]\r\n[2022/08/06 21:24:57.425 +00:00] [FATAL] [[lib.rs:494](http://lib.rs:494/)] [\"http://tc-pd-0.tc-pd-peer.endless-oltp-tps-1081134-1-59.svc:2379/ no longer belongs to cluster 7128727844455161346, it is in 0\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\\n             at home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/tikv_util/src/lib.rs:493:18\\n](http://github.com/pingcap/tikv/components/tikv_util/src/lib.rs:493:18/n)   1: std::panicking::rust_panic_with_hook\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:702](http://panicking.rs:702/):17\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:588](http://panicking.rs:588/):13\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/[backtrace.rs:138](http://backtrace.rs:138/):18\\n   4: rust_begin_unwind\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:584](http://panicking.rs:584/):5\\n   5: core::panicking::panic_fmt\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/[panicking.rs:142](http://panicking.rs:142/):14\\n   6: pd_client::util::PdConnector::load_members::{{closure}}\\n             at home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/pd_client/src/util.rs:618:29\\n](http://github.com/pingcap/tikv/components/pd_client/src/util.rs:618:29/n)      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/[mod.rs:91](http://mod.rs:91/):19\\n      pd_client::util::PdConnector::reconnect_pd::{{closure}}\\n             at home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/pd_client/src/util.rs:648:52\\n](http://github.com/pingcap/tikv/components/pd_client/src/util.rs:648:52/n)      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/[mod.rs:91](http://mod.rs:91/):19\\n   7: pd_client::util::Client::reconnect::{{closure}}::{{closure}}\\n             at home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/pd_client/src/util.rs:341:92\\n](http://github.com/pingcap/tikv/components/pd_client/src/util.rs:341:92/n)      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/[mod.rs:91](http://mod.rs:91/):19\\n      pd_client::util::Client::reconnect::{{closure}}\\n             at home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/pd_client/src/util.rs:361:63\\n](http://github.com/pingcap/tikv/components/pd_client/src/util.rs:361:63/n)      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/[mod.rs:91](http://mod.rs:91/):19\\n   8: pd_client::client::RpcClient::new_async::{{closure}}::{{closure}}\\n             at home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/pd_client/src/client.rs:148:67\\n](http://github.com/pingcap/tikv/components/pd_client/src/client.rs:148:67/n)      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/[mod.rs:91](http://mod.rs:91/):19\\n      yatp::task::future::RawTask<F>::poll\\n             at rust/git/checkouts/yatp-e704b73c3ee279b6/2f5f6e4/src/task/[future.rs:59](http://future.rs:59/):9\\n   9: yatp::task::future::TaskCell::poll\\n             at rust/git/checkouts/yatp-e704b73c3ee279b6/2f5f6e4/src/task/[future.rs:103](http://future.rs:103/):9\\n      <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\\n             at rust/git/checkouts/yatp-e704b73c3ee279b6/2f5f6e4/src/task/[future.rs:387](http://future.rs:387/):20\\n  10: yatp::pool::worker::WorkerThread<T,R>::run\\n             at rust/git/checkouts/yatp-e704b73c3ee279b6/2f5f6e4/src/pool/[worker.rs:48](http://worker.rs:48/):13\\n      yatp::pool::builder::LazyBuilder<T>::build::{{closure}}\\n             at rust/git/checkouts/yatp-e704b73c3ee279b6/2f5f6e4/src/pool/[builder.rs:114](http://builder.rs:114/):25\\n      std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/[backtrace.rs:122](http://backtrace.rs:122/):18\\n  11: std::thread::Builder::spawn_unchecked_::{{closure}}::{{closure}}\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/[mod.rs:500](http://mod.rs:500/):17\\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panic/[unwind_safe.rs:271](http://unwind_safe.rs:271/):9\\n      std::panicking::try::do_call\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:492](http://panicking.rs:492/):40\\n      std::panicking::try\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:456](http://panicking.rs:456/):19\\n      std::panic::catch_unwind\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panic.rs:137](http://panic.rs:137/):14\\n      std::thread::Builder::spawn_unchecked_::{{closure}}\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/[mod.rs:499](http://mod.rs:499/):30\\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/[function.rs:248](http://function.rs:248/):5\\n  12: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/[boxed.rs:1866](http://boxed.rs:1866/):9\\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/[boxed.rs:1866](http://boxed.rs:1866/):9\\n      std::sys::unix::thread::Thread::new::thread_start\\n             at rust/toolchains/nightly-2022-05-01-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/unix/[thread.rs:108](http://thread.rs:108/):17\\n  13: <unknown>\\n  14: clone\\n\"] [location=components/pd_client/src/[util.rs:618](http://util.rs:618/)] [thread_name=pdmonitor-0]\r\n[2022/08/06 21:24:58.888 +00:00] [INFO] [[lib.rs:84](http://lib.rs:84/)] [\"Welcome to TiKV\"]\r\n",
  "state": "closed",
  "created_at": "2022-08-08T06:41:45Z",
  "updated_at": "2022-08-11T10:10:50Z",
  "closed_at": "2022-08-11T10:10:50Z",
  "labels": [
    "type/bug",
    "severity/critical",
    "affects-6.1",
    "affects-6.2"
  ],
  "comments_data": [
    {
      "id": 1207730373,
      "user": "Lily2025",
      "created_at": "2022-08-08T06:43:22Z",
      "body": "/type bug\r\n/severity Critical\r\n/assign @bufferflies"
    },
    {
      "id": 1207730393,
      "user": "ti-chi-bot",
      "created_at": "2022-08-08T06:43:23Z",
      "body": "@Lily2025: GitHub didn't allow me to assign the following users: bufferflies.\n\nNote that only [tikv members](https://github.com/orgs/tikv/people), repo collaborators and people who have commented on this issue/PR can be assigned. Additionally, issues/PRs can only have 10 assignees at the same time.\nFor more information please see [the contributor guide](https://git.k8s.io/community/contributors/guide/first-contribution.md#issue-assignment-in-github)\n\n<details>\n\nIn response to [this](https://github.com/tikv/tikv/issues/13240#issuecomment-1207730373):\n\n>/type bug\r\n>/severity Critical\r\n>/assign @bufferflies\n\n\nInstructions for interacting with me using PR comments are available [here](https://git.k8s.io/community/contributors/guide/pull-requests.md).  If you have questions or suggestions related to my behavior, please file an issue against the [kubernetes/test-infra](https://github.com/kubernetes/test-infra/issues/new?title=Prow%20issue:) repository.\n</details>"
    },
    {
      "id": 1207730724,
      "user": "Lily2025",
      "created_at": "2022-08-08T06:43:51Z",
      "body": "@bufferflies "
    },
    {
      "id": 1207733661,
      "user": "Connor1996",
      "created_at": "2022-08-08T06:48:09Z",
      "body": "the same root cause of https://github.com/tikv/tikv/issues/13124"
    }
  ]
}