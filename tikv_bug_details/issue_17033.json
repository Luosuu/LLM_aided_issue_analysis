{
  "issue_number": 17033,
  "title": "TiKV panic: range end index 182 out of range for slice of length 180 in table_scan_executor",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nmaster `86e0ec3006dd306a254481a3631069370b3a0537`\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nNo idea how it happened. I was modifying memdb in client-go. I ran large insert/update/delete statements multiple times.\r\nSome time later I noticed TiKV keeps restarting, and I found logs:\r\n\r\n```\r\n[lib.rs:477] [\"range end index 182 out of range for slice of length 180\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\r\n             at /workspace/source/tikv/components/tikv_util/src/lib.rs:476:18\r\n   1: <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2029:9\r\n      std::panicking::rust_panic_with_hook\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:783:13\r\n   2: std::panicking::begin_panic_handler::{{closure}}\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:657:13\r\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:171:18\r\n   4: rust_begin_unwind\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:645:5\r\n   5: core::panicking::panic_fmt\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:72:14\r\n   6: core::slice::index::slice_end_index_len_fail_rt\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/slice/index.rs:76:5\r\n      core::slice::index::slice_end_index_len_fail\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/slice/index.rs:68:9\r\n   7: <core::ops::range::Range<usize> as core::slice::index::SliceIndex<[T]>>::index\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/slice/index.rs:394:13\r\n      core::slice::index::<impl core::ops::index::Index<I> for [T]>::index\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/slice/index.rs:18:9\r\n      tidb_query_executors::table_scan_executor::TableScanExecutorImpl::process_v2\r\n             at /workspace/source/tikv/components/tidb_query_executors/src/table_scan_executor.rs:249:53\r\n      <tidb_query_executors::table_scan_executor::TableScanExecutorImpl as tidb_query_executors::util::scan_executor::ScanExecutorImpl>::process_kv_pair\r\n             at /workspace/source/tikv/components/tidb_query_executors/src/table_scan_executor.rs:356:43\r\n   8: tidb_query_executors::util::scan_executor::ScanExecutor<S,I,F>::fill_column_vec::{{closure}}\r\n             at /workspace/source/tikv/components/tidb_query_executors/src/util/scan_executor.rs:116:33\r\n      <tidb_query_executors::util::scan_executor::ScanExecutor<S,I,F> as tidb_query_executors::interface::BatchExecutor>::next_batch::{{closure}}\r\n             at /workspace/source/tikv/components/tidb_query_executors/src/util/scan_executor.rs:179:80\r\n   9: <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/future.rs:124:9\r\n      <tidb_query_executors::table_scan_executor::BatchTableScanExecutor<S,F> as tidb_query_executors::interface::BatchExecutor>::next_batch::{{closure}}\r\n             at /workspace/source/tikv/components/tidb_query_executors/src/table_scan_executor.rs:126:38\r\n  10: <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/future.rs:124:9\r\n      <tikv_util::quota_limiter::CpuObserveFuture<F> as core::future::future::Future>::poll\r\n             at /workspace/source/tikv/components/tikv_util/src/quota_limiter.rs:177:19\r\n  11: tikv::coprocessor::statistics::analyze::RowSampleBuilder<S,F>::collect_column_stats::{{closure}}\r\n             at /workspace/source/tikv/src/coprocessor/statistics/analyze.rs:108:26\r\n  12: tikv::coprocessor::statistics::analyze_context::AnalyzeContext<S,F>::handle_full_sampling::{{closure}}\r\n             at /workspace/source/tikv/src/coprocessor/statistics/analyze_context.rs:123:57\r\n      <tikv::coprocessor::statistics::analyze_context::AnalyzeContext<S,F> as tikv::coprocessor::RequestHandler>::handle_request::{{closure}}\r\n             at /workspace/source/tikv/src/coprocessor/statistics/analyze_context.rs:285:78\r\n  13: <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/future.rs:124:9\r\n      <tikv::coprocessor::interceptors::deadline::DeadlineChecker<F> as core::future::future::Future>::poll\r\n             at /workspace/source/tikv/src/coprocessor/interceptors/deadline.rs:37:9\r\n      <tikv::coprocessor::interceptors::tracker::Tracker<F,E> as core::future::future::Future>::poll\r\n             at /workspace/source/tikv/src/coprocessor/interceptors/tracker.rs:54:19\r\n  14: <tikv::coprocessor::interceptors::concurrency_limiter::ConcurrencyLimiter<PF,F> as core::future::future::Future>::poll\r\n             at /workspace/source/tikv/src/coprocessor/interceptors/concurrency_limiter.rs:112:15\r\n      tikv::coprocessor::endpoint::Endpoint<E>::handle_unary_request_impl::{{closure}}\r\n             at /workspace/source/tikv/src/coprocessor/endpoint.rs:463:87\r\n      <resource_metering::InTags<T> as core::future::future::Future>::poll\r\n             at /workspace/source/tikv/components/resource_metering/src/lib.rs:267:9\r\n      <futures_util::future::future::map::Map<Fut,F> as core::future::future::Future>::poll\r\n             at /workspace/.cargo/registry/src/index.crates.io-6f17d22bba15001f/futures-util-0.3.15/src/future/future/map.rs:55:37\r\n      <futures_util::future::future::Map<Fut,F> as core::future::future::Future>::poll\r\n             at /workspace/.cargo/registry/src/index.crates.io-6f17d22bba15001f/futures-util-0.3.15/src/lib.rs:93:13\r\n  15: <futures_util::future::future::map::Map<Fut,F> as core::future::future::Future>::poll\r\n             at /workspace/.cargo/registry/src/index.crates.io-6f17d22bba15001f/futures-util-0.3.15/src/future/future/map.rs:55:37\r\n      <futures_util::future::future::Map<Fut,F> as core::future::future::Future>::poll\r\n             at /workspace/.cargo/registry/src/index.crates.io-6f17d22bba15001f/futures-util-0.3.15/src/lib.rs:93:13\r\n      <resource_control::future::ControlledFuture<F> as core::future::future::Future>::poll\r\n             at /workspace/source/tikv/components/resource_control/src/future.rs:48:19\r\n  16: resource_control::future::with_resource_limiter::{{closure}}\r\n             at /workspace/source/tikv/components/resource_control/src/future.rs:240:11\r\n      <tracker::tls::TrackedFuture<F> as core::future::future::Future>::poll::{{closure}}\r\n             at /workspace/source/tikv/components/tracker/src/tls.rs:64:23\r\n      std::thread::local::LocalKey<T>::try_with\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:270:16\r\n      std::thread::local::LocalKey<T>::with\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/local.rs:246:9\r\n      <tracker::tls::TrackedFuture<F> as core::future::future::Future>::poll\r\n             at /workspace/source/tikv/components/tracker/src/tls.rs:62:27\r\n      yatp::task::future::RawTask<F>::poll\r\n             at /workspace/.cargo/git/checkouts/yatp-e704b73c3ee279b6/793be4d/src/task/future.rs:59:9\r\n  17: yatp::task::future::TaskCell::poll\r\n             at /workspace/.cargo/git/checkouts/yatp-e704b73c3ee279b6/793be4d/src/task/future.rs:103:9\r\n      <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\r\n             at /workspace/.cargo/git/checkouts/yatp-e704b73c3ee279b6/793be4d/src/task/future.rs:387:20\r\n  18: <tikv_util::yatp_pool::YatpPoolRunner<T> as yatp::pool::runner::Runner>::handle\r\n             at /workspace/source/tikv/components/tikv_util/src/yatp_pool/mod.rs:199:24\r\n      <yatp::queue::multilevel::TrackedRunner<R> as yatp::pool::runner::Runner>::handle\r\n             at /workspace/.cargo/git/checkouts/yatp-e704b73c3ee279b6/793be4d/src/queue/multilevel.rs:285:19\r\n  19: yatp::pool::worker::WorkerThread<T,R>::run\r\n             at /workspace/.cargo/git/checkouts/yatp-e704b73c3ee279b6/793be4d/src/pool/worker.rs:48:13\r\n      yatp::pool::builder::LazyBuilder<T>::build::{{closure}}\r\n             at /workspace/.cargo/git/checkouts/yatp-e704b73c3ee279b6/793be4d/src/pool/builder.rs:114:25\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:155:18\r\n  20: std::thread::Builder::spawn_unchecked_::{{closure}}::{{closure}}\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:529:17\r\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panic/unwind_safe.rs:272:9\r\n      std::panicking::try::do_call\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:552:40\r\n      std::panicking::try\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:516:19\r\n      std::panic::catch_unwind\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panic.rs:142:14\r\n      std::thread::Builder::spawn_unchecked_::{{closure}}\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:528:30\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:250:5\r\n  21: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2015:9\r\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2015:9\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at /root/.rustup/toolchains/nightly-2023-12-28-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/unix/thread.rs:108:17\r\n  22: start_thread\r\n  23: __GI___clone3\r\n\"] [location=components/tidb_query_executors/src/table_scan_executor.rs:249] [thread_name=unified-read-pool-5] [thread_id=38]\r\n```\r\n\r\n### What did you expect?\r\n\r\nNo panicking.\r\n\r\n### What did happened?\r\n\r\nTiKV keeps restarting.\r\n<img width=\"1609\" alt=\"image\" src=\"https://github.com/tikv/tikv/assets/31720476/4e2a64bc-b725-4f67-88ec-5883e361f81d\">\r\n",
  "state": "closed",
  "created_at": "2024-05-20T07:36:58Z",
  "updated_at": "2024-05-21T11:30:07Z",
  "closed_at": "2024-05-21T11:30:07Z",
  "labels": [
    "type/bug"
  ],
  "comments_data": []
}