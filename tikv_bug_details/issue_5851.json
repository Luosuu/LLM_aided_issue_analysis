{
  "issue_number": 5851,
  "title": "Tikv 2.1.18 crashes with Illegal instruction and the cluster is very unstable ",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n```\r\nTiKV \r\nRelease Version:   2.1.18\r\nGit Commit Hash:   149fea745ee979daa95bdc39bd00b5083e531d8b\r\nGit Commit Branch: release-2.1\r\nUTC Build Time:    2019-11-08 08:09:02\r\nRust Version:      rustc 1.29.0-nightly (4f3c7a472 2018-07-17)\r\n```\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n```\r\nprocessor\t: 0\r\nvendor_id\t: GenuineIntel\r\ncpu family\t: 6\r\nmodel\t\t: 45\r\nmodel name\t: Intel(R) Xeon(R) CPU E5-2680 0 @ 2.70GHz\r\nstepping\t: 7\r\nmicrocode\t: 0x710\r\ncpu MHz\t\t: 2699.894\r\ncache size\t: 20480 KB\r\nphysical id\t: 1\r\nsiblings\t: 16\r\ncore id\t\t: 7\r\ncpu cores\t: 8\r\napicid\t\t: 47\r\ninitial apicid\t: 47\r\nfpu\t\t: yes\r\nfpu_exception\t: yes\r\ncpuid level\t: 13\r\nwp\t\t: yes\r\nflags\t\t: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic popcnt tsc_deadline_timer aes xsave avx lahf_lm epb tpr_shadow vnmi flexpriority ept vpid xsaveopt dtherm arat pln pts\r\nbogomips\t: 5405.32\r\nclflush size\t: 64\r\ncache_alignment\t: 64\r\naddress sizes\t: 46 bits physical, 48 bits virtual\r\npower management:\r\n```\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nWe now have 5000+ regions on one tikv instance, the cache sizes are limited by setting cache-size \r\n```\r\n[server]\r\nlog-level = \"info\"\r\n[metric]\r\ninterval = \"15s\"\r\njob = \"tikv\"\r\n[raftstore]\r\nsync-log = false\r\npd-heartbeat-tick-interval = \"3m\"\r\npd-store-heartbeat-tick-interval = \"15s\"\r\n[pd]\r\n[rocksdb]\r\ncompaction-readahead-size = \"8MB\"\r\n[rocksdb.defaultcf]\r\ncompression-per-level = [\"no\", \"snappy\", \"lz4\", \"lz4\", \"lz4\", \"zstd\", \"zstd\"]\r\nmax-write-buffer-number = 15\r\nblock-cache-size = \"1GB\"\r\n[rocksdb.writecf]\r\nblock-cache-size = \"256MB\"\r\n[rocksdb.raftcf]\r\nblock-cache-size = \"128MB\"\r\n[rocksdb.lockcf]\r\nblock-cache-size = \"128MB\"\r\n[storage]\r\nscheduler-worker-pool-size = 8\r\n```\r\nBut the tikv-server rss size will sometimes increase up to 50GiB (64GB physical memory) and the memory is swapped out. we just upgrade tikv from 2.1.1 to 2.1.18.\r\n\r\n\r\n### What did you expect?\r\n\r\ntikv's memory usage should be stable and bounded and should not crash\r\n\r\n### What did happened?\r\n\r\nTwo instances of tikv crashes once:\r\n\r\n```\r\n-rw------- 1 root root 159G Nov  9 22:22 /home/tidb/core.1394\r\n-rw------- 1 root root  81G Nov  9 22:13 /home/tidb/core.18532 \r\n```\r\n\r\n```\r\ngdb tikv-server core.1394 \r\nGNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-115.el7\r\nCopyright (C) 2013 Free Software Foundation, Inc.\r\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\r\nThis is free software: you are free to change and redistribute it.\r\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\r\nand \"show warranty\" for details.\r\nThis GDB was configured as \"x86_64-redhat-linux-gnu\".\r\nFor bug reporting instructions, please see:\r\n<http://www.gnu.org/software/gdb/bugs/>...\r\nReading symbols from /home/tidb/tikv-server...done.\r\n[New LWP 1582]\r\n[New LWP 1693]\r\n[New LWP 1691]\r\n[New LWP 1697]\r\n[New LWP 1712]\r\n[New LWP 1701]\r\n[New LWP 1721]\r\n[New LWP 1716]\r\n[New LWP 1707]\r\n[New LWP 1706]\r\n[New LWP 1699]\r\n[New LWP 1852]\r\n[New LWP 1717]\r\n[New LWP 1704]\r\n[New LWP 1868]\r\n[New LWP 1700]\r\n[New LWP 1846]\r\n[New LWP 1858]\r\n[New LWP 1702]\r\n[New LWP 1687]\r\n[New LWP 1710]\r\n[New LWP 1709]\r\n[New LWP 1690]\r\n[New LWP 1715]\r\n[New LWP 1698]\r\n[New LWP 1867]\r\n[New LWP 1713]\r\n[New LWP 1714]\r\n[New LWP 1865]\r\n[New LWP 1872]\r\n[New LWP 1771]\r\n[New LWP 1866]\r\n[New LWP 1770]\r\n[New LWP 1836]\r\n[New LWP 1792]\r\n[New LWP 1475]\r\n[New LWP 1983]\r\n[New LWP 1857]\r\n[New LWP 1903]\r\n[New LWP 1551]\r\n[New LWP 1860]\r\n[New LWP 1466]\r\n[New LWP 1581]\r\n[New LWP 1692]\r\n[New LWP 1438]\r\n[New LWP 1688]\r\n[New LWP 1575]\r\n[New LWP 1574]\r\n[New LWP 1579]\r\n[New LWP 1708]\r\n[New LWP 1705]\r\n[New LWP 1837]\r\n[New LWP 1920]\r\n[New LWP 1901]\r\n[New LWP 1883]\r\n[New LWP 23451]\r\n[New LWP 1879]\r\n[New LWP 1854]\r\n[New LWP 1889]\r\n[New LWP 1859]\r\n[New LWP 1880]\r\n[New LWP 1479]\r\n[New LWP 1580]\r\n[New LWP 1864]\r\n[New LWP 1568]\r\n[New LWP 1862]\r\n[New LWP 1437]\r\n[New LWP 23439]\r\n[New LWP 1440]\r\n[New LWP 1576]\r\n[New LWP 1890]\r\n[New LWP 1881]\r\n[New LWP 1720]\r\n[New LWP 1583]\r\n[New LWP 1569]\r\n[New LWP 1870]\r\n[New LWP 1884]\r\n[New LWP 1902]\r\n[New LWP 1468]\r\n[New LWP 1482]\r\n[New LWP 1853]\r\n[New LWP 1885]\r\n[New LWP 1689]\r\n[New LWP 1703]\r\n[New LWP 1565]\r\n[New LWP 1719]\r\n[New LWP 23445]\r\n[New LWP 1873]\r\n[New LWP 1531]\r\n[New LWP 1888]\r\n[New LWP 1541]\r\n[New LWP 1882]\r\n[New LWP 1516]\r\n[New LWP 1562]\r\n[New LWP 1892]\r\n[New LWP 1538]\r\n[New LWP 1904]\r\n[New LWP 1470]\r\n[New LWP 1875]\r\n[New LWP 27073]\r\n[New LWP 1886]\r\n[New LWP 1487]\r\n[New LWP 1493]\r\n[New LWP 1578]\r\n[New LWP 1573]\r\n[New LWP 1564]\r\n[New LWP 1495]\r\n[New LWP 1907]\r\n[New LWP 1485]\r\n[New LWP 1874]\r\n[New LWP 1552]\r\n[New LWP 1492]\r\n[New LWP 1517]\r\n[New LWP 1411]\r\n[New LWP 1887]\r\n[New LWP 1547]\r\n[New LWP 1546]\r\n[New LWP 1898]\r\n[New LWP 1478]\r\n[New LWP 1905]\r\n[New LWP 1394]\r\n[New LWP 1877]\r\n[New LWP 1537]\r\n[New LWP 1471]\r\n[New LWP 1891]\r\n[New LWP 1491]\r\n[New LWP 1512]\r\n[New LWP 1567]\r\n[New LWP 1561]\r\n[New LWP 1572]\r\n[New LWP 1893]\r\n[New LWP 1497]\r\n[New LWP 1477]\r\n[New LWP 1472]\r\n[New LWP 1473]\r\n[New LWP 1410]\r\n[New LWP 1488]\r\n[New LWP 1409]\r\n[New LWP 1895]\r\n[New LWP 1897]\r\n[New LWP 1544]\r\n[New LWP 1913]\r\n[New LWP 1914]\r\n[New LWP 1571]\r\n[New LWP 1535]\r\n[New LWP 1467]\r\n[New LWP 1900]\r\n[New LWP 1896]\r\n[New LWP 1486]\r\n[New LWP 1533]\r\n[New LWP 1549]\r\n[New LWP 1483]\r\n[New LWP 1545]\r\n[New LWP 1908]\r\n[New LWP 1539]\r\n[New LWP 1489]\r\n[New LWP 1515]\r\n[New LWP 1871]\r\n[New LWP 1490]\r\n[New LWP 1899]\r\n[New LWP 1563]\r\n[New LWP 1480]\r\n[New LWP 1910]\r\n[New LWP 1469]\r\n[New LWP 1570]\r\n[New LWP 1989]\r\n[New LWP 23454]\r\n[New LWP 1718]\r\n[New LWP 1584]\r\n[New LWP 1484]\r\n[New LWP 1560]\r\n[New LWP 1494]\r\n[New LWP 1408]\r\n[New LWP 1540]\r\n[New LWP 1474]\r\n[New LWP 1848]\r\n[New LWP 1916]\r\n[New LWP 1425]\r\n[New LWP 1876]\r\n[New LWP 1407]\r\n[New LWP 1513]\r\n[New LWP 1534]\r\n[New LWP 1439]\r\n[New LWP 1406]\r\n[New LWP 1465]\r\n[New LWP 10847]\r\n[New LWP 1585]\r\n[New LWP 1909]\r\n[New LWP 1476]\r\n[New LWP 1548]\r\n[New LWP 1481]\r\n[New LWP 1566]\r\n[New LWP 1587]\r\n[New LWP 1695]\r\n[New LWP 1694]\r\n[New LWP 1431]\r\n[New LWP 1586]\r\n[New LWP 1432]\r\n[New LWP 1696]\r\n[New LWP 1458]\r\n[New LWP 1461]\r\n[New LWP 1459]\r\n[New LWP 1460]\r\n[New LWP 1462]\r\n[New LWP 1711]\r\n[New LWP 1464]\r\n[New LWP 1463]\r\n[New LWP 1433]\r\n[New LWP 1435]\r\n[New LWP 1457]\r\n[New LWP 1443]\r\n[New LWP 1444]\r\n[New LWP 1442]\r\n[New LWP 1441]\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib64/libthread_db.so.1\".\r\nCore was generated by `tikv-server --log-level info --pd=192.168.20.80:2379,192.168.20.81:2379,192.168'.\r\nProgram terminated with signal 4, Illegal instruction.\r\n#0  0x000055ae260a31df in new_v1 () at /checkout/src/libcore/fmt/mod.rs:347\r\n347\t/checkout/src/libcore/fmt/mod.rs: No such file or directory.\r\nwarning: Missing auto-load scripts referenced in section .debug_gdb_scripts\r\nof file /home/tidb/tikv-server\r\nUse `info auto-load python [REGEXP]' to list them.\r\nMissing separate debuginfos, use: debuginfo-install glibc-2.17-196.el7.x86_64 libgcc-4.8.5-16.el7.x86_64\r\n(gdb) bt\r\n#0  0x000055ae260a31df in new_v1 () at /checkout/src/libcore/fmt/mod.rs:347\r\n#1  std::panicking::rust_panic_with_hook::h60a37fb79e459606 () at libstd/panicking.rs:490\r\n#2  0x000055ae26023f63 in std::panicking::begin_panic::hd155e0e5ba0036cf (msg=..., file_line_col=0x32) at /checkout/src/libstd/panicking.rs:409\r\n#3  0x000055ae26023f26 in _$LT$slog_scope..NoGlobalLoggerSet$u20$as$u20$slog..Drain$GT$::log::h3baf180ba0f73773 (self=0x0, _record=0x0, _values=0x0) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:123\r\n#4  0x000055ae260239cb in log<SendSyncRefUnwindSafeDrain> (record=0x7f95873fc2b0, o=0x0, self=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1679\r\n#5  log<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>> (record=0x7f95873fc2b0, self=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1193\r\n#6  {{closure}} (logger=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-stdlog-3.0.4-pre/lib.rs:99\r\n#7  {{closure}}<closure,()> (s=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:215\r\n#8  try_with<core::cell::RefCell<alloc::vec::Vec<*const slog::Logger<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>>>>,closure,()> (f=..., self=<optimized out>) at /checkout/src/libstd/thread/local.rs:294\r\n#9  with<core::cell::RefCell<alloc::vec::Vec<*const slog::Logger<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>>>>,closure,()> (f=..., self=<optimized out>) at /checkout/src/libstd/thread/local.rs:248\r\n#10 with_logger<closure,()> (f=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:211\r\n#11 _$LT$slog_stdlog..Logger$u20$as$u20$log..Log$GT$::log::hb8429808d5129044 (self=<optimized out>, r=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-stdlog-3.0.4-pre/lib.rs:99\r\n#12 0x000055ae26033d64 in log::__log::he02fbf0915f31dcd (level=0, target=..., loc=0x32, args=...) at /root/.cargo/git/checkouts/log-a40929f53ca27dda/70860d6/src/lib.rs:968\r\n#13 0x000055ae2594df5f in tikv::util::panic_hook::set_exit_hook::_$u7b$$u7b$closure$u7d$$u7d$::h50ab4ed8d0efb326 (info=<optimized out>) at src/util/panic_hook.rs:104\r\n#14 0x000055ae260a32e0 in std::panicking::rust_panic_with_hook::h60a37fb79e459606 () at libstd/panicking.rs:479\r\n#15 0x000055ae26023f63 in std::panicking::begin_panic::hd155e0e5ba0036cf (msg=..., file_line_col=0x32) at /checkout/src/libstd/panicking.rs:409\r\n#16 0x000055ae26023f26 in _$LT$slog_scope..NoGlobalLoggerSet$u20$as$u20$slog..Drain$GT$::log::h3baf180ba0f73773 (self=0x0, _record=0x0, _values=0x0) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:123\r\n#17 0x000055ae260239cb in log<SendSyncRefUnwindSafeDrain> (record=0x7f95873fc5d0, o=0x0, self=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1679\r\n#18 log<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>> (record=0x7f95873fc5d0, self=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1193\r\n#19 {{closure}} (logger=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-stdlog-3.0.4-pre/lib.rs:99\r\n#20 {{closure}}<closure,()> (s=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:215\r\n#21 try_with<core::cell::RefCell<alloc::vec::Vec<*const slog::Logger<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>>>>,closure,()> (f=..., self=<optimized out>) at /checkout/src/libstd/thread/local.rs:294\r\n#22 with<core::cell::RefCell<alloc::vec::Vec<*const slog::Logger<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>>>>,closure,()> (f=..., self=<optimized out>) at /checkout/src/libstd/thread/local.rs:248\r\n#23 with_logger<closure,()> (f=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:211\r\n#24 _$LT$slog_stdlog..Logger$u20$as$u20$log..Log$GT$::log::hb8429808d5129044 (self=<optimized out>, r=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-stdlog-3.0.4-pre/lib.rs:99\r\n#25 0x000055ae26033d64 in log::__log::he02fbf0915f31dcd (level=0, target=..., loc=0x32, args=...) at /root/.cargo/git/checkouts/log-a40929f53ca27dda/70860d6/src/lib.rs:968\r\n#26 0x000055ae2594df5f in tikv::util::panic_hook::set_exit_hook::_$u7b$$u7b$closure$u7d$$u7d$::h50ab4ed8d0efb326 (info=<optimized out>) at src/util/panic_hook.rs:104\r\n#27 0x000055ae260a32e0 in std::panicking::rust_panic_with_hook::h60a37fb79e459606 () at libstd/panicking.rs:479\r\n#28 0x000055ae26023f63 in std::panicking::begin_panic::hd155e0e5ba0036cf (msg=..., file_line_col=0x32) at /checkout/src/libstd/panicking.rs:409\r\n#29 0x000055ae26023f26 in _$LT$slog_scope..NoGlobalLoggerSet$u20$as$u20$slog..Drain$GT$::log::h3baf180ba0f73773 (self=0x0, _record=0x0, _values=0x0) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:123\r\n#30 0x000055ae260239cb in log<SendSyncRefUnwindSafeDrain> (record=0x7f95873fc8f0, o=0x0, self=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1679\r\n#31 log<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>> (record=0x7f95873fc8f0, self=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1193\r\n#32 {{closure}} (logger=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-stdlog-3.0.4-pre/lib.rs:99\r\n#33 {{closure}}<closure,()> (s=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:215\r\n#34 try_with<core::cell::RefCell<alloc::vec::Vec<*const slog::Logger<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>>>>,closure,()> (f=..., self=<optimized out>) at /checkout/src/libstd/thread/local.rs:294\r\n#35 with<core::cell::RefCell<alloc::vec::Vec<*const slog::Logger<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>>>>,closure,()> (f=..., self=<optimized out>) at /checkout/src/libstd/thread/local.rs:248\r\n#36 with_logger<closure,()> (f=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:211\r\n#37 _$LT$slog_stdlog..Logger$u20$as$u20$log..Log$GT$::log::hb8429808d5129044 (self=<optimized out>, r=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-stdlog-3.0.4-pre/lib.rs:99\r\n#38 0x000055ae26033d64 in log::__log::he02fbf0915f31dcd (level=0, target=..., loc=0x32, args=...) at /root/.cargo/git/checkouts/log-a40929f53ca27dda/70860d6/src/lib.rs:968\r\n#39 0x000055ae2588ca78 in _$LT$futures..future..then..Then$LT$A$C$$u20$B$C$$u20$F$GT$$u20$as$u20$futures..future..Future$GT$::poll::h0024e91abae89084 (self=0x7f7038e18cc0) at <log macros>:7\r\n#40 0x000055ae25f620a6 in grpcio::async::executor::poll::hb9b2ca50c199459a (notify=<optimized out>, woken=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.23/src/future/mod.rs:113\r\n#41 0x000055ae25f62566 in _$LT$futures..task_impl..std..ArcWrapped$LT$T$GT$$u20$as$u20$futures..task_impl..Notify$GT$::notify::hfc33c5cdfec8d425 (self=<optimized out>, id=<optimized out>)\r\n    at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/grpcio-0.3.1/src/async/executor.rs:129\r\n#42 0x000055ae25f6067b in std::sys_common::backtrace::__rust_begin_short_backtrace::h0872b8e3a4c89c20 (f=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/futures-0.1.23/src/task_impl/mod.rs:621\r\n#43 0x000055ae25f5bbe6 in _$LT$F$u20$as$u20$alloc..boxed..FnBox$LT$A$GT$$GT$::call_box::hce191c21dd10985d (self=0x7f95f2bf8e00, args=<optimized out>) at /checkout/src/libstd/thread/mod.rs:409\r\n#44 0x000055ae260911f4 in std::sys::unix::thread::Thread::new::thread_start::h96884314b12ba24c () at /checkout/src/liballoc/boxed.rs:650\r\n#45 0x00007f9602bd9e25 in start_thread () from /lib64/libpthread.so.0\r\n#46 0x00007f96026f134d in clone () from /lib64/libc.so.6\r\n```\r\n\r\n\r\n```\r\n gdb tikv-server core.18532 \r\nGNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-115.el7\r\nCopyright (C) 2013 Free Software Foundation, Inc.\r\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\r\nThis is free software: you are free to change and redistribute it.\r\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\r\nand \"show warranty\" for details.\r\nThis GDB was configured as \"x86_64-redhat-linux-gnu\".\r\nFor bug reporting instructions, please see:\r\n<http://www.gnu.org/software/gdb/bugs/>...\r\nReading symbols from /home/tidb/tikv-server...done.\r\n[New LWP 18653]\r\n[New LWP 18657]\r\n[New LWP 18664]\r\n[New LWP 18660]\r\n[New LWP 18666]\r\n[New LWP 18667]\r\n[New LWP 18655]\r\n[New LWP 18656]\r\n[New LWP 18707]\r\n[New LWP 18676]\r\n[New LWP 18654]\r\n[New LWP 18540]\r\n[New LWP 18686]\r\n[New LWP 18679]\r\n[New LWP 18682]\r\n[New LWP 18665]\r\n[New LWP 18539]\r\n[New LWP 18681]\r\n[New LWP 18668]\r\n[New LWP 18658]\r\n[New LWP 18659]\r\n[New LWP 18673]\r\n[New LWP 18670]\r\n[New LWP 18671]\r\n[New LWP 18678]\r\n[New LWP 18687]\r\n[New LWP 18705]\r\n[New LWP 18704]\r\n[New LWP 18685]\r\n[New LWP 18714]\r\n[New LWP 23415]\r\n[New LWP 27553]\r\n[New LWP 18611]\r\n[New LWP 18697]\r\n[New LWP 18691]\r\n[New LWP 18722]\r\n[New LWP 18672]\r\n[New LWP 18669]\r\n[New LWP 18677]\r\n[New LWP 18690]\r\n[New LWP 18693]\r\n[New LWP 18680]\r\n[New LWP 18703]\r\n[New LWP 18683]\r\n[New LWP 23048]\r\n[New LWP 18560]\r\n[New LWP 18717]\r\n[New LWP 18715]\r\n[New LWP 18720]\r\n[New LWP 18723]\r\n[New LWP 18675]\r\n[New LWP 18692]\r\n[New LWP 18689]\r\n[New LWP 18696]\r\n[New LWP 18706]\r\n[New LWP 23414]\r\n[New LWP 27069]\r\n[New LWP 18610]\r\n[New LWP 18537]\r\n[New LWP 18719]\r\n[New LWP 18713]\r\n[New LWP 18694]\r\n[New LWP 18698]\r\n[New LWP 18684]\r\n[New LWP 18726]\r\n[New LWP 23449]\r\n[New LWP 18633]\r\n[New LWP 18721]\r\n[New LWP 18724]\r\n[New LWP 18777]\r\n[New LWP 18695]\r\n[New LWP 18766]\r\n[New LWP 18727]\r\n[New LWP 18732]\r\n[New LWP 18775]\r\n[New LWP 18636]\r\n[New LWP 18559]\r\n[New LWP 18771]\r\n[New LWP 27554]\r\n[New LWP 18849]\r\n[New LWP 18598]\r\n[New LWP 18646]\r\n[New LWP 18779]\r\n[New LWP 18700]\r\n[New LWP 18767]\r\n[New LWP 18731]\r\n[New LWP 18783]\r\n[New LWP 18765]\r\n[New LWP 18644]\r\n[New LWP 18642]\r\n[New LWP 18774]\r\n[New LWP 18558]\r\n[New LWP 18600]\r\n[New LWP 18674]\r\n[New LWP 18536]\r\n[New LWP 18716]\r\n[New LWP 18786]\r\n[New LWP 18768]\r\n[New LWP 18733]\r\n[New LWP 18614]\r\n[New LWP 18770]\r\n[New LWP 18643]\r\n[New LWP 18628]\r\n[New LWP 18728]\r\n[New LWP 18778]\r\n[New LWP 18650]\r\n[New LWP 18608]\r\n[New LWP 18718]\r\n[New LWP 18552]\r\n[New LWP 18623]\r\n[New LWP 18541]\r\n[New LWP 18781]\r\n[New LWP 18780]\r\n[New LWP 18619]\r\n[New LWP 18586]\r\n[New LWP 18605]\r\n[New LWP 18604]\r\n[New LWP 18621]\r\n[New LWP 18729]\r\n[New LWP 18782]\r\n[New LWP 18601]\r\n[New LWP 18617]\r\n[New LWP 18785]\r\n[New LWP 18557]\r\n[New LWP 18616]\r\n[New LWP 18699]\r\n[New LWP 18688]\r\n[New LWP 18607]\r\n[New LWP 18629]\r\n[New LWP 18784]\r\n[New LWP 18773]\r\n[New LWP 18606]\r\n[New LWP 18624]\r\n[New LWP 18647]\r\n[New LWP 18640]\r\n[New LWP 18602]\r\n[New LWP 18787]\r\n[New LWP 18599]\r\n[New LWP 18701]\r\n[New LWP 18730]\r\n[New LWP 18627]\r\n[New LWP 18609]\r\n[New LWP 18631]\r\n[New LWP 18622]\r\n[New LWP 31227]\r\n[New LWP 18637]\r\n[New LWP 18725]\r\n[New LWP 18612]\r\n[New LWP 18615]\r\n[New LWP 18625]\r\n[New LWP 18626]\r\n[New LWP 18620]\r\n[New LWP 18618]\r\n[New LWP 18603]\r\n[New LWP 18538]\r\n[New LWP 18776]\r\n[New LWP 18648]\r\n[New LWP 18645]\r\n[New LWP 18632]\r\n[New LWP 18630]\r\n[New LWP 18638]\r\n[New LWP 18580]\r\n[New LWP 18634]\r\n[New LWP 18649]\r\n[New LWP 18702]\r\n[New LWP 18641]\r\n[New LWP 18635]\r\n[New LWP 18651]\r\n[New LWP 18639]\r\n[New LWP 18613]\r\n[New LWP 18571]\r\n[New LWP 18572]\r\n[New LWP 18564]\r\n[New LWP 18563]\r\n[New LWP 18567]\r\n[New LWP 18566]\r\n[New LWP 18568]\r\n[New LWP 18569]\r\n[New LWP 18570]\r\n[New LWP 18663]\r\n[New LWP 18661]\r\n[New LWP 18662]\r\n[New LWP 18562]\r\n[New LWP 18561]\r\n[New LWP 18565]\r\n[New LWP 18553]\r\n[New LWP 18652]\r\n[New LWP 18578]\r\n[New LWP 18532]\r\n[New LWP 18583]\r\n[New LWP 18555]\r\n[New LWP 18554]\r\n[New LWP 18575]\r\n[New LWP 18582]\r\n[New LWP 18597]\r\n[New LWP 18556]\r\n[New LWP 18579]\r\n[New LWP 18588]\r\n[New LWP 18581]\r\n[New LWP 18574]\r\n[New LWP 18584]\r\n[New LWP 18577]\r\n[New LWP 18590]\r\n[New LWP 18591]\r\n[New LWP 18576]\r\n[New LWP 18596]\r\n[New LWP 18587]\r\n[New LWP 18573]\r\n[New LWP 18589]\r\n[New LWP 18585]\r\n[New LWP 18592]\r\n[New LWP 18594]\r\n[New LWP 18595]\r\n[New LWP 18593]\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib64/libthread_db.so.1\".\r\nCore was generated by `tikv-server --log-level info --pd=192.168.20.80:2379,192.168.20.81:2379,192.168'.\r\nProgram terminated with signal 4, Illegal instruction.\r\n#0  0x000055b4607a21df in new_v1 () at /checkout/src/libcore/fmt/mod.rs:347\r\n347\t/checkout/src/libcore/fmt/mod.rs: No such file or directory.\r\nwarning: Missing auto-load scripts referenced in section .debug_gdb_scripts\r\nof file /home/tidb/tikv-server\r\nUse `info auto-load python [REGEXP]' to list them.\r\nMissing separate debuginfos, use: debuginfo-install glibc-2.17-196.el7.x86_64 libgcc-4.8.5-16.el7.x86_64\r\n(gdb) bt\r\n#0  0x000055b4607a21df in new_v1 () at /checkout/src/libcore/fmt/mod.rs:347\r\n#1  std::panicking::rust_panic_with_hook::h60a37fb79e459606 () at libstd/panicking.rs:490\r\n#2  0x000055b460722f63 in std::panicking::begin_panic::hd155e0e5ba0036cf (msg=..., file_line_col=0x32) at /checkout/src/libstd/panicking.rs:409\r\n#3  0x000055b460722f26 in _$LT$slog_scope..NoGlobalLoggerSet$u20$as$u20$slog..Drain$GT$::log::h3baf180ba0f73773 (self=0x0, _record=0x0, _values=0x0) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:123\r\n#4  0x000055b4607229cb in log<SendSyncRefUnwindSafeDrain> (record=0x7fef9edf6a10, o=0x0, self=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1679\r\n#5  log<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>> (record=0x7fef9edf6a10, self=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1193\r\n#6  {{closure}} (logger=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-stdlog-3.0.4-pre/lib.rs:99\r\n#7  {{closure}}<closure,()> (s=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:215\r\n#8  try_with<core::cell::RefCell<alloc::vec::Vec<*const slog::Logger<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>>>>,closure,()> (f=..., self=<optimized out>) at /checkout/src/libstd/thread/local.rs:294\r\n#9  with<core::cell::RefCell<alloc::vec::Vec<*const slog::Logger<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>>>>,closure,()> (f=..., self=<optimized out>) at /checkout/src/libstd/thread/local.rs:248\r\n#10 with_logger<closure,()> (f=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:211\r\n#11 _$LT$slog_stdlog..Logger$u20$as$u20$log..Log$GT$::log::hb8429808d5129044 (self=<optimized out>, r=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-stdlog-3.0.4-pre/lib.rs:99\r\n#12 0x000055b460732d64 in log::__log::he02fbf0915f31dcd (level=0, target=..., loc=0x32, args=...) at /root/.cargo/git/checkouts/log-a40929f53ca27dda/70860d6/src/lib.rs:968\r\n#13 0x000055b46004cf5f in tikv::util::panic_hook::set_exit_hook::_$u7b$$u7b$closure$u7d$$u7d$::h50ab4ed8d0efb326 (info=<optimized out>) at src/util/panic_hook.rs:104\r\n#14 0x000055b4607a22e0 in std::panicking::rust_panic_with_hook::h60a37fb79e459606 () at libstd/panicking.rs:479\r\n#15 0x000055b460722f63 in std::panicking::begin_panic::hd155e0e5ba0036cf (msg=..., file_line_col=0x32) at /checkout/src/libstd/panicking.rs:409\r\n#16 0x000055b460722f26 in _$LT$slog_scope..NoGlobalLoggerSet$u20$as$u20$slog..Drain$GT$::log::h3baf180ba0f73773 (self=0x0, _record=0x0, _values=0x0) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:123\r\n#17 0x000055b4607229cb in log<SendSyncRefUnwindSafeDrain> (record=0x7fef9edf6d30, o=0x0, self=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1679\r\n#18 log<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>> (record=0x7fef9edf6d30, self=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1193\r\n#19 {{closure}} (logger=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-stdlog-3.0.4-pre/lib.rs:99\r\n#20 {{closure}}<closure,()> (s=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:215\r\n#21 try_with<core::cell::RefCell<alloc::vec::Vec<*const slog::Logger<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>>>>,closure,()> (f=..., self=<optimized out>) at /checkout/src/libstd/thread/local.rs:294\r\n#22 with<core::cell::RefCell<alloc::vec::Vec<*const slog::Logger<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>>>>,closure,()> (f=..., self=<optimized out>) at /checkout/src/libstd/thread/local.rs:248\r\n#23 with_logger<closure,()> (f=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:211\r\n#24 _$LT$slog_stdlog..Logger$u20$as$u20$log..Log$GT$::log::hb8429808d5129044 (self=<optimized out>, r=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-stdlog-3.0.4-pre/lib.rs:99\r\n#25 0x000055b460732d64 in log::__log::he02fbf0915f31dcd (level=0, target=..., loc=0x32, args=...) at /root/.cargo/git/checkouts/log-a40929f53ca27dda/70860d6/src/lib.rs:968\r\n#26 0x000055b46004cf5f in tikv::util::panic_hook::set_exit_hook::_$u7b$$u7b$closure$u7d$$u7d$::h50ab4ed8d0efb326 (info=<optimized out>) at src/util/panic_hook.rs:104\r\n#27 0x000055b4607a22e0 in std::panicking::rust_panic_with_hook::h60a37fb79e459606 () at libstd/panicking.rs:479\r\n#28 0x000055b460722f63 in std::panicking::begin_panic::hd155e0e5ba0036cf (msg=..., file_line_col=0x32) at /checkout/src/libstd/panicking.rs:409\r\n#29 0x000055b460722f26 in _$LT$slog_scope..NoGlobalLoggerSet$u20$as$u20$slog..Drain$GT$::log::h3baf180ba0f73773 (self=0x0, _record=0x0, _values=0x0) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:123\r\n#30 0x000055b4607229cb in log<SendSyncRefUnwindSafeDrain> (record=0x7fef9edf7050, o=0x0, self=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1679\r\n#31 log<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>> (record=0x7fef9edf7050, self=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-2.3.3/src/lib.rs:1193\r\n#32 {{closure}} (logger=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-stdlog-3.0.4-pre/lib.rs:99\r\n#33 {{closure}}<closure,()> (s=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:215\r\n#34 try_with<core::cell::RefCell<alloc::vec::Vec<*const slog::Logger<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>>>>,closure,()> (f=..., self=<optimized out>) at /checkout/src/libstd/thread/local.rs:294\r\n#35 with<core::cell::RefCell<alloc::vec::Vec<*const slog::Logger<alloc::sync::Arc<SendSyncRefUnwindSafeDrain>>>>,closure,()> (f=..., self=<optimized out>) at /checkout/src/libstd/thread/local.rs:248\r\n#36 with_logger<closure,()> (f=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-scope-4.0.1/lib.rs:211\r\n#37 _$LT$slog_stdlog..Logger$u20$as$u20$log..Log$GT$::log::hb8429808d5129044 (self=<optimized out>, r=<optimized out>) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/slog-stdlog-3.0.4-pre/lib.rs:99\r\n#38 0x000055b460732c13 in _$LT$log..LoggerAdaptor$u20$as$u20$log..Log$GT$::log::hf75a28fa3b984dd9 (self=<optimized out>, record=<optimized out>) at /root/.cargo/git/checkouts/log-a40929f53ca27dda/70860d6/src/lib.rs:907\r\n#39 0x000055b45ffe579a in _$LT$raft..raft..Raft$LT$T$GT$$GT$::step::h959eec8db27464dd (self=0x7fef71b902b0, m=...) at /root/.cargo/git/checkouts/log-a40929f53ca27dda/20502c5/src/lib.rs:1232\r\n#40 0x000055b45fe7358d in tikv::raftstore::store::fsm::peer::_$LT$impl$u20$tikv..raftstore..store..fsm..Store$LT$T$C$$u20$C$GT$$GT$::on_raft_message::hed739f4d1989d66b (self=0x7fef9edfbf38, msg=...)\r\n    at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/raft-0.4.3/src/raw_node.rs:337\r\n#41 0x000055b45fe814bb in tikv::raftstore::store::fsm::store::_$LT$impl$u20$mio..handler..Handler$u20$for$u20$tikv..raftstore..store..fsm..Store$LT$T$C$$u20$C$GT$$GT$::notify::h3926823e53159cac (self=0x7fef9edfbf38, event_loop=<optimized out>, msg=...)\r\n    at /go/src/github.com/tikv/tikv/src/raftstore/store/fsm/store.rs:1049\r\n#42 0x000055b45fdd508a in _$LT$mio..event_loop..EventLoop$LT$H$GT$$GT$::run_once::h38c0e95e48c1d3ed (self=0x7fef9edfb498, handler=0x7fef9edfbf38, timeout_ms=...) at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/mio-0.5.1/src/event_loop.rs:350\r\n#43 0x000055b45fea6c17 in tikv::raftstore::store::fsm::store::_$LT$impl$u20$tikv..raftstore..store..fsm..Store$LT$T$C$$u20$C$GT$$GT$::run::h3c396c224ffa1402 (self=<optimized out>, event_loop=0x7fef9edfb498)\r\n    at /root/.cargo/registry/src/github.com-1ecc6299db9ec823/mio-0.5.1/src/event_loop.rs:247\r\n#44 0x000055b45fdafd4f in std::sys_common::backtrace::__rust_begin_short_backtrace::h8c8279dcde9f47ed (f=...) at /go/src/github.com/tikv/tikv/src/server/node.rs:376\r\n#45 0x000055b46080c822 in _$LT$F$u20$as$u20$alloc..boxed..FnBox$LT$A$GT$$GT$::call_box::he0781114f2a2e3ea (self=0x7ff01da34e00, args=<optimized out>) at /checkout/src/libstd/thread/mod.rs:409\r\n#46 0x000055b4607901f4 in std::sys::unix::thread::Thread::new::thread_start::h96884314b12ba24c () at /checkout/src/liballoc/boxed.rs:650\r\n#47 0x00007ff01ead2e25 in start_thread () from /lib64/libpthread.so.0\r\n#48 0x00007ff01e5ea34d in clone () from /lib64/libc.so.6\r\n(gdb) \r\n```\r\n",
  "state": "closed",
  "created_at": "2019-11-10T02:36:44Z",
  "updated_at": "2019-11-10T18:23:20Z",
  "closed_at": "2019-11-10T18:23:20Z",
  "labels": [
    "type/bug"
  ],
  "comments_data": [
    {
      "id": 552167676,
      "user": "siddontang",
      "created_at": "2019-11-10T06:31:02Z",
      "body": "> tikv's memory usage should be stable and bounded and should not crash\r\n\r\nPTAL @zhangjinpeng1987 "
    },
    {
      "id": 552199427,
      "user": "darren",
      "created_at": "2019-11-10T14:25:18Z",
      "body": "With the following config, the memory usage of tikv can be as high as 90% of system memory and be swapped out, the the status of the tikv shows `disconnected` in the pd server, the leaders of the regions on the tikv are evicted,  and query in tidb shows `tikv server is busy`  \r\n\r\nAre there any other options in the config that can be used to control the memory usage except the `x-cache-size` settings?\r\n\r\n```\r\ntop - 22:13:29 up 780 days, 10:22,  1 user,  load average: 16.95, 10.15, 6.45\r\nTasks:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie\r\ntop - 22:17:40 up 780 days, 10:26,  1 user,  load average: 3.31, 6.38, 5.77\r\nTasks:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie\r\n%Cpu(s):  5.0 us,  0.7 sy,  0.0 ni, 93.7 id,  0.4 wa,  0.0 hi,  0.2 si,  0.0 st\r\nMiB Mem : 64235.70+total, 44075.63+free, 16558.62+used, 3601.449 buff/cache\r\nMiB Swap: 32767.99+total, 25058.16+free, 7709.828 used. 47048.89+avail Mem \r\n\r\n PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND     SWAP                        \r\n32084 root      20   0  0.130t 0.057t   7.3m S  93.0 90.4  3285:02 tikv-server  3.243g\r\n\r\n```\r\n\r\ntikv config:\r\n\r\n```\r\n[server]\r\nlog-level = \"info\"\r\n[metric]\r\ninterval = \"15s\"\r\njob = \"tikv\"\r\n[raftstore]\r\nsync-log = false\r\npd-heartbeat-tick-interval = \"3m\"\r\npd-store-heartbeat-tick-interval = \"15s\"\r\n[pd]\r\n[rocksdb]\r\ncompaction-readahead-size = \"8MB\"\r\n[rocksdb.defaultcf]\r\ncompression-per-level = [\"no\", \"snappy\", \"lz4\", \"lz4\", \"lz4\", \"zstd\", \"zstd\"]\r\nmax-write-buffer-number = 15\r\nblock-cache-size = \"1GB\"\r\n[rocksdb.writecf]\r\nblock-cache-size = \"256MB\"\r\n[rocksdb.raftcf]\r\nblock-cache-size = \"128MB\"\r\n[rocksdb.lockcf]\r\nblock-cache-size = \"128MB\"\r\n[storage]\r\nscheduler-worker-pool-size = 8\r\n```\r\n"
    },
    {
      "id": 552219852,
      "user": "darren",
      "created_at": "2019-11-10T18:23:20Z",
      "body": "sorry, the high memory usage  is caused by bad SQL in application code that is doing full table scan without index."
    }
  ]
}