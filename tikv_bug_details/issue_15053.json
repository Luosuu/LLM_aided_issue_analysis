{
  "issue_number": 15053,
  "title": "tikv panic because SST files of sst_importer is deleted before raft ingest",
  "body": "replace https://github.com/tikv/tikv/issues/15003\r\n\r\nIn a IMPORT INTO test case, import_mode is **off**. A tikv node keeps panic\r\n\r\n```\r\n[2023/06/29 08:18:21.507 +00:00] [FATAL] [lib.rs:497] [\"[region 1219424] 1219427 ingest uuid: FE812936A6A541748DFA17324AC24D0F range { start: 7480000000000000FF625F698000000000FF00000B013062754CFF73483434FF764158FF736D61384BFF6E30FF45324841756EFF69FF314958644D7167FFFF0000000000000000FFF7016E6F64653051FF6D49FF4C6C334354FF547167FF4E70764EFF51737131FF503554FF386B594443FF505AFF363470774676FF77FF457065576D6D73FFFF744F57536D643945FFFF713371714F4A44FF63FF415762756874FF6449FF5253593258FF6D336DFF49544D66FF43707041FF415970FF644536466AFF5A6FFF586E416E4337FF67FF784B5468676175FFFF746579576B594764FFFF696D6F50777078FF4AFF597A39414F57FF3262FF444F556667FF616967FF56585832FF6459466EFF313575FF626D785631FF4153FF6B63306E3037FF55FF63556463706F42FFFF57426B49356E5643FFFF4F543957555659FF67FF676243683433FF3876FF6D316D4E78FF78697AFF61504564FF71486C39FF6C3254FF30784F4E34FF5500FF000000000000F800FE end: 7480000000000000FF625F698000000000FF00000B0131334954FF374D7732FF616C46FF6B32755542FF7231FF734D6F584930FF6BFF624862566A5066FFFF0000000000000000FFF7016E6F64653065FF7034FF4A7A596E45FF70795AFF65667056FF6F434237FF346A4BFF3951704F4CFF4175FF527644317065FF51FF674C6B4A424155FFFF576C6E75546E3968FFFF52513677646478FF45FF626E6A455131FF6369FF774C4D3265FF454F64FF51426A76FF6347344CFF4F7175FF4756664545FF666BFF357331677538FF4DFF73314E54486F68FFFF6178633473383248FFFF6136426C327A30FF47FF764C656E7744FF5559FF7258324446FF353345FF77484356FF6C384776FF427375FF3439704F58FF4B42FF777A63476746FF32FF497A457073306BFFFF44436F31426C5671FFFF4B63457631776FFF5AFF777650756269FF5833FF374C4B6A48FF304E6FFF4136476FFF72367A53FF7A474EFF516D506A6FFF6C00FF000000000000F800FE } cf_name: \\\"write\\\" region_id: 1219424 region_epoch { conf_ver: 29 version: 726 }: EngineTraits(Engine(Status { code: IoError, sub_code: None, sev: NoError, state: \\\"IO error: No such file or directory: while stat a file for size: /var/lib/tikv/data/import/fe812936-a6a5-4174-8dfa-17324ac24d0f_1219424_29_726_write.sst: No such file or directory\\\" }))\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/lib.rs:496:18\\n   1: <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2032:9\\n      std::panicking::rust_panic_with_hook\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:692:13\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:579:13\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:137:18\\n   4: rust_begin_unwind\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:575:5\\n   5: core::panicking::panic_fmt\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:65:14\\n   6: raftstore::store::fsm::apply::ApplyDelegate<EK>::handle_ingest_sst\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/store/fsm/apply.rs:2005:17\\n      raftstore::store::fsm::apply::ApplyDelegate<EK>::exec_write_cmd\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/store/fsm/apply.rs:1755:39\\n      raftstore::store::fsm::apply::ApplyDelegate<EK>::exec_raft_cmd\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/store/fsm/apply.rs:1678:13\\n      raftstore::store::fsm::apply::ApplyDelegate<EK>::apply_raft_cmd\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/store/fsm/apply.rs:1442:45\\n   7: raftstore::store::fsm::apply::ApplyDelegate<EK>::process_raft_cmd\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/store/fsm/apply.rs:1378:52\\n   8: raftstore::store::fsm::apply::ApplyDelegate<EK>::handle_raft_entry_normal\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/store/fsm/apply.rs:1256:24\\n      raftstore::store::fsm::apply::ApplyDelegate<EK>::handle_raft_committed_entries\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/store/fsm/apply.rs:1130:43\\n   9: raftstore::store::fsm::apply::ApplyFsm<EK>::resume_pending\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/store/fsm/apply.rs:4107:13\\n      <raftstore::store::fsm::apply::ApplyPoller<EK> as batch_system::batch::PollHandler<raftstore::store::fsm::apply::ApplyFsm<EK>,raftstore::store::fsm::apply::ControlFsm>>::handle_normal\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/store/fsm/apply.rs:4588:13\\n  10: batch_system::batch::Poller<N,C,Handler>::poll\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/batch-system/src/batch.rs:422:27\\n  11: batch_system::batch::BatchSystem<N,C>::start_poller::{{closure}}\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/batch-system/src/batch.rs:550:17\\n      <std::thread::Builder as tikv_util::sys::thread::StdThreadBuildWrapper>::spawn_wrapper::{{closure}}\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/sys/thread.rs:427:23\\n      std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:121:18\\n  12: std::thread::Builder::spawn_unchecked_::{{closure}}::{{closure}}\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:551:17\\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panic/unwind_safe.rs:271:9\\n      std::panicking::try::do_call\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:483:40\\n      std::panicking::try\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:447:19\\n      std::panic::catch_unwind\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panic.rs:137:14\\n      std::thread::Builder::spawn_unchecked_::{{closure}}\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:550:30\\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:513:5\\n  13: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2000:9\\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2000:9\\n      std::sys::unix::thread::Thread::new::thread_start\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/unix/thread.rs:108:17\\n  14: start_thread\\n  15: clone3\\n\"] [location=/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore/src/store/fsm/apply.rs:2005] [thread_name=apply-low-0]\r\n```\r\n\r\nThis is because it has deleted the SST files needed by ingest. Related log lines are\r\n\r\n```\r\n[2023/06/29 08:13:17.607 +00:00] [INFO] [sst_importer.rs:259] [delete] [path=\"ImportPath { save: \\\"/var/lib/tikv/data/import/fe812936-a6a5-4174-8dfa-17324ac24d0f_1219424_29_726_write.sst\\\", temp: \\\"/var/lib/tikv/data/import/.temp/fe812936-a6a5-4174-8dfa-17324ac24d0f_1219424_29_726_write.sst\\\", clone: \\\"/var/lib/tikv/data/import/.clone/fe812936-a6a5-4174-8dfa-17324ac24d0f_1219424_29_726_write.sst\\\" }\"]\r\n[2023/06/29 08:13:35.599 +00:00] [INFO] [apply.rs:1690] [\"execute admin command\"] [command=\"cmd_type: BatchSplit splits { requests { split_key: 7480000000000000FF625F698000000000FF00000B0131334954FF46633679FF785449FF7A47724634FF4B64FF554F70637031FF46FF67386558565145FFFF0000000000000000FFF7016E6F64653070FF6E6AFF637338616BFF453273FF526B654CFF75734E7AFF304246FF52526F6550FF3173FF455443795347FF48FF6F56466441306AFFFF7065794A41463851FFFF6265346D544239FF6FFF7236357A4566FF587AFF623857614EFF4D6C5AFF306C566FFF43587678FF66617AFF6161615067FF514BFF51516F586A71FF68FF337253474D3464FFFF4267496533786A50FFFF50496D7A77424AFF32FF333848696365FF6F4AFF7659483742FF42414CFF6D307545FF49555743FF58716BFF7A434E3457FF624CFF4566624C354DFF38FF6F397073667059FFFF6968694C5A697835FFFF35447A3658686BFF35FF5252534E4F4AFF5A77FF5159463059FF523463FF4D666848FF704A5541FF427256FF7636334B53FF4700FF000000000000F800FE new_region_id: 1219424 new_peer_ids: 1219425 new_peer_ids: 1219426 new_peer_ids: 1219427 } right_derive: true }\"] [index=8] [term=6] [peer_id=1214974] [region_id=1214971]\r\n[2023/06/29 08:18:21.507 +00:00] *panic, see above code block*\r\n```\r\n\r\nAnd from another peer of region 1219424, we can see order of the related events in raft log is\r\n\r\n1. [2023/06/29 08:06:38.310 +00:00] region 1219424 is generated from split, with { conf_ver: 29 version: 726 }\r\n2. [2023/06/29 08:12:03.599 +00:00] ingest fe812936-a6a5-4174-8dfa-17324ac24d0f_1219424_29_726_write.sst\r\n3. [2023/06/29 08:12:14.491 +00:00] region 1219424 splits into multiple regions, now the epoch is { conf_ver: 29 version: 727 }\r\n\r\nWe infer that the delete stale SST files logic is wrong. At `[2023/06/29 08:13:17.607 +00:00]` the panic tikv is in \"off\" import_mode, it does not have the region in local store because of slow raft process, and the PD shows region 1219424 has newer epoch than the epoch encoded in SST filename. These condition may cause wrong deletion.",
  "state": "closed",
  "created_at": "2023-07-03T05:58:05Z",
  "updated_at": "2024-08-05T02:50:44Z",
  "closed_at": "2024-01-29T21:45:57Z",
  "labels": [
    "type/bug",
    "severity/major",
    "may-affects-5.2",
    "may-affects-5.3",
    "may-affects-5.4",
    "may-affects-6.1",
    "affects-6.5",
    "affects-7.1",
    "affects-7.5"
  ],
  "comments_data": [
    {
      "id": 1617410316,
      "user": "lance6716",
      "created_at": "2023-07-03T06:00:12Z",
      "body": "And @tonyxuqqi suggest we can change the delete stale SST files logic. The stale SST files can be deleted when we destroy the region. Can you help to fix this issue?"
    },
    {
      "id": 1651361568,
      "user": "tonyxuqqi",
      "created_at": "2023-07-26T09:32:30Z",
      "body": "Downgrade it to major as this issue is not new to 7.3. It has been there for 7.2 or earlier version.  And the tikv side change alone won't solve this issue, it needs lightning side change as well. "
    },
    {
      "id": 1915627988,
      "user": "tonyxuqqi",
      "created_at": "2024-01-29T21:45:57Z",
      "body": "The https://github.com/tikv/tikv/pull/15013 will likely solve this issue. Close it for now. "
    },
    {
      "id": 2268063631,
      "user": "lance6716",
      "created_at": "2024-08-05T02:39:12Z",
      "body": "/affects-7.1"
    },
    {
      "id": 2268071307,
      "user": "lance6716",
      "created_at": "2024-08-05T02:49:45Z",
      "body": "/label affects-7.1 affects-6.5"
    },
    {
      "id": 2268071890,
      "user": "lance6716",
      "created_at": "2024-08-05T02:50:29Z",
      "body": "/label affects-7.1"
    },
    {
      "id": 2268072010,
      "user": "lance6716",
      "created_at": "2024-08-05T02:50:40Z",
      "body": "/label affects-6.5"
    }
  ]
}