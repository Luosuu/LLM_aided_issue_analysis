{
  "issue_number": 17100,
  "title": "In-memory Engine: Deadlock during TPCC prepare ",
  "body": "## Bug Report\r\n\r\nThreads that interact with RocksDB are blocked by the deadlock on RocksDB mutex.\r\n\r\n\r\n```\r\nâžœ grep -E \"^Thread|Mutex::|__lll_lock_wait\" deadlock.log\r\n  22   Thread 0x7f2e9dad1640 (LWP 34) \"background-0\"     0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  23   Thread 0x7f2e9d8d0640 (LWP 35) \"background-1\"     0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  29   Thread 0x7f2e7bcb8640 (LWP 45) \"rocksdb:low\"      0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  32   Thread 0x7f2e7a4b5640 (LWP 48) \"rocksdb:low\"      0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  34   Thread 0x7f2e789ff640 (LWP 50) \"rocksdb:high\"     0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  36   Thread 0x7f2e6e5f5640 (LWP 68) \"tikv-server\"      0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  46   Thread 0x7f2e701fa640 (LWP 79) \"pd-worker-0\"      0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  47   Thread 0x7f2e6fff9640 (LWP 80) \"unified-read-po\"  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  48   Thread 0x7f2e6d5f3640 (LWP 81) \"unified-read-po\"  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  49   Thread 0x7f2e6cbf2640 (LWP 82) \"unified-read-po\"  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  50   Thread 0x7f2e6c1f1640 (LWP 83) \"unified-read-po\"  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  51   Thread 0x7f2e6b7f0640 (LWP 84) \"unified-read-po\"  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  52   Thread 0x7f2e6adef640 (LWP 85) \"unified-read-po\"  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  59   Thread 0x7f2e6ddf4640 (LWP 93) \"sched-worker-po\"  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  60   Thread 0x7f2e637e8640 (LWP 94) \"sched-worker-po\"  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  61   Thread 0x7f2e635e7640 (LWP 95) \"sched-worker-po\"  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  62   Thread 0x7f2e633e6640 (LWP 96) \"sched-worker-po\"  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  95   Thread 0x7f2e5f1c5640 (LWP 129) \"region-worker-0\" 0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  116  Thread 0x7f2e5b130640 (LWP 150) \"raftstore-1-0\"   0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n  119  Thread 0x7f2e56e2d640 (LWP 153) \"apply-1\"         0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\nThread 119 (Thread 0x7f2e56e2d640 (LWP 153) \"apply-1\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 118 (Thread 0x7f2e5702e640 (LWP 152) \"apply-0\"):\r\nThread 117 (Thread 0x7f2e5af2f640 (LWP 151) \"raftstore-1-1\"):\r\nThread 116 (Thread 0x7f2e5b130640 (LWP 150) \"raftstore-1-0\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 95 (Thread 0x7f2e5f1c5640 (LWP 129) \"region-worker-0\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 62 (Thread 0x7f2e633e6640 (LWP 96) \"sched-worker-po\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 61 (Thread 0x7f2e635e7640 (LWP 95) \"sched-worker-po\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 60 (Thread 0x7f2e637e8640 (LWP 94) \"sched-worker-po\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 59 (Thread 0x7f2e6ddf4640 (LWP 93) \"sched-worker-po\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 58 (Thread 0x7f2e689e9640 (LWP 91) \"resource-meteri\"):\r\nThread 57 (Thread 0x7f2e68bea640 (LWP 90) \"resource-meteri\"):\r\nThread 56 (Thread 0x7f2e68deb640 (LWP 89) \"resource-meteri\"):\r\nThread 55 (Thread 0x7f2e68fec640 (LWP 88) \"debugger\"):\r\nThread 54 (Thread 0x7f2e699ed640 (LWP 87) \"unified-read-po\"):\r\nThread 53 (Thread 0x7f2e6a3ee640 (LWP 86) \"unified-read-po\"):\r\nThread 52 (Thread 0x7f2e6adef640 (LWP 85) \"unified-read-po\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 51 (Thread 0x7f2e6b7f0640 (LWP 84) \"unified-read-po\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 50 (Thread 0x7f2e6c1f1640 (LWP 83) \"unified-read-po\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 49 (Thread 0x7f2e6cbf2640 (LWP 82) \"unified-read-po\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 48 (Thread 0x7f2e6d5f3640 (LWP 81) \"unified-read-po\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 47 (Thread 0x7f2e6fff9640 (LWP 80) \"unified-read-po\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 46 (Thread 0x7f2e701fa640 (LWP 79) \"pd-worker-0\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 45 (Thread 0x7f2e703fb640 (LWP 78) \"cdc-0\"):\r\nThread 44 (Thread 0x7f2e707fd640 (LWP 76) \"gc-worker-0\"):\r\nThread 43 (Thread 0x7f2e729fe640 (LWP 75) \"flow-checker\"):\r\nThread 42 (Thread 0x7f2e72bff640 (LWP 74) \"tikv-server\"):\r\nThread 41 (Thread 0x7f2e9a7ff640 (LWP 73) \"background-rang\"):\r\nThread 40 (Thread 0x7f2e9b07f640 (LWP 72) \"lock-cleanup-wo\"):\r\nThread 39 (Thread 0x7f2f29cff640 (LWP 71) \"background-dele\"):\r\nThread 38 (Thread 0x7f2e6f5f7640 (LWP 70) \"background-rang\"):\r\nThread 37 (Thread 0x7f2e6edf6640 (LWP 69) \"range-cache-bac\"):\r\nThread 36 (Thread 0x7f2e6e5f5640 (LWP 68) \"tikv-server\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 35 (Thread 0x7f2e77bff640 (LWP 51) \"rocksdb:high\"):\r\nThread 34 (Thread 0x7f2e789ff640 (LWP 50) \"rocksdb:high\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 33 (Thread 0x7f2e797ff640 (LWP 49) \"rocksdb:low\"):\r\nThread 32 (Thread 0x7f2e7a4b5640 (LWP 48) \"rocksdb:low\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 31 (Thread 0x7f2e7acb6640 (LWP 47) \"rocksdb:low\"):\r\nThread 30 (Thread 0x7f2e7b4b7640 (LWP 46) \"rocksdb:low\"):\r\nThread 29 (Thread 0x7f2e7bcb8640 (LWP 45) \"rocksdb:low\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 28 (Thread 0x7f2e9ae7e640 (LWP 44) \"sst-recovery-0\"):\r\nThread 27 (Thread 0x7f2e99fff640 (LWP 43) \"re-metrics\"):\r\nThread 26 (Thread 0x7f2e927ff640 (LWP 42) \"grpc_global_tim\"):\r\nThread 25 (Thread 0x7f2e9bd7f640 (LWP 37) \"check-leader-0\"):\r\nThread 24 (Thread 0x7f2e9c7ff640 (LWP 36) \"region-collecto\"):\r\nThread 23 (Thread 0x7f2e9d8d0640 (LWP 35) \"background-1\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\nThread 22 (Thread 0x7f2e9dad1640 (LWP 34) \"background-0\"):\r\n#0  0x00007f2f3546b560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#2  0x000055ef248990c9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x000055ef247993e5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x000055ef247994a5 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f2f34e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n```\r\n\r\n[deadlock.log](https://github.com/user-attachments/files/15604111/deadlock.log)\r\n\r\n### What version of TiKV are you using?\r\n\r\nNightly, built on #16868 https://github.com/tikv/tikv/pull/16868/commits/604449c843e2e2c31f83ee15b575d5c67d0aedea\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nTiKV Config\r\n\r\n```toml\r\n[range-cache-engine]\r\n  enabled = true\r\n  hard-limit-threshold = \"8GB\"\r\n  soft-limit-threshold = \"5GB\"\r\n```\r\n\r\nTPCC commands\r\n\r\n```bash\r\n/root/.tiup/components/bench/v1.12.0/go-tpc \\\r\n    tpcc prepare \\\r\n    -H $HOST -P $PORT \\\r\n    -D tpcc100 --warehouses 100 -T 50\r\n```\r\n\r\n### What did you expect?\r\n\r\nNo deadlock.\r\n",
  "state": "closed",
  "created_at": "2024-06-06T05:19:58Z",
  "updated_at": "2024-06-11T09:38:45Z",
  "closed_at": "2024-06-11T09:38:44Z",
  "labels": [
    "type/bug"
  ],
  "comments_data": [
    {
      "id": 2159775106,
      "user": "overvenus",
      "created_at": "2024-06-11T04:34:56Z",
      "body": "The deadlock is caused by concurrent ingest and write. \r\nIngest sst first acquires mutext and then `WaitForPendingWrites()`, while writes needs to acquire mutex to get oldest snapshot in write_callback.\r\n\r\nIngest:\r\nhttps://github.com/tikv/rocksdb/blob/45509f0f530ad370863876fc1ee95ccf85bfe96d/db/db_impl/db_impl.cc#L4800-L4818\r\n\r\nWrite callback:\r\nhttps://github.com/tikv/tikv/blob/604449c843e2e2c31f83ee15b575d5c67d0aedea/components/region_cache_memory_engine/src/write_batch.rs#L158-L167\r\n"
    },
    {
      "id": 2160272717,
      "user": "overvenus",
      "created_at": "2024-06-11T09:38:44Z",
      "body": "Fixed by https://github.com/SpadeA-Tang/tikv/pull/5"
    }
  ]
}