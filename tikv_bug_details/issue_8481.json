{
  "issue_number": 8481,
  "title": "copr: tikv panic when executes aggr func ",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n```\r\n[2020-08-21T04:00:34.961Z] [2020/08/21 11:55:03.077 +08:00] [INFO] [lib.rs:95] [\"Git Commit Hash:   56961321cac9202ea2ba42da825e99ed56b82a57\"]\r\n[2020-08-21T04:00:34.961Z] [2020/08/21 11:55:03.077 +08:00] [INFO] [lib.rs:95] [\"Git Commit Branch: master\"]\r\n[2020-08-21T04:00:34.961Z] [2020/08/21 11:55:03.077 +08:00] [INFO] [lib.rs:95] [\"UTC Build Time:    2020-08-20 02:13:02\"]\r\n``` \r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\nwhen run  lightning integration test, tikv panic in executing query `SELECT count(i), sum(i) FROM cpch_tsr.tbl;`\r\n\r\n### What did you expect?\r\n\r\n### What did happened?\r\ntikv panic with:\r\n```\r\n[2020-08-21T04:00:35.067Z] [2020/08/21 11:59:47.714 +08:00] [FATAL] [lib.rs:483] [\"construct identical logical_rows larger than batch size\"] [backtrace=\"stack backtrace:\r\n   0: tikv_util::set_panic_hook::{{closure}}\r\n             at components/tikv_util/src/lib.rs:482\r\n   1: std::panicking::rust_panic_with_hook\r\n             at src/libstd/panicking.rs:524\r\n   2: std::panicking::begin_panic\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panicking.rs:450\r\n   3: <tidb_query_vec_executors::simple_aggr_executor::SimpleAggregationImpl as tidb_query_vec_executors::util::aggr_executor::AggregationExecutorImpl<Src>>::process_batch_input\r\n             at components/tidb_query_datatype/src/codec/data_type/logical_rows.rs:52\r\n      tidb_query_vec_executors::util::aggr_executor::AggregationExecutor<Src,I>::handle_next_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/util/aggr_executor.rs:205\r\n      <tidb_query_vec_executors::util::aggr_executor::AggregationExecutor<Src,I> as tidb_query_vec_executors::interface::BatchExecutor>::next_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/util/aggr_executor.rs:282\r\n      <tidb_query_vec_executors::simple_aggr_executor::BatchSimpleAggregationExecutor<Src> as tidb_query_vec_executors::interface::BatchExecutor>::next_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/simple_aggr_executor.rs:35\r\n      <tidb_query_common::execute_stats::WithSummaryCollector<C,T> as tidb_query_vec_executors::interface::BatchExecutor>::next_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/interface.rs:108\\n   4: <alloc::boxed::Box<T> as tidb_query_vec_executors::interface::BatchExecutor>::next_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/interface.rs:77\\n      tidb_query_vec_executors::runner::BatchExecutorsRunner<SS>::internal_handle_request\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/runner.rs:497\r\n   5: tidb_query_vec_executors::runner::BatchExecutorsRunner<SS>::handle_request::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/runner.rs:382\\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/mod.rs:74\r\n      <tikv::coprocessor::dag::BatchDAGHandler as tikv::coprocessor::RequestHandler>::handle_request::__handle_request::{{closure}}\r\n             at src/coprocessor/dag/mod.rs:152\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/mod.rs:74\r\n      <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/future.rs:119\r\n      <minitrace::future::TraceWrapped<T> as core::future::future::Future>::poll\r\n             at /rust/git/checkouts/minitrace-rust-4a91d55623f07cfc/de69110/src/future.rs:107\r\n   6: <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/future.rs:119\r\n      <minitrace::future::TraceWrapped<T> as core::future::future::Future>::poll\r\n             at /rust/git/checkouts/minitrace-rust-4a91d55623f07cfc/de69110/src/future.rs:107\r\n      <tikv::coprocessor::interceptors::tracker::Tracker<F> as core::future::future::Future>::poll\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/coprocessor/interceptors/tracker.rs:45\r\n   7: <tikv::coprocessor::interceptors::concurrency_limiter::ConcurrencyLimiter<PF,F> as core::future::future::Future>::poll\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/coprocessor/interceptors/concurrency_limiter.rs:101\r\n      tikv::coprocessor::endpoint::Endpoint<E>::handle_unary_request_impl::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/coprocessor/endpoint.rs:402\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/mod.rs:74\r\n      <minitrace::future::TraceSpawned<T> as core::future::future::Future>::poll\r\n             at /rust/git/checkouts/minitrace-rust-4a91d55623f07cfc/de69110/src/future.rs:77\r\n      tikv::read_pool::ReadPoolHandle::spawn_handle::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/read_pool.rs:139\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/mod.rs:74\r\n   8: tikv::read_pool::ReadPoolHandle::spawn::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/read_pool.rs:115\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/mod.rs:74\r\n   9: <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/3894a86/src/task/future.rs:254\r\n  10: <tikv::read_pool::ReadPoolRunner<E,R> as yatp::pool::runner::Runner>::handle\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/read_pool.rs:169\r\n      <yatp::queue::multilevel::MultilevelRunner<R> as yatp::pool::runner::Runner>::handle\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/3894a86/src/queue/multilevel.rs:245\r\n      yatp::pool::worker::WorkerThread<T,R>::run\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/3894a86/src/pool/worker.rs:48\r\n      yatp::pool::builder::LazyBuilder<T>::build::{{closure}}\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/3894a86/src/pool/builder.rs:91\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/sys_common/backtrace.rs:130\r\n  11: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/thread/mod.rs:475\r\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panic.rs:318\r\n      std::panicking::try::do_call\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panicking.rs:342\r\n      std::panicking::try\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panicking.rs:319\r\n      std::panic::catch_unwind\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panic.rs:394\r\n      std::thread::Builder::spawn_unchecked::{{closure}}\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/thread/mod.rs:474\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/ops/function.rs:233\r\n  12: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/liballoc/boxed.rs:1078\r\n      <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/liballoc/boxed.rs:1078\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at src/libstd/sys/unix/thread.rs:87\\n  13: start_thread\r\n  14: __clone\\n\"] [location=components/tidb_query_datatype/src/codec/data_type/logical_rows.rs:52] [thread_name=unified-read-pool-4]\r\n```\r\n\r\nI think the related pr is #8397\r\n\r\nSee the detail logs at:  https://internal.pingcap.net/idc-jenkins/blue/organizations/jenkins/lightning_ghpr_test/detail/lightning_ghpr_test/1368/pipeline",
  "state": "closed",
  "created_at": "2020-08-21T07:02:45Z",
  "updated_at": "2020-08-22T07:21:57Z",
  "closed_at": "2020-08-22T07:21:57Z",
  "labels": [
    "type/bug",
    "sig/coprocessor",
    "severity/moderate"
  ],
  "comments_data": [
    {
      "id": 678080387,
      "user": "glorv",
      "created_at": "2020-08-21T07:03:12Z",
      "body": "@skyzh  @breeswish  PTAL"
    },
    {
      "id": 678082951,
      "user": "skyzh",
      "created_at": "2020-08-21T07:09:50Z",
      "body": "When I was making that PR, I wondered how TiKV ensures identical `logical_rows` could be less than `BATCH_SIZE`. After I added that check, I observed some failure in integration test, and fixed them. It seems that I didn't fix all points that may cause this issue.\r\n\r\nI suggest reverting that PR and investigate further into this issue before adding this check."
    },
    {
      "id": 678084780,
      "user": "skyzh",
      "created_at": "2020-08-21T07:14:46Z",
      "body": "Anyway, the root cause seems to be `logical_rows` could exceed `IDENTICAL_LOGICAL_ROWS: [usize; BATCH_MAX_SIZE]`, and this issue exists before I made that PR where I explicitly checked this condition."
    },
    {
      "id": 678090105,
      "user": "skyzh",
      "created_at": "2020-08-21T07:28:27Z",
      "body": "I've temporarily removed fast-path `LogicalRows` in #8482. Would you please have a try? If it still panics, then this issue should have existed long ago. (And we could revert that PR to make it work as before)"
    },
    {
      "id": 678100735,
      "user": "glorv",
      "created_at": "2020-08-21T07:55:06Z",
      "body": "> I've temporarily removed fast-path `LogicalRows` in #8482. Would you please have a try? If it still panics, then this issue should have existed long ago. (And we could revert that PR to make it work as before)\r\n\r\nYes, after this change, the tests can run successfully, thank you @skyzh."
    }
  ]
}