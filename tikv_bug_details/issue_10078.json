{
  "issue_number": 10078,
  "title": "Panic because the index to committed goes past the last index",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\nv5.0.0 7706b9634bd901c9fe8dbe6a556025abbfd0793d\r\n\r\n### What operating system and CPU are you using?\r\nGot from the perf report\r\n```\r\n# os release : 3.10.107-1-tlinux2_kvm_guest-0052\r\n# arch : x86_64\r\n# nrcpus online : 32\r\n# nrcpus avail : 32\r\n# cpudesc : Intel(R) Xeon(R) Platinum 8255C CPU @ 2.50GHz\r\n\r\nmemory: 128GB\r\n```\r\n\r\n### Steps to reproduce\r\nDeploy a cluster, import data into single table with `replace`. The table includes huge fields.\r\nFound panic when exec `self.raft_group.step(m)?;`\r\n\r\n### What did you expect?\r\nNo FATAL errors and work fine\r\n\r\n### What did happened?\r\n```\r\n20:23:53.422 +08:00] [INFO] [kv.rs:613] [\"batch_raft RPC is called, new gRPC stream established\"]\r\n20:23:53.423 +08:00] [INFO] [raft_client.rs:668] [\"resolve store address ok\"] [addr=11.180.181.63:20160] [store_id=4]\r\n20:23:53.423 +08:00] [INFO] [raft_client.rs:568] [\"server: new connection with tikv endpoint\"] [store_id=4] [addr=11.180.181.63:20160]\r\n20:23:53.423 +08:00] [INFO] [raft_client.rs:668] [\"resolve store address ok\"] [addr=11.180.181.24:20160] [store_id=7]\r\n20:23:53.423 +08:00] [INFO] [raft_client.rs:568] [\"server: new connection with tikv endpoint\"] [store_id=7] [addr=11.180.181.24:20160]\r\n20:23:53.424 +08:00] [INFO] [<unknown>] [\"New connected subchannel at 0x7f670342f330 for subchannel 0x7f6716c4d1c0\"]\r\n20:23:53.424 +08:00] [INFO] [<unknown>] [\"New connected subchannel at 0x7f67a142f630 for subchannel 0x7f6716c4d540\"]\r\n20:23:53.430 +08:00] [INFO] [kv.rs:613] [\"batch_raft RPC is called, new gRPC stream established\"]\r\n20:23:53.431 +08:00] [INFO] [raft_client.rs:668] [\"resolve store address ok\"] [addr=11.180.180.186:20160] [store_id=10]\r\n20:23:53.431 +08:00] [INFO] [raft_client.rs:568] [\"server: new connection with tikv endpoint\"] [store_id=10] [addr=11.180.180.186:20160]\r\n20:23:53.432 +08:00] [INFO] [<unknown>] [\"New connected subchannel at 0x7f67a040e3c0 for subchannel 0x7f6716c4d8c0\"]\r\n20:23:53.834 +08:00] [FATAL] [lib.rs:465] [\"to_commit 18 is out of range [last_index 17], raft_id: 73577035, region_id: 73577032\"] [backtrace=\"stack backtrace:\\n   0: tikv_util::set_panic_hook::{{closure}}\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/tikv_util/src/lib.rs:464\\n   1: std::panicking::rust_panic_with_hook\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/panicking.rs:595\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/panicking.rs:497\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/sys_common/backtrace.rs:141\\n   4: rust_begin_unwind\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/panicking.rs:493\\n   5: std::panicking::begin_panic_fmt\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/panicking.rs:435\\n   6: raft::raft_log::RaftLog<T>::commit_to\\n             at /rust/git/checkouts/raft-rs-42b8049ef2e3af07/91a60ce/src/raft_log.rs:252\\n   7: raft::raft::Raft<T>::handle_heartbeat\\n             at /rust/git/checkouts/raft-rs-42b8049ef2e3af07/91a60ce/src/raft.rs:2291\\n   8: raft::raft::Raft<T>::step_follower\\n             at /rust/git/checkouts/raft-rs-42b8049ef2e3af07/91a60ce/src/raft.rs:2130\\n      raft::raft::Raft<T>::step\\n             at /rust/git/checkouts/raft-rs-42b8049ef2e3af07/91a60ce/src/raft.rs:1440\\n   9: raft::raw_node::RawNode<T>::step\\n             at /rust/git/checkouts/raft-rs-42b8049ef2e3af07/91a60ce/src/raw_node.rs:378\\n      raftstore::store::peer::Peer<EK,ER>::step\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/raftstore/src/store/peer.rs:1138\\n      raftstore::store::fsm::peer::PeerFsmDelegate<EK,ER,T>::on_raft_message\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/raftstore/src/store/fsm/peer.rs:1229\\n  10: raftstore::store::fsm::peer::PeerFsmDelegate<EK,ER,T>::handle_msgs\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/raftstore/src/store/fsm/peer.rs:485\\n  11: <raftstore::store::fsm::store::RaftPoller<EK,ER,T> as batch_system::batch::PollHandler<raftstore::store::fsm::peer::PeerFsm<EK,ER>,raftstore::store::fsm::store::StoreFsm<EK>>>::handle_normal\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/raftstore/src/store/fsm/store.rs:828\\n  12: batch_system::batch::Poller<N,C,Handler>::poll\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/batch-system/src/batch.rs:325\\n  13: batch_system::batch::BatchSystem<N,C>::spawn::{{closure}}\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/batch-system/src/batch.rs:399\\n      std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/sys_common/backtrace.rs:125\\n  14: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/thread/mod.rs:474\\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/panic.rs:322\\n      std::panicking::try::do_call\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/panicking.rs:379\\n      std::panicking::try\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/panicking.rs:343\\n      std::panic::catch_unwind\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/panic.rs:396\\n      std::thread::Builder::spawn_unchecked::{{closure}}\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/thread/mod.rs:473\\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/ops/function.rs:227\\n  15: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/alloc/src/boxed.rs:1484\\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/alloc/src/boxed.rs:1484\\n      std::sys::unix::thread::Thread::new::thread_start\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/sys/unix/thread.rs:71\\n  16: start_thread\\n  17: clone\\n\"] [location=/rust/git/checkouts/raft-rs-42b8049ef2e3af07/91a60ce/src/raft_log.rs:252] [thread_name=raftstore-8-1]\r\n20:23:53.834 +08:00] [FATAL] [lib.rs:465] [\"to_commit 12 is out of range [last_index 11], raft_id: 73825649, region_id: 73825646\"] [backtrace=\"stack backtrace:\\n   0: tikv_util::set_panic_hook::{{closure}}\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/tikv_util/src/lib.rs:464\\n   1: std::panicking::rust_panic_with_hook\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/panicking.rs:595\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/panicking.rs:497\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/sys_common/backtrace.rs:141\\n   4: rust_begin_unwind\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/panicking.rs:493\\n   5: std::panicking::begin_panic_fmt\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/panicking.rs:435\\n   6: raft::raft_log::RaftLog<T>::commit_to\\n             at /rust/git/checkouts/raft-rs-42b8049ef2e3af07/91a60ce/src/raft_log.rs:252\\n   7: raft::raft::Raft<T>::handle_heartbeat\\n             at /rust/git/checkouts/raft-rs-42b8049ef2e3af07/91a60ce/src/raft.rs:2291\\n   8: raft::raft::Raft<T>::step_follower\\n             at /rust/git/checkouts/raft-rs-42b8049ef2e3af07/91a60ce/src/raft.rs:2130\\n      raft::raft::Raft<T>::step\\n             at /rust/git/checkouts/raft-rs-42b8049ef2e3af07/91a60ce/src/raft.rs:1440\\n   9: raft::raw_node::RawNode<T>::step\\n             at /rust/git/checkouts/raft-rs-42b8049ef2e3af07/91a60ce/src/raw_node.rs:378\\n      raftstore::store::peer::Peer<EK,ER>::step\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/raftstore/src/store/peer.rs:1138\\n      raftstore::store::fsm::peer::PeerFsmDelegate<EK,ER,T>::on_raft_message\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/raftstore/src/store/fsm/peer.rs:1229\\n  10: raftstore::store::fsm::peer::PeerFsmDelegate<EK,ER,T>::handle_msgs\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/raftstore/src/store/fsm/peer.rs:485\\n  11: <raftstore::store::fsm::store::RaftPoller<EK,ER,T> as batch_system::batch::PollHandler<raftstore::store::fsm::peer::PeerFsm<EK,ER>,raftstore::store::fsm::store::StoreFsm<EK>>>::handle_normal\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/raftstore/src/store/fsm/store.rs:828\\n  12: batch_system::batch::Poller<N,C,Handler>::poll\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/batch-system/src/batch.rs:325\\n  13: batch_system::batch::BatchSystem<N,C>::spawn::{{closure}}\\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_v5.0.0/tikv/components/batch-system/src/batch.rs:399\\n      std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/sys_common/backtrace.rs:125\\n  14: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/thread/mod.rs:474\\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/panic.rs:322\\n      std::panicking::try::do_call\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/panicking.rs:379\\n      std::panicking::try\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/panicking.rs:343\\n      std::panic::catch_unwind\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/panic.rs:396\\n      std::thread::Builder::spawn_unchecked::{{closure}}\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/std/src/thread/mod.rs:473\\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/core/src/ops/function.rs:227\\n  15: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/alloc/src/boxed.rs:1484\\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35/library/alloc/src/boxed.rs:1484\\n      std::sys::unix::thread::Thread::new::thread_start\\n             at /rustc/bc39d4d9c514e5fdb40a5782e6ca08924f979c35//library/std/src/sys/unix/thread.rs:71\\n  16: start_thread\\n  17: clone\\n\"] [location=/rust/git/checkouts/raft-rs-42b8049ef2e3af07/91a60ce/src/raft_log.rs:252] [thread_name=raftstore-8-0]\r\n20:24:09.153 +08:00] [INFO] [lib.rs:89] [\"Welcome to TiKV\"]\r\n20:24:09.153 +08:00] [INFO] [lib.rs:94] [\"Release Version:   5.0.0\"]\r\n20:24:09.153 +08:00] [INFO] [lib.rs:94] [\"Edition:           Community\"]\r\n20:24:09.153 +08:00] [INFO] [lib.rs:94] [\"Git Commit Hash:   7706b9634bd901c9fe8dbe6a556025abbfd0793d\"]\r\n```\r\n### Attach\r\nMore logs and context are stored in Jira.",
  "state": "closed",
  "created_at": "2021-04-25T06:07:35Z",
  "updated_at": "2021-04-26T10:26:55Z",
  "closed_at": "2021-04-26T10:26:55Z",
  "labels": [
    "type/bug",
    "sig/raft",
    "priority/high"
  ],
  "comments_data": [
    {
      "id": 826716950,
      "user": "gengliqi",
      "created_at": "2021-04-26T10:26:55Z",
      "body": "The panic is caused by data loss so it has nothing to do with raft-rs/raftstore.\r\nIt is probably caused by the user deletes the LOCK of raft db and kv db to start tikv-ctl while TiKV is running, leading to data loss."
    }
  ]
}