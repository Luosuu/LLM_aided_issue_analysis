{
  "issue_number": 15762,
  "title": "[dr-autosync] After down 2 zone, got of total bank account  does not meet expectations",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nv6.5.5\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\nHere is topo of dr-auto-sync cluster, which has 5 replicas.\r\n![image](https://github.com/tikv/tikv/assets/9443637/7bee5b03-3597-4492-945a-5fc9ba700d7d)\r\n\r\nHere is the placement rule.\r\n```\r\nsh-4.2# tiup ctl:v6.5.5 pd -u http://pd1-peer.dr-auto-sync-8c12tikv-tps-3000476-1-615:2379 config placement-rules show\r\nStarting component `ctl`: /root/.tiup/components/ctl/v6.5.5/ctl /root/.tiup/components/ctl/v6.5.5/ctl pd -u http://pd1-peer.dr-auto-sync-8c12tikv-tps-3000476-1-615:2379 config placement-rules show\r\n[\r\n  {\r\n    \"group_id\": \"pd\",\r\n    \"id\": \"learner1\",\r\n    \"start_key\": \"\",\r\n    \"end_key\": \"\",\r\n    \"role\": \"learner\",\r\n    \"is_witness\": false,\r\n    \"count\": 1,\r\n    \"label_constraints\": [\r\n      {\r\n        \"key\": \"zone\",\r\n        \"op\": \"in\",\r\n        \"values\": [\r\n          \"dc2-zone3\"\r\n        ]\r\n      }\r\n    ],\r\n    \"location_labels\": [\r\n      \"dc\",\r\n      \"zone\",\r\n      \"rack\",\r\n      \"host\"\r\n    ],\r\n    \"version\": 1,\r\n    \"create_timestamp\": 1697117291\r\n  },\r\n  {\r\n    \"group_id\": \"pd\",\r\n    \"id\": \"pfollower1\",\r\n    \"start_key\": \"\",\r\n    \"end_key\": \"\",\r\n    \"role\": \"follower\",\r\n    \"is_witness\": false,\r\n    \"count\": 1,\r\n    \"label_constraints\": [\r\n      {\r\n        \"key\": \"zone\",\r\n        \"op\": \"in\",\r\n        \"values\": [\r\n          \"dc2-zone1\"\r\n        ]\r\n      }\r\n    ],\r\n    \"location_labels\": [\r\n      \"dc\",\r\n      \"zone\",\r\n      \"rack\",\r\n      \"host\"\r\n    ],\r\n    \"version\": 1,\r\n    \"create_timestamp\": 1697117291\r\n  },\r\n  {\r\n    \"group_id\": \"pd\",\r\n    \"id\": \"pfollower2\",\r\n    \"start_key\": \"\",\r\n    \"end_key\": \"\",\r\n    \"role\": \"follower\",\r\n    \"is_witness\": false,\r\n    \"count\": 1,\r\n    \"label_constraints\": [\r\n      {\r\n        \"key\": \"zone\",\r\n        \"op\": \"in\",\r\n        \"values\": [\r\n          \"dc2-zone2\"\r\n        ]\r\n      }\r\n    ],\r\n    \"location_labels\": [\r\n      \"dc\",\r\n      \"zone\",\r\n      \"rack\",\r\n      \"host\"\r\n    ],\r\n    \"version\": 1,\r\n    \"create_timestamp\": 1697117291\r\n  },\r\n  {\r\n    \"group_id\": \"pd\",\r\n    \"id\": \"pvoter1\",\r\n    \"start_key\": \"\",\r\n    \"end_key\": \"\",\r\n    \"role\": \"voter\",\r\n    \"is_witness\": false,\r\n    \"count\": 1,\r\n    \"label_constraints\": [\r\n      {\r\n        \"key\": \"zone\",\r\n        \"op\": \"in\",\r\n        \"values\": [\r\n          \"dc1-zone1\"\r\n        ]\r\n      }\r\n    ],\r\n    \"location_labels\": [\r\n      \"dc\",\r\n      \"zone\",\r\n      \"rack\",\r\n      \"host\"\r\n    ],\r\n    \"version\": 1,\r\n    \"create_timestamp\": 1697117291\r\n  },\r\n  {\r\n    \"group_id\": \"pd\",\r\n    \"id\": \"pvoter2\",\r\n    \"start_key\": \"\",\r\n    \"end_key\": \"\",\r\n    \"role\": \"voter\",\r\n    \"is_witness\": false,\r\n    \"count\": 1,\r\n    \"label_constraints\": [\r\n      {\r\n        \"key\": \"zone\",\r\n        \"op\": \"in\",\r\n        \"values\": [\r\n          \"dc1-zone2\"\r\n        ]\r\n      }\r\n    ],\r\n    \"location_labels\": [\r\n      \"dc\",\r\n      \"zone\",\r\n      \"rack\",\r\n      \"host\"\r\n    ],\r\n    \"version\": 1,\r\n    \"create_timestamp\": 1697117291\r\n  },\r\n  {\r\n    \"group_id\": \"pd\",\r\n    \"id\": \"pvoter3\",\r\n    \"start_key\": \"\",\r\n    \"end_key\": \"\",\r\n    \"role\": \"voter\",\r\n    \"is_witness\": false,\r\n    \"count\": 1,\r\n    \"label_constraints\": [\r\n      {\r\n        \"key\": \"zone\",\r\n        \"op\": \"in\",\r\n        \"values\": [\r\n          \"dc1-zone3\"\r\n        ]\r\n      }\r\n    ],\r\n    \"location_labels\": [\r\n      \"dc\",\r\n      \"zone\",\r\n      \"rack\",\r\n      \"host\"\r\n    ],\r\n    \"version\": 1,\r\n    \"create_timestamp\": 1697117291\r\n  }\r\n]\r\n\r\n```\r\n\r\n```\r\n[2023/10/12 21:20:35.415 +08:00] [INFO] [utils.go:175] [\"Inject chaos to workloadNode\"] [workloadName=tikv3]\r\n[2023/10/12 21:20:35.491 +08:00] [INFO] [utils.go:175] [\"Inject chaos to workloadNode\"] [workloadName=tikv5]\r\n[2023/10/12 21:20:35.553 +08:00] [INFO] [utils.go:175] [\"Inject chaos to workloadNode\"] [workloadName=tikv9]\r\n[2023/10/12 21:20:35.612 +08:00] [INFO] [utils.go:175] [\"Inject chaos to workloadNode\"] [workloadName=tikv11]\r\n```\r\n\r\n### What did you expect?\r\nbank2_accounts total should be 2000000000.\r\n\r\n### What did happened?\r\n```\r\n2023/10/12 21:20:36.216 +08:00] [ERROR] [run.go:386] [\"[%s] bank2_accounts total should be %d, but got %d, query uuid is %s\"] [client=bank2] [expected=2000000000] [total=625600000] [uuid=270f0ed6-d191-4a96-a2c4-10278c5b8aed] [stack=\"github.com/pingcap/endless/pkg/workload/bank.(*Bank2Client).Verify\\n\\t/home/project/endless/pkg/workload/bank/run.go:386\\ngithub.com/pingcap/endless/pkg/workload/bank.(*Bank2Client).ContinueVerify\\n\\t/home/project/endless/pkg/workload/bank/run.go:315\\ngithub.com/pingcap/endless/testcase/oltp/tiuptest/drautosync/workload.RunBank.func2\\n\\t/home/project/endless/testcase/oltp/tiuptest/drautosync/workload/run.go:88\\ngithub.com/pingcap/endless/testcase/hatest/utils.GinkgoRecoverWithErr.func1\\n\\t/home/project/endless/testcase/hatest/utils/fastfail.go:22\\ngolang.org/x/sync/errgroup.(*Group).Go.func1\\n\\t/root/go/pkg/mod/golang.org/x/sync@v0.2.0/errgroup/errgroup.go:75\"]\r\n[2023/10/12 21:20:36.470 +08:00] [ERROR] [run.go:407] [\"[%s] bank2_accounts total should be %d, but got %d, query uuid is %s\"] [client=bank2] [expected=2000000000] [total=625600000] [uuid=359cc100-7bda-49ba-8303-e64431c87ba8] [stack=\"github.com/pingcap/endless/pkg/workload/bank.(*Bank2Client).Verify\\n\\t/home/project/endless/pkg/workload/bank/run.go:407\\ngithub.com/pingcap/endless/pkg/workload/bank.(*Bank2Client).ContinueVerify\\n\\t/home/project/endless/pkg/workload/bank/run.go:315\\ngithub.com/pingcap/endless/testcase/oltp/tiuptest/drautosync/workload.RunBank.func2\\n\\t/home/project/endless/testcase/oltp/tiuptest/drautosync/workload/run.go:88\\ngithub.com/pingcap/endless/testcase/hatest/utils.GinkgoRecoverWithErr.func1\\n\\t/home/project/endless/testcase/hatest/utils/fastfail.go:22\\ngolang.org/x/sync/errgroup.(*Group).Go.func1\\n\\t/root/go/pkg/mod/golang.org/x/sync@v0.2.0/errgroup/errgroup.go:75\"]\r\n```\r\n",
  "state": "closed",
  "created_at": "2023-10-13T01:17:32Z",
  "updated_at": "2024-02-18T08:47:28Z",
  "closed_at": "2024-02-18T08:47:28Z",
  "labels": [
    "type/bug",
    "severity/moderate",
    "may-affects-5.3",
    "may-affects-5.4",
    "may-affects-6.1",
    "may-affects-6.5",
    "may-affects-7.1",
    "affects-7.5",
    "affects-7.6"
  ],
  "comments_data": [
    {
      "id": 1760622109,
      "user": "mayjiang0203",
      "created_at": "2023-10-13T01:17:50Z",
      "body": "/severity critical"
    },
    {
      "id": 1951030109,
      "user": "mayjiang0203",
      "created_at": "2024-02-18T08:46:29Z",
      "body": "Can't be reproduced recently, so remove the critical label and close this bug.\r\n/remove-severity critical\r\n/severity moderate"
    },
    {
      "id": 1951031442,
      "user": "ti-chi-bot[bot]",
      "created_at": "2024-02-18T08:47:27Z",
      "body": "@mayjiang0203: These labels are not set on the issue: `severity/critical`.\n\n<details>\n\nIn response to [this](https://github.com/tikv/tikv/issues/15762#issuecomment-1951030109):\n\n>Can't be reproduced recently, so remove the critical label and close this bug.\r\n>/remove-severity critical\r\n>/severity moderate\n\n\nInstructions for interacting with me using PR comments are available [here](https://prow.tidb.net/command-help).  If you have questions or suggestions related to my behavior, please file an issue against the [ti-community-infra/tichi](https://github.com/ti-community-infra/tichi/issues/new?title=Prow%20issue:) repository.\n</details>"
    }
  ]
}