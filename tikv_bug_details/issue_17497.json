{
  "issue_number": 17497,
  "title": "Flaky test tests::failpoints cases::test_replica_stale_read::test_update_apply_index_before_sync_read_state",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n\r\nRef: #17490\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\nLinux, x86_64\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nCI run unit test job, [link](https://do.pingcap.net/jenkins/job/tikv/job/tikv/job/pull_unit_test/1499/)\r\n\r\n### What did you expect?\r\n\r\ntests all passed.\r\n\r\n### What did happened?\r\n\r\n```log\r\n--- TRY 3 STDOUT:        tests::failpoints cases::test_replica_stale_read::test_update_apply_index_before_sync_read_state ---\r\n\r\nrunning 1 test\r\n\r\n--- TRY 3 STDERR:        tests::failpoints cases::test_replica_stale_read::test_update_apply_index_before_sync_read_state ---\r\nthread 'raftstore-1-0::test_update_apply_index_before_sync_read_state' panicked at /rust/registry/src/index.crates.io-6f17d22bba15001f/fail-0.5.1/src/lib.rs:496:25:\r\nfailpoint on_step_read_index_msg panic\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panicking.rs:645:5\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/panicking.rs:72:14\r\n   2: fail::FailPoint::eval\r\n   3: fail::eval\r\n   4: raftstore::store::peer::Peer<EK,ER>::step\r\n   5: raftstore::store::fsm::peer::PeerFsmDelegate<EK,ER,T>::on_raft_message\r\n   6: raftstore::store::fsm::peer::PeerFsmDelegate<EK,ER,T>::handle_msgs\r\n   7: <raftstore::store::fsm::store::RaftPoller<EK,ER,T> as batch_system::batch::PollHandler<raftstore::store::fsm::peer::PeerFsm<EK,ER>,raftstore::store::fsm::store::StoreFsm<EK>>>::handle_normal\r\n   8: batch_system::batch::Poller<N,C,Handler>::poll\r\n   9: batch_system::batch::BatchSystem<N,C>::start_poller::{{closure}}\r\n  10: <std::thread::Builder as tikv_util::sys::thread::StdThreadBuildWrapper>::spawn_wrapper::{{closure}}\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\nthread 'sched-worker-pool::test_update_apply_index_before_sync_read_state-0' panicked at /home/jenkins/tikv-src/src/storage/txn/scheduler.rs:914:25:\r\nundetermined error: Error(Undetermined(\"async write on_applied callback is dropped\")) cid=4, tag=prewrite, process result=Some(PrewriteResult { result: PrewriteResult { locks: [], min_commit_ts: TimeStamp(0), one_pc_commit_ts: TimeStamp(0) } })\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panicking.rs:645:5\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/panicking.rs:72:14\r\n   2: tikv::storage::txn::scheduler::TxnScheduler<E,L>::on_write_finished\r\n   3: tikv::storage::txn::scheduler::TxnScheduler<E,L>::handle_async_write::{{closure}}\r\n   4: tikv::storage::txn::scheduler::TxnScheduler<E,L>::process_write::{{closure}}\r\n   5: tikv::storage::txn::scheduler::TxnScheduler<E,L>::process::{{closure}}::{{closure}}\r\n   6: <resource_metering::InTags<T> as core::future::future::Future>::poll\r\n   7: tikv::storage::txn::scheduler::TxnScheduler<E,L>::process::{{closure}}\r\n   8: tikv::storage::txn::scheduler::TxnScheduler<E,L>::execute::{{closure}}\r\n   9: <futures_util::future::future::map::Map<Fut,F> as core::future::future::Future>::poll\r\n  10: <futures_util::future::future::Map<Fut,F> as core::future::future::Future>::poll\r\n  11: <tracker::tls::TrackedFuture<F> as core::future::future::Future>::poll::{{closure}}\r\n  12: std::thread::local::LocalKey<T>::try_with\r\n  13: std::thread::local::LocalKey<T>::with\r\n  14: <tracker::tls::TrackedFuture<F> as core::future::future::Future>::poll\r\n  15: <futures_util::future::future::map::Map<Fut,F> as core::future::future::Future>::poll\r\n  16: <futures_util::future::future::Map<Fut,F> as core::future::future::Future>::poll\r\n  17: yatp::task::future::RawTask<F>::poll\r\n  18: yatp::task::future::TaskCell::poll\r\n  19: <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\r\n  20: <tikv_util::yatp_pool::YatpPoolRunner<T> as yatp::pool::runner::Runner>::handle\r\n  21: yatp::pool::worker::WorkerThread<T,R>::run\r\n  22: yatp::pool::builder::LazyBuilder<T>::build::{{closure}}\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\nthread 'cases::test_replica_stale_read::test_update_apply_index_before_sync_read_state' panicked at components/test_raftstore/src/util.rs:1074:59:\r\ncalled `Result::unwrap()` on an `Err` value: RpcFailure(RpcStatus { code: 1-CANCELLED, message: \"CANCELLED\", details: [] })\r\nstack backtrace:\r\n   0: rust_begin_unwind\r\n             at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panicking.rs:645:5\r\n   1: core::panicking::panic_fmt\r\n             at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/panicking.rs:72:14\r\n   2: core::result::unwrap_failed\r\n             at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/result.rs:1649:5\r\n   3: core::result::Result<T,E>::unwrap\r\n   4: test_raftstore::util::must_kv_prewrite_with\r\n   5: test_raftstore::util::must_kv_prewrite\r\n   6: test_raftstore::util::must_kv_write\r\n   7: test_raftstore::util::PeerClient::must_kv_write\r\n   8: failpoints::cases::test_replica_stale_read::test_update_apply_index_before_sync_read_state\r\n             at /home/jenkins/tikv-src/tests/failpoints/cases/test_replica_stale_read.rs:240:5\r\n   9: failpoints::cases::test_replica_stale_read::test_update_apply_index_before_sync_read_state::{{closure}}\r\n             at /home/jenkins/tikv-src/tests/failpoints/cases/test_replica_stale_read.rs:204:52\r\n  10: core::ops::function::FnOnce::call_once\r\n             at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/ops/function.rs:250:5\r\n  11: test_util::runner::run_test_with_hook::{{closure}}::{{closure}}\r\n  12: core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n  13: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/alloc/src/boxed.rs:2015:9\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\nthread 'cases::test_replica_stale_read::test_update_apply_index_before_sync_read_state' panicked at /rust/git/checkouts/yatp-e704b73c3ee279b6/793be4d/src/pool.rs:72:26:\r\ncalled `Result::unwrap()` on an `Err` value: Any { .. }\r\nstack backtrace:\r\n   0:     0x55c3f8a15596 - std::backtrace_rs::backtrace::libunwind::trace::h0c778a97139c185f\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/../../backtrace/src/backtrace/libunwind.rs:104:5\r\n   1:     0x55c3f8a15596 - std::backtrace_rs::backtrace::trace_unsynchronized::h49275f7f11d03db8\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/../../backtrace/src/backtrace/mod.rs:66:5\r\n   2:     0x55c3f8a15596 - std::sys_common::backtrace::_print_fmt::hc6d2af0f9113f87c\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/sys_common/backtrace.rs:68:5\r\n   3:     0x55c3f8a15596 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::h4269025391cee804\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/sys_common/backtrace.rs:44:22\r\n   4:     0x55c3f8a471c0 - core::fmt::rt::Argument::fmt::h47e13179bda442d0\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/fmt/rt.rs:142:9\r\n   5:     0x55c3f8a471c0 - core::fmt::write::h0ea06241e192b662\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/fmt/mod.rs:1120:17\r\n   6:     0x55c3f8a1183f - std::io::Write::write_fmt::hada0a89348d2eeaf\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/io/mod.rs:1810:15\r\n   7:     0x55c3f8a15374 - std::sys_common::backtrace::_print::h474b180b0f0cbfaa\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/sys_common/backtrace.rs:47:5\r\n   8:     0x55c3f8a15374 - std::sys_common::backtrace::print::h292cdb95c9f3ed37\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/sys_common/backtrace.rs:34:9\r\n   9:     0x55c3f8a16f67 - std::panicking::default_hook::{{closure}}::h215c742b61103c6e\r\n  10:     0x55c3f8a16cc9 - std::panicking::default_hook::h57e29db39f9afc40\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panicking.rs:292:9\r\n  11:     0x55c3f8a173f8 - std::panicking::rust_panic_with_hook::hdec91a2b4b229c0a\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panicking.rs:779:13\r\n  12:     0x55c3f8a172d2 - std::panicking::begin_panic_handler::{{closure}}::h307c36ea28011ec5\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panicking.rs:657:13\r\n  13:     0x55c3f8a15a96 - std::sys_common::backtrace::__rust_end_short_backtrace::h4a40c8d6f1eb7696\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/sys_common/backtrace.rs:171:18\r\n  14:     0x55c3f8a17030 - rust_begin_unwind\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panicking.rs:645:5\r\n  15:     0x55c3f18699e5 - core::panicking::panic_fmt::h5740899885667996\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/panicking.rs:72:14\r\n  16:     0x55c3f186a023 - core::result::unwrap_failed::hede68b820f4ed9a9\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/result.rs:1649:5\r\n  17:     0x55c3f759acd7 - core::result::Result<T,E>::unwrap::h1668fd11cf5a5acf\r\n  18:     0x55c3f757fdde - yatp::pool::ThreadPool<T>::shutdown::h91ba7b7345ffe611\r\n  19:     0x55c3f7580a7a - <yatp::pool::ThreadPool<T> as core::ops::drop::Drop>::drop::h0ff6c92ce1c1df27\r\n  20:     0x55c3f7526db5 - core::ptr::drop_in_place<yatp::pool::ThreadPool<yatp::task::future::TaskCell>>::h17bd6600f3a535d6\r\n  21:     0x55c3f7526845 - core::ptr::drop_in_place<tikv_util::yatp_pool::future_pool::PoolInner>::h86d2257d3808d4ef\r\n  22:     0x55c3f7538279 - alloc::sync::Arc<T,A>::drop_slow::h98338f3f05c153ca\r\n  23:     0x55c3f7538d40 - <alloc::sync::Arc<T,A> as core::ops::drop::Drop>::drop::h60fc2e6758cbf08d\r\n  24:     0x55c3f75273ba - core::ptr::drop_in_place<alloc::sync::Arc<tikv_util::yatp_pool::future_pool::PoolInner>>::h3d0cf23727f67393\r\n  25:     0x55c3f752689a - core::ptr::drop_in_place<tikv_util::yatp_pool::future_pool::FuturePool>::h642d91b826a82131\r\n  26:     0x55c3f3be9dc6 - core::ptr::drop_in_place<tikv::storage::txn::sched_pool::VanillaQueue>::h9c258efd8c79ef68\r\n  27:     0x55c3f3be7e15 - core::ptr::drop_in_place<tikv::storage::txn::sched_pool::SchedPool>::h4109b57c31c4f163\r\n  28:     0x55c3f3b98180 - core::ptr::drop_in_place<tikv::storage::txn::scheduler::TxnSchedulerInner<tikv::server::lock_manager::LockManager>>::hafda137b4b03ec95\r\n  29:     0x55c3f429e08c - alloc::sync::Arc<T,A>::drop_slow::hd0f3d9411a14040b\r\n  30:     0x55c3f42b5610 - <alloc::sync::Arc<T,A> as core::ops::drop::Drop>::drop::h99f8e6cb41e8d574\r\n  31:     0x55c3f3ba319a - core::ptr::drop_in_place<alloc::sync::Arc<tikv::storage::txn::scheduler::TxnSchedulerInner<tikv::server::lock_manager::LockManager>>>::hc9a8c7e709764cab\r\n  32:     0x55c3f2bdc1ca - core::ptr::drop_in_place<tikv::storage::txn::scheduler::TxnScheduler<tikv::server::raftkv::RaftKv<engine_rocks::engine::RocksEngine,test_raftstore::transport_simulate::SimulateTransport<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>>,tikv::server::lock_manager::LockManager>>::h056b5d2b7fd3e8b4\r\n  33:     0x55c3f2bdbddb - core::ptr::drop_in_place<tikv::storage::Storage<tikv::server::raftkv::RaftKv<engine_rocks::engine::RocksEngine,test_raftstore::transport_simulate::SimulateTransport<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>>,tikv::server::lock_manager::LockManager,api_version::ApiV1>>::h1deec0eab93063dc\r\n  34:     0x55c3f2bddbfb - core::ptr::drop_in_place<tikv::server::service::kv::Service<tikv::server::raftkv::RaftKv<engine_rocks::engine::RocksEngine,test_raftstore::transport_simulate::SimulateTransport<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>>,tikv::server::lock_manager::LockManager,api_version::ApiV1>>::h1f26dae777e24bd6\r\n  35:     0x55c3f2bf5745 - core::ptr::drop_in_place<tikv::server::server::BuilderFactory<tikv::server::service::kv::Service<tikv::server::raftkv::RaftKv<engine_rocks::engine::RocksEngine,test_raftstore::transport_simulate::SimulateTransport<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>>,tikv::server::lock_manager::LockManager,api_version::ApiV1>>>::h409c47a69bed7f3c\r\n  36:     0x55c3f3bf59eb - core::ptr::drop_in_place<alloc::boxed::Box<dyn tikv::server::server::GrpcBuilderFactory>>::h997456734d5c5ecd\r\n  37:     0x55c3f2bda5cd - core::ptr::drop_in_place<tikv::server::server::Server<tikv::server::resolve::PdStoreAddrResolver,tikv::server::raftkv::RaftKv<engine_rocks::engine::RocksEngine,test_raftstore::transport_simulate::SimulateTransport<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>>>>::hae57f4af0180b1d4\r\n  38:     0x55c3f352da02 - <test_raftstore::server::ServerCluster as test_raftstore::cluster::Simulator>::stop_node::hbed10aaf4400de0f\r\n  39:     0x55c3f2dae498 - test_raftstore::cluster::Cluster<T>::stop_node::hbe75593961579483\r\n  40:     0x55c3f2db1ccd - test_raftstore::cluster::Cluster<T>::shutdown::h50ab294c28739c83\r\n  41:     0x55c3f2db26ac - <test_raftstore::cluster::Cluster<T> as core::ops::drop::Drop>::drop::hf00c3dd4e585ac75\r\n  42:     0x55c3f2c6e4f5 - core::ptr::drop_in_place<test_raftstore::cluster::Cluster<test_raftstore::server::ServerCluster>>::h0dacfaa8860f22b6\r\n  43:     0x55c3f1c9c53c - failpoints::cases::test_replica_stale_read::test_update_apply_index_before_sync_read_state::h0cc3b187686a2f95\r\n                               at /home/jenkins/tikv-src/tests/failpoints/cases/test_replica_stale_read.rs:249:1\r\n  44:     0x55c3f1ae81fe - failpoints::cases::test_replica_stale_read::test_update_apply_index_before_sync_read_state::{{closure}}::h14727f5e2413a040\r\n                               at /home/jenkins/tikv-src/tests/failpoints/cases/test_replica_stale_read.rs:204:52\r\n  45:     0x55c3f1ae81fe - core::ops::function::FnOnce::call_once::h6b32cf62913b5192\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/ops/function.rs:250:5\r\n  46:     0x55c3f3b7e32d - test_util::runner::run_test_with_hook::{{closure}}::{{closure}}::ha4110b85053a4743\r\n  47:     0x55c3f3b74455 - core::ops::function::FnOnce::call_once{{vtable.shim}}::h5b75eaadbc32ff37\r\n  48:     0x55c3f5d8830a - <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once::he244563f3f19158a\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/alloc/src/boxed.rs:2015:9\r\n  49:     0x55c3f5d8830a - test::__rust_begin_short_backtrace::h2bee667dfacf6394\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/test/src/lib.rs:627:18\r\n  50:     0x55c3f5d87121 - test::run_test_in_process::{{closure}}::h66e90ca3a6483175\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/test/src/lib.rs:650:60\r\n  51:     0x55c3f5d87121 - <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once::h83ce589675c8e5c4\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/panic/unwind_safe.rs:272:9\r\n  52:     0x55c3f5d87121 - std::panicking::try::do_call::hde5aba0cea3dc698\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panicking.rs:552:40\r\n  53:     0x55c3f5d87121 - std::panicking::try::hcf5248222f90d5ff\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panicking.rs:516:19\r\n  54:     0x55c3f5d87121 - std::panic::catch_unwind::h02e247c10aa761d1\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panic.rs:142:14\r\n  55:     0x55c3f5d87121 - test::run_test_in_process::h253ae08688d44717\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/test/src/lib.rs:650:27\r\n  56:     0x55c3f5d87121 - test::run_test::{{closure}}::h671b269aff1223f2\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/test/src/lib.rs:573:43\r\n  57:     0x55c3f5d4e796 - test::run_test::{{closure}}::h94f25b04859b081c\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/test/src/lib.rs:601:41\r\n  58:     0x55c3f5d4e796 - std::sys_common::backtrace::__rust_begin_short_backtrace::ha37bc9836d969f8c\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/sys_common/backtrace.rs:155:18\r\n  59:     0x55c3f5d537f7 - std::thread::Builder::spawn_unchecked_::{{closure}}::{{closure}}::h5092bed309bb48ca\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/thread/mod.rs:529:17\r\n  60:     0x55c3f5d537f7 - <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once::h77b767f13bf8ae8f\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/panic/unwind_safe.rs:272:9\r\n  61:     0x55c3f5d537f7 - std::panicking::try::do_call::h0fe2a261a5fe4c8b\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panicking.rs:552:40\r\n  62:     0x55c3f5d537f7 - std::panicking::try::h2e1b1d5112b41b7c\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panicking.rs:516:19\r\n  63:     0x55c3f5d537f7 - std::panic::catch_unwind::h9f0da9903043e48c\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/panic.rs:142:14\r\n  64:     0x55c3f5d537f7 - std::thread::Builder::spawn_unchecked_::{{closure}}::h49204260847051e7\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/thread/mod.rs:528:30\r\n  65:     0x55c3f5d537f7 - core::ops::function::FnOnce::call_once{{vtable.shim}}::h1d1eb0c62b32e230\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/core/src/ops/function.rs:250:5\r\n  66:     0x55c3f8a1e375 - <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once::hc049aa84baee5c22\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/alloc/src/boxed.rs:2015:9\r\n  67:     0x55c3f8a1e375 - <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once::hf5846f37b8112bb2\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/alloc/src/boxed.rs:2015:9\r\n  68:     0x55c3f8a1e375 - std::sys::unix::thread::Thread::new::thread_start::hd01330a228cdd35d\r\n                               at /rustc/89e2160c4ca5808657ed55392620ed1dbbce78d1/library/std/src/sys/unix/thread.rs:108:17\r\n  69:     0x7fb0c1697ea5 - start_thread\r\n  70:     0x7fb0c10be9fd - __clone\r\n  71:                0x0 - <unknown>\r\nthread 'advance-ts' panicked at /rust/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.25.3/src/runtime/blocking/shutdown.rs:51:21:\r\nCannot drop a runtime in a context where blocking is not allowed. This happens when a runtime is dropped from within an asynchronous context.\r\nstack backtrace:\r\n   0: std::panicking::begin_panic\r\n   1: tokio::runtime::blocking::shutdown::Receiver::wait\r\n   2: tokio::runtime::blocking::pool::BlockingPool::shutdown\r\n   3: <tokio::runtime::blocking::pool::BlockingPool as core::ops::drop::Drop>::drop\r\n   4: core::ptr::drop_in_place<tokio::runtime::blocking::pool::BlockingPool>\r\n   5: core::ptr::drop_in_place<tokio::runtime::runtime::Runtime>\r\n   6: alloc::sync::Arc<T,A>::drop_slow\r\n   7: <alloc::sync::Arc<T,A> as core::ops::drop::Drop>::drop\r\n   8: core::ptr::drop_in_place<alloc::sync::Arc<tokio::runtime::runtime::Runtime>>\r\n   9: core::ptr::drop_in_place<resolved_ts::scanner::ScannerPool<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine>>\r\n  10: core::ptr::drop_in_place<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>\r\n  11: core::ptr::drop_in_place<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>\r\n  12: core::ptr::drop_in_place<tikv_util::worker::pool::RunnableWrapper<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>>\r\n  13: core::ptr::drop_in_place<tikv_util::worker::pool::Worker::start_with_timer_impl<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>::{{closure}}>\r\n  14: core::ptr::drop_in_place<tracker::tls::TrackedFuture<tikv_util::worker::pool::Worker::start_with_timer_impl<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>::{{closure}}>>\r\n  15: core::ptr::drop_in_place<futures_util::future::future::map::Map<tracker::tls::TrackedFuture<tikv_util::worker::pool::Worker::start_with_timer_impl<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>::{{closure}}>,tikv_util::yatp_pool::future_pool::PoolInner::spawn<tracker::tls::TrackedFuture<tikv_util::worker::pool::Worker::start_with_timer_impl<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>::{{closure}}>>::{{closure}}>>\r\n  16: core::ptr::drop_in_place<futures_util::future::future::Map<tracker::tls::TrackedFuture<tikv_util::worker::pool::Worker::start_with_timer_impl<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>::{{closure}}>,tikv_util::yatp_pool::future_pool::PoolInner::spawn<tracker::tls::TrackedFuture<tikv_util::worker::pool::Worker::start_with_timer_impl<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>::{{closure}}>>::{{closure}}>>\r\n  17: core::ptr::drop_in_place<core::cell::UnsafeCell<futures_util::future::future::Map<tracker::tls::TrackedFuture<tikv_util::worker::pool::Worker::start_with_timer_impl<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>::{{closure}}>,tikv_util::yatp_pool::future_pool::PoolInner::spawn<tracker::tls::TrackedFuture<tikv_util::worker::pool::Worker::start_with_timer_impl<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>::{{closure}}>>::{{closure}}>>>\r\n  18: core::ptr::drop_in_place<yatp::task::future::RawTask<futures_util::future::future::Map<tracker::tls::TrackedFuture<tikv_util::worker::pool::Worker::start_with_timer_impl<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>::{{closure}}>,tikv_util::yatp_pool::future_pool::PoolInner::spawn<tracker::tls::TrackedFuture<tikv_util::worker::pool::Worker::start_with_timer_impl<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>::{{closure}}>>::{{closure}}>>>\r\n  19: core::ptr::drop_in_place<alloc::boxed::Box<yatp::task::future::RawTask<futures_util::future::future::Map<tracker::tls::TrackedFuture<tikv_util::worker::pool::Worker::start_with_timer_impl<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>::{{closure}}>,tikv_util::yatp_pool::future_pool::PoolInner::spawn<tracker::tls::TrackedFuture<tikv_util::worker::pool::Worker::start_with_timer_impl<tikv_util::worker::pool::NoTimeoutRunnableWrapper<resolved_ts::endpoint::Endpoint<raftstore::router::CdcRaftRouter<raftstore::router::ServerRaftStoreRouter<engine_rocks::engine::RocksEngine,raft_log_engine::engine::RaftLogEngine>>,engine_rocks::engine::RocksEngine,raftstore::store::fsm::store::StoreMeta>>>::{{closure}}>>::{{closure}}>>>>\r\n  20: core::mem::drop\r\n  21: yatp::task::future::RawTask<F>::drop\r\n  22: <yatp::task::future::TaskCell as core::ops::drop::Drop>::drop\r\n  23: core::ptr::drop_in_place<yatp::task::future::TaskCell>\r\n  24: core::ptr::drop_in_place<alloc::borrow::Cow<yatp::task::future::TaskCell>>\r\n  25: yatp::task::future::wake_task::{{closure}}\r\n  26: std::thread::local::LocalKey<T>::try_with\r\n  27: std::thread::local::LocalKey<T>::with\r\n  28: yatp::task::future::wake_task\r\n  29: yatp::task::future::wake_impl\r\n  30: yatp::task::future::wake_raw\r\n  31: core::task::wake::Waker::wake\r\n  32: futures_core::task::__internal::atomic_waker::AtomicWaker::wake\r\n  33: futures_channel::mpsc::UnboundedSenderInner<T>::queue_push_and_signal\r\n  34: futures_channel::mpsc::UnboundedSender<T>::do_send_nb\r\n  35: futures_channel::mpsc::UnboundedSender<T>::unbounded_send\r\n  36: tikv_util::worker::pool::Scheduler<T>::schedule_force\r\n  37: tikv_util::worker::pool::Scheduler<T>::schedule\r\n  38: resolved_ts::advance::AdvanceTsWorker::advance_ts_for_regions::{{closure}}\r\n  39: tokio::runtime::task::core::Core<T,S>::poll::{{closure}}\r\n  40: tokio::loom::std::unsafe_cell::UnsafeCell<T>::with_mut\r\n  41: tokio::runtime::task::core::Core<T,S>::poll\r\n  42: tokio::runtime::task::harness::poll_future::{{closure}}\r\n  43: <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n  44: std::panicking::try::do_call\r\n  45: __rust_try\r\n  46: std::panicking::try\r\n  47: std::panic::catch_unwind\r\n  48: tokio::runtime::task::harness::poll_future\r\n  49: tokio::runtime::task::harness::Harness<T,S>::poll_inner\r\n  50: tokio::runtime::task::harness::Harness<T,S>::poll\r\n  51: tokio::runtime::task::raw::poll\r\n  52: tokio::runtime::task::raw::RawTask::poll\r\n  53: tokio::runtime::task::LocalNotified<S>::run\r\n  54: tokio::runtime::scheduler::multi_thread::worker::Context::run_task::{{closure}}\r\n  55: tokio::runtime::scheduler::multi_thread::worker::Context::run_task\r\n  56: tokio::runtime::scheduler::multi_thread::worker::Context::run\r\n  57: tokio::runtime::scheduler::multi_thread::worker::run::{{closure}}\r\n  58: tokio::macros::scoped_tls::ScopedKey<T>::set\r\n  59: tokio::runtime::scheduler::multi_thread::worker::run\r\n  60: tokio::runtime::scheduler::multi_thread::worker::Launch::launch::{{closure}}\r\n  61: <tokio::runtime::blocking::task::BlockingTask<T> as core::future::future::Future>::poll\r\n  62: tokio::runtime::task::core::Core<T,S>::poll::{{closure}}\r\n  63: tokio::loom::std::unsafe_cell::UnsafeCell<T>::with_mut\r\n  64: tokio::runtime::task::core::Core<T,S>::poll\r\n  65: tokio::runtime::task::harness::poll_future::{{closure}}\r\n  66: <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n  67: std::panicking::try::do_call\r\n  68: __rust_try\r\n  69: std::panicking::try\r\n  70: std::panic::catch_unwind\r\n  71: tokio::runtime::task::harness::poll_future\r\n  72: tokio::runtime::task::harness::Harness<T,S>::poll_inner\r\n  73: tokio::runtime::task::harness::Harness<T,S>::poll\r\n  74: tokio::runtime::task::raw::poll\r\n  75: tokio::runtime::task::raw::RawTask::poll\r\n  76: tokio::runtime::task::UnownedTask<S>::run\r\n  77: tokio::runtime::blocking::pool::Task::run\r\n  78: tokio::runtime::blocking::pool::Inner::run\r\n  79: tokio::runtime::blocking::pool::Spawner::spawn_thread::{{closure}}\r\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\r\nthread 'cases::test_replica_stale_read::test_update_apply_index_before_sync_read_state' panicked at library/core/src/panicking.rs:163:5:\r\npanic in a destructor during cleanup\r\nthread caused non-unwinding panic. aborting.\r\n\r\n```\r\n",
  "state": "open",
  "created_at": "2024-09-09T03:52:29Z",
  "updated_at": "2024-11-01T10:02:06Z",
  "closed_at": null,
  "labels": [
    "type/bug",
    "severity/major",
    "component/test",
    "may-affects-5.4",
    "may-affects-6.1",
    "may-affects-6.5",
    "may-affects-7.1",
    "may-affects-7.5",
    "may-affects-8.1",
    "affects-8.5"
  ],
  "comments_data": [
    {
      "id": 2337058528,
      "user": "wuhuizuo",
      "created_at": "2024-09-09T03:52:41Z",
      "body": "/label flaky_test"
    },
    {
      "id": 2337058573,
      "user": "ti-chi-bot[bot]",
      "created_at": "2024-09-09T03:52:43Z",
      "body": "@wuhuizuo: The label(s) `flaky_test` cannot be applied. These labels are supported: `challenge-program, compatibility-breaker, high-performance, hptc, wontfix, do-not-merge/cherry-pick-not-approved, needs-cherry-pick-release-5.4, needs-cherry-pick-release-6.1, needs-cherry-pick-release-6.5, needs-cherry-pick-release-7.1, needs-cherry-pick-release-7.5, needs-cherry-pick-release-8.1, needs-cherry-pick-release-8.3, affects-5.4, affects-6.1, affects-6.5, affects-7.1, affects-7.5, affects-8.1, affects-8.3, may-affects-5.4, may-affects-6.1, may-affects-6.5, may-affects-7.1, may-affects-7.5, may-affects-8.1`.\n\n<details>\n\nIn response to [this](https://github.com/tikv/tikv/issues/17497#issuecomment-2337058528):\n\n>/label flaky_test\n\n\nInstructions for interacting with me using PR comments are available [here](https://prow.tidb.net/command-help).  If you have questions or suggestions related to my behavior, please file an issue against the [ti-community-infra/tichi](https://github.com/ti-community-infra/tichi/issues/new?title=Prow%20issue:) repository.\n</details>"
    },
    {
      "id": 2337164702,
      "user": "wuhuizuo",
      "created_at": "2024-09-09T05:34:48Z",
      "body": "I think it's introduced by https://github.com/tikv/tikv/pull/17359/"
    }
  ]
}