{
  "issue_number": 17260,
  "title": "In-memory Engine: Deadlock during TPCC run",
  "body": "## Bug Report\r\n\r\nThreads that interact with RocksDB are blocked on the RocksDB mutex.\r\n\r\n```\r\nâžœ grep -B1 -E \"Mutex::|__lll_lock_wait|__futex_abstimed_wait_common\" deadlock.log\r\nThread 159 (Thread 0x7f1636b7e640 (LWP 197) \"apply-0\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 135 (Thread 0x7f163bfba640 (LWP 171) \"region-worker-0\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 134 (Thread 0x7f163c1bb640 (LWP 170) \"cleanup-worker-\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n--\r\nThread 78 (Thread 0x7f16431f3640 (LWP 114) \"sched-worker-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 77 (Thread 0x7f16433f4640 (LWP 113) \"sched-worker-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 76 (Thread 0x7f16435f5640 (LWP 112) \"sched-worker-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 75 (Thread 0x7f16437f6640 (LWP 111) \"sched-worker-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 74 (Thread 0x7f16439f7640 (LWP 110) \"sched-worker-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 73 (Thread 0x7f1643bf8640 (LWP 109) \"sched-worker-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 72 (Thread 0x7f1643df9640 (LWP 108) \"sched-worker-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 71 (Thread 0x7f1643ffa640 (LWP 107) \"sched-worker-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 61 (Thread 0x7f16513ff640 (LWP 95) \"unified-read-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 60 (Thread 0x7f16523ff640 (LWP 94) \"unified-read-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 59 (Thread 0x7f16533ff640 (LWP 93) \"unified-read-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 58 (Thread 0x7f16543ff640 (LWP 92) \"unified-read-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 57 (Thread 0x7f16553ff640 (LWP 91) \"unified-read-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 56 (Thread 0x7f16563ff640 (LWP 90) \"unified-read-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 55 (Thread 0x7f16573ff640 (LWP 89) \"unified-read-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 54 (Thread 0x7f16583ff640 (LWP 88) \"unified-read-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 53 (Thread 0x7f16593ff640 (LWP 87) \"unified-read-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 52 (Thread 0x7f165a3f7640 (LWP 86) \"unified-read-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 51 (Thread 0x7f165adf8640 (LWP 85) \"unified-read-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 50 (Thread 0x7f16677ff640 (LWP 84) \"unified-read-po\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 49 (Thread 0x7f1669bff640 (LWP 83) \"pd-worker-0\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 38 (Thread 0x7f16665fb640 (LWP 71) \"tikv-server\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 37 (Thread 0x7f16729ff640 (LWP 53) \"rocksdb:high\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n--\r\nThread 36 (Thread 0x7f16737ff640 (LWP 52) \"rocksdb:high\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n--\r\nThread 35 (Thread 0x7f16745ff640 (LWP 51) \"rocksdb:high\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n--\r\nThread 34 (Thread 0x7f16753ff640 (LWP 50) \"rocksdb:low\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n--\r\nThread 33 (Thread 0x7f16761ff640 (LWP 49) \"rocksdb:low\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 32 (Thread 0x7f1676f35640 (LWP 48) \"rocksdb:low\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n--\r\nThread 31 (Thread 0x7f1677736640 (LWP 47) \"rocksdb:low\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n--\r\nThread 30 (Thread 0x7f1677f37640 (LWP 46) \"rocksdb:low\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n--\r\nThread 29 (Thread 0x7f1678738640 (LWP 45) \"rocksdb:low\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n--\r\nThread 23 (Thread 0x7f16b66f9640 (LWP 35) \"background-1\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 22 (Thread 0x7f16b68fa640 (LWP 34) \"background-0\"):\r\n#0  0x00007f17514af560 in __lll_lock_wait () from /lib64/libc.so.6\r\n#1  0x00007f17514b5c22 in pthread_mutex_lock@@GLIBC_2.2.5 () from /lib64/libc.so.6\r\n#2  0x0000564d365d08e9 in rocksdb::port::Mutex::Lock (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/port/port_posix.cc:82\r\n#3  0x0000564d364d0aa5 in rocksdb::InstrumentedMutex::LockInternal (this=<optimized out>) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:38\r\n#4  0x0000564d364d0b65 in rocksdb::InstrumentedMutex::Lock (this=this@entry=0x7f1750e4f310) at /home/stn/.cargo/git/checkouts/rust-rocksdb-a9a28e74c6ead8ef/224bed6/librocksdb_sys/rocksdb/monitoring/instrumented_mutex.cc:31\r\n--\r\nThread 9 (Thread 0x7f174cffc640 (LWP 20) \"jemalloc_bg_thd\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n--\r\nThread 8 (Thread 0x7f174d7fd640 (LWP 19) \"jemalloc_bg_thd\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n--\r\nThread 7 (Thread 0x7f174dffe640 (LWP 18) \"jemalloc_bg_thd\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n--\r\nThread 6 (Thread 0x7f174e9ff640 (LWP 17) \"jemalloc_bg_thd\"):\r\n#0  0x00007f17514af39a in __futex_abstimed_wait_common () from /lib64/libc.so.6\r\n```\r\n\r\n[deadlock.log](https://github.com/user-attachments/files/16172472/deadlock.log)\r\n\r\n### What version of TiKV are you using?\r\n\r\nNightly 2024-07-10, built on 4013c0963\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nTiKV Config\r\n\r\n```toml\r\n[range-cache-engine]\r\n  enabled = true\r\n  hard-limit-threshold = \"8GB\"\r\n  soft-limit-threshold = \"5GB\"\r\n```\r\n\r\nTPCC commands\r\n\r\n```bash\r\n/root/.tiup/components/bench/v1.12.0/go-tpc \\\r\n    tpcc prepare \\\r\n    -H $HOST -P $PORT \\\r\n    -D tpcc100 --warehouses 100 -T 1000\r\n```\r\n\r\n### What did you expect?\r\n\r\nNo deadlock.\r\n",
  "state": "closed",
  "created_at": "2024-07-11T06:41:03Z",
  "updated_at": "2024-09-04T06:52:28Z",
  "closed_at": "2024-09-04T06:52:27Z",
  "labels": [
    "type/bug"
  ],
  "comments_data": [
    {
      "id": 2222206998,
      "user": "overvenus",
      "created_at": "2024-07-11T07:14:53Z",
      "body": "### Deadlock Analysis\r\n\r\nThe deadlock involves two mutexes and three threads:\r\n\r\n**Mutexes:**\r\n- RocksDB Mutex\r\n- RangeCacheMemoryEngine RwLock\r\n\r\n**Threads:**\r\n- cleanup-worker\r\n- apply-0\r\n- apply-1\r\n\r\n**Deadlock Sequence:**\r\n\r\n1. **cleanup-worker Thread:**\r\n   - Holds the RocksDB Mutex.\r\n   - Blocked at `WaitForPendingWrites`.\r\n\r\n2. **apply-1 Thread:**\r\n   - `WaitForPendingWrites` is blocked because it waits for the apply-1 thread's `HybridEngineWriteBatch::write_callback_opt`.\r\n   - `HybridEngineWriteBatch::write_callback_opt` is blocked at RangeCacheMemoryEngine's `RwLock::upgradable_read`.\r\n\r\n3. **RangeCacheMemoryEngine RwLock:**\r\n   - `RwLock::upgradable_read` is blocked because the write lock has been acquired by the apply-0 thread.\r\n\r\n4. **apply-0 Thread:**\r\n   - Holds the write lock of RangeCacheMemoryEngine RwLock.\r\n   - Blocked at `HybridEngine::prepare_for`, which tries to get a RocksDB snapshot and is blocked by the RocksDB Mutex.\r\n\r\n**Summary:**\r\n- The **cleanup-worker** thread holds the **RocksDB Mutex** and waits for **apply-1**.\r\n- The **apply-1** thread is blocked at **RangeCacheMemoryEngine RwLock** due to **apply-0** holding the write lock.\r\n- The **apply-0** thread holds the write lock and is blocked by the **RocksDB Mutex** held by the **cleanup-worker**.\r\n\r\nThis cycle creates a deadlock where each thread is waiting on a resource held by another thread."
    },
    {
      "id": 2328056253,
      "user": "overvenus",
      "created_at": "2024-09-04T06:52:27Z",
      "body": "After 40 hours of testing with #17296 (rebased to master), no deadlocks have occurred. We believe the issue has been resolved by https://github.com/tikv/tikv/pull/17331  "
    }
  ]
}