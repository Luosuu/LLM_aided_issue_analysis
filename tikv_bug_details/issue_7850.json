{
  "issue_number": 7850,
  "title": "AWS br backup failed when collation is open ",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n```\r\nTiKV \r\nRelease Version:   4.1.0-alpha\r\nGit Commit Hash:   957655cacab1bd48100bf0b252fa93a9758848dc\r\nGit Commit Branch: master\r\nUTC Build Time:    2020-05-08 02:04:59\r\nRust Version:      rustc 1.44.0-nightly (b2e36e6c2 2020-04-22)\r\nEnable Features:   jemalloc portable sse protobuf-codec\r\nProfile:           dist_release\r\n```\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\nrun in container\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\n- open collation\r\n```\r\nupdate mysql.tidb set VARIABLE_VALUE=\"True\" Where VARIABLE_NAME=\"new_collation_enabled\";\r\n```\r\n\r\n- deploy a cluster \r\n\r\n- restore data from aws bucket `dbaas-hibernate` prefix `test18`\r\n\r\n- backup data from this cluster with BR, and report error\r\n\r\n### What did you expect?\r\nbackup success\r\n### What did happened?\r\nfull backup failed and log is send to @kennytm \r\nbackup failed log is showed below \r\n```\r\nI0515 06:39:57.934050       1 backup.go:92] [2020/05/15 06:39:57.933 +00:00] [INFO] [progress.go:102] [\"Full backup\"] [progress=21.56%!](MISSING)\r\nI0515 06:39:58.134068       1 backup.go:92] [2020/05/15 06:39:58.133 +00:00] [INFO] [progress.go:102] [\"Full backup\"] [progress=21.56%!](MISSING)\r\nI0515 06:39:58.305924       1 backup.go:92] [2020/05/15 06:39:58.305 +00:00] [INFO] [client.go:740] [\"range backuped\"] [StartKey=\"dIAAAAAAAABGX3KAAAAAKEF4KQ==\"] [EndKey=\"dIAAAAAAAABGX3KAAAAAKEOx+g==\"]\r\nI0515 06:39:58.306002       1 backup.go:92] [2020/05/15 06:39:58.305 +00:00] [INFO] [client.go:740] [\"range backuped\"] [StartKey=\"dIAAAAAAAABGX3KAAAAAKGvm5g==\"] [EndKey=\"dIAAAAAAAABGX3KAAAAAKG4gsg==\"]\r\nI0515 06:39:58.306039       1 backup.go:92] [2020/05/15 06:39:58.305 +00:00] [ERROR] [push.go:111] [\"backup occur unknown error\"] [error=\"Io(Custom { kind: Other, error: \\\"failed to put object Error during dispatch: connection error: Connection timed out (os error 110)\\\" })\"] [stack=\"github.com/pingcap/log.Error\\n\\t/go/pkg/mod/github.com/pingcap/log@v0.0.0-20200117041106-d28c14d3b1cd/global.go:42\\ngithub.com/pingcap/br/pkg/backup.(*pushDown).pushBackup\\n\\t/home/jenkins/agent/workspace/build_br_multi_branch_v4.0.0-rc/go/src/github.com/pingcap/br/pkg/backup/push.go:111\\ngithub.com/pingcap/br/pkg/backup.(*Client).BackupRange\\n\\t/home/jenkins/agent/workspace/build_br_multi_branch_v4.0.0-rc/go/src/github.com/pingcap/br/pkg/backup/client.go:424\\ngithub.com/pingcap/br/pkg/backup.(*Client).BackupRanges.func2\\n\\t/home/jenkins/agent/workspace/build_br_multi_branch_v4.0.0-rc/go/src/github.com/pingcap/br/pkg/backup/client.go:337\"]\r\nI0515 06:39:58.306109       1 backup.go:92] [2020/05/15 06:39:58.306 +00:00] [INFO] [client.go:394] [\"backup range finished\"] [take=16m5.794334246s]\r\nI0515 06:39:58.306146       1 backup.go:92] [2020/05/15 06:39:58.306 +00:00] [INFO] [client.go:329] [\"Backup Ranges\"] [take=19m18.172269236s]\r\nI0515 06:39:58.311061       1 backup.go:92] [2020/05/15 06:39:58.310 +00:00] [INFO] [ddl.go:407] [\"[ddl] DDL closed\"] [ID=e715ece9-efae-48ef-9d63-ad7523d004d9] [\"take time\"=4.600585ms]\r\nI0515 06:39:58.311085       1 backup.go:92] [2020/05/15 06:39:58.310 +00:00] [INFO] [ddl.go:301] [\"[ddl] stop DDL\"] [ID=e715ece9-efae-48ef-9d63-ad7523d004d9]\r\nI0515 06:39:58.317267       1 backup.go:92] [2020/05/15 06:39:58.317 +00:00] [INFO] [domain.go:607] [\"domain closed\"] [\"take time\"=11.020482ms]\r\nI0515 06:39:58.318562       1 backup.go:92] [2020/05/15 06:39:58.318 +00:00] [INFO] [collector.go:180] [\"Full backup Failed summary : total backup ranges: 13, total success: 12, total failed: 1\"] [\"backup total regions\"=8112] [unitName=\"range start:7480000000000000465f720000000000000000 end:7480000000000000465f72ffffffffffffffff00\"] [error=\"msg:\\\"Io(Custom { kind: Other, error: \\\\\\\"failed to put object Error during dispatch: connection error: Connection timed out (os error 110)\\\\\\\" })\\\" \"] [errorVerbose=\"msg:\\\"Io(Custom { kind: Other, error: \\\\\\\"failed to put object Error during dispatch: connection error: Connection timed out (os error 110)\\\\\\\" })\\\" \\ngithub.com/pingcap/br/pkg/backup.(*pushDown).pushBackup\\n\\t/home/jenkins/agent/workspace/build_br_multi_branch_v4.0.0-rc/go/src/github.com/pingcap/br/pkg/backup/push.go:113\\ngithub.com/pingcap/br/pkg/backup.(*Client).BackupRange\\n\\t/home/jenkins/agent/workspace/build_br_multi_branch_v4.0.0-rc/go/src/github.com/pingcap/br/pkg/backup/client.go:424\\ngithub.com/pingcap/br/pkg/backup.(*Client).BackupRanges.func2\\n\\t/home/jenkins/agent/workspace/build_br_multi_branch_v4.0.0-rc/go/src/github.com/pingcap/br/pkg/backup/client.go:337\\nruntime.goexit\\n\\t/usr/local/go/src/runtime/asm_amd64.s:1357\"]\r\nI0515 06:39:58.320546       1 backup.go:92] \r\nI0515 06:39:58.320571       1 backup.go:99] Error: msg:\"Io(Custom { kind: Other, error: \\\"failed to put object Error during dispatch: connection error: Connection timed out (os error 110)\\\" })\" \r\nI0515 06:39:58.332913       1 manager.go:207] reset cluster tidb1261122416541700096/collation-backup-3 tikv_gc_life_time to 10m0s success\r\nE0515 06:39:58.332940       1 manager.go:210] backup cluster tidb1261122416541700096/collation-backup-3 data failed, err: cluster tidb1261122416541700096/collation-backup-3, wait pipe message failed, errMsg [2020/05/15 06:39:58.305 +00:00] [ERROR] [push.go:111] [\"backup occur unknown error\"] [error=\"Io(Custom { kind: Other, error: \\\"failed to put object Error during dispatch: connection error: Connection timed out (os error 110)\\\" })\"] [stack=\"github.com/pingcap/log.Error\\n\\t/go/pkg/mod/github.com/pingcap/log@v0.0.0-20200117041106-d28c14d3b1cd/global.go:42\\ngithub.com/pingcap/br/pkg/backup.(*pushDown).pushBackup\\n\\t/home/jenkins/agent/workspace/build_br_multi_branch_v4.0.0-rc/go/src/github.com/pingcap/br/pkg/backup/push.go:111\\ngithub.com/pingcap/br/pkg/backup.(*Client).BackupRange\\n\\t/home/jenkins/agent/workspace/build_br_multi_branch_v4.0.0-rc/go/src/github.com/pingcap/br/pkg/backup/client.go:424\\ngithub.com/pingcap/br/pkg/backup.(*Client).BackupRanges.func2\\n\\t/home/jenkins/agent/workspace/build_br_multi_branch_v4.0.0-rc/go/src/github.com/pingcap/br/pkg/backup/client.go:337\"]\r\nError: msg:\"Io(Custom { kind: Other, error: \\\"failed to put object Error during dispatch: connection error: Connection timed out (os error 110)\\\" })\" \r\n, err: exit status 1\r\n```\r\n\r\ntikv failed log at this point is like below, tikv1 \r\n```\r\n[2020/05/15 06:24:19.898 +00:00] [WARN] [util.rs:194] [\"updating PD client done\"] [spend=64.980358ms]\r\n[2020/05/15 06:39:58.470 +00:00] [ERROR] [endpoint.rs:284] [\"backup save file failed\"] [error=\"Io(Custom { kind: Other, error: \\\"failed to put object Error during dispatch: connection error: Network is unreachable (os error 101)\\\" })\"]\r\n[2020/05/15 06:39:58.471 +00:00] [ERROR] [endpoint.rs:284] [\"backup save file failed\"] [error=\"Io(Custom { kind: Other, error: \\\"failed to put object Error during dispatch: connection error: Connection timed out (os error 110)\\\" })\"]\r\n[2020/05/15 06:39:58.471 +00:00] [ERROR] [endpoint.rs:669] [\"backup region failed\"] [error=\"Io(Custom { kind: Other, error: \\\"failed to put object Error during dispatch: connection error: Connection timed out (os error 110)\\\" })\"] [end_key=] [start_key=] [region=\"id: 33736 start_key: 7480000000000000FF465F728000000028FF4178290000000000FA end_key: 7480000000000000FF465F728000000028FF43B1FA0000000000FA region_epoch { conf_ver: 5 version: 391 } peers { id: 33737 store_id: 1 } peers { id: 33738 store_id: 4 } peers { id: 33739 store_id: 5 }\"]\r\n[2020/05/15 06:39:58.471 +00:00] [ERROR] [endpoint.rs:669] [\"backup region failed\"] [error=\"Io(Custom { kind: Other, error: \\\"failed to put object Error during dispatch: connection error: Network is unreachable (os error 101)\\\" })\"] [end_key=] [start_key=] [region=\"id: 33768 start_key: 7480000000000000FF465F728000000028FF6BE6E60000000000FA end_key: 7480000000000000FF465F728000000028FF6E20B20000000000FA region_epoch { conf_ver: 5 version: 389 } peers { id: 33769 store_id: 1 } peers { id: 33770 store_id: 4 } peers { id: 33771 store_id: 5 }\"]\r\n[2020/05/15 06:39:58.472 +00:00] [ERROR] [service.rs:86] [\"backup canceled\"] [error=RemoteStopped]\r\n[2020/05/15 06:39:58.480 +00:00] [INFO] [endpoint.rs:686] [\"backup finished\"] [summary=\"Statistics { lock: CfStatistics { processed: 0, get: 0, next: 0, prev: 0, seek: 391, seek_for_prev: 0, over_seek_bound: 0, flow_stats: FlowStatistics { read_keys: 0, read_bytes: 0 } }, write: CfStatistics { processed: 56367644, get: 0, next: 56367644, prev: 0, seek: 391, seek_for_prev: 0, over_seek_bound: 0, flow_stats: FlowStatistics { read_keys: 56367644, read_bytes: 2311073404 } }, data: CfStatistics { processed: 56367644, get: 0, next: 56367253, prev: 0, seek: 391, seek_for_prev: 0, over_seek_bound: 0, flow_stats: FlowStatistics { read_keys: 56367644, read_bytes: 36468667747 } } }\"] [take=965.953601557s]\r\n[2020/05/15 06:39:58.480 +00:00] [WARN] [mod.rs:86] [\"handle task BackupTask { start_ts: TimeStamp(0), end_ts: TimeStamp(416684085045100545), start_key: \\\"7480000000000000465F720000000000000000\\\", end_key: \\\"7480000000000000465F72FFFFFFFFFFFFFFFF00\\\", is_raw_kv: false, cf: \\\"default\\\" }\"] [takes=965955]\r\n```",
  "state": "closed",
  "created_at": "2020-05-15T07:05:15Z",
  "updated_at": "2020-05-29T06:51:37Z",
  "closed_at": "2020-05-29T06:51:37Z",
  "labels": [
    "type/bug",
    "component/backup-restore",
    "sig/migrate"
  ],
  "comments_data": [
    {
      "id": 630657288,
      "user": "shuijing198799",
      "created_at": "2020-05-19T08:06:08Z",
      "body": "https://github.com/tikv/tikv/issues/7846 It seem the same reason with this ISSUE"
    }
  ]
}