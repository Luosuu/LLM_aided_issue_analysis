{
  "issue_number": 4048,
  "title": "tikv-server segfault with rocksdb:low2",
  "body": "## Bug Report\r\n\r\n**What version of Rust are you using?**\r\n`rustc 1.29.0-nightly (4f3c7a472 2018-07-17)`\r\n\r\n**GCC version used**\r\n```\r\nUsing built-in specs.\r\nCOLLECT_GCC=gcc\r\nCOLLECT_LTO_WRAPPER=/opt/rh/devtoolset-6/root/usr/libexec/gcc/x86_64-redhat-linux/6.3.1/lto-wrapper\r\nTarget: x86_64-redhat-linux\r\nConfigured with: ../configure --enable-bootstrap --enable-languages=c,c++,fortran,lto --prefix=/opt/rh/devtoolset-6/root/usr --mandir=/opt/rh/devtoolset-6/root/usr/share/man --infodir=/opt/rh/devtoolset-6/root/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --enable-shared --enable-threads=posix --enable-checking=release --enable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --enable-plugin --with-linker-hash-style=gnu --enable-initfini-array --disable-libgcj --with-default-libstdcxx-abi=gcc4-compatible --with-isl=/builddir/build/BUILD/gcc-6.3.1-20170216/obj-x86_64-redhat-linux/isl-install --enable-libmpx --with-mpc=/builddir/build/BUILD/gcc-6.3.1-20170216/obj-x86_64-redhat-linux/mpc-install --with-tune=generic --with-arch_32=i686 --build=x86_64-redhat-linux\r\nThread model: posix\r\ngcc version 6.3.1 20170216 (Red Hat 6.3.1-3) (GCC) \r\n```\r\n\r\n**What operating system and CPU are you using?**\r\n```\r\nprocessor\t: 0\r\nvendor_id\t: GenuineIntel\r\ncpu family\t: 6\r\nmodel\t\t: 45\r\nmodel name\t: Intel(R) Xeon(R) CPU E5-2603 0 @ 1.80GHz\r\nstepping\t: 7\r\nmicrocode\t: 0x714\r\ncpu MHz\t\t: 1799.670\r\ncache size\t: 10240 KB\r\nphysical id\t: 0\r\nsiblings\t: 4\r\ncore id\t\t: 0\r\ncpu cores\t: 4\r\napicid\t\t: 0\r\ninitial apicid\t: 0\r\nfpu\t\t: yes\r\nfpu_exception\t: yes\r\ncpuid level\t: 13\r\nwp\t\t: yes\r\nflags\t\t: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic popcnt tsc_deadline_timer aes xsave avx lahf_lm epb ssbd ibrs ibpb stibp tpr_shadow vnmi flexpriority ept vpid xsaveopt dtherm arat pln pts spec_ctrl intel_stibp flush_l1d\r\nbogomips\t: 3599.98\r\nclflush size\t: 64\r\ncache_alignment\t: 64\r\naddress sizes\t: 46 bits physical, 48 bits virtual\r\npower management:\r\n```\r\n\r\n**core dump** \r\n\r\ndmesg shows:\r\n\r\n```\r\n[2803669.531251] rocksdb:low2[37324]: segfault at 7f715622fa87 ip 0000562d8a256b51 sp 00007f70737fa870 error 4 in tikv-server[562d890e5000+1637000]\r\n```\r\n\r\nstacktrace:\r\n\r\n```\r\n$ gdb tikv-server  core.37312 \r\nGNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-114.el7\r\nCopyright (C) 2013 Free Software Foundation, Inc.\r\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\r\nThis is free software: you are free to change and redistribute it.\r\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\r\nand \"show warranty\" for details.\r\nThis GDB was configured as \"x86_64-redhat-linux-gnu\".\r\nFor bug reporting instructions, please see:\r\n<http://www.gnu.org/software/gdb/bugs/>...\r\nReading symbols from /home/tidb/tikv-server...done.\r\n[New LWP 37324]\r\n[New LWP 37334]\r\n[New LWP 37330]\r\n[New LWP 37329]\r\n[New LWP 37326]\r\n[New LWP 37332]\r\n[New LWP 37352]\r\n[New LWP 37333]\r\n[New LWP 37349]\r\n[New LWP 37342]\r\n[New LWP 37335]\r\n[New LWP 37353]\r\n[New LWP 37336]\r\n[New LWP 37350]\r\n[New LWP 37339]\r\n[New LWP 37361]\r\n[New LWP 37338]\r\n[New LWP 37348]\r\n[New LWP 37331]\r\n[New LWP 37347]\r\n[New LWP 37370]\r\n[New LWP 37346]\r\n[New LWP 37327]\r\n[New LWP 37379]\r\n[New LWP 37325]\r\n[New LWP 37337]\r\n[New LWP 37399]\r\n[New LWP 37344]\r\n[New LWP 37341]\r\n[New LWP 37360]\r\n[New LWP 37343]\r\n[New LWP 37356]\r\n[New LWP 37409]\r\n[New LWP 37340]\r\n[New LWP 37367]\r\n[New LWP 37328]\r\n[New LWP 37358]\r\n[New LWP 38228]\r\n[New LWP 37363]\r\n[New LWP 37354]\r\n[New LWP 37381]\r\n[New LWP 37374]\r\n[New LWP 37359]\r\n[New LWP 37364]\r\n[New LWP 37345]\r\n[New LWP 37321]\r\n[New LWP 37368]\r\n[New LWP 37373]\r\n[New LWP 37382]\r\n[New LWP 37320]\r\n[New LWP 37357]\r\n[New LWP 37314]\r\n[New LWP 37351]\r\n[New LWP 37383]\r\n[New LWP 37384]\r\n[New LWP 37398]\r\n[New LWP 37362]\r\n[New LWP 37319]\r\n[New LWP 37323]\r\n[New LWP 37404]\r\n[New LWP 37385]\r\n[New LWP 37407]\r\n[New LWP 37396]\r\n[New LWP 37412]\r\n[New LWP 37402]\r\n[New LWP 37395]\r\n[New LWP 37410]\r\n[New LWP 37376]\r\n[New LWP 37322]\r\n[New LWP 37394]\r\n[New LWP 37400]\r\n[New LWP 37403]\r\n[New LWP 37401]\r\n[New LWP 37386]\r\n[New LWP 37416]\r\n[New LWP 37392]\r\n[New LWP 37421]\r\n[New LWP 37391]\r\n[New LWP 37316]\r\n[New LWP 37369]\r\n[New LWP 37417]\r\n[New LWP 37380]\r\n[New LWP 37423]\r\n[New LWP 37389]\r\n[New LWP 37419]\r\n[New LWP 37406]\r\n[New LWP 37312]\r\n[New LWP 37375]\r\n[New LWP 37371]\r\n[New LWP 37388]\r\n[New LWP 37317]\r\n[New LWP 37387]\r\n[New LWP 37420]\r\n[New LWP 37318]\r\n[New LWP 37378]\r\n[New LWP 37415]\r\n[New LWP 37408]\r\n[New LWP 37418]\r\n[New LWP 37390]\r\n[New LWP 37355]\r\n[New LWP 37413]\r\n[New LWP 37393]\r\n[New LWP 37411]\r\n[New LWP 37365]\r\n[New LWP 37414]\r\n[New LWP 37372]\r\n[New LWP 37377]\r\n[New LWP 37397]\r\n[New LWP 37366]\r\n[New LWP 37405]\r\n[Thread debugging using libthread_db enabled]\r\nUsing host libthread_db library \"/lib64/libthread_db.so.1\".\r\nCore was generated by `tikv-server --log-level info --pd=192.168.20.80:2379,192.168.20.81:2379,192.168'.\r\nProgram terminated with signal 11, Segmentation fault.\r\n#0  LZ4_copy8 (src=0x7f715622fa87, dst=0x7f705622fa8f) at liblz4/lib/lz4.c:252\r\n252\tliblz4/lib/lz4.c: No such file or directory.\r\nwarning: Missing auto-load scripts referenced in section .debug_gdb_scripts\r\nof file /home/tidb/tikv-server\r\nUse `info auto-load python [REGEXP]' to list them.\r\nMissing separate debuginfos, use: debuginfo-install glibc-2.17-260.el7.x86_64 libgcc-4.8.5-36.el7.x86_64\r\n(gdb) bt\r\n#0  LZ4_copy8 (src=0x7f715622fa87, dst=0x7f705622fa8f) at liblz4/lib/lz4.c:252\r\n#1  LZ4_decompress_generic (dictSize=0, dictStart=0x0, lowPrefix=<optimized out>, dict=2, targetOutputSize=0, partialDecoding=0, endOnInput=1, outputSize=<optimized out>, inputSize=<optimized out>, dest=<optimized out>, source=0x7f6fdfedc003 \"q\")\r\n    at liblz4/lib/lz4.c:1252\r\n#2  LZ4_decompress_safe_continue (LZ4_streamDecode=0x7f6dea5ce9a0, source=0x7f6fdfedc003 \"q\", dest=<optimized out>, compressedSize=<optimized out>, maxOutputSize=<optimized out>) at liblz4/lib/lz4.c:1340\r\n#3  0x0000562d8a1ece22 in rocksdb::UncompressBlockContentsForCompressionType(rocksdb::UncompressionContext const&, char const*, unsigned long, rocksdb::BlockContents*, unsigned int, rocksdb::ImmutableCFOptions const&) ()\r\n#4  0x0000562d8a1ed374 in rocksdb::UncompressBlockContents(rocksdb::UncompressionContext const&, char const*, unsigned long, rocksdb::BlockContents*, unsigned int, rocksdb::ImmutableCFOptions const&) ()\r\n#5  0x0000562d8a1e8811 in rocksdb::BlockFetcher::ReadBlockContents() ()\r\n#6  0x0000562d8a1d6b3c in rocksdb::(anonymous namespace)::ReadBlockFromFile(rocksdb::RandomAccessFileReader*, rocksdb::FilePrefetchBuffer*, rocksdb::Footer const&, rocksdb::ReadOptions const&, rocksdb::BlockHandle const&, std::unique_ptr<rocksdb::Block, std::default_delete<rocksdb::Block> >*, rocksdb::ImmutableCFOptions const&, bool, rocksdb::Slice const&, rocksdb::PersistentCacheOptions const&, unsigned long, unsigned long, bool) ()\r\n#7  0x0000562d8a1dfd71 in rocksdb::DataBlockIter* rocksdb::BlockBasedTable::NewDataBlockIterator<rocksdb::DataBlockIter>(rocksdb::BlockBasedTable::Rep*, rocksdb::ReadOptions const&, rocksdb::BlockHandle const&, rocksdb::DataBlockIter*, bool, bool, rocksdb::GetContext*, rocksdb::Status, rocksdb::FilePrefetchBuffer*) ()\r\n#8  0x0000562d8a1e49e5 in rocksdb::BlockBasedTableIterator<rocksdb::DataBlockIter>::InitDataBlock() ()\r\n#9  0x0000562d8a1e4e4a in rocksdb::BlockBasedTableIterator<rocksdb::DataBlockIter>::FindKeyForward() ()\r\n#10 0x0000562d8a17a279 in rocksdb::(anonymous namespace)::LevelIterator::Next() ()\r\n#11 0x0000562d8a1fd737 in rocksdb::MergingIterator::Next() ()\r\n#12 0x0000562d8a2e2459 in rocksdb::CompactionIterator::Next() ()\r\n#13 0x0000562d8a2ed924 in rocksdb::CompactionJob::ProcessKeyValueCompaction(rocksdb::CompactionJob::SubcompactionState*) ()\r\n#14 0x0000562d8a2eed4e in rocksdb::CompactionJob::Run() ()\r\n#15 0x0000562d8a0ed091 in rocksdb::DBImpl::BackgroundCompaction(bool*, rocksdb::JobContext*, rocksdb::LogBuffer*, rocksdb::DBImpl::PrepickedCompaction*) ()\r\n#16 0x0000562d8a0eebe1 in rocksdb::DBImpl::BackgroundCallCompaction(rocksdb::DBImpl::PrepickedCompaction*, rocksdb::Env::Priority) ()\r\n#17 0x0000562d8a0ef0da in rocksdb::DBImpl::BGWorkCompaction(void*) ()\r\n#18 0x0000562d8a329d95 in rocksdb::ThreadPoolImpl::Impl::BGThread(unsigned long) ()\r\n#19 0x0000562d8a329f3f in rocksdb::ThreadPoolImpl::Impl::BGThreadWrapper(void*) ()\r\n#20 0x0000562d8a28ea6f in execute_native_thread_routine ()\r\n#21 0x00007f7086840dd5 in start_thread () from /lib64/libpthread.so.0\r\n#22 0x00007f7086353ead in clone () from /lib64/libc.so.6\r\n(gdb) \r\n```\r\n\r\nconfig.toml\r\n\r\n```\r\n[server]\r\nlog-level = \"info\"\r\n[metric]\r\ninterval = \"15s\"\r\naddress = \"192.168.20.73:9091\"\r\njob = \"tikv\"\r\n[raftstore]\r\nsync-log = false\r\npd-heartbeat-tick-interval = \"3m\"\r\npd-store-heartbeat-tick-interval = \"15s\"\r\n[pd]\r\n[rocksdb]\r\ncompaction-readahead-size = \"8MB\"\r\n[rocksdb.defaultcf]\r\ncompression-per-level = [\"no\", \"snappy\", \"lz4\", \"lz4\", \"lz4\", \"zstd\", \"zstd\"]\r\nmax-write-buffer-number = 15\r\nblock-cache-size = \"4GB\"\r\n[rocksdb.writecf]\r\nblock-cache-size = \"1GB\"\r\n[rocksdb.raftcf]\r\nblock-cache-size = \"512MB\"\r\n[rocksdb.lockcf]\r\nblock-cache-size = \"512MB\"\r\n[storage]\r\nscheduler-worker-pool-size = 8\r\n```\r\n\r\n**tikv-version**\r\n\r\n```\r\nTiKV \r\nRelease Version:   2.1.1\r\nGit Commit Hash:   b48f3317c162fb69a1589e48c83452c2b89efb9d\r\nGit Commit Branch: release-2.1\r\nUTC Build Time:    2018-12-17 02:25:04\r\nRust Version:      rustc 1.29.0-nightly (4f3c7a472 2018-07-17)\r\n```",
  "state": "closed",
  "created_at": "2019-01-10T03:38:35Z",
  "updated_at": "2019-01-10T09:41:19Z",
  "closed_at": "2019-01-10T09:41:19Z",
  "labels": [
    "type/bug",
    "component/rocksdb"
  ],
  "comments_data": [
    {
      "id": 452972919,
      "user": "DorianZheng",
      "created_at": "2019-01-10T05:11:03Z",
      "body": "@darren Could you upload  the core file and binary?"
    },
    {
      "id": 452993284,
      "user": "darren",
      "created_at": "2019-01-10T07:11:26Z",
      "body": "@DorianZheng\r\n\r\nhmmm, it's rather big in size\r\n\r\n```\r\ntotal 11G\r\ndrwxr-xr-x 2 root root 4.0K Jan 10 15:02 .\r\ndrwxr-xr-x 5 root root 4.0K Jan 10 15:03 ..\r\n-rw------- 1 root root  26G Jan  9 02:45 core.37312\r\n-rwxr-xr-x 1 root root 164M Jan 10 15:01 tikv-server\r\n``` \r\nLet me try compressing it, i'll send you the download link via mail while it's ready.\r\n"
    },
    {
      "id": 453028581,
      "user": "darren",
      "created_at": "2019-01-10T09:29:33Z",
      "body": "Maybe duplicate of #3964\r\n\r\nCompare these segfaults in dmesg,\r\n\r\n```\r\nkernel: rocksdb:low2[37324]: segfault at 7f715622fa87 ip 0000562d8a256b51 sp 00007f70737fa870 error 4 in tikv-server[562d890e5000+1637000]\r\nkernel: split-check[31704]:  segfault at 7fd00c5e9dc7 ip 0000559c2075ab51 sp 00007fcead7fc080 error 4 in tikv-server[559c1f5e9000+1637000]\r\n```\r\n\r\nBTW: segfaults in both  #4048 and #3964  happened only on the same tikv node.\r\n\r\nI wonder whether this is a hardware problem. \r\n\r\nThis node used to be a Spark node (on Centos6), and java process on this node exit abruptly now and then  for no good reason. So we reinstall the node to CentOS7 and make it a tikv node. No memory corruption related message is found in kernel message.\r\n\r\n\r\n"
    },
    {
      "id": 453029308,
      "user": "siddontang",
      "created_at": "2019-01-10T09:32:00Z",
      "body": "> So we reinstall the node to CentOS7 and make it a tikv node\r\n\r\n@darren you mean that after you reinstall OS, the problem still exists? "
    },
    {
      "id": 453032050,
      "user": "darren",
      "created_at": "2019-01-10T09:40:32Z",
      "body": "@siddontang \r\n\r\nYes! Both segfaults of tikv happens only on this node with a fresh install of CentOS7.\r\n\r\nI think it must be hardware problem. We should remove this node from the rack.\r\nThank you all from your time! I am going to close these issues.\r\n"
    }
  ]
}