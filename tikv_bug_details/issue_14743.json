{
  "issue_number": 14743,
  "title": "[Dynamic Regions]: tikv panic during the restart",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nmaster with pr: https://github.com/tikv/tikv/pull/14735\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\nrun sysbench prepare and restart tikv every 10 minutes\r\n### What did you expect?\r\nrestart succeed\r\n### What did happened?\r\none tikv keep panic\r\n\r\n189789 [2023/05/12 10:00:49.429 +08:00] [FATAL] [lib.rs:497] [\"called `Option::unwrap()` on a `None` value\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\\n   1: <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call\\       n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/alloc/src/boxed.rs:2032:9\\n      std::panicking::rust_panic_with_hook\\n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/std/src/panick       ing.rs:692:13\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/std/src/panicking.rs:577:13\\n   3: std::sys_common::backtrace::__rust_end_short_backtra       ce\\n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/std/src/sys_common/backtrace.rs:137:18\\n   4: rust_begin_unwind\\n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/std/src/panicking       .rs:575:5\\n   5: core::panicking::panic_fmt\\n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/core/src/panicking.rs:65:14\\n   6: core::panicking::panic\\n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b171       0a8cebeef/library/core/src/panicking.rs:114:5\\n   7: raftstore_v2::operation::ready::apply_trace::ApplyTrace::recover\\n   8: raftstore_v2::operation::ready::apply_trace::<impl raftstore_v2::raft::storage::Storage<EK,ER>>::new\\n          9: <raft_log_engine::engine::RaftLogEngine as engine_traits::raft_engine::RaftEngine>::for_each_raft_group\\n  10: raftstore_v2::batch::store::StorePollerBuilder<EK,ER,T>::init\\n  11: raftstore_v2::batch::store::StoreSystem<EK,ER>:       :start\\n  12: tikv::server::raftkv2::node::NodeV2<C,EK,ER>::start_store\\n  13: tikv::server::raftkv2::node::NodeV2<C,EK,ER>::start\\n  14: server::server2::TikvServer<ER>::init_servers\\n  15: server::server2::run_tikv\\n  16: tikv_s       erver::main\\n  17: std::sys_common::backtrace::__rust_begin_short_backtrace\\n  18: std::rt::lang_start::{{closure}}\\n  19: core::ops::function::impls::<impl core::ops::function::FnOnce<A> for &F>::call_once\\n             at /rustc       /96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/core/src/ops/function.rs:612:13\\n      std::panicking::try::do_call\\n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/std/src/panicking.rs:483:40\\n      std:       :panicking::try\\n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/std/src/panicking.rs:447:19\\n      std::panic::catch_unwind\\n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/std/src/       panic.rs:137:14\\n      std::rt::lang_start_internal::{{closure}}\\n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/std/src/rt.rs:148:48\\n      std::panicking::try::do_call\\n             at /rustc/96ddd32c4bf       b1d78f0cd03eb068b1710a8cebeef/library/std/src/panicking.rs:483:40\\n      std::panicking::try\\n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/std/src/panicking.rs:447:19\\n      std::panic::catch_unwind\\n                    at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/std/src/panic.rs:137:14\\n      std::rt::lang_start_internal\\n             at /rustc/96ddd32c4bfb1d78f0cd03eb068b1710a8cebeef/library/std/src/rt.rs:148:20\\n  20:        main\\n  21: __libc_start_main\\n  22: <unknown>\\n\"] [location=/data4/qixu/l/tikv/components/raftstore-v2/src/operation/ready/apply_trace.rs:192] [thread_name=main]\r\n\r\nBy adding logs, we find out the region id is 731 and the cf is default and the previous log is:\r\n\r\n\r\n[2023/05/12 10:00:05.207 +08:00] [INFO] [raft.rs:1376] [\"received a message with higher term from 850\"] [\"msg type\"=MsgRequestVote] [message_term=13] [term=12] [from=850] [raft_id=732] [peer_id=732] [region_id=731]\r\n[2023/05/12 10:00:05.207 +08:00] [INFO] [raft.rs:1132] [\"became follower at term 13\"] [term=13] [raft_id=732] [peer_id=732] [region_id=731]\r\n[2023/05/12 10:00:05.207 +08:00] [INFO] [raft.rs:1577] [\"[logterm: 12, index: 527430, vote: 0] cast vote for 850 [logterm: 12, index: 527430] at term 13\"] [\"msg type\"=MsgRequestVote] [term=13] [msg_index=527430] [msg_term=12] [fro       m=850] [vote=0] [log_index=527430] [log_term=12] [raft_id=732] [peer_id=732] [region_id=731]\r\n\r\n\r\n [2023/05/12 10:00:07.333 +08:00] [INFO] [raft.rs:1445] [\"ignored a message with lower term from 734\"] [\"msg term\"=12] [\"msg type\"=MsgHeartbeatResponse] [term=13] [from=734] [raft_id=732] [peer_id=732] [region_id=731]\r\n\r\n\r\n[2023/05/12 10:00:08.270 +08:00] [INFO] [compact_log.rs:538] [\"compact log\"] [truncated=\"applied_index: 527851 truncated_state { index: 527741 term: 13 }\"] [apply_trace=\"ApplyTrace { data_cfs: [Progress { flushed: 5, last_modified       : 5, last_trigger_flush: 5 }, Progress { flushed: 527321, last_modified: 527851, last_trigger_flush: 459579 }, Progress { flushed: 527433, last_modified: 527818, last_trigger_flush: 436017 }], admin: Progress { flushed: 527321, la       st_modified: 459579, last_trigger_flush: 0 }, persisted_applied: 527321, try_persist: false }\"] [index=527321] [peer_id=732] [region_id=731]\r\n\r\n [2023/05/12 10:00:12.881 +08:00] [INFO] [apply_trace.rs:548] [\"persisting admin flushed\"] [flushed=527433] [tablet_index=459579] [peer_id=732] [region_id=731]\r\n\r\n[2023/05/12 10:00:12.881 +08:00] [INFO] [compact_log.rs:538] [\"compact log\"] [truncated=\"applied_index: 528530 truncated_state { index: 527741 term: 13 }\"] [apply_trace=\"ApplyTrace { data_cfs: [Progress { flushed: 5, last_modified       : 5, last_trigger_flush: 5 }, Progress { flushed: 528517, last_modified: 528530, last_trigger_flush: 459579 }, Progress { flushed: 527433, last_modified: 528504, last_trigger_flush: 436017 }], admin: Progress { flushed: 527433, la       st_modified: 459579, last_trigger_flush: 0 }, persisted_applied: 527433, try_persist: false }\"] [index=527433] [peer_id=732] [region_id=731]\r\n\r\n[731.log](https://github.com/tikv/tikv/files/11468025/731.log)\r\n",
  "state": "closed",
  "created_at": "2023-05-12T22:04:48Z",
  "updated_at": "2023-07-05T21:49:56Z",
  "closed_at": "2023-06-21T17:26:43Z",
  "labels": [
    "type/bug",
    "severity/critical",
    "feature/developing",
    "affects-7.1",
    "affects-7.2"
  ],
  "comments_data": [
    {
      "id": 1552966144,
      "user": "dbsid",
      "created_at": "2023-05-18T12:13:52Z",
      "body": "observed with master + pr https://github.com/tikv/tikv/pull/14708\r\n\r\n```\r\n[2023/05/18 19:40:06.339 +08:00] [FATAL] [lib.rs:497] [\"called `Option::unwrap()` on a `None` value\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/lib.rs:496:18\\n   1: <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2032:9\\n      std::panicking::rust_panic_with_hook\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:692:13\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:577:13\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:137:18\\n   4: rust_begin_unwind\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:575:5\\n   5: core::panicking::panic_fmt\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:65:14\\n   6: core::panicking::panic\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:114:5\\n   7: raftstore_v2::operation::ready::apply_trace::ApplyTrace::recover\\n      raftstore_v2::operation::ready::apply_trace::<impl raftstore_v2::raft::storage::Storage<EK,ER>>::new\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore-v2/src/operation/ready/apply_trace.rs:392:37\\n      raftstore_v2::batch::store::StorePollerBuilder<EK,ER,T>::init::{{closure}}\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore-v2/src/batch/store.rs:355:37\\n      <raft_log_engine::engine::RaftLogEngine as engine_traits::raft_engine::RaftEngine>::for_each_raft_group\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raft_log_engine/src/engine.rs:795:17\\n      raftstore_v2::batch::store::StorePollerBuilder<EK,ER,T>::init\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore-v2/src/batch/store.rs:352:9\\n      raftstore_v2::batch::store::StoreSystem<EK,ER>::start\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore-v2/src/batch/store.rs:702:21\\n   8: tikv::server::raftkv2::node::NodeV2<C,EK,ER>::start_store\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/server/raftkv2/node.rs:226:9\\n      tikv::server::raftkv2::node::NodeV2<C,EK,ER>::start\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/src/server/raftkv2/node.rs:133:9\\n   9: server::server2::TikvServer<ER>::init_servers\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/server/src/server2.rs:793:9\\n  10: server::server2::run_impl\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/server/src/server2.rs:130:25\\n      server::server2::run_tikv\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/server/src/server2.rs:168:5\\n  11: tikv_server::main\\n             at home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/cmd/tikv-server/src/main.rs:222:32\\n  12: core::ops::function::FnOnce::call_once\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:513:5\\n      std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:121:18\\n  13: main\\n  14: __libc_start_call_main\\n  15: __libc_start_main_alias_2\\n  16: <unknown>\\n\"] [location=/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/raftstore-v2/src/operation/ready/apply_trace.rs:183] [thread_name=main]\r\n```\r\n"
    },
    {
      "id": 1584049783,
      "user": "overvenus",
      "created_at": "2023-06-09T06:34:32Z",
      "body": "We have reproduced the issue. From files in raft engine, the missing flushed index is actually existed. But during raft engine recovery, the flushed index is skipped because there is an atomic group in the same file.\r\n\r\nThe flushed index kv is added to `PendingAtomicGroup ` in https://github.com/tikv/raft-engine/blob/7016173984665d1847789a713f0d00e6750627f5/src/memtable.rs#L1324-L1333\r\n\r\nBut it seems the `PendingAtomicGroup ` is never used. \r\n"
    }
  ]
}