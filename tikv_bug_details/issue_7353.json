{
  "issue_number": 7353,
  "title": "raft::raft_log::RaftLog<T>::commit_to paniked",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n\r\n```\r\n/ # /tikv-server -V\r\nTiKV\r\nRelease Version:   4.0.0-beta.2\r\nGit Commit Hash:   f6e0bb5b2719b2f1262fc2898e12ff3742c9e332\r\nGit Commit Branch: HEAD\r\nUTC Build Time:    2020-04-02 01:15:12\r\nRust Version:      rustc 1.42.0-nightly (0de96d37f 2019-12-19)\r\nEnable Features:   jemalloc portable sse protobuf-codec\r\nProfile:           dist_release\r\n```\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\nGCP n1-standard-32\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nrun tipocket/bank with \r\n```\r\n-tidb-replica-read=leader-and-follower\r\n-nemesis=random_kill,kill_pd_leader_5min,partition_one,subcritical_skews,big_skews,shuffle-leader-scheduler,shuffle-region-scheduler,random-merge-scheduler\r\n```\r\n\r\n### What did you expect?\r\n\r\n```\r\nNONE\r\n```\r\n\r\n### What did happened?\r\n\r\n```\r\n2020/04/02 15:51:41 control.go:497: [fatal] 1 panics occurred in ns: tipocket-scbank2 pod tipocket-scbank2-tikv-1. Content: [[2020/04/02 15:45:20.863 +00:00] [FATAL] [lib.rs:480] [\"to_commit 177238 is out of range [last_index 177215], raft_id: 2003, region_id: 2001\"] [backtrace=\"stack backtrace:\r\n   0: tikv_util::set_panic_hook::{{closure}}\r\n             at components/tikv_util/src/lib.rs:479\r\n   1: std::panicking::rust_panic_with_hook\r\n             at src/libstd/panicking.rs:475\r\n   2: rust_begin_unwind\r\n             at src/libstd/panicking.rs:375\r\n   3: std::panicking::begin_panic_fmt\r\n             at src/libstd/panicking.rs:326\r\n   4: raft::raft_log::RaftLog<T>::commit_to\r\n             at tikv/<::std::macros::panic macros>:9\r\n   5: raft::raft_log::RaftLog<T>::maybe_commit\r\n             at root/.cargo/git/checkouts/raft-rs-841f8a6db665c5c0/b9891b6/src/raft_log.rs:429\r\n   6: raft::raft::Raft<T>::step_follower\r\n             at root/.cargo/git/checkouts/raft-rs-841f8a6db665c5c0/b9891b6/src/raft.rs:1851\r\n      raft::raft::Raft<T>::step\r\n             at root/.cargo/git/checkouts/raft-rs-841f8a6db665c5c0/b9891b6/src/raft.rs:1155\r\n   7: raft::raw_node::RawNode<T>::step\r\n             at root/.cargo/git/checkouts/raft-rs-841f8a6db665c5c0/b9891b6/src/raw_node.rs:339\r\n      raftstore::store::peer::Peer::step\r\n             at tikv/components/raftstore/src/store/peer.rs:762\r\n      raftstore::store::fsm::peer::PeerFsmDelegate<T,C>::on_raft_message\r\n             at tikv/components/raftstore/src/store/fsm/peer.rs:894\r\n   8: raftstore::store::fsm::peer::PeerFsmDelegate<T,C>::handle_msgs\r\n             at tikv/components/raftstore/src/store/fsm/peer.rs:282\r\n   9: <raftstore::store::fsm::store::RaftPoller<T,C> as batch_system::batch::PollHandler<raftstore::store::fsm::peer::PeerFsm<engine_rocks::engine::RocksEngine>,raftstore::store::fsm::store::StoreFsm>>::handle_normal\r\n             at tikv/components/raftstore/src/store/fsm/store.rs:702\r\n  10: batch_system::batch::Poller<N,C,Handler>::poll\r\n             at tikv/components/batch-system/src/batch.rs:290\r\n  11: batch_system::batch::BatchSystem<N,C>::spawn::{{closure}}\r\n             at tikv/components/batch-system/src/batch.rs:394\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/sys_common/backtrace.rs:136\r\n  12: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\r\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/thread/mod.rs:469\r\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panic.rs:318\r\n      std::panicking::try::do_call\r\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panicking.rs:292\r\n      std::panicking::try\r\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8//src/libpanic_unwind/lib.rs:78\r\n      std::panic::catch_unwind\r\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panic.rs:394\r\n      std::thread::Builder::spawn_unchecked::{{closure}}\r\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/thread/mod.rs:468\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libcore/ops/function.rs:232\r\n  13: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/liballoc/boxed.rs:1022\r\n  14: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/liballoc/boxed.rs:1022\r\n      std::sys_common::thread::start_thread\r\n             at src/libstd/sys_common/thread.rs:13\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at src/libstd/sys/unix/thread.rs:80\r\n  15: <unknown>\r\n  16: clone\r\n\"] [location=/root/.cargo/git/checkouts/raft-rs-841f8a6db665c5c0/b9891b6/src/raft_log.rs:237] [thread_name=raftstore-4-0]\r\n```\r\n\r\n[tipocket-scbank2-p7v8c.log](https://github.com/tikv/tikv/files/4424713/tipocket-scbank2-p7v8c.log)",
  "state": "closed",
  "created_at": "2020-04-03T02:21:13Z",
  "updated_at": "2020-04-09T10:15:43Z",
  "closed_at": "2020-04-09T10:15:43Z",
  "labels": [
    "type/bug"
  ],
  "comments_data": [
    {
      "id": 608222675,
      "user": "mahjonp",
      "created_at": "2020-04-03T04:30:04Z",
      "body": "\r\n[tidb-logs.zip](https://github.com/tikv/tikv/files/4425049/tidb-logs.zip)\r\n"
    },
    {
      "id": 608247067,
      "user": "gengliqi",
      "created_at": "2020-04-03T06:03:34Z",
      "body": "It's caused by the https://github.com/tikv/raft-rs/pull/346 and a subtle hack code in tikv. \r\nWe hack the ReadIndex response in https://github.com/tikv/tikv/blob/e43a6e304c3d364bddd3f7a44bc6b0c27e3844cc/components/raftstore/src/store/peer.rs#L740-L752\r\nBut we forget to set term. So the term checker in `maybe_commit` lost effect. (Both zero)\r\nhttps://github.com/tikv/raft-rs/blob/c82696c904e1d4e05ee9ecb1cfd8bf3f957a842a/src/raft_log.rs#L423\r\nI think we should change two mistakes. \r\nOne is we should set term in ReadIndex response.\r\nThe other one is the check can be stronger because the term zero is invalid.\r\n/cc @NingLin-P "
    }
  ]
}