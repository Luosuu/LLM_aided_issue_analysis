{
  "issue_number": 13551,
  "title": "LruCache is unsound",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n\r\nmaster\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\nnot matter\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\n`cargo miri test --package tikv_util --no-fail-fast -- lru::tests`\r\n\r\n### What did you expect?\r\n\r\n`cargo miri test` pass.\r\n\r\n### What did happened?\r\n```\r\ntest lru::tests::test_insert ... error: Undefined Behavior: no item granting read access to tag <542191> at alloc209902 found in borrow stack.\r\n   --> components/tikv_util/src/lru.rs:104:30\r\n    |\r\n104 |             let mut record = self.tail.prev;\r\n    |                              ^^^^^^^^^^^^^^ no item granting read access to tag <542191> at alloc209902 found in borrow stack.\r\n    |\r\n    = help: this indicates a potential bug in the program: it performed an invalid operation, but the rules it violated are still experimental\r\n    = help: see https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md for further information\r\n\r\n    = note: inside `lru::Trace::<i32>::reuse_tail` at components/tikv_util/src/lru.rs:104:30\r\nnote: inside `lru::LruCache::<i32, i32>::insert` at components/tikv_util/src/lru.rs:247:31\r\n   --> components/tikv_util/src/lru.rs:247:31\r\n    |\r\n247 |                     let res = self.trace.reuse_tail(v.key().clone());\r\n    |                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nnote: inside `lru::tests::test_insert` at components/tikv_util/src/lru.rs:370:13\r\n   --> components/tikv_util/src/lru.rs:370:13\r\n    |\r\n370 |             map.insert(i, i);\r\n    |             ^^^^^^^^^^^^^^^^\r\nnote: inside closure at components/tikv_util/src/lru.rs:361:5\r\n   --> components/tikv_util/src/lru.rs:361:5\r\n    |\r\n360 |       #[test]\r\n    |       ------- in this procedural macro expansion\r\n361 | /     fn test_insert() {\r\n362 | |         let mut map = LruCache::with_capacity(10);\r\n363 | |         for i in 0..10 {\r\n364 | |             map.insert(i, i);\r\n...   |\r\n380 | |         }\r\n381 | |     }\r\n    | |_____^\r\n```\r\n\r\n```\r\ntest lru::tests::test_clear ... error: Undefined Behavior: trying to reborrow for Unique at alloc382169, but parent tag <963820> does not have an appropriate item in the borrow stack\r\n   --> components/tikv_util/src/lru.rs:118:35\r\n    |\r\n118 |             while cur.as_ptr() != &mut *self.tail {\r\n    |                                   ^^^^^^^^^^^^^^^ trying to reborrow for Unique at alloc382169, but parent tag <963820> does not have an appropriate item in the borrow stack\r\n    |\r\n    = help: this indicates a potential bug in the program: it performed an invalid operation, but the rules it violated are still experimental\r\n    = help: see https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md for further information\r\n\r\n    = note: inside `lru::Trace::<i32>::clear` at components/tikv_util/src/lru.rs:118:35\r\nnote: inside `lru::LruCache::<i32, i32>::clear` at components/tikv_util/src/lru.rs:204:9\r\n   --> components/tikv_util/src/lru.rs:204:9\r\n    |\r\n204 |         self.trace.clear();\r\n    |         ^^^^^^^^^^^^^^^^^^\r\nnote: inside `lru::tests::test_clear` at components/tikv_util/src/lru.rs:518:9\r\n   --> components/tikv_util/src/lru.rs:518:9\r\n    |\r\n518 |         map.clear();\r\n    |         ^^^^^^^^^^^\r\nnote: inside closure at components/tikv_util/src/lru.rs:510:5\r\n   --> components/tikv_util/src/lru.rs:510:5\r\n    |\r\n509 |       #[test]\r\n    |       ------- in this procedural macro expansion\r\n510 | /     fn test_clear() {\r\n511 | |         let mut map = LruCache::with_capacity(10);\r\n512 | |         for i in 0..10 {\r\n513 | |             map.insert(i, i);\r\n...   |\r\n527 | |         }\r\n528 | |     }\r\n    | |_____^\r\n```",
  "state": "closed",
  "created_at": "2022-09-28T03:11:29Z",
  "updated_at": "2022-09-28T08:25:46Z",
  "closed_at": "2022-09-28T08:25:46Z",
  "labels": [
    "type/bug",
    "severity/minor"
  ],
  "comments_data": []
}