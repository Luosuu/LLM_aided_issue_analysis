{
  "issue_number": 13723,
  "title": "flashback during workload, tikv panic lead to tidb down",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n[root@localhost ~]# /data1/tidb-deploy/tikv-2360/bin/tikv-server -V\r\nTiKV \r\nRelease Version:   6.4.0-alpha\r\nEdition:           Community\r\nGit Commit Hash:   e0885803a17dfcd26964e74029ce5af9a32cd797\r\nGit Commit Branch: heads/refs/tags/v6.4.0-alpha\r\nUTC Build Time:    2022-10-31 14:26:38\r\nRust Version:      rustc 1.64.0-nightly (0f4bcadb4 2022-07-30)\r\nEnable Features:   pprof-fp jemalloc mem-profiling portable sse test-engine-kv-rocksdb test-engine-raft-raft-engine cloud-aws cloud-gcp cloud-azure\r\nProfile:           dist_release\r\n[root@localhost ~]# \r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\nrun tpcc workload\r\nrun flashback during workload running\r\n\r\n### What did you expect?\r\nflashback successfully\r\n\r\n### What did happened?\r\ntidb down\r\n```code\r\n[2022/11/02 21:24:33.730 +08:00] [FATAL] [[lib.rs:495](http://lib.rs:495/)] [\"assertion failed: row.write.is_none()\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/tikv_util/src/lib.rs:494:18\\n](http://github.com/pingcap/tikv/components/tikv_util/src/lib.rs:494:18/n)   1: std::panicking::rust_panic_with_hook\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:702](http://panicking.rs:702/):17\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:586](http://panicking.rs:586/):13\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/[backtrace.rs:138](http://backtrace.rs:138/):18\\n   4: rust_begin_unwind\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:584](http://panicking.rs:584/):5\\n   5: core::panicking::panic_fmt\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/[panicking.rs:142](http://panicking.rs:142/):14\\n   6: core::panicking::panic\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/[panicking.rs:48](http://panicking.rs:48/):5\\n   7: resolved_ts::cmd::group_row_changes\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/resolved_ts/src/cmd.rs:217:29\\n](http://github.com/pingcap/tikv/components/resolved_ts/src/cmd.rs:217:29/n)      resolved_ts::cmd::ChangeLog::encode_change_log::{{closure}}\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/resolved_ts/src/cmd.rs:62:57\\n](http://github.com/pingcap/tikv/components/resolved_ts/src/cmd.rs:62:57/n)      core::iter::adapters::map::map_fold::{{closure}}\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/iter/adapters/[map.rs:84](http://map.rs:84/):28\\n      core::iter::traits::iterator::Iterator::fold\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/iter/traits/[iterator.rs:2414](http://iterator.rs:2414/):21\\n      <core::iter::adapters::map::Map<I,F> as core::iter::traits::iterator::Iterator>::fold\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/iter/adapters/[map.rs:124](http://map.rs:124/):9\\n      core::iter::traits::iterator::Iterator::for_each\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/iter/traits/[iterator.rs:831](http://iterator.rs:831/):9\\n      <alloc::vec::Vec<T,A> as alloc::vec::spec_extend::SpecExtend<T,I>>::spec_extend\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/vec/[spec_extend.rs:40](http://spec_extend.rs:40/):17\\n      <alloc::vec::Vec<T> as alloc::vec::spec_from_iter_nested::SpecFromIterNested<T,I>>::from_iter\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/vec/[spec_from_iter_nested.rs:62](http://spec_from_iter_nested.rs:62/):9\\n      alloc::vec::in_place_collect::<impl alloc::vec::spec_from_iter::SpecFromIter<T,I> for alloc::vec::Vec<T>>::from_iter\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/vec/[in_place_collect.rs:164](http://in_place_collect.rs:164/):20\\n      <alloc::vec::Vec<T> as core::iter::traits::collect::FromIterator<T>>::from_iter\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/resolved_ts/src/cmd.rs:48:9\\n](http://github.com/pingcap/tikv/components/resolved_ts/src/cmd.rs:48:9/n)      core::iter::traits::iterator::Iterator::collect\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/iter/traits/[iterator.rs:1836](http://iterator.rs:1836/):9\\n      resolved_ts::cmd::ChangeLog::encode_change_log\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/resolved_ts/src/cmd.rs:48:9\\n](http://github.com/pingcap/tikv/components/resolved_ts/src/cmd.rs:48:9/n)   8: resolved_ts::endpoint::Endpoint<T,E,C>::handle_change_log::{{closure}}\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/resolved_ts/src/endpoint.rs:538:40\\n](http://github.com/pingcap/tikv/components/resolved_ts/src/endpoint.rs:538:40/n)      core::ops::function::impls::<impl core::ops::function::FnMut<A> for &mut F>::call_mut\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/[function.rs:290](http://function.rs:290/):13\\n      core::iter::traits::iterator::Iterator::find_map::check::{{closure}}\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/iter/traits/[iterator.rs:2732](http://iterator.rs:2732/):32\\n      core::iter::traits::iterator::Iterator::try_fold\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/iter/traits/[iterator.rs:2238](http://iterator.rs:2238/):21\\n      core::iter::traits::iterator::Iterator::find_map\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/iter/traits/[iterator.rs:2738](http://iterator.rs:2738/):9\\n      <core::iter::adapters::filter_map::FilterMap<I,F> as core::iter::traits::iterator::Iterator>::next\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/iter/adapters/[filter_map.rs:61](http://filter_map.rs:61/):9\\n   9: <alloc::vec::Vec<T> as alloc::vec::spec_from_iter_nested::SpecFromIterNested<T,I>>::from_iter\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/vec/[spec_from_iter_nested.rs:26](http://spec_from_iter_nested.rs:26/):32\\n      alloc::vec::in_place_collect::<impl alloc::vec::spec_from_iter::SpecFromIter<T,I> for alloc::vec::Vec<T>>::from_iter\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/vec/[in_place_collect.rs:164](http://in_place_collect.rs:164/):20\\n      <alloc::vec::Vec<T> as core::iter::traits::collect::FromIterator<T>>::from_iter\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/resolved_ts/src/endpoint.rs:530:20\\n](http://github.com/pingcap/tikv/components/resolved_ts/src/endpoint.rs:530:20/n)      core::iter::traits::iterator::Iterator::collect\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/iter/traits/[iterator.rs:1836](http://iterator.rs:1836/):9\\n      resolved_ts::endpoint::Endpoint<T,E,C>::handle_change_log\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/resolved_ts/src/endpoint.rs:530:20\\n](http://github.com/pingcap/tikv/components/resolved_ts/src/endpoint.rs:530:20/n)      <resolved_ts::endpoint::Endpoint<T,E,C> as tikv_util::worker::pool::Runnable>::run\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/resolved_ts/src/endpoint.rs:748:18\\n](http://github.com/pingcap/tikv/components/resolved_ts/src/endpoint.rs:748:18/n)      tikv_util::worker::pool::Worker::start_with_timer_impl::{{closure}}\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/tikv_util/src/worker/pool.rs:489:25\\n](http://github.com/pingcap/tikv/components/tikv_util/src/worker/pool.rs:489:25/n)      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/[mod.rs:91](http://mod.rs:91/):19\\n      yatp::task::future::RawTask<F>::poll\\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/39cb495/src/task/[future.rs:59](http://future.rs:59/):9\\n  10: yatp::task::future::TaskCell::poll\\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/39cb495/src/task/[future.rs:103](http://future.rs:103/):9\\n      <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/39cb495/src/task/[future.rs:387](http://future.rs:387/):20\\n  11: <tikv_util::yatp_pool::YatpPoolRunner<T> as yatp::pool::runner::Runner>::handle\\n             at /home/jenkins/agent/workspace/build-common/go/src/[github.com/pingcap/tikv/components/tikv_util/src/yatp_pool/mod.rs:122:24\\n](http://github.com/pingcap/tikv/components/tikv_util/src/yatp_pool/mod.rs:122:24/n)      yatp::pool::worker::WorkerThread<T,R>::run\\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/39cb495/src/pool/[worker.rs:48](http://worker.rs:48/):13\\n      yatp::pool::builder::LazyBuilder<T>::build::{{closure}}\\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/39cb495/src/pool/[builder.rs:114](http://builder.rs:114/):25\\n      std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/[backtrace.rs:122](http://backtrace.rs:122/):18\\n  12: std::thread::Builder::spawn_unchecked_::{{closure}}::{{closure}}\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/[mod.rs:505](http://mod.rs:505/):17\\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panic/[unwind_safe.rs:271](http://unwind_safe.rs:271/):9\\n      std::panicking::try::do_call\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:492](http://panicking.rs:492/):40\\n      std::panicking::try\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panicking.rs:456](http://panicking.rs:456/):19\\n      std::panic::catch_unwind\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/[panic.rs:137](http://panic.rs:137/):14\\n      std::thread::Builder::spawn_unchecked_::{{closure}}\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/[mod.rs:504](http://mod.rs:504/):30\\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/[function.rs:248](http://function.rs:248/):5\\n  13: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/[boxed.rs:1935](http://boxed.rs:1935/):9\\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/[boxed.rs:1935](http://boxed.rs:1935/):9\\n      std::sys::unix::thread::Thread::new::thread_start\\n             at /rust/toolchains/nightly-2022-07-31-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/unix/[thread.rs:108](http://thread.rs:108/):17\\n  14: start_thread\\n  15: clone\\n\"] [location=components/resolved_ts/src/[cmd.rs:217](http://cmd.rs:217/)] [thread_name=resolved-ts-0]\r\n```",
  "state": "closed",
  "created_at": "2022-11-02T14:13:49Z",
  "updated_at": "2022-11-04T02:16:03Z",
  "closed_at": "2022-11-04T02:16:03Z",
  "labels": [
    "type/bug",
    "severity/major"
  ],
  "comments_data": [
    {
      "id": 1301664652,
      "user": "JmPotato",
      "created_at": "2022-11-03T05:31:27Z",
      "body": "The reason for the panic is that there are multiple write records for the same key in the same Raft cmd batch. This could happen during a flashback when a key's pessimistic lock rollback and MVCC overwriting are in the same batch. #13695 will fix this by separating the lock and writing batch."
    }
  ]
}