{
  "issue_number": 6519,
  "title": "RocksDB scanning Write CF returns keys out of order",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\nhttps://github.com/tikv/tikv/pull/6513 (https://github.com/tikv/tikv/pull/6513/commits/13139a246882c7a1d6fc9b101820477210d3e3ce) ï¼Œ which adds some logs based on https://github.com/tikv/tikv/pull/6308 (https://github.com/tikv/tikv/commit/a498b9d63bdcdf3054ae543579277fb8952d5e69) inorder to locate the problem. \r\nThe merge-base on master branch is https://github.com/tikv/tikv/commit/2c97d8706c0def76409a184d50c8ba10a904a3cc\r\n\r\n\r\n### Steps to reproduce\r\n\r\nIn a raw kv cluster, generate about 10G random raw keys in write cf with this program: https://gist.github.com/MyonKeminta/6a9d60111bbe2f6f96b091ac474d2fc4\r\n\r\n```\r\n./rawkv-util-cf --mode=rand-gen --pd-addr=172.16.4.217:2379 --start-key=\"31\" --end-key=\"3130303030303030303030303030\" --concurrency=16 --key-max-len=32 --cf=write\r\n```\r\n\r\nThen this may happen in rawkv backup and raftstore snapshot generation.\r\n\r\n### What did you expect?\r\n\r\nRawkv backup or snapshot generation succeeds normally.\r\n\r\n### What did happened?\r\n\r\nGenerating snapshot randomly fails:\r\n\r\n```\r\n[2020/02/03 20:22:15.338 -05:00] [INFO] [peer_storage.rs:794] [\"requesting snapshot\"] [request_index=0] [peer_id=279] [region_id=104]\r\n[2020/02/03 20:22:15.339 -05:00] [INFO] [snap.rs:707] [\"scan snapshot of one cf\"] [size=0] [key_count=0] [cf=default] [snapshot=/data1/br/deploy/data/snap/gen_104_10_215979_(default|lock|write).sst] [region_id=104]\r\n[2020/02/03 20:22:15.339 -05:00] [INFO] [snap.rs:707] [\"scan snapshot of one cf\"] [size=0] [key_count=0] [cf=lock] [snapshot=/data1/br/deploy/data/snap/gen_104_10_215979_(default|lock|write).sst] [region_id=104]\r\n[2020/02/03 20:22:15.765 -05:00] [ERROR] [io.rs:82] [\"keys scanned from snap out of order\"] [current_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A] [last_key=7A311C39017D2D9DD3FEEDAE4B186FAF9FF802313EB566C44596E20B669481760B]\r\n[2020/02/03 20:22:15.765 -05:00] [ERROR] [io.rs:90] [\"sst writer put error\"] [current_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A] [last_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A]\r\n[2020/02/03 20:22:15.766 -05:00] [ERROR] [region.rs:268] [\"failed to generate snap!!!\"] [err=\"snap failed \\\"[src/raftstore/store/worker/region.rs:230]: [src/raftstore/store/snap/io.rs:76]: Io Storage Engine Invalid argument: Keys must be added in order\\\"\"] [region_id=104]\r\n[2020/02/03 20:22:16.301 -05:00] [INFO] [peer.rs:738] [\"failed to schedule peer tick\"] [err=\"sending on a disconnected channel\"] [tick=CHECK_PEER_STALE_STATE] [peer_id=1962] [region_id=1959]\r\n[2020/02/03 20:22:17.335 -05:00] [WARN] [peer_storage.rs:771] [\"failed to try generating snapshot\"] [times=1] [peer_id=279] [region_id=104]\r\n[2020/02/03 20:22:17.335 -05:00] [INFO] [peer_storage.rs:794] [\"requesting snapshot\"] [request_index=0] [peer_id=279] [region_id=104]\r\n[2020/02/03 20:22:17.336 -05:00] [INFO] [snap.rs:707] [\"scan snapshot of one cf\"] [size=0] [key_count=0] [cf=default] [snapshot=/data1/br/deploy/data/snap/gen_104_10_215979_(default|lock|write).sst] [region_id=104]\r\n[2020/02/03 20:22:17.336 -05:00] [INFO] [snap.rs:707] [\"scan snapshot of one cf\"] [size=0] [key_count=0] [cf=lock] [snapshot=/data1/br/deploy/data/snap/gen_104_10_215979_(default|lock|write).sst] [region_id=104]\r\n[2020/02/03 20:22:17.776 -05:00] [ERROR] [io.rs:82] [\"keys scanned from snap out of order\"] [current_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A] [last_key=7A311C39017D2D9DD3FEEDAE4B186FAF9FF802313EB566C44596E20B669481760B]\r\n[2020/02/03 20:22:17.776 -05:00] [ERROR] [io.rs:90] [\"sst writer put error\"] [current_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A] [last_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A]\r\n[2020/02/03 20:22:17.778 -05:00] [ERROR] [region.rs:268] [\"failed to generate snap!!!\"] [err=\"snap failed \\\"[src/raftstore/store/worker/region.rs:230]: [src/raftstore/store/snap/io.rs:76]: Io Storage Engine Invalid argument: Keys must be added in order\\\"\"] [region_id=104]\r\n[2020/02/03 20:22:19.336 -05:00] [WARN] [peer_storage.rs:771] [\"failed to try generating snapshot\"] [times=2] [peer_id=279] [region_id=104]\r\n[2020/02/03 20:22:19.337 -05:00] [INFO] [peer_storage.rs:794] [\"requesting snapshot\"] [request_index=0] [peer_id=279] [region_id=104]\r\n[2020/02/03 20:22:19.338 -05:00] [INFO] [snap.rs:707] [\"scan snapshot of one cf\"] [size=0] [key_count=0] [cf=default] [snapshot=/data1/br/deploy/data/snap/gen_104_10_215979_(default|lock|write).sst] [region_id=104]\r\n[2020/02/03 20:22:19.338 -05:00] [INFO] [snap.rs:707] [\"scan snapshot of one cf\"] [size=0] [key_count=0] [cf=lock] [snapshot=/data1/br/deploy/data/snap/gen_104_10_215979_(default|lock|write).sst] [region_id=104]\r\n[2020/02/03 20:22:19.770 -05:00] [ERROR] [io.rs:82] [\"keys scanned from snap out of order\"] [current_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A] [last_key=7A311C39017D2D9DD3FEEDAE4B186FAF9FF802313EB566C44596E20B669481760B]\r\n[2020/02/03 20:22:19.770 -05:00] [ERROR] [io.rs:90] [\"sst writer put error\"] [current_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A] [last_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A]\r\n[2020/02/03 20:22:19.771 -05:00] [ERROR] [region.rs:268] [\"failed to generate snap!!!\"] [err=\"snap failed \\\"[src/raftstore/store/worker/region.rs:230]: [src/raftstore/store/snap/io.rs:76]: Io Storage Engine Invalid argument: Keys must be added in order\\\"\"] [region_id=104]\r\n[2020/02/03 20:22:21.338 -05:00] [WARN] [peer_storage.rs:771] [\"failed to try generating snapshot\"] [times=3] [peer_id=279] [region_id=104]\r\n[2020/02/03 20:22:21.339 -05:00] [INFO] [peer_storage.rs:794] [\"requesting snapshot\"] [request_index=0] [peer_id=279] [region_id=104]\r\n[2020/02/03 20:22:21.340 -05:00] [INFO] [snap.rs:707] [\"scan snapshot of one cf\"] [size=0] [key_count=0] [cf=default] [snapshot=/data1/br/deploy/data/snap/gen_104_10_215979_(default|lock|write).sst] [region_id=104]\r\n[2020/02/03 20:22:21.340 -05:00] [INFO] [snap.rs:707] [\"scan snapshot of one cf\"] [size=0] [key_count=0] [cf=lock] [snapshot=/data1/br/deploy/data/snap/gen_104_10_215979_(default|lock|write).sst] [region_id=104]\r\n[2020/02/03 20:22:21.777 -05:00] [ERROR] [io.rs:82] [\"keys scanned from snap out of order\"] [current_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A] [last_key=7A311C39017D2D9DD3FEEDAE4B186FAF9FF802313EB566C44596E20B669481760B]\r\n[2020/02/03 20:22:21.777 -05:00] [ERROR] [io.rs:90] [\"sst writer put error\"] [current_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A] [last_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A]\r\n[2020/02/03 20:22:21.778 -05:00] [ERROR] [region.rs:268] [\"failed to generate snap!!!\"] [err=\"snap failed \\\"[src/raftstore/store/worker/region.rs:230]: [src/raftstore/store/snap/io.rs:76]: Io Storage Engine Invalid argument: Keys must be added in order\\\"\"] [region_id=104]\r\n[2020/02/03 20:22:23.341 -05:00] [WARN] [peer_storage.rs:771] [\"failed to try generating snapshot\"] [times=4] [peer_id=279] [region_id=104]\r\n[2020/02/03 20:22:23.341 -05:00] [INFO] [peer_storage.rs:794] [\"requesting snapshot\"] [request_index=0] [peer_id=279] [region_id=104]\r\n[2020/02/03 20:22:23.342 -05:00] [INFO] [snap.rs:707] [\"scan snapshot of one cf\"] [size=0] [key_count=0] [cf=default] [snapshot=/data1/br/deploy/data/snap/gen_104_10_215979_(default|lock|write).sst] [region_id=104]\r\n[2020/02/03 20:22:23.342 -05:00] [INFO] [snap.rs:707] [\"scan snapshot of one cf\"] [size=0] [key_count=0] [cf=lock] [snapshot=/data1/br/deploy/data/snap/gen_104_10_215979_(default|lock|write).sst] [region_id=104]\r\n[2020/02/03 20:22:23.772 -05:00] [ERROR] [io.rs:82] [\"keys scanned from snap out of order\"] [current_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A] [last_key=7A311C39017D2D9DD3FEEDAE4B186FAF9FF802313EB566C44596E20B669481760B]\r\n[2020/02/03 20:22:23.772 -05:00] [ERROR] [io.rs:90] [\"sst writer put error\"] [current_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A] [last_key=7A311C390155DDA659A89F159E323768D6D2077FE4CCD5250D44D454E2AF41482A]\r\n[2020/02/03 20:22:23.773 -05:00] [ERROR] [region.rs:268] [\"failed to generate snap!!!\"] [err=\"snap failed \\\"[src/raftstore/store/worker/region.rs:230]: [src/raftstore/store/snap/io.rs:76]: Io Storage Engine Invalid argument: Keys must be added in order\\\"\"] [region_id=104]\r\n[2020/02/03 20:22:25.343 -05:00] [WARN] [peer_storage.rs:771] [\"failed to try generating snapshot\"] [times=5] [peer_id=279] [region_id=104]\r\n[2020/02/03 20:22:25.875 -05:00] [FATAL] [lib.rs:503] [\"[region 104] 279 unexpected error: Store(Other(\\\"[src/raftstore/store/peer_storage.rs:788]: failed to get snapshot after 5 times\\\"))\"] [backtrace=\"stack backtrace:\\n   0: tikv_util::set_panic_hook::{{closure}}\\n             at components/tikv_util/src/lib.rs:502\\n   1: std::panicking::rust_panic_with_hook\\n             at src/libstd/panicking.rs:475\\n   2: rust_begin_unwind\\n             at src/libstd/panicking.rs:375\\n   3: std::panicking::begin_panic_fmt\\n             at src/libstd/panicking.rs:326\\n   4: raft::raft::Raft<T>::prepare_send_snapshot\\n             at /home/jenkins/agent/workspace/tikv_ghpr_build_release/tikv/<::std::macros::panic macros>:9\\n   5: raft::raft::Raft<T>::send_append\\n             at /rust/git/checkouts/raft-rs-841f8a6db665c5c0/2432781/src/raft.rs:636\\n   6: raft::raft::Raft<T>::step_leader\\n             at /rust/git/checkouts/raft-rs-841f8a6db665c5c0/2432781/src/raft.rs:1873\\n   7: raft::raft::Raft<T>::step\\n             at /rust/git/checkouts/raft-rs-841f8a6db665c5c0/2432781/src/raft.rs:1245\\n   8: tikv::raftstore::store::fsm::peer::PeerFsmDelegate<T,C>::on_raft_message\\n             at /rust/git/checkouts/raft-rs-841f8a6db665c5c0/2432781/src/raw_node.rs:356\\n   9: tikv::raftstore::store::fsm::peer::PeerFsmDelegate<T,C>::handle_msgs\\n             at /home/jenkins/agent/workspace/tikv_ghpr_build_release/tikv/src/raftstore/store/fsm/peer.rs:279\\n  10: <tikv::raftstore::store::fsm::store::RaftPoller<T,C> as batch_system::batch::PollHandler<tikv::raftstore::store::fsm::peer::PeerFsm,tikv::raftstore::store::fsm::store::StoreFsm>>::handle_normal\\n             at /home/jenkins/agent/workspace/tikv_ghpr_build_release/tikv/src/raftstore/store/fsm/store.rs:686\\n      batch_system::batch::Poller<N,C,Handler>::poll\\n             at /home/jenkins/agent/workspace/tikv_ghpr_build_release/tikv/components/batch-system/src/batch.rs:290\\n  11: batch_system::batch::BatchSystem<N,C>::spawn::{{closure}}\\n             at /home/jenkins/agent/workspace/tikv_ghpr_build_release/tikv/components/batch-system/src/batch.rs:361\\n      std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/sys_common/backtrace.rs:136\\n  12: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/thread/mod.rs:469\\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panic.rs:318\\n      std::panicking::try::do_call\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panicking.rs:292\\n      std::panicking::try\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8//src/libpanic_unwind/lib.rs:78\\n      std::panic::catch_unwind\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panic.rs:394\\n      std::thread::Builder::spawn_unchecked::{{closure}}\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/thread/mod.rs:468\\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libcore/ops/function.rs:232\\n  13: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/liballoc/boxed.rs:1022\\n  14: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/liballoc/boxed.rs:1022\\n      std::sys_common::thread::start_thread\\n             at src/libstd/sys_common/thread.rs:13\\n      std::sys::unix::thread::Thread::new::thread_start\\n             at src/libstd/sys/unix/thread.rs:80\\n  15: start_thread\\n  16: __clone\\n\"] [location=/rust/git/checkouts/raft-rs-841f8a6db665c5c0/2432781/src/raft.rs:541] [thread_name=raftstore-5-1]\r\n```\r\n\r\nRawkv Backup randomly fails:\r\n\r\n```\r\n[2020/02/03 20:19:37.319 -05:00] [ERROR] [endpoint.rs:237] [\"keys scanned from cursor out of order\"] [current_key=31182A0104C26E561B7FF2FB1E136455C917EB0351C7895E4736EE224F4AB196] [last_key=31182A011A602C2CE0CF1082E07A2E0D2CD9B90D1032FC01ABE49E150290A96A]       [2020/02/03 20:19:37.320 -05:00] [ERROR] [writer.rs:239] [\"write sst failed.\"] [last_key=31182A011A602C2CE0CF1082E07A2E0D2CD9B90D1032FC01ABE49E150290A96A] [key=31182A0104C26E561B7FF2FB1E136455C917EB0351C7895E4736EE224F4AB196]\r\n[2020/02/03 20:19:37.320 -05:00] [ERROR] [endpoint.rs:252] [\"backup raw kv build sst failed\"] [error=\"EngineTrait(Engine(\\\"Invalid argument: Keys must be added in order\\\"))\"]\r\n[2020/02/03 20:19:37.320 -05:00] [ERROR] [endpoint.rs:652] [\"backup region failed\"] [error=\"EngineTrait(Engine(\\\"Invalid argument: Keys must be added in order\\\"))\"] [end_key=] [start_key=] [region=\"id: 152 start_key: 31161009EA1E94A13E04FA9933B58505BC16B2D01351 end_key: 311896343F2014849C0930A6658F0C8750D4541E82A8CEFCD2A627ED509066F8 region_epoch { conf_ver: 17 version: 6 } peers { id: 153 store_id: 1 } peers { id: 330 store_id: 5 } peers { id: 366 store_id: 6 }\"]\r\n[2020/02/03 20:19:37.321 -05:00] [INFO] [endpoint.rs:669] [\"backup finished\"] [summary=\"Statistics { lock: CfStatistics { processed: 0, get: 0, next: 0, prev: 0, seek: 0, seek_for_prev: 0, over_seek_bound: 0, flow_stats: FlowStatistics { read_keys: 0, read_bytes: 0 } }, write: CfStatistics { processed: 0, get: 0, next: 1136712, prev: 0, seek: 3, seek_for_prev: 0, over_seek_bound: 0, flow_stats: FlowStatistics { read_keys: 1136712, read_bytes: 286915488 } }, data: CfStatistics { processed: 0, get: 0, next: 0, prev: 0, seek: 0, seek_for_prev: 0, over_seek_bound: 0, flow_stats: FlowStatistics { read_keys: 0, read_bytes: 0 } } }\"] [take=9.742272771s]\r\n[2020/02/03 20:19:37.321 -05:00] [WARN] [mod.rs:89] [\"handle task BackupTask { start_ts: TimeStamp(0), end_ts: TimeStamp(414391774082498562), start_key: \\\"31\\\", end_key: \\\"3130303030303030303030303030\\\", is_raw_kv: true, cf: \\\"write\\\" }\"] [takes=9.743s]\r\n```\r\n\r\nI'm not sure if this is related to our special configurations for Write CF. If not, it might be a bug of RocksDB.\r\n\r\n@Little-Wallace @zhangjinpeng1987 PTAL.\r\ncc. @overvenus @3pointer ",
  "state": "closed",
  "created_at": "2020-02-04T04:25:15Z",
  "updated_at": "2020-04-15T02:35:23Z",
  "closed_at": "2020-04-15T02:35:11Z",
  "labels": [
    "type/bug",
    "component/rocksdb"
  ],
  "comments_data": [
    {
      "id": 581751568,
      "user": "yiwu-arbug",
      "created_at": "2020-02-04T05:38:54Z",
      "body": "Will check."
    },
    {
      "id": 611197259,
      "user": "yiwu-arbug",
      "created_at": "2020-04-08T21:12:32Z",
      "body": "The issue is due to https://github.com/facebook/rocksdb/issues/6666. In summary, rocksdb read wrong result from ingested sst, which is generated by tikv snapshot. Subsequent scan on the data will appear to be out of order, which is actually a wrong result being returned in the middle. The issue does not affect txnkv API, as txnkv key encoding avoids the buggy case.\r\n\r\nInvestigated with @Little-Wallace and @Connor1996 ."
    },
    {
      "id": 613780868,
      "user": "zhangjinpeng87",
      "created_at": "2020-04-15T02:35:11Z",
      "body": "https://github.com/tikv/tikv/pull/7420 has fixed this issue."
    }
  ]
}