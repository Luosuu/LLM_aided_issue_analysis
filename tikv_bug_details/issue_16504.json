{
  "issue_number": 16504,
  "title": "Stale peer may cause resolve ts doesn't push",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nv6.5.4\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\n<img width=\"1741\" alt=\"image\" src=\"https://github.com/tikv/tikv/assets/26020263/48e9a8f4-6887-4892-8935-5ff780f81469\">\r\n\r\nRelated log are following:\r\n\r\n```log\r\n\"[2024/01/26 07:12:21.299 +00:00] [INFO] [store.rs:624] [\\\"raft message is stale, tell to gc\\\"] [to_peer_store_id=277] [to_peer_id=1041669428] [msg_type=MsgAppendResponse] [current_region_epoch=\\\"conf_ver: 208216 version: 6072877\\\"] [region_id=1041669023]\"\r\n```\r\n\r\n```log\r\n\"[2024/01/26 07:12:21.280 +00:00] [INFO] [apply.rs:2385] [\\\"conf change successfully\\\"] [\\\"current region\\\"=\\\"id: 1041669023 start_key: ? end_key: ? region_epoch { conf_ver: 208211 version: 6072877 } peers { id: 1041669428 store_id: 277 role: DemotingVoter } peers { id: 1041669430 store_id: 477403250 role: DemotingVoter } peers { id: 1041669429 store_id: 478557948 } peers { id: 1041672161 store_id: 282 role: IncomingVoter } peers { id: 1041672162 store_id: 20296629 role: IncomingVoter }\\\"] [\\\"original region\\\"=\\\"id: 1041669023 start_key: ? end_key: ? region_epoch { conf_ver: 208207 version: 6072877 } peers { id: 1041669428 store_id: 277 } peers { id: 1041669430 store_id: 477403250 } peers { id: 1041669429 store_id: 478557948 } peers { id: 1041672161 store_id: 282 role: Learner } peers { id: 1041672162 store_id: 20296629 role: Learner }\\\"] [changes=\\\"[peer { id: 1041672161 store_id: 282 }, peer { id: 1041672162 store_id: 20296629 }, change_type: AddLearnerNode peer { id: 1041669428 store_id: 277 role: Learner }, change_type: AddLearnerNode peer { id: 1041669430 store_id: 477403250 role: Learner }]\\\"] [peer_id=1041669428] [region_id=1041669023]\" \r\n\r\n\"[2024/01/26 07:12:21.287 +00:00] [INFO] [apply.rs:2415] [\\\"leave joint state successfully\\\"] [region=\\\"id: 1041669023 start_key: ? end_key: ? region_epoch { conf_ver: 208215 version: 6072877 } peers { id: 1041669428 store_id: 277 role: Learner } peers { id: 1041669430 store_id: 477403250 role: Learner } peers { id: 1041669429 store_id: 478557948 } peers { id: 1041672161 store_id: 282 } peers { id: 1041672162 store_id: 20296629 }\\\"] [peer_id=1041669428] [region_id=1041669023]\" \r\n\r\n\"[2024/01/26 07:12:21.300 +00:00] [INFO] [peer.rs:2951] [\\\"receive stale gc message, ignore.\\\"] [peer_id=1041669428] [region_id=1041669023]\"\r\n...\r\n...\r\n\"[2024/01/26 07:12:35.591 +00:00] [INFO] [endpoint.rs:888] [\\\"the max gap of safe-ts is large\\\"] [\\\"min start ts\\\"=None] [\\\"lock num\\\"=None] [advance-ts-interval=ReadableDuration(2s)] [\\\"region id\\\"=1041669023] [\\\"oldest safe-ts\\\"=447284022796091414] [gap=16851]\"\r\n...\r\n...\r\n\"[2024/01/26 07:31:46.352 +00:00] [INFO] [endpoint.rs:888] [\\\"the max gap of safe-ts is large\\\"] [\\\"min start ts\\\"=None] [\\\"lock num\\\"=None] [advance-ts-interval=ReadableDuration(2s)] [\\\"region id\\\"=1041669023] [\\\"oldest safe-ts\\\"=447284022796091414] [gap=1167601]\"\r\n...\r\n...\r\n\r\n\"[2024/01/26 07:31:47.457 +00:00] [INFO] [store.rs:624] [\\\"raft message is stale, tell to gc\\\"] [to_peer_store_id=277] [to_peer_id=1041669428] [msg_type=MsgHup] [current_region_epoch=\\\"conf_ver: 208217 version: 6072877\\\"] [region_id=1041669023]\"\r\n\"[2024/01/26 07:31:47.457 +00:00] [INFO] [peer.rs:2960] [\\\"receives gc message, trying to remove\\\"] [to_peer=\\\"id: 1041669428 store_id: 277 role: Learner\\\"] [peer_id=1041669428] [region_id=1041669023]\"\r\n\"[2024/01/26 07:31:47.457 +00:00] [INFO] [apply.rs:3723] [\\\"remove delegate from apply delegates\\\"] [peer_id=1041669428] [region_id=1041669023]\"\r\n\"[2024/01/26 07:31:47.457 +00:00] [INFO] [peer.rs:1461] [\\\"begin to destroy\\\"] [peer_id=1041669428] [region_id=1041669023]\"\r\n\"[2024/01/26 07:31:47.460 +00:00] [INFO] [peer.rs:1565] [\\\"peer destroy itself\\\"] [keep_data=false] [clean=true] [takes=2.868957ms] [peer_id=1041669428] [region_id=1041669023]\"\r\n\"[2024/01/26 07:31:47.460 +00:00] [INFO] [router.rs:345] [\\\"[region 1041669023] shutdown mailbox\\\"]\"\r\n```\r\n\r\nThe region peers that safe-ts did not advance were 1041669428.  And the peer 1041669428 received a gc message at `07:12:21.300`, but ignored it, and then the peer's safe-ts started not advancing(blocked resolve ts too). Then the peer sent itself a GC message until `07:31:47.457` and started destroying the peer.\r\n\r\nWhy does the peer ignore gc message when it receives it at the first time  `07:12:21.300`? I think the [check code](https://github.com/tikv/tikv/blob/0812e2f85633093991c01b826c77392aff7bfc02/components/raftstore/src/store/fsm/peer.rs#L2944) has some bug. \r\n\r\n```rust\r\n        if self.fsm.peer.peer != *msg.get_to_peer() {\r\n            info!(\r\n                \"receive stale gc message, ignore.\";\r\n                \"region_id\" => self.fsm.region_id(),\r\n                \"peer_id\" => self.fsm.peer_id(),\r\n            );\r\n            self.ctx.raft_metrics.message_dropped.stale_msg.inc();\r\n            return;\r\n        }\r\n```\r\n\r\nThe check should only compare the peer id instead of comparing all peer info, like this PR change https://github.com/tikv/tikv/pull/16505? I see that the role of this peer changes in the log. At `07:12:21.280`, the role becomes `DemotingVoter`, and at `07:12:21.287`, the role becomes `Learner`. Since the role changed, with upper check, the stale peer will ignore the gc message and start block resolve ts to push.\r\n\r\n",
  "state": "closed",
  "created_at": "2024-02-06T03:52:33Z",
  "updated_at": "2024-04-02T12:48:18Z",
  "closed_at": "2024-04-02T12:48:18Z",
  "labels": [
    "type/bug",
    "severity/major",
    "affects-6.5",
    "affects-7.1",
    "affects-7.5"
  ],
  "comments_data": []
}