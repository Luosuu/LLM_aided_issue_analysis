{
  "issue_number": 11588,
  "title": "TiKV panic on restart when `storage.enable_ttl=true`",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n5.3.0\r\n\r\n\r\n\r\n### Steps to reproduce\r\n\r\n1. Start TiKV v5.3.0 with this config:\r\n```toml\r\n[storage]\r\nenable-ttl = true\r\n```\r\n\r\n2. Write data using TiKV client (not TiDB).\r\n3. Restart the TiKV.\r\n\r\n### What did happened?\r\n\r\n```\r\ntikv quit: exit status 1\r\nency-checks\\\":false,\\\"prop-size-index-distance\\\":4194304,\\\"prop-keys-index-distance\\\":40960,\\\"enable-doubly-skiplist\\\":true,\\\"enable-compaction-guard\\\":true,\\\"compaction-guard-min-output-file-size\\\":\\\"8MiB\\\",\\\"compaction-guard-max-output-file-size\\\":\\\"128MiB\\\",\\\"bottommost-level-compression\\\":\\\"zstd\\\",\\\"bottommost-zstd-compression-dict-size\\\":0,\\\"bottommost-zstd-compression-sample-size\\\":0,\\\"titan\\\":{\\\"min-blob-size\\\":\\\"1KiB\\\",\\\"blob-file-compression\\\":\\\"lz4\\\",\\\"blob-cache-size\\\":\\\"0KiB\\\",\\\"min-gc-batch-size\\\":\\\"16MiB\\\",\\\"max-gc-batch-size\\\":\\\"64MiB\\\",\\\"discardable-ratio\\\":0.5,\\\"sample-ratio\\\":0.1,\\\"merge-small-file-threshold\\\":\\\"8MiB\\\",\\\"blob-run-mode\\\":\\\"read-only\\\",\\\"level-merge\\\":false,\\\"range-merge\\\":true,\\\"max-sorted-runs\\\":20,\\\"gc-merge-rewrite\\\":false}},\\\"lockcf\\\":{\\\"block-size\\\":\\\"16KiB\\\",\\\"block-cache-size\\\":\\\"1GiB\\\",\\\"disable-block-cache\\\":false,\\\"cache-index-and-filter-blocks\\\":true,\\\"pin-l0-filter-and-index-blocks\\\":true,\\\"use-bloom-filter\\\":true,\\\"optimize-filters-for-hits\\\":false,\\\"whole-key-filtering\\\":true,\\\"bloom-filter-bits-per-key\\\":10,\\\"block-based-bloom-filter\\\":false,\\\"read-amp-bytes-per-bit\\\":0,\\\"compression-per-level\\\":[\\\"no\\\",\\\"no\\\",\\\"no\\\",\\\"no\\\",\\\"no\\\",\\\"no\\\",\\\"no\\\"],\\\"write-buffer-size\\\":\\\"32MiB\\\",\\\"max-write-buffer-number\\\":5,\\\"min-write-buffer-number-to-merge\\\":1,\\\"max-bytes-for-level-base\\\":\\\"128MiB\\\",\\\"target-file-size-base\\\":\\\"8MiB\\\",\\\"level0-file-num-compaction-trigger\\\":1,\\\"level0-slowdown-writes-trigger\\\":20,\\\"level0-stop-writes-trigger\\\":36,\\\"max-compaction-bytes\\\":\\\"2GiB\\\",\\\"compaction-pri\\\":0,\\\"dynamic-level-bytes\\\":true,\\\"num-levels\\\":7,\\\"max-bytes-for-level-multiplier\\\":10,\\\"compaction-style\\\":0,\\\"disable-auto-compactions\\\":false,\\\"disable-write-stall\\\":true,\\\"soft-pending-compaction-bytes-limit\\\":\\\"192GiB\\\",\\\"hard-pending-compaction-bytes-limit\\\":\\\"256GiB\\\",\\\"force-consistency-checks\\\":false,\\\"prop-size-index-distance\\\":4194304,\\\"prop-keys-index-distance\\\":40960,\\\"enable-doubly-skiplist\\\":true,\\\"enable-compaction-guard\\\":false,\\\"compaction-guard-min-output-file-size\\\":\\\"8MiB\\\",\\\"compaction-guard-max-output-file-size\\\":\\\"128MiB\\\",\\\"bottommost-level-compression\\\":\\\"disable\\\",\\\"bottommost-zstd-compression-dict-size\\\":0,\\\"bottommost-zstd-compression-sample-size\\\":0,\\\"titan\\\":{\\\"min-blob-size\\\":\\\"1KiB\\\",\\\"blob-file-compression\\\":\\\"lz4\\\",\\\"blob-cache-size\\\":\\\"0KiB\\\",\\\"min-gc-batch-size\\\":\\\"16MiB\\\",\\\"max-gc-batch-size\\\":\\\"64MiB\\\",\\\"discardable-ratio\\\":0.5,\\\"sample-ratio\\\":0.1,\\\"merge-small-file-threshold\\\":\\\"8MiB\\\",\\\"blob-run-mode\\\":\\\"read-only\\\",\\\"level-merge\\\":false,\\\"range-merge\\\":true,\\\"max-sorted-runs\\\":20,\\\"gc-merge-rewrite\\\":false}},\\\"raftcf\\\":{\\\"block-size\\\":\\\"16KiB\\\",\\\"block-cache-size\\\":\\\"128MiB\\\",\\\"disable-block-cache\\\":false,\\\"cache-index-and-filter-blocks\\\":true,\\\"pin-l0-filter-and-index-blocks\\\":true,\\\"use-bloom-filter\\\":true,\\\"optimize-filters-for-hits\\\":true,\\\"whole-key-filtering\\\":true,\\\"bloom-filter-bits-per-key\\\":10,\\\"block-based-bloom-filter\\\":false,\\\"read-amp-bytes-per-bit\\\":0,\\\"compression-per-level\\\":[\\\"no\\\",\\\"no\\\",\\\"no\\\",\\\"no\\\",\\\"no\\\",\\\"no\\\",\\\"no\\\"],\\\"write-buffer-size\\\":\\\"128MiB\\\",\\\"max-write-buffer-number\\\":5,\\\"min-write-buffer-number-to-merge\\\":1,\\\"max-bytes-for-level-base\\\":\\\"128MiB\\\",\\\"target-file-size-base\\\":\\\"8MiB\\\",\\\"level0-file-num-compaction-trigger\\\":1,\\\"level0-slowdown-writes-trigger\\\":20,\\\"level0-stop-writes-trigger\\\":36,\\\"max-compaction-bytes\\\":\\\"2GiB\\\",\\\"compaction-pri\\\":0,\\\"dynamic-level-bytes\\\":true,\\\"num-levels\\\":7,\\\"max-bytes-for-level-multiplier\\\":10,\\\"compaction-style\\\":0,\\\"disable-auto-compactions\\\":false,\\\"disable-write-stall\\\":true,\\\"soft-pending-compaction-bytes-limit\\\":\\\"192GiB\\\",\\\"hard-pending-compaction-bytes-limit\\\":\\\"256GiB\\\",\\\"force-consistency-checks\\\":false,\\\"prop-size-index-distance\\\":4194304,\\\"prop-keys-index-distance\\\":40960,\\\"enable-doubly-skiplist\\\":true,\\\"enable-compaction-guard\\\":false,\\\"compaction-guard-min-output-file-size\\\":\\\"8MiB\\\",\\\"compaction-guard-max-output-file-size\\\":\\\"128MiB\\\",\\\"bottommost-level-compression\\\":\\\"disable\\\",\\\"bottommost-zstd-compression-dict-size\\\":0,\\\"bottommost-zstd-compression-sample-size\\\":0,\\\"titan\\\":{\\\"min-blob-size\\\":\\\"1KiB\\\",\\\"blob-file-compression\\\":\\\"lz4\\\",\\\"blob-cache-size\\\":\\\"0KiB\\\",\\\"min-gc-batch-size\\\":\\\"16MiB\\\",\\\"max-gc-batch-size\\\":\\\"64MiB\\\",\\\"discardable-ratio\\\":0.5,\\\"sample-ratio\\\":0.1,\\\"merge-small-file-threshold\\\":\\\"8MiB\\\",\\\"blob-run-mode\\\":\\\"read-only\\\",\\\"level-merge\\\":false,\\\"range-merge\\\":true,\\\"max-sorted-runs\\\":20,\\\"gc-merge-rewrite\\\":false}},\\\"titan\\\":{\\\"enabled\\\":false,\\\"dirname\\\":\\\"\\\",\\\"disable-gc\\\":false,\\\"max-background-gc\\\":4,\\\"purge-obsolete-files-period\\\":\\\"10s\\\"}},\\\"raftdb\\\":{\\\"wal-recovery-mode\\\":2,\\\"wal-dir\\\":\\\"\\\",\\\"wal-ttl-seconds\\\":0,\\\"wal-size-limit\\\":\\\"0KiB\\\",\\\"max-total-wal-size\\\":\\\"4GiB\\\",\\\"max-background-jobs\\\":4,\\\"max-background-flushes\\\":1,\\\"max-manifest-file-size\\\":\\\"20MiB\\\",\\\"create-if-missing\\\":true,\\\"max-open-files\\\":40960,\\\"enable-statistics\\\":true,\\\"stats-dump-period\\\":\\\"10m\\\",\\\"compaction-readahead-size\\\":\\\"0KiB\\\",\\\"info-log-max-size\\\":\\\"1GiB\\\",\\\"info-log-roll-time\\\":\\\"0s\\\",\\\"info-log-keep-log-file-num\\\":10,\\\"info-log-dir\\\":\\\"\\\",\\\"info-log-level\\\":\\\"info\\\",\\\"max-sub-compactions\\\":2,\\\"writable-file-max-buffer-size\\\":\\\"1MiB\\\",\\\"use-direct-io-for-flush-and-compaction\\\":false,\\\"enable-pipelined-write\\\":true,\\\"enable-unordered-write\\\":false,\\\"allow-concurrent-memtable-write\\\":true,\\\"bytes-per-sync\\\":\\\"1MiB\\\",\\\"wal-bytes-per-sync\\\":\\\"512KiB\\\",\\\"defaultcf\\\":{\\\"block-size\\\":\\\"64KiB\\\",\\\"block-cache-size\\\":\\\"2GiB\\\",\\\"disable-block-cache\\\":false,\\\"cache-index-and-filter-blocks\\\":true,\\\"pin-l0-filter-and-index-blocks\\\":true,\\\"use-bloom-filter\\\":false,\\\"optimize-filters-for-hits\\\":true,\\\"whole-key-filtering\\\":true,\\\"bloom-filter-bits-per-key\\\":10,\\\"block-based-bloom-filter\\\":false,\\\"read-amp-bytes-per-bit\\\":0,\\\"compression-per-level\\\":[\\\"no\\\",\\\"no\\\",\\\"lz4\\\",\\\"lz4\\\",\\\"lz4\\\",\\\"zstd\\\",\\\"zstd\\\"],\\\"write-buffer-size\\\":\\\"128MiB\\\",\\\"max-write-buffer-number\\\":5,\\\"min-write-buffer-number-to-merge\\\":1,\\\"max-bytes-for-level-base\\\":\\\"512MiB\\\",\\\"target-file-size-base\\\":\\\"8MiB\\\",\\\"level0-file-num-compaction-trigger\\\":4,\\\"level0-slowdown-writes-trigger\\\":10000,\\\"level0-stop-writes-trigger\\\":10000,\\\"max-compaction-bytes\\\":\\\"2GiB\\\",\\\"compaction-pri\\\":0,\\\"dynamic-level-bytes\\\":true,\\\"num-levels\\\":7,\\\"max-bytes-for-level-multiplier\\\":10,\\\"compaction-style\\\":0,\\\"disable-auto-compactions\\\":false,\\\"disable-write-stall\\\":false,\\\"soft-pending-compaction-bytes-limit\\\":\\\"0KiB\\\",\\\"hard-pending-compaction-bytes-limit\\\":\\\"0KiB\\\",\\\"force-consistency-checks\\\":false,\\\"prop-size-index-distance\\\":4194304,\\\"prop-keys-index-distance\\\":40960,\\\"enable-doubly-skiplist\\\":true,\\\"enable-compaction-guard\\\":false,\\\"compaction-guard-min-output-file-size\\\":\\\"8MiB\\\",\\\"compaction-guard-max-output-file-size\\\":\\\"128MiB\\\",\\\"bottommost-level-compression\\\":\\\"disable\\\",\\\"bottommost-zstd-compression-dict-size\\\":0,\\\"bottommost-zstd-compression-sample-size\\\":0,\\\"titan\\\":{\\\"min-blob-size\\\":\\\"1KiB\\\",\\\"blob-file-compression\\\":\\\"lz4\\\",\\\"blob-cache-size\\\":\\\"0KiB\\\",\\\"min-gc-batch-size\\\":\\\"16MiB\\\",\\\"max-gc-batch-size\\\":\\\"64MiB\\\",\\\"discardable-ratio\\\":0.5,\\\"sample-ratio\\\":0.1,\\\"merge-small-file-threshold\\\":\\\"8MiB\\\",\\\"blob-run-mode\\\":\\\"normal\\\",\\\"level-merge\\\":false,\\\"range-merge\\\":true,\\\"max-sorted-runs\\\":20,\\\"gc-merge-rewrite\\\":false}},\\\"titan\\\":{\\\"enabled\\\":false,\\\"dirname\\\":\\\"\\\",\\\"disable-gc\\\":false,\\\"max-background-gc\\\":4,\\\"purge-obsolete-files-period\\\":\\\"10s\\\"}},\\\"raft-engine\\\":{\\\"enable\\\":false,\\\"dir\\\":\\\"/disk1/home/andy/.tiup/data/test/tikv-0/data/raft-engine\\\",\\\"recovery-mode\\\":\\\"tolerate-corrupted-tail-records\\\",\\\"bytes-per-sync\\\":\\\"256KiB\\\",\\\"target-file-size\\\":\\\"128MiB\\\",\\\"purge-threshold\\\":\\\"10GiB\\\",\\\"batch-compression-threshold\\\":\\\"8KiB\\\"},\\\"security\\\":{\\\"ca-path\\\":\\\"\\\",\\\"cert-path\\\":\\\"\\\",\\\"key-path\\\":\\\"\\\",\\\"cert-allowed-cn\\\":[],\\\"redact-info-log\\\":null,\\\"encryption\\\":{\\\"data-encryption-method\\\":\\\"plaintext\\\",\\\"data-key-rotation-period\\\":\\\"7d\\\",\\\"enable-file-dictionary-log\\\":true,\\\"file-dictionary-rewrite-threshold\\\":1000000,\\\"master-key\\\":{\\\"type\\\":\\\"plaintext\\\"},\\\"previous-master-key\\\":{\\\"type\\\":\\\"plaintext\\\"}}},\\\"import\\\":{\\\"num-threads\\\":8,\\\"stream-channel-window\\\":128,\\\"import-mode-timeout\\\":\\\"10m\\\"},\\\"backup\\\":{\\\"num-threads\\\":30,\\\"batch-size\\\":8,\\\"sst-max-size\\\":\\\"144MiB\\\",\\\"enable-auto-tune\\\":false,\\\"auto-tune-remain-threads\\\":2,\\\"auto-tune-refresh-interval\\\":\\\"1m\\\",\\\"hadoop\\\":{\\\"home\\\":\\\"\\\",\\\"linux-user\\\":\\\"\\\"}},\\\"pessimistic-txn\\\":{\\\"wait-for-lock-timeout\\\":\\\"1s\\\",\\\"wake-up-delay-duration\\\":\\\"20ms\\\",\\\"pipelined\\\":true},\\\"gc\\\":{\\\"ratio-threshold\\\":1.1,\\\"batch-keys\\\":512,\\\"max-write-bytes-per-sec\\\":\\\"0KiB\\\",\\\"enable-compaction-filter\\\":true,\\\"compaction-filter-skip-version-check\\\":false},\\\"split\\\":{\\\"qps-threshold\\\":3000,\\\"split-balance-score\\\":0.25,\\\"split-contained-score\\\":0.5,\\\"detect-times\\\":10,\\\"sample-num\\\":20,\\\"sample-threshold\\\":100,\\\"byte-threshold\\\":31457280},\\\"cdc\\\":{\\\"min-ts-interval\\\":\\\"1s\\\",\\\"hibernate-regions-compatible\\\":true,\\\"incremental-scan-threads\\\":4,\\\"incremental-scan-concurrency\\\":6,\\\"incremental-scan-speed-limit\\\":\\\"128MiB\\\",\\\"sink-memory-quota\\\":\\\"512MiB\\\",\\\"old-value-cache-memory-quota\\\":\\\"512MiB\\\"},\\\"resolved-ts\\\":{\\\"enable\\\":true,\\\"advance-ts-interval\\\":\\\"1s\\\",\\\"scan-lock-pool-size\\\":2},\\\"resource-metering\\\":{\\\"enabled\\\":false,\\\"receiver-address\\\":\\\"\\\",\\\"report-receiver-interval\\\":\\\"1m\\\",\\\"max-resource-groups\\\":2000,\\\"precision\\\":\\\"1s\\\"}}\"]\r\n[2021/12/06 23:04:55.522 +08:00] [INFO] [mod.rs:118] [\"encryption: none of key dictionary and file dictionary are found.\"]\r\n[2021/12/06 23:04:55.522 +08:00] [INFO] [mod.rs:479] [\"encryption is disabled.\"]\r\n[2021/12/06 23:04:55.522 +08:00] [ERROR] [server.rs:1052] [\"failed to init io snooper\"] [err_code=KV:Unknown] [err=\"\\\"IO snooper is not started due to not compiling with BCC\\\"\"]\r\n[2021/12/06 23:04:55.640 +08:00] [INFO] [mod.rs:227] [\"Storage started.\"]\r\n[2021/12/06 23:04:55.641 +08:00] [ERROR] [node.rs:279] [\"unable to switch `storage.api_version`\"] [\"found data key that is not written by TiDB\"=6B31] [target=V1ttl] [current=V1]\r\n[2021/12/06 23:04:55.641 +08:00] [FATAL] [server.rs:732] [\"failed to bootstrap node id: \\\"[src/server/node.rs:285]: unable to switch `storage.api_version` from V1 to V1ttl because found data key that is not written by TiDB: \\\\\\\"6B31\\\\\\\"\\\"\"]\r\n```\r\n",
  "state": "closed",
  "created_at": "2021-12-06T15:48:43Z",
  "updated_at": "2021-12-07T17:02:36Z",
  "closed_at": "2021-12-07T17:02:36Z",
  "labels": [
    "type/bug",
    "priority/critical"
  ],
  "comments_data": []
}