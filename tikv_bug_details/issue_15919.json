{
  "issue_number": 15919,
  "title": "Stale peers are left forever after region merge",
  "body": "## Bug Report\r\n\r\nA \"stale peer\" refers to a peer that still exists on a TiKV node but has been\r\nremoved from the raft group, typically through a confchange operation.\r\nTiKV performs regular checks and validations on its peers to ensure that no such\r\nstale peer exists.\r\n\r\nHowever, the presence of the TODO below creates a situation where stale peers\r\ncannot be removed after the corresponding region is merged.\r\n\r\nhttps://github.com/tikv/tikv/blob/e0fe14d57136f645457bcf14ee5ae1a478be04b8/components/raftstore/src/store/worker/pd.rs#L1569-L1572\r\n\r\n**It wastes cpu and memory and blocks resolved ts.**\r\n\r\n\r\n<!--\r\n\r\npd\r\n```log\r\n[2023/11/01 17:41:41.379 +08:00] [INFO] [region.go:735] [\"region Version changed\"] [region-id=906] [detail=\"StartKey Changed:{7480000000000000FF775F72800000001EFF143B440000000000FA} -> {7480000000000000FF775F72800000001DFFCFC94A0000000000FA}, EndKey:{7480000000000000FF7800000000000000F8}\"] [old-version=171] [new-version=175]\r\n[2023/11/01 17:41:41.600 +08:00] [INFO] [operator_controller.go:464] [\"add operator\"] [region-id=906] [operator=\"\\\"merge-region {merge: region 906 to 1747} (kind:merge,region,leader, region:906(175, 31), createAt:2023-11-01 17:41:41.60077071 +0800 CST m=+11383.180666476, startAt:0001-01-01 00:00:00 +0000 UTC, currentStep:0, size:2, steps:[0:{add learner peer 43228 on store 1}, 1:{add learner peer 43227 on store 343}, 2:{transfer leader from store 313 to store 13}, 3:{use joint consensus, promote learner peer 43228 on store 1 to voter, promote learner peer 43227 on store 343 to voter, demote voter peer 23838 on store 12 to learner, demote voter peer 909 on store 313 to learner}, 4:{leave joint state, promote learner peer 43228 on store 1 to voter, promote learner peer 43227 on store 343 to voter, demote voter peer 23838 on store 12 to learner, demote voter peer 909 on store 313 to learner}, 5:{remove peer on store 12}, 6:{remove peer on store 313}, 7:{merge region 906 into region 1747}], timeout:[43m0s])\\\"\"] [additional-info=\"{\\\"related merge region\\\":\\\"1747\\\"}\"]\r\n[2023/11/01 17:41:42.064 +08:00] [INFO] [region.go:735] [\"region Version changed\"] [region-id=1747] [detail=\"StartKey Changed:{7480000000000000FF7800000000000000F8} -> {7480000000000000FF775F72800000001DFFCFC94A0000000000FA}, EndKey:{7480000000000000FF785F728000000000FF0017240000000000FA}\"] [old-version=96] [new-version=177]\r\n```\r\n\r\ntikv 7\r\n```\r\n[2023/11/01 15:45:34.900 +08:00] [INFO] [peer.rs:321] [\"replicate peer\"] [store_id=304] [peer_id=1537] [region_id=906] [thread_id=0x5]\r\n[2023/11/01 15:45:34.900 +08:00] [INFO] [raft.rs:2660] [\"switched to configuration\"] [config=\"Configuration { voters: Configuration { incoming: Configuration { voters: {} }, outgoing: Configuration>[2023/11/01 15:45:34.900 +08:00] [INFO] [raft.rs:1127] [\"became follower at term 0\"] [term=0] [raft_id=1537] [region_id=906] [thread_id=0x5]\r\n[2023/11/01 15:45:34.900 +08:00] [INFO] [raft.rs:388] [newRaft] [peers=\"Configuration { incoming: Configuration { voters: {} }, outgoing: Configuration { voters: {} } }\"] [\"last term\"=0] [\"last ind>[2023/11/01 15:45:34.900 +08:00] [INFO] [raw_node.rs:315] [\"RawNode created with id 1537.\"] [id=1537] [raft_id=1537] [region_id=906] [thread_id=0x5]\r\n[2023/11/01 15:45:34.900 +08:00] [INFO] [raft.rs:1362] [\"received a message with higher term from 909\"] [\"msg type\"=MsgHeartbeat] [message_term=7] [term=0] [from=909] [raft_id=1537] [region_id=906]>[2023/11/01 15:45:34.900 +08:00] [INFO] [raft.rs:1127] [\"became follower at term 7\"] [term=7] [raft_id=1537] [region_id=906] [thread_id=0x5]\r\n[2023/11/01 16:03:47.299 +08:00] [INFO] [endpoint.rs:622] [\"the max gap of follower resolved-ts is large\"] [oldest_candidate=\"Some(ReadState { idx: 6532, ts: 445336706315190279 })\"] [latest_candida>[2023/11/01 16:03:57.300 +08:00] [INFO] [endpoint.rs:622] [\"the max gap of follower resolved-ts is large\"] [oldest_candidate=\"Some(ReadState { idx: 6532, ts: 445336706315190279 })\"] [latest_candida>\r\n\r\n[2023/11/01 18:05:34.997 +08:00] [WARN] [peer.rs:6382] [\"leader missing longer than max_leader_missing_duration. To check with pd and other peers whether it's still valid\"] [expect=2h] [peer_id=153>\r\n```\r\n\r\ntikv 6\r\n```\r\n[2023/11/01 16:00:23.902 +08:00] [WARN] [peer_storage.rs:515] [\"failed to try generating snapshot\"] [request_peer=1537] [times=1] [peer_id=909] [region_id=906] [thread_id=0x5]\r\n[2023/11/01 16:00:23.902 +08:00] [INFO] [peer_storage.rs:547] [\"requesting snapshot\"] [request_peer=1537] [request_index=0] [peer_id=909] [region_id=906] [thread_id=0x5]\r\n[2023/11/01 16:01:15.880 +08:00] [INFO] [peer.rs:1307] [\"deleting compacted snap file\"] [snap_file=906_7_73526] [peer_id=909] [region_id=906] [thread_id=0x5]\r\n[2023/11/01 16:02:35.741 +08:00] [INFO] [snap.rs:914] [\"scan snapshot of one cf\"] [size=10179124479] [key_count=521473] [cf=default] [snapshot=/var/lib/tikv/data/snap/gen_906_7_82250_(default|lock|>[2023/11/01 16:02:35.745 +08:00] [INFO] [snap.rs:914] [\"scan snapshot of one cf\"] [size=0] [key_count=0] [cf=lock] [snapshot=/var/lib/tikv/data/snap/gen_906_7_82250_(default|lock|write).sst] [regio>[2023/11/01 16:02:36.480 +08:00] [INFO] [snap.rs:914] [\"scan snapshot of one cf\"] [size=58926449] [key_count=1042946] [cf=write] [snapshot=/var/lib/tikv/data/snap/gen_906_7_82250_(default|lock|writ>[2023/11/01 16:02:36.481 +08:00] [INFO] [snap.rs:1088] [\"scan snapshot\"] [takes=132.578462083s] [size=7678717747] [key_count=1564419] [snapshot=/var/lib/tikv/data/snap/gen_906_7_82250_(default|lock>[2023/11/01 16:02:36.481 +08:00] [WARN] [peer_storage.rs:515] [\"failed to try generating snapshot\"] [request_peer=1537] [times=1] [peer_id=909] [region_id=906] [thread_id=0x5]\r\n[2023/11/01 16:02:36.481 +08:00] [INFO] [peer_storage.rs:547] [\"requesting snapshot\"] [request_peer=1537] [request_index=0] [peer_id=909] [region_id=906] [thread_id=0x5]\r\n[2023/11/01 16:03:15.884 +08:00] [INFO] [peer.rs:1307] [\"deleting compacted snap file\"] [snap_file=906_7_82250] [peer_id=909] [region_id=906] [thread_id=0x5]\r\n\r\n[2023/11/01 16:03:28.468 +08:00] [INFO] [apply.rs:1691] [\"execute admin command\"] [command=\"cmd_type: ChangePeerV2 change_peer_v2 { changes { change_type: RemoveNode peer { id: 1537 store_id: 304 role: Learner } } }\"] [index=95876] [term=7] [peer_id=909] [region_id=906] [thread_id=0x5]\r\n[2023/11/01 16:03:28.468 +08:00] [INFO] [apply.rs:2285] [\"exec ConfChangeV2\"] [epoch=\"conf_ver: 24 version: 77\"] [kind=Simple] [peer_id=909] [region_id=906] [thread_id=0x5]\r\n[2023/11/01 16:03:28.468 +08:00] [INFO] [apply.rs:2466] [\"conf change successfully\"] [\"current region\"=\"id: 906 start_key: 7480000000000000FF7700000000000000F8 end_key: 7480000000000000FF7800000000000000F8 region_epoch { conf_ver: 25 version: 77 } peers { id: 909 store_id: 313 } peers { id: 967 store_id: 13 } peers { id: 994 store_id: 358 }\"] [\"original region\"=\"id: 906 start_key: 7480000000000000FF7700000000000000F8 end_key: 7480000000000000FF7800000000000000F8 region_epoch { conf_ver: 24 version: 77 } peers { id: 909 store_id: 313 } peers { id: 967 store_id: 13 } peers { id: 994 store_id: 358 } peers { id: 1537 store_id: 304 role: Learner }\"] [changes=\"[change_type: RemoveNode peer { id: 1537 store_id: 304 role: Learner }]\"] [peer_id=909] [region_id=906] [thread_id=0x5]\r\n[2023/11/01 16:03:28.469 +08:00] [INFO] [raft.rs:2660] [\"switched to configuration\"] [config=\"Configuration { voters: Configuration { incoming: Configuration { voters: {909, 994, 967} }, outgoing: Configuration { voters: {} } }, learners: {}, learners_next: {}, auto_leave: false }\"] [raft_id=909] [region_id=906] [thread_id=0x5]\r\n-->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n\r\nv7.5.0\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nIt's an egde case, cannot reproduce reliably. Generally, run a workload with multiple hotspots.\r\n\r\n### What did you expect?\r\n\r\nNo stale peer.\r\n\r\n### What did happened?\r\n\r\nStale peer.",
  "state": "closed",
  "created_at": "2023-11-04T05:01:20Z",
  "updated_at": "2023-11-08T07:56:14Z",
  "closed_at": "2023-11-08T07:56:14Z",
  "labels": [
    "type/bug",
    "severity/major",
    "affects-4.0",
    "affects-5.0",
    "affects-5.1",
    "affects-5.2",
    "affects-5.3",
    "affects-5.4",
    "affects-6.0",
    "affects-6.1",
    "affects-6.2",
    "affects-6.3",
    "affects-6.4",
    "affects-6.5",
    "affects-6.6",
    "affects-7.0",
    "affects-7.1",
    "affects-7.2",
    "affects-7.3",
    "affects-7.4",
    "affects-7.5"
  ],
  "comments_data": []
}