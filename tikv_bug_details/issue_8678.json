{
  "issue_number": 8678,
  "title": "TiKV always starting a new election",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\nv4.0.0\r\n\r\n### What operating system and CPU are you using?\r\nN/A\r\n\r\n### Steps to reproduce\r\nAfter `tiup reload`, TiKV log shows many `starting a new election`.\r\n\r\nBelow is a segment of log file:\r\n```\r\n[2020/09/15 16:28:36.521 +08:00] [INFO] [raft.rs:923] [\"[logterm: 137, index: 641] sent request to 67872825\"] [msg=MsgRequestPreVote] [term=137] [id=67872825] [log_index=641] [log_term=137] [raft_id=67225761] [region_id=126612]\r\n[2020/09/15 16:28:36.521 +08:00] [INFO] [raft.rs:1177] [\"starting a new election\"] [term=121] [raft_id=68495591] [region_id=248686]\r\n[2020/09/15 16:28:36.521 +08:00] [INFO] [raft.rs:833] [\"became pre-candidate at term 121\"] [term=121] [raft_id=68495591] [region_id=248686]\r\n[2020/09/15 16:28:36.521 +08:00] [INFO] [raft.rs:902] [\"68495591 received message from 68495591\"] [term=121] [msg=MsgRequestPreVote] [from=68495591] [id=68495591] [raft_id=68495591] [region_id=248686]\r\n[2020/09/15 16:28:36.521 +08:00] [INFO] [raft.rs:923] [\"[logterm: 121, index: 7941] sent request to 67875394\"] [msg=MsgRequestPreVote] [term=121] [id=67875394] [log_index=7941] [log_term=121] [raft_id=68495591] [region_id=248686]\r\n[2020/09/15 16:28:36.521 +08:00] [INFO] [raft.rs:923] [\"[logterm: 121, index: 7941] sent request to 68558265\"] [msg=MsgRequestPreVote] [term=121] [id=68558265] [log_index=7941] [log_term=121] [raft_id=68495591] [region_id=248686]\r\n[2020/09/15 16:28:36.521 +08:00] [INFO] [raft.rs:783] [\"became follower at term 124\"] [term=124] [raft_id=67748222] [region_id=231557]\r\n[2020/09/15 16:28:36.521 +08:00] [INFO] [raft.rs:783] [\"became follower at term 104\"] [term=104] [raft_id=68255499] [region_id=68255496]\r\n[2020/09/15 16:28:36.521 +08:00] [INFO] [raft.rs:1177] [\"starting a new election\"] [term=132] [raft_id=67396660] [region_id=67396657]\r\n[2020/09/15 16:28:36.521 +08:00] [INFO] [raft.rs:833] [\"became pre-candidate at term 132\"] [term=132] [raft_id=67396660] [region_id=67396657]\r\n[2020/09/15 16:28:36.521 +08:00] [INFO] [raft.rs:902] [\"67396660 received message from 67396660\"] [term=132] [msg=MsgRequestPreVote] [from=67396660] [id=67396660] [raft_id=67396660] [region_id=67396657]\r\n[2020/09/15 16:28:36.521 +08:00] [INFO] [raft.rs:923] [\"[logterm: 132, index: 1145] sent request to 67396658\"] [msg=MsgRequestPreVote] [term=132] [id=67396658] [log_index=1145] [log_term=132] [raft_id=67396660] [region_id=67396657]\r\n[2020/09/15 16:28:36.522 +08:00] [INFO] [raft.rs:923] [\"[logterm: 132, index: 1145] sent request to 67396659\"] [msg=MsgRequestPreVote] [term=132] [id=67396659] [log_index=1145] [log_term=132] [raft_id=67396660] [region_id=67396657]\r\n[2020/09/15 16:28:36.522 +08:00] [INFO] [raft.rs:783] [\"became follower at term 88\"] [term=88] [raft_id=68419691] [region_id=68419690]\r\n[2020/09/15 16:28:36.522 +08:00] [INFO] [raft.rs:783] [\"became follower at term 159\"] [term=159] [raft_id=67700640] [region_id=293705]\r\n[2020/09/15 16:28:36.522 +08:00] [INFO] [raft.rs:1177] [\"starting a new election\"] [term=161] [raft_id=68286652] [region_id=73948]\r\n[2020/09/15 16:28:36.522 +08:00] [INFO] [raft.rs:833] [\"became pre-candidate at term 161\"] [term=161] [raft_id=68286652] [region_id=73948]\r\n[2020/09/15 16:28:36.522 +08:00] [INFO] [raft.rs:902] [\"68286652 received message from 68286652\"] [term=161] [msg=MsgRequestPreVote] [from=68286652] [id=68286652] [raft_id=68286652] [region_id=73948]\r\n[2020/09/15 16:28:36.522 +08:00] [INFO] [raft.rs:923] [\"[logterm: 161, index: 1733] sent request to 46841812\"] [msg=MsgRequestPreVote] [term=161] [id=46841812] [log_index=1733] [log_term=161] [raft_id=68286652] [region_id=73948]\r\n[2020/09/15 16:28:36.522 +08:00] [INFO] [raft.rs:923] [\"[logterm: 161, index: 1733] sent request to 67250414\"] [msg=MsgRequestPreVote] [term=161] [id=67250414] [log_index=1733] [log_term=161] [raft_id=68286652] [region_id=73948]\r\n[2020/09/15 16:28:36.522 +08:00] [INFO] [raft.rs:783] [\"became follower at term 306\"] [term=306] [raft_id=68378544] [region_id=466368]\r\n[2020/09/15 16:28:36.522 +08:00] [INFO] [raft.rs:783] [\"became follower at term 153\"] [term=153] [raft_id=67283345] [region_id=449005]\r\n[2020/09/15 16:28:36.522 +08:00] [INFO] [raft.rs:783] [\"became follower at term 50\"] [term=50] [raft_id=68584227] [region_id=29984]\r\n[2020/09/15 16:28:36.523 +08:00] [INFO] [raft.rs:783] [\"became follower at term 146\"] [term=146] [raft_id=68155023] [region_id=603285]\r\n[2020/09/15 16:28:36.523 +08:00] [INFO] [raft.rs:1177] [\"starting a new election\"] [term=149] [raft_id=67266656] [region_id=44488]\r\n[2020/09/15 16:28:36.523 +08:00] [INFO] [raft.rs:833] [\"became pre-candidate at term 149\"] [term=149] [raft_id=67266656] [region_id=44488]\r\n[2020/09/15 16:28:36.523 +08:00] [INFO] [raft.rs:902] [\"67266656 received message from 67266656\"] [term=149] [msg=MsgRequestPreVote] [from=67266656] [id=67266656] [raft_id=67266656] [region_id=44488]\r\n[2020/09/15 16:28:36.523 +08:00] [INFO] [raft.rs:923] [\"[logterm: 149, index: 297] sent request to 399941\"] [msg=MsgRequestPreVote] [term=149] [id=399941] [log_index=297] [log_term=149] [raft_id=67266656] [region_id=44488]\r\n[2020/09/15 16:28:36.523 +08:00] [INFO] [raft.rs:923] [\"[logterm: 149, index: 297] sent request to 67165535\"] [msg=MsgRequestPreVote] [term=149] [id=67165535] [log_index=297] [log_term=149] [raft_id=67266656] [region_id=44488]\r\n[2020/09/15 16:28:36.523 +08:00] [INFO] [raft.rs:783] [\"became follower at term 124\"] [term=124] [raft_id=68322454] [region_id=68322451]\r\n[2020/09/15 16:28:36.523 +08:00] [INFO] [raft.rs:1177] [\"starting a new election\"] [term=104] [raft_id=68391487] [region_id=664993]\r\n[2020/09/15 16:28:36.523 +08:00] [INFO] [raft.rs:833] [\"became pre-candidate at term 104\"] [term=104] [raft_id=68391487] [region_id=664993]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:902] [\"68391487 received message from 68391487\"] [term=104] [msg=MsgRequestPreVote] [from=68391487] [id=68391487] [raft_id=68391487] [region_id=664993]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:1177] [\"starting a new election\"] [term=146] [raft_id=67525057] [region_id=93000]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:833] [\"became pre-candidate at term 146\"] [term=146] [raft_id=67525057] [region_id=93000]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:923] [\"[logterm: 104, index: 23540] sent request to 664996\"] [msg=MsgRequestPreVote] [term=104] [id=664996] [log_index=23540] [log_term=104] [raft_id=68391487] [region_id=664993]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:902] [\"67525057 received message from 67525057\"] [term=146] [msg=MsgRequestPreVote] [from=67525057] [id=67525057] [raft_id=67525057] [region_id=93000]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:923] [\"[logterm: 104, index: 23540] sent request to 68128628\"] [msg=MsgRequestPreVote] [term=104] [id=68128628] [log_index=23540] [log_term=104] [raft_id=68391487] [region_id=664993]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:923] [\"[logterm: 146, index: 1268] sent request to 68254400\"] [msg=MsgRequestPreVote] [term=146] [id=68254400] [log_index=1268] [log_term=146] [raft_id=67525057] [region_id=93000]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:923] [\"[logterm: 146, index: 1268] sent request to 1083499\"] [msg=MsgRequestPreVote] [term=146] [id=1083499] [log_index=1268] [log_term=146] [raft_id=67525057] [region_id=93000]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:1177] [\"starting a new election\"] [term=116] [raft_id=67288417] [region_id=63416]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:833] [\"became pre-candidate at term 116\"] [term=116] [raft_id=67288417] [region_id=63416]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:902] [\"67288417 received message from 67288417\"] [term=116] [msg=MsgRequestPreVote] [from=67288417] [id=67288417] [raft_id=67288417] [region_id=63416]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:923] [\"[logterm: 116, index: 133] sent request to 63417\"] [msg=MsgRequestPreVote] [term=116] [id=63417] [log_index=133] [log_term=116] [raft_id=67288417] [region_id=63416]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:923] [\"[logterm: 116, index: 133] sent request to 63419\"] [msg=MsgRequestPreVote] [term=116] [id=63419] [log_index=133] [log_term=116] [raft_id=67288417] [region_id=63416]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:1177] [\"starting a new election\"] [term=118] [raft_id=67290942] [region_id=74608]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:833] [\"became pre-candidate at term 118\"] [term=118] [raft_id=67290942] [region_id=74608]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:902] [\"67290942 received message from 67290942\"] [term=118] [msg=MsgRequestPreVote] [from=67290942] [id=67290942] [raft_id=67290942] [region_id=74608]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:923] [\"[logterm: 118, index: 129] sent request to 148204\"] [msg=MsgRequestPreVote] [term=118] [id=148204] [log_index=129] [log_term=118] [raft_id=67290942] [region_id=74608]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:923] [\"[logterm: 118, index: 129] sent request to 74611\"] [msg=MsgRequestPreVote] [term=118] [id=74611] [log_index=129] [log_term=118] [raft_id=67290942] [region_id=74608]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:1177] [\"starting a new election\"] [term=83] [raft_id=68565313] [region_id=68391897]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:833] [\"became pre-candidate at term 83\"] [term=83] [raft_id=68565313] [region_id=68391897]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:902] [\"68565313 received message from 68565313\"] [term=83] [msg=MsgRequestPreVote] [from=68565313] [id=68565313] [raft_id=68565313] [region_id=68391897]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:923] [\"[logterm: 83, index: 59084] sent request to 68585855\"] [msg=MsgRequestPreVote] [term=83] [id=68585855] [log_index=59084] [log_term=83] [raft_id=68565313] [region_id=68391897]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:923] [\"[logterm: 83, index: 59084] sent request to 68475505\"] [msg=MsgRequestPreVote] [term=83] [id=68475505] [log_index=59084] [log_term=83] [raft_id=68565313] [region_id=68391897]\r\n[2020/09/15 16:28:36.524 +08:00] [INFO] [raft.rs:1177] [\"starting a new election\"] [term=73] [raft_id=67586043] [region_id=67586040]\r\n```\r\n\r\n",
  "state": "closed",
  "created_at": "2020-09-16T02:12:36Z",
  "updated_at": "2020-11-05T07:47:36Z",
  "closed_at": "2020-09-22T11:17:00Z",
  "labels": [
    "type/bug",
    "priority/high",
    "severity/major"
  ],
  "comments_data": [
    {
      "id": 696657168,
      "user": "hunterlxt",
      "created_at": "2020-09-22T11:17:00Z",
      "body": "Maybe because hibernate region is only enabled on some nodes but disabled on other nodes. Close hibernate among all nodes and the issue is resolved."
    },
    {
      "id": 722168778,
      "user": "zhangjinpeng87",
      "created_at": "2020-11-05T06:20:35Z",
      "body": "So we can't turn on the hibernate regions feature by rolling upgrade? @BusyJay "
    },
    {
      "id": 722169936,
      "user": "BusyJay",
      "created_at": "2020-11-05T06:23:43Z",
      "body": "Yes, and get around by #8208. "
    },
    {
      "id": 722205157,
      "user": "gengliqi",
      "created_at": "2020-11-05T07:47:35Z",
      "body": "The root cause is that the user opens the hibernate region on **some** TiKV, not **all** TiKV.  \r\nI think some configs have the same property, such as `prevote`, some `raft` related ticks, and so on.\r\nFurthermore, some configs even can't change after deployment, such as `right_derive_when_split`(change may lead to state machine inconsistency)"
    }
  ]
}