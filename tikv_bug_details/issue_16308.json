{
  "issue_number": 16308,
  "title": "TiKV panic because it detects damaged SST file was not removed",
  "body": "## Bug Report\r\n\r\nA disk issue resulted in the corruption of an SST file, leading to TiKV detecting and removing the affected regions in response. Despite this action, TiKV later experienced a panic. Based on the SST file key range, it appears the corrupted file is not an L0 file, and should therefore be removable using the `delete_files_in_ranges` function. However, due to the file containing multiple regions, this function was unable to fully cover the entire file, resulting in its unexpected retention.\r\n\r\nTo address this issue, a more comprehensive solution may be necessary:\r\n1. Lock the corrupted range, so that no region in the range can be created on this TiKV.\r\n2. Issue a `delete_file_in_ranges` that covers the entire file.\r\n3. After the `delete_file_in_ranges` completes, unlocks the range, so  that region can be created. \r\n\r\n```\r\n[2023/12/27 04:41:51.140 +08:00] [WARN] [event_listener.rs:127] [\"detected rocksdb background error\"] [err=\"Corruption: block checksum mismatch: stored = 2981909476, computed = 324654415, type = 1  in /data1/data/db/38457359.sst offset 8497742 size 3971\"] [sst=/38457359.sst]\r\n[2023/12/27 04:41:52.381 +08:00] [WARN] [store.rs:243] [\"detected damaged regions overlapping damaged file ranges\"] [id=\"{592132084, 442186929, 607655650}\"]\r\n\r\n[2023/12/27 04:42:01.909 +08:00] [FATAL] [lib.rs:509] [\"Failed to recover sst file: /38457359.sst, error: file still exists, it may belong L0, damaged_files:[name:\\\"/38457359.sst\\\", smallest_key:[122, 116, 128, 0, 0, 0, 0, 0, 2, 255, 147, 95, 105, 128, 0, 0, 0, 0, 255, 0, 0, 5, 4, 25, 176, 2, 250, 255, 52, 5, 28, 152, 3, 128, 0, 0, 255, 0, 98, 225, 177, 197, 0, 0, 0, 252, 249, 224, 166, 248, 155, 115, 255, 254], largest_key:[122, 116, 128, 0, 0, 0, 0, 0, 2, 255, 147, 95, 105, 128, 0, 0, 0, 0, 255, 0, 0, 5, 4, 25, 176, 8, 209, 255, 7, 8, 84, 208, 3, 128, 0, 0, 255, 0, 99, 57, 165, 158, 0, 0, 0, 252, 249, 224, 107, 106, 81, 119, 255, 204], elapsed_secs:10.273459802]\"] [backtrace=\"   0: tikv_util::set_panic_hook::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/lib.rs:508:18\r\n   1: <alloc::boxed::Box<F,A> as core::ops::function::Fn<Args>>::call\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2032:9\r\n      std::panicking::rust_panic_with_hook\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:692:13\r\n   2: std::panicking::begin_panic_handler::{{closure}}\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:579:13\r\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:137:18\r\n   4: rust_begin_unwind\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:575:5\r\n   5: core::panicking::panic_fmt\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panicking.rs:65:14\r\n   6: engine_rocks_helper::sst_recovery::RecoveryRunner::set_panic_mark_and_panic\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/engine_rocks_helper/src/sst_recovery.rs:191:9\r\n      engine_rocks_helper::sst_recovery::RecoveryRunner::must_file_not_exist\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/engine_rocks_helper/src/sst_recovery.rs:202:17\r\n      engine_rocks_helper::sst_recovery::RecoveryRunner::check_overlap_damaged_regions\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/engine_rocks_helper/src/sst_recovery.rs:175:13\r\n   7: alloc::vec::Vec<T,A>::retain_mut::process_loop\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/vec/mod.rs:1641:21\r\n      alloc::vec::Vec<T,A>::retain_mut\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/vec/mod.rs:1667:9\r\n      alloc::vec::Vec<T,A>::retain\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/vec/mod.rs:1561:9\r\n      engine_rocks_helper::sst_recovery::RecoveryRunner::check_damaged_files\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/engine_rocks_helper/src/sst_recovery.rs:143:9\r\n      <engine_rocks_helper::sst_recovery::RecoveryRunner as tikv_util::worker::pool::RunnableWithTimer>::on_timeout\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/engine_rocks_helper/src/sst_recovery.rs:65:9\r\n      tikv_util::worker::pool::Worker::start_with_timer_impl::{{closure}}\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/worker/pool.rs:500:25\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:91:19\r\n      yatp::task::future::RawTask<F>::poll\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/39cb495/src/task/future.rs:59:9\r\n   8: yatp::task::future::TaskCell::poll\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/39cb495/src/task/future.rs:103:9\r\n      <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/39cb495/src/task/future.rs:387:20\r\n   9: <tikv_util::yatp_pool::YatpPoolRunner<T> as yatp::pool::runner::Runner>::handle\r\n             at /home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tikv/components/tikv_util/src/yatp_pool/mod.rs:122:24\r\n      yatp::pool::worker::WorkerThread<T,R>::run\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/39cb495/src/pool/worker.rs:48:13\r\n      yatp::pool::builder::LazyBuilder<T>::build::{{closure}}\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/39cb495/src/pool/builder.rs:114:25\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys_common/backtrace.rs:121:18\r\n  10: std::thread::Builder::spawn_unchecked_::{{closure}}::{{closure}}\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:551:17\r\n      <core::panic::unwind_safe::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/panic/unwind_safe.rs:271:9\r\n      std::panicking::try::do_call\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:483:40\r\n      std::panicking::try\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:447:19\r\n      std::panic::catch_unwind\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panic.rs:137:14\r\n      std::thread::Builder::spawn_unchecked_::{{closure}}\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:550:30\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:513:5\r\n  11: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2000:9\r\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/alloc/src/boxed.rs:2000:9\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at /rust/toolchains/nightly-2022-11-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/unix/thread.rs:108:17\r\n  12: start_thread\r\n  13: __clone\r\n\"] [location=components/engine_rocks_helper/src/sst_recovery.rs:191] [thread_name=sst-recovery-0]\r\n\r\n\r\n# smallest_key\r\nmok 7A7480000000000002FF935F698000000000FF0000050419B002FAFF34051C9803800000FF0062E1B1C5000000FCF9E0A6F89B73FFFE\r\n\"7A7480000000000002FF935F698000000000FF0000050419B002FAFF34051C9803800000FF0062E1B1C5000000FCF9E0A6F89B73FFFE\"\r\n└─## decode hex key\r\n  └─\"zt\\200\\000\\000\\000\\000\\000\\002\\377\\223_i\\200\\000\\000\\000\\000\\377\\000\\000\\005\\004\\031\\260\\002\\372\\3774\\005\\034\\230\\003\\200\\000\\000\\377\\000b\\341\\261\\305\\000\\000\\000\\374\\371\\340\\246\\370\\233s\\377\\376\"\r\n    └─## decode rocksdb data key\r\n      └─\"t\\200\\000\\000\\000\\000\\000\\002\\377\\223_i\\200\\000\\000\\000\\000\\377\\000\\000\\005\\004\\031\\260\\002\\372\\3774\\005\\034\\230\\003\\200\\000\\000\\377\\000b\\341\\261\\305\\000\\000\\000\\374\\371\\340\\246\\370\\233s\\377\\376\"\r\n        ├─## decode mvcc key\r\n        │ ├─\"t\\200\\000\\000\\000\\000\\000\\002\\223_i\\200\\000\\000\\000\\000\\000\\000\\005\\004\\031\\260\\002\\3724\\005\\034\\230\\003\\200\\000\\000\\000b\\341\\261\\305\"\r\n        │ │ ├─## table prefix\r\n        │ │ │ └─table: 659\r\n        │ │ └─## table index key\r\n        │ │   ├─table: 659\r\n        │ │   ├─index: 5\r\n        │ │   └─\"\\004\\031\\260\\002\\3724\\005\\034\\230\\003\\200\\000\\000\\000b\\341\\261\\305\"\r\n        │ │     └─## decode index values\r\n        │ │       ├─kind: Uint64, value: 1850982720487103640\r\n        │ │       └─kind: Int64, value: 1658958277\r\n        │ └─ts: 441169176792137729 (2023-05-01 15:40:52.387 +0800 CST)\r\n        └─## table prefix\r\n          └─table: 767\r\n\r\n# largest_key\r\nmok 7A7480000000000002FF935F698000000000FF0000050419B008D1FF070854D003800000FF006339A59E000000FCF9E06B6A5177FFCC\r\n\"7A7480000000000002FF935F698000000000FF0000050419B008D1FF070854D003800000FF006339A59E000000FCF9E06B6A5177FFCC\"\r\n└─## decode hex key\r\n  └─\"zt\\200\\000\\000\\000\\000\\000\\002\\377\\223_i\\200\\000\\000\\000\\000\\377\\000\\000\\005\\004\\031\\260\\010\\321\\377\\007\\010T\\320\\003\\200\\000\\000\\377\\000c9\\245\\236\\000\\000\\000\\374\\371\\340kjQw\\377\\314\"\r\n    └─## decode rocksdb data key\r\n      └─\"t\\200\\000\\000\\000\\000\\000\\002\\377\\223_i\\200\\000\\000\\000\\000\\377\\000\\000\\005\\004\\031\\260\\010\\321\\377\\007\\010T\\320\\003\\200\\000\\000\\377\\000c9\\245\\236\\000\\000\\000\\374\\371\\340kjQw\\377\\314\"\r\n        ├─## decode mvcc key\r\n        │ ├─\"t\\200\\000\\000\\000\\000\\000\\002\\223_i\\200\\000\\000\\000\\000\\000\\000\\005\\004\\031\\260\\010\\321\\007\\010T\\320\\003\\200\\000\\000\\000c9\\245\\236\"\r\n        │ │ ├─## table prefix\r\n        │ │ │ └─table: 659\r\n        │ │ └─## table index key\r\n        │ │   ├─table: 659\r\n        │ │   ├─index: 5\r\n        │ │   └─\"\\004\\031\\260\\010\\321\\007\\010T\\320\\003\\200\\000\\000\\000c9\\245\\236\"\r\n        │ │     └─## decode index values\r\n        │ │       ├─kind: Uint64, value: 1850989140708447440\r\n        │ │       └─kind: Int64, value: 1664722334\r\n        │ └─ts: 441234659104784435 (2023-05-04 13:04:07.586 +0800 CST)\r\n        └─## table prefix\r\n          └─table: 767\r\n```\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n\r\nv6.5.4\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nModify a non-L0 SST file that contains multiple regions.\r\n\r\n### What did you expect?\r\n\r\nNo panic.\r\n\r\n### What did happened?\r\n\r\nPanic.\r\n",
  "state": "open",
  "created_at": "2024-01-08T07:10:31Z",
  "updated_at": "2024-06-03T02:25:53Z",
  "closed_at": null,
  "labels": [
    "type/bug",
    "severity/moderate",
    "affects-6.1",
    "affects-6.2",
    "affects-6.3",
    "affects-6.4",
    "affects-6.5",
    "affects-6.6",
    "affects-7.0",
    "affects-7.1",
    "affects-7.2",
    "affects-7.3",
    "affects-7.4",
    "affects-7.5",
    "user_report",
    "affects-8.1",
    "impact/panic"
  ],
  "comments_data": []
}