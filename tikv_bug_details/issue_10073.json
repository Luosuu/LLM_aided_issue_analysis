{
  "issue_number": 10073,
  "title": "CDC should not send changes of un-captured key ranges",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\nCDC sends changes of un-captured key ranges. It has overheads for both TiCDC and TiKV, especially for TiKV when a changefeed enables old value. For example, when we start to load data by INSERT SQL, TiKV caches old value by region, so it may cache both row data and index data (which is not unnecessary to captured). In pessimistic txn, TiKV may not cache all indexes, it may lead to old value cache miss.\r\n\r\nIn the red box, the cache hit rate should be 100%.\r\n![image](https://user-images.githubusercontent.com/2150711/115840841-b2da7e00-a44e-11eb-9f43-5ce6cf4782bb.png)\r\n\r\nThis issue is found during the development of #10072 \r\n\r\n```\r\nmysql> trace insert into `sbtest1` (`k` , `c` , `pad`, `id` ) values (2992017 , \"31451373586-15688153734-79729593694-96509299839-83724898275-86711833539-78981337422-35049690573-51724173961-87474696253\", \"98996621624-36689827414-04092488557-09587706818-65008859162\", 1000019);\r\n+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------$--------+-------------+\r\n| operation                                                                                                                                                                                 | startTS        | duration    |\r\n+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------$--------+-------------+\r\n| trace                                                                                                                                                                                     | 01:05:5$.204092 | 13.883489ms |\r\n|   └─session.ExecuteStmt                                                                                                                                                                   | 01:05:5$.204098 | 13.86887ms  |\r\n|     ├─executor.Compile                                                                                                                                                                    | 01:05:5$.204115 | 110.188µs   |\r\n|     └─session.runStmt                                                                                                                                                                     | 01:05:5$.204260 | 13.663742ms |\r\n|       ├─executor.handleNoDelayExecutor                                                                                                                                                    | 01:05:5$.204288 | 10.387744ms |\r\n|       │ └─*executor.InsertExec.Next                                                                                                                                                       | 01:05:5$.204291 | 10.369615ms |\r\n|       │   ├─table.AddRecord                                                                                                                                                               | 01:05:5$.214577 | 60.16µs     |\r\n|       │   └─index.Create                                                                                                                                                                  | 01:05:5$.214616 | 2.527µs     |\r\n|       ├─loadRegion                                                                                                                                                                        | 01:05:5$.214698 | 476.335µs   |\r\n|       ├─loadRegion                                                                                                                                                                        | 01:05:52.215229 | 239.766µs   |\r\n|       └─regionRequest.SendReqCtx # TiKV cache old values here                                                                                                                             | 01:05:52.215520 | 1.078863ms  |\r\n|         ├─rpcClient.SendRequest, region ID: 126, type: PessimisticLock, mutations [PessimisticLock], key [7480000000000000335f6980000000000000010380000000000f42530380000000002da791]     | 01:05:52.215580 | 981.217µs   |\r\n|         └─regionRequest.SendReqCtx # TiKV cache old values here                                                                                                                           | 01:05:52.216645 | 1.013009ms  |\r\n|           └─rpcClient.SendRequest, region ID: 2, type: PessimisticLock, mutations [PessimisticLock], key [7480000000000000335f72800000000181b336]                                         | 01:05:52.216686 | 950.6µs     |\r\n+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+-------------+\r\n14 rows in set (0.02 sec)\r\n\r\nmysql> trace commit;\r\n+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------+------------+\r\n| operation                                                                                                                                                                           | startTS        | duration   |\r\n+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------+------------+\r\n| trace                                                                                                                                                                               | 01:06:05.2746$6 | 3.602457ms |\r\n|   └─session.ExecuteStmt                                                                                                                                                             | 01:06:05.2746$1 | 3.588645ms |\r\n|     ├─executor.Compile                                                                                                                                                              | 01:06:05.2746$0 | 8.986µs    |\r\n|     └─session.runStmt                                                                                                                                                               | 01:06:05.2746$5 | 3.493035ms |\r\n|       ├─executor.handleNoDelayExecutor                                                                                                                                              | 01:06:05.2746$6 | 21.58µs    |\r\n|       │ └─*executor.SimpleExec.Next                                                                                                                                                 | 01:06:05.274687 | 1.605µs    |\r\n|       └─session.CommitTxn                                                                                                                                                           | 01:06:05.274712 | 3.39318ms  |\r\n|         └─session.doCommitWitRetry                                                                                                                                                  | 01:06:05.274716 | 3.381367ms |\r\n|           └─tikvTxn.Commit                                                                                                                                                          | 01:06:05.274723 | 3.349106ms |\r\n|             └─twoPhaseCommitter.prewriteMutations                                                                                                                                   | 01:06:05.275236 | 2.80608ms  |\r\n|               ├─loadRegion                                                                                                                                                          | 01:06:05.275246 | 386.527µs  |\r\n|               ├─regionRequest.SendReqCtx                                                                                                                                            | 01:06:05.275746 | 2.274309ms |\r\n|               │ └─rpcClient.SendRequest, region ID: 2, type: Prewrite, mutations [Put], key [7480000000000000335f72800000000181b336]                                                | 01:06:05.275800 | 2.195865ms |\r\n|               ├─regionRequest.SendReqCtx                                                                                                                                            | 01:06:05.275747 | 2.141951ms |\r\n|               │ └─rpcClient.SendRequest, region ID: 126, type: Prewrite, mutations [Insert], key [7480000000000000335f6980000000000000010380000000000f42530380000000002da791]       | 01:06:05.275801 | 2.063306ms |\r\n|               └─regionRequest.SendReqCtx                                                                                                                                            | 01:06:05.275783 | 2.164292ms |\r\n|                 └─rpcClient.SendRequest, region ID: 178, type: Prewrite, mutations [Put], key [7480000000000000335f6980000000000000020380000000002da79103800000000181b336]          | 01:06:05.275840 | 2.084568ms |\r\n+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------+------------+\r\n17 rows in set (0.01 sec)\r\n\r\nmysql> show create table sbtest1;\r\n+---------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\r\n| Table   | Create Table                                                                                                                                                                                                                                                                                                                                          |\r\n+---------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\r\n| sbtest1 | CREATE TABLE `sbtest1` (\r\n  `id` int(11) NOT NULL AUTO_INCREMENT,\r\n  `k` int(11) NOT NULL DEFAULT '0',\r\n  `c` char(120) NOT NULL DEFAULT '',\r\n  `pad` char(60) NOT NULL DEFAULT '',\r\n  PRIMARY KEY (`id`,`k`) /*T![clustered_index] NONCLUSTERED */,\r\n  KEY `k_1` (`k`)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin AUTO_INCREMENT=25307238 |\r\n+---------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\r\n1 row in set (0.01 sec)\r\n```\r\n\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n\r\nTiKV 5.0.0\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\n```\r\n# create a changefeed with old value enabled.\r\nsysbench --db-driver=mysql --mysql-host=172.16.5.33 --mysql-port=47904 --mysql-user=root --time=15000 --report-interval=10 --threads=64 --mysql-db=test --tables=1 --table-size=6000000 oltp_write_only prepare && \\\r\nsleep 60 && sysbench --db-driver=mysql --mysql-host=172.16.5.33 --mysql-port=47904 --mysql-user=root --time=15000 --report-interval=10 --threads=64 --mysql-db=test --tables=1 --table-size=6000000 oltp_write_only run\r\n```\r\n\r\n### What did you expect?\r\n\r\n100% cache hit.\r\n\r\n### What did happened?\r\n\r\n90% cache hit. \r\n",
  "state": "closed",
  "created_at": "2021-04-23T08:13:12Z",
  "updated_at": "2023-02-16T10:22:05Z",
  "closed_at": "2023-02-16T10:22:05Z",
  "labels": [
    "type/bug",
    "difficulty/easy",
    "component/CDC",
    "severity/minor"
  ],
  "comments_data": [
    {
      "id": 850360766,
      "user": "overvenus",
      "created_at": "2021-05-28T11:45:18Z",
      "body": "@ben1009 Could you take a look?"
    },
    {
      "id": 851364052,
      "user": "ben1009",
      "created_at": "2021-05-31T09:40:26Z",
      "body": "> @ben1009 Could you take a look?\r\n\r\nsure"
    },
    {
      "id": 1070592482,
      "user": "Rustin170506",
      "created_at": "2022-03-17T09:13:42Z",
      "body": "/unassign @hicqu\r\n \r\n/assign"
    }
  ]
}