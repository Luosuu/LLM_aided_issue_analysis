{
  "issue_number": 8555,
  "title": "cop: panic by assertion failure in BatchTableScanExecutor",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\nmaster with commit `4d8e469860292b10636f1b25bf7a19da84e0b067`\r\n\r\n### What operating system and CPU are you using?\r\n<!-- If you're using Linux, you can run `cat /proc/cpuinfo` -->\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\ntidb-lightning integration test fails in create table\r\n\r\ntikv panic log as follows:\r\n```\r\n[2020-08-31T10:28:27.692Z] [2020/08/31 18:14:41.452 +08:00] [FATAL] [lib.rs:481] [\"assertion failed: `(left == right)`\r\n  left: `1`,\r\n right: `2`\"] [backtrace=\"stack backtrace:\r\n   0: tikv_util::set_panic_hook::{{closure}}\r\n             at components/tikv_util/src/lib.rs:480\r\n   1: std::panicking::rust_panic_with_hook\r\n             at src/libstd/panicking.rs:524\r\n   2: rust_begin_unwind\r\n             at src/libstd/panicking.rs:431\r\n   3: std::panicking::begin_panic_fmt\r\n             at src/libstd/panicking.rs:385\r\n   4: tidb_query_datatype::codec::batch::lazy_column_vec::LazyBatchColumnVec::assert_columns_equal_length\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/macros.rs:16\r\n   5: <tidb_query_vec_executors::util::scan_executor::ScanExecutor<S,I> as tidb_query_vec_executors::interface::BatchExecutor>::next_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/util/scan_executor.rs:172\r\n      <tidb_query_vec_executors::table_scan_executor::BatchTableScanExecutor<S> as tidb_query_vec_executors::interface::BatchExecutor>::next_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/table_scan_executor.rs:110\r\n   6: <tidb_query_common::execute_stats::WithSummaryCollector<C,T> as tidb_query_vec_executors::interface::BatchExecutor>::next_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/interface.rs:108\r\n   7: <alloc::boxed::Box<T> as tidb_query_vec_executors::interface::BatchExecutor>::next_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/interface.rs:77\r\n      <tidb_query_vec_executors::selection_executor::BatchSelectionExecutor<Src> as tidb_query_vec_executors::interface::BatchExecutor>::next_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/selection_executor.rs:179\r\n      <tidb_query_common::execute_stats::WithSummaryCollector<C,T> as tidb_query_vec_executors::interface::BatchExecutor>::next_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/interface.rs:108\r\n   8: <alloc::boxed::Box<T> as tidb_query_vec_executors::interface::BatchExecutor>::next_batch\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/interface.rs:77\r\n      tidb_query_vec_executors::runner::BatchExecutorsRunner<SS>::internal_handle_request\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/runner.rs:504\r\n   9: tidb_query_vec_executors::runner::BatchExecutorsRunner<SS>::handle_request::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/components/tidb_query_vec_executors/src/runner.rs:389\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/mod.rs:74\r\n      <tikv::coprocessor::dag::BatchDAGHandler as tikv::coprocessor::RequestHandler>::handle_request::__handle_request::{{closure}}\r\n             at src/coprocessor/dag/mod.rs:152\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/mod.rs:74\r\n      <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/future.rs:119\r\n      <minitrace::future::TraceWrapped<T> as core::future::future::Future>::poll\r\n             at /rust/git/checkouts/minitrace-rust-4a91d55623f07cfc/de69110/src/future.rs:107\r\n  10: <core::pin::Pin<P> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/future.rs:119\r\n      <minitrace::future::TraceWrapped<T> as core::future::future::Future>::poll\r\n             at /rust/git/checkouts/minitrace-rust-4a91d55623f07cfc/de69110/src/future.rs:107\r\n      <tikv::coprocessor::interceptors::tracker::Tracker<F> as core::future::future::Future>::poll\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/coprocessor/interceptors/tracker.rs:45\r\n  11: <tikv::coprocessor::interceptors::concurrency_limiter::ConcurrencyLimiter<PF,F> as core::future::future::Future>::poll\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/coprocessor/interceptors/concurrency_limiter.rs:101\r\n      tikv::coprocessor::endpoint::Endpoint<E>::handle_unary_request_impl::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/coprocessor/endpoint.rs:402\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/mod.rs:74\r\n      <minitrace::future::TraceSpawned<T> as core::future::future::Future>::poll\r\n             at /rust/git/checkouts/minitrace-rust-4a91d55623f07cfc/de69110/src/future.rs:77\r\n      tikv::read_pool::ReadPoolHandle::spawn_handle::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/read_pool.rs:139\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/mod.rs:74\r\n  12: tikv::read_pool::ReadPoolHandle::spawn::{{closure}}\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/read_pool.rs:115\r\n      <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/future/mod.rs:74\r\n  13: <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/3894a86/src/task/future.rs:254\r\n  14: <tikv::read_pool::ReadPoolRunner<E,R> as yatp::pool::runner::Runner>::handle\r\n             at /home/jenkins/agent/workspace/build_tikv_multi_branch_master/tikv/src/read_pool.rs:169\r\n      <yatp::queue::multilevel::MultilevelRunner<R> as yatp::pool::runner::Runner>::handle\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/3894a86/src/queue/multilevel.rs:245\r\n      yatp::pool::worker::WorkerThread<T,R>::run\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/3894a86/src/pool/worker.rs:48\r\n      yatp::pool::builder::LazyBuilder<T>::build::{{closure}}\r\n             at /rust/git/checkouts/yatp-e704b73c3ee279b6/3894a86/src/pool/builder.rs:91\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/sys_common/backtrace.rs:130\r\n  15: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/thread/mod.rs:475\r\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panic.rs:318\r\n      std::panicking::try::do_call\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panicking.rs:342\r\n      std::panicking::try\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panicking.rs:319\r\n      std::panic::catch_unwind\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/panic.rs:394\r\n      std::thread::Builder::spawn_unchecked::{{closure}}\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/thread/mod.rs:474\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libcore/ops/function.rs:233\r\n  16: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/liballoc/boxed.rs:1078\r\n      <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at /rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/liballoc/boxed.rs:1078\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at src/libstd/sys/unix/thread.rs:87\r\n  17: start_thread\r\n  18: __clone\r\n\"] [location=/rustc/16957bd4d3a5377263f76ed74c572aad8e4b7e59/src/libstd/macros.rs:16] [thread_name=unified-read-pool-7]\r\n```\r\n\r\nthis panic can reporduce stably.\r\n\r\nfor more detail log, see: https://internal.pingcap.net/idc-jenkins/blue/organizations/jenkins/lightning_ghpr_test/detail/lightning_ghpr_test/1462/pipeline/50\r\n\r\n### What did you expect?\r\n\r\n### What did happened?\r\n",
  "state": "closed",
  "created_at": "2020-08-31T11:26:18Z",
  "updated_at": "2020-11-19T14:00:57Z",
  "closed_at": "2020-11-19T14:00:57Z",
  "labels": [
    "type/bug",
    "sig/coprocessor",
    "severity/moderate"
  ],
  "comments_data": [
    {
      "id": 685266821,
      "user": "ZenoTan",
      "created_at": "2020-09-02T03:24:24Z",
      "body": "/label sig/coprocessor"
    },
    {
      "id": 730345264,
      "user": "breezewish",
      "created_at": "2020-11-19T12:33:53Z",
      "body": "@glorv Does this issue still exist?"
    },
    {
      "id": 730394937,
      "user": "glorv",
      "created_at": "2020-11-19T14:00:57Z",
      "body": "I think it's fixed."
    }
  ]
}