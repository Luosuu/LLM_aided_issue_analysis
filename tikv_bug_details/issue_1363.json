{
  "issue_number": 1363,
  "title": "Panic when stop",
  "body": "Panic when stop\r\n```\r\n2016-11-25 22:13:40,597 panic_hook.rs:85 - ERROR - thread 'raftstore-1' panicked 'send write finished to scheduler failed cid=412508, err:Other(StringError(\"NotifyError::Closed(..)\"\r\n))' at \"src/storage/txn/scheduler.rs:187\"\r\nstack backtrace:\r\n   0:     0x7fe93fc749de - backtrace::backtrace::libunwind::trace\r\n                        at /home/pingcap/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.2.3/src/backtrace/mod.rs:82\r\n                         - backtrace::backtrace::trace<closure>\r\n                        at /home/pingcap/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.2.3/src/backtrace/mod.rs:70\r\n   1:     0x7fe93fc75073 - backtrace::capture::{{impl}}::new\r\n                        at /home/pingcap/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.2.3/src/lib.rs:96\r\n   2:     0x7fe93fc74344 - tikv::util::panic_hook::set_exit_hook::{{closure}}\r\n                        at /home/pingcap/go/src/github.com/pingcap/tikv2/tikv/src/util/panic_hook.rs:84\r\n   3:     0x7fe94015dd44 - std::panicking::rust_panic_with_hook\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/obj/../src/libstd/panicking.rs:452\r\n   4:     0x7fe94015dc04 - std::panicking::begin_panic<collections::string::String>\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/obj/../src/libstd/panicking.rs:413\r\n   5:     0x7fe94015db29 - std::panicking::begin_panic_fmt\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/obj/../src/libstd/panicking.rs:397\r\n   6:     0x7fe93fb99f0d - tikv::storage::txn::scheduler::make_engine_cb::{{closure}}\r\n                        at /home/pingcap/go/src/github.com/pingcap/tikv2/tikv/src/storage/txn/scheduler.rs:187\r\n                         - alloc::boxed::{{impl}}::call_box<(core::result::Result<(), tikv::storage::engine::Error>),closure>\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/obj/../src/liballoc/boxed.rs:595\r\n   7:     0x7fe93fb25ed1 - alloc::boxed::{{impl}}::call_once<(core::result::Result<(), tikv::storage::engine::Error>),()>\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/obj/../src/liballoc/boxed.rs:615\r\n                         - tikv::storage::engine::raftkv::{{impl}}::async_write::{{closure}}<tikv::server::transport::ServerRaftStoreRouter>\r\n                        at /home/pingcap/go/src/github.com/pingcap/tikv2/tikv/src/storage/engine/raftkv.rs:219\r\n                         - alloc::boxed::{{impl}}::call_box<(core::result::Result<tikv::storage::engine::raftkv::CmdRes, tikv::storage::engine::Error>),closure>\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/obj/../src/liballoc/boxed.rs:595\r\n   8:     0x7fe93fb21d47 - alloc::boxed::{{impl}}::call_once<(core::result::Result<tikv::storage::engine::raftkv::CmdRes, tikv::storage::engine::Error>),()>\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/obj/../src/liballoc/boxed.rs:615\r\n```\r\n",
  "state": "closed",
  "created_at": "2016-11-25T15:21:19Z",
  "updated_at": "2018-08-07T00:46:20Z",
  "closed_at": "2017-06-30T08:53:42Z",
  "labels": [
    "type/bug"
  ],
  "comments_data": [
    {
      "id": 262978151,
      "user": "zhangjinpeng87",
      "created_at": "2016-11-25T15:22:02Z",
      "body": "```\r\n8:     0x7fe93fb21d47 - alloc::boxed::{{impl}}::call_once<(core::result::Result<tikv::storage::engine::raftkv::CmdRes, tikv::storage::engine::Error>),()>\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/obj/../src/liballoc/boxed.rs:615\r\n                         - tikv::storage::engine::raftkv::{{impl}}::call_command::{{closure}}<tikv::server::transport::ServerRaftStoreRouter>\r\n                        at /home/pingcap/go/src/github.com/pingcap/tikv2/tikv/src/storage/engine/raftkv.rs:140\r\n                         - alloc::boxed::{{impl}}::call_box<(kvproto::raft_cmdpb::RaftCmdResponse),closure>\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/obj/../src/liballoc/boxed.rs:595\r\n   9:     0x7fe93fc22f6c - tikv::raftstore::store::peer::{{impl}}::process_raft_cmd\r\n                        at /home/pingcap/go/src/github.com/pingcap/tikv2/tikv/src/raftstore/store/peer.rs:1168\r\n  10:     0x7fe93fc1a8ac - tikv::raftstore::store::peer::{{impl}}::handle_raft_entry_normal\r\n                        at /home/pingcap/go/src/github.com/pingcap/tikv2/tikv/src/raftstore/store/peer.rs:1063\r\n                         - tikv::raftstore::store::peer::{{impl}}::handle_raft_commit_entries\r\n                        at /home/pingcap/go/src/github.com/pingcap/tikv2/tikv/src/raftstore/store/peer.rs:1021\r\n                         - tikv::raftstore::store::peer::{{impl}}::handle_raft_ready_apply\r\n                        at /home/pingcap/go/src/github.com/pingcap/tikv2/tikv/src/raftstore/store/peer.rs:637\r\n  11:     0x7fe93fb38268 - tikv::raftstore::store::store::{{impl}}::on_raft_ready<tikv::server::transport::ServerTransport,tikv::pd::client::RpcClient>\r\n                        at /home/pingcap/go/src/github.com/pingcap/tikv2/tikv/src/raftstore/store/store.rs:816\r\n  12:     0x7fe93fac5ba3 - tikv::raftstore::store::store::{{impl}}::tick<tikv::server::transport::ServerTransport,tikv::pd::client::RpcClient>\r\n                        at /home/pingcap/go/src/github.com/pingcap/tikv2/tikv/src/raftstore/store/store.rs:1679\r\n                         - mio::event_loop::{{impl}}::run_once<tikv::raftstore::store::store::Store<tikv::server::transport::ServerTransport, tikv::pd::client::RpcClient>>\r\n                        at /home/pingcap/.cargo/git/checkouts/mio-e79f285e2377d154/master/src/event_loop.rs:315\r\n  13:     0x7fe93fb42c6b - mio::event_loop::{{impl}}::run<tikv::raftstore::store::store::Store<tikv::server::transport::ServerTransport, tikv::pd::client::RpcClient>>\r\n                        at /home/pingcap/.cargo/git/checkouts/mio-e79f285e2377d154/master/src/event_loop.rs:261\r\n                         - tikv::raftstore::store::store::{{impl}}::run<tikv::server::transport::ServerTransport,tikv::pd::client::RpcClient>\r\n                        at /home/pingcap/go/src/github.com/pingcap/tikv2/tikv/src/raftstore/store/store.rs:393\r\n  14:     0x7fe93faaa9a7 - tikv::server::node::{{impl}}::start_store::{{closure}}<tikv::pd::client::RpcClient,tikv::server::transport::ServerTransport>\r\n                        at /home/pingcap/go/src/github.com/pingcap/tikv2/tikv/src/server/node.rs:248\r\n                         - std::panic::{{impl}}::call_once<(),closure>\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/obj/../src/libstd/panic.rs:255\r\n                         - std::panicking::try::do_call<std::panic::AssertUnwindSafe<closure>,()>\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/obj/../src/libstd/panicking.rs:356\r\n  15:     0x7fe94016693a - panic_unwind::__rust_maybe_catch_panic\r\n                        at /buildslave/rust-buildbot/slave/nightly-dist-rustc-linux/build/obj/../src/libpanic_unwind/lib.rs:97\r\n```"
    }
  ]
}