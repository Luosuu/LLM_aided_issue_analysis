{
  "issue_number": 10118,
  "title": "CDC panic on deregister downstream",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\n<!-- You can run `tikv-server --version` -->\r\n\r\nA custom build TiKV: overvenus/tikv@78621ac . Not sure whether the release branch has the same or not.\r\n\r\n<details> <summary> TiKV panic log </summary>\r\n\r\n```\r\n[2021/04/29 22:02:51.611 +08:00] [INFO] [endpoint.rs:351] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"downstream\\\", region_id: 614, downstream_id: DownstreamID(1538), conn_id: ConnID(17), err: Some(Sink(Congest)) }\"]\r\n[2021/04/29 22:02:51.618 +08:00] [ERROR] [endpoint.rs:1256] [\"cdc send scan event failed\"] [req_id=6202]\r\n[2021/04/29 22:02:51.618 +08:00] [INFO] [endpoint.rs:351] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"downstream\\\", region_id: 642, downstream_id: DownstreamID(1552), conn_id: ConnID(17), err: Some(Sink(Congest)) }\"]\r\n[2021/04/29 22:02:51.626 +08:00] [ERROR] [endpoint.rs:1256] [\"cdc send scan event failed\"] [req_id=6191]\r\n[2021/04/29 22:02:51.626 +08:00] [INFO] [endpoint.rs:351] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"downstream\\\", region_id: 652, downstream_id: DownstreamID(1541), conn_id: ConnID(17), err: Some(Sink(Congest)) }\"]\r\n[2021/04/29 22:02:52.208 +08:00] [INFO] [endpoint.rs:682] [\"cdc send event failed, full\"] [downstream=\"\\\"ipv4:172.16.5.33:58526\\\"\"] [conn_id=ConnID(11)]\r\n[2021/04/29 22:02:52.208 +08:00] [INFO] [endpoint.rs:682] [\"cdc send event failed, full\"] [downstream=\"\\\"ipv4:172.16.5.33:58128\\\"\"] [conn_id=ConnID(9)]\r\n[2021/04/29 22:02:53.208 +08:00] [INFO] [endpoint.rs:682] [\"cdc send event failed, full\"] [downstream=\"\\\"ipv4:172.16.5.33:58018\\\"\"] [conn_id=ConnID(1)]\r\n[2021/04/29 22:02:53.208 +08:00] [INFO] [endpoint.rs:682] [\"cdc send event failed, full\"] [downstream=\"\\\"ipv4:172.16.5.33:58582\\\"\"] [conn_id=ConnID(15)]\r\n[2021/04/29 22:02:53.208 +08:00] [INFO] [endpoint.rs:682] [\"cdc send event failed, full\"] [downstream=\"\\\"ipv4:172.16.5.33:58528\\\"\"] [conn_id=ConnID(12)]\r\n[2021/04/29 22:02:53.208 +08:00] [INFO] [endpoint.rs:682] [\"cdc send event failed, full\"] [downstream=\"\\\"ipv4:172.16.5.33:58128\\\"\"] [conn_id=ConnID(9)]\r\n[2021/04/29 22:02:53.805 +08:00] [INFO] [delegate.rs:128] [\"cdc send event failed, full\"] [req_id=4874] [downstream_id=DownstreamID(231)] [conn_id=ConnID(9)]\r\n[2021/04/29 22:02:53.805 +08:00] [INFO] [endpoint.rs:351] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"region\\\", region_id: 4, observe_id: ObserveID(327), err: Sink(Congest) }\"]\r\n[2021/04/29 22:02:53.805 +08:00] [INFO] [delegate.rs:341] [\"cdc met region error\"] [error=Sink(Congest)] [region_id=4]\r\n[2021/04/29 22:02:53.813 +08:00] [INFO] [endpoint.rs:490] [\"cdc register region\"] [downstream_id=DownstreamID(1563)] [req_id=6214] [conn_id=ConnID(15)] [region_id=4]\r\n[2021/04/29 22:02:53.813 +08:00] [INFO] [endpoint.rs:1300] [\"cdc downstream is initialized\"] [downstream_id=DownstreamID(1563)]\r\n[2021/04/29 22:02:53.814 +08:00] [ERROR] [endpoint.rs:1256] [\"cdc send scan event failed\"] [req_id=6214]\r\n[2021/04/29 22:02:53.814 +08:00] [INFO] [endpoint.rs:351] [\"cdc deregister\"] [deregister=\"Deregister { deregister: \\\"downstream\\\", region_id: 4, downstream_id: DownstreamID(1563), conn_id: ConnID(15), err: Some(Sink(Congest)) }\"]\r\n[2021/04/29 22:02:54.195 +08:00] [FATAL] [lib.rs:452] [\"called `Result::unwrap()` on an `Err` value: Noop\"] [backtrace=\"stack backtrace:\\n   0: tikv_util::set_panic_hook::{{closure}}\\n             at components/tikv_util/src/lib.rs:451\\n   1: std::panicking::rust_panic_wi\r\nth_hook\\n             at library/std/src/panicking.rs:595\\n   2: std::panicking::begin_panic_handler::{{closure}}\\n             at library/std/src/panicking.rs:497\\n   3: std::sys_common::backtrace::__rust_end_short_backtrace\\n             at library/std/src/sys_common/ba\r\ncktrace.rs:141\\n   4: rust_begin_unwind\\n             at library/std/src/panicking.rs:493\\n   5: core::panicking::panic_fmt\\n             at library/core/src/panicking.rs:92\\n   6: core::result::unwrap_failed\\n             at library/core/src/result.rs:1355\\n   7: core::r\r\nesult::Result<T,E>::unwrap\\n             at /home/stn/.rustup/toolchains/nightly-2021-04-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/result.rs:1037\\n   8: cdc::endpoint::Endpoint<T>::on_deregister\\n             at /home/stn/tikv/components/cdc/src/en\r\ndpoint.rs:375\\n   9: <cdc::endpoint::Endpoint<T> as tikv_util::worker::pool::Runnable>::run\\n             at /home/stn/tikv/components/cdc/src/endpoint.rs:1288\\n  10: tikv_util::worker::pool::Worker::start_with_timer_impl::{{closure}}\\n             at /home/stn/tikv/compo\r\nnents/tikv_util/src/worker/pool.rs:430\\n  11: <core::future::from_generator::GenFuture<T> as core::future::future::Future>::poll\\n             at /home/stn/.rustup/toolchains/nightly-2021-04-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/future/mod.rs:8\r\n0\\n  12: <yatp::task::future::Runner as yatp::pool::runner::Runner>::handle\\n             at /home/stn/.cargo/git/checkouts/yatp-e704b73c3ee279b6/6bbea16/src/task/future.rs:261\\n  13: <tikv_util::yatp_pool::YatpPoolRunner<T> as yatp::pool::runner::Runner>::handle\\n\r\n      at /home/stn/tikv/components/tikv_util/src/yatp_pool/mod.rs:93\\n  14: yatp::pool::worker::WorkerThread<T,R>::run\\n             at /home/stn/.cargo/git/checkouts/yatp-e704b73c3ee279b6/6bbea16/src/pool/worker.rs:48\\n  15: yatp::pool::builder::LazyBuilder<T>::build::{{\r\nclosure}}\\n             at /home/stn/.cargo/git/checkouts/yatp-e704b73c3ee279b6/6bbea16/src/pool/builder.rs:91\\n  16: std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at /home/stn/.rustup/toolchains/nightly-2021-04-15-x86_64-unknown-linux-gnu/lib/rus\r\ntlib/src/rust/library/std/src/sys_common/backtrace.rs:125\\n  17: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\\n             at /home/stn/.rustup/toolchains/nightly-2021-04-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:47\r\n4\\n  18: <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\n             at /home/stn/.rustup/toolchains/nightly-2021-04-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panic.rs:344\\n  19: std::panicking::try::do_call\\n\r\n       at /home/stn/.rustup/toolchains/nightly-2021-04-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:379\\n  20: __rust_try.llvm.18008344519231701248\\n  21: std::panicking::try\\n             at /home/stn/.rustup/toolchains/nightly-2021-04-15\r\n-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panicking.rs:343\\n  22: std::panic::catch_unwind\\n             at /home/stn/.rustup/toolchains/nightly-2021-04-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/panic.rs:431\\n  23: std::thread::\r\nBuilder::spawn_unchecked::{{closure}}\\n             at /home/stn/.rustup/toolchains/nightly-2021-04-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:473\\n  24: core::ops::function::FnOnce::call_once{{vtable.shim}}\\n             at /home/stn/.\r\nrustup/toolchains/nightly-2021-04-15-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:227\\n  25: <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at /rustc/16bf626a31cb5b121d0bca2baa969b4f67eb0dab/library\r\n/alloc/src/boxed.rs:1546\\n      <alloc::boxed::Box<F,A> as core::ops::function::FnOnce<Args>>::call_once\\n             at /rustc/16bf626a31cb5b121d0bca2baa969b4f67eb0dab/library/alloc/src/boxed.rs:1546\\n      std::sys::unix::thread::Thread::new::thread_start\\n\r\n at library/std/src/sys/unix/thread.rs:71\\n  26: start_thread\\n  27: __clone\\n\"] [location=/home/stn/tikv/components/cdc/src/endpoint.rs:378] [thread_name=cdc-0]\r\n```\r\n\r\n</details>\r\n\r\n### Steps to reproduce\r\n<!-- If possible, provide a recipe for reproducing the error. A complete runnable program is good. -->\r\n\r\nJust run CDC.\r\n\r\n### What did you expect?\r\n\r\nNo panic.\r\n",
  "state": "closed",
  "created_at": "2021-05-06T05:18:19Z",
  "updated_at": "2021-05-19T13:49:42Z",
  "closed_at": "2021-05-19T13:49:42Z",
  "labels": [
    "type/bug",
    "component/CDC",
    "severity/critical"
  ],
  "comments_data": [
    {
      "id": 843720948,
      "user": "overvenus",
      "created_at": "2021-05-19T03:37:14Z",
      "body": "Find the panic on the latest release-4.0\r\n\r\n<details> <summary> TiKV panic log </summary>\r\n\r\n```\r\n[2021/05/19 04:31:47.143 +08:00] [INFO] [snap.rs:384] [\"sent snapshot\"] [duration=90.263269ms] [size=37003293] [snap_key=16356_8_231357] [region_id=16356]\r\n[2021/05/19 04:31:47.143 +08:00] [INFO] [peer.rs:805] [\"report snapshot status\"] [status=Finish] [to=\"id: 16650 store_id: 1 is_learner: true\"] [peer_id=16358] [region_id=16356]\r\n[2021/05/19 04:31:47.504 +08:00] [INFO] [pd.rs:780] [\"try to change peer\"] [peer=\"id: 16650 store_id: 1\"] [change_type=AddNode] [region_id=16356]\r\n[2021/05/19 04:31:47.505 +08:00] [INFO] [peer.rs:2734] [\"propose conf change peer\"] [change_peer=16650] [change_type=AddNode] [peer_id=16358] [region_id=16356]\r\n[2021/05/19 04:31:47.505 +08:00] [INFO] [apply.rs:1203] [\"execute admin command\"] [command=\"cmd_type: ChangePeer change_peer { peer { id: 16650 store_id: 1 } }\"] [index=231358] [term=8] [peer_id=16358] [region_id=16356]\r\n[2021/05/19 04:31:47.505 +08:00] [INFO] [apply.rs:1541] [\"exec ConfChange\"] [epoch=\"conf_ver: 27 version: 139\"] [type=AddNode] [peer_id=16358] [region_id=16356]\r\n[2021/05/19 04:31:47.505 +08:00] [INFO] [apply.rs:1596] [\"add peer successfully\"] [region=\"id: 16356 start_key: 7480000000000000FF325F698000000000FF0000020380000000FF0361333603800000FF00009FDC0D000000FC end_key: 7480000000000000FF325F698000000000FF0000020380000000FF037D01FC03800000FF0000160A98000000FC region_epoch { conf_ver: 27 version: 139 } peers { id: 16357 store_id: 6 } peers { id: 16358 store_id: 4 } peers { id: 16359 store_id: 5 } peers { id: 16650 store_id: 1 is_learner: true }\"] [peer=\"id: 16650 store_id: 1\"] [peer_id=16358] [region_id=16356]\r\n[2021/05/19 04:31:47.506 +08:00] [INFO] [peer.rs:1902] [\"notify pd with change peer region\"] [region=\"id: 16356 start_key: 7480000000000000FF325F698000000000FF0000020380000000FF0361333603800000FF00009FDC0D000000FC end_key: 7480000000000000FF325F698000000000FF0000020380000000FF037D01FC03800000FF0000160A98000000FC region_epoch { conf_ver: 28 version: 139 } peers { id: 16357 store_id: 6 } peers { id: 16358 store_id: 4 } peers { id: 16359 store_id: 5 } peers { id: 16650 store_id: 1 }\"] [peer_id=16358] [region_id=16356]\r\n[2021/05/19 04:31:47.506 +08:00] [INFO] [pd.rs:780] [\"try to change peer\"] [peer=\"id: 16359 store_id: 5\"] [change_type=RemoveNode] [region_id=16356]\r\n[2021/05/19 04:31:47.506 +08:00] [INFO] [peer.rs:2734] [\"propose conf change peer\"] [change_peer=16359] [change_type=RemoveNode] [peer_id=16358] [region_id=16356]\r\n[2021/05/19 04:31:47.507 +08:00] [INFO] [pd.rs:780] [\"try to change peer\"] [peer=\"id: 16359 store_id: 5\"] [change_type=RemoveNode] [region_id=16356]\r\n[2021/05/19 04:31:47.507 +08:00] [INFO] [peer.rs:2691] [\"there is a pending conf change, try later\"] [peer_id=16358] [region_id=16356]\r\n[2021/05/19 04:31:47.507 +08:00] [INFO] [apply.rs:1203] [\"execute admin command\"] [command=\"cmd_type: ChangePeer change_peer { change_type: RemoveNode peer { id: 16359 store_id: 5 } }\"] [index=231359] [term=8] [peer_id=16358] [region_id=16356]\r\n[2021/05/19 04:31:47.507 +08:00] [INFO] [apply.rs:1541] [\"exec ConfChange\"] [epoch=\"conf_ver: 28 version: 139\"] [type=RemoveNode] [peer_id=16358] [region_id=16356]\r\n[2021/05/19 04:31:47.507 +08:00] [INFO] [apply.rs:1649] [\"remove peer successfully\"] [region=\"id: 16356 start_key: 7480000000000000FF325F698000000000FF0000020380000000FF0361333603800000FF00009FDC0D000000FC end_key: 7480000000000000FF325F698000000000FF0000020380000000FF037D01FC03800000FF0000160A98000000FC region_epoch { conf_ver: 28 version: 139 } peers { id: 16357 store_id: 6 } peers { id: 16358 store_id: 4 } peers { id: 16359 store_id: 5 } peers { id: 16650 store_id: 1 }\"] [peer=\"id: 16359 store_id: 5\"] [peer_id=16358] [region_id=16356]\r\n[2021/05/19 04:31:47.507 +08:00] [INFO] [peer.rs:1902] [\"notify pd with change peer region\"] [region=\"id: 16356 start_key: 7480000000000000FF325F698000000000FF0000020380000000FF0361333603800000FF00009FDC0D000000FC end_key: 7480000000000000FF325F698000000000FF0000020380000000FF037D01FC03800000FF0000160A98000000FC region_epoch { conf_ver: 29 version: 139 } peers { id: 16357 store_id: 6 } peers { id: 16358 store_id: 4 } peers { id: 16650 store_id: 1 }\"] [peer_id=16358] [region_id=16356]\r\n[2021/05/19 04:31:47.507 +08:00] [INFO] [store.rs:374] [\"raft message is stale, ignore it\"] [msg_type=MsgAppendResponse] [current_region_epoch=\"conf_ver: 29 version: 139\"] [region_id=16356]\r\n[2021/05/19 04:33:09.628 +08:00] [INFO] [tracker.rs:241] [slow-query] [perf_stats.internal_delete_skipped_count=0] [perf_stats.internal_key_skipped_count=1443312] [perf_stats.block_read_byte=19693390] [perf_stats.block_read_count=442] [perf_stats.block_cache_hit_count=638] [scan.range.first=\"Some(start: 7480000000000000325F6980000000000000020380000000036133360380000000009FDC0D end: 7480000000000000325F6980000000000000020380000000037D01FC038000000000160A98)\"] [scan.ranges=1] [scan.total=1443313] [scan.processed=1443312] [scan.is_desc=None] [tag=analyze_index] [table_id=50] [txn_start_ts=18446744073709551615] [total_suspend_time=0ns] [total_process_time=1.572s] [handler_build_time=0ns] [wait_time.snapshot=0ns] [wait_time.schedule=0ns] [wait_time=0ns] [total_lifetime=1.572s] [remote_host=ipv4:172.16.4.55:35858] [region_id=16356]\r\n[2021/05/19 04:39:49.864 +08:00] [INFO] [endpoint.rs:465] [\"cdc register region\"] [downstream_id=DownstreamID(5697)] [req_id=12342] [conn_id=ConnID(28)] [region_id=16356]\r\n[2021/05/19 06:54:07.077 +08:00] [INFO] [endpoint.rs:465] [\"cdc register region\"] [downstream_id=DownstreamID(7434)] [req_id=15825] [conn_id=ConnID(40)] [region_id=16356]\r\n[2021/05/19 09:12:03.824 +08:00] [INFO] [endpoint.rs:465] [\"cdc register region\"] [downstream_id=DownstreamID(9553)] [req_id=20290] [conn_id=ConnID(50)] [region_id=16356]\r\n[2021/05/19 09:13:03.861 +08:00] [INFO] [endpoint.rs:321] [\"cdc deregister region\"] [deregister=\"Deregister { deregister: \\\"downstream\\\", region_id: 16356, downstream_id: DownstreamID(9553), conn_id: ConnID(50), err: Some(Sink(Disconnected)) }\"]\r\n[2021/05/19 09:13:04.304 +08:00] [FATAL] [lib.rs:482] [\"unexpect txn extra op Noop, region_id: 16356, downstream_id: DownstreamID(9553), conn_id: ConnID(50)\"] [backtrace=\"stack backtrace:\\n   0: tikv_util::set_panic_hook::{{closure}}\\n             at components/tikv_util/src/lib.rs:481\\n   1: std::panicking::rust_panic_with_hook\\n             at src/libstd/panicking.rs:475\\n   2: rust_begin_unwind\\n             at src/libstd/panicking.rs:375\\n   3: std::panicking::begin_panic_fmt\\n             at src/libstd/panicking.rs:326\\n   4: cdc::endpoint::Endpoint<T>::on_deregister\\n             at /home/stn/tikv/<::std::macros::panic macros>:9\\n   5: <cdc::endpoint::Endpoint<T> as tikv_util::worker::Runnable<cdc::endpoint::Task>>::run\\n             at /home/stn/tikv/components/cdc/src/endpoint.rs:1084\\n   6: tikv_util::worker::Runnable::run_batch\\n             at /home/stn/tikv/components/tikv_util/src/worker/mod.rs:88\\n      tikv_util::worker::poll\\n             at /home/stn/tikv/components/tikv_util/src/worker/mod.rs:268\\n      tikv_util::worker::Worker<T>::start_with_timer::{{closure}}\\n             at /home/stn/tikv/components/tikv_util/src/worker/mod.rs:346\\n      std::sys_common::backtrace::__rust_begin_short_backtrace\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/sys_common/backtrace.rs:136\\n   7: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/thread/mod.rs:469\\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panic.rs:318\\n      std::panicking::try::do_call\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panicking.rs:292\\n      __rust_maybe_catch_panic\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8//src/libpanic_unwind/lib.rs:78\\n      std::panicking::try\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panicking.rs:270\\n      std::panic::catch_unwind\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/panic.rs:394\\n      std::thread::Builder::spawn_unchecked::{{closure}}\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libstd/thread/mod.rs:468\\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/libcore/ops/function.rs:232\\n   8: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/liballoc/boxed.rs:1022\\n   9: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\\n             at /rustc/0de96d37fbcc54978458c18f5067cd9817669bc8/src/liballoc/boxed.rs:1022\\n      std::sys_common::thread::start_thread\\n             at src/libstd/sys_common/thread.rs:13\\n      std::sys::unix::thread::Thread::new::thread_start\\n             at src/libstd/sys/unix/thread.rs:80\\n  10: start_thread\\n  11: clone\\n\"] [location=components/cdc/src/endpoint.rs:349] [thread_name=cdc]\r\n```\r\n\r\n</details>\r\n"
    },
    {
      "id": 843774471,
      "user": "overvenus",
      "created_at": "2021-05-19T06:07:40Z",
      "body": "This panic is introduced in https://github.com/tikv/tikv/pull/9892"
    }
  ]
}