{
  "issue_number": 5365,
  "title": "TiKV panic with multiple shutdown mailbox ",
  "body": "## Bug Report\r\n\r\n<!-- Thanks for your bug report! Don't worry if you can't fill out all the sections. -->\r\n\r\n### What version of TiKV are you using?\r\nTiKV branch: master\r\nTiKV hash: `56c5d65d70596cf091c6b2e0ae4e68e26eba1855`\r\n### What did happened?\r\n```\r\n[2019/08/28 18:11:59.038 +00:00] [info] [region.rs:271] [\"begin apply snap data\"] [region_id=300845]\r\n[2019/08/28 18:12:00.545 +00:00] [info] [region.rs:340] [\"apply new data\"] [time_takes=851.26741ms] [region_id=300845]\r\n[2019/08/28 18:12:05.826 +00:00] [info] [snap.rs:223] [\"saving snapshot file\"] [file=/var/lib/tikv/snap/rev_300845_9_109700351_(default|lock|write).sst] [snap_key=300845_9_109700351]\r\n[2019/08/28 18:12:05.828 +00:00] [info] [raft.rs:2244] [\"[commit: 109455974, lastindex: 109455974, lastterm: 9] starts to restore snapshot [index: 109700351, term: 9]\"] [tag=\"[region 300845] 310522\"] [snapshot_term=9] [snapshot_index=109700351] [last_term=9] [last_index=109455974] [commit=109455974] [id=310522]\r\n[2019/08/28 18:12:05.828 +00:00] [info] [raft_log.rs:519] [\"[region 300845] 310522 log [committed=109455974, applied=109455974, unstable.offset=109455975, unstable.entries.len()=0] starts to restore snapshot [index: 109700351, term: 9]\"] [snapshot_term=9] [snapshot_index=109700351] [log=\"committed=109455974, applied=109455974, unstable.offset=109455975, unstable.entries.len()=0\"] [tag=\"[region 300845] 310522\"] [tag=\"[region 300845] 310522\"]\r\n[2019/08/28 18:12:05.828 +00:00] [info] [raft.rs:2176] [\"[commit: 109700351, term: 9] restored snapshot [index: 109700351, term: 9]\"] [tag=\"[region 300845] 310522\"] [snapshot_term=9] [snapshot_index=109700351] [commit=109700351] [term=9] [id=310522]\r\n[2019/08/28 18:12:05.828 +00:00] [info] [peer_storage.rs:905] [\"begin to apply snapshot\"] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:12:05.828 +00:00] [info] [peer_storage.rs:1330] [\"finish clear peer meta\"] [takes=366.206µs] [raft_logs=0] [raft_key=1] [apply_key=1] [meta_key=1] [region_id=300845]\r\n[2019/08/28 18:12:05.828 +00:00] [info] [peer_storage.rs:945] [\"apply snapshot with state ok\"] [state=\"raftapplystate { applied_index: 109700351, truncated_state: some(rafttruncatedstate { index: 109700351, term: 9, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 7 } }), unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 14 } }\"] [region=\"region { id: 300845, start_key: [116, 128, 0, 0, 0, 0, 0, 0, 255, 125, 95, 114, 128, 0, 0, 0, 19, 255, 103, 253, 186, 0, 0, 0, 0, 0, 250], end_key: [116, 128, 0, 0, 0, 0, 0, 0, 255, 126, 0, 0, 0, 0, 0, 0, 0, 248], region_epoch: some(regionepoch { conf_ver: 2649, version: 5068, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }), peers: [peer { id: 308188, store_id: 10, is_learner: false, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }, peer { id: 310522, store_id: 5, is_learner: false, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }, peer { id: 320959, store_id: 6, is_learner: false, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }, peer { id: 321220, store_id: 11, is_learner: true, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }], unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }\"] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:12:05.833 +00:00] [info] [peer.rs:2121] [\"snapshot is applied\"] [region=\"region { id: 300845, start_key: [116, 128, 0, 0, 0, 0, 0, 0, 255, 125, 95, 114, 128, 0, 0, 0, 19, 255, 103, 253, 186, 0, 0, 0, 0, 0, 250], end_key: [116, 128, 0, 0, 0, 0, 0, 0, 255, 126, 0, 0, 0, 0, 0, 0, 0, 248], region_epoch: some(regionepoch { conf_ver: 2649, version: 5068, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }), peers: [peer { id: 308188, store_id: 10, is_learner: false, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }, peer { id: 310522, store_id: 5, is_learner: false, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }, peer { id: 320959, store_id: 6, is_learner: false, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }, peer { id: 321220, store_id: 11, is_learner: true, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }], unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }\"] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:12:05.833 +00:00] [info] [region_info_accessor.rs:216] [\"trying to create region but it already exists, try to update it\"] [region_id=300845]\r\n[2019/08/28 18:12:05.833 +00:00] [info] [peer.rs:2138] [\"region changed after applying snapshot\"] [region=\"region { id: 300845, start_key: [116, 128, 0, 0, 0, 0, 0, 0, 255, 125, 95, 114, 128, 0, 0, 0, 19, 255, 103, 253, 186, 0, 0, 0, 0, 0, 250], end_key: [116, 128, 0, 0, 0, 0, 0, 0, 255, 126, 0, 0, 0, 0, 0, 0, 0, 248], region_epoch: some(regionepoch { conf_ver: 2649, version: 5068, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }), peers: [peer { id: 308188, store_id: 10, is_learner: false, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }, peer { id: 310522, store_id: 5, is_learner: false, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }, peer { id: 320959, store_id: 6, is_learner: false, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }, peer { id: 321220, store_id: 11, is_learner: true, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }], unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }\"] [prev_region=\"region { id: 300845, start_key: [116, 128, 0, 0, 0, 0, 0, 0, 255, 125, 95, 114, 128, 0, 0, 0, 19, 255, 103, 253, 186, 0, 0, 0, 0, 0, 250], end_key: [116, 128, 0, 0, 0, 0, 0, 0, 255, 126, 0, 0, 0, 0, 0, 0, 0, 248], region_epoch: some(regionepoch { conf_ver: 2649, version: 5068, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }), peers: [peer { id: 308188, store_id: 10, is_learner: false, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }, peer { id: 310522, store_id: 5, is_learner: false, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }, peer { id: 320959, store_id: 6, is_learner: false, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }, peer { id: 321220, store_id: 11, is_learner: true, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }], unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }\"] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:12:05.834 +00:00] [info] [apply.rs:2390] [\"re-register to apply delegates\"] [term=9] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:12:07.822 +00:00] [info] [peer.rs:522] [\"deleting applied snap file\"] [snap_file=300845_8_109017388] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:12:07.823 +00:00] [info] [peer.rs:522] [\"deleting applied snap file\"] [snap_file=300845_9_109455974] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:13:03.464 +00:00] [info] [region.rs:271] [\"begin apply snap data\"] [region_id=300845]\r\n[2019/08/28 18:13:05.771 +00:00] [info] [region.rs:340] [\"apply new data\"] [time_takes=1.147971329s] [region_id=300845]\r\n[2019/08/28 18:13:05.964 +00:00] [info] [peer.rs:1006] [\"target peer id is larger, destroying self\"] [target_peer=\"peer { id: 321462, store_id: 5, is_learner: true, unknown_fields: unknownfields { fields: none }, cached_size: cachedsize { size: 0 } }\"] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:13:05.964 +00:00] [info] [peer.rs:1355] [\"starts destroy\"] [merged_by_target=false] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:13:05.964 +00:00] [info] [apply.rs:2473] [\"remove delegate from apply delegates\"] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:13:05.964 +00:00] [info] [router.rs:446] [\"[region 300845] shutdown mailbox\"]\r\n[2019/08/28 18:13:05.964 +00:00] [info] [peer.rs:522] [\"begin to destroy\"] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:13:05.964 +00:00] [info] [peer_storage.rs:1330] [\"finish clear peer meta\"] [takes=95.453µs] [raft_logs=0] [raft_key=1] [apply_key=1] [meta_key=1] [region_id=300845]\r\n[2019/08/28 18:13:05.964 +00:00] [info] [peer.rs:569] [\"peer destroy itself\"] [takes=375.388µs] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:13:05.964 +00:00] [info] [router.rs:446] [\"[region 300845] shutdown mailbox\"]\r\n[2019/08/28 18:13:05.964 +00:00] [info] [peer.rs:1355] [\"starts destroy\"] [merged_by_target=false] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:13:05.964 +00:00] [info] [apply.rs:2856] [\"target region is not found, drop messages\"] [region_id=300845]\r\n[2019/08/28 18:13:05.964 +00:00] [info] [peer.rs:522] [\"begin to destroy\"] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:13:05.965 +00:00] [info] [peer_storage.rs:1330] [\"finish clear peer meta\"] [takes=45.571µs] [raft_logs=0] [raft_key=1] [apply_key=1] [meta_key=1] [region_id=300845]\r\n[2019/08/28 18:13:05.965 +00:00] [info] [peer.rs:569] [\"peer destroy itself\"] [takes=257.84µs] [peer_id=310522] [region_id=300845]\r\n[2019/08/28 18:13:05.965 +00:00] [info] [router.rs:446] [\"[region 300845] shutdown mailbox\"]\r\n[2019/08/28 18:13:05.965 +00:00] [fatal] [lib.rs:489] [\"[region 300845] 310522 meta corruption detected\"] [backtrace=\"stack backtrace:\r\n 0:     0x5614b2f0c1ad - backtrace::backtrace::trace::hdcb1982fbe7677c4\r\n 1:     0x5614b3e4c378 - tikv_util::set_panic_hook::{{closure}}::h47195ae73a956338\r\n 2:     0x5614b35fea9c - std::panicking::rust_panic_with_hook::h3ccc79b44ba3c353\\n                        at src/libstd/panicking.rs:481\r\n3:     0x5614b35fe5ce - std::panicking::continue_panic_fmt::h6da01b9bb2c73c79\\n                        at src/libstd/panicking.rs:384\r\n4:     0x5614b35fe57b - std::panicking::begin_panic_fmt::ha4fbbae8c2cc86c2\\n                        at src/libstd/panicking.rs:339\r\n5:     0x5614b30ff487 - tikv::raftstore::store::fsm::peer::peerfsmdelegate<t,c>::destroy_peer::hbf4c92362154e076\r\n 6:     0x5614b30ff567 - tikv::raftstore::store::fsm::peer::peerfsmdelegate<t,c>::on_apply_res::h338d3f64efea1186\r\n7:     0x5614b30f965f - tikv::raftstore::store::fsm::peer::peerfsmdelegate<t,c>::handle_msgs::h063f17c47279431a\r\n8:     0x5614b3127713 - tikv::raftstore::store::fsm::batch::poller<n,c,handler>::poll::h284187afbdc40d3d\r\n 9:     0x5614b300b833 - std::sys_common::backtrace::__rust_begin_short_backtrace::h3c0b7cbb1f2c4a4\r\n10:     0x5614b303d593 - core::ops::function::fnonce::call_once{{vtable.shim}}::h6ccf7559aa6f41e0\r\n11:     0x5614b35efdce - <alloc::boxed::box<f> as core::ops::function::fnonce<a>>::call_once::h7844af52ddbc8472\r\n                    at /rustc/311376d30dc1cfa622142a9f50317b1e0cb4608a/src/liballoc/boxed.rs:766\r\n12:     0x5614b36026bb - <alloc::boxed::box<f> as core::ops::function::fnonce<a>>::call_once::h4b6d646eab5dba5b|\r\n               at /rustc/311376d30dc1cfa622142a9f50317b1e0cb4608a/src/liballoc/boxed.rs:766\\n                         - std::sys_common::thread::start_thread::h5e4ac5df687e9051\r\n             at src/libstd/sys_common/thread.rs:13\\n                         - std::sys::unix::thread::thread::new::thread_start::heee16dd36d9df83b\r\n                at src/libstd/sys/unix/thread.rs:79\r\n13:     0x7fce98505d2b - <unknown>\r\n 14:     0x7fce97c19e3e - __clone\r\n15:                0x0 - <unknown>\"] [location=src/raftstore/store/fsm/peer.rs:1427] [thread_name=raftstore-5-1]\r\n```",
  "state": "closed",
  "created_at": "2019-08-29T12:19:58Z",
  "updated_at": "2019-12-20T11:44:34Z",
  "closed_at": "2019-12-20T11:44:34Z",
  "labels": [
    "type/bug"
  ],
  "comments_data": [
    {
      "id": 526178212,
      "user": "siddontang",
      "created_at": "2019-08-29T13:11:26Z",
      "body": "how to meet this problem?"
    },
    {
      "id": 526464396,
      "user": "nolouch",
      "created_at": "2019-08-30T05:41:36Z",
      "body": "@Luffbee  meet this situation with `oltp_insert` case."
    },
    {
      "id": 555961893,
      "user": "lhy1024",
      "created_at": "2019-11-20T11:24:50Z",
      "body": "## Bug Report\r\n\r\n### What version of TiKV are you using?\r\nTiKV branch: master\r\nTiKV hash: 612c2dd17d24508dc5b015b107b2c7f832115fb2\r\n\r\n### What did happened?\r\n\r\n```\r\n[2019/11/20 10:07:57.462 +00:00] [FATAL] [lib.rs:481] [\"[region 9006] 9010 meta corruption detected\"] [backtrace=\"stack backtrace:\r\n   0: tikv_util::set_panic_hook::{{closure}}\r\n             at components/tikv_util/src/lib.rs:480\r\n   1: std::panicking::rust_panic_with_hook\r\n             at src/libstd/panicking.rs:481\r\n   2: std::panicking::continue_panic_fmt\r\n             at src/libstd/panicking.rs:384\r\n   3: std::panicking::begin_panic_fmt\r\n             at src/libstd/panicking.rs:339\r\n   4: tikv::raftstore::store::fsm::peer::PeerFsmDelegate<T,C>::destroy_peer\r\n             at root/tikv/<::std::macros::panic macros>:9\r\n   5: tikv::raftstore::store::fsm::peer::PeerFsmDelegate<T,C>::on_apply_res\r\n             at root/tikv/src/raftstore/store/fsm/peer.rs:847\r\n   6: tikv::raftstore::store::fsm::peer::PeerFsmDelegate<T,C>::handle_msgs\r\n             at root/tikv/src/raftstore/store/fsm/peer.rs:300\r\n   7: <tikv::raftstore::store::fsm::store::RaftPoller<T,C> as tikv::raftstore::store::fsm::batch::PollHandler<tikv::raftstore::store::fsm::peer::PeerFsm,tikv::raftstore::store::fsm::store::StoreFsm>>::handle_normal\r\n             at root/tikv/src/raftstore/store/fsm/store.rs:646\r\n      tikv::raftstore::store::fsm::batch::Poller<N,C,Handler>::poll\r\n             at root/tikv/src/raftstore/store/fsm/batch.rs:322\r\n      tikv::raftstore::store::fsm::batch::BatchSystem<N,C>::spawn::{{closure}}\r\n             at root/tikv/src/raftstore/store/fsm/batch.rs:393\r\n      std::sys_common::backtrace::__rust_begin_short_backtrace\r\n             at rustc/c6e9c76c59e3c10acd63ca9ec157a8894ea1a068/src/libstd/sys_common/backtrace.rs:77\r\n   8: std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}}\r\n             at rustc/c6e9c76c59e3c10acd63ca9ec157a8894ea1a068/src/libstd/thread/mod.rs:470\r\n      <std::panic::AssertUnwindSafe<F> as core::ops::function::FnOnce<()>>::call_once\r\n             at rustc/c6e9c76c59e3c10acd63ca9ec157a8894ea1a068/src/libstd/panic.rs:315\r\n      std::panicking::try::do_call\r\n             at rustc/c6e9c76c59e3c10acd63ca9ec157a8894ea1a068/src/libstd/panicking.rs:296\r\n      std::panicking::try\r\n             at rustc/c6e9c76c59e3c10acd63ca9ec157a8894ea1a068//src/libpanic_abort/lib.rs:28\r\n      std::panic::catch_unwind\r\n             at rustc/c6e9c76c59e3c10acd63ca9ec157a8894ea1a068/src/libstd/panic.rs:394\r\n      std::thread::Builder::spawn_unchecked::{{closure}}\r\n             at rustc/c6e9c76c59e3c10acd63ca9ec157a8894ea1a068/src/libstd/thread/mod.rs:469\r\n      core::ops::function::FnOnce::call_once{{vtable.shim}}\r\n             at rustc/c6e9c76c59e3c10acd63ca9ec157a8894ea1a068/src/libcore/ops/function.rs:227\r\n   9: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at rustc/c6e9c76c59e3c10acd63ca9ec157a8894ea1a068/src/liballoc/boxed.rs:922\r\n  10: <alloc::boxed::Box<F> as core::ops::function::FnOnce<A>>::call_once\r\n             at rustc/c6e9c76c59e3c10acd63ca9ec157a8894ea1a068/src/liballoc/boxed.rs:922\r\n      std::sys_common::thread::start_thread\r\n             at src/libstd/sys_common/thread.rs:13\r\n      std::sys::unix::thread::Thread::new::thread_start\r\n             at src/libstd/sys/unix/thread.rs:79\r\n  11: <unknown>\r\n  12: __clone\r\n\"] [location=src/raftstore/store/fsm/peer.rs:1428] [thread_name=raftstore-5-1]\r\n```"
    },
    {
      "id": 567897947,
      "user": "gengliqi",
      "created_at": "2019-12-20T11:44:34Z",
      "body": "already fixed"
    }
  ]
}